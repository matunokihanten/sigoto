<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>é£²é£Ÿåº—çµŒå–¶åˆ†æãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ v4.0 (AIè¨ºæ–­å¼·åŒ–ç‰ˆ)</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
  <style>
    :root {
      --primary-color: #007bff;
      --success-color: #28a745;
      --warning-color: #ffc107;
      --danger-color: #dc3545;
      --info-color: #17a2b8;
      --advice-color: #6610f2;
      --bg-color: #f8f9fa;
    }

    body {
      font-family: "Helvetica Neue", Arial, "Hiragino Kaku Gothic ProN", "Hiragino Sans", Meiryo, sans-serif;
      margin: 20px;
      background: var(--bg-color);
      color: #343a40;
      transition: all 0.3s ease;
    }
    
    h1, h2, h3 { text-align: center; }
    h1 { margin-bottom: 20px; color: #2c3e50; }
    
    /* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ã‚¯ãƒ©ã‚¹ */
    .fade-in { animation: fadeIn 0.8s ease-in-out; }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* æ¥­æ…‹é¸æŠã‚¨ãƒªã‚¢ */
    .industry-selector {
        text-align: center;
        margin-bottom: 20px;
        padding: 20px;
        background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
        border-radius: 12px;
        border: 1px solid #90caf9;
        box-shadow: 0 4px 6px rgba(0,0,0,0.05);
    }
    .industry-selector select {
        padding: 10px;
        font-size: 16px;
        border-radius: 6px;
        border: 1px solid #90caf9;
        margin-left: 10px;
        cursor: pointer;
    }

    .input-form {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 20px;
      margin-bottom: 30px;
    }
    .input-group {
      background: #fff;
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.05);
      width: 45%;
      min-width: 320px;
      transition: transform 0.2s;
    }
    .input-group:hover {
        transform: translateY(-2px);
    }
    .input-group h2 {
      margin-top: 0;
      border-bottom: 2px solid #f1f3f5;
      padding-bottom: 15px;
      font-size: 1.25em;
      color: #495057;
    }
    .input-group label {
      display: block;
      margin-top: 15px;
      font-weight: bold;
      font-size: 0.9em;
      color: #495057;
    }
    .input-group input[type="number"], .input-group input[type="text"] {
      width: 100%;
      padding: 10px;
      margin-top: 5px;
      box-sizing: border-box;
      border: 1px solid #ced4da;
      border-radius: 6px;
      font-size: 1em;
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    .input-group input:focus {
        border-color: var(--primary-color);
        outline: 0;
        box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25);
    }

    .checkbox-container {
      display: flex;
      align-items: center;
      margin-top: 15px;
      font-weight: normal;
      padding: 10px;
      background: #f8f9fa;
      border-radius: 6px;
    }
    .checkbox-container input[type="checkbox"] {
      width: auto;
      margin-right: 10px;
      transform: scale(1.2);
    }

    .button-group {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin: 30px auto;
      flex-wrap: wrap;
    }
    .button-group button {
      width: 220px;
      padding: 15px;
      border: none;
      border-radius: 50px;
      font-size: 16px;
      cursor: pointer;
      font-weight: bold;
      transition: all 0.3s ease;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    .button-group button:hover { transform: translateY(-2px); box-shadow: 0 6px 8px rgba(0,0,0,0.15); }
    .button-group button:active { transform: translateY(0); }
    
    #updateButton { background: var(--primary-color); color: #fff; }
    #saveExcelButton { background: var(--success-color); color: #fff; }
    #generatePdfButton { background: var(--danger-color); color: #fff; }
    
    #report-content { padding: 10px; }

    .summary-box {
      background: #fff;
      border-top: 5px solid var(--primary-color);
      border-radius: 8px;
      padding: 30px;
      margin: 30px auto;
      width: 90%;
      max-width: 1200px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.05);
      position: relative;
      overflow: hidden;
    }
    .summary-box h2 { font-size: 1.8em; margin-bottom: 20px; }
    
    .score-container {
        text-align: center;
        margin-bottom: 30px;
        position: relative;
    }
    .score-label { font-size: 1.2em; color: #6c757d; display: block; margin-bottom: 5px; }
    .score-value {
      font-size: 4em;
      font-weight: 800;
      color: var(--primary-color);
      line-height: 1;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
    }
    .score-unit { font-size: 0.4em; color: #6c757d; font-weight: normal; margin-left: 5px; }

    #summaryText li {
        margin-bottom: 10px;
        line-height: 1.6;
        padding-left: 10px;
        border-left: 4px solid #dee2e6;
        list-style: none;
    }
    #simulationText {
        color: #d63384;
        font-weight: bold;
        background: #fdf2f8;
        padding: 20px;
        border-radius: 8px;
        border: 1px solid #fcc2d7;
        margin-top: 20px;
        animation: fadeIn 1s ease;
    }

    /* AIã‚¢ãƒ‰ãƒã‚¤ã‚¹ãƒœãƒƒã‚¯ã‚¹ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    .advice-box {
        background: #fff;
        padding: 30px;
        margin: 30px auto;
        width: 90%;
        max-width: 1200px;
        border-radius: 12px;
        border-left: 8px solid var(--advice-color);
        box-shadow: 0 10px 25px rgba(102, 16, 242, 0.1);
    }
    .advice-box h2 {
        color: var(--advice-color);
        border-bottom: 1px solid #e9ecef;
        padding-bottom: 15px;
        margin-bottom: 20px;
        text-align: left;
    }
    .advice-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
    }
    .advice-card {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 20px;
        border: 1px solid #e9ecef;
        transition: transform 0.2s;
    }
    .advice-card:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
    .advice-card h3 {
        font-size: 1.1em;
        margin-top: 0;
        margin-bottom: 10px;
        text-align: left;
        display: flex;
        align-items: center;
    }
    .advice-card p { font-size: 0.95em; color: #555; line-height: 1.5; margin-bottom: 0; }
    .status-icon { margin-right: 8px; font-size: 1.2em; }
    .status-danger { color: var(--danger-color); }
    .status-warning { color: var(--warning-color); }
    .status-success { color: var(--success-color); }
    .action-list { margin-top: 10px; padding-left: 20px; font-size: 0.9em; color: #333; }
    .action-list li { margin-bottom: 5px; }

    
    table {
      margin: 30px auto;
      border-collapse: separate;
      border-spacing: 0;
      width: 90%;
      max-width: 1200px;
      background: #fff;
      box-shadow: 0 4px 15px rgba(0,0,0,0.05);
      border-radius: 8px;
      overflow: hidden;
    }
    th, td {
      padding: 15px 20px;
      border-bottom: 1px solid #dee2e6;
      text-align: right;
    }
    th { background: #f8f9fa; font-weight: bold; color: #495057; text-align: center;}
    tbody th { background: #e9ecef; text-align: left; padding-left: 20px; color: #212529;}
    .metric-name { text-align: left; font-weight: 600; }
    .metric-formula { text-align: left; font-family: monospace; color: #868e96; font-size: 0.85em; }
    
    /* æ¥­æ…‹ãƒãƒƒã‚¸ */
    .industry-badge {
        font-size: 0.8em;
        background: #6f42c1;
        color: white;
        padding: 4px 8px;
        border-radius: 20px;
        margin-left: 5px;
        vertical-align: middle;
    }

    .score-badge {
        display: inline-block;
        padding: 6px 12px;
        border-radius: 20px;
        color: #fff;
        font-weight: bold;
        font-size: 0.9em;
        min-width: 40px;
        text-align: center;
        transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
    .score-badge:hover { transform: scale(1.1); }
    
    .score-badge-100 { background-color: #28a745; box-shadow: 0 2px 5px rgba(40,167,69,0.4); }
    .score-badge-80 { background-color: #17a2b8; box-shadow: 0 2px 5px rgba(23,162,184,0.4); }
    .score-badge-60 { background-color: #ffc107; color: #212529; box-shadow: 0 2px 5px rgba(255,193,7,0.4); }
    .score-badge-40 { background-color: #fd7e14; box-shadow: 0 2px 5px rgba(253,126,20,0.4); }
    .score-badge-20 { background-color: #dc3545; box-shadow: 0 2px 5px rgba(220,53,69,0.4); }
    .score-badge-0 { background-color: #6c757d; }
    
    .cf-row { background-color: #f1f8e9; font-weight: bold; border-left: 5px solid #28a745; }

    .charts-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 30px;
      margin: 40px auto;
      padding: 0;
      width: 90%;
      max-width: 1200px;
    }
    .chart-container {
      background: #fff;
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 10px 20px rgba(0,0,0,0.05);
      transition: transform 0.3s;
    }
    .chart-container:hover { transform: translateY(-5px); }
    .chart-container h2 {
      margin-top: 0;
      text-align: center;
      font-size: 1.3em;
      border-bottom: 1px solid #eee;
      padding-bottom: 15px;
      margin-bottom: 25px;
      color: #555;
    }
    .gauge-container {
        display: flex;
        justify-content: space-around;
        align-items: flex-start;
        flex-wrap: wrap;
    }
  </style>
</head>
<body class="fade-in">

  <h1>é£²é£Ÿåº—çµŒå–¶åˆ†æãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ v4.0</h1>

  <div class="industry-selector">
      <label for="industryType">æ¥­æ…‹ã‚’é¸æŠï¼ˆç›®å®‰åŸºæº–ãŒå¤‰ã‚ã‚Šã¾ã™ï¼‰:</label>
      <select id="industryType" onchange="updateDashboard()">
          <option value="general">ä¸€èˆ¬é£²é£Ÿåº—ï¼ˆæ¨™æº–ï¼‰</option>
          <option value="izakaya">å±…é…’å±‹ãƒ»ãƒãƒ¼ï¼ˆåŸä¾¡ç‡ä½ãƒ»äººä»¶è²»é«˜ï¼‰</option>
          <option value="cafe">ã‚«ãƒ•ã‚§ãƒ»å–«èŒ¶ï¼ˆå®¢å˜ä¾¡ä½ãƒ»å›è»¢ç‡é‡è¦–ï¼‰</option>
          <option value="ramen">ãƒ©ãƒ¼ãƒ¡ãƒ³ãƒ»å°‚é–€æ–™ç†ï¼ˆåŸä¾¡ç‡é«˜ãƒ»å›è»¢ç‡é«˜ï¼‰</option>
          <option value="fine_dining">é«˜ç´šåº—ãƒ»ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³ï¼ˆFLé«˜ãƒ»åˆ©ç›Šç‡é‡è¦–ï¼‰</option>
      </select>
  </div>

  <div class="input-form">
    <div class="input-group">
      <h2>æç›Šè¨ˆç®—æ›¸(PL)ãƒ‡ãƒ¼ã‚¿</h2>
      <label for="sales">å£²ä¸Šé«˜åˆè¨ˆ:</label>
      <input type="number" id="sales" value="87372059" onchange="updateEmployeeCount()">
      <label for="grossProfit">å£²ä¸Šç·åˆ©ç›Š:</label>
      <input type="number" id="grossProfit" value="59773028">
      <label for="operatingProfit">å–¶æ¥­åˆ©ç›Š:</label>
      <input type="number" id="operatingProfit" value="6192140">
      <label for="recurringProfit">çµŒå¸¸åˆ©ç›Š:</label>
      <input type="number" id="recurringProfit" value="6131225">
      <label for="netProfit">å½“æœŸç´”åˆ©ç›Š:</label>
      <input type="number" id="netProfit" value="4783999">
      
      <label for="depreciation" style="color:#007bff;">æ¸›ä¾¡å„Ÿå´è²» (CFè¨ˆç®—ç”¨):</label>
      <input type="number" id="depreciation" value="2500000">

      <label for="fixedCost">è²©å£²è²»ãƒ»ä¸€èˆ¬ç®¡ç†è²»åˆè¨ˆ:</label>
      <input type="number" id="fixedCost" value="53580888">
      <label for="laborCostExcluding">äººä»¶è²»ï¼ˆå½¹å“¡å ±é…¬å«ã¾ãªã„ï¼‰:</label>
      <input type="number" id="laborCostExcluding" value="19506662">
      <label for="directorSalary">å½¹å“¡å ±é…¬:</label>
      <input type="number" id="directorSalary" value="10816000">
      
      <div class="checkbox-container">
        <input type="checkbox" id="includeDirectorSalary" checked>
        <label for="includeDirectorSalary">äººä»¶è²»ã«å½¹å“¡å ±é…¬ã‚’å«ã‚ã‚‹</label>
      </div>
      <label for="employees">å¾“æ¥­å“¡æ•°:</label>
      <input type="number" id="employees" value="9">
    </div>

    <div class="input-group">
      <h2>è²¸å€Ÿå¯¾ç…§è¡¨(BS)ãƒ»ç›®æ¨™è¨­å®š</h2>
      <label for="totalAssets">è³‡ç”£åˆè¨ˆ:</label>
      <input type="number" id="totalAssets" value="103504754">
      <label for="currentAssets">æµå‹•è³‡ç”£:</label>
      <input type="number" id="currentAssets" value="13077908">
      <label for="fixedAssets">å›ºå®šè³‡ç”£:</label>
      <input type="number" id="fixedAssets" value="90426846">
      <label for="liabilities">è² å‚µåˆè¨ˆ:</label>
      <input type="number" id="liabilities" value="72979123">
      
      <label for="debtRepayment" style="color:#007bff;">å€Ÿå…¥é‡‘å…ƒé‡‘è¿”æ¸ˆé¡ (å¹´é–“):</label>
      <input type="number" id="debtRepayment" value="5000000">

      <label for="currentLiabilities">æµå‹•è² å‚µ:</label>
      <input type="number" id="currentLiabilities" value="16440508">
      <label for="fixedLiabilities">å›ºå®šè² å‚µ:</label>
      <input type="number" id="fixedLiabilities" value="56538614">
      <label for="equity">ç´”è³‡ç”£åˆè¨ˆï¼ˆè‡ªå·±è³‡æœ¬ï¼‰:</label>
      <input type="number" id="equity" value="30525631">
      <label for="interestBearingDebt">æœ‰åˆ©å­è² å‚µåˆè¨ˆ:</label>
      <input type="number" id="interestBearingDebt" value="56258235">
      <label for="directorLoan">å½¹å“¡å€Ÿå…¥é‡‘:</label>
      <input type="number" id="directorLoan" value="31720235">
      
      <div class="checkbox-container">
        <input type="checkbox" id="includeDirectorLoan" checked>
        <label for="includeDirectorLoan">æœ‰åˆ©å­è² å‚µã«å½¹å“¡å€Ÿå…¥é‡‘ã‚’å«ã‚ã‚‹</label>
      </div>

      <div style="margin-top:20px; border-top: 2px dashed #ffc107; padding-top:15px;">
          <h3 style="margin:0 0 10px 0; font-size:1.1em; color:#d39e00;">ğŸ¯ ç›®æ¨™è¨­å®š (ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³)</h3>
          <label for="targetOperatingMargin">ç›®æ¨™ å–¶æ¥­åˆ©ç›Šç‡ (%):</label>
          <input type="number" id="targetOperatingMargin" value="10" step="0.1">
      </div>
    </div>
  </div>

  <div class="button-group">
    <button id="updateButton" onclick="updateDashboard()">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚’æ›´æ–°</button>
    <button id="saveExcelButton" onclick="saveToExcel()">åˆ†æçµæœã‚’Excelä¿å­˜</button>
    <button id="generatePdfButton" onclick="generatePDF()">åˆ†æãƒ¬ãƒãƒ¼ãƒˆã‚’PDFä¿å­˜</button>
  </div>

  <div id="report-content">
    <div class="summary-box fade-in">
      <h2>çµŒå–¶çŠ¶æ³ã®ç·æ‹¬</h2>
      <div class="score-container">
          <span class="score-label">ç·åˆçµŒå–¶ã‚¹ã‚³ã‚¢</span>
          <span id="scoreValue" class="score-value">0</span><span class="score-unit">ç‚¹</span>
      </div>
      <ul id="summaryText"></ul>
      <div id="simulationText"></div>
    </div>
    
    <div class="advice-box fade-in" id="adviceBox" style="display:none;">
        <h2>ğŸ›¡ï¸ AI çµŒå–¶æ”¹å–„ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒ—ãƒ©ãƒ³</h2>
        <div id="adviceContent" class="advice-grid">
            </div>
    </div>
    
    <table id="analysisTable" class="fade-in">
      <thead>
        <tr>
            <th class="metric-name">æŒ‡æ¨™</th>
            <th class="metric-formula">è¨ˆç®—å¼</th>
            <th class="metric-value">å®Ÿç¸¾å€¤</th>
            <th class="score-column">ã‚¹ã‚³ã‚¢</th>
            <th class="average-value">ç›®å®‰ <span id="industryLabel" class="industry-badge">æ¨™æº–</span></th>
            <th class="comment-text">ã‚³ãƒ¡ãƒ³ãƒˆ</th>
        </tr>
      </thead>
      <tbody>
        <tr><th colspan="6">ğŸ“ˆ åç›Šæ€§ãƒ»åŠ¹ç‡æ€§åˆ†æ</th></tr>
        <tr><td class="metric-name">å£²ä¸Šé«˜ç·åˆ©ç›Šç‡</td><td class="metric-formula">å£²ä¸Šç·åˆ©ç›Š / å£²ä¸Šé«˜</td><td id="grossMargin">-</td><td id="grossMarginScore">-</td><td class="average-value" id="grossMarginRef">-</td><td class="comment-text">å•†å“ç«¶äº‰åŠ›</td></tr>
        <tr><td class="metric-name">å£²ä¸Šé«˜å–¶æ¥­åˆ©ç›Šç‡</td><td class="metric-formula">å–¶æ¥­åˆ©ç›Š / å£²ä¸Šé«˜</td><td id="operatingMargin">-</td><td id="operatingMarginScore">-</td><td class="average-value" id="operatingMarginRef">-</td><td class="comment-text">æœ¬æ¥­ã§ã®åç›ŠåŠ›</td></tr>
        <tr><td class="metric-name">å£²ä¸Šé«˜çµŒå¸¸åˆ©ç›Šç‡</td><td class="metric-formula">çµŒå¸¸åˆ©ç›Š / å£²ä¸Šé«˜</td><td id="recurringMargin">-</td><td id="recurringMarginScore">-</td><td class="average-value" id="recurringMarginRef">3ï½8%</td><td class="comment-text">ç·åˆçš„ãªåç›ŠåŠ›</td></tr>
        <tr><td class="metric-name">ç·è³‡ç”£åˆ©ç›Šç‡ (ROA)</td><td class="metric-formula">å½“æœŸç´”åˆ©ç›Š / ç·è³‡ç”£</td><td id="roa">-</td><td id="roaScore">-</td><td class="average-value">3ï½5%</td><td class="comment-text">è³‡ç”£å…¨ä½“ã®åŠ¹ç‡æ€§</td></tr>
        <tr><td class="metric-name">è‡ªå·±è³‡æœ¬åˆ©ç›Šç‡ (ROE)</td><td class="metric-formula">å½“æœŸç´”åˆ©ç›Š / è‡ªå·±è³‡æœ¬</td><td id="roe">-</td><td id="roeScore">-</td><td class="average-value">10ï½15%</td><td class="comment-text">æ ªä¸»è³‡æœ¬ã®åŠ¹ç‡æ€§</td></tr>
        
        <tr><td class="metric-name">FLã‚³ã‚¹ãƒˆç‡</td><td class="metric-formula">(åŸä¾¡+äººä»¶è²») / å£²ä¸Šé«˜</td><td id="flRatio">-</td><td id="flRatioScore">-</td><td class="average-value" id="flRatioRef">-</td><td class="comment-text">åŸä¾¡ã¨äººä»¶è²»ã®é©æ­£åº¦</td></tr>
        <tr><td class="metric-name">åŠ´åƒåˆ†é…ç‡</td><td class="metric-formula">äººä»¶è²» / å£²ä¸Šç·åˆ©ç›Š</td><td id="laborShare">-</td><td id="laborShareScore">-</td><td class="average-value" id="laborShareRef">-</td><td class="comment-text">ä»˜åŠ ä¾¡å€¤ã®äººä»¶è²»é…åˆ†</td></tr>
        
        <tr><td class="metric-name">æç›Šåˆ†å²ç‚¹æ¯”ç‡</td><td class="metric-formula">æç›Šåˆ†å²ç‚¹å£²ä¸Šé«˜ / å£²ä¸Šé«˜</td><td id="breakevenRatio">-</td><td id="breakevenRatioScore">-</td><td class="average-value">80%ä»¥ä¸‹</td><td class="comment-text">èµ¤å­—ã¸ã®æŠµæŠ—åŠ›</td></tr>
        <tr><td class="metric-name">å®‰å…¨ä½™è£•ç‡</td><td class="metric-formula">100% - æç›Šåˆ†å²ç‚¹æ¯”ç‡</td><td id="marginOfSafety">-</td><td id="marginOfSafetyScore">-</td><td class="average-value">20%ä»¥ä¸Š</td><td class="comment-text">å£²ä¸Šæ¸›ã¸ã®è€ä¹…åº¦</td></tr>
        
        <tr><td class="metric-name">ä¸€äººå½“ãŸã‚Šå£²ä¸Šé«˜</td><td class="metric-formula">å£²ä¸Šé«˜ / å¾“æ¥­å“¡æ•°</td><td id="salesPerEmployee">-</td><td id="salesPerEmployeeScore">-</td><td class="average-value">800ä¸‡å††ä»¥ä¸Š</td><td class="comment-text">åŠ´åƒç”Ÿç”£æ€§ï¼ˆå£²ä¸Šï¼‰</td></tr>
        
        <tr><th colspan="6">ğŸ›¡ï¸ å®‰å…¨æ€§ãƒ»è³‡é‡‘ç¹°ã‚Šï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ•ãƒ­ãƒ¼ï¼‰</th></tr>
        <tr><td class="metric-name">è‡ªå·±è³‡æœ¬æ¯”ç‡</td><td class="metric-formula">è‡ªå·±è³‡æœ¬ / ç·è³‡ç”£</td><td id="equityRatio">-</td><td id="equityRatioScore">-</td><td class="average-value">30%ä»¥ä¸Š</td><td class="comment-text">è²¡å‹™åŸºç›¤ã®å®‰å®šæ€§</td></tr>
        <tr><td class="metric-name">æµå‹•æ¯”ç‡</td><td class="metric-formula">æµå‹•è³‡ç”£ / æµå‹•è² å‚µ</td><td id="currentRatio">-</td><td id="currentRatioScore">-</td><td class="average-value">120%ä»¥ä¸Š</td><td class="comment-text">çŸ­æœŸçš„ãªæ”¯æ‰•èƒ½åŠ›</td></tr>
        <tr><td class="metric-name">æœ‰åˆ©å­è² å‚µä¾å­˜åº¦</td><td class="metric-formula">æœ‰åˆ©å­è² å‚µ / ç·è³‡ç”£</td><td id="interestBearingDebtRatio">-</td><td id="interestBearingDebtRatioScore">-</td><td class="average-value">40%ä»¥ä¸‹</td><td class="comment-text">å€Ÿå…¥é‡‘ã®è¿”æ¸ˆè² æ‹…ãƒªã‚¹ã‚¯</td></tr>
        
        <tr><td class="metric-name">å‚µå‹™å„Ÿé‚„å¹´æ•°</td><td class="metric-formula">æœ‰åˆ©å­è² å‚µ / (å–¶æ¥­åˆ©ç›Š+å„Ÿå´)</td><td id="debtRepaymentPeriod">-</td><td id="debtRepaymentPeriodScore">-</td><td class="average-value">10å¹´ä»¥å†…</td><td class="comment-text">å€Ÿå…¥è¿”æ¸ˆã«ã‹ã‹ã‚‹å¹´æ•°</td></tr>
        
        <tr class="cf-row">
            <td class="metric-name">è¿”æ¸ˆå¾Œæ‰‹å…ƒè³‡é‡‘(ç°¡æ˜“CF)</td>
            <td class="metric-formula">ç´”åˆ©ç›Š+å„Ÿå´è²»-è¿”æ¸ˆ</td>
            <td id="cashFlow">-</td>
            <td id="cashFlowScore">-</td>
            <td class="average-value">ãƒ—ãƒ©ã‚¹ç¶­æŒ</td>
            <td class="comment-text">å®Ÿéš›ã«æ‰‹å…ƒã«æ®‹ã‚‹ç¾é‡‘</td>
        </tr>
      </tbody>
    </table>

    <div class="charts-grid fade-in">
        <div class="chart-container">
            <h2>çµŒå–¶å¥å…¨æ€§ã‚µãƒãƒªãƒ¼</h2>
            <canvas id="radarChart"></canvas>
        </div>
        <div class="chart-container">
            <h2>FLã‚³ã‚¹ãƒˆãƒ»åˆ©ç›Šæ§‹æˆ</h2>
            <canvas id="costStructureChart"></canvas>
        </div>
        <div class="chart-container">
            <h2>å®‰å…¨æ€§æŒ‡æ¨™</h2>
            <div class="gauge-container">
              <canvas id="equityRatioGauge"></canvas>
              <canvas id="currentRatioGauge"></canvas>
            </div>
        </div>
        <div class="chart-container">
            <h2>åç›Šæ€§ æ™‚ç³»åˆ—æ¨ç§»</h2>
            <canvas id="salesTrendChart"></canvas>
        </div>
    </div>
  </div>

  <script>
    let radarChart, costStructureChart, equityRatioGauge, currentRatioGauge, salesTrendChart;

    const gaugeTextPlugin = {
      id: 'gaugeText',
      afterDraw(chart) {
        const { ctx, config } = chart;
        const GAUGE_TEXT_CONFIG = config.options.plugins.gaugeText;
        if (!GAUGE_TEXT_CONFIG?.display) return;

        const text = GAUGE_TEXT_CONFIG.text;
        const subtext = GAUGE_TEXT_CONFIG.subtext;
        const color = GAUGE_TEXT_CONFIG.color || '#343a40';
        
        ctx.save();
        const centerX = (chart.chartArea.left + chart.chartArea.right) / 2;
        const centerY = (chart.chartArea.top + chart.chartArea.bottom) / 1.5;

        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.font = GAUGE_TEXT_CONFIG.font || 'bold 1.5em sans-serif';
        ctx.fillStyle = color;
        ctx.fillText(text, centerX, centerY);
        
        if (subtext) {
          ctx.font = 'bold 0.9em sans-serif';
          ctx.fillStyle = '#6c757d';
          ctx.fillText(subtext, centerX, centerY + 25);
        }
        ctx.restore();
      }
    };
    if (typeof Chart !== 'undefined') {
        Chart.register(gaugeTextPlugin);
        Chart.defaults.font.family = '"Helvetica Neue", "Helvetica", "Arial", sans-serif';
        Chart.defaults.animation.duration = 1500;
        Chart.defaults.animation.easing = 'easeOutQuart';
    }

    const industryBenchmarks = {
        general: { 
            label: "ä¸€èˆ¬é£²é£Ÿåº—",
            grossMargin: { min: 65, max: 75 },
            operatingMargin: { min: 5, max: 10 },
            laborShare: { min: 35, max: 45 },
            laborCostRatio: { min: 30, max: 35 },
            flRatio: { min: 55, max: 60 }
        },
        izakaya: { 
            label: "å±…é…’å±‹",
            grossMargin: { min: 68, max: 78 },
            operatingMargin: { min: 5, max: 12 },
            laborShare: { min: 35, max: 45 },
            laborCostRatio: { min: 30, max: 38 },
            flRatio: { min: 55, max: 62 }
        },
        cafe: { 
            label: "ã‚«ãƒ•ã‚§",
            grossMargin: { min: 70, max: 80 },
            operatingMargin: { min: 5, max: 12 },
            laborShare: { min: 35, max: 45 },
            laborCostRatio: { min: 30, max: 40 },
            flRatio: { min: 55, max: 60 }
        },
        ramen: { 
            label: "ãƒ©ãƒ¼ãƒ¡ãƒ³",
            grossMargin: { min: 60, max: 70 },
            operatingMargin: { min: 8, max: 15 },
            laborShare: { min: 30, max: 40 },
            laborCostRatio: { min: 25, max: 32 },
            flRatio: { min: 55, max: 62 }
        },
        fine_dining: { 
            label: "é«˜ç´šåº—",
            grossMargin: { min: 60, max: 70 },
            operatingMargin: { min: 3, max: 8 },
            laborShare: { min: 40, max: 50 },
            laborCostRatio: { min: 30, max: 40 },
            flRatio: { min: 50, max: 60 }
        }
    };

    // æ•°å€¤ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é–¢æ•°
    const animateValue = (id, start, end, duration) => {
        const obj = document.getElementById(id);
        if(!obj) return;
        let startTimestamp = null;
        const step = (timestamp) => {
            if (!startTimestamp) startTimestamp = timestamp;
            const progress = Math.min((timestamp - startTimestamp) / duration, 1);
            obj.innerHTML = Math.floor(progress * (end - start) + start);
            if (progress < 1) {
                window.requestAnimationFrame(step);
            } else {
                obj.innerHTML = end;
            }
        };
        window.requestAnimationFrame(step);
    };

    const getScore = (value, targetMin, targetMax, isHigherBetter = true) => {
        if (!isFinite(value)) return 0; // å®‰å…¨å¯¾ç­–
        let score;
        const idealScore = 100;
        const acceptableScore = 50;

        if (isHigherBetter) {
            if (value >= targetMax) {
                score = idealScore;
            } else if (value >= targetMin) {
                score = acceptableScore + ((value - targetMin) / (targetMax - targetMin)) * (idealScore - acceptableScore);
            } else {
                const diff = targetMin - value;
                const penaltyScale = targetMin * 0.5 || 1; 
                score = acceptableScore - (diff / penaltyScale) * acceptableScore;
            }
        } else { // isLowerBetter
            if (value <= targetMin) {
                score = idealScore;
            } else if (value <= targetMax) {
                score = acceptableScore + ((targetMax - value) / (targetMax - targetMin)) * (idealScore - acceptableScore);
            } else {
                const diff = value - targetMax;
                const penaltyScale = targetMax * 0.5 || 1;
                score = acceptableScore - (diff / penaltyScale) * acceptableScore;
            }
        }
        return Math.round(Math.max(0, Math.min(100, score)));
    };

    const calcMetrics = (d) => {
      const safeDiv = (num, den) => (den && den !== 0 ? num / den : 0);
      
      const includeDirectorLoan = document.getElementById('includeDirectorLoan').checked;
      const includeDirectorSalary = document.getElementById('includeDirectorSalary').checked;

      const totalLiabilities = d.liabilities;
      const interestBearingDebt = includeDirectorLoan ? d.interestBearingDebt : Math.max(0, d.interestBearingDebt - d.directorLoan);
      const laborCost = includeDirectorSalary ? d.laborCostExcluding + d.directorSalary : d.laborCostExcluding;

      const adjustedFixedLiabilities = d.fixedLiabilities;
      const adjustedCurrentLiabilities = d.currentLiabilities;
      
      const costOfGoods = d.sales - d.grossProfit;
      const flCost = costOfGoods + laborCost;

      // å–¶æ¥­CFï¼ˆç°¡æ˜“ï¼‰
      const operatingCashFlow = d.operatingProfit + d.depreciation;
      
      // å‚µå‹™å„Ÿé‚„å¹´æ•°ï¼ˆã‚¼ãƒ­é™¤ç®—ãƒ»ãƒã‚¤ãƒŠã‚¹é™¤ç®—å¯¾ç­–ï¼‰
      let debtRepaymentPeriod = 0;
      if (operatingCashFlow > 0) {
          debtRepaymentPeriod = interestBearingDebt / operatingCashFlow;
      } else if (interestBearingDebt > 0) {
          debtRepaymentPeriod = 99.9; // åˆ©ç›ŠãŒå‡ºã¦ã„ãªã„ã®ã§è¿”æ¸ˆä¸èƒ½
      }

      const cashFlow = d.netProfit + d.depreciation - d.debtRepayment;
      
      // æç›Šåˆ†å²ç‚¹å£²ä¸Šé«˜
      const contributionRate = safeDiv(d.grossProfit, d.sales);
      const breakevenSales = contributionRate > 0 ? d.fixedCost / contributionRate : 0;

      return {
        grossMargin: safeDiv(d.grossProfit, d.sales) * 100,
        operatingMargin: safeDiv(d.operatingProfit, d.sales) * 100,
        recurringMargin: safeDiv(d.recurringProfit, d.sales) * 100,
        netProfitMargin: safeDiv(d.netProfit, d.sales) * 100,
        roa: safeDiv(d.netProfit, d.totalAssets) * 100,
        roe: safeDiv(d.netProfit, d.equity) * 100,
        breakevenRatio: safeDiv(breakevenSales, d.sales) * 100,
        breakevenSales: breakevenSales,
        laborShare: safeDiv(laborCost, d.grossProfit) * 100,
        laborCostRatio: safeDiv(laborCost, d.sales) * 100,
        salesPerEmployee: safeDiv(d.sales, d.employees),
        opPerEmployee: safeDiv(d.operatingProfit, d.employees),
        totalAssetTurnover: safeDiv(d.sales, d.totalAssets),

        equityRatio: safeDiv(d.equity, d.totalAssets) * 100,
        currentRatio: safeDiv(d.currentAssets, adjustedCurrentLiabilities) * 100,
        fixedRatio: safeDiv(d.fixedAssets, d.equity) * 100,
        fixedLongRatio: safeDiv(d.fixedAssets, (d.equity + adjustedFixedLiabilities)) * 100,
        debtRatio: safeDiv(totalLiabilities, d.equity) * 100,
        interestBearingDebtRatio: safeDiv(interestBearingDebt, d.totalAssets) * 100,
        
        flRatio: safeDiv(flCost, d.sales) * 100,
        debtRepaymentPeriod: debtRepaymentPeriod,
        marginOfSafety: 100 - (safeDiv(breakevenSales, d.sales) * 100),
        cashFlow: cashFlow 
      };
    };

    const scoreMetrics = (m) => {
        let comments = [];
        const scores = {};
        
        const industryKey = document.getElementById("industryType").value;
        const bench = industryBenchmarks[industryKey] || industryBenchmarks.general;

        // UIã®ç›®å®‰è¡¨ç¤ºæ›´æ–°
        const setRef = (id, text) => { const el = document.getElementById(id); if(el) el.textContent = text; };
        setRef("industryLabel", bench.label);
        setRef("grossMarginRef", `${bench.grossMargin.min}ï½${bench.grossMargin.max}%`);
        setRef("operatingMarginRef", `${bench.operatingMargin.min}ï½${bench.operatingMargin.max}%`);
        setRef("laborShareRef", `${bench.laborShare.min}ï½${bench.laborShare.max}%`);
        setRef("flRatioRef", `${bench.flRatio.min}ï½${bench.flRatio.max}%`);

        // ã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°
        scores.grossMarginScore = getScore(m.grossMargin, bench.grossMargin.min, bench.grossMargin.max);
        scores.operatingMarginScore = getScore(m.operatingMargin, bench.operatingMargin.min, bench.operatingMargin.max);
        scores.recurringMarginScore = getScore(m.recurringMargin, 3, 8);
        scores.netProfitMarginScore = getScore(m.netProfitMargin, 2, 5);
        scores.roaScore = getScore(m.roa, 3, 5);
        scores.roeScore = getScore(m.roe, 10, 15);
        scores.breakevenRatioScore = getScore(m.breakevenRatio, 50, 80, false);
        scores.breakevenSalesScore = getScore(m.breakevenSales, 50000000, 80000000, false); 
        scores.laborShareScore = getScore(m.laborShare, bench.laborShare.min, bench.laborShare.max, false);
        scores.salesPerEmployeeScore = getScore(m.salesPerEmployee, 8000000, 12000000);
        scores.opPerEmployeeScore = getScore(m.opPerEmployee, 500000, 1000000);
        scores.totalAssetTurnoverScore = getScore(m.totalAssetTurnover, 1.0, 1.5);
        scores.equityRatioScore = getScore(m.equityRatio, 30, 50);
        scores.currentRatioScore = getScore(m.currentRatio, 120, 200);
        scores.fixedRatioScore = getScore(m.fixedRatio, 80, 100, false);
        scores.debtRatioScore = getScore(m.debtRatio, 50, 100, false);
        scores.interestBearingDebtRatioScore = getScore(m.interestBearingDebtRatio, 20, 40, false);
        
        scores.flRatioScore = getScore(m.flRatio, bench.flRatio.min, bench.flRatio.max, false);
        scores.debtRepaymentPeriodScore = getScore(m.debtRepaymentPeriod, 0, 10, false); 
        scores.marginOfSafetyScore = getScore(m.marginOfSafety, 20, 40);
        scores.cashFlowScore = m.cashFlow > 0 ? 100 : 20;

        // ç°¡æ˜“ã‚³ãƒ¡ãƒ³ãƒˆï¼ˆãƒªã‚¹ãƒˆç”¨ï¼‰
        if (m.cashFlow < 0) comments.push(`âš ï¸ ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ•ãƒ­ãƒ¼ãŒãƒã‚¤ãƒŠã‚¹(${Math.round(m.cashFlow/10000)}ä¸‡å††)ã§ã™ã€‚`);
        if (m.debtRepaymentPeriod > 20) comments.push(`âš ï¸ å‚µå‹™å„Ÿé‚„å¹´æ•°ãŒå±é™ºæ°´åŸŸï¼ˆ${m.debtRepaymentPeriod.toFixed(1)}å¹´ï¼‰ã§ã™ã€‚`);
        if (m.flRatio > bench.flRatio.max) comments.push(`FLã‚³ã‚¹ãƒˆç‡(${m.flRatio.toFixed(1)}%)ãŒé«˜ã™ãã¾ã™ã€‚`);
        if (m.operatingMargin >= bench.operatingMargin.min) comments.push(`ğŸ‘ å–¶æ¥­åˆ©ç›Šç‡ã¯å¥å…¨ã§ã™ã€‚`);
        if (m.marginOfSafety < 0) comments.push("â›” ç¾åœ¨ã€èµ¤å­—çŠ¶æ…‹ã§ã™ã€‚");

        const scoreWeights = { roe: 20, operatingMargin: 20, equityRatio: 20, currentRatio: 10, breakevenRatio: 10, flRatio: 10, debtRepaymentPeriod: 10 };
        let totalScore = 0;
        totalScore += (scores.roeScore / 100) * scoreWeights.roe;
        totalScore += (scores.operatingMarginScore / 100) * scoreWeights.operatingMargin;
        totalScore += (scores.equityRatioScore / 100) * scoreWeights.equityRatio;
        totalScore += (scores.currentRatioScore / 100) * scoreWeights.currentRatio;
        totalScore += (scores.breakevenRatioScore / 100) * scoreWeights.breakevenRatio;
        totalScore += (scores.flRatioScore / 100) * scoreWeights.flRatio;
        totalScore += (scores.debtRepaymentPeriodScore / 100) * scoreWeights.debtRepaymentPeriod;

        return { score: totalScore.toFixed(0), comments, detailScores: scores };
    };

    // æ–°æ©Ÿèƒ½: å…·ä½“çš„ãªã‚¢ãƒ‰ãƒã‚¤ã‚¹ç”Ÿæˆæ©Ÿèƒ½
    const generateDetailedAdvice = (m, bench) => {
        const container = document.getElementById('adviceContent');
        const box = document.getElementById('adviceBox');
        container.innerHTML = '';
        box.style.display = 'block';

        let adviceCards = [];

        // 1. ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ•ãƒ­ãƒ¼åˆ¤å®š (æœ€å„ªå…ˆ)
        if (m.cashFlow < 0) {
            adviceCards.push({
                title: "è³‡é‡‘ç¹°ã‚Šãƒ»ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ•ãƒ­ãƒ¼ (ç·Šæ€¥)",
                status: "danger",
                icon: "ğŸ”¥",
                message: "åˆ©ç›ŠãŒå‡ºã¦ã„ã¦ã‚‚ã€å€Ÿå…¥è¿”æ¸ˆã§æ‰‹å…ƒè³‡é‡‘ãŒæ¸›ã£ã¦ã„ã¾ã™ã€‚",
                actions: [
                    "å€Ÿå…¥é‡‘ã®è¿”æ¸ˆã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’è¦‹ç›´ã—ï¼ˆãƒªã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼‰ã‚’æ¤œè¨ã—ã¦ãã ã•ã„ã€‚",
                    "ä¸è¦ãªè¨­å‚™æŠ•è³‡ã‚’å³åº§ã«å‡çµã—ã¦ãã ã•ã„ã€‚",
                    "æ¸›ä¾¡å„Ÿå´è²»ã®ç¯„å›²å†…ã§ã®å€Ÿå…¥è¿”æ¸ˆé¡ã«åã‚ã‚‹ã®ãŒç†æƒ³ã§ã™ã€‚"
                ]
            });
        }

        // 2. FLã‚³ã‚¹ãƒˆåˆ¤å®š
        if (m.flRatio > bench.flRatio.max) {
            adviceCards.push({
                title: "FLã‚³ã‚¹ãƒˆ (åŸä¾¡ãƒ»äººä»¶è²»)",
                status: "danger",
                icon: "ğŸ”ª",
                message: `FLæ¯”ç‡ãŒ${m.flRatio.toFixed(1)}%ã¨é«˜ã™ãã¾ã™ï¼ˆç›®æ¨™: ${bench.flRatio.max}%ä»¥ä¸‹ï¼‰ã€‚`,
                actions: [
                    "ãƒ•ãƒ¼ãƒ‰ãƒ­ã‚¹ï¼ˆå»ƒæ£„ï¼‰ã®è¨˜éŒ²ã‚’æ¯æ—¥ã¤ã‘ã¦åŸå› ã‚’ç‰¹å®šã—ã¦ãã ã•ã„ã€‚",
                    "ãƒãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆç››ã‚Šä»˜ã‘é‡ï¼‰ãŒéå‰°ã§ãªã„ã‹ãƒãƒ‹ãƒ¥ã‚¢ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚",
                    "ã‚¢ã‚¤ãƒ‰ãƒ«ã‚¿ã‚¤ãƒ ï¼ˆæš‡ãªæ™‚é–“ï¼‰ã®ã‚·ãƒ•ãƒˆäººå“¡ã‚’å‰Šæ¸›ã—ã¦ãã ã•ã„ã€‚"
                ]
            });
        } else if (m.flRatio > bench.flRatio.min) {
            adviceCards.push({
                title: "FLã‚³ã‚¹ãƒˆ (åŸä¾¡ãƒ»äººä»¶è²»)",
                status: "warning",
                icon: "âš ï¸",
                message: "é©æ­£ç¯„å›²å†…ã§ã™ãŒã€æ”¹å–„ã®ä½™åœ°ãŒã‚ã‚Šã¾ã™ã€‚",
                actions: ["åŸä¾¡ç‡ã®é«˜ã„ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®ä¾¡æ ¼è¦‹ç›´ã—ã€ã¾ãŸã¯æ§‹æˆæ¯”ã‚’ä¸‹ã’ã‚‹å·¥å¤«ã‚’ã—ã¾ã—ã‚‡ã†ã€‚"]
            });
        }

        // 3. æç›Šåˆ†å²ç‚¹ãƒ»å›ºå®šè²»
        if (m.breakevenRatio > 90) {
            adviceCards.push({
                title: "å›ºå®šè²»ãƒ»æç›Šæ§‹é€ ",
                status: "danger",
                icon: "ğŸ“‰",
                message: "å£²ä¸ŠãŒã‚ãšã‹ã«è½ã¡ã‚‹ã ã‘ã§èµ¤å­—ã«ãªã‚‹å±é™ºãªçŠ¶æ…‹ã§ã™ã€‚",
                actions: [
                    "å®¶è³ƒã€é€šä¿¡è²»ã€åºƒå‘Šè²»ãªã©ã®å›ºå®šè²»ã‚’è¦‹ç›´ã—ã¦ãã ã•ã„ã€‚",
                    "å®¢å˜ä¾¡ã‚¢ãƒƒãƒ—ã®ãŸã‚ã®ã‚»ãƒƒãƒˆãƒ¡ãƒ‹ãƒ¥ãƒ¼å°å…¥ã‚’æ¤œè¨ã—ã¦ãã ã•ã„ã€‚"
                ]
            });
        }

        // 4. åŠ´åƒç”Ÿç”£æ€§
        if (m.salesPerEmployee < 6000000) { // 600ä¸‡å††æœªæº€
             adviceCards.push({
                title: "åŠ´åƒç”Ÿç”£æ€§",
                status: "warning",
                icon: "â³",
                message: "å¾“æ¥­å“¡ä¸€äººå½“ãŸã‚Šã®å£²ä¸ŠãŒä½ã„ã§ã™ã€‚",
                actions: [
                    "ã‚ªãƒšãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’åŠ¹ç‡åŒ–ã—ã€å°‘ãªã„äººæ•°ã§å›ã›ã‚‹ä»•çµ„ã¿ã‚’ä½œã£ã¦ãã ã•ã„ã€‚",
                    "è¿½åŠ æ³¨æ–‡ã‚’ä¿ƒã™å£°æ›ã‘ã‚„ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒ–ãƒƒã‚¯ã®å·¥å¤«ã‚’å¾¹åº•ã—ã¦ãã ã•ã„ã€‚"
                ]
            });
        }

        // 5. å‚µå‹™å„Ÿé‚„å¹´æ•°
        if (m.debtRepaymentPeriod > 10) {
             adviceCards.push({
                title: "å€Ÿå…¥é‡‘ãƒ»è²¡å‹™ä½“è³ª",
                status: "warning",
                icon: "ğŸ¦",
                message: `å®Œæ¸ˆã¾ã§${m.debtRepaymentPeriod.toFixed(1)}å¹´ã‹ã‹ã‚‹è¨ˆç®—ã§ã™ã€‚è¿½åŠ èè³‡ãŒé›£ã—ããªã‚Šã¾ã™ã€‚`,
                actions: [
                    "åˆ©ç›Šã®çµ¶å¯¾é¡ã‚’å¢—ã‚„ã™ã“ã¨ãŒæœ€å„ªå…ˆã§ã™ã€‚",
                    "éŠä¼‘è³‡ç”£ï¼ˆä½¿ã£ã¦ã„ãªã„æ©Ÿæãªã©ï¼‰ãŒã‚ã‚Œã°å£²å´ã‚’æ¤œè¨ã—ã¦ãã ã•ã„ã€‚"
                ]
            });
        }

        // è‰¯å¥½ãªå ´åˆ
        if (adviceCards.length === 0) {
            adviceCards.push({
                title: "çµŒå–¶çŠ¶æ…‹ã¯è‰¯å¥½ã§ã™",
                status: "success",
                icon: "âœ¨",
                message: "ä¸»è¦ãªæŒ‡æ¨™ã¯ã™ã¹ã¦åŸºæº–ã‚’ã‚¯ãƒªã‚¢ã—ã¦ã„ã¾ã™ã€‚",
                actions: [
                    "å†…éƒ¨ç•™ä¿ã‚’åšãã—ã€æ¬¡ã®å‡ºåº—ã‚„æ”¹è£…ã¸ã®æŠ•è³‡è³‡é‡‘ã‚’æº–å‚™ã—ã¾ã—ã‚‡ã†ã€‚",
                    "ã‚¹ã‚¿ãƒƒãƒ•ã¸ã®é‚„å…ƒã‚„æ•™è‚²æŠ•è³‡ã§ã€ã•ã‚‰ãªã‚‹ã‚µãƒ¼ãƒ“ã‚¹å‘ä¸Šã‚’ç›®æŒ‡ã—ã¦ãã ã•ã„ã€‚"
                ]
            });
        }

        // ã‚«ãƒ¼ãƒ‰ç”Ÿæˆ
        adviceCards.forEach(card => {
            const cardEl = document.createElement('div');
            cardEl.className = 'advice-card';
            cardEl.innerHTML = `
                <h3 class="${card.status === 'danger' ? 'status-danger' : card.status === 'warning' ? 'status-warning' : 'status-success'}">
                    <span class="status-icon">${card.icon}</span> ${card.title}
                </h3>
                <p>${card.message}</p>
                <ul class="action-list">
                    ${card.actions.map(action => `<li>${action}</li>`).join('')}
                </ul>
            `;
            container.appendChild(cardEl);
        });
    };

    const runSimulation = (d, m) => {
        const targetOpMargin = parseFloat(document.getElementById("targetOperatingMargin").value) || 10;
        const grossMarginRatio = d.grossProfit / d.sales;
        const targetOpMarginRatio = targetOpMargin / 100;
        
        const simEl = document.getElementById("simulationText");
        
        if (grossMarginRatio <= targetOpMarginRatio) {
            simEl.innerHTML = `âš ï¸ ç›®æ¨™å–¶æ¥­åˆ©ç›Šç‡ ${targetOpMargin}% ã¯ç¾åœ¨ã®ç²—åˆ©ç‡(${m.grossMargin.toFixed(1)}%)ã§ã¯é”æˆå›°é›£ã§ã™ã€‚åŸä¾¡ç‡æ”¹å–„ãŒå¿…è¦ã§ã™ã€‚`;
            return;
        }

        const requiredSales = d.fixedCost / (grossMarginRatio - targetOpMarginRatio);
        const gap = requiredSales - d.sales;
        const gapText = gap > 0 
            ? `<span style="color:#dc3545; font-size:1.1em;">ã‚ã¨ ${Math.round(gap).toLocaleString()} å††ã®å£²ä¸Šå¢—ãŒå¿…è¦ã§ã™ â¤´ï¸</span>` 
            : `<span style="color:#28a745; font-size:1.1em;">ç›®æ¨™é”æˆä¸­ï¼ ä½™è£•é¡: ${Math.round(Math.abs(gap)).toLocaleString()} å†† ğŸ‰</span>`;

        simEl.innerHTML = `
            <strong>ğŸ¯ ç›®æ¨™é”æˆã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³</strong><br>
            ç›®æ¨™å–¶æ¥­åˆ©ç›Šç‡ <strong>${targetOpMargin}%</strong> é”æˆã«å¿…è¦ãªå£²ä¸Šé«˜: 
            <strong>${Math.round(requiredSales).toLocaleString()} å††</strong><br>
            ç¾çŠ¶ã¨ã®ã‚®ãƒ£ãƒƒãƒ—: ${gapText}
        `;
    };

    const updateDashboard = () => {
      try {
          const inputs = document.querySelectorAll('.input-form input:not([type="checkbox"])');
          const inputData = {};
          inputs.forEach(input => {
              inputData[input.id] = parseFloat(input.value) || 0;
          });

          const m = calcMetrics(inputData);
          const { score, comments, detailScores } = scoreMetrics(m);
          
          // ãƒ†ãƒ¼ãƒ–ãƒ«æ›´æ–°
          Object.keys(m).forEach(key => {
            const el = document.getElementById(key);
            if (el) {
              if (['salesPerEmployee', 'opPerEmployee', 'breakevenSales', 'cashFlow'].includes(key)) {
                el.textContent = `${Math.round(m[key]).toLocaleString()} å††`;
                if (key === 'cashFlow') el.style.color = m[key] < 0 ? '#dc3545' : '#28a745';
              } else if (key === 'totalAssetTurnover') {
                el.textContent = `${m[key].toFixed(2)} å›`;
              } else if (key === 'debtRepaymentPeriod') {
                el.textContent = `${m[key].toFixed(1)} å¹´`;
              } else {
                el.textContent = `${m[key].toFixed(1)} %`;
              }
            }
          });

          // ã‚¹ã‚³ã‚¢ãƒãƒƒã‚¸æ›´æ–°
          const getScoreClass = (scoreValue) => {
              if (scoreValue >= 80) return 'score-badge-100';
              if (scoreValue >= 60) return 'score-badge-80';
              if (scoreValue >= 40) return 'score-badge-60';
              if (scoreValue >= 20) return 'score-badge-40';
              if (scoreValue >= 0) return 'score-badge-20';
              return 'score-badge-0';
          };
          Object.keys(detailScores).forEach(key => {
              const el = document.getElementById(key);
              if (el) {
                  const scoreValue = detailScores[key];
                  el.innerHTML = `<span class="score-badge ${getScoreClass(scoreValue)}">${scoreValue}</span>`;
              }
          });
          
          // ã‚µãƒãƒªãƒ¼æ›´æ–°
          animateValue("scoreValue", 0, parseInt(score), 1000);
          
          const summaryList = document.getElementById("summaryText");
          summaryList.innerHTML = comments.map(c => `<li>${c}</li>`).join('');
          
          // ã‚¢ãƒ‰ãƒã‚¤ã‚¹ç”Ÿæˆ (NEW)
          const industryKey = document.getElementById("industryType").value;
          const bench = industryBenchmarks[industryKey] || industryBenchmarks.general;
          generateDetailedAdvice(m, bench);

          // ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
          runSimulation(inputData, m);

          // ã‚°ãƒ©ãƒ•æ›´æ–°
          updateRadarChart(m);
          updateCostStructureChart(inputData, m); 
          updateGaugeCharts(m);
          updateSalesTrendChart(inputData, m);
      } catch (e) {
          console.error("Dashboard Update Error:", e);
          alert("è¨ˆç®—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚å…¥åŠ›å€¤ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
      }
    };

    function updateRadarChart(m) {
        const labels = ['è³‡æœ¬åŠ¹ç‡ (ROE)', 'è³‡ç”£åŠ¹ç‡ (ROA)', 'å–¶æ¥­åˆ©ç›Šç‡', 'ã‚³ã‚¹ãƒˆç®¡ç† (FLæ¯”ç‡)', 'å®‰å…¨æ€§ (è‡ªå·±è³‡æœ¬æ¯”ç‡)', 'çµŒå–¶ä½“åŠ› (å®‰å…¨ä½™è£•ç‡)'];
        const data = [m.roe, m.roa, m.operatingMargin, 100 - m.flRatio, m.equityRatio, m.marginOfSafety];
        const averageData = [12.5, 4, 7.5, 40, 30, 20]; // 100-60=40
        const clippedData = data.map(v => Math.max(0, Math.min(100, v)));

        const chartData = {
            labels: labels,
            datasets: [{
                label: 'è‡ªç¤¾',
                data: clippedData,
                backgroundColor: 'rgba(0, 123, 255, 0.2)',
                borderColor: 'rgba(0, 123, 255, 1)',
                borderWidth: 2,
                pointBackgroundColor: 'rgba(0, 123, 255, 1)',
            }, {
                label: 'æ¨™æº–ç›®å®‰',
                data: averageData,
                backgroundColor: 'rgba(40, 167, 69, 0.2)',
                borderColor: 'rgba(40, 167, 69, 1)',
                borderWidth: 2,
                pointBackgroundColor: 'rgba(40, 167, 69, 1)',
            }]
        };

        if (radarChart) {
            radarChart.data = chartData;
            radarChart.update();
        } else {
            radarChart = new Chart(document.getElementById("radarChart"), { type: 'radar', data: chartData, options: { responsive: true, maintainAspectRatio: true }});
        }
    }

    function updateCostStructureChart(d, m) {
        const includeDirectorSalary = document.getElementById('includeDirectorSalary').checked;
        const laborCost = includeDirectorSalary ? d.laborCostExcluding + d.directorSalary : d.laborCostExcluding;
        const costOfGoods = d.sales - d.grossProfit;
        const otherFixedCost = d.fixedCost - laborCost;

        const data = {
            labels: ['åŸä¾¡ (Food)', 'äººä»¶è²» (Labor)', 'ãã®ä»–è²©ç®¡è²»', 'å–¶æ¥­åˆ©ç›Š'],
            datasets: [{
                data: [costOfGoods, laborCost, otherFixedCost, d.operatingProfit],
                backgroundColor: ['#e83e8c', '#007bff', '#6c757d', '#28a745'],
                hoverOffset: 10
            }]
        };
        
        if (costStructureChart) {
            costStructureChart.data = data;
            costStructureChart.update();
        } else {
            costStructureChart = new Chart(document.getElementById("costStructureChart"), { type: 'doughnut', data: data, options: { cutout: '60%' } });
        }
    }

    function updateGaugeCharts(m) {
        const equityData = {
            datasets: [{ data: [m.equityRatio, 100 - m.equityRatio], backgroundColor: ['#28a745', '#e9ecef'], borderWidth: 0 }]
        };
        const equityOptions = {
            circumference: 180, rotation: -90, cutout: '75%', responsive: true, maintainAspectRatio: true,
            plugins: { tooltip: { enabled: false }, gaugeText: { display: true, text: `${m.equityRatio.toFixed(1)}%`, subtext: 'è‡ªå·±è³‡æœ¬æ¯”ç‡' } }
        };
        if (equityRatioGauge) {
            equityRatioGauge.data = equityData;
            equityRatioGauge.options.plugins.gaugeText.text = `${m.equityRatio.toFixed(1)}%`;
            equityRatioGauge.update();
        } else {
            equityRatioGauge = new Chart(document.getElementById("equityRatioGauge"), { type: 'doughnut', data: equityData, options: equityOptions });
        }
        
        const currentRatioClipped = Math.min(m.currentRatio, 200);
        const currentData = {
            datasets: [{ data: [currentRatioClipped, 200 - currentRatioClipped], backgroundColor: ['#17a2b8', '#e9ecef'], borderWidth: 0 }]
        };
        const currentOptions = {
            circumference: 180, rotation: -90, cutout: '75%', responsive: true, maintainAspectRatio: true,
            plugins: { tooltip: { enabled: false }, gaugeText: { display: true, text: `${m.currentRatio.toFixed(1)}%`, subtext: 'æµå‹•æ¯”ç‡' } }
        };
        if (currentRatioGauge) {
            currentRatioGauge.data = currentData;
            currentRatioGauge.options.plugins.gaugeText.text = `${m.currentRatio.toFixed(1)}%`;
            currentRatioGauge.update();
        } else {
            currentRatioGauge = new Chart(document.getElementById("currentRatioGauge"), { type: 'doughnut', data: currentData, options: currentOptions });
        }
    }
    
    function updateSalesTrendChart(d, m) {
        const labels = ['æœ€æ–°æœŸ'];
        const chartData = {
            labels: labels,
            datasets: [
                {
                    type: 'bar',
                    label: 'å£²ä¸Šé«˜',
                    data: [d.sales],
                    backgroundColor: 'rgba(0, 123, 255, 0.6)',
                    yAxisID: 'yAmount',
                },
                {
                    type: 'bar',
                    label: 'å–¶æ¥­åˆ©ç›Š',
                    data: [d.operatingProfit],
                    backgroundColor: 'rgba(23, 162, 184, 0.6)',
                    yAxisID: 'yAmount',
                },
                {
                    type: 'line',
                    label: 'å–¶æ¥­åˆ©ç›Šç‡',
                    data: [m.operatingMargin],
                    borderColor: 'rgb(255, 193, 7)',
                    backgroundColor: 'rgba(255, 193, 7, 0.2)',
                    borderWidth: 3,
                    tension: 0.1,
                    fill: false,
                    yAxisID: 'yRatio',
                }
            ]
        };
        
        const options = {
            responsive: true,
            maintainAspectRatio: true,
            scales: {
                yAmount: {
                    type: 'linear',
                    position: 'left',
                    title: { display: true, text: 'é‡‘é¡ (å††)' },
                    ticks: { callback: value => new Intl.NumberFormat('ja-JP').format(value) }
                },
                yRatio: {
                    type: 'linear',
                    position: 'right',
                    title: { display: true, text: 'æ¯”ç‡ (%)' },
                    grid: { drawOnChartArea: false },
                    ticks: { callback: value => `${value}%` }
                }
            }
        };

        if (salesTrendChart) {
            salesTrendChart.data = chartData;
            salesTrendChart.update();
        } else {
            salesTrendChart = new Chart(document.getElementById("salesTrendChart"), { data: chartData, options: options });
        }
    }

    const saveToExcel = () => {
      const table = document.getElementById("analysisTable");
      let csv = ['\uFEFF'];
      const headers = Array.from(table.querySelectorAll('thead th')).map(th => `"${th.textContent.trim()}"`);
      csv.push(headers.join(','));
      table.querySelectorAll('tbody tr').forEach(row => {
          let rowData = Array.from(row.querySelectorAll('th, td')).map(cell => `"${cell.textContent.trim().replace(/"/g, '""')}"`);
          csv.push(rowData.join(','));
      });
      const blob = new Blob([csv.join('\n')], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement("a");
      link.setAttribute("href", URL.createObjectURL(blob));
      link.setAttribute("download", "çµŒå–¶åˆ†æçµæœ.csv");
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    };

    const generatePDF = async () => {
      const { jsPDF } = window.jspdf;
      const pdfButton = document.getElementById("generatePdfButton");
      const originalButtonText = pdfButton.textContent;
      pdfButton.textContent = "PDFä½œæˆä¸­...";
      pdfButton.disabled = true;

      const summaryBox = document.querySelector('.summary-box');
      const adviceBox = document.querySelector('.advice-box'); // æ–°è¦è¿½åŠ 
      const analysisTable = document.querySelector('#analysisTable');
      const chartsGrid = document.querySelector('.charts-grid');
      
      const pdfOptions = { scale: 2, useCORS: true, backgroundColor: "#ffffff" };

      try {
        const doc = new jsPDF('p', 'mm', 'a4');
        const pdfWidth = doc.internal.pageSize.getWidth();
        const pdfHeight = doc.internal.pageSize.getHeight();
        const margin = 10;
        const contentWidth = pdfWidth - margin * 2;
        let currentY = margin;
        
        doc.setFontSize(16);
        doc.text("é£²é£Ÿåº—çµŒå–¶åˆ†æãƒ¬ãƒãƒ¼ãƒˆ", pdfWidth / 2, currentY, { align: "center" });
        currentY += 10;

        // 1. ã‚µãƒãƒªãƒ¼
        const canvasSummary = await html2canvas(summaryBox, pdfOptions);
        const imgSummaryData = canvasSummary.toDataURL('image/png');
        const imgSummaryHeight = canvasSummary.height * contentWidth / canvasSummary.width;
        doc.addImage(imgSummaryData, 'PNG', margin, currentY, contentWidth, imgSummaryHeight);
        currentY += imgSummaryHeight + 5;

        // 2. ã‚¢ãƒ‰ãƒã‚¤ã‚¹ (NEW)
        if (adviceBox.style.display !== 'none') {
            const canvasAdvice = await html2canvas(adviceBox, pdfOptions);
            const imgAdviceData = canvasAdvice.toDataURL('image/png');
            const imgAdviceHeight = canvasAdvice.height * contentWidth / canvasAdvice.width;
            
            // æ”¹ãƒšãƒ¼ã‚¸åˆ¤å®š
            if (currentY + imgAdviceHeight > pdfHeight) { doc.addPage(); currentY = margin; }
            
            doc.addImage(imgAdviceData, 'PNG', margin, currentY, contentWidth, imgAdviceHeight);
            currentY += imgAdviceHeight + 5;
        }

        // 3. ãƒ†ãƒ¼ãƒ–ãƒ«
        const canvasTable = await html2canvas(analysisTable, pdfOptions);
        const imgTableData = canvasTable.toDataURL('image/png');
        const imgTableHeight = canvasTable.height * contentWidth / canvasTable.width;
        
        if (currentY + imgTableHeight > pdfHeight) { doc.addPage(); currentY = margin; }
        doc.addImage(imgTableData, 'PNG', margin, currentY, contentWidth, imgTableHeight);

        // 4. ãƒãƒ£ãƒ¼ãƒˆ
        doc.addPage();
        const canvasCharts = await html2canvas(chartsGrid, { ...pdfOptions, backgroundColor: "#ffffff"});
        const imgChartsData = canvasCharts.toDataURL('image/png');
        const imgChartsHeight = canvasCharts.height * pdfWidth / canvasCharts.width;
        const finalChartHeight = Math.min(imgChartsHeight, pdfHeight);
        doc.addImage(imgChartsData, 'PNG', 0, 0, pdfWidth, finalChartHeight);

        doc.save("çµŒå–¶åˆ†æãƒ¬ãƒãƒ¼ãƒˆ.pdf");

      } catch (err) {
        console.error("PDFã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ:", err);
        alert("PDFã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
      } finally {
        pdfButton.textContent = originalButtonText;
        pdfButton.disabled = false;
      }
    };

    const updateEmployeeCount = () => {
      const sales = parseFloat(document.getElementById("sales").value);
      if (!isNaN(sales) && sales > 0) {
        document.getElementById("employees").value = Math.ceil(sales / 10000000);
      }
    };
    
    window.onload = () => {
      updateEmployeeCount();
      setTimeout(updateDashboard, 100);
      document.getElementById('includeDirectorLoan').addEventListener('change', updateDashboard);
      document.getElementById('includeDirectorSalary').addEventListener('change', updateDashboard);
      document.getElementById('targetOperatingMargin').addEventListener('change', updateDashboard); 
      document.getElementById('depreciation').addEventListener('change', updateDashboard); 
      document.getElementById('debtRepayment').addEventListener('change', updateDashboard); 
    };
  </script>
</body>
</html>
