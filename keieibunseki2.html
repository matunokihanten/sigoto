<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>飲食店経営分析ダッシュボード</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      margin: 20px;
      background: #f8f9fa;
      color: #343a40;
    }
    h1, h2 { text-align: center; }
    h1 { margin-bottom: 30px; }

    .input-form {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 20px;
      margin-bottom: 30px;
    }
    .input-group {
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.05);
      width: 45%;
      min-width: 320px;
    }
    .input-group h2 {
      margin-top: 0;
      border-bottom: 1px solid #dee2e6;
      padding-bottom: 10px;
      font-size: 1.25em;
    }
    .input-group label {
      display: block;
      margin-top: 10px;
      font-weight: bold;
      font-size: 0.9em;
    }
    .input-group input {
      width: 100%;
      padding: 8px;
      margin-top: 5px;
      box-sizing: border-box;
      border: 1px solid #ced4da;
      border-radius: 4px;
      transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
    }
    .input-group input:focus {
        border-color: #80bdff;
        outline: 0;
        box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25);
    }

    .checkbox-container {
      display: flex;
      align-items: center;
      margin-top: 10px;
      font-weight: normal;
    }
    .checkbox-container input[type="checkbox"] {
      width: auto;
      margin-right: 10px;
    }

    .button-group {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin: 30px auto;
      flex-wrap: wrap;
    }
    .button-group button {
      width: 220px;
      padding: 12px;
      border: none;
      border-radius: 5px;
      font-size: 16px;
      cursor: pointer;
      font-weight: bold;
      transition: opacity 0.2s;
    }
    .button-group button:hover { opacity: 0.85; }
    #updateButton { background: #007bff; color: #fff; }
    #saveExcelButton { background: #28a745; color: #fff; }
    #generatePdfButton { background: #dc3545; color: #fff; }
    
    #report-content { padding: 10px; }

    .summary-box {
      background: #e9ecef;
      border: 1px solid #dee2e6;
      border-radius: 8px;
      padding: 25px;
      margin: 30px auto;
      width: 90%;
      max-width: 1200px;
    }
    .summary-box h2 { font-size: 1.5em; }
    .score {
      font-size: 2.5em;
      font-weight: bold;
      color: #007bff;
      text-align: center;
      margin-bottom: 15px;
    }
    #summaryText {
        padding-left: 20px;
    }
    
    table {
      margin: 30px auto;
      border-collapse: collapse;
      width: 90%;
      max-width: 1200px;
      background: #fff;
      box-shadow: 0 4px 6px rgba(0,0,0,0.05);
    }
    th, td {
      padding: 12px 15px;
      border: 1px solid #dee2e6;
      text-align: right;
    }
    th { background: #f8f9fa; font-weight: bold; }
    tbody th { background: #e9ecef; }
    .metric-name { text-align: left; }
    .metric-formula { text-align: left; font-family: monospace; color: #555; }

    .score-badge {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 12px;
        color: #fff;
        font-weight: bold;
        font-size: 0.8em;
        margin-left: 10px;
    }
    .score-badge-100 { background-color: #28a745; }
    .score-badge-80 { background-color: #17a2b8; }
    .score-badge-60 { background-color: #ffc107; }
    .score-badge-40 { background-color: #fd7e14; }
    .score-badge-20 { background-color: #dc3545; }
    .score-badge-0 { background-color: #6c757d; }

    .charts-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(380px, 1fr));
      gap: 30px;
      margin: 40px auto;
      padding: 0;
      width: 90%;
      max-width: 1200px;
    }
    .chart-container {
      background: #fff;
      padding: 25px;
      border-radius: 8px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.05);
    }
    .chart-container h2 {
      margin-top: 0;
      text-align: center;
      font-size: 1.3em;
      border-bottom: 1px solid #eee;
      padding-bottom: 15px;
      margin-bottom: 25px;
    }
    .gauge-container {
        display: flex;
        justify-content: space-around;
        align-items: flex-start;
        flex-wrap: wrap;
    }
  </style>
</head>
<body>

  <h1>飲食店経営分析ダッシュボード</h1>

  <div class="input-form">
    <div class="input-group" id="plData">
      <h2>損益計算書データ</h2>
      <label for="sales">売上高合計:</label>
      <input type="number" id="sales" value="87372059" onchange="updateEmployeeCount()">
      <label for="grossProfit">売上総利益:</label>
      <input type="number" id="grossProfit" value="59773028">
      <label for="operatingProfit">営業利益:</label>
      <input type="number" id="operatingProfit" value="6192140">
      <label for="recurringProfit">経常利益:</label>
      <input type="number" id="recurringProfit" value="6131225">
      <label for="netProfit">当期純利益:</label>
      <input type="number" id="netProfit" value="4783999">
      <label for="fixedCost">販売費・一般管理費合計:</label>
      <input type="number" id="fixedCost" value="53580888">
      <label for="laborCostExcluding">人件費（役員報酬含まない）:</label>
      <input type="number" id="laborCostExcluding" value="19506662">
      <label for="directorSalary">役員報酬:</label>
      <input type="number" id="directorSalary" value="10816000">
      <div class="checkbox-container">
        <input type="checkbox" id="includeDirectorSalary" checked>
        <label for="includeDirectorSalary">人件費に役員報酬を含める</label>
      </div>
      <label for="employees">従業員数:</label>
      <input type="number" id="employees" value="9">
    </div>

    <div class="input-group" id="bsData">
      <h2>貸借対照表データ</h2>
      <label for="totalAssets">資産合計:</label>
      <input type="number" id="totalAssets" value="103504754">
      <label for="currentAssets">流動資産:</label>
      <input type="number" id="currentAssets" value="13077908">
      <label for="fixedAssets">固定資産:</label>
      <input type="number" id="fixedAssets" value="90426846">
      <label for="liabilities">負債合計:</label>
      <input type="number" id="liabilities" value="72979123">
      <label for="currentLiabilities">流動負債:</label>
      <input type="number" id="currentLiabilities" value="48160743">
      <label for="fixedLiabilities">固定負債:</label>
      <input type="number" id="fixedLiabilities" value="24818380">
      <label for="equity">純資産合計（自己資本）:</label>
      <input type="number" id="equity" value="30525631">
      <label for="interestBearingDebt">有利子負債合計:</label>
      <input type="number" id="interestBearingDebt" value="56258235">
      <label for="directorLoan">役員借入金:</label>
      <input type="number" id="directorLoan" value="31720235">
      <div class="checkbox-container">
        <input type="checkbox" id="includeDirectorLoan" checked>
        <label for="includeDirectorLoan">有利子負債に役員借入金を含める</label>
      </div>
    </div>
  </div>

  <div class="button-group">
    <button id="updateButton" onclick="updateDashboard()">ダッシュボードを更新</button>
    <button id="saveExcelButton" onclick="saveToExcel()">分析結果をExcel保存</button>
    <button id="generatePdfButton" onclick="generatePDF()">分析レポートをPDF保存</button>
  </div>

  <div id="report-content">
    <div class="summary-box">
      <h2>経営状況の総括</h2>
      <div class="score" id="score">-</div>
      <p id="summaryText"></p>
    </div>
    
    <table id="analysisTable">
      <thead>
        <tr><th class="metric-name">指標</th><th class="metric-formula">計算式</th><th class="metric-value">値</th><th class="score-column">スコア</th><th class="average-value">目安</th><th class="comment-text">コメント</th></tr>
      </thead>
      <tbody>
        <tr><th colspan="6" style="text-align: left;">収益性・効率性分析</th></tr>
        <tr><td class="metric-name">売上高総利益率</td><td class="metric-formula">売上総利益 / 売上高</td><td id="grossMargin">-</td><td id="grossMarginScore">-</td><td class="average-value">65～75%</td><td class="comment-text">商品競争力</td></tr>
        <tr><td class="metric-name">売上高営業利益率</td><td class="metric-formula">営業利益 / 売上高</td><td id="operatingMargin">-</td><td id="operatingMarginScore">-</td><td class="average-value">5～10%</td><td class="comment-text">本業での収益力</td></tr>
        <tr><td class="metric-name">売上高経常利益率</td><td class="metric-formula">経常利益 / 売上高</td><td id="recurringMargin">-</td><td id="recurringMarginScore">-</td><td class="average-value">3～8%</td><td class="comment-text">総合的な収益力</td></tr>
        <tr><td class="metric-name">売上高純利益率</td><td class="metric-formula">当期純利益 / 売上高</td><td id="netProfitMargin">-</td><td id="netProfitMarginScore">-</td><td class="average-value">2～5%</td><td class="comment-text">最終的な収益力</td></tr>
        <tr><td class="metric-name">総資産利益率 (ROA)</td><td class="metric-formula">当期純利益 / 総資産</td><td id="roa">-</td><td id="roaScore">-</td><td class="average-value">3～5%</td><td class="comment-text">資産全体の効率性</td></tr>
        <tr><td class="metric-name">自己資本利益率 (ROE)</td><td class="metric-formula">当期純利益 / 自己資本</td><td id="roe">-</td><td id="roeScore">-</td><td class="average-value">10～15%</td><td class="comment-text">株主資本の効率性</td></tr>
        <tr><td class="metric-name">損益分岐点比率</td><td class="metric-formula">損益分岐点売上高 / 売上高</td><td id="breakevenRatio">-</td><td id="breakevenRatioScore">-</td><td class="average-value">80%以下</td><td class="comment-text">赤字への抵抗力</td></tr>
        <tr><td class="metric-name">損益分岐点売上高</td><td class="metric-formula">固定費 / (1 - (売上原価 / 売上高))</td><td id="breakevenSales">-</td><td id="breakevenSalesScore">-</td><td class="average-value">8000万円以下</td><td class="comment-text">損益分岐点となる売上</td></tr>
        <tr><td class="metric-name">労働分配率</td><td class="metric-formula">人件費 / 売上総利益</td><td id="laborShare">-</td><td id="laborShareScore">-</td><td class="average-value">35～45%</td><td class="comment-text">付加価値の人件費配分</td></tr>
        <tr><td class="metric-name">人件費率</td><td class="metric-formula">人件費 / 売上高</td><td id="laborCostRatio">-</td><td id="laborCostRatioScore">-</td><td class="average-value">30～35%</td><td class="comment-text">売上に対する人件費の割合</td></tr>
        <tr><td class="metric-name">一人当たり売上高</td><td class="metric-formula">売上高 / 従業員数</td><td id="salesPerEmployee">-</td><td id="salesPerEmployeeScore">-</td><td class="average-value">800万円以上</td><td class="comment-text">労働生産性（売上）</td></tr>
        <tr><td class="metric-name">一人当たり営業利益</td><td class="metric-formula">営業利益 / 従業員数</td><td id="opPerEmployee">-</td><td id="opPerEmployeeScore">-</td><td class="average-value">50万円以上</td><td class="comment-text">労働生産性（利益）</td></tr>
        <tr><td class="metric-name">総資本回転率</td><td class="metric-formula">売上高 / 総資産</td><td id="totalAssetTurnover">-</td><td id="totalAssetTurnoverScore">-</td><td class="average-value">1.0～1.5回</td><td class="comment-text">資産の回転効率</td></tr>
        <tr><th colspan="6" style="text-align: left;">安全性・資本構成分析</th></tr>
        <tr><td class="metric-name">自己資本比率</td><td class="metric-formula">自己資本 / 総資産</td><td id="equityRatio">-</td><td id="equityRatioScore">-</td><td class="average-value">30%以上</td><td class="comment-text">財務基盤の安定性</td></tr>
        <tr><td class="metric-name">流動比率</td><td class="metric-formula">流動資産 / 流動負債</td><td id="currentRatio">-</td><td id="currentRatioScore">-</td><td class="average-value">120%以上</td><td class="comment-text">短期的な支払能力</td></tr>
        <tr><td class="metric-name">固定比率</td><td class="metric-formula">固定資産 / 自己資本</td><td id="fixedRatio">-</td><td id="fixedRatioScore">-</td><td class="average-value">100%以下</td><td class="comment-text">設備投資の健全性</td></tr>
        <tr><td class="metric-name">固定長期適合率</td><td class="metric-formula">固定資産 / (自己資本 + 固定負債)</td><td id="fixedLongRatio">-</td><td id="fixedLongRatioScore">-</td><td class="average-value">100%以下</td><td class="comment-text">長期的な安定性</td></tr>
        <tr><td class="metric-name">負債比率</td><td class="metric-formula">負債合計 / 自己資本</td><td id="debtRatio">-</td><td id="debtRatioScore">-</td><td class="average-text">100%以下</td><td class="comment-text">他人資本への依存度</td></tr>
        <tr><td class="metric-name">有利子負債依存度</td><td class="metric-formula">有利子負債 / 総資産</td><td id="interestBearingDebtRatio">-</td><td id="interestBearingDebtRatioScore">-</td><td class="average-value">40%以下</td><td class="comment-text">借入金の返済負担リスク</td></tr>
      </tbody>
    </table>

    <div class="charts-grid">
        <div class="chart-container">
            <h2>経営健全性サマリー</h2>
            <canvas id="radarChart"></canvas>
        </div>
        <div class="chart-container">
            <h2>費用構成 (販管費)</h2>
            <canvas id="costStructureChart"></canvas>
        </div>
        <div class="chart-container">
            <h2>安全性指標</h2>
            <div class="gauge-container">
              <canvas id="equityRatioGauge"></canvas>
              <canvas id="currentRatioGauge"></canvas>
            </div>
        </div>
        <div class="chart-container">
            <h2>収益性 時系列推移</h2>
            <canvas id="salesTrendChart"></canvas>
        </div>
    </div>
    </div>

  <script>
    let radarChart, costStructureChart, equityRatioGauge, currentRatioGauge, salesTrendChart;

    const gaugeTextPlugin = {
      id: 'gaugeText',
      afterDraw(chart) {
        const { ctx, config } = chart;
        const GAUGE_TEXT_CONFIG = config.options.plugins.gaugeText;
        if (!GAUGE_TEXT_CONFIG?.display) return;

        const text = GAUGE_TEXT_CONFIG.text;
        const subtext = GAUGE_TEXT_CONFIG.subtext;
        const color = GAUGE_TEXT_CONFIG.color || '#343a40';
        
        ctx.save();
        const centerX = (chart.chartArea.left + chart.chartArea.right) / 2;
        const centerY = (chart.chartArea.top + chart.chartArea.bottom) / 1.5;

        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.font = GAUGE_TEXT_CONFIG.font || 'bold 2em sans-serif';
        ctx.fillStyle = color;
        ctx.fillText(text, centerX, centerY);
        
        if (subtext) {
          ctx.font = 'bold 1em sans-serif';
          ctx.fillStyle = '#6c757d';
          ctx.fillText(subtext, centerX, centerY + 30);
        }
        ctx.restore();
      }
    };
    Chart.register(gaugeTextPlugin);

    // スコア計算ロジックを修正：目安の範囲から外れても0にならないように
    const getScore = (value, targetMin, targetMax, isHigherBetter = true) => {
        let score;
        const idealScore = 100;
        const acceptableScore = 50;

        if (isHigherBetter) {
            if (value >= targetMax) {
                score = idealScore;
            } else if (value >= targetMin) {
                score = acceptableScore + ((value - targetMin) / (targetMax - targetMin)) * (idealScore - acceptableScore);
            } else {
                // 目安範囲を外れた場合、乖離度に応じて0〜50点の範囲で減点
                const diff = targetMin - value;
                const penaltyScale = targetMin * 0.5; // 例: 目安値の50%を乖離の減点スケールとする
                score = acceptableScore - (diff / penaltyScale) * acceptableScore;
            }
        } else { // isLowerBetter
            if (value <= targetMin) {
                score = idealScore;
            } else if (value <= targetMax) {
                score = acceptableScore + ((targetMax - value) / (targetMax - targetMin)) * (idealScore - acceptableScore);
            } else {
                // 目安範囲を外れた場合、乖離度に応じて0〜50点の範囲で減点
                const diff = value - targetMax;
                const penaltyScale = targetMax * 0.5; // 例: 目安値の50%を乖離の減点スケールとする
                score = acceptableScore - (diff / penaltyScale) * acceptableScore;
            }
        }
        
        return Math.round(Math.max(0, Math.min(100, score)));
    };

    const calcMetrics = (d) => {
      const safeDiv = (num, den) => (den > 0 ? num / den : 0);
      const contributionRate = safeDiv(d.grossProfit, d.sales);
      const breakevenSales = safeDiv(d.fixedCost, contributionRate);
      
      const includeDirectorLoan = document.getElementById('includeDirectorLoan').checked;
      const includeDirectorSalary = document.getElementById('includeDirectorSalary').checked;

      const totalLiabilities = d.liabilities;
      const interestBearingDebt = includeDirectorLoan ? d.interestBearingDebt : d.interestBearingDebt - d.directorLoan;
      const laborCost = includeDirectorSalary ? d.laborCostExcluding + d.directorSalary : d.laborCostExcluding;

      const adjustedFixedLiabilities = d.fixedLiabilities;
      const adjustedCurrentLiabilities = d.currentLiabilities;
      const adjustedEquity = d.equity + d.directorLoan;

      return {
        grossMargin: safeDiv(d.grossProfit, d.sales) * 100,
        operatingMargin: safeDiv(d.operatingProfit, d.sales) * 100,
        recurringMargin: safeDiv(d.recurringProfit, d.sales) * 100,
        netProfitMargin: safeDiv(d.netProfit, d.sales) * 100,
        roa: safeDiv(d.netProfit, d.totalAssets) * 100,
        roe: safeDiv(d.netProfit, d.equity) * 100,
        breakevenRatio: safeDiv(breakevenSales, d.sales) * 100,
        breakevenSales: breakevenSales,
        laborShare: safeDiv(laborCost, d.grossProfit) * 100,
        laborCostRatio: safeDiv(laborCost, d.sales) * 100,
        salesPerEmployee: safeDiv(d.sales, d.employees),
        opPerEmployee: safeDiv(d.operatingProfit, d.employees),
        totalAssetTurnover: safeDiv(d.sales, d.totalAssets),

        equityRatio: safeDiv(d.equity, d.totalAssets) * 100,
        currentRatio: safeDiv(d.currentAssets, adjustedCurrentLiabilities) * 100,
        fixedRatio: safeDiv(d.fixedAssets, d.equity) * 100,
        fixedLongRatio: safeDiv(d.fixedAssets, (d.equity + adjustedFixedLiabilities)) * 100,
        debtRatio: safeDiv(totalLiabilities, d.equity) * 100,
        interestBearingDebtRatio: safeDiv(interestBearingDebt, d.totalAssets) * 100
      };
    };

    const scoreMetrics = (m) => {
        let comments = [];
        const scores = {};
        
        // スコアリング
        scores.grossMarginScore = getScore(m.grossMargin, 65, 75);
        scores.operatingMarginScore = getScore(m.operatingMargin, 5, 10);
        scores.recurringMarginScore = getScore(m.recurringMargin, 3, 8);
        scores.netProfitMarginScore = getScore(m.netProfitMargin, 2, 5);
        scores.roaScore = getScore(m.roa, 3, 5);
        scores.roeScore = getScore(m.roe, 10, 15);
        scores.breakevenRatioScore = getScore(m.breakevenRatio, 50, 80, false);
        scores.breakevenSalesScore = getScore(m.breakevenSales, 50000000, 80000000, false);
        scores.laborShareScore = getScore(m.laborShare, 35, 45, false);
        scores.laborCostRatioScore = getScore(m.laborCostRatio, 30, 35, false);
        scores.salesPerEmployeeScore = getScore(m.salesPerEmployee, 8000000, 12000000);
        scores.opPerEmployeeScore = getScore(m.opPerEmployee, 500000, 1000000);
        scores.totalAssetTurnoverScore = getScore(m.totalAssetTurnover, 1.0, 1.5);
        scores.equityRatioScore = getScore(m.equityRatio, 30, 50);
        scores.currentRatioScore = getScore(m.currentRatio, 120, 200);
        scores.fixedRatioScore = getScore(m.fixedRatio, 80, 100, false);
        scores.fixedLongRatioScore = getScore(m.fixedLongRatio, 80, 100, false);
        scores.debtRatioScore = getScore(m.debtRatio, 50, 100, false);
        scores.interestBearingDebtRatioScore = getScore(m.interestBearingDebtRatio, 20, 40, false);

        // 総括コメント
        if (m.roe >= 10) comments.push("自己資本利益率(ROE)は良好です。資本を効率的に活用し利益を生み出せています。");
        else comments.push("自己資本利益率(ROE)が低めです。収益性を高めるか、資産効率の改善が必要です。");

        if (m.operatingMargin >= 5) comments.pu