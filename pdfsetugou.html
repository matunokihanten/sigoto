<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PDFçµåˆãƒ„ãƒ¼ãƒ«</title>
  <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
  <script src="https://unpkg.com/@pdf-lib/fontkit@1.0.1/dist/fontkit.umd.min.js"></script>
  <style>
    /* ãƒšãƒ¼ã‚¸å…¨ä½“ã®åŸºæœ¬ã‚¹ã‚¿ã‚¤ãƒ« */
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Hiragino Sans", "Noto Sans CJK JP", "Yu Gothic", sans-serif;
      background-color: #f4f4f9;
      color: #333;
      display: flex;
      justify-content: center;
      align-items: flex-start; /* ä¸Šéƒ¨ã«å¯„ã›ã‚‹ */
      min-height: 100vh;
      margin: 0;
      padding: 20px;
    }

    /* ã‚³ãƒ³ãƒ†ãƒŠã®ã‚¹ã‚¿ã‚¤ãƒ« */
    .container {
      max-width: 700px; /* å¹…ã‚’å°‘ã—åºƒã’ã‚‹ */
      width: 100%;
      background-color: #ffffff;
      border-radius: 8px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      padding: 30px;
      text-align: center;
      margin-top: 20px; /* ä¸Šéƒ¨ã«ãƒãƒ¼ã‚¸ãƒ³ */
    }

    h1 {
      color: #444;
      margin-bottom: 25px;
    }

    /* å…¥åŠ›æ¬„ã‚°ãƒ«ãƒ¼ãƒ— */
    .input-group {
      margin-bottom: 20px;
      text-align: left;
    }

    label {
      display: block;
      margin-bottom: 8px;
      font-weight: bold;
      color: #555;
    }

    input[type="file"] {
      width: 100%;
      padding: 10px;
      box-sizing: border-box;
      border: 1px solid #ddd;
      border-radius: 4px;
      background-color: #f9f9f9;
      cursor: pointer; /* ã‚«ãƒ¼ã‚½ãƒ«ã‚’ãƒã‚¤ãƒ³ã‚¿ãƒ¼ã« */
    }

    input[type="file"]:hover {
      border-color: #007bff;
    }

    /* ãƒ•ã‚¡ã‚¤ãƒ«ãƒªã‚¹ãƒˆã®ã‚¹ã‚¿ã‚¤ãƒ« */
    #fileList {
      list-style: none;
      padding: 0;
      margin: 20px 0;
      border: 1px solid #ddd;
      border-radius: 4px;
      background-color: #f9f9f9;
      min-height: 50px; /* ãƒ•ã‚¡ã‚¤ãƒ«ãŒãªã„ã¨ãã‚‚é ˜åŸŸã‚’ç¢ºä¿ */
      position: relative; /* ãƒ‰ãƒ©ãƒƒã‚°ã‚ªãƒ¼ãƒãƒ¼ã®ãƒœãƒ¼ãƒ€ãƒ¼ã®ãŸã‚ */
    }

    #fileList.drag-over-area {
        border: 2px dashed #007bff; /* ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‰ãƒ©ãƒƒã‚°æ™‚ã®å¼·èª¿è¡¨ç¤º */
        background-color: #e6f2ff;
    }

    .file-item {
      display: flex;
      align-items: center;
      padding: 10px;
      border-bottom: 1px solid #eee;
      cursor: grab; /* ãƒ‰ãƒ©ãƒƒã‚°å¯èƒ½ã§ã‚ã‚‹ã“ã¨ã‚’ç¤ºã™ã‚«ãƒ¼ã‚½ãƒ« */
      background-color: #fff;
      transition: background-color 0.2s ease;
    }

    .file-item:last-child {
      border-bottom: none;
    }

    .file-item:hover {
        background-color: #f0f0f0;
    }

    .file-item.dragging {
        opacity: 0.5; /* ãƒ‰ãƒ©ãƒƒã‚°ä¸­ã®ã‚¢ã‚¤ãƒ†ãƒ ã‚’åŠé€æ˜ã« */
    }

    .file-item.drag-over {
        border-top: 2px dashed #007bff; /* ãƒ‰ãƒ­ãƒƒãƒ—ä½ç½®ã‚’ç¤ºã™ */
    }
     .file-item.drag-over-bottom {
        border-bottom: 2px dashed #007bff; /* ãƒ‰ãƒ­ãƒƒãƒ—ä½ç½®ã‚’ç¤ºã™ */
    }


    .file-item span {
      flex-grow: 1; /* ãƒ•ã‚¡ã‚¤ãƒ«åãŒé ˜åŸŸã‚’å ã‚ã‚‹ã‚ˆã†ã« */
      text-align: left;
      padding-left: 10px; /* ãƒ‰ãƒ©ãƒƒã‚°ãƒãƒ³ãƒ‰ãƒ«ã¨ã®é–“ã«ã‚¹ãƒšãƒ¼ã‚¹ */
      word-break: break-all; /* é•·ã„ãƒ•ã‚¡ã‚¤ãƒ«åã‚’æŠ˜ã‚Šè¿”ã™ */
    }

    .file-item .remove-btn {
      background-color: #dc3545;
      color: white;
      border: none;
      border-radius: 4px;
      padding: 4px 8px;
      cursor: pointer;
      font-size: 0.8em;
      margin-left: 10px;
      transition: background-color 0.2s ease;
    }

    .file-item .remove-btn:hover {
      background-color: #c82333;
    }

    /* ãƒ‰ãƒ©ãƒƒã‚°ãƒãƒ³ãƒ‰ãƒ« */
    .drag-handle {
        cursor: grab;
        font-size: 1.2em;
        color: #888;
        padding: 0 5px;
    }
     .drag-handle:active {
         cursor: grabbing;
     }


    /* ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    .button-group {
        margin-top: 20px;
    }
    button {
      width: 48%;
      padding: 12px;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: background-color 0.3s;
      margin: 0 1%; /* ãƒœã‚¿ãƒ³é–“ã®ã‚¹ãƒšãƒ¼ã‚¹ã‚’èª¿æ•´ */
      box-sizing: border-box;
    }

    button:hover {
      background-color: #0056b3;
    }

    button:disabled {
      background-color: #cccccc;
      cursor: not-allowed;
    }

    /* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º */
    #status {
      margin-top: 20px;
      font-weight: bold;
      min-height: 24px; /* é ˜åŸŸã‚’ç¢ºä¿ */
    }

    .status-success {
      color: #28a745;
    }

    .status-error {
      color: #dc3545;
    }
     .status-info {
        color: #007bff;
     }
  </style>
</head>
<body>
  <div class="container">
    <h1>PDFçµåˆãƒ„ãƒ¼ãƒ«</h1>

    <div class="input-group">
      <label for="pdfFiles">1. çµåˆã—ãŸã„PDFãƒ•ã‚¡ã‚¤ãƒ«ã‚„ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ (è¤‡æ•°é¸æŠå¯)</label>
      <input type="file" id="pdfFiles" accept=".pdf, .jpg, .jpeg, .png" multiple>
    </div>

    <div class="input-group">
        <label>2. çµåˆé †ã‚’ç¢ºèªãƒ»ä¸¦ã¹æ›¿ãˆ</label>
        <ul id="fileList">
            <li style="padding: 10px; color: #666; text-align: center;">PDF/ç”»åƒã‚’ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—ã™ã‚‹ã‹ã€ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚</li>
        </ul>
        <p style="font-size: 0.9em; color: #666; margin-top: 5px;">â€» ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦ä¸¦ã¹æ›¿ãˆã‚‰ã‚Œã¾ã™ã€‚</p>
    </div>


    <div class="button-group">
        <button id="mergeButton" disabled>PDFã‚’çµåˆã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
        <button id="clearButton" disabled>ãƒªã‚¹ãƒˆã‚’ã‚¯ãƒªã‚¢</button>
    </div>


    <p id="status"></p>

  </div>

  <script>
    const { PDFDocument, rgb, StandardFonts } = PDFLib;

    // HTMLè¦ç´ ã®å–å¾—
    const pdfFilesInput = document.getElementById('pdfFiles');
    const fileListEl = document.getElementById('fileList');
    const mergeButton = document.getElementById('mergeButton');
    const clearButton = document.getElementById('clearButton');
    const statusEl = document.getElementById('status');

    // é¸æŠã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã¨ãã®ãƒ‡ãƒ¼ã‚¿ã‚’ä¿æŒã™ã‚‹é…åˆ—
    // { name: 'file.pdf', type: 'pdf'|'image', file: Fileã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ, arrayBuffer: ArrayBuffer } ã®å½¢å¼ã§ä¿æŒ
    let selectedFiles = [];

    // ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—é–¢é€£ã®å¤‰æ•° (ãƒªã‚¹ãƒˆå†…ã®ã‚¢ã‚¤ãƒ†ãƒ ä¸¦ã¹æ›¿ãˆç”¨)
    let draggedItem = null;

    // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤ºã®é–¢æ•°
    function displayStatus(message, type = '') {
      statusEl.textContent = message;
      statusEl.className = ''; // æ—¢å­˜ã®ã‚¯ãƒ©ã‚¹ã‚’ãƒªã‚»ãƒƒãƒˆ
      if (type === 'success') {
        statusEl.classList.add('status-success');
      } else if (type === 'error') {
        statusEl.classList.add('status-error');
      } else if (type === 'info') {
        statusEl.classList.add('status-info');
      }
    }

    // ãƒ•ã‚¡ã‚¤ãƒ«ãƒªã‚¹ãƒˆã‚’UIã«æç”»ã™ã‚‹é–¢æ•°
    function renderFileList() {
      fileListEl.innerHTML = ''; // ãƒªã‚¹ãƒˆã‚’ã‚¯ãƒªã‚¢
      if (selectedFiles.length === 0) {
        fileListEl.innerHTML = '<li style="padding: 10px; color: #666; text-align: center;">PDF/ç”»åƒã‚’ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—ã™ã‚‹ã‹ã€ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚</li>';
        mergeButton.disabled = true;
        clearButton.disabled = true;
        return;
      }

      selectedFiles.forEach((fileData, index) => {
        const li = document.createElement('li');
        li.classList.add('file-item');
        li.setAttribute('draggable', true); // ãƒ‰ãƒ©ãƒƒã‚°å¯èƒ½ã«ã™ã‚‹
        li.dataset.index = index; // ãƒ‡ãƒ¼ã‚¿å±æ€§ã«ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ä¿å­˜

        // ãƒ‰ãƒ©ãƒƒã‚°ãƒãƒ³ãƒ‰ãƒ«
        const handle = document.createElement('span');
        handle.classList.add('drag-handle');
        handle.textContent = 'â ¿'; // ã¾ãŸã¯ä»–ã®ã‚¢ã‚¤ã‚³ãƒ³ï¼ˆä¾‹: 'â˜°'ï¼‰
        li.appendChild(handle);

        // ãƒ•ã‚¡ã‚¤ãƒ«å
        const span = document.createElement('span');
        let typeIcon = '';
        if (fileData.type === 'pdf') {
            typeIcon = 'ğŸ“„ '; // PDFã‚¢ã‚¤ã‚³ãƒ³
        } else if (fileData.type === 'image') {
            typeIcon = 'ğŸï¸ '; // ç”»åƒã‚¢ã‚¤ã‚³ãƒ³
        }
        span.textContent = typeIcon + fileData.name;
        li.appendChild(span);

        // å‰Šé™¤ãƒœã‚¿ãƒ³
        const removeBtn = document.createElement('button');
        removeBtn.classList.add('remove-btn');
        removeBtn.textContent = 'å‰Šé™¤';
        removeBtn.addEventListener('click', () => {
          removeFile(index);
        });
        li.appendChild(removeBtn);

        fileListEl.appendChild(li);
      });

      // ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š (ãƒªã‚¹ãƒˆã‚¢ã‚¤ãƒ†ãƒ ä¸¦ã¹æ›¿ãˆç”¨)
      addDragDropListenersForItems();

      // ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’æ›´æ–°
      mergeButton.disabled = selectedFiles.length < 1; // 1ãƒ•ã‚¡ã‚¤ãƒ«ä»¥ä¸Šã§æœ‰åŠ¹ (ç”»åƒå¤‰æ›å¾Œã«1ã¤ã ã‘ã§ã‚‚DLã§ãã‚‹ã‚ˆã†ã«)
      clearButton.disabled = false;
    }

    // ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒªã‚¹ãƒˆã‹ã‚‰å‰Šé™¤ã™ã‚‹é–¢æ•°
    function removeFile(index) {
      selectedFiles.splice(index, 1); // é…åˆ—ã‹ã‚‰å‰Šé™¤
      renderFileList(); // ãƒªã‚¹ãƒˆã‚’å†æç”»
      displayStatus(''); // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ã‚¯ãƒªã‚¢
    }

    // ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ ã™ã‚‹é–¢æ•° (ãƒªã‚¹ãƒˆã‚¢ã‚¤ãƒ†ãƒ ä¸¦ã¹æ›¿ãˆç”¨)
    function addDragDropListenersForItems() {
        const items = fileListEl.querySelectorAll('.file-item');

        items.forEach(item => {
            item.addEventListener('dragstart', handleDragStart);
            item.addEventListener('dragover', handleDragOver);
            item.addEventListener('dragleave', handleDragLeave);
            item.addEventListener('drop', handleDrop);
            item.addEventListener('dragend', handleDragEnd);
        });
    }

    // ãƒ‰ãƒ©ãƒƒã‚°é–‹å§‹æ™‚ã®å‡¦ç† (ãƒªã‚¹ãƒˆã‚¢ã‚¤ãƒ†ãƒ ä¸¦ã¹æ›¿ãˆç”¨)
    function handleDragStart(e) {
        draggedItem = e.target;
        e.dataTransfer.effectAllowed = 'move';
        setTimeout(() => {
             draggedItem.classList.add('dragging');
        }, 0);
    }

    // ãƒ‰ãƒ©ãƒƒã‚°è¦ç´ ãŒãƒ‰ãƒ­ãƒƒãƒ—ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã®ä¸Šã«ã‚ã‚‹æ™‚ã®å‡¦ç† (ãƒªã‚¹ãƒˆã‚¢ã‚¤ãƒ†ãƒ ä¸¦ã¹æ›¿ãˆç”¨)
    function handleDragOver(e) {
        e.preventDefault(); // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®æŒ™å‹• (ãƒ‰ãƒ­ãƒƒãƒ—ã‚’è¨±å¯ã—ãªã„) ã‚’ç„¡åŠ¹ã«ã™ã‚‹
        e.stopPropagation(); // è¦ªè¦ç´ ã®ãƒ‰ãƒ©ãƒƒã‚°ã‚¤ãƒ™ãƒ³ãƒˆã¨ç«¶åˆã—ãªã„ã‚ˆã†ã«ä¼æ’­ã‚’æ­¢ã‚ã‚‹
        e.dataTransfer.dropEffect = 'move';

        const targetItem = e.target.closest('.file-item');
        if (targetItem && targetItem !== draggedItem) {
             const rect = targetItem.getBoundingClientRect();
             const middleY = rect.top + rect.height / 2;

             // ä¸€æ—¦å…¨ã¦ã® drag-over ã‚¯ãƒ©ã‚¹ã‚’å‰Šé™¤
             fileListEl.querySelectorAll('.file-item').forEach(item => {
                 item.classList.remove('drag-over', 'drag-over-bottom');
             });

             if (e.clientY < middleY) {
                 targetItem.classList.add('drag-over');
             } else {
                 targetItem.classList.add('drag-over-bottom');
             }
        }
    }

    // ãƒ‰ãƒ©ãƒƒã‚°è¦ç´ ãŒãƒ‰ãƒ­ãƒƒãƒ—ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‹ã‚‰é›¢ã‚ŒãŸæ™‚ã®å‡¦ç† (ãƒªã‚¹ãƒˆã‚¢ã‚¤ãƒ†ãƒ ä¸¦ã¹æ›¿ãˆç”¨)
    function handleDragLeave(e) {
         if (!fileListEl.contains(e.relatedTarget)) {
              fileListEl.querySelectorAll('.file-item').forEach(item => {
                  item.classList.remove('drag-over', 'drag-over-bottom');
              });
         }
    }

    // ãƒ‰ãƒ©ãƒƒã‚°è¦ç´ ãŒãƒ‰ãƒ­ãƒƒãƒ—ã•ã‚ŒãŸæ™‚ã®å‡¦ç† (ãƒªã‚¹ãƒˆã‚¢ã‚¤ãƒ†ãƒ ä¸¦ã¹æ›¿ãˆç”¨)
    function handleDrop(e) {
        e.preventDefault();
        e.stopPropagation();

        const targetItem = e.target.closest('.file-item');
        if (targetItem && targetItem !== draggedItem) {
            const draggedIndex = parseInt(draggedItem.dataset.index);
            const targetIndex = parseInt(targetItem.dataset.index);

            const [removed] = selectedFiles.splice(draggedIndex, 1);
            const rect = targetItem.getBoundingClientRect();
            const middleY = rect.top + rect.height / 2;
            let insertIndex = targetIndex;
            if (e.clientY > middleY) {
                 insertIndex = targetIndex + 1;
                 if (draggedIndex < targetIndex) {
                     insertIndex--;
                 }
            } else {
                 if (draggedIndex > targetIndex) {
                     // insertIndexã¯ãã®ã¾ã¾ã§OK
                 }
            }

            selectedFiles.splice(insertIndex, 0, removed);

            renderFileList();
        }

        // ãƒ‰ãƒ©ãƒƒã‚°çµ‚äº†æ™‚ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
        handleDragEnd();
    }

    // ãƒ‰ãƒ©ãƒƒã‚°çµ‚äº†æ™‚ã®å‡¦ç† (ãƒªã‚¹ãƒˆã‚¢ã‚¤ãƒ†ãƒ ä¸¦ã¹æ›¿ãˆç”¨)
    function handleDragEnd() {
        fileListEl.querySelectorAll('.file-item').forEach(item => {
            item.classList.remove('dragging', 'drag-over', 'drag-over-bottom');
        });
        draggedItem = null;
    }


    // --- æ–°è¦è¿½åŠ : ãƒ•ã‚¡ã‚¤ãƒ«ã‚¨ãƒªã‚¢ã¸ã®ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—ã§ãƒ•ã‚¡ã‚¤ãƒ«è¿½åŠ  ---

    fileListEl.addEventListener('dragover', (e) => {
        e.preventDefault();
        e.stopPropagation();
        fileListEl.classList.add('drag-over-area');
        e.dataTransfer.dropEffect = 'copy'; // ãƒ‰ãƒ­ãƒƒãƒ—ã§ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚³ãƒ”ãƒ¼ã•ã‚Œã‚‹ã“ã¨ã‚’ç¤ºã™
    });

    fileListEl.addEventListener('dragleave', (e) => {
        e.preventDefault();
        e.stopPropagation();
        // ãƒã‚¦ã‚¹ãŒå®Œå…¨ã«è¦ç´ ã®å¤–ã«å‡ºãŸå ´åˆã®ã¿ã‚¯ãƒ©ã‚¹ã‚’å‰Šé™¤
        if (!fileListEl.contains(e.relatedTarget)) {
             fileListEl.classList.remove('drag-over-area');
        }
    });

    fileListEl.addEventListener('drop', async (e) => {
        e.preventDefault();
        e.stopPropagation();
        fileListEl.classList.remove('drag-over-area');

        const droppedFiles = Array.from(e.dataTransfer.files);
        await processAndAddFiles(droppedFiles);
    });

    // --- ç”»åƒã‚’PDFã«å¤‰æ›ã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•° ---
    async function convertImageToPdf(imageFile) {
        const img = new Image();
        const reader = new FileReader();

        return new Promise((resolve, reject) => {
            reader.onload = (e) => {
                img.onload = async () => {
                    try {
                        const pdfDoc = await PDFDocument.create();
                        const page = pdfDoc.addPage();

                        let imageEmbed;
                        if (imageFile.type === 'image/jpeg' || imageFile.type === 'image/jpg') {
                            imageEmbed = await pdfDoc.embedJpg(e.target.result);
                        } else if (imageFile.type === 'image/png') {
                            imageEmbed = await pdfDoc.embedPng(e.target.result);
                        } else {
                            throw new Error('Unsupported image format.');
                        }

                        // ç”»åƒã‚’ãƒšãƒ¼ã‚¸ã«ãƒ•ã‚£ãƒƒãƒˆã•ã›ã‚‹
                        const { width, height } = imageEmbed.scale(1);
                        const pageWidth = page.getWidth();
                        const pageHeight = page.getHeight();

                        const scaleX = pageWidth / width;
                        const scaleY = pageHeight / height;
                        const scale = Math.min(scaleX, scaleY);

                        const scaledWidth = width * scale;
                        const scaledHeight = height * scale;

                        // ãƒšãƒ¼ã‚¸ã®ä¸­å¤®ã«é…ç½®
                        const x = (pageWidth - scaledWidth) / 2;
                        const y = (pageHeight - scaledHeight) / 2;

                        page.drawImage(imageEmbed, {
                            x,
                            y,
                            width: scaledWidth,
                            height: scaledHeight,
                        });

                        const pdfBytes = await pdfDoc.save();
                        resolve(pdfBytes);
                    } catch (error) {
                        reject(new Error(`ç”»åƒã®PDFå¤‰æ›ã«å¤±æ•—ã—ã¾ã—ãŸ (${imageFile.name}): ${error.message}`));
                    }
                };
                img.onerror = () => reject(new Error(`ç”»åƒã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ (${imageFile.name})ã€‚`));
                img.src = e.target.result; // ç”»åƒãƒ‡ãƒ¼ã‚¿ã‚’Imageã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®srcã«è¨­å®š
            };
            reader.onerror = (err) => reject(new Error(`ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼ (${imageFile.name}): ${err.message}`));
            reader.readAsDataURL(imageFile); // ç”»åƒã¨ã—ã¦Data URLã§èª­ã¿è¾¼ã‚€
        });
    }

    // ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‡¦ç†ã—ã¦ãƒªã‚¹ãƒˆã«è¿½åŠ ã™ã‚‹å…±é€šé–¢æ•°
    async function processAndAddFiles(files) {
        if (files.length === 0) {
            displayStatus('');
            return;
        }

        displayStatus('ãƒ•ã‚¡ã‚¤ãƒ«ã®å†…å®¹ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...', 'info');

        const readPromises = files.map(file => {
            return new Promise(async (resolve) => {
                // æ—¢å­˜ã®ãƒ•ã‚¡ã‚¤ãƒ«åã¨é‡è¤‡ã—ãªã„ã‹ãƒã‚§ãƒƒã‚¯ (ç°¡æ˜“çš„ãªé‡è¤‡é˜²æ­¢)
                const isDuplicate = selectedFiles.some(f => f.name === file.name && f.file.size === file.size);
                if (isDuplicate) {
                    console.warn(`é‡è¤‡ãƒ•ã‚¡ã‚¤ãƒ«ã‚¹ã‚­ãƒƒãƒ—: ${file.name}`);
                    resolve(null); // é‡è¤‡ãƒ•ã‚¡ã‚¤ãƒ«ã¯ã‚¹ã‚­ãƒƒãƒ—
                    return;
                }

                if (file.type === 'application/pdf') {
                    const reader = new FileReader();
                    reader.onload = (e) => resolve({ name: file.name, type: 'pdf', file: file, arrayBuffer: e.target.result });
                    reader.onerror = (e) => {
                        console.error(`PDFèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼ (${file.name}):`, e);
                        displayStatus(`${file.name} ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚`, 'error');
                        resolve(null);
                    };
                    reader.readAsArrayBuffer(file);
                } else if (file.type.startsWith('image/')) {
                    try {
                        displayStatus(`${file.name} ã‚’PDFã«å¤‰æ›ä¸­...`, 'info');
                        const pdfBytes = await convertImageToPdf(file);
                        resolve({ name: `${file.name}.pdf`, type: 'image', file: file, arrayBuffer: pdfBytes }); // æ‹¡å¼µå­ã‚’.pdfã«ã™ã‚‹
                    } catch (error) {
                        console.error(`ç”»åƒå¤‰æ›ã‚¨ãƒ©ãƒ¼ (${file.name}):`, error);
                        displayStatus(`ç”»åƒãƒ•ã‚¡ã‚¤ãƒ« ${file.name} ã®PDFå¤‰æ›ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}`, 'error');
                        resolve(null);
                    }
                } else {
                    console.warn(`ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ãªã„ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼: ${file.name} (${file.type})`);
                    displayStatus(`ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ãªã„ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ã§ã™: ${file.name}`, 'error');
                    resolve(null);
                }
            });
        });

        const results = await Promise.all(readPromises);
        const validFiles = results.filter(result => result !== null);

        if (validFiles.length > 0) {
           selectedFiles = selectedFiles.concat(validFiles);
           renderFileList();
           displayStatus(`${validFiles.length}å€‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¿½åŠ ã—ã¾ã—ãŸã€‚`, 'success');
        } else {
           displayStatus('æœ‰åŠ¹ãªPDFã¾ãŸã¯ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠ/ãƒ‰ãƒ­ãƒƒãƒ—ã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚', 'error');
        }
    }


    // PDFãƒ•ã‚¡ã‚¤ãƒ«ã‚’çµåˆã™ã‚‹é–¢æ•°
    async function mergePdfs() {
      if (selectedFiles.length === 0) {
        displayStatus('çµåˆã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚Šã¾ã›ã‚“ã€‚', 'error');
        return;
      }

      displayStatus('PDFã®çµåˆã‚’é–‹å§‹ã—ã¾ã™...', 'info');
      mergeButton.disabled = true;
      clearButton.disabled = true;
      pdfFilesInput.disabled = true;

      try {
        const mergedPdf = await PDFDocument.create();

        for (const fileData of selectedFiles) {
          displayStatus(`${fileData.name} ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...`, 'info');
          let originalPdfDoc;
          try {
              originalPdfDoc = await PDFDocument.load(fileData.arrayBuffer);
          } catch (e) {
              console.error(`PDFèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼ (${fileData.name}):`, e);
              throw new Error(`${fileData.name} ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ•ã‚¡ã‚¤ãƒ«ãŒç ´æã—ã¦ã„ã‚‹ã‹ã€å¯¾å¿œã—ã¦ã„ãªã„å½¢å¼ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚`);
          }

          displayStatus(`${fileData.name} ã®ãƒšãƒ¼ã‚¸ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ã„ã¾ã™...`, 'info');
          try {
              const copiedPages = await mergedPdf.copyPages(originalPdfDoc, originalPdfDoc.getPageIndices());
              copiedPages.forEach((page) => {
                mergedPdf.addPage(page);
              });
          } catch (e) {
               console.error(`ãƒšãƒ¼ã‚¸ã‚³ãƒ”ãƒ¼ã‚¨ãƒ©ãƒ¼ (${fileData.name}):`, e);
               throw new Error(`${fileData.name} ã®ãƒšãƒ¼ã‚¸ã®ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚`);
          }

           originalPdfDoc = null; // ãƒ¡ãƒ¢ãƒªè§£æ”¾
        }

        displayStatus('çµåˆã•ã‚ŒãŸPDFã‚’ä¿å­˜ã—ã¦ã„ã¾ã™...', 'info');
        const mergedPdfBytes = await mergedPdf.save();

        displayStatus('ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æº–å‚™ä¸­ã§ã™...', 'info');
        const filename = "merged_document.pdf";
        const blob = new Blob([mergedPdfBytes], { type: "application/pdf" });
        const objectUrl = URL.createObjectURL(blob);

        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        if (isMobile) {
          window.open(objectUrl, '_blank');
        } else {
          const link = document.createElement('a');
          link.href = objectUrl;
          link.download = filename;
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
        }

        setTimeout(() => { URL.revokeObjectURL(objectUrl); }, 5000);

        displayStatus('å®Œäº†ã—ã¾ã—ãŸï¼çµåˆã•ã‚ŒãŸPDFã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãŒé–‹å§‹ã•ã‚Œã¾ã™ã€‚', 'success');

      } catch (e) {
        console.error("çµåˆå‡¦ç†ã‚¨ãƒ©ãƒ¼:", e);
        displayStatus(`ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${e.message}`, 'error');
      } finally {
        mergeButton.disabled = selectedFiles.length < 1;
        clearButton.disabled = selectedFiles.length === 0;
        pdfFilesInput.disabled = false;
        pdfFilesInput.value = '';
      }
    }

    // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠæ™‚ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©
    pdfFilesInput.addEventListener('change', async (event) => {
      const files = Array.from(event.target.files);
      await processAndAddFiles(files);
      event.target.value = ''; // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ input ã®å€¤ã‚’ãƒªã‚»ãƒƒãƒˆ
    });

    // çµåˆãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©
    mergeButton.addEventListener('click', mergePdfs);

    // ã‚¯ãƒªã‚¢ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©
    clearButton.addEventListener('click', () => {
        selectedFiles = [];
        renderFileList();
        displayStatus('ãƒ•ã‚¡ã‚¤ãƒ«ãƒªã‚¹ãƒˆã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸã€‚', 'info');
        pdfFilesInput.value = '';
    });

    // åˆæœŸè¡¨ç¤º
    renderFileList();

    // ãƒšãƒ¼ã‚¸ã‚’é›¢ã‚Œã‚‹ã¨ãã«ä½œæˆã—ãŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆURLã‚’è§£æ”¾ã™ã‚‹ (å¿µã®ãŸã‚)
    window.addEventListener('beforeunload', () => {
      // ç‰¹ã«ã“ã“ã§ã®è¿½åŠ è§£æ”¾ã¯ä¸è¦ã ãŒã€ãƒªãƒ¼ã‚¯å¯¾ç­–ã¨ã—ã¦æ®‹ã—ã¦ãŠã
    });

  </script>
</body>
</html>
