<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ç¢ºå®šç”³å‘Šæ”¯æ´ãƒ»ç¨é‡‘ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼</title>
  <style>
    :root{
      --bg:#f6f8fb; --card:#fff; --accent:#0b69ff; --muted:#6b7280; --grid:#cbd5e1;
      --success:#10b981; --danger:#ef4444; --orange:#f59e0b; --purple:#8b5cf6; --tax:#059669;
    }
    html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,"Hiragino Kaku Gothic ProN","Noto Sans JP",sans-serif;background:var(--bg);color:#111}
    .wrap{max-width:1300px;margin:20px auto;padding:18px}
    h1{font-size:18px;margin:0 0 12px; display:flex; align-items:center; gap:10px;}
    .badge{background:#e0f2fe; color:var(--accent); font-size:11px; padding:2px 6px; border-radius:4px; border:1px solid #bae6fd;}
    .card{background:var(--card);border-radius:10px;padding:14px;box-shadow:0 1px 6px rgba(16,24,40,0.06); position:relative;}
    .toolbar{display:flex;gap:8px;align-items:center;margin-bottom:12px;flex-wrap:wrap;padding-bottom:12px;border-bottom:1px solid #eee}
    
    /* æ‰¶é¤Šãƒ»ç¨é‡‘ãƒ‘ãƒãƒ«ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    .fuyo-panel {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
      padding: 15px;
      background: #f8fafc;
      border-radius: 8px;
      border: 1px solid #e2e8f0;
    }
    .fuyo-item { display: flex; flex-direction: column; gap: 4px; }
    .fuyo-label { font-size: 11px; color: var(--muted); font-weight: bold; }
    .fuyo-val { font-size: 16px; font-weight: 700; font-feature-settings: "tnum"; }
    .fuyo-input { 
      padding: 6px; border: 1px solid var(--grid); border-radius: 4px; font-size: 14px; 
      width: 100%; box-sizing: border-box; font-weight: bold;
    }
    .status-badge {
      display: inline-block; padding: 2px 8px; border-radius: 12px; font-size: 11px; font-weight: bold;
      margin-top: 4px; text-align: center;
    }
    .status-ok { background: #dcfce7; color: #166534; }
    .status-ng { background: #fee2e2; color: #991b1b; }
    .tax-result { color: var(--tax); font-size: 18px; }

    button{background:var(--accent);color:#fff;border:0;padding:8px 12px;border-radius:6px;cursor:pointer;font-weight:600;font-size:13px; transition:all 0.1s; display:flex; align-items:center; gap:4px;}
    button:hover{opacity:0.9}
    button:active{transform:translateY(1px);}
    button.ghost{background:#fff;color:var(--accent);border:1px solid #dbeafe}
    button.danger{background:#fff;color:var(--danger);border:1px solid #fca5a5}
    button.action{background:var(--success);}
    button.warning{background:#fff; color:var(--orange); border:1px solid #fcd34d;}
    
    .bulk-area{display:flex;gap:6px;align-items:center;background:#f8fafc;padding:4px 8px;border-radius:6px;border:1px dashed var(--grid);}
    .bulk-area select{padding:4px; border:1px solid var(--grid); border-radius:4px;}
    
    .table-wrap{overflow:auto;border:1px solid var(--grid);border-radius:6px;background:#fff; max-height:50vh;}
    table.sheet{border-collapse:collapse;width:100%;min-width:950px}
    table.sheet th, table.sheet td{border:1px solid var(--grid);padding:0;vertical-align:middle; height:36px;}
    table.sheet th{background:#eef2ff;font-weight:700;text-align:left;font-size:12px; padding:0 8px; position:sticky; top:0; z-index:10;}
    
    input.cell{width:100%;height:100%;border:0;padding:0 8px;font-size:13px;box-sizing:border-box;background:transparent; font-family:inherit;}
    input.cell:focus{outline:2px solid var(--accent);outline-offset:-2px; background:rgba(11,105,255,0.05);}
    
    .right{margin-left:auto;display:flex;gap:10px;align-items:center}
    .sum-box{background:var(--purple);color:#fff;padding:6px 12px;border-radius:6px;font-weight:700; font-feature-settings: "tnum";}
    
    #saveStatus{position:absolute; top:14px; right:14px; font-size:12px; color:var(--success); opacity:0; transition:opacity 0.3s; pointer-events:none; font-weight:bold;}
    .cb-cell{text-align:center; background:#fafafa;}
    input[type="checkbox"]{cursor:pointer; width:16px; height:16px; margin:0;}
    #fileInput { display: none; }
    
    .info-tip { font-size: 10px; color: var(--muted); margin-top: 2px; line-height: 1.2;}
    
    @media(max-width:900px){ .toolbar{align-items:flex-start;} .right{margin-left:0; width:100%; justify-content:flex-end;} .fuyo-panel{grid-template-columns: 1fr 1fr;} }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>ç¢ºå®šç”³å‘Šæ”¯æ´ã‚¢ãƒ—ãƒª <span class="badge">æ‰¶é¤Šãƒ»ç¨é‡‘æ¦‚ç®—å¯¾å¿œç‰ˆ</span></h1>
    
    <div class="card">
      <div id="saveStatus">âœ“ ä¿å­˜å®Œäº†</div>

      <div class="fuyo-panel">
        <div class="fuyo-item">
          <label class="fuyo-label">å¹´é–“å£²ä¸Šï¼ˆå ±é…¬é¡ï¼‰</label>
          <input type="number" id="revenueInput" class="fuyo-input" placeholder="0" value="0">
          <div class="info-tip">â€»æºæ³‰å¾´åå‰ã®ç·é¡</div>
        </div>
        <div class="fuyo-item">
          <label class="fuyo-label">æ‰¶é¤Šå®¶æ—ã®äººæ•°ï¼ˆ16æ­³ä»¥ä¸Šï¼‰</label>
          <input type="number" id="depCountInput" class="fuyo-input" placeholder="0" value="0" min="0">
          <div class="info-tip">â€»1äººã«ã¤ã38ä¸‡å††æ§é™¤ã¨ã—ã¦è¨ˆç®—</div>
        </div>
        <div class="fuyo-item">
          <label class="fuyo-label">ç¤¾ä¼šä¿é™ºæ–™ç­‰ã®åˆè¨ˆï¼ˆæ§é™¤ï¼‰</label>
          <input type="number" id="otherDeductionInput" class="fuyo-input" placeholder="0" value="0">
          <div class="info-tip">â€»å¹´é‡‘ãƒ»å¥åº·ä¿é™ºãƒ»ç”Ÿå‘½ä¿é™ºãªã©</div>
        </div>
        <div class="fuyo-item">
          <label class="fuyo-label">é’è‰²ç”³å‘Šæ§é™¤</label>
          <select id="blueReturnSelect" class="fuyo-input">
            <option value="0">ãªã— (ç™½è‰²)</option>
            <option value="100000">10ä¸‡å††æ§é™¤</option>
            <option value="550000">55ä¸‡å††æ§é™¤</option>
            <option value="650000">65ä¸‡å††æ§é™¤ (e-Taxç­‰)</option>
          </select>
        </div>
        
        <div class="fuyo-item" style="border-left: 2px solid #ddd; padding-left: 15px;">
          <label class="fuyo-label">å·®å¼•æ‰€å¾—ï¼ˆå£²ä¸Šï¼çµŒè²»ï¼‰</label>
          <div class="fuyo-val" id="netIncome">Â¥0</div>
          <div id="taxStatus" class="status-badge" style="width: 100px;">åˆ¤å®šä¸­...</div>
        </div>

        <div class="fuyo-item">
          <label class="fuyo-label" style="color:var(--tax)">æ¦‚ç®—æ‰€å¾—ç¨é¡</label>
          <div class="fuyo-val tax-result" id="approxIncomeTax">Â¥0</div>
          <div class="info-tip">â€»æ‰€å¾—æ§é™¤è€ƒæ…®å¾Œã®æ‰€å¾—ç¨</div>
        </div>
        <div class="fuyo-item">
          <label class="fuyo-label" style="color:var(--tax)">æ¦‚ç®—ä½æ°‘ç¨é¡</label>
          <div class="fuyo-val tax-result" id="approxInhabitantTax">Â¥0</div>
          <div class="info-tip">â€»ç´„10%ã§ç°¡æ˜“è¨ˆç®—</div>
        </div>
      </div>

      <div class="toolbar">
        <button id="addRow">ï¼‹ è¡Œè¿½åŠ </button>
        <button id="dupRow" class="ghost" title="é¸æŠã—ãŸè¡Œã‚’æœ«å°¾ã«é€£ç¶šã‚³ãƒ”ãƒ¼">ğŸ“‹ é€£ç¶šè¤‡è£½</button>
        <button id="delRow" class="danger">ğŸ—‘ å‰Šé™¤</button>
        <div class="bulk-area">
          <select id="bulkCatSelect"><option value="">ä¸€æ‹¬ã‚«ãƒ†ã‚´ãƒª...</option></select>
          <button id="applyBulkCat" class="ghost" style="padding:4px 8px;">é©ç”¨</button>
        </div>
        <button id="sortDate" class="ghost">ğŸ“… ä¸¦ã¹æ›¿ãˆ</button>
        <div class="right">
          <button id="saveJson" class="warning">JSONä¿å­˜</button>
          <button id="loadJson" class="warning">JSONèª­è¾¼</button>
          <input type="file" id="fileInput" accept=".json">
          <div class="sum-box" id="totalBox" title="çµŒè²»åˆè¨ˆ">çµŒè²»: Â¥0</div>
          <button id="exportXls" class="action">Excelä¿å­˜</button>
          <button id="clearAll" class="ghost" style="font-size:11px; color:var(--muted);">å…¨æ¶ˆå»</button>
        </div>
      </div>

      <div class="table-wrap">
        <table class="sheet" id="sheet">
          <thead>
            <tr>
              <th style="width:40px; text-align:center"><input type="checkbox" id="selectAll"></th>
              <th style="width:110px">æ—¥ä»˜(åŠè§’)</th>
              <th style="width:110px">é‡‘é¡</th>
              <th>åº—å(å…¨è§’)</th>
              <th style="width:150px">ã‚«ãƒ†ã‚´ãƒª</th>
              <th>æ‘˜è¦</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <datalist id="catList"></datalist>

<script>
const STORAGE_KEY = 'receipt_app_v8_tax';
const SETTINGS_KEY = 'receipt_app_tax_settings';
const defaultCats = ['äº¤é€šè²»','äº¤éš›è²»','æ¶ˆè€—å“è²»','æ—…è²»äº¤é€šè²»','é€šä¿¡è²»','æ–°èå›³æ›¸è²»','ä¼šè­°è²»','åœ°ä»£å®¶è³ƒ','æ°´é“å…‰ç†±è²»','ãã®ä»–'];

let records = load();
let sortAsc = true;

const tbody = document.getElementById('tbody');
const totalBox = document.getElementById('totalBox');
const netIncomeEl = document.getElementById('netIncome');
const revenueInput = document.getElementById('revenueInput');
const depCountInput = document.getElementById('depCountInput');
const otherDeductionInput = document.getElementById('otherDeductionInput');
const blueReturnSelect = document.getElementById('blueReturnSelect');

const taxStatusEl = document.getElementById('taxStatus');
const approxIncomeTaxEl = document.getElementById('approxIncomeTax');
const approxInhabitantTaxEl = document.getElementById('approxInhabitantTax');

const saveStatus = document.getElementById('saveStatus');
const bulkSelect = document.getElementById('bulkCatSelect');
const fileInput = document.getElementById('fileInput');
const datalist = document.getElementById('catList');

function init(){
  datalist.innerHTML = '';
  bulkSelect.innerHTML = '<option value="">ä¸€æ‹¬ã‚«ãƒ†ã‚´ãƒª...</option>';
  defaultCats.forEach(c => {
    const opt = document.createElement('option');
    opt.value = c;
    datalist.appendChild(opt.cloneNode(true));
    bulkSelect.appendChild(new Option(c, c));
  });

  // ä¿å­˜è¨­å®šã®å¾©å…ƒ
  const savedSettings = JSON.parse(localStorage.getItem(SETTINGS_KEY) || '{}');
  revenueInput.value = savedSettings.revenue || 0;
  depCountInput.value = savedSettings.depCount || 0;
  otherDeductionInput.value = savedSettings.otherDeduction || 0;
  blueReturnSelect.value = savedSettings.blueReturn || 0;

  render();
}

function load(){
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    return raw ? JSON.parse(raw) : [];
  } catch(e) { return []; }
}

function save(){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(records));
  const settings = {
    revenue: revenueInput.value,
    depCount: depCountInput.value,
    otherDeduction: otherDeductionInput.value,
    blueReturn: blueReturnSelect.value
  };
  localStorage.setItem(SETTINGS_KEY, JSON.stringify(settings));
  showSaveIndicator();
  updateTotal();
}

function showSaveIndicator(){
  saveStatus.style.opacity = '1';
  clearTimeout(window.saveTimer);
  window.saveTimer = setTimeout(() => saveStatus.style.opacity = '0', 800);
}

function render(){
  const checkedIdx = new Set();
  tbody.querySelectorAll('.rowSelect').forEach((cb, idx) => {
    if(cb.checked) checkedIdx.add(idx);
  });
  tbody.innerHTML = '';
  records.forEach((r, idx) => {
    const tr = document.createElement('tr');
    tr.dataset.index = idx;
    tr.innerHTML = `
      <td class="cb-cell"><input type="checkbox" class="rowSelect" ${checkedIdx.has(idx)?'checked':''}></td>
      <td><input class="cell" data-field="date" value="${escapeHtml(r.date||'')}" placeholder="MM-DD" inputmode="url"></td>
      <td><input class="cell" data-field="amount" value="${r.amount ?? ''}" inputmode="numeric" style="text-align:right"></td>
      <td><input class="cell" data-field="store" value="${escapeHtml(r.store||'')}" inputmode="kana"></td>
      <td><input class="cell" data-field="category" list="catList" value="${escapeHtml(r.category||'')}"></td>
      <td><input class="cell" data-field="memo" value="${escapeHtml(r.memo||'')}"></td>
    `;
    tbody.appendChild(tr);
  });
  attachEvents();
  updateTotal();
}

function attachEvents(){
  tbody.querySelectorAll('.cell').forEach(el => {
    el.addEventListener('input', onCellInput);
    el.addEventListener('keydown', onCellKeyDown);
    if(el.dataset.field === 'date') el.addEventListener('change', onDateAutoFill);
  });
}

function onCellInput(e){
  const idx = e.target.closest('tr').dataset.index;
  const field = e.target.dataset.field;
  let val = e.target.value;
  if(field === 'amount'){
    val = val.replace(/[^\d\.\-]/g,'');
    e.target.value = val;
    records[idx][field] = val === '' ? '' : Number(val);
  } else {
    records[idx][field] = val;
  }
  save();
}

function onCellKeyDown(e){
  if(e.key === 'Enter'){
    e.preventDefault();
    const all = Array.from(tbody.querySelectorAll('.cell'));
    const i = all.indexOf(e.target);
    const next = e.shiftKey ? all[i-1] : all[i+1];
    if(next) next.focus();
  }
}

function onDateAutoFill(e){
  let val = e.target.value.trim();
  if(!val) return;
  if(!/^\d{4}-\d{2}-\d{2}$/.test(val)){
    const now = new Date();
    val = val.replace(/\//g, '-').replace(/[ï¼-ï¼™]/g, s => String.fromCharCode(s.charCodeAt(0) - 0xFEE0));
    const parts = val.split('-');
    if(parts.length === 2) val = `${now.getFullYear()}-${parts[0].padStart(2,'0')}-${parts[1].padStart(2,'0')}`;
  }
  e.target.value = val;
  records[e.target.closest('tr').dataset.index].date = val;
  save();
}

// --- ç¨é‡‘è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ ---
[revenueInput, depCountInput, otherDeductionInput, blueReturnSelect].forEach(el => {
  el.addEventListener('input', save);
});

function updateTotal(){
  const totalExp = records.reduce((s,x)=> s + (Number(x.amount)||0), 0);
  const revenue = Number(revenueInput.value) || 0;
  const netIncome = revenue - totalExp;

  // è¡¨ç¤ºæ›´æ–°
  totalBox.textContent = 'çµŒè²»: Â¥' + formatNum(totalExp);
  netIncomeEl.textContent = 'Â¥' + formatNum(netIncome);

  // æ‰¶é¤Šåˆ¤å®š (æ‰€å¾—48ä¸‡å††ä»¥ä¸‹)
  if(netIncome <= 480000){
    taxStatusEl.textContent = 'ç¨å‹™æ‰¶é¤Šå†…';
    taxStatusEl.className = 'status-badge status-ok';
  } else {
    taxStatusEl.textContent = 'æ‰¶é¤Šå¤–';
    taxStatusEl.className = 'status-badge status-ng';
  }

  // --- ãŠãŠã‚ˆãã®ç¨é‡‘è¨ˆç®— ---
  const basicDeduction = 480000; // åŸºç¤æ§é™¤
  const blueDeduction = Number(blueReturnSelect.value) || 0; // é’è‰²æ§é™¤
  const depDeduction = (Number(depCountInput.value) || 0) * 380000; // æ‰¶é¤Šæ§é™¤
  const otherDeduction = Number(otherDeductionInput.value) || 0; // ç¤¾ä¼šä¿é™ºç­‰

  // èª²ç¨æ‰€å¾—é‡‘é¡
  let taxableIncome = netIncome - basicDeduction - blueDeduction - depDeduction - otherDeduction;
  if(taxableIncome < 0) taxableIncome = 0;

  // æ‰€å¾—ç¨ (ç°¡æ˜“è¨ˆç®—è¡¨)
  let incomeTax = 0;
  if(taxableIncome <= 1950000) incomeTax = taxableIncome * 0.05;
  else if(taxableIncome <= 3300000) incomeTax = taxableIncome * 0.1 - 97500;
  else if(taxableIncome <= 6950000) incomeTax = taxableIncome * 0.2 - 427500;
  else if(taxableIncome <= 8999000) incomeTax = taxableIncome * 0.23 - 636000;
  else incomeTax = taxableIncome * 0.33 - 1536000; // è¶…éåˆ†ã¯çœç•¥
  
  // å¾©èˆˆç‰¹åˆ¥æ‰€å¾—ç¨ (2.1%) åŠ ç®—
  incomeTax = incomeTax * 1.021;

  // ä½æ°‘ç¨ (ä¸€å¾‹10% + å‡ç­‰å‰²5000å††ã¨ä»®å®š)
  const inhabitantTax = taxableIncome > 0 ? (taxableIncome * 0.1 + 5000) : 0;

  approxIncomeTaxEl.textContent = 'Â¥' + formatNum(Math.floor(incomeTax));
  approxInhabitantTaxEl.textContent = 'Â¥' + formatNum(Math.floor(inhabitantTax));
}

function formatNum(n){
  return String(n).replace(/\B(?=(\d{3})+(?!\d))/g, ",");
}

// --- ãƒœã‚¿ãƒ³æ“ä½œ ---
document.getElementById('addRow').addEventListener('click', ()=>{
  records.push({date:'', amount:'', store:'', category:'', memo:''});
  save(); render();
});

document.getElementById('dupRow').addEventListener('click', ()=>{
  const checks = tbody.querySelectorAll('.rowSelect');
  const newRows = [];
  checks.forEach((cb, i) => { if(cb.checked) newRows.push(JSON.parse(JSON.stringify(records[i]))); });
  if(!newRows.length) return alert('è¤‡è£½ã—ãŸã„è¡Œã‚’é¸æŠã—ã¦ãã ã•ã„');
  records = records.concat(newRows);
  save(); render();
});

document.getElementById('delRow').addEventListener('click', ()=>{
  const checks = Array.from(tbody.querySelectorAll('.rowSelect'));
  const targetIdx = checks.map((cb,i) => cb.checked ? i : -1).filter(i => i !== -1);
  if(!targetIdx.length) return alert('å‰Šé™¤ã™ã‚‹è¡Œã‚’é¸æŠã—ã¦ãã ã•ã„');
  if(!confirm(`${targetIdx.length} ä»¶ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return;
  targetIdx.reverse().forEach(i => records.splice(i,1));
  save(); render();
});

document.getElementById('applyBulkCat').addEventListener('click', ()=>{
  const cat = bulkSelect.value;
  if(!cat) return alert('ã‚«ãƒ†ã‚´ãƒªã‚’é¸æŠã—ã¦ãã ã•ã„');
  tbody.querySelectorAll('.rowSelect').forEach((cb, i) => { if(cb.checked) records[i].category = cat; });
  save(); render();
});

document.getElementById('selectAll').addEventListener('change', (e)=>{
  tbody.querySelectorAll('.rowSelect').forEach(cb => cb.checked = e.target.checked);
});

document.getElementById('sortDate').addEventListener('click', ()=>{
  sortAsc = !sortAsc;
  records.sort((a,b) => {
    const da = a.date ? new Date(a.date) : new Date('9999-12-31');
    const db = b.date ? new Date(b.date) : new Date('9999-12-31');
    return sortAsc ? da - db : db - da;
  });
  save(); render();
});

document.getElementById('saveJson').addEventListener('click', ()=>{
  const exportData = {
    settings: {
      revenue: revenueInput.value,
      depCount: depCountInput.value,
      otherDeduction: otherDeductionInput.value,
      blueReturn: blueReturnSelect.value
    },
    expenses: records
  };
  const blob = new Blob([JSON.stringify(exportData, null, 2)], {type: 'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `tax_data_${new Date().toISOString().slice(0,10)}.json`;
  a.click();
});

document.getElementById('loadJson').addEventListener('click', () => fileInput.click());

fileInput.addEventListener('change', (e) => {
  const file = e.target.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = (event) => {
    try {
      const imported = JSON.parse(event.target.result);
      const newRecs = imported.expenses || (Array.isArray(imported) ? imported : []);
      if(imported.settings){
        revenueInput.value = imported.settings.revenue || 0;
        depCountInput.value = imported.settings.depCount || 0;
        otherDeductionInput.value = imported.settings.otherDeduction || 0;
        blueReturnSelect.value = imported.settings.blueReturn || 0;
      }
      if(confirm('æ—¢å­˜ã®ãƒ‡ãƒ¼ã‚¿ã«è¿½åŠ ã—ã¾ã™ã‹ï¼Ÿ')){ records = records.concat(newRecs); } 
      else { records = newRecs; }
      save(); render();
    } catch(err) { alert('ã‚¨ãƒ©ãƒ¼: JSONå½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“'); }
    fileInput.value = '';
  };
  reader.readAsText(file);
});

document.getElementById('exportXls').addEventListener('click', ()=>{
  const total = records.reduce((s,x)=> s + (Number(x.amount)||0), 0);
  let html = '<html><head><meta charset="utf-8"></head><body><table border="1">';
  html += `<tr><th colspan="5">ç¨é‡‘è¨ˆç®—ã‚µãƒãƒªãƒ¼</th></tr>`;
  html += `<tr><td>å£²ä¸Š</td><td>${revenueInput.value}</td><td>æ‰€å¾—</td><td>${revenueInput.value - total}</td><td></td></tr>`;
  html += `<tr><td>æ‰€å¾—ç¨(æ¦‚ç®—)</td><td>${approxIncomeTaxEl.textContent}</td><td>ä½æ°‘ç¨(æ¦‚ç®—)</td><td>${approxInhabitantTaxEl.textContent}</td><td></td></tr>`;
  html += '<tr><th>æ—¥ä»˜</th><th>é‡‘é¡</th><th>åº—å</th><th>ã‚«ãƒ†ã‚´ãƒª</th><th>æ‘˜è¦</th></tr>';
  records.forEach(r => {
    html += `<tr><td>${r.date||''}</td><td>${r.amount||0}</td><td>${escapeHtml(r.store)}</td><td>${escapeHtml(r.category)}</td><td>${escapeHtml(r.memo)}</td></tr>`;
  });
  html += '</table></body></html>';
  const a = document.createElement('a');
  a.href = URL.createObjectURL(new Blob([html], {type: 'application/vnd.ms-excel'}));
  a.download = `receipt_export_${new Date().toISOString().slice(0,10)}.xls`;
  a.click();
});

document.getElementById('clearAll').addEventListener('click', ()=>{
  if(confirm('å…¨ã¦æ¶ˆå»ã—ã¾ã™ã‹ï¼Ÿ')) { records=[]; revenueInput.value=0; save(); render(); }
});

function escapeHtml(s){
  return s ? String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[m])) : '';
}

init();
</script>
</body>
</html>
