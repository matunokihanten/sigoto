<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ç©¶æ¥µã®vCardæ•´ç†ãƒ„ãƒ¼ãƒ« - é‡è¤‡å‰Šé™¤å¯¾å¿œ</title>
<style>
  body{font-family:system-ui,-apple-system,sans-serif;margin:16px;background:#f0f4f8;color:#1e293b;line-height:1.5}
  h1{font-size:1.4rem;color:#0f172a;margin-bottom:16px;text-align:center}
  .card{background:#fff;border-radius:12px;padding:20px;box-shadow:0 4px 6px -1px rgba(0,0,0,0.1);margin-bottom:16px}
  .controls{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:16px;align-items:center}
  
  /* ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
  button{padding:10px 16px;border-radius:8px;border:none;font-weight:600;cursor:pointer;transition:0.2s;font-size:0.9rem}
  .btn-primary{background:#2563eb;color:#fff}
  .btn-primary:hover{background:#1d4ed8}
  .btn-secondary{background:#e2e8f0;color:#475569}
  .btn-secondary:hover{background:#cbd5e1}
  .btn-danger{background:#ef4444;color:#fff}
  .btn-danger:hover{background:#dc2626}
  .btn-success{background:#10b981;color:#fff}

  /* æ¤œç´¢ãƒœãƒƒã‚¯ã‚¹ */
  .search-box{width:100%;padding:10px;border:1px solid #cbd5e1;border-radius:8px;margin-bottom:16px;font-size:1rem}

  /* ãƒ†ãƒ¼ãƒ–ãƒ« */
  .table-wrapper{overflow:auto;max-height:500px;border:1px solid #e2e8f0;border-radius:8px}
  table{width:100%;border-collapse:collapse;background:#fff}
  th,td{padding:12px;border-bottom:1px solid #eee;text-align:left}
  th{background:#f8fafc;position:sticky;top:0;z-index:1}
  tr:hover{background:#f1f5f9}
  
  /* ãƒãƒƒã‚¸ */
  .badge{padding:2px 8px;border-radius:999px;font-size:0.75rem;font-weight:bold;margin-left:4px}
  .badge-duplicate{background:#fee2e2;color:#991b1b;border:1px solid #fecaca}

  .muted{color:#64748b;font-size:0.85rem}
  input[type=file]{display:block;margin:10px 0;width:100%}
  .hidden{display:none}
</style>
</head>
<body>

  <h1>vCard é›»è©±ç•ªå·æ•´ç†ãƒ„ãƒ¼ãƒ«</h1>

  <div class="card">
    <label><strong>1. vCardãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆ.vcfï¼‰ã‚’èª­ã¿è¾¼ã‚€</strong></label>
    <input id="vcfFile" type="file" accept=".vcf,text/vcard" />
    <div id="fileInfo" class="muted"></div>
  </div>

  <div id="mainArea" class="hidden">
    <div class="card">
      <div class="controls">
        <button id="selectDuplicates" class="btn-secondary">ğŸ”„ é‡è¤‡ç•ªå·ã‚’è‡ªå‹•é¸æŠ</button>
        <button id="selectAll" class="btn-secondary">å…¨ã¦é¸æŠ</button>
        <button id="deselectAll" class="btn-secondary">è§£é™¤</button>
        <div style="flex-grow:1"></div>
        <button id="deleteSelected" class="btn-danger">ğŸ—‘ï¸ é¸æŠã—ãŸç•ªå·ã‚’å‰Šé™¤</button>
      </div>

      <input type="text" id="searchBox" class="search-box" placeholder="åå‰ã‚„é›»è©±ç•ªå·ã§æ¤œç´¢...">

      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th style="width:50px">é¸æŠ</th>
              <th>åå‰</th>
              <th>é›»è©±ç•ªå·</th>
              <th>ã‚¿ã‚¤ãƒ—</th>
            </tr>
          </thead>
          <tbody id="contactsBody"></tbody>
        </table>
      </div>

      <div style="margin-top:16px">
        <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
          <input type="checkbox" id="removeEmptyContacts" checked />
          <span>é›»è©±ç•ªå·ãŒ0ä»¶ã«ãªã£ãŸé€£çµ¡å…ˆã‚’å®Œå…¨ã«å‰Šé™¤ã™ã‚‹</span>
        </label>
      </div>
    </div>

    <div class="card" style="text-align:center">
      <div id="statusMsg" style="margin-bottom:12px;font-weight:bold"></div>
      <button id="downloadBtn" class="btn-success" style="padding:12px 24px;font-size:1.1rem;display:none">
        ğŸ’¾ ä¿®æ­£æ¸ˆã¿ vCard ã‚’ä¿å­˜ã™ã‚‹
      </button>
    </div>
  </div>

<script>
let contacts = []; 
let originalFileName = "contacts_edited.vcf";

// 1. ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿
document.getElementById('vcfFile').addEventListener('change', async (e) => {
  const file = e.target.files[0];
  if (!file) return;
  originalFileName = "edited_" + file.name;
  const text = await file.text();
  parseVCard(text);
  renderTable();
  document.getElementById('mainArea').classList.remove('hidden');
});

// 2. vCardè§£æ
function parseVCard(text) {
  contacts = [];
  // æŠ˜ã‚Šè¿”ã—è¡Œã®çµåˆ
  const unfolded = text.replace(/\r\n/g, '\n').replace(/\r/g, '\n').replace(/\n[ \t]/g, '');
  const blocks = unfolded.split(/(?=BEGIN:VCARD)/i).filter(b => b.includes('BEGIN:VCARD'));

  blocks.forEach((block, bIdx) => {
    const lines = block.split('\n').filter(l => l.trim() !== '');
    let fn = "(åå‰ãªã—)";
    let tels = [];

    lines.forEach((line, lIdx) => {
      const upper = line.toUpperCase();
      if (upper.startsWith('FN')) {
        fn = line.split(':')[1] || fn;
      }
      if (upper.startsWith('TEL')) {
        const parts = line.split(':');
        const meta = parts[0];
        const num = parts.slice(1).join(':').trim();
        let type = "OTHER";
        const typeMatch = meta.match(/TYPE=([^;:]+)/i);
        if (typeMatch) type = typeMatch[1];
        
        tels.push({
          id: `${bIdx}-${lIdx}`,
          raw: line,
          number: num,
          cleanNumber: num.replace(/\D/g, ''), // æ¯”è¼ƒç”¨ã«æ•°å­—ã®ã¿æŠ½å‡º
          type: type
        });
      }
    });
    contacts.push({ bIdx, fn, tels, rawLines: lines });
  });
}

// 3. ãƒ†ãƒ¼ãƒ–ãƒ«è¡¨ç¤º
function renderTable() {
  const body = document.getElementById('contactsBody');
  const searchTxt = document.getElementById('searchBox').value.toLowerCase();
  body.innerHTML = '';

  // é‡è¤‡ãƒã‚§ãƒƒã‚¯ç”¨ã®ã‚«ã‚¦ãƒ³ãƒˆä½œæˆ
  const numCounts = {};
  contacts.forEach(c => c.tels.forEach(t => {
    numCounts[t.cleanNumber] = (numCounts[t.cleanNumber] || 0) + 1;
  }));

  contacts.forEach((c, cIdx) => {
    c.tels.forEach((t, tIdx) => {
      if (searchTxt && !c.fn.toLowerCase().includes(searchTxt) && !t.number.includes(searchTxt)) return;

      const isDup = numCounts[t.cleanNumber] > 1;
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><input type="checkbox" class="tel-chk" data-cidx="${cIdx}" data-tidx="${tIdx}" data-dup="${isDup}"></td>
        <td>${escapeHtml(c.fn)}</td>
        <td>
          ${escapeHtml(t.number)}
          ${isDup ? '<span class="badge badge-duplicate">é‡è¤‡</span>' : ''}
        </td>
        <td class="muted">${escapeHtml(t.type)}</td>
      `;
      body.appendChild(tr);
    });
  });

  updateStatus();
}

// 4. é‡è¤‡ã®è‡ªå‹•é¸æŠ (è³¢ã„é¸æŠ: 1ã¤ã¯æ®‹ã—ã¦ä»–ã‚’ãƒã‚§ãƒƒã‚¯)
document.getElementById('selectDuplicates').addEventListener('click', () => {
  const seen = new Set();
  const checkboxes = document.querySelectorAll('.tel-chk');
  checkboxes.forEach(cb => {
    const cIdx = cb.dataset.cidx;
    const tIdx = cb.dataset.tidx;
    const cleanNum = contacts[cIdx].tels[tIdx].cleanNumber;
    
    if (seen.has(cleanNum)) {
      cb.checked = true; // ã™ã§ã«ç™»å ´ã—ãŸç•ªå·ãªã‚‰ãƒã‚§ãƒƒã‚¯
    } else {
      seen.add(cleanNum); // åˆã‚ã¦ã®ç•ªå·ãªã‚‰ã‚­ãƒ¼ãƒ—
      cb.checked = false;
    }
  });
});

// 5. å‰Šé™¤å®Ÿè¡Œ
document.getElementById('deleteSelected').addEventListener('click', () => {
  const checked = document.querySelectorAll('.tel-chk:checked');
  if (checked.length === 0) return alert('å‰Šé™¤ã—ãŸã„ç•ªå·ã«ãƒã‚§ãƒƒã‚¯ã‚’å…¥ã‚Œã¦ãã ã•ã„ã€‚');

  if (!confirm(`${checked.length}ä»¶ã®ç•ªå·ã‚’å‰Šé™¤ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ`)) return;

  // å‰Šé™¤ãƒ•ãƒ©ã‚°ã‚’ç«‹ã¦ã‚‹
  checked.forEach(cb => {
    const cIdx = cb.dataset.cidx;
    const tIdx = cb.dataset.tidx;
    contacts[cIdx].tels[tIdx]._delete = true;
  });

  // å®Ÿéš›ã«ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°
  contacts.forEach(c => {
    c.tels = c.tels.filter(t => !t._delete);
  });

  // ç©ºã®é€£çµ¡å…ˆå‰Šé™¤ã‚ªãƒ—ã‚·ãƒ§ãƒ³
  if (document.getElementById('removeEmptyContacts').checked) {
    contacts = contacts.filter(c => c.tels.length > 0);
  }

  renderTable();
  prepareDownload();
});

// 6. ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰æº–å‚™
function prepareDownload() {
  let output = "";
  contacts.forEach(c => {
    output += "BEGIN:VCARD\r\n";
    // TELä»¥å¤–ã®å…ƒã®è¡Œã‚’ç¶­æŒã—ã¤ã¤ã€æ›´æ–°ã•ã‚ŒãŸTELã‚’æ›¸ãå‡ºã™
    c.rawLines.forEach(line => {
      const upper = line.toUpperCase();
      if (!upper.startsWith('TEL') && !upper.startsWith('BEGIN') && !upper.startsWith('END')) {
        output += line.trim() + "\r\n";
      }
    });
    c.tels.forEach(t => {
      output += t.raw.trim() + "\r\n";
    });
    output += "END:VCARD\r\n";
  });

  const blob = new Blob([output], {type: 'text/vcard'});
  const url = URL.createObjectURL(blob);
  const dlBtn = document.getElementById('downloadBtn');
  dlBtn.onclick = () => {
    const a = document.createElement('a');
    a.href = url;
    a.download = originalFileName;
    a.click();
  };
  dlBtn.style.display = 'inline-block';
}

// è£œåŠ©æ©Ÿèƒ½
document.getElementById('selectAll').addEventListener('click', () => {
  document.querySelectorAll('.tel-chk').forEach(c => c.checked = true);
});
document.getElementById('deselectAll').addEventListener('click', () => {
  document.querySelectorAll('.tel-chk').forEach(c => c.checked = false);
});
document.getElementById('searchBox').addEventListener('input', renderTable);

function updateStatus() {
  const total = contacts.reduce((acc, c) => acc + c.tels.length, 0);
  document.getElementById('statusMsg').textContent = `ç¾åœ¨ã®é€£çµ¡å…ˆæ•°: ${contacts.length} ä»¶ / é›»è©±ç•ªå·åˆè¨ˆ: ${total} ä»¶`;
}

function escapeHtml(str) {
  return str.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
}
</script>
</body>
</html>
