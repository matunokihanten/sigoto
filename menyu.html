
<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>メニュー生成ツール（改良版：編集・追加・背景カラー）</title>
<style>
:root{
  --bg:#f3f4f6; --panel:#ffffff; --muted:#6b7280; --accent:#1f6feb;
  --maxw:1200px;
}
*{box-sizing:border-box}
body{font-family:"Yu Gothic","Hiragino Kaku Gothic ProN",sans-serif;background:var(--bg);color:#111;margin:18px;display:flex;justify-content:center}
.wrap{width:100%;max-width:var(--maxw);display:grid;grid-template-columns:1fr 380px;gap:18px}
.left,.right{background:var(--panel);border-radius:10px;padding:16px;box-shadow:0 6px 18px rgba(15,23,42,0.06)}
.left{min-height:640px}
h2{margin:0 0 10px 0;font-size:18px}
label{display:block;margin-top:8px;font-size:13px;color:var(--muted)}
input[type=file]{display:block;margin-top:8px}
textarea{width:100%;height:90px;margin-top:8px;padding:8px;border-radius:6px;border:1px solid #e5e7eb}
.btns{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
button{background:var(--accent);color:#fff;border:none;padding:8px 12px;border-radius:8px;cursor:pointer}
button.ghost{background:#fff;color:var(--accent);border:1px solid var(--accent)}
.small{font-size:13px;color:var(--muted)}
.controls{display:flex;flex-direction:column;gap:10px}
.table-area{margin-top:12px;background:#fff;border-radius:8px;padding:10px;border:1px solid #eee}
.category-panel{display:flex;flex-direction:column;gap:8px}
.cat-list{display:flex;flex-direction:column;gap:8px;margin-top:8px}
.cat-item{padding:8px;border-radius:8px;border:1px solid #eef2ff;background:linear-gradient(180deg,#ffffff,#fbfdff);display:flex;justify-content:space-between;align-items:center}
.preview-wrap{margin-top:12px;padding:12px;background:#fff;border-radius:8px;border:1px solid #eee}
#printArea{display:none}
.menu-preview{width:100%;max-width:900px;margin:0 auto;padding:36px;border-radius:8px; background-size:cover; background-position:center; box-shadow:0 8px 30px rgba(2,6,23,0.06)}
.menu-inner{background:rgba(255,255,255,0.86);padding:18px;border-radius:6px}
.menu-category{font-size:22px;font-weight:900;letter-spacing:2px;border-bottom:2px solid #222;padding-bottom:8px;margin-top:18px;margin-bottom:8px}
.menu-row{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px dashed rgba(0,0,0,0.06);align-items:center}
.menu-name{font-size:20px;font-weight:900} /* さらに大きく太く */
.menu-price{font-size:18px;font-weight:900}
.row-drag-handle{cursor:grab;padding:6px;border-radius:6px;background:#f8fafc;border:1px solid #eef2ff}
.draggable-row{background:#fff;border-radius:6px;padding:8px;margin-bottom:8px;display:flex;align-items:center;justify-content:space-between;gap:8px;border:1px solid #f1f5f9}
.row-left{display:flex;gap:12px;align-items:center;flex:1}
.row-title{font-weight:700}
.small-muted{font-size:12px;color:var(--muted)}
.color-swatch{width:30px;height:22px;border-radius:6px;border:1px solid #ddd;cursor:pointer}
.bg-presets{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
.input-inline{display:flex;gap:6px;align-items:center}
.modal{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);background:#fff;padding:18px;border-radius:10px;box-shadow:0 10px 40px rgba(2,6,23,0.3);z-index:999;min-width:320px}
.modal.hidden{display:none}
.modal h3{margin:0 0 8px 0}
.modal .row{margin-top:8px}
.ghost-sm{background:#fff;color:var(--accent);border:1px solid var(--accent);padding:6px 8px;border-radius:6px}
@media print{
  body *{visibility:hidden}
  #printArea, #printArea *{visibility:visible}
  #printArea{position:fixed;left:0;top:0;width:100%}
}
</style>
</head>
<body>
<div class="wrap">
  <div class="left">
    <h2>メニュー編集・追加・背景（改良版）</h2>

    <div style="display:flex;gap:8px;align-items:center">
      <span class="small">Excel/CSV 読込・書出し、編集で価格変更、価格空欄でカテゴリ化、メニュー追加</span>
    </div>

    <div style="margin-top:12px" class="controls">
      <div class="group">
        <label>Excel / CSV 読込 (.xlsx .xls .csv)</label>
        <input type="file" id="fileInput" accept=".xlsx,.xls,.csv" />
        <div class="note">または下のテキストに貼り付け（行毎 / タブ区切り可）。価格が無い行はカテゴリ見出しになります。</div>
        <textarea id="pasteArea" placeholder="例: 五目焼きそば[TAB]850 を行ごとに貼り付け"></textarea>
        <div style="margin-top:8px" class="btns">
          <button id="btnParse">読み込む</button>
          <button id="btnClear" class="ghost">全クリア</button>
          <button id="btnAutoGroup" class="ghost">自動カテゴリ推定</button>
        </div>
      </div>

      <div class="group">
        <label>背景設定（画像 / URL / 7色プリセット）</label>
        <input type="file" id="bgFile" accept="image/*" />
        <div style="display:flex;gap:8px;margin-top:8px">
          <input type="text" id="bgUrl" placeholder="画像URLを入力してダウンロード" />
          <button id="btnLoadBg" class="ghost">ダウンロード</button>
        </div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button id="btnClearBg" class="ghost">背景クリア</button>
          <button id="btnDownloadBg" class="ghost">背景をダウンロード</button>
        </div>
        <div class="bg-presets" id="bgPresets" title="背景プリセット">
          <!-- 7色プリセット -->
        </div>
        <div class="note">プリセットは薄い紙風の色です。背景画像とプリセットは排他で適用されます。</div>
      </div>

      <div class="group">
        <label>メニュー追加</label>
        <div style="display:flex;gap:8px;margin-top:6px">
          <input type="text" id="newMenuName" placeholder="品名を入力" />
          <input type="text" id="newMenuPrice" placeholder="価格（空白でカテゴリ見出し）" style="width:120px" />
        </div>
        <div style="display:flex;gap:8px;margin-top:6px;align-items:center">
          <select id="newMenuCat" style="flex:1"><option value="">（カテゴリを選択）</option></select>
          <button id="btnAddMenu" class="ghost">追加</button>
        </div>
        <div class="note">価格を空白にすると「新しいカテゴリ見出し」として追加されます</div>
      </div>

      <div class="group">
        <label>レイアウト</label>
        <div style="display:flex;gap:8px;margin-top:6px">
          <label style="min-width:110px">列数</label>
          <select id="colCount"><option value="1">1列</option><option value="2" selected>2列</option><option value="3">3列</option></select>
        </div>
        <div style="display:flex;gap:8px;margin-top:6px">
          <label style="min-width:110px">向き</label>
          <select id="orientation"><option value="portrait">縦向き</option><option value="landscape">横向き</option></select>
        </div>
      </div>

      <div class="group">
        <label>保存 / 読込</label>
        <div style="display:flex;gap:8px;margin-top:6px">
          <button id="btnDownloadJSON" class="ghost">JSON保存</button>
          <input type="file" id="jsonLoad" accept=".json" style="display:none" />
          <button id="btnLoadJSON" class="ghost">JSON読込</button>
        </div>
        <div style="display:flex;gap:8px;margin-top:6px">
          <button id="btnExportXLSX">Excel保存 (.xlsx)</button>
          <button id="btnExportCSV" class="ghost">CSV保存 (.csv)</button>
        </div>
      </div>

      <div class="group">
        <label>プレビュー / 印刷</label>
        <div style="display:flex;gap:8px;margin-top:6px">
          <button id="btnPreview" class="ghost">プレビュー表示</button>
          <button id="btnPrint" class="ghost">印刷</button>
        </div>
      </div>
    </div>

    <div class="table-area" style="margin-top:12px">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div class="small">読み込みプレビュー（クリックで選択、ドラッグで移動）</div>
        <div class="small">編集で価格を空にするとカテゴリになります</div>
      </div>
      <div id="rowsContainer" style="margin-top:8px;max-height:420px;overflow:auto"></div>
    </div>
  </div>

  <div class="right">
    <h2>カテゴリ管理</h2>
    <div style="display:flex;gap:8px;">
      <input type="text" id="newCatTitle" placeholder="新規カテゴリ名" />
      <button id="btnAddCat">追加</button>
    </div>
    <div class="cat-list" id="catList" style="margin-top:12px;max-height:260px;overflow:auto"></div>

    <div style="margin-top:12px;display:flex;gap:8px">
      <button id="btnSelectAll" class="ghost">全選択</button>
      <button id="btnUnselectAll" class="ghost">解除</button>
    </div>

    <div style="margin-top:12px;display:flex;gap:8px">
      <button id="btnGroupByKeyword" class="ghost">キーワードで一括割当</button>
      <button id="btnUngroup" class="ghost">選択解除</button>
    </div>

    <div class="preview-wrap" style="margin-top:12px">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div class="small">プレビュー</div>
        <div style="display:flex;gap:6px">
          <button id="btnPreviewSmall" class="ghost">簡易表示</button>
        </div>
      </div>
      <div id="printArea">
        <div id="menuPreview" class="menu-preview"></div>
      </div>
    </div>
  </div>
</div>

<!-- Modal: 編集 -->
<div id="editModal" class="modal hidden" role="dialog" aria-hidden="true">
  <h3>メニュー編集</h3>
  <div class="row"><label>品名</label><input type="text" id="editName" /></div>
  <div class="row"><label>価格（空にするとカテゴリ化）</label><input type="text" id="editPrice" /></div>
  <div class="row"><label>割当カテゴリ</label><select id="editCat"></select></div>
  <div style="display:flex;gap:8px;margin-top:10px;justify-content:flex-end">
    <button id="editCancel" class="ghost-sm">キャンセル</button>
    <button id="editSave">保存</button>
  </div>
</div>

<!-- SheetJS CDN -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<script>
/* データ構造 */
let state = { rows: [], categories: [] };
let currentBg = null; // dataURL or color string
function uid(prefix='id'){ return prefix+'-'+Math.random().toString(36).slice(2,9); }
function toHalfWidth(s){ if(!s) return s; return s.replace(/[！-～]/g,ch=>String.fromCharCode(ch.charCodeAt(0)-0xFEE0)).replace(/　/g,' '); }
function extractPriceAndName(line){
  if(!line) return { name:null, price:null, raw:'' };
  let raw = String(line).trim(); raw = raw.replace(/\r/g,'').replace(/\n/g,' ').trim(); raw = toHalfWidth(raw);
  const priceRegex = /([￥¥]?\s*[\d,\.]+(?:\s*円)?\s*)$/u;
  const m = raw.match(priceRegex);
  if(m){
    let pricePart = m[1]; let digits = pricePart.replace(/[￥¥\s円,]/g,''); let priceNum = Number(digits);
    let name = raw.slice(0, m.index).trim(); if(!name) name = null;
    if(!Number.isFinite(priceNum)) priceNum = null;
    return { name, price: priceNum, raw };
  }
  const parts = raw.split(/\t|,|;/).map(p=>p.trim()).filter(Boolean);
  if(parts.length>1){
    let last = parts[parts.length-1]; let digits = last.replace(/[￥¥\s円,]/g,''); let priceNum = Number(digits);
    if(Number.isFinite(priceNum)){ let name = parts.slice(0,parts.length-1).join(' '); return { name, price: priceNum, raw }; }
  }
  return { name: raw, price: null, raw };
}

/* ---------- 初期背景プリセット（7色） ---------- */
const BG_PRESETS = ['#fff9f0','#f7fff6','#f6fbff','#fff6fb','#fcfff9','#fafafc','#fffdf6'];
function renderBgPresets(){
  const cont = document.getElementById('bgPresets');
  BG_PRESETS.forEach(c=>{
    const d = document.createElement('div');
    d.className = 'color-swatch';
    d.style.background = c;
    d.title = c;
    d.addEventListener('click', ()=>{ applyBackground(c); });
    cont.appendChild(d);
  });
}
renderBgPresets();

/* ---------- 入出力 ---------- */
async function parseFile(file){
  const name = file.name || '';
  if(name.match(/\.csv$/i)){
    const text = await file.text();
    parseTextRowsWithCategories(text);
    renderRowList(); return;
  }
  const data = await file.arrayBuffer();
  const wb = XLSX.read(data, {type:'array'});
  const ws = wb.Sheets[wb.SheetNames[0]];
  const json = XLSX.utils.sheet_to_json(ws, {header:1, raw:false, defval:''});
  const lines = json.map(row=>row.join('\t')).join('\n');
  parseTextRowsWithCategories(lines);
  renderRowList();
}

function parseTextRowsWithCategories(text){
  const lines = text.split(/\r?\n/);
  let currentCatId = null;
  const newRows = [];
  // If state.categories already has items, continue; else start fresh categories array
  // We'll append newly-detected categories to state.categories
  lines.forEach(line=>{
    if(!line || /^\s*$/.test(line)) return;
    const {name,price,raw} = extractPriceAndName(line);
    if(price === null){
      // create category
      const cat = { id: uid('cat'), title: name || raw, rowIds: [] };
      state.categories.push(cat);
      currentCatId = cat.id;
    } else {
      const row = { id: uid('r'), raw, name, price, display:true, categoryId: currentCatId, selected:false };
      newRows.push(row);
    }
  });
  if(newRows.length>0 && state.categories.length===0){
    // ensure an uncategorized if no category found
    const def = { id: 'cat-unc', title: '未分類', rowIds: [] }; state.categories.push(def);
    newRows.forEach(r=> r.categoryId = def.id);
  } else if(state.categories.length===0){
    // nothing parsed: do nothing
  }
  state.rows = state.rows.concat(newRows);
  // reconstruct category rowIds from rows
  state.categories.forEach(c=> c.rowIds = []);
  state.rows.forEach(r=>{
    const cat = state.categories.find(c=>c.id===r.categoryId) || state.categories[0];
    if(cat){ r.categoryId = cat.id; cat.rowIds.push(r.id); }
  });
}

/* ---------- UI: 行一覧レンダリング（カテゴリ毎にドロップ可能・ドラッグで並べ替え） ---------- */
function renderRowList(){
  const container = document.getElementById('rowsContainer');
  container.innerHTML = '';
  // update "newMenuCat" select options
  refreshCategorySelects();
  state.categories.forEach(cat=>{
    const wrap = document.createElement('div');
    wrap.style.marginBottom='12px';
    wrap.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
      <strong>${escapeHtml(cat.title)}</strong>
      <div style="display:flex;gap:6px;align-items:center">
        <span class="small">(${cat.rowIds.length})</span>
        <button class="ghost btn-delete-cat" data-id="${cat.id}">削除</button>
      </div>
    </div>`;
    const list = document.createElement('div');
    list.className = 'cat-dropzone';
    list.dataset.cat = cat.id;
    list.style.padding='6px';
    list.style.minHeight='36px';
    list.style.border='1px dashed #eef2ff';
    list.style.borderRadius='8px';
    list.style.background='#fff';
    // drop to append
    list.addEventListener('dragover', e=>{ e.preventDefault(); list.style.background='#f0f8ff'; });
    list.addEventListener('dragleave', e=>{ list.style.background='#fff'; });
    list.addEventListener('drop', e=>{
      e.preventDefault(); list.style.background='#fff';
      const payload = e.dataTransfer.getData('text/plain');
      if(!payload) return;
      if(payload.startsWith('row:')){
        const rowId = payload.slice(4); assignRowToCategory(rowId, cat.id, null);
      } else if(payload.startsWith('reorder:')){
        const parts = payload.slice(8).split('|');
        const rowId = parts[0], afterId = parts[1] === 'null' ? null : parts[1];
        reorderRowInCategory(rowId, cat.id, afterId);
      }
    });
    // add items
    cat.rowIds.forEach((rid, idx)=>{
      const r = state.rows.find(x=>x.id===rid);
      if(!r) return;
      const item = document.createElement('div');
      item.className = 'draggable-row';
      item.draggable = true;
      item.dataset.id = r.id;
      item.innerHTML = `<div class="row-left">
        <div class="row-drag-handle" title="ドラッグで移動">☰</div>
        <div>
          <div class="row-title">${escapeHtml(r.name || r.raw)}</div>
          <div class="small-muted">${escapeHtml(r.raw)}</div>
        </div>
      </div>
      <div style="display:flex;align-items:center;gap:8px">
        <div style="text-align:right"><div class="menu-price">¥${r.price===null?'':r.price}</div></div>
        <div style="display:flex;gap:6px">
          <button class="ghost btn-edit-row" data-id="${r.id}">編集</button>
          <button class="ghost btn-delete-row" data-id="${r.id}">削除</button>
        </div>
      </div>`;
      // dragstart
      item.addEventListener('dragstart', e=>{
        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/plain', 'row:'+r.id);
      });
      // dragover/drop for reordering (drop before/after)
      item.addEventListener('dragover', e=>{ e.preventDefault(); item.style.border='2px dashed #cfe9ff'; });
      item.addEventListener('dragleave', e=>{ item.style.border=''; });
      item.addEventListener('drop', e=>{
        e.preventDefault(); item.style.border='';
        const payload = e.dataTransfer.getData('text/plain');
        if(!payload) return;
        if(payload.startsWith('row:')){
          const rowId = payload.slice(4);
          // place before this item
          assignRowToCategory(rowId, cat.id, r.id);
        } else if(payload.startsWith('reorder:')){
          const parts = payload.slice(8).split('|');
          const rowId = parts[0], afterId = parts[1] === 'null' ? null : parts[1];
          reorderRowInCategory(rowId, cat.id, r.id);
        }
      });
      // delete
      item.querySelector('.btn-delete-row').addEventListener('click', ()=>{
        if(!confirm('このメニューを削除しますか？')) return;
        deleteRowById(r.id);
      });
      // edit
      item.querySelector('.btn-edit-row').addEventListener('click', ()=>{
        openEditModal(r.id);
      });
      list.appendChild(item);
    });
    wrap.appendChild(list);
    container.appendChild(wrap);
    // delete cat
    wrap.querySelector('.btn-delete-cat').addEventListener('click', ()=>{
      if(!confirm('カテゴリを削除します。カテゴリ内のメニューは未分類になります。')) return;
      const catId = cat.id;
      let def = state.categories.find(c=>c.id==='cat-unc');
      if(!def){ def = { id:'cat-unc', title:'未分類', rowIds:[] }; state.categories.push(def); }
      const moving = cat.rowIds.slice();
      moving.forEach(rid=>{ const rr = state.rows.find(rrr=>rrr.id===rid); if(rr) rr.categoryId = def.id; def.rowIds.push(rid); });
      state.categories = state.categories.filter(c=>c.id!==catId);
      syncCategoriesFromRows();
      renderRowList();
    });
  });
  refreshCategorySelects();
}

/* ---------- カテゴリリストサイド更新 ---------- */
function refreshCategorySelects(){
  const sel = document.getElementById('newMenuCat');
  const editSel = document.getElementById('editCat');
  sel.innerHTML = '<option value="">（カテゴリを選択）</option>';
  if(editSel) editSel.innerHTML = '';
  state.categories.forEach(c=>{
    const o = document.createElement('option'); o.value = c.id; o.textContent = c.title; sel.appendChild(o);
    if(editSel){
      const oe = document.createElement('option'); oe.value = c.id; oe.textContent = c.title; editSel.appendChild(oe);
    }
  });
  // also ensure categories array is not empty
  if(state.categories.length===0){
    const def = { id:'cat-unc', title:'未分類', rowIds:[] }; state.categories.push(def);
    refreshCategorySelects();
  }
}

/* ---------- 行/カテゴリ操作ユーティリティ ---------- */
function assignRowToCategory(rowId, catId, beforeRowId=null){
  const row = state.rows.find(r=>r.id===rowId);
  if(!row) return;
  state.categories.forEach(c=> c.rowIds = c.rowIds.filter(id=>id!==rowId));
  row.categoryId = catId;
  const cat = state.categories.find(c=>c.id===catId);
  if(!cat) return;
  if(beforeRowId === null) cat.rowIds.push(rowId);
  else {
    const idx = cat.rowIds.indexOf(beforeRowId);
    if(idx === -1) cat.rowIds.push(rowId); else cat.rowIds.splice(idx, 0, rowId);
  }
  renderRowList();
}

function reorderRowInCategory(rowId, catId, afterRowId){
  const cat = state.categories.find(c=>c.id===catId); if(!cat) return;
  cat.rowIds = cat.rowIds.filter(id=>id!==rowId);
  if(afterRowId === null) cat.rowIds.unshift(rowId);
  else {
    const i = cat.rowIds.indexOf(afterRowId);
    if(i===-1) cat.rowIds.push(rowId); else cat.rowIds.splice(i+1, 0, rowId);
  }
  const row = state.rows.find(r=>r.id===rowId); if(row) row.categoryId = catId;
  renderRowList();
}

function deleteRowById(rowId){
  state.rows = state.rows.filter(r=> r.id!==rowId);
  state.categories.forEach(c=> c.rowIds = c.rowIds.filter(id=>id!==rowId));
  renderRowList();
}

function syncCategoriesFromRows(){
  state.categories.forEach(c=> c.rowIds = []);
  state.rows.forEach(r=>{
    let cat = state.categories.find(c=>c.id===r.categoryId);
    if(!cat){ cat = state.categories[0]; r.categoryId = cat.id; }
    cat.rowIds.push(r.id);
  });
}

/* ---------- メニュー追加処理 ---------- */
document.getElementById('btnAddMenu').addEventListener('click', ()=>{
  const name = document.getElementById('newMenuName').value.trim();
  const priceRaw = document.getElementById('newMenuPrice').value.trim();
  const catId = document.getElementById('newMenuCat').value || null;
  if(!name && priceRaw==='') return alert('品名または価格を入力してください');
  if(priceRaw === ''){
    // create category
    const cat = { id: uid('cat'), title: name || '新しいカテゴリ', rowIds: [] };
    state.categories.push(cat);
    syncCategoriesFromRows();
    renderRowList();
    document.getElementById('newMenuName').value = '';
    document.getElementById('newMenuPrice').value = '';
    return;
  }
  const priceNum = Number(priceRaw.replace(/[^\d]/g,''));
  const row = { id: uid('r'), raw: name + '\t' + priceRaw, name: name || null, price: Number.isFinite(priceNum) ? priceNum : null, display:true, categoryId: catId, selected:false };
  state.rows.push(row);
  // if no category selected, put into uncategorized or first category
  if(!catId){
    let def = state.categories.find(c=>c.id==='cat-unc');
    if(!def){ def = { id:'cat-unc', title:'未分類', rowIds:[] }; state.categories.unshift(def); }
    row.categoryId = def.id;
    def.rowIds.push(row.id);
  } else {
    const cat = state.categories.find(c=>c.id===catId);
    if(cat) cat.rowIds.push(row.id);
  }
  document.getElementById('newMenuName').value = '';
  document.getElementById('newMenuPrice').value = '';
  renderRowList();
});

/* ---------- 編集モーダル（価格変更、価格空欄でカテゴリ化） ---------- */
let editingRowId = null;
function openEditModal(rowId){
  const r = state.rows.find(x=>x.id===rowId); if(!r) return;
  editingRowId = rowId;
  document.getElementById('editName').value = r.name || r.raw;
  document.getElementById('editPrice').value = r.price===null? '' : String(r.price);
  refreshCategorySelects();
  document.getElementById('editCat').value = r.categoryId || '';
  document.getElementById('editModal').classList.remove('hidden');
}
document.getElementById('editCancel').addEventListener('click', ()=>{
  editingRowId = null; document.getElementById('editModal').classList.add('hidden');
});
document.getElementById('editSave').addEventListener('click', ()=>{
  if(!editingRowId) return;
  const r = state.rows.find(x=>x.id===editingRowId); if(!r) return;
  const newName = document.getElementById('editName').value.trim();
  const newPriceRaw = document.getElementById('editPrice').value.trim();
  const newCat = document.getElementById('editCat').value || null;
  // If price empty -> convert this row into a category header
  if(newPriceRaw === ''){
    // create new category with title = newName (or raw)
    const title = newName || r.raw || '新しいカテゴリ';
    const cat = { id: uid('cat'), title: title, rowIds: [] };
    // remove row from rows and place this row's remaining data as nothing
    // we will remove the row and then reassign subsequent rows to this new category until next category appears.
    // Simpler approach: remove the row, insert new category at the position where the row used to be, and leave other rows' categories untouched.
    // To approximate user's expectation, we will remove the row and create category, then no automatic reassignment (user can drag).
    state.rows = state.rows.filter(rr=> rr.id !== editingRowId);
    state.categories.push(cat);
    syncCategoriesFromRows();
    editingRowId = null;
    document.getElementById('editModal').classList.add('hidden');
    renderRowList();
    alert('価格が空のため新しいカテゴリを作成しました。必要に応じてメニューをドラッグで移し替えてください。');
    return;
  }
  // Otherwise update row
  r.name = newName || r.name;
  const v = newPriceRaw.replace(/[^\d]/g,'');
  r.price = v === '' ? null : Number(v);
  r.categoryId = newCat || r.categoryId;
  syncCategoriesFromRows();
  editingRowId = null;
  document.getElementById('editModal').classList.add('hidden');
  renderRowList();
});

/* ---------- 背景処理（画像 / URL / プリセット / ダウンロード） ---------- */
function applyBackground(data){
  currentBg = data;
  const preview = document.getElementById('menuPreview');
  if(!preview) return;
  if(!data) { preview.style.backgroundImage = ''; preview.style.backgroundColor = ''; return; }
  if(data.startsWith('#')){ // color
    preview.style.backgroundImage = '';
    preview.style.backgroundColor = data;
  } else {
    preview.style.backgroundImage = `url(${data})`;
    preview.style.backgroundColor = '';
  }
}
document.getElementById('bgFile').addEventListener('change', e=>{
  const f = e.target.files[0]; if(!f) return;
  const fr = new FileReader(); fr.onload = ev=> applyBackground(ev.target.result); fr.readAsDataURL(f);
  e.target.value = '';
});
document.getElementById('btnLoadBg').addEventListener('click', async ()=>{
  const url = document.getElementById('bgUrl').value.trim();
  if(!url) return alert('URLを入力してください');
  try{
    const res = await fetch(url);
    if(!res.ok) throw new Error('取得失敗');
    const blob = await res.blob();
    const fr = new FileReader(); fr.onload = e=> applyBackground(e.target.result); fr.readAsDataURL(blob);
  }catch(err){ alert('背景画像のダウンロードに失敗しました'); }
});
document.getElementById('btnClearBg').addEventListener('click', ()=> applyBackground(null));
document.getElementById('btnDownloadBg').addEventListener('click', ()=>{
  if(!currentBg) return alert('背景が設定されていません');
  const a = document.createElement('a'); a.href = currentBg; a.download = 'background'; a.click();
});

/* ---------- プレビュー構築 ---------- */
function showPreview(){
  syncCategoriesFromRows();
  const preview = document.getElementById('menuPreview');
  const colCount = Number(document.getElementById('colCount').value || 2);
  const orientation = document.getElementById('orientation').value || 'portrait';
  preview.style.width = orientation==='landscape' ? '1120px' : '800px';
  // build inner content
  let html = `<div class="menu-inner" style="display:grid;grid-template-columns:repeat(${colCount},1fr);gap:18px">`;
  const blocks = [];
  state.categories.forEach(cat=>{
    const rows = cat.rowIds.map(rid => state.rows.find(r=>r.id===rid)).filter(Boolean).filter(r=>r.display);
    if(rows.length===0) return;
    let block = `<div><div class="menu-category">${escapeHtml(cat.title)}</div>`;
    rows.forEach(r=>{
      block += `<div class="menu-row"><div class="menu-name">${escapeHtml(r.name || r.raw)}</div><div class="menu-price">${r.price===null? '': '¥'+r.price}</div></div>`;
    });
    block += `</div>`;
    blocks.push(block);
  });
  // distribute blocks across columns
  const cols = Array.from({length:colCount}, ()=>'');
  let idx = 0;
  blocks.forEach(b=>{ cols[idx]+=b; idx=(idx+1)%colCount; });
  cols.forEach(c=> html += `<div>${c}</div>`);
  html += `</div>`;
  preview.innerHTML = html;
  document.getElementById('printArea').style.display = 'block';
  preview.scrollIntoView({behavior:'smooth'});
}

/* ---------- 保存 / 読込 / Export ---------- */
function downloadJSON(){
  const out = { meta:{exportedAt:new Date().toISOString()}, rows:state.rows, categories:state.categories, background:currentBg };
  const blob = new Blob([JSON.stringify(out, null, 2)], {type:'application/json'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'menu-export.json'; a.click(); URL.revokeObjectURL(a.href);
}
function handleJSONLoad(file){
  const fr = new FileReader();
  fr.onload = e=>{
    try{
      const parsed = JSON.parse(e.target.result);
      if(parsed.rows && parsed.categories){
        state.rows = parsed.rows.map(r=>({...r, selected:false}));
        state.categories = parsed.categories.map(c=>({...c}));
        currentBg = parsed.background || null;
        applyBackground(currentBg);
        syncCategoriesFromRows();
        renderRowList();
        alert('JSONを読み込みました。');
      } else alert('不正なJSON形式です');
    }catch(err){ alert('JSONの読み込みに失敗しました'); }
  };
  fr.readAsText(file);
}

function exportCSV(){
  const outRows = [];
  state.categories.forEach(cat=>{
    cat.rowIds.forEach(rid=>{
      const r = state.rows.find(rr=>rr.id===rid);
      if(!r) return;
      outRows.push({ Category: cat.title, Item: r.name || r.raw, Price: r.price===null? '' : r.price });
    });
  });
  const header = ['Category','Item','Price'];
  const csv = [header.join(',')].concat(outRows.map(row=> header.map(h=> `"${String(row[h] ?? '').replace(/"/g,'""')}"`).join(','))).join('\n');
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'}); const a = document.createElement('a');
  a.href = URL.createObjectURL(blob); a.download = 'menu-export.csv'; a.click(); URL.revokeObjectURL(a.href);
}

function exportXLSX(){
  const wb = XLSX.utils.book_new(); const out = [];
  state.categories.forEach(cat=>{
    out.push([cat.title]);
    cat.rowIds.forEach(rid=>{
      const r = state.rows.find(rr=>rr.id===rid);
      if(!r) return;
      out.push([r.name || r.raw, r.price===null? '': r.price]);
    });
    out.push([]);
  });
  const ws = XLSX.utils.aoa_to_sheet(out); XLSX.utils.book_append_sheet(wb, ws, 'Menu'); XLSX.writeFile(wb, 'menu-export.xlsx');
}

/* ---------- ヘルパー & バインド ---------- */
function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }

/* UI バインド */
document.getElementById('btnParse').addEventListener('click', async ()=>{
  const fi = document.getElementById('fileInput');
  const area = document.getElementById('pasteArea').value.trim();
  if(fi.files.length>0){ try{ await parseFile(fi.files[0]); fi.value=''; renderRowList(); }catch(err){ console.error(err); alert('ファイル読み込みに失敗しました'); } }
  else if(area){ parseTextRowsWithCategories(area); renderRowList(); }
  else alert('Excelファイルを選択するか、テキストを貼り付けてください');
});
document.getElementById('fileInput').addEventListener('change', async e=>{ if(e.target.files.length){ try{ await parseFile(e.target.files[0]); renderRowList(); }catch(err){ alert('読み込み失敗'); } e.target.value=''; } });
document.getElementById('btnClear').addEventListener('click', ()=>{ if(!confirm('全データをクリアしますか？')) return; state.rows=[]; state.categories=[]; currentBg=null; applyBackground(null); renderRowList(); });
document.getElementById('btnAutoGroup').addEventListener('click', ()=>{ autoGroupByKeywords(); renderRowList(); });
document.getElementById('btnAddCat').addEventListener('click', ()=>{ const t=document.getElementById('newCatTitle').value.trim(); if(!t) return alert('カテゴリ名を入力してください'); const c={id:uid('cat'),title:t,rowIds:[]}; state.categories.push(c); document.getElementById('newCatTitle').value=''; renderRowList(); });
document.getElementById('btnDownloadJSON').addEventListener('click', downloadJSON);
document.getElementById('btnLoadJSON').addEventListener('click', ()=> document.getElementById('jsonLoad').click());
document.getElementById('jsonLoad').addEventListener('change', e=>{ if(e.target.files.length) handleJSONLoad(e.target.files[0]); e.target.value=''; });
document.getElementById('btnExportXLSX').addEventListener('click', exportXLSX);
document.getElementById('btnExportCSV').addEventListener('click', exportCSV);
document.getElementById('btnPreview').addEventListener('click', ()=> showPreview());
document.getElementById('btnPreviewSmall').addEventListener('click', ()=> showPreview());
document.getElementById('btnPrint').addEventListener('click', ()=> { showPreview(); setTimeout(()=> window.print(), 250); });

document.getElementById('btnSelectAll').addEventListener('click', ()=> { state.rows.forEach(r=> r.selected=true); renderRowList(); });
document.getElementById('btnUnselectAll').addEventListener('click', ()=> { state.rows.forEach(r=> r.selected=false); renderRowList(); });
document.getElementById('btnGroupByKeyword').addEventListener('click', ()=> {
  const kw = prompt('キーワード（含む）を入力: 例: ラーメン'); if(!kw) return;
  const title = prompt('割当先カテゴリ名を入力（既存と同名ならそのカテゴリに追加）:', kw+' のカテゴリ'); if(!title) return;
  let cat = state.categories.find(c=>c.title===title); if(!cat){ cat={id:uid('cat'),title, rowIds:[]}; state.categories.push(cat); }
  state.rows.forEach(r=> { if(r.name && r.name.indexOf(kw)!==-1) assignRowToCategory(r.id, cat.id); });
  renderRowList();
});
document.getElementById('btnUngroup').addEventListener('click', ()=> {
  const sel = state.rows.filter(r=> r.selected);
  if(sel.length===0) return alert('先に行を選択してください（クリックで選択）');
  sel.forEach(r=>{ if(r.categoryId){ const old = state.categories.find(c=>c.id===r.categoryId); if(old) old.rowIds = old.rowIds.filter(id=>id!==r.id); r.categoryId = null; r.selected=false; }});
  let def = state.categories.find(c=>c.id==='cat-unc'); if(!def){ def={id:'cat-unc',title:'未分類',rowIds:[]}; state.categories.push(def); }
  state.rows.forEach(r=> { if(!r.categoryId){ r.categoryId = def.id; def.rowIds.push(r.id); }});
  renderRowList();
});

/* json load trigger */
document.getElementById('jsonLoad').addEventListener('change', e=>{ if(e.target.files.length) handleJSONLoad(e.target.files[0]); e.target.value=''; });

/* background download from URL button */
document.getElementById('btnLoadBg').addEventListener('click', async ()=>{/* handled above */});

/* helper: auto keyword grouping */
function autoGroupByKeywords(){
  const rules = [
    {k:'ラーメン', title:'麺類'},
    {k:'そば', title:'麺類'},
    {k:'焼きそば', title:'麺類'},
    {k:'デザート', title:'デザート'},
    {k:'お子様', title:'セット'},
    {k:'セット', title:'セット'},
    {k:'冷麺', title:'冷麺・旬'},
    {k:'丼', title:'丼物'},
    {k:'チャーシュー', title:'麺類'}
  ];
  rules.forEach(rule=>{
    let cat = state.categories.find(c=>c.title===rule.title);
    if(!cat){ cat={id:uid('cat'),title:rule.title,rowIds:[]}; state.categories.push(cat); }
    state.rows.forEach(r=>{ if(!r.categoryId && r.name && r.name.indexOf(rule.k)!==-1) assignRowToCategory(r.id, cat.id); });
  });
  let def = state.categories.find(c=>c.id==='cat-unc'); if(!def){ def={id:'cat-unc',title:'未分類',rowIds:[]}; state.categories.unshift(def); }
  state.rows.forEach(r=>{ if(!r.categoryId){ r.categoryId = def.id; def.rowIds.push(r.id); }});
}

/* ---------- Utility: simple initial sample (optional) ---------- */
// (none) — start empty

/* 初期レンダリング */
renderRowList();

</script>
</body>
</html>
