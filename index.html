<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>高機能リアルタイムチャット</title>
  <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@mdi/font@6.9.96/css/materialdesignicons.min.css">
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f0f2f5;
      color: #333;
      margin: 0;
      padding: 0;
    }

    header {
      background-color: #fff;
      color: #007bff;
      text-align: center;
      padding: 1rem;
      border-bottom: 1px solid #e9ecef;
    }

    #chatContainer {
      width: 90%;
      max-width: 800px;
      height: 60vh;
      margin: 20px auto;
      padding: 20px;
      background-color: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      overflow-y: auto;
    }

    .chatMessage {
      padding: 10px;
      margin-bottom: 10px;
      border-bottom: 1px solid #e9ecef;
      word-break: break-word;
      display: flex;
      align-items: flex-start;
    }

    .chatMessage:last-child {
      border-bottom: none;
    }

    .chatMessage .name {
      font-weight: bold;
      margin-right: 0.5rem;
    }

    .chatMessage .time {
      font-size: 0.75rem;
      color: #6c757d;
    }

    .inputArea {
      width: 90%;
      max-width: 800px;
      margin: 20px auto;
      padding: 20px;
      background-color: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .inputArea label {
      display: block;
      margin-bottom: 0.5rem;
      color: #495057;
    }

    .inputArea input[type="text"],
    .inputArea textarea {
      width: 100%;
      padding: 0.75rem;
      margin-bottom: 1rem;
      border: 1px solid #ced4da;
      border-radius: 4px;
      font-size: 1rem;
    }

    .inputArea textarea {
      resize: vertical;
    }

    .inputArea button {
      background-color: #007bff;
      color: #fff;
      border: none;
      padding: 0.75rem 1.5rem;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.2s ease;
    }

    .inputArea button:hover {
      background-color: #0056b3;
    }

    /* ダークモード用スタイル */
    body.dark-mode {
      background-color: #212529;
      color: #fff;
    }

    body.dark-mode header {
      background-color: #343a40;
      color: #fff;
      border-bottom-color: #495057;
    }

    body.dark-mode #chatContainer {
      background-color: #343a40;
      box-shadow: 0 2px 4px rgba(255, 255, 255, 0.1);
    }

    body.dark-mode .chatMessage {
      border-bottom-color: #495057;
    }

    body.dark-mode .inputArea {
      background-color: #343a40;
      box-shadow: 0 2px 4px rgba(255, 255, 255, 0.1);
    }

    body.dark-mode .inputArea label {
      color: #fff;
    }

    body.dark-mode .inputArea input[type="text"],
    body.dark-mode .inputArea textarea {
      background-color: #495057;
      color: #fff;
      border-color: #495057;
    }
  </style>
</head>
<body>
  <header>
    <h1>高機能リアルタイムチャット</h1>
  </header>

  <div id="chatContainer"></div>

  <div class="inputArea">
    <label for="nameInput">名前:</label>
    <input type="text" id="nameInput" placeholder="名前 (空の場合は『名無し』)">

    <label for="textInput">メッセージ:</label>
    <textarea id="textInput" rows="4" placeholder="メッセージを入力"></textarea>

    <button id="sendButton">送信</button>
    <button id="clearButton">クリア</button>
    <button id="darkModeButton">ダークモード</button>
  </div>

  <script>
    // Firebase設定
    const firebaseConfig = {
      apiKey: "AIzaSyCluZ07gfC31CH5njxq_inel53KOvV6jG8",
      authDomain: "chat-c59bf.firebaseapp.com",
      databaseURL: "https://chat-c59bf-default-rtdb.firebaseio.com",
      projectId: "chat-c59bf",
      storageBucket: "chat-c59bf.appspot.com",
      messagingSenderId: "383217078378",
      appId: "1:383217078378:web:3b90e80e25f7351d6bba13"
    };

    // Firebase初期化
    firebase.initializeApp(firebaseConfig);

    const db = firebase.database();
    const chatRef = db.ref("chat");

    // DOMエレメントの取得
    const chatContainer = document.getElementById("chatContainer");
    const textInput = document.getElementById("textInput");
    const nameInput = document.getElementById("nameInput");
    const sendButton = document.getElementById("sendButton");
    const clearButton = document.getElementById("clearButton");
    const darkModeButton = document.getElementById("darkModeButton");

    // メッセージ送信機能
    sendButton.addEventListener("click", function() {
      sendMessage();
    });

    textInput.addEventListener("keydown", function(event) {
      if (event.key === "Enter" && !event.shiftKey) { // Shift+Enterで改行
        event.preventDefault(); // デフォルトの改行を防止
        sendMessage();
      }
    });

    function sendMessage() {
      const name = nameInput.value.trim() || "名無し"; // 空の場合は「名無し」
      const message = textInput.value.trim();

      if (message === "") {
        alert("メッセージを入力してください");
        return;
      }

      // Firebaseにデータを送信
      chatRef.push({
        name: name,
        message: message,
        time: firebase.database.ServerValue.TIMESTAMP // サーバーのタイムスタンプを使用
      });

      // 入力欄をクリア
      textInput.value = "";
    }

    // チャットクリア機能
    clearButton.addEventListener("click", function() {
      if (confirm("チャットをクリアしますか？")) {
        chatRef.remove()
          .then(function() {
            console.log("チャットがクリアされました");
          })
          .catch(function(error) {
            console.error("チャットのクリアに失敗しました: ", error);
          });
      }
    });

    // ダークモード切替機能
    darkModeButton.addEventListener("click", function() {
      document.body.classList.toggle("dark-mode");
    });

    // メッセージのリアルタイム受信
    chatRef.on("child_added", function(snapshot) {
      const data = snapshot.val();
      const messageDiv = document.createElement("div");
      messageDiv.classList.add("chatMessage");

      // 名前、メッセージ、タイムスタンプをそれぞれ別の要素で表示
      const nameSpan = document.createElement("span");
      nameSpan.classList.add("name");
      nameSpan.textContent = data.name + ": ";
      messageDiv.appendChild(nameSpan);

      const messageText = document.createElement("span");
      messageText.classList.add("message");
      messageText.textContent = data.message;
      messageDiv.appendChild(messageText);

      const timeSpan = document.createElement("span");
      timeSpan.classList.add("time");
      // タイムスタンプをDateオブジェクトに変換してフォーマット
      const date = new Date(data.time);
      const formattedTime = date.toLocaleString();
      timeSpan.textContent = " (" + formattedTime + ")";
      messageDiv.appendChild(timeSpan);

      chatContainer.appendChild(messageDiv);

      // 自動スクロール
      chatContainer.scrollTop = chatContainer.scrollHeight;
    });

    // チャット内容が更新されたときに実行される関数
    chatRef.on("child_removed", function(snapshot) {
      // 削除されたメッセージに対応する処理 (例: 画面からメッセージを削除)
      chatContainer.innerHTML = ''; // 簡単のため、毎回チャット内容を再描画
    });
  </script>
</body>
</html>