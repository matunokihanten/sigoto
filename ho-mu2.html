<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>WebBuilder Pro - å®Œå…¨ã‚µãƒ³ãƒ‰ãƒœãƒƒã‚¯ã‚¹ç‰ˆ</title>
  <style>
    :root {
      --primary: #2563eb; --bg-app: #0f172a; --bg-toolbar: #ffffff;
      --border: #e2e8f0; --text: #334155;
    }
    * { box-sizing: border-box; }
    body { 
      margin: 0; padding: 0; font-family: sans-serif;
      background-color: var(--bg-app); height: 100vh;
      display: flex; flex-direction: column; overflow: hidden;
    }
    header, .format-bar {
      background: var(--bg-toolbar); border-bottom: 1px solid var(--border);
      padding: 10px 20px; display: flex; gap: 10px; align-items: center; z-index: 100;
    }
    .format-bar { background: #f8fafc; padding: 5px 20px; }
    .btn {
      padding: 6px 12px; border-radius: 4px; border: 1px solid var(--border);
      background: white; cursor: pointer; font-size: 13px; color: var(--text);
      display: flex; align-items: center; gap: 5px;
    }
    .btn:hover { border-color: var(--primary); background: #f8fafc; }
    .btn.active { background: var(--primary); color: white; }
    .btn-primary { background: var(--primary); color: white; border: none; }
    
    #workspace { flex: 1; overflow: auto; display: flex; justify-content: center; padding: 30px; transition: 0.3s; }
    
    #editor-wrapper {
      background: white; box-shadow: 0 30px 60px rgba(0,0,0,0.4);
      transition: width 0.4s; width: 100%; max-width: 1200px;
      display: flex; flex-direction: column; position: relative;
    }
    
    /* ç·¨é›†ç”¨iframeã®ã‚¹ã‚¿ã‚¤ãƒ« */
    #edit-frame {
      width: 100%; flex: 1; border: none; background: white;
    }
    
    #source-editor {
      display: none; background: #1e1e1e; color: #9cdcfe;
      width: 100%; flex: 1; border: none; padding: 20px;
      font-family: monospace; line-height: 1.6; resize: none;
    }

    .view-mobile #editor-wrapper { width: 375px; }
    body.preview-mode #workspace { padding: 0; }
    body.preview-mode #editor-wrapper { max-width: 100%; width: 100%; height: 100%; }
    body.preview-mode header, body.preview-mode .format-bar { display: none; }

    #exit-preview { position: fixed; bottom: 20px; right: 20px; display: none; z-index: 2000; }
    body.preview-mode #exit-preview { display: block; }
    .toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: #059669; color: white; padding: 10px 25px; border-radius: 50px; display: none; z-index: 2000; }
  </style>
</head>
<body class="view-desktop">

  <header>
    <div style="font-weight:bold; color:var(--primary)">WebBuilder Pro</div>
    <button class="btn" onclick="execUndo()">â†¶ æˆ»ã™</button>
    <button class="btn" onclick="execRedo()">â†· é€²ã‚€</button>
    <input type="file" id="file-in" accept=".html" style="display:none" onchange="importHTML(this)">
    <button class="btn" onclick="document.getElementById('file-in').click()">ğŸ“ é–‹ã</button>
    <button class="btn btn-primary" onclick="saveFile(false)">ğŸ’¾ ä¸Šæ›¸ã</button>
    <button class="btn" onclick="saveFile(true)">ğŸ“¤ åˆ¥åä¿å­˜</button>
    <button class="btn active" id="btn-pc" onclick="setView('desktop')">ğŸ’» PC</button>
    <button class="btn" id="btn-sp" onclick="setView('mobile')">ğŸ“± ã‚¹ãƒãƒ›</button>
    <button class="btn" id="btn-code" onclick="toggleMode()">ã‚½ãƒ¼ã‚¹</button>
    <button class="btn" onclick="setPreview(true)">ğŸ‘ï¸ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</button>
  </header>

  <div class="format-bar">
    <button class="btn" onclick="format('bold')"><b>B</b></button>
    <button class="btn" onclick="format('italic')"><i>I</i></button>
    <button class="btn" onclick="format('insertUnorderedList')">â€¢ ãƒªã‚¹ãƒˆ</button>
    <button class="btn" onclick="insertLink()">ğŸ”— ãƒªãƒ³ã‚¯</button>
    <input type="color" onchange="format('foreColor', this.value)">
  </div>

  <div id="workspace">
    <div id="editor-wrapper">
      <iframe id="edit-frame"></iframe>
      <textarea id="source-editor" spellcheck="false"></textarea>
    </div>
  </div>

  <button class="btn btn-primary" id="exit-preview" onclick="setPreview(false)">âœ• çµ‚äº†</button>
  <div class="toast" id="toast"></div>

  <script>
    const frame = document.getElementById('edit-frame');
    const source = document.getElementById('source-editor');
    let fileHandle = null;
    let isCodeMode = false;

    // iframeã®åˆæœŸåŒ–
    function initFrame(content = '<html><body><h1>æ–°è¦ãƒšãƒ¼ã‚¸</h1><p>ç·¨é›†ã‚’é–‹å§‹ã—ã¦ãã ã•ã„ã€‚</p></body></html>') {
      const doc = frame.contentDocument || frame.contentWindow.document;
      doc.open();
      doc.write(content);
      doc.close();
      doc.designMode = 'on';
      
      // iframeå†…ã®å…¥åŠ›ã‚’ç›£è¦–ã—ã¦å±¥æ­´ä¿å­˜
      doc.addEventListener('input', () => {
        clearTimeout(this.timer);
        this.timer = setTimeout(saveHistory, 500);
      });
    }

    // ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆå®Ÿè¡Œ
    function format(cmd, val = null) {
      frame.contentDocument.execCommand(cmd, false, val);
      saveHistory();
    }

    function insertLink() {
      const url = prompt("URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:", "https://");
      if (url) format('createLink', url);
    }

    // ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ
    function toggleMode() {
      isCodeMode = !isCodeMode;
      const doc = frame.contentDocument;
      if (isCodeMode) {
        source.value = doc.documentElement.outerHTML;
        frame.style.display = 'none';
        source.style.display = 'block';
      } else {
        initFrame(source.value);
        source.style.display = 'none';
        frame.style.display = 'block';
      }
      document.getElementById('btn-code').classList.toggle('active', isCodeMode);
    }

    // ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿
    async function importHTML(input) {
      const file = input.files[0];
      if (!file) return;
      const text = await file.text();
      initFrame(text);
      showToast("èª­ã¿è¾¼ã¿å®Œäº†");
    }

    // ä¿å­˜æ©Ÿèƒ½
    async function saveFile(isNew = false) {
      const content = isCodeMode ? source.value : (frame.contentDocument.documentElement.outerHTML);
      const html = content.startsWith('<!DOCTYPE') ? content : '<!DOCTYPE html>\n' + content;

      try {
        if (isNew || !fileHandle) {
          fileHandle = await window.showSaveFilePicker({
            suggestedName: 'index.html',
            types: [{ description: 'HTML', accept: {'text/html': ['.html']} }]
          });
        }
        const writable = await fileHandle.createWritable();
        await writable.write(html);
        await writable.close();
        showToast("ä¿å­˜å®Œäº†");
      } catch (e) { console.error(e); }
    }

    // å±¥æ­´ç®¡ç†
    let history = [];
    let hIdx = -1;
    function saveHistory() {
      const cur = isCodeMode ? source.value : frame.contentDocument.documentElement.outerHTML;
      if (history[hIdx] === cur) return;
      history = history.slice(0, hIdx + 1);
      history.push(cur);
      hIdx++;
    }
    function execUndo() { if (hIdx > 0) { hIdx--; applyH(); } }
    function execRedo() { if (hIdx < history.length - 1) { hIdx++; applyH(); } }
    function applyH() {
      if (isCodeMode) source.value = history[hIdx];
      else initFrame(history[hIdx]);
    }

    // UIåˆ¶å¾¡
    function setView(v) {
      document.body.className = 'view-' + v;
      document.getElementById('btn-pc').classList.toggle('active', v==='desktop');
      document.getElementById('btn-sp').classList.toggle('active', v==='mobile');
    }

    function setPreview(on) {
      if (on) {
        if (isCodeMode) toggleMode();
        frame.contentDocument.designMode = 'off';
        document.body.classList.add('preview-mode');
      } else {
        frame.contentDocument.designMode = 'on';
        document.body.classList.remove('preview-mode');
      }
    }

    function showToast(m) {
      const t = document.getElementById('toast');
      t.textContent = m; t.style.display = 'block';
      setTimeout(() => t.style.display = 'none', 2000);
    }

    window.onload = () => { initFrame(); saveHistory(); };
    document.addEventListener('keydown', e => {
      if ((e.ctrlKey || e.metaKey) && e.key === 's') { e.preventDefault(); saveFile(); }
    });
  </script>
</body>
</html>
