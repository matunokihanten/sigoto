<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>WebBuilder Pro - ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸åˆ¶ä½œã‚¨ãƒ‡ã‚£ã‚¿ (ä¸Šæ›¸ãä¿å­˜å¯¾å¿œ)</title>
  <style>
    :root {
      --primary: #2563eb;
      --primary-dark: #1e40af;
      --bg-app: #0f172a;
      --bg-toolbar: #ffffff;
      --border: #e2e8f0;
      --text: #334155;
    }
    * { box-sizing: border-box; }
    body { 
      margin: 0; padding: 0; 
      font-family: 'Helvetica Neue', Arial, 'Hiragino Kaku Gothic ProN', sans-serif;
      background-color: var(--bg-app); 
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    header {
      background: var(--bg-toolbar);
      border-bottom: 1px solid var(--border);
      padding: 10px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      z-index: 100;
    }
    .app-logo { font-weight: bold; color: var(--primary); font-size: 1.1rem; }
    .main-toolbar, .format-bar {
      display: flex; gap: 8px; align-items: center;
    }
    .btn {
      padding: 6px 12px; border-radius: 4px; border: 1px solid var(--border);
      background: white; cursor: pointer; font-size: 13px; transition: 0.2s;
      color: var(--text); display: flex; align-items: center; gap: 5px;
    }
    .btn:hover:not(:disabled) { border-color: var(--primary); background: #f8fafc; }
    .btn.active { background: var(--primary); color: white; border-color: var(--primary); }
    .btn-primary { background: var(--primary); color: white; border: none; }
    .btn:disabled { opacity: 0.3; cursor: not-allowed; }
    .format-bar {
      background: #f8fafc; border-bottom: 1px solid var(--border);
      padding: 5px 20px;
    }
    #workspace {
      flex: 1; overflow: auto; display: flex; justify-content: center;
      padding: 30px;
    }
    #editor-container {
      background: white; box-shadow: 0 30px 60px rgba(0,0,0,0.4);
      transition: width 0.4s;
      display: flex; flex-direction: column; width: 100%; max-width: 1200px;
    }
    .browser-mock {
      height: 35px; background: #f1f5f9; border-bottom: 1px solid var(--border);
      display: flex; align-items: center; padding: 0 15px; gap: 6px;
    }
    .dot { width: 10px; height: 10px; border-radius: 50%; background: #cbd5e1; }
    #editor, #source-editor {
      width: 100%; flex: 1; border: none; padding: 40px;
      outline: none; min-height: 70vh; overflow-y: auto;
    }
    #source-editor {
      display: none; background: #1e1e1e; color: #9cdcfe;
      font-family: 'Consolas', monospace; line-height: 1.6; resize: none;
    }
    .view-mobile #editor-container { width: 375px; }
    .modal {
      position: fixed; inset: 0; background: rgba(0,0,0,0.6);
      display: none; justify-content: center; align-items: center; z-index: 1000;
    }
    .modal.show { display: flex; }
    .modal-content {
      background: white; padding: 25px; border-radius: 12px; width: 450px;
    }
    .input-group { margin-bottom: 15px; }
    .input-group label { display: block; margin-bottom: 5px; font-size: 12px; font-weight: bold; }
    input[type="text"], textarea, select {
      width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 5px;
    }
    .toast {
      position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
      background: #059669; color: white; padding: 10px 25px; border-radius: 50px;
      display: none; z-index: 2000;
    }
  </style>
</head>
<body class="view-desktop">

  <header>
    <div class="app-logo">WebBuilder Pro</div>
    <div class="main-toolbar">
      <button class="btn" id="undo-btn" onclick="undo()" title="å…ƒã«æˆ»ã™ (Ctrl+Z)">â†¶ æˆ»ã™</button>
      <button class="btn" id="redo-btn" onclick="redo()" title="ã‚„ã‚Šç›´ã— (Ctrl+Y)">â†· é€²ã‚€</button>
      <div style="width: 1px; height: 20px; background: #ddd; margin: 0 5px;"></div>
      
      <button class="btn" onclick="importHTML()">ğŸ“ é–‹ã</button>
      <button class="btn btn-primary" onclick="saveOverwrite()" title="ä¸Šæ›¸ãä¿å­˜ (Ctrl+S)">ğŸ’¾ ä¿å­˜</button>
      <button class="btn" onclick="exportFinalHTML()">ğŸ“¤ åˆ¥åã§ä¿å­˜</button>

      <div style="width: 1px; height: 20px; background: #ddd; margin: 0 5px;"></div>
      <button class="btn active" id="btn-pc" onclick="changeView('desktop')">ğŸ’» PC</button>
      <button class="btn" id="btn-sp" onclick="changeView('mobile')">ğŸ“± ã‚¹ãƒãƒ›</button>
      <button class="btn" id="btn-toggle-code" onclick="toggleEditorMode()">HTMLã‚½ãƒ¼ã‚¹</button>
      <button class="btn" onclick="openModal('seo-modal')">âš™ï¸ è¨­å®š</button>
    </div>
  </header>

  <div class="format-bar" id="fmt-bar">
    <select onchange="doFormat('formatBlock', this.value)" style="width:120px;">
      <option value="p">æ¨™æº–ãƒ†ã‚­ã‚¹ãƒˆ</option>
      <option value="h1">å¤§è¦‹å‡ºã— H1</option>
      <option value="h2">ä¸­è¦‹å‡ºã— H2</option>
      <option value="h3">å°è¦‹å‡ºã— H3</option>
    </select>
    <button class="btn" onclick="doFormat('bold')">B</button>
    <button class="btn" onclick="doFormat('italic')">I</button>
    <button class="btn" onclick="openModal('link-modal')">ğŸ”— ãƒªãƒ³ã‚¯</button>
    <button class="btn" onclick="openModal('img-modal')">ğŸ–¼ï¸ ç”»åƒ</button>
    <input type="color" onchange="doFormat('foreColor', this.value)">
  </div>

  <div id="workspace">
    <div id="editor-container">
      <div class="browser-mock"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>
      <div id="editor" contenteditable="true">
        <h1>ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸åˆ¶ä½œã‚¨ãƒ‡ã‚£ã‚¿</h1>
        <p>èª¤ã£ã¦å‰Šé™¤ã—ãŸå ´åˆã¯ã€å·¦ä¸Šã®ã€Œæˆ»ã™ã€ãƒœã‚¿ãƒ³ã€ã¾ãŸã¯ Ctrl+Z ã§å¾©å…ƒã§ãã¾ã™ã€‚</p>
      </div>
      <textarea id="source-editor" spellcheck="false"></textarea>
    </div>
  </div>

  <div class="modal" id="link-modal"><div class="modal-content"><h3>ãƒªãƒ³ã‚¯æŒ¿å…¥</h3><input type="text" id="link-url" placeholder="https://"><br><br><button class="btn btn-primary" onclick="applyLink()">é©ç”¨</button><button class="btn" onclick="closeModal('link-modal')">é–‰ã˜ã‚‹</button></div></div>
  <div class="modal" id="img-modal"><div class="modal-content"><h3>ç”»åƒæŒ¿å…¥</h3><input type="text" id="img-src" placeholder="ç”»åƒURL"><br><br><button class="btn btn-primary" onclick="applyImage()">æŒ¿å…¥</button><button class="btn" onclick="closeModal('img-modal')">é–‰ã˜ã‚‹</button></div></div>
  <div class="modal" id="seo-modal"><div class="modal-content"><h3>ãƒšãƒ¼ã‚¸è¨­å®š</h3><div class="input-group"><label>ã‚¿ã‚¤ãƒˆãƒ«</label><input type="text" id="seo-title"></div><div class="input-group"><label>èª¬æ˜</label><textarea id="seo-desc"></textarea></div><button class="btn btn-primary" onclick="closeModal('seo-modal')">ä¿å­˜</button></div></div>

  <div class="toast" id="toast-msg"></div>

  <script>
    const editor = document.getElementById('editor');
    const sourceEditor = document.getElementById('source-editor');
    
    // --- ãƒ•ã‚¡ã‚¤ãƒ«ç®¡ç†å¤‰æ•° ---
    let fileHandle = null;

    // --- å±¥æ­´ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  ---
    let historyStack = [];
    let historyIndex = -1;
    const maxHistory = 50;

    function saveHistory() {
      const currentContent = isCodeMode ? sourceEditor.value : editor.innerHTML;
      if (historyIndex >= 0 && historyStack[historyIndex] === currentContent) return;
      historyStack = historyStack.slice(0, historyIndex + 1);
      historyStack.push(currentContent);
      if (historyStack.length > maxHistory) {
        historyStack.shift();
      } else {
        historyIndex++;
      }
      updateHistoryButtons();
    }

    function undo() {
      if (historyIndex > 0) {
        historyIndex--;
        const content = historyStack[historyIndex];
        if (isCodeMode) sourceEditor.value = content;
        else editor.innerHTML = content;
        updateHistoryButtons();
      }
    }

    function redo() {
      if (historyIndex < historyStack.length - 1) {
        historyIndex++;
        const content = historyStack[historyIndex];
        if (isCodeMode) sourceEditor.value = content;
        else editor.innerHTML = content;
        updateHistoryButtons();
      }
    }

    function updateHistoryButtons() {
      document.getElementById('undo-btn').disabled = (historyIndex <= 0);
      document.getElementById('redo-btn').disabled = (historyIndex >= historyStack.length - 1);
    }

    editor.addEventListener('input', () => {
      clearTimeout(this.timer);
      this.timer = setTimeout(saveHistory, 500);
    });

    // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ
    document.addEventListener('keydown', (e) => {
      if (e.ctrlKey || e.metaKey) {
        if (e.key === 'z') { e.preventDefault(); undo(); }
        if (e.key === 'y') { e.preventDefault(); redo(); }
        if (e.key === 's') { e.preventDefault(); saveOverwrite(); }
      }
    });

    // --- ã‚¨ãƒ‡ã‚£ã‚¿åŸºæœ¬æ©Ÿèƒ½ ---
    let isCodeMode = false;
    function doFormat(cmd, val) {
      if(isCodeMode) return;
      document.execCommand(cmd, false, val);
      saveHistory();
      editor.focus();
    }

    function toggleEditorMode() {
      isCodeMode = !isCodeMode;
      const btn = document.getElementById('btn-toggle-code');
      if (isCodeMode) {
        sourceEditor.value = editor.innerHTML;
        editor.style.display = 'none';
        sourceEditor.style.display = 'block';
        btn.classList.add('active');
      } else {
        editor.innerHTML = sourceEditor.value;
        sourceEditor.style.display = 'none';
        editor.style.display = 'block';
        btn.classList.remove('active');
      }
      saveHistory();
    }

    function changeView(type) {
      document.body.className = 'view-' + type;
      document.getElementById('btn-pc').classList.toggle('active', type === 'desktop');
      document.getElementById('btn-sp').classList.toggle('active', type === 'mobile');
    }

    // --- ãƒ•ã‚¡ã‚¤ãƒ«å…¥å‡ºåŠ›æ©Ÿèƒ½ ---

    // æ–°è¦èª­ã¿è¾¼ã¿ï¼ˆãƒ•ã‚¡ã‚¤ãƒ«ãƒãƒ³ãƒ‰ãƒ«ä¿æŒå¯¾å¿œï¼‰
    async function importHTML() {
      try {
        if (!window.showOpenFilePicker) {
          alert('ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯ãƒ•ã‚¡ã‚¤ãƒ«ç›´æ¥æ“ä½œã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚');
          return;
        }
        [fileHandle] = await window.showOpenFilePicker({
          types: [{ description: 'HTMLãƒ•ã‚¡ã‚¤ãƒ«', accept: {'text/html': ['.html']} }],
          multiple: false
        });
        const file = await fileHandle.getFile();
        const text = await file.text();
        const doc = new DOMParser().parseFromString(text, 'text/html');
        document.getElementById('seo-title').value = doc.title || '';
        editor.innerHTML = doc.body.innerHTML;
        saveHistory();
        showToast('èª­ã¿è¾¼ã¿å®Œäº†');
      } catch (err) {
        console.warn('ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸ');
      }
    }

    // ä¸Šæ›¸ãä¿å­˜
    async function saveOverwrite() {
      if (!fileHandle) {
        return exportFinalHTML(); // ãƒãƒ³ãƒ‰ãƒ«ãŒãªã‘ã‚Œã°åˆ¥åä¿å­˜ã¸
      }
      try {
        const content = isCodeMode ? sourceEditor.value : editor.innerHTML;
        const title = document.getElementById('seo-title').value || 'My Page';
        const html = `<!DOCTYPE html><html><head><meta charset="UTF-8"><title>${title}</title></head><body>${content}</body></html>`;
        
        const writable = await fileHandle.createWritable();
        await writable.write(html);
        await writable.close();
        showToast('ä¸Šæ›¸ãä¿å­˜å®Œäº†');
      } catch (err) {
        console.error(err);
        showToast('ä¿å­˜ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
      }
    }

    // åˆ¥åã§ä¿å­˜ï¼ˆã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆï¼‰
    async function exportFinalHTML() {
      const content = isCodeMode ? sourceEditor.value : editor.innerHTML;
      const title = document.getElementById('seo-title').value || 'My Page';
      const html = `<!DOCTYPE html><html><head><meta charset="UTF-8"><title>${title}</title></head><body>${content}</body></html>`;

      if (window.showSaveFilePicker) {
        try {
          fileHandle = await window.showSaveFilePicker({
            suggestedName: 'index.html',
            types: [{ description: 'HTMLãƒ•ã‚¡ã‚¤ãƒ«', accept: {'text/html': ['.html']} }]
          });
          const writable = await fileHandle.createWritable();
          await writable.write(html);
          await writable.close();
          showToast('ä¿å­˜å®Œäº†');
        } catch (err) { console.warn('ä¿å­˜ã‚­ãƒ£ãƒ³ã‚»ãƒ«'); }
      } else {
        // éå¯¾å¿œãƒ–ãƒ©ã‚¦ã‚¶ç”¨ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
        const blob = new Blob([html], {type: 'text/html'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'index.html';
        a.click();
      }
    }

    function openModal(id) { document.getElementById(id).classList.add('show'); }
    function closeModal(id) { document.getElementById(id).classList.remove('show'); }

    function applyLink() {
      const url = document.getElementById('link-url').value;
      if(url) doFormat('createLink', url);
      closeModal('link-modal');
    }

    function applyImage() {
      const src = document.getElementById('img-src').value;
      if(src) doFormat('insertHTML', `<img src="${src}">`);
      closeModal('img-modal');
    }

    function showToast(msg) {
      const t = document.getElementById('toast-msg');
      t.textContent = msg; t.style.display = 'block';
      setTimeout(() => t.style.display = 'none', 2000);
    }

    window.onload = () => {
      saveHistory();
    };
  </script>
</body>
</html>
