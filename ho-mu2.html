<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>é€²åŒ–ç‰ˆHTMLã‚¨ãƒ‡ã‚£ã‚¿</title>
  <style>
    /* åŸºæœ¬ã‚¹ã‚¿ã‚¤ãƒ« */
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; background: #f5f5f5; }
    header { 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 15px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      color: white;
      position: sticky;
      top: 0;
      z-index: 1000;
    }
    .toolbar {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
    }
    .toolbar-group {
      display: flex;
      gap: 5px;
      padding: 5px;
      background: rgba(255,255,255,0.1);
      border-radius: 8px;
    }
    button {
      padding: 8px 12px;
      border: none;
      border-radius: 5px;
      background: #fff;
      color: #333;
      cursor: pointer;
      transition: all 0.3s;
      font-size: 12px;
    }
    button:hover { background: #e0e0e0; transform: translateY(-1px); }
    button:active { transform: translateY(0); }
    .btn-primary { background: #4CAF50; color: white; }
    .btn-primary:hover { background: #45a049; }
    .btn-danger { background: #f44336; color: white; }
    .btn-danger:hover { background: #da190b; }
    
    #editor {
      margin: 20px;
      padding: 20px;
      border: 2px solid #ddd;
      min-height: 500px;
      background: white;
      border-radius: 10px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      line-height: 1.6;
    }
    
    /* é«˜åº¦ãªã‚¨ãƒ‡ã‚£ã‚¿æ©Ÿèƒ½ */
    .format-toolbar {
      position: sticky;
      top: 68px; /* headerã®é«˜ã• + è‹¥å¹²ã®éš™é–“ */
      background: #f8f9fa;
      padding: 10px;
      border-bottom: 1px solid #ddd;
      display: flex;
      gap: 5px;
      flex-wrap: wrap;
      z-index: 100;
    }
    
    /* ãƒªãƒ³ã‚¯ãƒœã‚¿ãƒ³ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
    .link-grid {
      display: grid;
      gap: 10px;
      margin: 15px 0;
    }
    .link-button {
      display: inline-block;
      padding: 10px 15px;
      text-decoration: none;
      color: white;
      border-radius: 8px;
      margin: 5px;
      transition: all 0.3s;
      font-weight: bold;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    .link-button:hover { transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
    
    .simple-button {
      background: #f8f9fa !important;
      color: #495057 !important;
      border: 2px solid #6c757d !important;
      border-radius: 4px !important;
      box-shadow: none !important;
    }
    .simple-button:hover { background: #e9ecef !important; }
    
    /* ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ */
    .modal {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.6);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      backdrop-filter: blur(5px);
    }
    .modal-content {
      background: white;
      padding: 30px;
      max-width: 800px;
      width: 90%;
      max-height: 80%;
      overflow-y: auto;
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 2px solid #eee;
    }
    .close-btn {
      background: #f44336;
      color: white;
      border: none;
      width: 30px;
      height: 30px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 16px;
    }
    
    .modal-content input[type="text"],
    .modal-content input[type="number"],
    .modal-content input[type="url"],
    .modal-content select,
    .modal-content textarea {
      width: 100%;
      box-sizing: border-box;
      padding: 10px;
      font-size: 14px;
      border: 2px solid #ddd;
      border-radius: 5px;
      margin-bottom: 10px;
    }
    .modal-content input:focus,
    .modal-content select:focus,
    .modal-content textarea:focus {
      border-color: #667eea;
      outline: none;
    }
    
    /* ãƒ†ãƒ¼ãƒ–ãƒ«ã‚¹ã‚¿ã‚¤ãƒ« */
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    table, th, td { border: 1px solid #ddd; }
    th {
      background: #667eea;
      color: white;
      padding: 12px;
      text-align: left;
    }
    td { padding: 10px; }
    td:first-child { width: 50px; text-align: center; }
    td:last-child { width: 80px; text-align: center; }
    .draggable { cursor: move; background: #f9f9f9; }
    .dragging { opacity: 0.5; }
    
    /* ã‚°ãƒªãƒƒãƒ‰ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
    .link-grid {
      display: grid;
      gap: 10px;
      margin: 15px 0;
    }
    
    /* ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¨ãƒªã‚¢ */
    .preview-area {
      border: 2px solid #28a745;
      border-radius: 10px;
      padding: 15px;
      margin: 10px 0;
      background: #f8fff8;
    }
    
    /* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
    .fade-in {
      animation: fadeIn 0.3s ease-in;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ– */
    @media (max-width: 768px) {
      .toolbar { flex-direction: column; }
      .toolbar-group { justify-content: center; }
      #editor { margin: 10px; padding: 15px; }
      .modal-content { width: 95%; padding: 20px; }
    }
    
    /* æ–°æ©Ÿèƒ½ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
    .snippet-list {
      max-height: 200px;
      overflow-y: auto;
      border: 1px solid #ddd;
      background: white;
    }
    .snippet-item {
      padding: 10px;
      border-bottom: 1px solid #eee;
      cursor: pointer;
    }
    .snippet-item:hover { background: #f0f0f0; }
    
    /* çµ±è¨ˆè¡¨ç¤º */
    .stats {
      background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
      color: white;
      padding: 10px;
      border-radius: 8px;
      margin: 10px 0;
    }
    
    /* æ¤œç´¢ãƒã‚¤ãƒ©ã‚¤ãƒˆ */
    .highlight { background-color: yellow; padding: 2px; }
    
    /* è‡ªå‹•ä¿å­˜ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ */
    .save-indicator {
      position: fixed;
      top: 20px;
      right: 20px;
      background: #28a745;
      color: white;
      padding: 10px 15px;
      border-radius: 5px;
      display: none;
      z-index: 1000;
    }
    
    /* æ–°è¦ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
    @keyframes bounce {
        0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
        40% { transform: translateY(-10px); }
        60% { transform: translateY(-5px); }
    }
    
    @keyframes slideIn {
        from { opacity: 0; transform: translateX(-50px); }
        to { opacity: 1; transform: translateX(0); }
    }
    
    .link-button.bounce {
        animation: bounce 1s infinite;
    }
    .link-button.slideIn {
        animation: slideIn 0.5s ease-out;
    }
  </style>
</head>
<body>
  <div class="save-indicator" id="saveIndicator">è‡ªå‹•ä¿å­˜ä¸­...</div>
  
  <header>
    <div class="toolbar">
      <div class="toolbar-group">
        <input type="file" id="fileInput" accept=".html,.txt,.md" style="display:none">
        <button id="selectFile" class="btn-primary">ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ</button>
        <button id="saveFile" class="btn-primary">ğŸ’¾ ä¿å­˜</button>
        <button id="exportFile">ğŸ“¤ ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
        <button id="importText">ğŸ“¥ ãƒ†ã‚­ã‚¹ãƒˆå–ã‚Šè¾¼ã¿</button>
      </div>
      
      <div class="toolbar-group">
        <button id="undoBtn">â†¶ æˆ»ã‚‹</button>
        <button id="redoBtn">â†· é€²ã‚€</button>
        <button id="clearAll" class="btn-danger">ğŸ—‘ å…¨æ¶ˆå»</button>
      </div>
      
      <div class="toolbar-group">
        <label style="color: white;">èƒŒæ™¯è‰²: <input type="color" id="bgColorPicker" value="#ffffff"></label>
        <button id="togglePreview">ğŸ‘ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</button>
        <button id="fullscreen">ğŸ”³ å…¨ç”»é¢</button>
      </div>
      
      <div class="toolbar-group">
        <button id="editLinks">ğŸ”— ãƒªãƒ³ã‚¯ç·¨é›†</button>
        <button id="insertStyledText">âœ¨ ã‚¹ã‚¿ã‚¤ãƒ«æ–‡å­—</button>
        <button id="generateTOC">ğŸ“‹ ç›®æ¬¡ç”Ÿæˆ</button>
        <button id="makeSimple">ğŸ“ ã‚·ãƒ³ãƒ—ãƒ«åŒ–</button>
      </div>
      
      <div class="toolbar-group">
        <button id="insertSnippet">ğŸ“„ å®šå‹æ–‡</button>
        <button id="searchReplace">ğŸ” æ¤œç´¢ç½®æ›</button>
        <button id="wordCount">ğŸ“Š çµ±è¨ˆ</button>
        <button id="spellCheck">ğŸ“– æ ¡æ­£</button>
      </div>
    </div>
  </header>

  <div class="format-toolbar">
    <button onclick="document.execCommand('bold')"><b>B</b></button>
    <button onclick="document.execCommand('italic')"><i>I</i></button>
    <button onclick="document.execCommand('underline')"><u>U</u></button>
    <button onclick="document.execCommand('strikeThrough')"><s>S</s></button>
    <button onclick="document.execCommand('justifyLeft')">â¬…</button>
    <button onclick="document.execCommand('justifyCenter')">â¬†</button>
    <button onclick="document.execCommand('justifyRight')">â¡</button>
    <button onclick="document.execCommand('insertOrderedList')">1.</button>
    <button onclick="document.execCommand('insertUnorderedList')">â€¢</button>
    <button onclick="document.execCommand('outdent')">â¬…</button>
    <button onclick="document.execCommand('indent')">â¡</button>
    <select onchange="document.execCommand('formatBlock', false, this.value); this.selectedIndex=0;">
      <option value="">è¦‹å‡ºã—é¸æŠ</option>
      <option value="h1">è¦‹å‡ºã—1</option>
      <option value="h2">è¦‹å‡ºã—2</option>
      <option value="h3">è¦‹å‡ºã—3</option>
      <option value="p">æ®µè½</option>
    </select>
  </div>

  <div id="editor" contenteditable="true">
    <h1>HTMLã‚¨ãƒ‡ã‚£ã‚¿ã¸ã‚ˆã†ã“ã</h1>
    <p>ã“ã®ã‚¨ãƒ‡ã‚£ã‚¿ã¯å¤šãã®é«˜åº¦ãªæ©Ÿèƒ½ã‚’å‚™ãˆã¦ã„ã¾ã™ã€‚</p>
    <ul>
      <li>ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</li>
      <li>è‡ªå‹•ä¿å­˜æ©Ÿèƒ½</li>
      <li>æ¤œç´¢ãƒ»ç½®æ›</li>
      <li>å®šå‹æ–‡æŒ¿å…¥</li>
      <li>çµ±è¨ˆæƒ…å ±è¡¨ç¤º</li>
    </ul>
  </div>

  <div class="modal" id="linkModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>ğŸ”— ãƒªãƒ³ã‚¯ç®¡ç†</h2>
        <button class="close-btn" onclick="document.getElementById('linkModal').style.display='none'">Ã—</button>
      </div>
      <div style="margin-bottom: 20px;">
        <label>è¡¨ç¤ºåˆ—æ•°: <input type="number" id="linkColumns" value="3" min="1" max="10"></label>
        <label style="margin-left: 20px;">ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³: 
          <select id="linkAnimation">
            <option value="none">ãªã—</option>
            <option value="hover">ãƒ›ãƒãƒ¼åŠ¹æœ</option>
            <option value="bounce">ãƒã‚¦ãƒ³ã‚¹</option>
            <option value="slideIn">ã‚¹ãƒ©ã‚¤ãƒ‰ã‚¤ãƒ³</option>
          </select>
        </label>
      </div>
      <table id="linkTable">
        <thead>
          <tr>
            <th>é †</th>
            <th>ãƒªãƒ³ã‚¯å</th>
            <th>URL</th>
            <th>è‰²</th>
            <th>ã‚¢ã‚¤ã‚³ãƒ³</th>
            <th>å‰Šé™¤</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <br>
      <button id="addNewLinkRow" class="btn-primary">+ æ–°è¦ãƒªãƒ³ã‚¯</button>
      <button id="importLinks">ğŸ“¥ ä¸€æ‹¬å–ã‚Šè¾¼ã¿</button>
      <button id="exportLinks">ğŸ“¤ ä¸€æ‹¬ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
      <button id="applyLinkChanges" class="btn-primary">é©ç”¨</button>
      <button id="cancelLinkChanges">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    </div>
  </div>

  <div class="modal" id="textModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>âœ¨ ã‚¹ã‚¿ã‚¤ãƒ«ä»˜ããƒ†ã‚­ã‚¹ãƒˆ</h2>
        <button class="close-btn" onclick="document.getElementById('textModal').style.display='none'">Ã—</button>
      </div>
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
        <div>
          <label>ãƒ†ã‚­ã‚¹ãƒˆ:</label>
          <textarea id="styledText" rows="4" placeholder="æŒ¿å…¥ã™ã‚‹ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›"></textarea>
          
          <label>ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚º:</label>
          <input type="range" id="fontSize" min="8" max="72" value="16">
          <span id="fontSizeValue">16px</span>
          
          <label>æ–‡å­—è‰²:</label>
          <input type="color" id="fontColor" value="#000000">
          
          <label>èƒŒæ™¯è‰²:</label>
          <input type="color" id="bgTextColor" value="#ffffff">
          
          <label>ãƒ•ã‚©ãƒ³ãƒˆ:</label>
          <select id="fontFamily">
            <option value="Arial, sans-serif">Arial</option>
            <option value="Times New Roman, serif">Times New Roman</option>
            <option value="Courier New, monospace">Courier New</option>
            <option value="Georgia, serif">Georgia</option>
            <option value="Verdana, sans-serif">Verdana</option>
            <option value="Comic Sans MS">Comic Sans MS</option>
            <option value="Impact, sans-serif">Impact</option>
          </select>
        </div>
        <div>
          <div style="margin-bottom: 10px;">
            <label><input type="checkbox" id="boldCheck"> å¤ªå­—</label>
            <label><input type="checkbox" id="italicCheck"> æ–œä½“</label>
            <label><input type="checkbox" id="underlineCheck"> ä¸‹ç·š</label>
          </div>
          
          <label>ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ:</label>
          <select id="textEffect">
            <option value="none">ãªã—</option>
            <option value="shadow">å½±</option>
            <option value="glow">å…‰å½©</option>
            <option value="gradient">ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³</option>
          </select>
          
          <label>ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³:</label>
          <select id="textAnimation">
            <option value="none">ãªã—</option>
            <option value="fadeIn">ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¤ãƒ³</option>
            <option value="slideIn">ã‚¹ãƒ©ã‚¤ãƒ‰ã‚¤ãƒ³</option>
            <option value="bounce">ãƒã‚¦ãƒ³ã‚¹</option>
          </select>
          
          <div class="preview-area" id="textPreview">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤ºã‚¨ãƒªã‚¢</div>
        </div>
      </div>
      <br>
      <button id="applyStyledText" class="btn-primary">æŒ¿å…¥</button>
      <button id="cancelStyledText">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    </div>
  </div>

  <div class="modal" id="snippetModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>ğŸ“„ å®šå‹æ–‡ç®¡ç†</h2>
        <button class="close-btn" onclick="document.getElementById('snippetModal').style.display='none'">Ã—</button>
      </div>
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
        <div>
          <h3>å®šå‹æ–‡ä¸€è¦§</h3>
          <div class="snippet-list" id="snippetList"></div>
          <button id="insertSnippetBtn" class="btn-primary">æŒ¿å…¥</button>
          <button id="deleteSnippetBtn" class="btn-danger">å‰Šé™¤</button>
        </div>
        <div>
          <h3>æ–°è¦ä½œæˆãƒ»ç·¨é›†</h3>
          <label>ã‚¿ã‚¤ãƒˆãƒ«:</label>
          <input type="text" id="snippetTitle" placeholder="å®šå‹æ–‡ã®ã‚¿ã‚¤ãƒˆãƒ«">
          <label>å†…å®¹:</label>
          <textarea id="snippetContent" rows="8" placeholder="å®šå‹æ–‡ã®å†…å®¹"></textarea>
          <button id="saveSnippetBtn" class="btn-primary">ä¿å­˜</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal" id="searchModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>ğŸ” æ¤œç´¢ãƒ»ç½®æ›</h2>
        <button class="close-btn" onclick="document.getElementById('searchModal').style.display='none'">Ã—</button>
      </div>
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
        <div>
          <label>æ¤œç´¢æ–‡å­—åˆ—:</label>
          <input type="text" id="searchText" placeholder="æ¤œç´¢ã™ã‚‹æ–‡å­—åˆ—">
          <label>ç½®æ›æ–‡å­—åˆ—:</label>
          <input type="text" id="replaceText" placeholder="ç½®æ›ã™ã‚‹æ–‡å­—åˆ—">
          <div>
            <label><input type="checkbox" id="caseSensitive"> å¤§æ–‡å­—å°æ–‡å­—åŒºåˆ¥</label>
            <label><input type="checkbox" id="wholeWords"> å®Œå…¨ä¸€è‡´</label>
            <label><input type="checkbox" id="useRegex"> æ­£è¦è¡¨ç¾</label>
          </div>
        </div>
        <div>
          <button id="findBtn" class="btn-primary">æ¤œç´¢</button>
          <button id="findAllBtn">ã™ã¹ã¦æ¤œç´¢</button>
          <button id="replaceBtn" class="btn-primary">ç½®æ›</button>
          <button id="replaceAllBtn" class="btn-danger">ã™ã¹ã¦ç½®æ›</button>
          <button id="clearHighlights">ãƒã‚¤ãƒ©ã‚¤ãƒˆæ¶ˆå»</button>
          <div id="searchStats" class="stats" style="margin-top: 10px;"></div>
        </div>
      </div>
    </div>
  </div>

  <div class="modal" id="statsModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>ğŸ“Š æ–‡æ›¸çµ±è¨ˆ</h2>
        <button class="close-btn" onclick="document.getElementById('statsModal').style.display='none'">Ã—</button>
      </div>
      <div id="statsContent"></div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <script>
    // --- ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•° ---
    let currentFileName = "document.html";
    let historyStack = [];
    let historyPointer = -1;
    let inputTimeout;
    let autoSaveTimeout;
    let draggedRow = null;
    let snippets = JSON.parse(localStorage.getItem('htmlEditorSnippets') || '[]');
    let selectedSnippetIndex = -1;
    let linkData = [];
    let highlightedElements = [];
    let searchIndex = 0;
    let previewWindow = null;
    
    const editor = document.getElementById("editor");
    const saveIndicator = document.getElementById("saveIndicator");
    const linkModal = document.getElementById("linkModal");
    const linkTableBody = document.querySelector("#linkTable tbody");
    const textModal = document.getElementById("textModal");
    const snippetModal = document.getElementById("snippetModal");
    const searchModal = document.getElementById("searchModal");
    const statsModal = document.getElementById("statsModal");

    // ã‚«ãƒ©ãƒ¼ãƒãƒƒãƒ”ãƒ³ã‚°ï¼ˆæ‹¡å¼µç‰ˆï¼‰
    const colorMap = {
      "èµ¤": "#ff4757", "é’": "#3742fa", "é»„": "#ffa502", "ç·‘": "#2ed573",
      "ç´«": "#a55eea", "æ°´è‰²": "#26d0ce", "é»„ç·‘": "#7bed9f", "é»’": "#2f3542",
      "ç°è‰²": "#747d8c", "ã‚ªãƒ¬ãƒ³ã‚¸": "#ff6348", "ãƒ”ãƒ³ã‚¯": "#ff3838", "èŒ¶è‰²": "#8b4513",
      "æ¿ƒé’": "#1e3799", "æ¿ƒç·‘": "#006266", "æ¿ƒç´«": "#4834d4", "é‡‘": "#ffd700"
    };

    const iconMap = {
      "ãªã—": "", "å®¶": "ğŸ ", "ãƒ¡ãƒ¼ãƒ«": "ğŸ“§", "é›»è©±": "ğŸ“", "åœ°å›³": "ğŸ—ºï¸",
      "æ¤œç´¢": "ğŸ”", "è¨­å®š": "âš™ï¸", "ãƒ˜ãƒ«ãƒ—": "â“", "ãƒ¦ãƒ¼ã‚¶ãƒ¼": "ğŸ‘¤", "ã‚«ãƒ¼ãƒˆ": "ğŸ›’",
      "ãƒãƒ¼ãƒˆ": "â¤ï¸", "æ˜Ÿ": "â­", "ãƒã‚§ãƒƒã‚¯": "âœ…", "è­¦å‘Š": "âš ï¸", "æƒ…å ±": "â„¹ï¸"
    };

    // --- å±¥æ­´ç®¡ç†ï¼ˆæ”¹è‰¯ç‰ˆï¼‰ ---
    function pushHistory() {
      const currentContent = editor.innerHTML;
      if (historyPointer >= 0 && historyStack[historyPointer] === currentContent) return;
      historyStack = historyStack.slice(0, historyPointer + 1);
      historyStack.push(currentContent);
      if (historyStack.length > 50) historyStack.shift();
      else historyPointer++;
      updateUndoRedoButtons();
    }

    function undo() {
      if (historyPointer > 0) {
        historyPointer--;
        editor.innerHTML = historyStack[historyPointer];
        updateUndoRedoButtons();
      }
    }

    function redo() {
      if (historyPointer < historyStack.length - 1) {
        historyPointer++;
        editor.innerHTML = historyStack[historyPointer];
        updateUndoRedoButtons();
      }
    }

    function updateUndoRedoButtons() {
      document.getElementById("undoBtn").disabled = historyPointer <= 0;
      document.getElementById("redoBtn").disabled = historyPointer >= historyStack.length - 1;
    }

    // --- è‡ªå‹•ä¿å­˜æ©Ÿèƒ½ ---
    function autoSave() {
      clearTimeout(autoSaveTimeout);
      autoSaveTimeout = setTimeout(() => {
        localStorage.setItem('autoSavedContent', editor.innerHTML);
        showSaveIndicator();
      }, 2000);
    }

    function showSaveIndicator() {
      saveIndicator.style.display = 'block';
      setTimeout(() => {
        saveIndicator.style.display = 'none';
      }, 2000);
    }

    // --- ãƒ•ã‚¡ã‚¤ãƒ«æ“ä½œï¼ˆæ”¹è‰¯ç‰ˆï¼‰ ---
    const fileInput = document.getElementById("fileInput");
    document.getElementById("selectFile").addEventListener("click", () => fileInput.click());
    
    fileInput.addEventListener("change", e => {
      const file = e.target.files[0];
      if (file) {
        currentFileName = file.name;
        const reader = new FileReader();
        reader.onload = evt => {
          let content = evt.target.result;
          
          if (file.name.endsWith('.md')) {
            content = convertMarkdownToHTML(content);
          } else if (file.name.endsWith('.txt')) {
            content = content.replace(/\n/g, '<br>');
          }
          
          editor.innerHTML = content;
          editor.focus();
          transformLinksToButtons();
          pushHistory();
        };
        reader.readAsText(file, 'UTF-8');
      }
    });

    document.getElementById("saveFile").addEventListener("click", () => {
      const content = `<!DOCTYPE html>\n<html lang="ja">\n<head>\n  <meta charset="UTF-8">\n  <title>${currentFileName}</title>\n</head>\n<body>\n${editor.innerHTML}\n</body>\n</html>`;
      downloadFile(content, currentFileName, 'text/html');
    });

    document.getElementById("exportFile").addEventListener("click", () => {
      const formats = ['HTML', 'ãƒ†ã‚­ã‚¹ãƒˆ', 'Markdown', 'PDF'];
      const format = prompt(`ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå½¢å¼ã‚’é¸æŠã—ã¦ãã ã•ã„:\n${formats.map((f,i) => `${i+1}. ${f}`).join('\n')}`);
      
      if (format && format >= 1 && format <= 4) {
        const selectedFormat = formats[format - 1];
        exportFile(selectedFormat);
      }
    });

    function exportFile(format) {
      let content, mimeType, extension;
      
      switch (format) {
        case 'HTML':
          content = `<!DOCTYPE html>\n<html lang="ja">\n<head>\n  <meta charset="UTF-8">\n  <title>${currentFileName}</title>\n</head>\n<body>\n${editor.innerHTML}\n</body>\n</html>`;
          mimeType = 'text/html';
          extension = 'html';
          downloadFile(content, `exported_document.${extension}`, mimeType);
          break;
        case 'ãƒ†ã‚­ã‚¹ãƒˆ':
          content = editor.innerText;
          mimeType = 'text/plain';
          extension = 'txt';
          downloadFile(content, `exported_document.${extension}`, mimeType);
          break;
        case 'Markdown':
          content = convertHTMLToMarkdown(editor.innerHTML);
          mimeType = 'text/markdown';
          extension = 'md';
          downloadFile(content, `exported_document.${extension}`, mimeType);
          break;
        case 'PDF':
          exportAsPdf();
          break;
        default:
          alert('ç„¡åŠ¹ãªå½¢å¼ã§ã™ã€‚');
          return;
      }
    }

    function downloadFile(content, filename, mimeType) {
      const blob = new Blob([content], { type: mimeType });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    }
    
    // Markdown/HTMLå¤‰æ›
    function convertMarkdownToHTML(markdown) {
        let html = markdown
            .replace(/^# (.*$)/gim, '<h1>$1</h1>')
            .replace(/^## (.*$)/gim, '<h2>$1</h2>')
            .replace(/^### (.*$)/gim, '<h3>$1</h3>')
            .replace(/^#### (.*$)/gim, '<h4>$1</h4>')
            .replace(/^##### (.*$)/gim, '<h5>$1</h5>')
            .replace(/^###### (.*$)/gim, '<h6>$1</h6>')
            .replace(/\*\*(.*)\*\*/gim, '<b>$1</b>')
            .replace(/__(.*)__/gim, '<b>$1</b>')
            .replace(/\*(.*)\*/gim, '<i>$1</i>')
            .replace(/_(.*)_/gim, '<i>$1</i>')
            .replace(/`([^`]+)`/gim, '<code>$1</code>')
            .replace(/\n\s*\n/g, '</p><p>');
        return `<p>${html}</p>`;
    }
    
    function convertHTMLToMarkdown(html) {
        let markdown = html
            .replace(/<h1>(.*?)<\/h1>/gim, '# $1\n')
            .replace(/<h2>(.*?)<\/h2>/gim, '## $1\n')
            .replace(/<h3>(.*?)<\/h3>/gim, '### $1\n')
            .replace(/<p>(.*?)<\/p>/gim, '$1\n\n')
            .replace(/<b>(.*?)<\/b>/gim, '**$1**')
            .replace(/<i>(.*?)<\/i>/gim, '*$1*')
            .replace(/<ul>/gim, '')
            .replace(/<\/ul>/gim, '')
            .replace(/<li>(.*?)<\/li>/gim, '* $1\n')
            .replace(/<br>/gim, '\n')
            .replace(/\n\n\n/g, '\n\n') // è¤‡æ•°è¡Œã®æ”¹è¡Œã‚’1ã¤ã«ã¾ã¨ã‚ã‚‹
            .trim();
        return markdown;
    }
    
    async function exportAsPdf() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        const content = editor.innerText;
        const lines = doc.splitTextToSize(content, 180);
        
        doc.setFontSize(12);
        doc.text(lines, 10, 10);
        
        doc.save(`${currentFileName.replace('.html', '')}.pdf`);
        alert('PDFã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¾ã—ãŸã€‚');
    }
    
    document.getElementById('importText').addEventListener('click', async () => {
        try {
            const text = await navigator.clipboard.readText();
            document.execCommand('insertText', false, text);
            pushHistory();
            alert('ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã‹ã‚‰ãƒ†ã‚­ã‚¹ãƒˆã‚’è²¼ã‚Šä»˜ã‘ã¾ã—ãŸã€‚');
        } catch (err) {
            alert('ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã‹ã‚‰ã®è²¼ã‚Šä»˜ã‘ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
        }
    });

    // --- ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š ---
    document.getElementById("undoBtn").addEventListener("click", undo);
    document.getElementById("redoBtn").addEventListener("click", redo);
    document.getElementById("clearAll").addEventListener("click", () => {
      if (confirm('æœ¬å½“ã«ã™ã¹ã¦æ¶ˆå»ã—ã¾ã™ã‹ï¼Ÿ')) {
        editor.innerHTML = "";
        pushHistory();
      }
    });
    
    document.getElementById('bgColorPicker').addEventListener('change', (e) => {
      editor.style.backgroundColor = e.target.value;
    });

    // åˆæœŸåŒ–å‡¦ç†
    window.addEventListener('load', () => {
      const saved = localStorage.getItem('autoSavedContent');
      if (saved) {
        editor.innerHTML = saved;
        transformLinksToButtons();
        pushHistory();
      }
    });
    editor.addEventListener("input", () => {
      clearTimeout(inputTimeout);
      inputTimeout = setTimeout(() => {
        pushHistory();
        autoSave();
      }, 500);
    });

    // --- ãƒªãƒ³ã‚¯ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« ---
    document.getElementById("editLinks").addEventListener("click", () => {
      linkData = [];
      const links = editor.querySelectorAll(".link-button");
      links.forEach(link => {
        linkData.push({
          name: link.textContent.trim(),
          url: link.href,
          color: link.style.backgroundColor,
          icon: link.textContent.replace(link.textContent.trim(), '').trim()
        });
      });
      renderLinkTable();
      linkModal.style.display = 'flex';
    });

    function renderLinkTable() {
      linkTableBody.innerHTML = '';
      linkData.forEach((link, index) => {
        const row = document.createElement('tr');
        row.setAttribute('draggable', 'true');
        row.dataset.index = index;
        row.innerHTML = `
          <td>${index + 1}</td>
          <td><input type="text" value="${link.name}"></td>
          <td><input type="url" value="${link.url}"></td>
          <td><input type="color" value="${link.color}"></td>
          <td>
            <select>
              ${Object.keys(iconMap).map(key => `<option value="${iconMap[key]}" ${iconMap[key] === link.icon ? 'selected' : ''}>${key}</option>`).join('')}
            </select>
          </td>
          <td><button class="btn-danger remove-link">å‰Šé™¤</button></td>
        `;
        linkTableBody.appendChild(row);
      });
      
      // ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã‚¤ãƒ™ãƒ³ãƒˆ
      const rows = linkTableBody.querySelectorAll('tr');
      rows.forEach(row => {
        row.addEventListener('dragstart', (e) => {
          draggedRow = e.target;
          setTimeout(() => draggedRow.classList.add('dragging'), 0);
        });
        row.addEventListener('dragend', () => {
          draggedRow.classList.remove('dragging');
          draggedRow = null;
        });
        row.addEventListener('dragover', (e) => {
          e.preventDefault();
          const targetRow = e.target.closest('tr');
          if (targetRow && targetRow !== draggedRow) {
            const bounding = targetRow.getBoundingClientRect();
            const offset = bounding.y + bounding.height / 2;
            if (e.clientY < offset) {
              linkTableBody.insertBefore(draggedRow, targetRow);
            } else {
              linkTableBody.insertBefore(draggedRow, targetRow.nextSibling);
            }
          }
        });
      });
      
      // å‰Šé™¤ãƒœã‚¿ãƒ³
      linkTableBody.querySelectorAll('.remove-link').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const row = e.target.closest('tr');
          const index = row.dataset.index;
          linkData.splice(index, 1);
          renderLinkTable();
        });
      });
    }

    document.getElementById("addNewLinkRow").addEventListener("click", () => {
      linkData.push({ name: 'æ–°è¦ãƒªãƒ³ã‚¯', url: '#', color: '#667eea', icon: '' });
      renderLinkTable();
    });
    
    document.getElementById("importLinks").addEventListener("click", () => {
        const json = prompt("ãƒªãƒ³ã‚¯ãƒ‡ãƒ¼ã‚¿ã‚’JSONå½¢å¼ã§è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ï¼š");
        if (json) {
            try {
                const importedData = JSON.parse(json);
                if (Array.isArray(importedData)) {
                    linkData = importedData;
                    renderLinkTable();
                } else {
                    alert('ç„¡åŠ¹ãªJSONå½¢å¼ã§ã™ã€‚é…åˆ—å½¢å¼ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                }
            } catch (e) {
                alert('JSONã®è§£æã«å¤±æ•—ã—ã¾ã—ãŸã€‚å½¢å¼ãŒæ­£ã—ã„ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
            }
        }
    });

    document.getElementById("exportLinks").addEventListener("click", () => {
        const json = JSON.stringify(linkData, null, 2);
        prompt("ä»¥ä¸‹ã®ãƒªãƒ³ã‚¯ãƒ‡ãƒ¼ã‚¿ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„ï¼š", json);
    });

    document.getElementById("applyLinkChanges").addEventListener("click", () => {
      const rows = linkTableBody.querySelectorAll('tr');
      const newLinkData = [];
      rows.forEach(row => {
        const name = row.querySelector('input[type="text"]').value;
        const url = row.querySelector('input[type="url"]').value;
        const color = row.querySelector('input[type="color"]').value;
        const icon = row.querySelector('select').value;
        newLinkData.push({ name, url, color, icon });
      });
      
      linkData = newLinkData;
      
      const linkColumns = document.getElementById("linkColumns").value;
      const linkAnimation = document.getElementById("linkAnimation").value;
      
      let html = `<div class="link-grid" style="grid-template-columns: repeat(${linkColumns}, 1fr);">`;
      linkData.forEach(link => {
        const icon = link.icon ? `${link.icon} ` : '';
        html += `<a href="${link.url}" class="link-button" style="background-color: ${link.color};" target="_blank">${icon}${link.name}</a>`;
      });
      html += `</div>`;
      
      editor.innerHTML += html;
      linkModal.style.display = 'none';
      transformLinksToButtons();
      pushHistory();
    });

    document.getElementById("cancelLinkChanges").addEventListener("click", () => {
      linkModal.style.display = 'none';
    });
    
    function transformLinksToButtons() {
        const linkRegex = /<a href="([^"]+)"(.*?)>(.*?)<\/a>/g;
        let originalContent = editor.innerHTML;
        const links = [];
        let match;
        while ((match = linkRegex.exec(originalContent)) !== null) {
            const href = match[1];
            const attributes = match[2];
            const text = match[3];
            links.push({ href, attributes, text });
        }

        links.forEach(({ href, attributes, text }) => {
            const isStyled = attributes.includes('class="link-button"');
            if (!isStyled) {
                // ã“ã“ã§å¤‰æ›ãƒ­ã‚¸ãƒƒã‚¯ã‚’å®Ÿè£…
                // ç°¡å˜ãªä¾‹ã¨ã—ã¦ã€classã‚’è¿½åŠ ã™ã‚‹
                const newLink = `<a href="${href}"${attributes} class="link-button simple-button">${text}</a>`;
                originalContent = originalContent.replace(match[0], newLink);
            }
        });

        // HTMLã‚’ç›´æ¥æ›¸ãæ›ãˆã‚‹ã¨ã‚«ãƒ¼ã‚½ãƒ«ãŒæ¶ˆãˆã‚‹ãŸã‚ã€æ…é‡ã«è¡Œã†
    }
    
    // --- ã‚¹ã‚¿ã‚¤ãƒ«ä»˜ããƒ†ã‚­ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ€ãƒ« ---
    document.getElementById("insertStyledText").addEventListener("click", () => {
        document.getElementById("styledText").value = getSelectionText();
        updateTextPreview();
        textModal.style.display = 'flex';
    });
    
    document.getElementById("styledText").addEventListener("input", updateTextPreview);
    document.getElementById("fontSize").addEventListener("input", updateTextPreview);
    document.getElementById("fontColor").addEventListener("input", updateTextPreview);
    document.getElementById("bgTextColor").addEventListener("input", updateTextPreview);
    document.getElementById("fontFamily").addEventListener("change", updateTextPreview);
    document.getElementById("boldCheck").addEventListener("change", updateTextPreview);
    document.getElementById("italicCheck").addEventListener("change", updateTextPreview);
    document.getElementById("underlineCheck").addEventListener("change", updateTextPreview);
    document.getElementById("textEffect").addEventListener("change", updateTextPreview);
    document.getElementById("textAnimation").addEventListener("change", updateTextPreview);
    
    function updateTextPreview() {
        const text = document.getElementById("styledText").value || 'ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤ºã‚¨ãƒªã‚¢';
        const fontSize = document.getElementById("fontSize").value;
        const fontColor = document.getElementById("fontColor").value;
        const bgTextColor = document.getElementById("bgTextColor").value;
        const fontFamily = document.getElementById("fontFamily").value;
        const bold = document.getElementById("boldCheck").checked;
        const italic = document.getElementById("italicCheck").checked;
        const underline = document.getElementById("underlineCheck").checked;
        const effect = document.getElementById("textEffect").value;
        const animation = document.getElementById("textAnimation").value;
        const preview = document.getElementById("textPreview");
        
        document.getElementById("fontSizeValue").textContent = `${fontSize}px`;
        
        let style = `font-size: ${fontSize}px; color: ${fontColor}; background-color: ${bgTextColor}; font-family: ${fontFamily};`;
        if (bold) style += 'font-weight: bold;';
        if (italic) style += 'font-style: italic;';
        if (underline) style += 'text-decoration: underline;';
        
        let classes = '';
        if (animation !== 'none') classes += ` ${animation}`;
        if (effect === 'shadow') style += 'text-shadow: 2px 2px 4px rgba(0,0,0,0.5);';
        if (effect === 'glow') style += 'text-shadow: 0 0 10px #fff, 0 0 20px #fff, 0 0 30px #fff;';
        if (effect === 'gradient') style += `background-image: linear-gradient(to right, #667eea, #764ba2); color: transparent; -webkit-background-clip: text;`;
        
        preview.innerHTML = `<span style="${style}" class="${classes}">${text}</span>`;
    }
    
    document.getElementById("applyStyledText").addEventListener("click", () => {
        const text = document.getElementById("styledText").value;
        const fontSize = document.getElementById("fontSize").value;
        const fontColor = document.getElementById("fontColor").value;
        const bgTextColor = document.getElementById("bgTextColor").value;
        const fontFamily = document.getElementById("fontFamily").value;
        const bold = document.getElementById("boldCheck").checked;
        const italic = document.getElementById("italicCheck").checked;
        const underline = document.getElementById("underlineCheck").checked;
        const effect = document.getElementById("textEffect").value;
        const animation = document.getElementById("textAnimation").value;
        
        let style = `font-size: ${fontSize}px; color: ${fontColor}; background-color: ${bgTextColor}; font-family: '${fontFamily}';`;
        if (bold) style += 'font-weight: bold;';
        if (italic) style += 'font-style: italic;';
        if (underline) style += 'text-decoration: underline;';
        
        let classes = '';
        if (animation !== 'none') classes += ` ${animation}`;
        if (effect === 'shadow') style += 'text-shadow: 2px 2px 4px rgba(0,0,0,0.5);';
        if (effect === 'glow') style += 'text-shadow: 0 0 10px #fff, 0 0 20px #fff, 0 0 30px #fff;';
        if (effect === 'gradient') style += `background-image: linear-gradient(to right, #667eea, #764ba2); color: transparent; -webkit-background-clip: text;`;

        const newHtml = `<span style="${style}" class="${classes}">${text}</span>`;
        document.execCommand('insertHTML', false, newHtml);
        textModal.style.display = 'none';
        pushHistory();
    });

    document.getElementById("cancelStyledText").addEventListener("click", () => {
      textModal.style.display = 'none';
    });
    
    function getSelectionText() {
        const selection = window.getSelection();
        return selection.toString();
    }
    
    // --- ç›®æ¬¡ç”Ÿæˆ ---
    document.getElementById('generateTOC').addEventListener('click', () => {
        const headings = editor.querySelectorAll('h1, h2, h3, h4, h5, h6');
        if (headings.length === 0) {
            alert('ç›®æ¬¡ã‚’ç”Ÿæˆã™ã‚‹ãŸã‚ã«ã¯ã€è¦‹å‡ºã—ï¼ˆh1, h2ãªã©ï¼‰ãŒå¿…è¦ã§ã™ã€‚');
            return;
        }

        let tocHtml = '<h2>ç›®æ¬¡</h2><ul>';
        headings.forEach((heading, index) => {
            const id = `toc-heading-${index}`;
            heading.setAttribute('id', id);
            const indent = (parseInt(heading.tagName.substring(1)) - 1) * 20; // h1ã¯0px, h2ã¯20pxãªã©
            tocHtml += `<li style="margin-left: ${indent}px;"><a href="#${id}">${heading.textContent}</a></li>`;
        });
        tocHtml += '</ul>';

        document.execCommand('insertHTML', false, tocHtml);
        pushHistory();
    });
    
    // --- ã‚·ãƒ³ãƒ—ãƒ«åŒ– ---
    document.getElementById('makeSimple').addEventListener('click', () => {
        let cleanHtml = editor.innerHTML
            .replace(/ style=".*?"/g, '')
            .replace(/ class=".*?"/g, '')
            .replace(/<span.*?>|<\/span>/g, '')
            .replace(/<div.*?>|<\/div>/g, '');
        
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = cleanHtml;
        const links = tempDiv.querySelectorAll('a');
        links.forEach(link => {
            link.className = 'link-button simple-button';
        });
        
        editor.innerHTML = tempDiv.innerHTML;
        pushHistory();
        alert('ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’ã‚·ãƒ³ãƒ—ãƒ«åŒ–ã—ã¾ã—ãŸã€‚');
    });

    // --- å®šå‹æ–‡ãƒ¢ãƒ¼ãƒ€ãƒ« ---
    document.getElementById("insertSnippet").addEventListener("click", () => {
        renderSnippetList();
        snippetModal.style.display = 'flex';
    });
    
    function renderSnippetList() {
        const list = document.getElementById('snippetList');
        list.innerHTML = '';
        snippets.forEach((snippet, index) => {
            const item = document.createElement('div');
            item.className = 'snippet-item';
            item.textContent = snippet.title;
            item.dataset.index = index;
            item.addEventListener('click', () => {
                selectSnippet(index);
            });
            list.appendChild(item);
        });
    }
    
    function selectSnippet(index) {
        const allItems = document.querySelectorAll('.snippet-item');
        allItems.forEach(item => item.style.backgroundColor = '');
        allItems[index].style.backgroundColor = '#ddd';
        
        selectedSnippetIndex = index;
        document.getElementById('snippetTitle').value = snippets[index].title;
        document.getElementById('snippetContent').value = snippets[index].content;
    }
    
    document.getElementById('saveSnippetBtn').addEventListener('click', () => {
        const title = document.getElementById('snippetTitle').value;
        const content = document.getElementById('snippetContent').value;
        if (!title || !content) {
            alert('ã‚¿ã‚¤ãƒˆãƒ«ã¨å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
            return;
        }
        
        if (selectedSnippetIndex >= 0) {
            snippets[selectedSnippetIndex] = { title, content };
        } else {
            snippets.push({ title, content });
        }
        localStorage.setItem('htmlEditorSnippets', JSON.stringify(snippets));
        renderSnippetList();
        document.getElementById('snippetTitle').value = '';
        document.getElementById('snippetContent').value = '';
        selectedSnippetIndex = -1;
        alert('å®šå‹æ–‡ã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚');
    });
    
    document.getElementById('insertSnippetBtn').addEventListener('click', () => {
        if (selectedSnippetIndex >= 0) {
            document.execCommand('insertHTML', false, snippets[selectedSnippetIndex].content);
            snippetModal.style.display = 'none';
            pushHistory();
        } else {
            alert('æŒ¿å…¥ã™ã‚‹å®šå‹æ–‡ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
        }
    });
    
    document.getElementById('deleteSnippetBtn').addEventListener('click', () => {
        if (selectedSnippetIndex >= 0) {
            if (confirm('æœ¬å½“ã«ã“ã®å®šå‹æ–‡ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                snippets.splice(selectedSnippetIndex, 1);
                localStorage.setItem('htmlEditorSnippets', JSON.stringify(snippets));
                renderSnippetList();
                document.getElementById('snippetTitle').value = '';
                document.getElementById('snippetContent').value = '';
                selectedSnippetIndex = -1;
                alert('å®šå‹æ–‡ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚');
            }
        } else {
            alert('å‰Šé™¤ã™ã‚‹å®šå‹æ–‡ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
        }
    });

    // --- æ¤œç´¢ãƒ»ç½®æ›ãƒ¢ãƒ¼ãƒ€ãƒ« ---
    document.getElementById('searchReplace').addEventListener('click', () => {
        searchModal.style.display = 'flex';
    });
    
    document.getElementById('findBtn').addEventListener('click', findNext);
    document.getElementById('findAllBtn').addEventListener('click', findAll);
    document.getElementById('replaceBtn').addEventListener('click', replace);
    document.getElementById('replaceAllBtn').addEventListener('click', replaceAll);
    document.getElementById('clearHighlights').addEventListener('click', clearHighlights);
    
    function findNext() {
        const searchText = document.getElementById('searchText').value;
        if (!searchText) return;
        
        clearHighlights();
        
        const content = editor.textContent;
        let flags = 'g';
        if (!document.getElementById('caseSensitive').checked) flags += 'i';
        
        const regex = new RegExp(searchText, flags);
        const matches = [...content.matchAll(regex)];
        
        if (matches.length === 0) {
            alert('ä¸€è‡´ã™ã‚‹æ–‡å­—åˆ—ã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚');
            return;
        }
        
        searchIndex = (searchIndex + 1) % matches.length;
        const match = matches[searchIndex];
        
        highlightText(match.index, match[0].length);
        document.getElementById('searchStats').textContent = `æ¤œç´¢çµæœ: ${matches.length}ä»¶ (ç¾åœ¨ ${searchIndex + 1}ä»¶ç›®)`;
    }
    
    function findAll() {
        const searchText = document.getElementById('searchText').value;
        if (!searchText) return;
        
        clearHighlights();
        
        const content = editor.textContent;
        let flags = 'g';
        if (!document.getElementById('caseSensitive').checked) flags += 'i';
        
        const regex = new RegExp(searchText, flags);
        const matches = [...content.matchAll(regex)];
        
        if (matches.length === 0) {
            alert('ä¸€è‡´ã™ã‚‹æ–‡å­—åˆ—ã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚');
            return;
        }
        
        matches.forEach(match => {
            highlightText(match.index, match[0].length);
        });
        document.getElementById('searchStats').textContent = `æ¤œç´¢çµæœ: ${matches.length}ä»¶`;
    }
    
    function replace() {
        const searchText = document.getElementById('searchText').value;
        const replaceText = document.getElementById('replaceText').value;
        if (!searchText || highlightedElements.length === 0) {
            alert('ç½®æ›ã™ã‚‹æ–‡å­—åˆ—ã‚’é¸æŠã™ã‚‹ã‹ã€æ¤œç´¢ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚');
            return;
        }
        
        const targetElement = highlightedElements[searchIndex];
        if (targetElement) {
            targetElement.outerHTML = targetElement.textContent.replace(new RegExp(searchText, 'i'), replaceText);
        }
        clearHighlights();
        pushHistory();
    }
    
    function replaceAll() {
        const searchText = document.getElementById('searchText').value;
        const replaceText = document.getElementById('replaceText').value;
        if (!searchText) return;
        
        let flags = 'g';
        if (!document.getElementById('caseSensitive').checked) flags += 'i';
        
        let html = editor.innerHTML;
        html = html.replace(new RegExp(searchText, flags), replaceText);
        editor.innerHTML = html;
        clearHighlights();
        pushHistory();
        alert('ã™ã¹ã¦ã®æ–‡å­—åˆ—ã‚’ç½®æ›ã—ã¾ã—ãŸã€‚');
    }
    
    function clearHighlights() {
        highlightedElements.forEach(el => {
            const parent = el.parentNode;
            parent.replaceChild(document.createTextNode(el.textContent), el);
            parent.normalize();
        });
        highlightedElements = [];
        searchIndex = 0;
        document.getElementById('searchStats').textContent = '';
    }
    
    function highlightText(startIndex, length) {
        const textNode = findTextNode(editor, startIndex);
        if (textNode) {
            const range = document.createRange();
            range.setStart(textNode, startIndex - findTextOffset(textNode));
            range.setEnd(textNode, startIndex - findTextOffset(textNode) + length);
            
            const span = document.createElement('span');
            span.className = 'highlight';
            range.surroundContents(span);
            highlightedElements.push(span);
        }
    }
    
    function findTextNode(element, targetIndex) {
        let offset = 0;
        const walker = document.createTreeWalker(element, NodeFilter.SHOW_TEXT);
        let node;
        
        while (node = walker.nextNode()) {
            const nodeLength = node.textContent.length;
            if (offset + nodeLength > targetIndex) {
                return node;
            }
            offset += nodeLength;
        }
        return null;
    }
    
    function findTextOffset(node) {
        let offset = 0;
        let prev = node.previousSibling;
        while (prev) {
            offset += prev.textContent.length;
            prev = prev.previousSibling;
        }
        return offset;
    }

    // --- çµ±è¨ˆæƒ…å ±ãƒ¢ãƒ¼ãƒ€ãƒ« ---
    document.getElementById('wordCount').addEventListener('click', () => {
        const content = editor.innerText;
        const wordCount = content.split(/\s+/).filter(word => word.length > 0).length;
        const charCount = content.length;
        const lineCount = content.split('\n').length;
        const htmlTagCount = (editor.innerHTML.match(/<[^>]+>/g) || []).length;
        
        const statsContent = `
            <p><strong>æ–‡å­—æ•°:</strong> ${charCount}</p>
            <p><strong>å˜èªæ•°:</strong> ${wordCount}</p>
            <p><strong>è¡Œæ•°:</strong> ${lineCount}</p>
            <p><strong>HTMLã‚¿ã‚°æ•°:</strong> ${htmlTagCount}</p>
        `;
        
        document.getElementById('statsContent').innerHTML = statsContent;
        statsModal.style.display = 'flex';
    });
    
    // --- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ©Ÿèƒ½ ---
    document.getElementById('togglePreview').addEventListener('click', () => {
        if (!previewWindow || previewWindow.closed) {
            previewWindow = window.open('', 'PreviewWindow', 'width=800,height=600');
        }
        updatePreview();
    });

    function updatePreview() {
        if (previewWindow && !previewWindow.closed) {
            const content = editor.innerHTML;
            const previewHtml = `
                <!DOCTYPE html>
                <html lang="ja">
                <head>
                    <meta charset="UTF-8">
                    <title>ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</title>
                    <style>${document.querySelector('style').textContent}</style>
                </head>
                <body>
                    <div id="preview-content" style="margin: 20px; padding: 20px; background: white; border-radius: 10px;">
                        ${content}
                    </div>
                </body>
                </html>
            `;
            previewWindow.document.open();
            previewWindow.document.write(previewHtml);
            previewWindow.document.close();
        }
    }
    
    editor.addEventListener("input", () => {
        updatePreview();
    });
    
    // --- å…¨ç”»é¢è¡¨ç¤º ---
    document.getElementById('fullscreen').addEventListener('click', () => {
        if (document.fullscreenElement) {
            document.exitFullscreen();
        } else {
            document.documentElement.requestFullscreen();
        }
    });

  </script>
</body>
</html>
