<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>レシピ分量計算アプリ</title>
    <style>
        /* --- ビューポート対応 --- */
        :root {
            --vh: 1vh;
            --base-font: 15px;
        }
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden; /* ページ全体のスクロールは無効化 */
            -webkit-text-size-adjust: 100%;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            font-size: var(--base-font);
            -webkit-tap-highlight-color: transparent;
        }

        /* --- 全体レイアウト --- */
        body {
            font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f4f7f9;
            color: #333;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: calc(var(--vh) * 100);
            box-sizing: border-box;
        }

        /* 固定配置してリフローによる揺れを抑制 */
        .app-container {
            position: relative;
            display: flex;
            width: 94%;
            max-width: 1200px;
            height: calc(var(--vh) * 100);
            background-color: #fff;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            border-radius: 8px;
            overflow: hidden;
            transform-origin: top center;
            /* 軽く縮小して余裕を持たせる */
            transform: scale(0.95);
        }

        /* --- 左右分割 --- */
        #recipeListContainer {
            width: 300px;
            min-width: 220px;
            border-right: 1px solid #eee;
            background-color: #ecf0f1;
            padding: 12px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            gap: 8px;
            /* 内部スクロール（外部ページはスクロールしない） */
            overflow: auto;
            -webkit-overflow-scrolling: touch;
        }

        #recipeFormContainer {
            flex: 1;
            padding: 12px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            gap: 10px;
            overflow: auto;
            -webkit-overflow-scrolling: touch;
        }

        /* --- ヘッダとリスト --- */
        .list-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 6px;
            border-bottom: 1px solid #ddd;
        }

        #recipeList {
            list-style: none;
            padding: 0;
            margin: 0;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        #recipeList li {
            padding: 8px 10px;
            cursor: pointer;
            transition: background-color 0.15s;
            border-bottom: 1px dotted #ddd;
            user-select: none;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-size: 0.95rem;
        }
        #recipeList li:hover { background-color: #e9eef1; }
        #recipeList li.selected { background-color: #3498db; color: #fff; font-weight: 700; }

        /* --- 共通フォーム部品 --- */
        .form-section {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 6px;
            background-color: #fafafa;
            box-sizing: border-box;
        }
        label { display: block; margin-bottom: 6px; font-weight: 600; color:#2c3e50; font-size:0.95rem; }
        input[type="text"], input[type="number"], .ingredient-item input {
            padding: 6px 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 0.92rem;
            box-sizing: border-box;
        }

        button {
            padding: 8px 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 0.92rem;
            transition: background-color 0.12s;
        }
        .primary { background:#2ecc71; color:#fff; }
        .primary:hover { background:#27ae60; }
        .secondary { background:#3498db; color:#fff; }
        .secondary:hover { background:#2980b9; }
        .danger { background:#e74c3c; color:#fff; padding:6px 8px; }
        .danger:hover { background:#c0392b; }

        .control-group { display:flex; gap:8px; flex-wrap:wrap; }
        .io-controls { display:flex; gap:8px; flex-wrap:wrap; }

        /* --- 材料リスト（1行配置） --- */
        #ingredientsList { list-style:none; padding:0; margin:0; display:flex; flex-direction:column; gap:6px; }
        .ingredient-item {
            display:flex;
            align-items:center;
            gap:8px;
            padding:6px 4px;
            border-bottom:1px dashed #eee;
            box-sizing:border-box;
            flex-wrap:nowrap; /* 1行を維持 */
            min-height:36px;
        }
        .ingredient-item input[type="radio"] { flex:0 0 auto; transform:scale(1.05); margin-right:6px; }
        .ingredient-item .name-input { flex:2 1 50%; min-width:0; font-size:0.92rem; }
        .ingredient-item .amount-input { flex:1 0 18%; min-width:0; text-align:right; font-size:0.92rem; }
        .ingredient-item .unit-label { flex:0 0 auto; margin-left:6px; white-space:nowrap; font-size:0.92rem; }
        .ingredient-item .ratio-display { flex:0 0 70px; text-align:right; font-size:0.88rem; color:#7f8c8d; white-space:nowrap; }
        .ingredient-item .danger { margin-left:6px; padding:6px 8px; font-size:0.9rem; }

        .ingredients-header { display:flex; justify-content:flex-end; padding-right:6px; margin-bottom:6px; }

        /* --- スケール/合計 --- */
        .scale-control, .total-control { display:flex; align-items:center; gap:8px; flex-wrap:nowrap; }
        .scale-control input[type="number"], .total-control input[type="number"] { width:84px; padding:6px; font-size:0.92rem; }
        .total-display { font-size:1.05rem; font-weight:700; color:#2980b9; }

        /* --- モバイル特定の改善（揺れ対策） --- */
        /* overscroll-behavior でバウンスや親スクロールへの影響を抑える */
        #recipeListContainer, #recipeFormContainer, #ingredientsList {
            overscroll-behavior: contain;
            -webkit-overflow-scrolling: touch;
        }

        /* ボタンやテキストの縮尺を控えめにして揺れを減らす */
        @media (max-width: 768px) {
            .app-container { width:100%; height:calc(var(--vh) * 100); border-radius:0; transform:scale(0.98); }
            #recipeListContainer, #recipeFormContainer { padding:8px; }
            #recipeListContainer { width:100%; border-right:none; border-bottom:1px solid #eee; height:40vh; }
            .app-container.form-visible #recipeListContainer { display:none; }
            .app-container.form-visible #recipeFormContainer { display:flex; height:calc(var(--vh) * 100); }

            #recipeFormContainer { height:calc(var(--vh) * 60); }

            /* 縦画面で1行配置を優先 */
            .ingredient-item { min-height:36px; }
            .ingredient-item .name-input { font-size:0.9rem; }
            .ingredient-item .amount-input { font-size:0.9rem; }
            .ingredient-item .ratio-display { flex:0 0 60px; font-size:0.85rem; }
            .list-header h2 { font-size:1.05rem; margin:0; }
        }

        /* 高さが極端に小さくなる端末向けに余白を調整（揺れを減らす） */
        @media (max-height: 640px) {
            .app-container { transform:scale(0.92); }
            .ingredient-item { padding:4px 4px; }
            .form-section { padding:6px; }
            button { padding:6px 8px; font-size:0.9rem; }
        }

        /* 視覚のちらつきやリフローを減らすための定義 */
        * { backface-visibility: hidden; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; }
    </style>
</head>
<body>
    <div class="app-container">
        <div id="recipeListContainer">
            <div class="list-header">
                <h2 style="margin:0;">レシピ一覧</h2>
                <button id="newRecipeBtn" class="primary">📝 新規作成</button>
            </div>
            <ul id="recipeList"></ul>
        </div>

        <div id="recipeFormContainer">
            <div class="mobile-controls" style="display:none;">
                <button id="backToListBtn" class="secondary">◀️ 一覧に戻る</button>
                <button id="fullscreenBtn" class="secondary">🌐 全画面</button>
            </div>

            <div class="form-section">
                <label for="recipeName">レシピ名</label>
                <input type="text" id="recipeName" placeholder="例: 肉じゃが" required />
            </div>

            <div class="form-section">
                <h3 style="margin:6px 0 8px 0; font-size:1rem;">材料と分量</h3>
                <div class="unit-radio-group" style="display:flex; gap:10px; align-items:center; margin-bottom:6px;">
                    <input type="radio" id="unitG" name="unit" value="g" checked />
                    <label for="unitG">グラム (g)</label>
                    <input type="radio" id="unitKg" name="unit" value="kg" />
                    <label for="unitKg">キログラム (kg)</label>
                </div>

                <div class="ingredients-header">
                    <button id="addIngredient" class="secondary">➕ 材料追加</button>
                </div>

                <ul id="ingredientsList"></ul>
            </div>

            <div class="form-section">
                <h3 style="margin:6px 0 8px 0; font-size:1rem;">分量計算 (基準材料から)</h3>
                <div class="scale-control">
                    <label style="margin-right:4px;">基準量:</label>
                    <input type="number" id="scaleAmount" min="0" placeholder="0" />
                    <span id="scaleUnit">g</span>
                    <button onclick="calculateFromSingleIngredient()" class="secondary">🔄 基準量から計算</button>
                </div>
                <p style="font-size:0.82rem; color:#7f8c8d; margin-top:6px;">※材料横のラジオボタンで基準材料を選択してから、基準量を入力・計算してください。</p>
            </div>

            <div class="form-section">
                <h3 style="margin:6px 0 8px 0; font-size:1rem;">分量計算 (合計量から)</h3>
                <div class="total-control">
                    <label style="margin-right:4px;">現在の合計:</label>
                    <span class="total-display"><span id="totalAmountValue">0</span><span id="totalAmountUnit">g</span></span>
                </div>
                <div class="total-control" style="margin-top:8px;">
                    <label style="margin-right:4px;">目標合計量:</label>
                    <input type="number" id="desiredTotalAmount" min="0" placeholder="0" />
                    <span id="totalUnitLabel">g</span>
                    <button id="scaleFromTotalBtn" class="secondary">🎯 合計量から計算</button>
                </div>
                <p style="font-size:0.82rem; color:#7f8c8d; margin-top:6px;">※目標合計量を入力し、ボタンを押すと全材料の分量が調整されます。</p>
            </div>

            <div class="control-group">
                <button id="saveBtn" class="primary">💾 保存</button>
                <button id="updateBtn" class="primary" style="display:none;">✔️ 更新</button>
                <button id="deleteBtn" class="danger" style="display:none;">🗑️ 削除</button>
            </div>

            <div class="io-controls">
                <button id="exportBtn" class="secondary">📤 エクスポート</button>
                <button id="importBtn" class="secondary">📥 インポート</button>
                <input type="file" id="importFile" accept=".json" style="display:none;" />
            </div>
        </div>
    </div>

    <script>
    // --- ビューポート高さの正確化（address bar 対応） ---
    (function() {
        function setVh() {
            document.documentElement.style.setProperty('--vh', (window.innerHeight * 0.01) + 'px');
        }
        setVh();
        window.addEventListener('resize', setVh);
        window.addEventListener('orientationchange', function() { setTimeout(setVh, 200); });
    })();

    // --- グローバル変数とDOM参照（機能は変更しない） ---
    const RECIPES_STORAGE_KEY = 'recipesv1all_improved';
    let recipes = [];
    let currentRecipeId = null;
    let currentUnit = 'g';

    const appContainer = document.querySelector('.app-container');
    const recipeListEl = document.getElementById('recipeList');
    const newRecipeBtn = document.getElementById('newRecipeBtn');
    const recipeNameEl = document.getElementById('recipeName');
    const ingredientsListEl = document.getElementById('ingredientsList');
    const addIngredientBtn = document.getElementById('addIngredient');
    const saveBtn = document.getElementById('saveBtn');
    const updateBtn = document.getElementById('updateBtn');
    const deleteBtn = document.getElementById('deleteBtn');
    const scaleAmountEl = document.getElementById('scaleAmount');
    const scaleUnitEl = document.getElementById('scaleUnit');
    const unitGRadio = document.getElementById('unitG');
    const unitKgRadio = document.getElementById('unitKg');
    const exportBtn = document.getElementById('exportBtn');
    const importBtn = document.getElementById('importBtn');
    const importFileEl = document.getElementById('importFile');
    const totalAmountValueEl = document.getElementById('totalAmountValue');
    const totalAmountUnitEl = document.getElementById('totalAmountUnit');
    const desiredTotalAmountEl = document.getElementById('desiredTotalAmount');
    const scaleFromTotalBtn = document.getElementById('scaleFromTotalBtn');
    const fullscreenBtn = document.getElementById('fullscreenBtn');
    const backToListBtn = document.getElementById('backToListBtn');
    const totalUnitLabelEl = document.getElementById('totalUnitLabel');

    // --- 初期化 ---
    document.addEventListener('DOMContentLoaded', () => {
        loadRecipes();
        renderRecipeList();
        setupEventListeners();
        clearForm();
        if (window.innerWidth <= 768) showListView();
    });

    // --- イベントリスナー ---
    function setupEventListeners() {
        recipeListEl.addEventListener('click', e => {
            if (e.target.tagName === 'LI' && e.target.dataset.id) selectRecipe(e.target.dataset.id);
        });
        newRecipeBtn.addEventListener('click', () => { clearForm(); showFormView(); });

        addIngredientBtn.addEventListener('click', () => addIngredientRow({ name: '', amount: 0 }, true));

        saveBtn.addEventListener('click', saveRecipe);
        updateBtn.addEventListener('click', updateRecipe);
        deleteBtn.addEventListener('click', deleteRecipe);
        unitGRadio.addEventListener('change', () => setUnit('g'));
        unitKgRadio.addEventListener('change', () => setUnit('kg'));
        scaleAmountEl.addEventListener('input', calculateFromSingleIngredient);
        scaleFromTotalBtn.addEventListener('click', scaleFromTotal);
        fullscreenBtn && fullscreenBtn.addEventListener('click', toggleFullscreen);
        backToListBtn && backToListBtn.addEventListener('click', showListView);

        ingredientsListEl.addEventListener('input', e => {
            const item = e.target.closest('.ingredient-item');
            if (!item) return;
            if (e.target.classList.contains('amount-input')) {
                const amountValue = parseFloat(e.target.value) || 0;
                const multiplier = currentUnit === 'kg' ? 1000 : 1;
                item.dataset.amountInG = amountValue * multiplier;
                updateTotalsAndRatios();
            }
        });

        ingredientsListEl.addEventListener('click', e => {
            if (e.target.type === 'radio' && e.target.name === 'baseIngredient') {
                const item = e.target.closest('.ingredient-item');
                if (item) {
                    const amountInG = parseFloat(item.dataset.amountInG || '0');
                    const divider = currentUnit === 'kg' ? 1000 : 1;
                    scaleAmountEl.value = (amountInG / divider).toFixed(divider === 1000 ? 3 : 0);
                    scaleAmountEl.focus();
                    calculateFromSingleIngredient();
                }
            }
        });

        exportBtn.addEventListener('click', exportRecipes);
        importBtn.addEventListener('click', () => importFileEl.click());
        importFileEl.addEventListener('change', importRecipes);

        // リストやフォームの内容変更で高さが変わる場合、レイアウトの揺れを抑える処理を最小化
        // ここでは必要最小限の再描画だけ行う（強制的な scale 操作は行わない）
        const observer = new MutationObserver(() => {
            // 変更が多発すると揺れの原因になるため、何もしない（必要時だけ軽く update）
            // （重要）: 揺れの原因だった頻繁な scale/resize をここで行わない
        });
        observer.observe(appContainer, { childList: true, subtree: true, attributes: true, characterData: true });
    }

    // --- 表示切替（モバイル） ---
    function showFormView() { appContainer.classList.add('form-visible'); document.body.scrollTop = 0; }
    function showListView() { appContainer.classList.remove('form-visible'); document.body.scrollTop = 0; }

    // --- レシピデータ管理 ---
    function loadRecipes() {
        try {
            const stored = localStorage.getItem(RECIPES_STORAGE_KEY);
            recipes = stored ? JSON.parse(stored) : generateSampleRecipes();
        } catch (e) {
            console.error('load error', e);
            recipes = generateSampleRecipes();
        }
        saveRecipesToStorage();
    }
    function saveRecipesToStorage() { localStorage.setItem(RECIPES_STORAGE_KEY, JSON.stringify(recipes)); }

    // --- レンダリング ---
    function renderRecipeList() {
        recipeListEl.innerHTML = '';
        if (!recipes || recipes.length === 0) {
            const li = document.createElement('li');
            li.textContent = 'レシピがありません。新規作成してください。';
            li.style.color = '#7f8c8d';
            li.style.cursor = 'default';
            recipeListEl.appendChild(li);
            return;
        }
        recipes.sort((a,b) => a.name.localeCompare(b.name, 'ja')).forEach(r => {
            const li = document.createElement('li');
            li.textContent = r.name;
            li.dataset.id = r.id;
            if (r.id === currentRecipeId) li.classList.add('selected');
            recipeListEl.appendChild(li);
        });
    }

    function renderRecipeForm(recipe) {
        currentRecipeId = recipe.id;
        recipeNameEl.value = recipe.name;
        ingredientsListEl.innerHTML = '';
        recipe.ingredients.forEach(ing => addIngredientRow(ing));
        scaleAmountEl.value = '';
        desiredTotalAmountEl.value = '';
        updateFormState('edit');
        setUnit(currentUnit);
    }

    // --- 材料行追加（1行配置を維持） ---
    function addIngredientRow(ingredient = { name:'', amount:0 }, focusAfterAdd = false) {
        const li = document.createElement('li');
        li.className = 'ingredient-item';
        li.dataset.amountInG = ingredient.amount || '0';

        const radio = document.createElement('input');
        radio.type = 'radio';
        radio.name = 'baseIngredient';
        radio.title = '基準にする';

        const nameInput = document.createElement('input');
        nameInput.type = 'text';
        nameInput.className = 'name-input';
        nameInput.placeholder = '材料名';
        nameInput.value = ingredient.name;

        const amountInput = document.createElement('input');
        amountInput.type = 'number';
        amountInput.className = 'amount-input';
        amountInput.placeholder = '分量';
        amountInput.min = '0';

        const unitLabel = document.createElement('span');
        unitLabel.className = 'unit-label';

        const ratioDisplay = document.createElement('span');
        ratioDisplay.className = 'ratio-display';

        const removeBtn = document.createElement('button');
        removeBtn.className = 'danger';
        removeBtn.textContent = '🗑️';
        removeBtn.title = '削除';
        removeBtn.addEventListener('click', () => {
            li.remove();
            updateTotalsAndRatios();
        });

        li.append(radio, nameInput, amountInput, unitLabel, ratioDisplay, removeBtn);
        ingredientsListEl.appendChild(li);

        if (focusAfterAdd) nameInput.focus();

        // 現在の単位に合わせて入力欄を初期化（機能はそのまま）
        setUnit(currentUnit, true);
        updateTotalsAndRatios();
    }

    function updateFormState(state) {
        saveBtn.style.display = state === 'new' ? 'inline-flex' : 'none';
        updateBtn.style.display = state === 'edit' ? 'inline-flex' : 'none';
        deleteBtn.style.display = state === 'edit' ? 'inline-flex' : 'none';
    }

    // --- レシピ操作 ---
    function selectRecipe(recipeId) {
        const recipe = recipes.find(r => r.id === recipeId);
        if (!recipe) return;
        const savedUnit = currentUnit;
        currentRecipeId = recipeId;
        renderRecipeForm(recipe);
        setUnit(savedUnit);
        renderRecipeList();
        showFormView();
    }

    function clearForm() {
        currentRecipeId = null;
        recipeNameEl.value = '';
        ingredientsListEl.innerHTML = '';
        scaleAmountEl.value = '';
        desiredTotalAmountEl.value = '';
        // 3行追加（ユーザー指定のUXは変更なし）
        addIngredientRow({ name:'', amount:0 }, true);
        addIngredientRow();
        addIngredientRow();
        updateFormState('new');
        setUnit('g');
        const sel = recipeListEl.querySelector('.selected');
        if (sel) sel.classList.remove('selected');
        recipeNameEl.focus();
    }

    function getRecipeDataFromForm() {
        const name = recipeNameEl.value.trim();
        if (!name) { alert('レシピ名を入力してください。'); return null; }
        const ingredients = Array.from(ingredientsListEl.querySelectorAll('.ingredient-item')).map(item => {
            const nm = item.querySelector('.name-input').value.trim();
            const amount = parseFloat(item.dataset.amountInG);
            return (nm && !isNaN(amount) && amount > 0) ? { name: nm, amount: amount } : null;
        }).filter(Boolean);
        if (ingredients.length === 0) { alert('有効な材料を1つ以上入力してください。'); return null; }
        return { name, ingredients };
    }

    function saveRecipe() {
        const data = getRecipeDataFromForm();
        if (!data) return;
        const newR = { id: `recipe_${Date.now()}`, ...data };
        recipes.push(newR);
        saveRecipesToStorage();
        renderRecipeList();
        selectRecipe(newR.id);
    }

    function updateRecipe() {
        if (!currentRecipeId) return;
        const data = getRecipeDataFromForm();
        if (!data) return;
        const idx = recipes.findIndex(r => r.id === currentRecipeId);
        if (idx > -1) {
            recipes[idx] = { ...recipes[idx], ...data };
            saveRecipesToStorage();
            renderRecipeList();
            alert('レシピが更新されました。');
        }
    }

    function deleteRecipe() {
        if (!currentRecipeId) return;
        const recipe = recipes.find(r => r.id === currentRecipeId);
        if (!recipe) return;
        if (confirm(`「${recipe.name}」を削除しますか？`)) {
            recipes = recipes.filter(r => r.id !== currentRecipeId);
            saveRecipesToStorage();
            renderRecipeList();
            clearForm();
            showListView();
        }
    }

    // --- 単位・計算ロジック（そのまま） ---
    function setUnit(unit, skipInputUpdate = false) {
        currentUnit = unit;
        scaleUnitEl.textContent = unit;
        totalAmountUnitEl.textContent = unit;
        totalUnitLabelEl.textContent = unit;
        unit === 'g' ? (unitGRadio.checked = true) : (unitKgRadio.checked = true);

        const divider = unit === 'kg' ? 1000 : 1;
        const precision = unit === 'kg' ? 3 : 0;

        ingredientsListEl.querySelectorAll('.ingredient-item').forEach(item => {
            const amountInG = parseFloat(item.dataset.amountInG || '0');
            const input = item.querySelector('.amount-input');
            if (!skipInputUpdate) {
                input.value = (amountInG / divider).toFixed(precision);
            } else {
                if (!input.value) input.value = (amountInG / divider).toFixed(precision);
            }
            item.querySelector('.unit-label').textContent = unit;
        });

        const baseRadio = ingredientsListEl.querySelector('input[name=baseIngredient]:checked');
        if (baseRadio) {
            const item = baseRadio.closest('.ingredient-item');
            const amountInG = parseFloat(item.dataset.amountInG || '0');
            scaleAmountEl.value = (amountInG / divider).toFixed(precision);
        } else if (scaleAmountEl.value) {
            scaleAmountEl.value = '';
        }

        updateTotalsAndRatios();
    }

    function calculateFromSingleIngredient() {
        const scaleAmount = parseFloat(scaleAmountEl.value);
        if (isNaN(scaleAmount) || scaleAmount <= 0) return;

        let baseItem = ingredientsListEl.querySelector('input[name=baseIngredient]:checked')?.closest('.ingredient-item');
        if (!baseItem) { alert('基準にする材料をラジオボタンで選択してください。'); return; }

        const baseAmountInG = parseFloat(baseItem.dataset.amountInG);
        if (isNaN(baseAmountInG) || baseAmountInG === 0) { alert('基準材料の分量が0のため、比率を計算できません。'); return; }

        const multiplier = currentUnit === 'kg' ? 1000 : 1;
        const scale = (scaleAmount * multiplier) / baseAmountInG;

        ingredientsListEl.querySelectorAll('.ingredient-item').forEach(item => {
            const originalAmountInG = parseFloat(item.dataset.amountInG || '0');
            if (!isNaN(originalAmountInG)) {
                const newAmountInG = originalAmountInG * scale;
                item.dataset.amountInG = newAmountInG;
            }
        });

        setUnit(currentUnit);
    }

    function scaleFromTotal() {
        const desiredTotal = parseFloat(desiredTotalAmountEl.value);
        if (isNaN(desiredTotal) || desiredTotal <= 0) { alert('有効な目標合計量を入力してください。'); return; }

        let currentTotalInG = 0;
        const items = Array.from(ingredientsListEl.querySelectorAll('.ingredient-item'));
        items.forEach(item => {
            const amountInG = parseFloat(item.dataset.amountInG || '0');
            if (!isNaN(amountInG)) currentTotalInG += amountInG;
        });

        if (currentTotalInG === 0) { alert('現在の合計が0のため、比率を計算できません。'); return; }

        const multiplier = currentUnit === 'kg' ? 1000 : 1;
        const scale = (desiredTotal * multiplier) / currentTotalInG;

        items.forEach(item => {
            const originalAmountInG = parseFloat(item.dataset.amountInG || '0');
            if (!isNaN(originalAmountInG)) {
                const newAmountInG = originalAmountInG * scale;
                item.dataset.amountInG = newAmountInG;
            }
        });

        setUnit(currentUnit);
    }

    function updateTotalsAndRatios() {
        let totalAmountInG = 0;
        const amountsInG = [];
        ingredientsListEl.querySelectorAll('.ingredient-item').forEach(item => {
            const amount = parseFloat(item.dataset.amountInG || '0');
            if (!isNaN(amount)) { totalAmountInG += amount; amountsInG.push(amount); }
            else amountsInG.push(0);
        });

        const divider = currentUnit === 'kg' ? 1000 : 1;
        totalAmountValueEl.textContent = (totalAmountInG / divider).toFixed(divider === 1000 ? 3 : 0);

        const displays = ingredientsListEl.querySelectorAll('.ratio-display');
        displays.forEach((display, index) => {
            const ratio = totalAmountInG > 0 ? (amountsInG[index] / totalAmountInG) * 100 : 0;
            display.textContent = `(${ratio.toFixed(1)}%)`;
        });
    }

    // --- 全画面 ---
    function toggleFullscreen() {
        if (!document.fullscreenElement) {
            document.documentElement.requestFullscreen().catch(err => alert(`全画面表示にできませんでした: ${err.message}`));
        } else {
            if (document.exitFullscreen) document.exitFullscreen();
        }
    }

    // --- エクスポート/インポート ---
    function exportRecipes() {
        if (recipes.length === 0) { alert('エクスポートするレシピがありません。'); return; }
        const dataStr = JSON.stringify(recipes, null, 2);
        const blob = new Blob([dataStr], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'recipes_backup.json';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }

    function importRecipes(event) {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = e => {
            try {
                const data = JSON.parse(e.target.result);
                if (!Array.isArray(data) || !data.every(item => item.id && item.name && Array.isArray(item.ingredients))) {
                    throw new Error('JSONのデータ構造が不正です。');
                }
                if (confirm('現在の全レシピをインポートしたデータで上書きします。よろしいですか？')) {
                    recipes = data;
                    saveRecipesToStorage();
                    clearForm();
                    renderRecipeList();
                    showListView();
                    alert(`${recipes.length}件のレシピをインポートしました。`);
                }
            } catch (error) {
                alert(`インポート失敗: ${error.message}`);
            } finally {
                importFileEl.value = '';
            }
        };
        reader.readAsText(file);
    }

    // --- サンプルデータ ---
    function generateSampleRecipes() {
        return [
            { id: "sample_1", name: "肉じゃが", ingredients: [ { name: "じゃがいも", amount: 300 }, { name: "牛肉", amount: 200 }, { name: "玉ねぎ", amount: 150 }, { name: "人参", amount: 100 }, { name: "醤油", amount: 45 }, { name: "砂糖", amount: 30 }, { name: "みりん", amount: 30 }, { name: "だし汁", amount: 200 } ] },
            { id: "sample_2", name: "豚の生姜焼き", ingredients: [ { name: "豚ロース肉", amount: 300 }, { name: "玉ねぎ", amount: 100 }, { name: "生姜（すりおろし）", amount: 15 }, { name: "醤油", amount: 30 }, { name: "みりん", amount: 30 }, { name: "酒", amount: 15 }, { name: "サラダ油", amount: 15 } ] },
            { id: "sample_3", name: "親子丼", ingredients: [ { name: "鶏もも肉", amount: 250 }, { name: "玉ねぎ", amount: 100 }, { name: "卵", amount: 150 }, { name: "だし汁", amount: 100 }, { name: "醤油", amount: 30 }, { name: "みりん", amount: 30 }, { name: "ご飯", amount: 600 } ] },
            { id: "sample_4", name: "カレーライス", ingredients: [ { name: "豚肉または牛肉", amount: 250 }, { name: "じゃがいも", amount: 300 }, { name: "人参", amount: 150 }, { name: "玉ねぎ", amount: 400 }, { name: "カレールー", amount: 100 }, { name: "水", amount: 800 }, { name: "サラダ油", amount: 15 } ] },
            { id: "sample_5", name: "鶏の唐揚げ", ingredients: [ { name: "鶏もも肉", amount: 500 }, { name: "醤油", amount: 30 }, { name: "酒", amount: 15 }, { name: "生姜（すりおろし）", amount: 10 }, { name: "にんにく（すりおろし）", amount: 5 }, { name: "片栗粉", amount: 50 }, { name: "揚げ油", amount: 500 } ] },
            { id: "sample_6", name: "ハンバーグ", ingredients: [ { name: "合いびき肉", amount: 400 }, { name: "玉ねぎ", amount: 150 }, { name: "パン粉", amount: 30 }, { name: "牛乳", amount: 45 }, { name: "卵", amount: 50 }, { name: "塩", amount: 3 }, { name: "こしょう", amount: 1 }, { name: "ナツメグ", amount: 1 } ] },
            { id: "sample_7", name: "鮭の塩焼き", ingredients: [ { name: "生鮭", amount: 240 }, { name: "塩", amount: 2 } ] },
            { id: "sample_8", name: "筑前煮", ingredients: [ { name: "鶏もも肉", amount: 200 }, { name: "ごぼう", amount: 100 }, { name: "人参", amount: 100 }, { name: "れんこん", amount: 150 }, { name: "干ししいたけ", amount: 10 }, { name: "こんにゃく", amount: 100 }, { name: "だし汁", amount: 300 }, { name: "醤油", amount: 45 }, { name: "砂糖", amount: 15 }, { name: "みりん", amount: 30 } ] },
            { id: "sample_9", name: "お好み焼き", ingredients: [ { name: "薄力粉", amount: 100 }, { name: "だし汁", amount: 120 }, { name: "キャベツ", amount: 300 }, { name: "豚バラ肉", amount: 100 }, { name: "卵", amount: 100 }, { name: "天かす", amount: 20 }, { name: "紅しょうが", amount: 10 } ] },
            { id: "sample_10", name: "だし巻き卵", ingredients: [ { name: "卵", amount: 200 }, { name: "だし汁", amount: 60 }, { name: "薄口醤油", amount: 5 }, { name: "みりん", amount: 5 }, { name: "塩", amount: 1 } ] },
            { id: "sample_11", name: "チャーハン", ingredients: [ { name: "ご飯", amount: 400 }, { name: "卵", amount: 100 }, { name: "長ネギ", amount: 50 }, { name: "焼き豚", amount: 80 }, { name: "醤油", amount: 10 }, { name: "塩", amount: 2 }, { name: "こしょう", amount: 1 }, { name: "ごま油", amount: 10 } ] },
            { id: "sample_12", name: "東坡肉（トンポーロー）", ingredients: [ { name: "豚バラブロック肉", amount: 500 }, { name: "長ネギの青い部分", amount: 50 }, { name: "生姜スライス", amount: 20 }, { name: "紹興酒", amount: 100 }, { name: "醤油", amount: 75 }, { name: "氷砂糖", amount: 50 }, { name: "水", amount: 400 }, { name: "八角", amount: 1 } ] }
        ];
    }
    </script>
</body>
</html>