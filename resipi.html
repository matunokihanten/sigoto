<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ãƒ¬ã‚·ãƒ”åˆ†é‡è¨ˆç®—ã‚¢ãƒ—ãƒª</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.14.0/Sortable.min.js"></script>
    <style>
        /* ========================================================================= */
        /* --- 1. ãƒ“ãƒ¥ãƒ¼ãƒãƒ¼ãƒˆå¯¾å¿œã¨åŸºæœ¬ãƒªã‚»ãƒƒãƒˆ --- */
        /* ========================================================================= */
        :root {
            --vh: 1vh;
            --base-font: 15px;
            --highlight-color: #f7f3e8; /* åŸºæº–ææ–™ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆè‰² */
        }
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden; 
            font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
            font-size: var(--base-font);
            color: #333;
            background-color: #f4f7f9;
            -webkit-text-size-adjust: 100%;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            -webkit-tap-highlight-color: transparent;
        }
        * { box-sizing: border-box; } 

        /* --- 2. å…¨ä½“ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ --- */
        body {
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: calc(var(--vh) * 100);
            padding-top: 10px;
        }
        
        .app-container {
            position: relative;
            display: flex;
            width: 96%;
            max-width: 1200px;
            height: calc(var(--vh) * 100 - 20px);
            min-height: 450px;
            background-color: #fff;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border-radius: 8px;
            overflow: hidden;
        }

        /* --- 3. å·¦å³åˆ†å‰²ã¨ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ« --- */
        #recipeListContainer {
            width: 300px;
            min-width: 250px;
            border-right: 1px solid #eee;
            background-color: #ecf0f1;
            padding: 12px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            overflow-y: hidden; 
            -webkit-overflow-scrolling: touch;
            overscroll-behavior: contain;
        }
        
        #recipeSelect {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 0.95rem;
            margin-bottom: 8px;
        }

        #recipeFormContainer {
            flex: 1;
            padding: 12px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            overflow-y: auto; 
            -webkit-overflow-scrolling: touch;
            overscroll-behavior: contain;
        }

        /* --- 4. å…±é€šãƒ•ã‚©ãƒ¼ãƒ éƒ¨å“ã¨ãƒœã‚¿ãƒ³ --- */
        .form-section {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            background-color: #fafafa;
        }
        label { display: block; margin-bottom: 6px; font-weight: 600; color:#2c3e50; font-size:0.95rem; }
        h2, h3 { margin: 6px 0; font-size: 1.1rem; }
        
        input[type="text"], input[type="number"], .ingredient-item input:not([type="radio"]) {
            padding: 8px 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 0.95rem;
            width: 100%;
        }
        
        button {
            padding: 8px 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 0.95rem;
            transition: background-color 0.12s;
        }
        .primary { background:#2ecc71; color:#fff; }
        .primary:hover { background:#27ae60; }
        .secondary { background:#3498db; color:#fff; }
        .secondary:hover { background:#2980b9; }
        .danger { background:#e74c3c; color:#fff; padding:6px 8px; font-size:0.9rem; }
        .danger:hover { background:#c0392b; }

        .control-group, .io-controls { display:flex; gap:10px; flex-wrap:wrap; }

        .list-header { 
            display:flex;
            justify-content:space-between; 
            align-items:center; 
            padding-bottom:6px; 
            border-bottom:1px solid #ddd;
            flex-wrap: wrap; 
        }
        
        /* --- 6. ææ–™ãƒªã‚¹ãƒˆã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆï¼ˆPC/ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆå‘ã‘1è¡Œå›ºå®šï¼‰ --- */
        #ingredientsList { list-style:none; padding:0; margin:0; display:flex; flex-direction:column; gap:6px; }
        .ingredient-item {
            display:flex;
            align-items:center;
            gap:8px;
            padding:4px 4px 4px 0;
            border-bottom:1px dashed #eee;
            flex-wrap:nowrap;
            cursor: move; 
            background-color: #fff; 
            transition: background-color 0.1s;
        }

        /* åŸºæº–ææ–™ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆ */
        .ingredient-item.is-base {
            background-color: var(--highlight-color);
            border-radius: 4px;
        }

        .ingredient-item input[type="radio"] { flex:0 0 auto; transform:scale(1.05); margin-right:4px; width: auto; }
        .ingredient-item .handle { flex:0 0 15px; cursor: grab; color:#aaa; font-size:1.1rem; line-height:1; } 
        .ingredient-item .name-input { flex:3 1 40%; min-width:80px; width: auto; }
        .ingredient-item .amount-input { flex:1 0 15%; min-width:50px; text-align:right; width: auto; }
        .ingredient-item .unit-input { flex:0 0 70px; min-width:50px; width: auto; font-size:0.92rem; }
        .ingredient-item .ratio-display { flex:0 0 65px; text-align:right; font-size:0.85rem; color:#7f8c8d; white-space:nowrap; width: auto; }
        .ingredient-item .danger { flex:0 0 auto; margin-left:4px; width: auto; }
        .ingredients-header { display:flex; justify-content:flex-end; margin-bottom:6px; }

        /* SortableJS å‘ã‘ã‚¹ã‚¿ã‚¤ãƒ« */
        .sortable-ghost {
            opacity: 0.4;
            background-color: #e0f2f1;
        }

        /* --- 7. ã‚¹ã‚±ãƒ¼ãƒ«/åˆè¨ˆè¡¨ç¤º --- */
        .scale-control, .total-control { 
            display:flex;
            align-items:center; 
            gap:8px; 
            flex-wrap:wrap;
        }
        .scale-control label, .total-control label { flex:0 0 auto; margin-bottom:0; }
        .scale-control input[type="number"], .total-control input[type="number"] { width:100px; flex: 0 0 auto; }
        .scale-control button, .total-control button { flex-grow: 1; min-width: 150px; }

        .total-display { font-size:1rem; font-weight:700; color:#2980b9; }
        .unit-radio-group label { display:inline-flex; align-items:center; margin-bottom:0; font-weight:normal; font-size:0.95rem; }
        
        .precision-select {
            padding: 8px 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 0.95rem;
            width: 100px;
        }

        /* --- 8. ãƒ¢ãƒã‚¤ãƒ«å°‚ç”¨ã‚¹ã‚¿ã‚¤ãƒ« (max-width: 768px) --- */
        @media (max-width: 768px) {
            body { padding-top: 0; }
            .app-container {
                width: 100%;
                height: calc(var(--vh) * 100);
                border-radius: 0;
                box-shadow: none;
                flex-direction: column;
            }
            
            #recipeListContainer {
                width: 100%;
                height: auto;
                border-right: none;
                border-bottom: 1px solid #eee;
                padding-bottom: 15px;
            }

            #recipeFormContainer {
                width: 100%;
                height: 100%;
                overflow-y: auto;
                padding: 10px;
                gap: 8px;
            }
            
            /* ææ–™è¡Œã®èª¿æ•´ - æ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«é˜²æ­¢ã®ãŸã‚ã®ä¸»è¦ãªä¿®æ­£ */
            .ingredient-item { 
                gap: 5px; 
                padding: 4px 0; 
                flex-wrap: nowrap; 
                justify-content: flex-start;
                padding-right: 4px; 
            }
            
            /* ä¸è¦ãªè¦ç´ ã‚’éè¡¨ç¤ºã«ã—ã€ã‚¹ãƒšãƒ¼ã‚¹ã‚’ç¢ºä¿ */
            .ingredient-item .handle, 
            .ingredient-item .ratio-display,
            .ingredient-item input[type="radio"] { 
                display: none; 
            }
            
            /* æ®‹ã‚Šã®è¦ç´ ã®å¹…ã‚’å†é…åˆ†ã—ã€å…¨ä½“ã§æ¨ªå¹…ã‚’è¶…ãˆãªã„ã‚ˆã†ã«èª¿æ•´ */
            .ingredient-item .name-input { flex: 4 1 35%; min-width: 70px; }
            .ingredient-item .amount-input { flex: 2 1 25%; min-width: 50px; }
            .ingredient-item .unit-input { flex: 2 1 25%; min-width: 40px; }
            .ingredient-item .danger { flex: 0 0 auto; margin-left: 0; padding: 4px 6px; }

            .scale-control, .total-control { flex-wrap: wrap; justify-content: flex-start; }
            .scale-control input[type="number"], .total-control input[type="number"] { width: 80px; }
            .scale-control button, .total-control button { flex: 1 1 100%; margin-top: 8px; }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div id="recipeListContainer">
            <div class="list-header">
                <h2 style="margin:0;">ãƒ¬ã‚·ãƒ”é¸æŠ</h2>
                <button id="newRecipeBtn" class="primary">ğŸ“ æ–°è¦ä½œæˆ</button>
            </div>
           
            <select id="recipeSelect">
                <option value="">-- ãƒ¬ã‚·ãƒ”ã‚’é¸æŠã—ã¦ãã ã•ã„ --</option>
                </select>
            
            <p style="font-size: 0.8rem; color: #7f8c8d; margin: 0; padding: 0;">â€»æ–°è¦ä½œæˆã§å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã™ã€‚</p>
        </div>

        <div id="recipeFormContainer">
  
           <div class="form-section">
                <label for="recipeName">ãƒ¬ã‚·ãƒ”å</label>
                <input type="text" id="recipeName" placeholder="ä¾‹: è‚‰ã˜ã‚ƒãŒ" required />
            </div>

            <div class="form-section">
                <label for="servings">ä½•äººåˆ†</label>
                <div style="display: flex; align-items: center; gap: 8px;">
                    <input type="number" id="servings" value="1" style="width: 100px;" />
                    <span>äººå‰</span>
                    <label for="precisionSelect" style="margin-left: 20px; margin-bottom: 0;">å°æ•°ç‚¹ä»¥ä¸‹</label>
                    <select id="precisionSelect" class="precision-select">
                        <option value="0">0æ¡</option>
                        <option value="1">1æ¡</option>
                        <option value="2" selected>2æ¡</option>
                        <option value="3">3æ¡</option>
                    </select>
                </div>
            </div>

            <div class="form-section">
                <h3 style="margin:6px 0 8px 0; font-size:1rem;">ææ–™ã¨åˆ†é‡ (1äººå‰ãƒ™ãƒ¼ã‚¹ã§ä¿å­˜)</h3>
    
             <div class="unit-radio-group" style="display:flex; gap:10px; align-items:center; margin-bottom:6px;">
                    <input type="radio" id="unitG" name="unit" value="g" checked />
                    <label for="unitG">ã‚°ãƒ©ãƒ  (g)</label>
                    <input type="radio" id="unitKg" name="unit" value="kg" />
                    <label for="unitKg">ã‚­ãƒ­ã‚°ãƒ©ãƒ  (kg)</label>
     
           </div>

                <div class="ingredients-header">
                    <button id="addIngredient" class="secondary">â• ææ–™è¿½åŠ </button>
                </div>

                <ul id="ingredientsList"></ul>
            </div>

    
         <div class="form-section">
                <h3 style="margin:6px 0 8px 0; font-size:1rem;">åˆ†é‡è¨ˆç®— (åŸºæº–ææ–™ã‹ã‚‰)</h3>
                <div class="scale-control">
                    <label style="margin-right:4px;">åŸºæº–é‡:</label>
                    <input type="number" id="scaleAmount" min="0" placeholder="0" />
                    <span id="scaleUnit">g</span>
               
     <button id="calculateFromSingleIngredientBtn" class="secondary">ğŸ”„ åŸºæº–é‡ã‹ã‚‰è¨ˆç®—</button>
                </div>
                <p style="font-size:0.82rem; color:#7f8c8d; margin-top:6px;">â€»ææ–™è¡Œã®ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ã§åŸºæº–ææ–™ã‚’é¸æŠã™ã‚‹ã‹ã€**æœ€å¤šé‡ã®ææ–™ãŒè‡ªå‹•ã§é¸æŠ**ã•ã‚Œã¾ã™ã€‚</p>
            </div>

            <div class="form-section">
                <h3 style="margin:6px 0 8px 0; font-size:1rem;">åˆ†é‡è¨ˆç®— (åˆè¨ˆé‡ã‹ã‚‰)</h3>
                <div class="total-control">
                    <label style="margin-right:4px;">ç¾åœ¨ã®åˆè¨ˆ:</label>
                    <span class="total-display"><span id="totalAmountValue">0</span><span id="totalAmountUnit">g</span></span>
                </div>
                <div class="total-control" style="margin-top:8px;">
    
                 <label style="margin-right:4px;">ç›®æ¨™åˆè¨ˆé‡:</label>
                    <input type="number" id="desiredTotalAmount" min="0" placeholder="0" />
                    <span id="totalUnitLabel">g</span>
                    <button id="scaleFromTotalBtn" class="secondary">ğŸ¯ åˆè¨ˆé‡ã‹ã‚‰è¨ˆç®—</button>
              
   </div>
                <p style="font-size:0.82rem; color:#7f8c8d; margin-top:6px;">â€»ç›®æ¨™åˆè¨ˆé‡ã‚’å…¥åŠ›ã—ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨å…¨ææ–™ã®åˆ†é‡ãŒèª¿æ•´ã•ã‚Œã¾ã™ã€‚</p>
            </div>

            <div class="control-group">
                <button id="saveBtn" class="primary">ğŸ’¾ ä¿å­˜</button>
                <button id="updateBtn" class="primary" style="display:none;">âœ”ï¸ æ›´æ–°</button>
                <button id="deleteBtn" class="danger" style="display:none;">ğŸ—‘ï¸ å‰Šé™¤</button>
            </div>

   
         <div class="io-controls">
                <button id="exportBtn" class="secondary">ğŸ“¤ CSVã§ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
                <button id="importBtn" class="secondary">ğŸ“¥ CSVã‹ã‚‰ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
                <input type="file" id="importFile" accept=".csv" style="display:none;" />
            </div>
        </div>
    </div>

    <script>
    // --- 0. åˆæœŸè¨­å®šã¨DOMå‚ç…§ ---
    (function() {
        function setVh() {
            document.documentElement.style.setProperty('--vh', (window.innerHeight * 0.01) + 'px');
        }
        setVh();
        window.addEventListener('resize', setVh);
        window.addEventListener('orientationchange', function() { setTimeout(setVh, 200); });
    })();

    const RECIPES_STORAGE_KEY = 'recipesv2_final'; 
    let recipes = [];
    let currentRecipeId = null;
    let currentUnit = 'g'; 

    const recipeSelectEl = document.getElementById('recipeSelect');
    const newRecipeBtn = document.getElementById('newRecipeBtn');
    const recipeNameEl = document.getElementById('recipeName');
    const servingsEl = document.getElementById('servings');
    const ingredientsListEl = document.getElementById('ingredientsList');
    const addIngredientBtn = document.getElementById('addIngredient');
    const saveBtn = document.getElementById('saveBtn');
    const updateBtn = document.getElementById('updateBtn');
    const deleteBtn = document.getElementById('deleteBtn');
    const scaleAmountEl = document.getElementById('scaleAmount');
    const scaleUnitEl = document.getElementById('scaleUnit');
    const unitGRadio = document.getElementById('unitG');
    const unitKgRadio = document.getElementById('unitKg');
    const exportBtn = document.getElementById('exportBtn');
    const importBtn = document.getElementById('importBtn');
    const importFileEl = document.getElementById('importFile');
    const totalAmountValueEl = document.getElementById('totalAmountValue');
    const totalAmountUnitEl = document.getElementById('totalAmountUnit');
    const desiredTotalAmountEl = document.getElementById('desiredTotalAmount');
    const scaleFromTotalBtn = document.getElementById('scaleFromTotalBtn');
    const totalUnitLabelEl = document.getElementById('totalUnitLabel');
    const calculateFromSingleIngredientBtn = document.getElementById('calculateFromSingleIngredientBtn');
    const precisionSelectEl = document.getElementById('precisionSelect'); 

    // --- 1. åˆæœŸåŒ–å‡¦ç† ---
    document.addEventListener('DOMContentLoaded', () => {
        loadRecipes();
        renderRecipeList();
        setupEventListeners();
        clearForm(true); 
        
        if (recipes.length > 0) {
            recipeSelectEl.value = recipes[0].id;
            selectRecipe(recipes[0].id);
        }
        
        new Sortable(ingredientsListEl, {
            handle: '.handle', 
            animation: 150,
            ghostClass: 'sortable-ghost' 
        });
    });

    // --- 2. ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š ---
    function setupEventListeners() {
        recipeSelectEl.addEventListener('change', e => selectRecipe(e.target.value));
        newRecipeBtn.addEventListener('click', () => {
            clearForm();
            recipeSelectEl.value = '';
        });
        
        servingsEl.addEventListener('input', scaleIngredientsByServings);
        precisionSelectEl.addEventListener('change', setUnit.bind(null, currentUnit, false)); 
        addIngredientBtn.addEventListener('click', () => addIngredientRow({ name: '', amount: 0 }, true));
        saveBtn.addEventListener('click', saveRecipe);
        updateBtn.addEventListener('click', updateRecipe);
        deleteBtn.addEventListener('click', deleteRecipe);
        unitGRadio.addEventListener('change', () => setUnit('g'));
        unitKgRadio.addEventListener('change', () => setUnit('kg'));
        
        scaleAmountEl.addEventListener('input', calculateFromSingleIngredient);
        calculateFromSingleIngredientBtn.addEventListener('click', calculateFromSingleIngredient); 
        
        scaleFromTotalBtn.addEventListener('click', scaleFromTotal);
        
        ingredientsListEl.addEventListener('input', handleIngredientInput);
        ingredientsListEl.addEventListener('click', handleIngredientRadioClick);

        exportBtn.addEventListener('click', exportRecipesToCsv);
        importBtn.addEventListener('click', () => importFileEl.click());
        importFileEl.addEventListener('change', importRecipesFromCsv);
    }
    
    function handleIngredientInput(e) {
        const item = e.target.closest('.ingredient-item');
        if (!item) return;

        if (e.target.classList.contains('amount-input')) {
            const amountValue = parseFloat(e.target.value) || 0;
            const multiplier = currentUnit === 'kg' ? 1000 : 1;
            const servings = parseInt(servingsEl.value, 10) || 1;
            
            const newAmountInG = amountValue * multiplier;
            item.dataset.amountInG = newAmountInG;
            item.dataset.baseAmountInG = newAmountInG / servings;

            updateTotalsAndRatios();
            autoSelectBaseIngredient(); 
        }
        if (e.target.classList.contains('unit-input')) {
            item.dataset.customUnit = 'true';
        }
    }
    
    function handleIngredientRadioClick(e) {
        if (e.target.type === 'radio' && e.target.name === 'baseIngredient') {
            const item = e.target.closest('.ingredient-item');
            if (item) {
                ingredientsListEl.querySelectorAll('.ingredient-item').forEach(li => li.classList.remove('is-base'));
                item.classList.add('is-base');
                
                const amountInG = parseFloat(item.dataset.amountInG || '0');
                const divider = currentUnit === 'kg' ? 1000 : 1;
                const precision = parseInt(precisionSelectEl.value, 10);
                scaleAmountEl.value = (amountInG / divider).toFixed(precision);
                scaleAmountEl.focus();
            }
        }
    }

    // --- 3. ãƒ‡ãƒ¼ã‚¿ç®¡ç† ---
    function loadRecipes() {
        try {
            const storedRecipes = localStorage.getItem(RECIPES_STORAGE_KEY);
            recipes = storedRecipes ? JSON.parse(storedRecipes) : [];
        } catch (e) {
            console.error("Failed to load recipes from localStorage", e);
            recipes = []; 
        }
        
        if (!recipes || !Array.isArray(recipes) || recipes.length === 0) {
             recipes = generateSampleRecipes();
             saveRecipesToStorage();
             console.log("LocalStorageã«ãƒ‡ãƒ¼ã‚¿ãŒãªã„ãŸã‚ã€ã‚µãƒ³ãƒ—ãƒ«3ä»¶ã‚’ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸã€‚");
        }
    }
    
    function saveRecipesToStorage() { localStorage.setItem(RECIPES_STORAGE_KEY, JSON.stringify(recipes)); }

    // --- 4. UIæç”» ---
    function renderRecipeList() {
        recipeSelectEl.innerHTML = '<option value="">-- ãƒ¬ã‚·ãƒ”ã‚’é¸æŠã—ã¦ãã ã•ã„ --</option>';
        if (recipes.length === 0) {
            const option = document.createElement('option');
            option.textContent = 'ãƒ¬ã‚·ãƒ”ãŒã‚ã‚Šã¾ã›ã‚“';
            option.disabled = true;
            recipeSelectEl.appendChild(option);
            return;
        }

        recipes.sort((a, b) => a.name.localeCompare(b.name, 'ja')).forEach(recipe => {
            const option = document.createElement('option');
            option.textContent = recipe.name;
            option.value = recipe.id;
            if (recipe.id === currentRecipeId) {
                option.selected = true;
            }
            recipeSelectEl.appendChild(option);
        });
    }

    function renderRecipeForm(recipe) {
        currentRecipeId = recipe.id;
        recipeNameEl.value = recipe.name;
        
        servingsEl.value = recipe.servings || 1; 
        currentUnit = recipe.unitPreference || 'g'; 
        
        ingredientsListEl.innerHTML = '';
        recipe.ingredients.forEach(ing => addIngredientRow(ing));
        
        scaleAmountEl.value = '';
        desiredTotalAmountEl.value = '';
        updateFormState('edit');
        setUnit(currentUnit); 
        scaleIngredientsByServings(); 
        autoSelectBaseIngredient(); 
    }

    function addIngredientRow(ingredient = { name: '', amount: 0, unit: null }, focusAfterAdd = false) {
        const li = document.createElement('li');
        li.className = 'ingredient-item';
        
        const servings = parseInt(servingsEl.value, 10) || 1;
        const currentAmountInG = ingredient.amount * servings;

        li.dataset.baseAmountInG = ingredient.amount || '0'; 
        li.dataset.amountInG = currentAmountInG || '0';
        
        if (ingredient.unit) {
            li.dataset.customUnit = 'true';
        }

        const handle = document.createElement('span'); handle.className = 'handle'; handle.textContent = 'â˜°';
        const radio = document.createElement('input'); radio.type = 'radio'; radio.name = 'baseIngredient'; radio.title = 'åŸºæº–ã«ã™ã‚‹';
        const nameInput = document.createElement('input'); nameInput.type = 'text'; nameInput.className = 'name-input'; nameInput.placeholder = 'ææ–™å'; nameInput.value = ingredient.name;
        const amountInput = document.createElement('input'); amountInput.type = 'number'; amountInput.className = 'amount-input'; amountInput.placeholder = 'åˆ†é‡'; amountInput.min = '0';
        
        const unitInput = document.createElement('input');
        unitInput.type = 'text';
        unitInput.className = 'unit-input';
        unitInput.title = 'å˜ä½ã‚’ç·¨é›†ã§ãã¾ã™';
        unitInput.value = ingredient.unit || currentUnit;
        
        const ratioDisplay = document.createElement('span'); ratioDisplay.className = 'ratio-display';
        const removeBtn = document.createElement('button'); removeBtn.textContent = 'ğŸ—‘ï¸'; removeBtn.className = 'danger'; removeBtn.title = 'å‰Šé™¤';
        removeBtn.addEventListener('click', () => {
            li.remove();
            updateTotalsAndRatios();
            autoSelectBaseIngredient();
        });
        
        li.append(handle, radio, nameInput, amountInput, unitInput, ratioDisplay, removeBtn);
        ingredientsListEl.appendChild(li);

        if (focusAfterAdd) {
            nameInput.focus();
        }
        
        setUnit(currentUnit, false);
    }

    function updateFormState(state) {
        saveBtn.style.display = state === 'new' ? 'inline-flex' : 'none';
        updateBtn.style.display = state === 'edit' ? 'inline-flex' : 'none';
        deleteBtn.style.display = state === 'edit' ? 'inline-flex' : 'none';
    }

    // --- 5. ãƒ¬ã‚·ãƒ”æ“ä½œ ---
    function selectRecipe(recipeId) {
        if (!recipeId) {
            clearForm();
            return;
        }

        const recipe = recipes.find(r => r.id === recipeId);
        if (recipe) {
            renderRecipeForm(recipe);
            renderRecipeList(); 
        }
    }

    function clearForm(isInitialLoad = false) {
        currentRecipeId = null;
        recipeNameEl.value = '';
        servingsEl.value = 1; // JSå´ã§ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤1ã‚’è¨­å®š
        ingredientsListEl.innerHTML = '';
        scaleAmountEl.value = '';
        desiredTotalAmountEl.value = '';
        
        setUnit('g');
        
        if (!isInitialLoad) {
            addIngredientRow({ name: '', amount: 0 }, true);
            addIngredientRow();
            addIngredientRow();
        }
        
        updateFormState('new');
        recipeSelectEl.value = '';
        recipeNameEl.focus();
    }

    function getRecipeDataFromForm() {
        const name = recipeNameEl.value.trim();
        // å…¥åŠ›ãŒç©ºã®å ´åˆã€0ã¾ãŸã¯1ã¨ã—ã¦æ‰±ã†ãŒã€ä¿å­˜æ™‚ã¯1æœªæº€ã¯1ã«å¼·åˆ¶ã™ã‚‹
        const servings = parseInt(servingsEl.value, 10) || 1;
        
        if (!name) {
            alert('ãƒ¬ã‚·ãƒ”åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
            return null;
        }

        const ingredients = Array.from(ingredientsListEl.querySelectorAll('.ingredient-item')).map(item => {
            const nameInput = item.querySelector('.name-input').value.trim();
            const amount = parseFloat(item.dataset.baseAmountInG);
            const unitText = item.querySelector('.unit-input').value.trim();
            
            return (nameInput && !isNaN(amount) && amount >= 0) ? { 
                name: nameInput, 
                amount: amount, 
                unit: (unitText === currentUnit || !unitText) ? null : unitText
            } : null;
        }).filter(Boolean);

        if (ingredients.length === 0) {
            alert('æœ‰åŠ¹ãªææ–™ã‚’1ã¤ä»¥ä¸Šå…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
            return null;
        }
        
        return { 
            name, 
            ingredients, 
            servings: servings < 1 ? 1 : servings, // 1æœªæº€ã¯1ã¨ã—ã¦ä¿å­˜
            unitPreference: currentUnit 
        };
    }

    function saveRecipe() {
        const newRecipeData = getRecipeDataFromForm();
        if (!newRecipeData) return;
        
        const newRecipe = { id: `recipe_${Date.now()}`, ...newRecipeData }; 
        recipes.push(newRecipe);
        saveRecipesToStorage();
        renderRecipeList();
        selectRecipe(newRecipe.id);
        recipeSelectEl.value = newRecipe.id;
        alert('ãƒ¬ã‚·ãƒ”ãŒä¿å­˜ã•ã‚Œã¾ã—ãŸã€‚');
    }

    function updateRecipe() {
        if (!currentRecipeId) return;
        const updatedData = getRecipeDataFromForm();
        if (!updatedData) return;
        
        const recipeIndex = recipes.findIndex(r => r.id === currentRecipeId);
        if (recipeIndex > -1) {
            recipes[recipeIndex] = { ...recipes[recipeIndex], ...updatedData };
            saveRecipesToStorage();
            renderRecipeList();
            alert('ãƒ¬ã‚·ãƒ”ãŒæ›´æ–°ã•ã‚Œã¾ã—ãŸã€‚');
        }
    }

    function deleteRecipe() {
        if (!currentRecipeId) return;
        const recipe = recipes.find(r => r.id === currentRecipeId);
        if (confirm(`ã€Œ${recipe.name}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
            recipes = recipes.filter(r => r.id !== currentRecipeId);
            saveRecipesToStorage();
            renderRecipeList();
            clearForm();
        }
    }

    // --- 6. è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ ---
    
    function autoSelectBaseIngredient() {
        let maxAmountInG = -1;
        let baseItem = null;
        const allItems = ingredientsListEl.querySelectorAll('.ingredient-item');

        allItems.forEach(li => {
            li.classList.remove('is-base');
            li.querySelector('input[type="radio"]').checked = false;
        });

        allItems.forEach(item => {
            const amountInG = parseFloat(item.dataset.amountInG || '0');
            if (item.querySelector('.name-input').value.trim() && amountInG > maxAmountInG) {
                maxAmountInG = amountInG;
                baseItem = item;
            }
        });

        if (baseItem && maxAmountInG > 0) {
            const radio = baseItem.querySelector('input[type="radio"]');
            radio.checked = true;
            baseItem.classList.add('is-base');
            
            const divider = currentUnit === 'kg' ? 1000 : 1;
            const precision = parseInt(precisionSelectEl.value, 10);
            scaleAmountEl.value = (maxAmountInG / divider).toFixed(precision);
        } else {
             scaleAmountEl.value = '';
        }
    }
    
    function scaleIngredientsByServings() {
        // å…¥åŠ›ãŒç©ºæ¬„ã®å ´åˆã¯ã€0ã¨ã—ã¦æ‰±ã„ã€è¨ˆç®—æ™‚ã«ã¯1ã‚’ä»£å…¥ã™ã‚‹
        const inputServings = parseFloat(servingsEl.value);
        const servings = isNaN(inputServings) || inputServings <= 0 ? 1 : inputServings;

        ingredientsListEl.querySelectorAll('.ingredient-item').forEach(item => {
            const baseAmountInG = parseFloat(item.dataset.baseAmountInG || '0');
            if (!isNaN(baseAmountInG)) {
                const newAmountInG = baseAmountInG * servings;
                item.dataset.amountInG = newAmountInG;
            }
        });
        
        // setUnitã®ç¬¬2å¼•æ•°ï¼ˆskipInputUpdateï¼‰ã‚’çœç•¥ã™ã‚‹ã“ã¨ã§ã€UIã®åˆ†é‡ãŒç¢ºå®Ÿã«æ›´æ–°ã•ã‚Œã‚‹
        setUnit(currentUnit); 
        autoSelectBaseIngredient();
    }

    function setUnit(unit, skipInputUpdate = false) {
        currentUnit = unit;
        scaleUnitEl.textContent = unit;
        totalAmountUnitEl.textContent = unit;
        totalUnitLabelEl.textContent = unit;
        unit === 'g' ? (unitGRadio.checked = true) : (unitKgRadio.checked = true);
        
        const divider = unit === 'kg' ? 1000 : 1;
        const precision = parseInt(precisionSelectEl.value, 10); 
        
        ingredientsListEl.querySelectorAll('.ingredient-item').forEach(item => {
            const amountInG = parseFloat(item.dataset.amountInG || '0');
            const input = item.querySelector('.amount-input');
            const unitInput = item.querySelector('.unit-input');

            if (!skipInputUpdate) {
                input.value = (amountInG / divider).toFixed(precision);
            }
     
            if (!item.dataset.customUnit || item.dataset.customUnit === 'false' || unitInput.value === 'g' || unitInput.value === 'kg') {
                unitInput.value = unit;
                item.dataset.customUnit = 'false'; 
            }
        });
        
        const baseItem = ingredientsListEl.querySelector('.ingredient-item.is-base');
        if (baseItem) {
            const amountInG = parseFloat(baseItem.dataset.amountInG || '0');
            scaleAmountEl.value = (amountInG / divider).toFixed(precision);
        } else if (scaleAmountEl.value) {
            scaleAmountEl.value = '';
        }

        updateTotalsAndRatios();
    }

    function calculateFromSingleIngredient() {
        const scaleAmount = parseFloat(scaleAmountEl.value);
        if (isNaN(scaleAmount) || scaleAmount <= 0) return;

        let baseItem = ingredientsListEl.querySelector('input[name=baseIngredient]:checked')?.closest('.ingredient-item');
        if (!baseItem) {
            alert('åŸºæº–ã«ã™ã‚‹ææ–™ã‚’ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ã§é¸æŠã—ã¦ãã ã•ã„ã€‚');
            return;
        }
        
        const baseAmountInG = parseFloat(baseItem.dataset.amountInG);
        if (isNaN(baseAmountInG) || baseAmountInG === 0) {
            alert('åŸºæº–ææ–™ã®åˆ†é‡ãŒ0ã®ãŸã‚ã€æ¯”ç‡ã‚’è¨ˆç®—ã§ãã¾ã›ã‚“ã€‚');
            return;
        }

        const multiplier = currentUnit === 'kg' ? 1000 : 1;
        const scale = (scaleAmount * multiplier) / baseAmountInG;
        const inputServings = parseFloat(servingsEl.value);
        const servings = isNaN(inputServings) || inputServings <= 0 ? 1 : inputServings;

        ingredientsListEl.querySelectorAll('.ingredient-item').forEach(item => {
            const originalAmountInG = parseFloat(item.dataset.amountInG || '0');
            if (!isNaN(originalAmountInG)) {
                const newAmountInG = originalAmountInG * scale;
                item.dataset.amountInG = newAmountInG;
                item.dataset.baseAmountInG = newAmountInG / servings;
            }
        });

        setUnit(currentUnit);
    }

    function scaleFromTotal() {
        const desiredTotal = parseFloat(desiredTotalAmountEl.value);
        if (isNaN(desiredTotal) || desiredTotal <= 0) {
            alert('æœ‰åŠ¹ãªç›®æ¨™åˆè¨ˆé‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
            return;
        }

        let currentTotalInG = 0;
        const items = Array.from(ingredientsListEl.querySelectorAll('.ingredient-item'));
        items.forEach(item => {
            const amountInG = parseFloat(item.dataset.amountInG || '0');
            if (!isNaN(amountInG)) {
                currentTotalInG += amountInG;
            }
        });
        
        if (currentTotalInG === 0) {
            alert('ç¾åœ¨ã®åˆè¨ˆãŒ0ã®ãŸã‚ã€æ¯”ç‡ã‚’è¨ˆç®—ã§ãã¾ã›ã‚“ã€‚æœ‰åŠ¹ãªææ–™ãŒã‚ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
            return;
        }

        const multiplier = currentUnit === 'kg' ? 1000 : 1;
        const scale = (desiredTotal * multiplier) / currentTotalInG;
        const inputServings = parseFloat(servingsEl.value);
        const servings = isNaN(inputServings) || inputServings <= 0 ? 1 : inputServings;

        items.forEach(item => {
            const originalAmountInG = parseFloat(item.dataset.amountInG || '0');
            if (!isNaN(originalAmountInG)) {
                const newAmountInG = originalAmountInG * scale;
                item.dataset.amountInG = newAmountInG;
                item.dataset.baseAmountInG = newAmountInG / servings;
            }
        });

        setUnit(currentUnit);
    }

    function updateTotalsAndRatios() {
        let totalAmountInG = 0;
        const amountsInG = [];
        ingredientsListEl.querySelectorAll('.ingredient-item').forEach(item => {
            const amount = parseFloat(item.dataset.amountInG || '0');
            if (!isNaN(amount)) {
                totalAmountInG += amount;
                amountsInG.push(amount);
            } else {
                amountsInG.push(0);
            }
        });
        
        const divider = currentUnit === 'kg' ? 1000 : 1;
        const precision = parseInt(precisionSelectEl.value, 10);

        totalAmountValueEl.textContent = (totalAmountInG / divider).toFixed(precision);
        
        ingredientsListEl.querySelectorAll('.ratio-display').forEach((display, index) => {
            const ratio = totalAmountInG > 0 ? (amountsInG[index] / totalAmountInG) * 100 : 0;
            display.textContent = `(${ratio.toFixed(1)}%)`;
        });
    }

    // --- 7. CSV I/O ---
    function exportRecipesToCsv() {
        if (recipes.length === 0) {
            alert('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹ãƒ¬ã‚·ãƒ”ãŒã‚ã‚Šã¾ã›ã‚“ã€‚');
            return;
        }

        let csv = 'ãƒ¬ã‚·ãƒ”å,ææ–™å,åˆ†é‡(g),ã‚«ã‚¹ã‚¿ãƒ å˜ä½\n'; 
        
        recipes.forEach(recipe => {
            recipe.ingredients.forEach(ing => {
                const recipeName = `"${recipe.name.replace(/"/g, '""')}"`;
                const ingredientName = `"${ing.name.replace(/"/g, '""')}"`;
                const amountG = ing.amount.toString(); 
                const unit = ing.unit || '';
                const customUnit = `"${unit.replace(/"/g, '""')}"`;
                csv += `${recipeName},${ingredientName},${amountG},${customUnit}\n`;
            });
        });
        const bom = new Uint8Array([0xEF, 0xBB, 0xBF]);
        const blob = new Blob([bom, csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = 'recipes_data.csv';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    function importRecipesFromCsv(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = e => {
            try {
                const text = e.target.result;
                const lines = text.split(/\r?\n/).filter(line => line.trim() !== '');

                if (lines.length < 2) {
                    alert('CSVãƒ•ã‚¡ã‚¤ãƒ«ã«æœ‰åŠ¹ãªãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚');
                    return;
                }

                const header = lines[0].replace(/"/g, '');
                if (!header.includes('ãƒ¬ã‚·ãƒ”å') || !header.includes('ææ–™å') || !header.includes('åˆ†é‡(g)')) {
                     alert('CSVãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ˜ãƒƒãƒ€ãƒ¼ãŒä¸æ­£ã§ã™ã€‚1è¡Œç›®ã«ã¯ã€Œãƒ¬ã‚·ãƒ”å,ææ–™å,åˆ†é‡(g)ã€ãŒå«ã¾ã‚Œã¦ã„ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚');
                     return;
                }
                
                const dataLines = lines.slice(1);
                const groupedRecipes = {};

                dataLines.forEach(line => {
                    const row = parseCsvLine(line);
                    if (row.length < 3) return;

                    const recipeName = row[0].trim();
                    const ingredientName = row[1].trim();
                    const amountG = parseFloat(row[2].trim());
                    const unit = row.length > 3 ? row[3].trim() : null; 

                    if (recipeName && ingredientName && !isNaN(amountG) && amountG >= 0) {
                        if (!groupedRecipes[recipeName]) {
                            groupedRecipes[recipeName] = { 
                                id: `recipe_${Date.now()}_${Object.keys(groupedRecipes).length}`, 
                                name: recipeName, 
                                ingredients: [],
                                servings: 1,
                                unitPreference: 'g'
                            };
                        }
                        groupedRecipes[recipeName].ingredients.push({ name: ingredientName, amount: amountG, unit: unit || null });
                    }
                });
                const importedRecipes = Object.values(groupedRecipes);

                if (importedRecipes.length === 0) {
                    alert('CSVãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰æœ‰åŠ¹ãªãƒ¬ã‚·ãƒ”ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚ã¾ã›ã‚“ã§ã—ãŸã€‚ãƒ¬ã‚·ãƒ”åã€ææ–™åã€åˆ†é‡(g)ãŒå«ã¾ã‚Œã¦ã„ã‚‹è¡Œã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
                    return;
                }

                if (confirm(`${importedRecipes.length}ä»¶ã®ãƒ¬ã‚·ãƒ”ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã™ã€‚ç¾åœ¨ã®å…¨ãƒ¬ã‚·ãƒ”ã‚’ä¸Šæ›¸ãã—ã¾ã™ãŒã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ`)) {
                    recipes = importedRecipes;
                    saveRecipesToStorage();
                    clearForm();
                    renderRecipeList();
                    alert(`${recipes.length}ä»¶ã®ãƒ¬ã‚·ãƒ”ã‚’CSVã‹ã‚‰ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸã€‚`);
                }
            } catch (error) {
                alert(`CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆå¤±æ•—: ãƒ‡ãƒ¼ã‚¿è§£æä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚\n${error.message}`);
                console.error(error);
            } finally {
                importFileEl.value = '';
            }
        };
        reader.readAsText(file, 'UTF-8');
    }

    function parseCsvLine(text) {
        const result = [];
        let inQuotes = false;
        let currentField = '';
        
        for (let i = 0; i < text.length; i++) {
            const char = text[i];
            if (char === '"') {
                if (inQuotes && text[i + 1] === '"') {
                    currentField += '"';
                    i++;
                } else {
                    inQuotes = !inQuotes;
                }
            } else if (char === ',' && !inQuotes) {
                result.push(currentField);
                currentField = '';
            } else {
                currentField += char;
            }
        }
        result.push(currentField);
        return result.map(field => field.replace(/^"|"$/g, '').trim());
    }

    // --- 8. ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆ ---
    function generateSampleRecipes() {
        return [
          { 
              "id": "recipe_01", 
              "name": "è‚‰ã˜ã‚ƒãŒ (4äººå‰ãƒ™ãƒ¼ã‚¹)", 
              "servings": 4, 
              "unitPreference": "g",
              "ingredients": [ 
                  { "name": "ã˜ã‚ƒãŒã„ã‚‚", "amount": 75 },
                  { "name": "ç‰›è‚‰", "amount": 50 },
                  { "name": "ç‰ã­ã", "amount": 37.5 },
                  { "name": "äººå‚", "amount": 25 },
                  { "name": "é†¤æ²¹", "amount": 11.25 },
                  { "name": "ã ã—æ±", "amount": 50 }
              ] 
          },
          { 
              "id": "recipe_02", 
              "name": "ãƒšãƒšãƒ­ãƒ³ãƒãƒ¼ãƒ (2äººå‰ãƒ™ãƒ¼ã‚¹)", 
              "servings": 2, 
              "unitPreference": "g",
              "ingredients": [ 
                  { "name": "ã‚¹ãƒ‘ã‚²ãƒƒãƒ†ã‚£", "amount": 100 },
                  { "name": "ã‚ªãƒªãƒ¼ãƒ–ã‚ªã‚¤ãƒ«", "amount": 25, "unit": "cc" },
                  { "name": "ã«ã‚“ã«ã", "amount": 5 }, 
                  { "name": "é·¹ã®çˆª", "amount": 0.5, "unit": "å€‹" },
                  { "name": "å¡©", "amount": 2.5 } 
              ] 
          },
          { 
              "id": "recipe_03", 
              "name": "å‘³å™Œæ± (2äººå‰ãƒ™ãƒ¼ã‚¹)", 
              "servings": 2, 
              "unitPreference": "g",
              "ingredients": [ 
                  { "name": "ã ã—æ±", "amount": 300 },
                  { "name": "å‘³å™Œ", "amount": 20 }, 
                  { "name": "è±†è…", "amount": 50 }, 
                  { "name": "ã‚ã‹ã‚(ä¹¾ç‡¥)", "amount": 2.5 }, 
                  { "name": "é•·ãƒã‚®", "amount": 10 } 
              ] 
          }
        ];
    }
    </script>
</body>
</html>
