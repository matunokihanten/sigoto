<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ¬ã‚·ãƒ”åˆ†é‡è¨ˆç®—ã‚¢ãƒ—ãƒª</title>
    <style>
        /* --- åŸºæœ¬è¨­å®š --- */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f7f9;
            color: #333;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            padding-top: 20px;
        }
        .app-container {
            display: flex;
            width: 90%;
            max-width: 1200px;
            background-color: #fff;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            overflow: hidden;
            min-height: 700px; /* ã‚ã‚‹ç¨‹åº¦ã®é«˜ã•ã‚’ç¢ºä¿ */
        }
        
        /* --- ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆåˆ†å‰² --- */
        #recipeListContainer {
            width: 300px;
            border-right: 1px solid #eee;
            background-color: #ecf0f1;
            padding: 20px 0;
            overflow-y: auto;
        }
        #recipeFormContainer {
            flex-grow: 1;
            padding: 20px;
            overflow-y: auto;
        }

        /* --- ãƒ¬ã‚·ãƒ”ãƒªã‚¹ãƒˆ --- */
        .list-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px 10px;
            border-bottom: 1px solid #ddd;
            margin-bottom: 10px;
        }
        #recipeList {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        #recipeList li {
            padding: 12px 20px;
            cursor: pointer;
            transition: background-color 0.2s;
            border-bottom: 1px dotted #ddd;
            user-select: none;
        }
        #recipeList li:hover {
            background-color: #e0e6e9;
        }
        #recipeList li.selected {
            background-color: #3498db;
            color: white;
            font-weight: bold;
        }
        
        /* --- ãƒ•ã‚©ãƒ¼ãƒ ã¨ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« --- */
        .form-section {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            background-color: #fafafa;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #2c3e50;
        }
        input[type="text"], input[type="number"], .ingredient-item input {
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 16px;
        }
        #recipeName {
            width: calc(100% - 20px);
            margin-bottom: 15px;
        }
        
        /* --- ãƒœã‚¿ãƒ³ --- */
        button {
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.2s, opacity 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            font-size: 16px;
        }
        .primary {
            background-color: #2ecc71;
            color: white;
        }
        .primary:hover {
            background-color: #27ae60;
        }
        .secondary {
            background-color: #3498db;
            color: white;
        }
        .secondary:hover {
            background-color: #2980b9;
        }
        .danger {
            background-color: #e74c3c;
            color: white;
            font-size: 1em;
            padding: 5px 8px;
            margin-left: 5px;
        }
        .danger:hover {
            background-color: #c0392b;
        }
        .control-group button {
            margin-right: 10px;
        }

        /* --- ææ–™ãƒªã‚¹ãƒˆ --- */
        #ingredientsList {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .ingredient-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
            padding: 5px;
            border-bottom: 1px dashed #eee;
        }
        .ingredient-item input[type="radio"] {
            margin-right: 5px;
            cursor: pointer;
            transform: scale(1.2);
        }
        .ingredient-item .name-input {
            flex: 4;
        }
        .ingredient-item .amount-input {
            flex: 2;
            text-align: right;
            -moz-appearance: textfield; /* Firefoxã§çŸ¢å°ã‚’éè¡¨ç¤º */
        }
        .ingredient-item .amount-input::-webkit-outer-spin-button,
        .ingredient-item .amount-input::-webkit-inner-spin-button {
            -webkit-appearance: none; /* Chrome, Safariã§çŸ¢å°ã‚’éè¡¨ç¤º */
            margin: 0;
        }
        .ingredient-item .unit-label, .ingredient-item .ratio-display {
            flex: 1;
            text-align: left;
            white-space: nowrap;
        }
        .ingredient-item .ratio-display {
            font-size: 0.9em;
            color: #7f8c8d;
        }
        .ingredients-header {
            display: flex;
            gap: 10px;
            align-items: center;
            justify-content: flex-end;
            padding-right: 10px;
            margin-bottom: 5px;
        }
        
        /* --- ã‚¹ã‚±ãƒ¼ãƒ«ã¨åˆè¨ˆ --- */
        .scale-control, .total-control {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .scale-control input[type="number"], .total-control input[type="number"] {
            width: 80px;
            text-align: right;
        }
        .total-display {
            font-size: 1.2em;
            font-weight: bold;
            color: #2980b9;
        }
        .unit-radio-group {
            display: flex;
            gap: 15px;
            align-items: center;
        }
        .unit-radio-group label {
            display: inline-flex;
            align-items: center;
            margin-bottom: 0;
            font-weight: normal;
        }

        /* --- ãƒ¢ãƒã‚¤ãƒ«å¯¾å¿œ --- */
        @media (max-width: 768px) {
            body {
                padding-top: 0;
            }
            .app-container {
                width: 100%;
                min-height: 100vh;
                border-radius: 0;
                box-shadow: none;
                flex-direction: column;
            }
            
            #recipeListContainer, #recipeFormContainer {
                width: 100%;
                padding: 10px;
                border-right: none;
                border-bottom: 1px solid #eee;
                box-sizing: border-box;
            }
            
            #recipeFormContainer {
                display: none; /* åˆæœŸã¯ãƒ•ã‚©ãƒ¼ãƒ ã‚’éš ã™ */
            }

            .app-container.form-visible #recipeListContainer {
                display: none; /* ãƒ•ã‚©ãƒ¼ãƒ è¡¨ç¤ºæ™‚ã¯ãƒªã‚¹ãƒˆã‚’éš ã™ */
            }
            .app-container.form-visible #recipeFormContainer {
                display: block; /* ãƒ•ã‚©ãƒ¼ãƒ è¡¨ç¤ºæ™‚ã¯ãƒ•ã‚©ãƒ¼ãƒ ã‚’è¦‹ã›ã‚‹ */
            }

            .list-header {
                padding: 0 10px 10px;
            }

            .ingredient-item {
                flex-wrap: wrap;
                gap: 5px;
            }
            .ingredient-item input[type="radio"] {
                order: 1;
            }
            .ingredient-item .name-input {
                order: 2;
                flex: 1 1 70%;
            }
            .ingredient-item .amount-input {
                order: 3;
                flex: 1 1 30%;
            }
            .ingredient-item .unit-label {
                order: 4;
            }
            .ingredient-item .ratio-display {
                order: 5;
                flex: 1 1 100%;
                text-align: right;
                padding-right: 5px;
            }
            .ingredient-item .danger {
                order: 6;
            }

            .scale-control, .total-control {
                flex-wrap: wrap;
            }
            .scale-control input[type="number"], .total-control input[type="number"] {
                width: 100px;
            }
            .mobile-controls {
                display: flex;
                justify-content: space-between;
                margin-bottom: 10px;
            }
        }
        
        /* --- ãã®ä»–ã®ã‚¹ã‚¿ã‚¤ãƒ« --- */
        #backToListBtn, .mobile-controls {
            display: none;
        }
        @media (max-width: 768px) {
            .app-container.form-visible #backToListBtn {
                display: inline-flex;
            }
            .mobile-controls {
                display: flex;
            }
        }
        .control-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        .io-controls {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div id="recipeListContainer">
            <div class="list-header">
                <h2>ãƒ¬ã‚·ãƒ”ä¸€è¦§</h2>
                <button id="newRecipeBtn" class="primary">ğŸ“ æ–°è¦ä½œæˆ</button>
            </div>
            <ul id="recipeList">
                </ul>
        </div>

        <div id="recipeFormContainer">
            <div class="mobile-controls">
                <button id="backToListBtn" class="secondary">â—€ï¸ ä¸€è¦§ã«æˆ»ã‚‹</button>
                <button id="fullscreenBtn" class="secondary">ğŸŒ å…¨ç”»é¢</button>
            </div>

            <div class="form-section">
                <label for="recipeName">ãƒ¬ã‚·ãƒ”å</label>
                <input type="text" id="recipeName" placeholder="ä¾‹: è‚‰ã˜ã‚ƒãŒ" required>
            </div>
            
            <div class="form-section">
                <h3>ææ–™ã¨åˆ†é‡</h3>
                <div class="unit-radio-group">
                    <input type="radio" id="unitG" name="unit" value="g" checked>
                    <label for="unitG">ã‚°ãƒ©ãƒ  (g)</label>
                    <input type="radio" id="unitKg" name="unit" value="kg">
                    <label for="unitKg">ã‚­ãƒ­ã‚°ãƒ©ãƒ  (kg)</label>
                </div>
                
                <div class="ingredients-header">
                    <button id="addIngredient" class="secondary">â• ææ–™è¿½åŠ </button>
                </div>
                
                <ul id="ingredientsList">
                    </ul>
            </div>

            <div class="form-section">
                <h3>åˆ†é‡è¨ˆç®— (åŸºæº–ææ–™ã‹ã‚‰)</h3>
                <div class="scale-control">
                    <label>åŸºæº–é‡:</label>
                    <input type="number" id="scaleAmount" min="0" placeholder="0">
                    <span id="scaleUnit">g</span>
                    <button onclick="calculateFromSingleIngredient()" class="secondary">ğŸ”„ åŸºæº–é‡ã‹ã‚‰è¨ˆç®—</button>
                </div>
                <p style="font-size:0.9em; color:#7f8c8d; margin-top:5px;">â€»ææ–™æ¨ªã®ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ã§åŸºæº–ææ–™ã‚’é¸æŠã—ã¦ã‹ã‚‰ã€åŸºæº–é‡ã‚’å…¥åŠ›ãƒ»è¨ˆç®—ã—ã¦ãã ã•ã„ã€‚</p>
            </div>

            <div class="form-section">
                <h3>åˆ†é‡è¨ˆç®— (åˆè¨ˆé‡ã‹ã‚‰)</h3>
                <div class="total-control">
                    <label>ç¾åœ¨ã®åˆè¨ˆ:</label>
                    <span class="total-display"><span id="totalAmountValue">0</span><span id="totalAmountUnit">g</span></span>
                </div>
                <div class="total-control" style="margin-top: 10px;">
                    <label>ç›®æ¨™åˆè¨ˆé‡:</label>
                    <input type="number" id="desiredTotalAmount" min="0" placeholder="0">
                    <span id="totalUnitLabel">g</span>
                    <button id="scaleFromTotalBtn" class="secondary">ğŸ¯ åˆè¨ˆé‡ã‹ã‚‰è¨ˆç®—</button>
                </div>
                <p style="font-size:0.9em; color:#7f8c8d; margin-top:5px;">â€»ç›®æ¨™åˆè¨ˆé‡ã‚’å…¥åŠ›ã—ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨å…¨ææ–™ã®åˆ†é‡ãŒèª¿æ•´ã•ã‚Œã¾ã™ã€‚</p>
            </div>

            <div class="control-group">
                <button id="saveBtn" class="primary">ğŸ’¾ ä¿å­˜</button>
                <button id="updateBtn" class="primary" style="display:none;">âœ”ï¸ æ›´æ–°</button>
                <button id="deleteBtn" class="danger" style="display:none;">ğŸ—‘ï¸ å‰Šé™¤</button>
            </div>

            <div class="io-controls">
                <button id="exportBtn" class="secondary">ğŸ“¤ ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
                <button id="importBtn" class="secondary">ğŸ“¥ ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
                <input type="file" id="importFile" accept=".json" style="display:none;">
            </div>
        </div>
    </div>

    <script>
    // --- ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã¨DOMè¦ç´  ---
    const RECIPES_STORAGE_KEY = 'recipesv1all_improved';
    let recipes = [];
    let currentRecipeId = null;
    let currentUnit = 'g';

    const appContainer = document.querySelector('.app-container');
    const recipeListEl = document.getElementById('recipeList');
    const newRecipeBtn = document.getElementById('newRecipeBtn');
    const recipeNameEl = document.getElementById('recipeName');
    const ingredientsListEl = document.getElementById('ingredientsList');
    const addIngredientBtn = document.getElementById('addIngredient');
    const saveBtn = document.getElementById('saveBtn');
    const updateBtn = document.getElementById('updateBtn');
    const deleteBtn = document.getElementById('deleteBtn');
    const scaleAmountEl = document.getElementById('scaleAmount');
    const scaleUnitEl = document.getElementById('scaleUnit');
    const unitGRadio = document.getElementById('unitG');
    const unitKgRadio = document.getElementById('unitKg');
    const exportBtn = document.getElementById('exportBtn');
    const importBtn = document.getElementById('importBtn');
    const importFileEl = document.getElementById('importFile');
    const totalAmountValueEl = document.getElementById('totalAmountValue');
    const totalAmountUnitEl = document.getElementById('totalAmountUnit');
    const desiredTotalAmountEl = document.getElementById('desiredTotalAmount');
    const scaleFromTotalBtn = document.getElementById('scaleFromTotalBtn');
    const fullscreenBtn = document.getElementById('fullscreenBtn');
    const backToListBtn = document.getElementById('backToListBtn');
    const totalUnitLabelEl = document.getElementById('totalUnitLabel'); // ç›®æ¨™åˆè¨ˆé‡ã®å˜ä½ãƒ©ãƒ™ãƒ«

    // --- åˆæœŸåŒ–å‡¦ç† ---
    document.addEventListener('DOMContentLoaded', () => {
        loadRecipes();
        renderRecipeList();
        setupEventListeners();
        clearForm();
        // åˆæœŸè¡¨ç¤ºã§ã¯ãƒ•ã‚©ãƒ¼ãƒ ã‚’éš ã™ï¼ˆã‚¹ãƒãƒ›è€ƒæ…®ï¼‰
        if (window.innerWidth <= 768) {
            showListView();
        }
    });

    // --- ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š ---
    function setupEventListeners() {
        recipeListEl.addEventListener('click', e => {
            if (e.target.tagName === 'LI' && e.target.dataset.id) { // ãƒ‡ãƒ¼ã‚¿IDãŒã‚ã‚‹å ´åˆã®ã¿
                selectRecipe(e.target.dataset.id);
            }
        });
        newRecipeBtn.addEventListener('click', () => {
            clearForm();
            showFormView();
        });
        // â˜…ãƒã‚°ä¿®æ­£: ææ–™è¿½åŠ ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ãŒãªã‹ã£ãŸã®ã‚’è¿½åŠ 
        addIngredientBtn.addEventListener('click', () => addIngredientRow({ name: '', amount: 0 }, true));

        saveBtn.addEventListener('click', saveRecipe);
        updateBtn.addEventListener('click', updateRecipe);
        deleteBtn.addEventListener('click', deleteRecipe);
        unitGRadio.addEventListener('change', () => setUnit('g'));
        unitKgRadio.addEventListener('change', () => setUnit('kg'));
        scaleAmountEl.addEventListener('input', calculateFromSingleIngredient);
        scaleFromTotalBtn.addEventListener('click', scaleFromTotal);
        fullscreenBtn.addEventListener('click', toggleFullscreen);
        backToListBtn.addEventListener('click', showListView);

        // â˜…ãƒ­ã‚¸ãƒƒã‚¯æ”¹å–„: ææ–™ãƒªã‚¹ãƒˆå…¨ä½“ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
        ingredientsListEl.addEventListener('input', e => {
            const item = e.target.closest('.ingredient-item');
            if (!item) return;
            // åˆ†é‡ã®æ‰‹å…¥åŠ›ã§ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ã‚’æ›´æ–°
            if (e.target.classList.contains('amount-input')) {
                const amountValue = parseFloat(e.target.value) || 0;
                const multiplier = currentUnit === 'kg' ? 1000 : 1;
                item.dataset.amountInG = amountValue * multiplier;
                updateTotalsAndRatios();
            }
        });

        // â˜…UXæ”¹å–„: åŸºæº–ææ–™ã®ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯ã§åŸºæº–é‡ã‚’å…¥åŠ›æ¬„ã«ã‚»ãƒƒãƒˆ
        ingredientsListEl.addEventListener('click', e => {
            if (e.target.type === 'radio' && e.target.name === 'baseIngredient') {
                const item = e.target.closest('.ingredient-item');
                if (item) {
                    const amountInG = parseFloat(item.dataset.amountInG || '0');
                    const divider = currentUnit === 'kg' ? 1000 : 1;
                    scaleAmountEl.value = (amountInG / divider).toFixed(divider === 1000 ? 3 : 0);
                    scaleAmountEl.focus(); // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚’ç§»å‹•
                    calculateFromSingleIngredient(); // é¸æŠã—ãŸæ™‚ç‚¹ã§è¨ˆç®—å®Ÿè¡Œ
                }
            }
        });

        exportBtn.addEventListener('click', exportRecipes);
        importBtn.addEventListener('click', () => importFileEl.click());
        importFileEl.addEventListener('change', importRecipes);
    }

    // --- UIåˆ¶å¾¡ (ã‚¹ãƒãƒ›è¡¨ç¤ºå¯¾å¿œ) ---
    function showFormView() { appContainer.classList.add('form-visible'); }
    function showListView() { appContainer.classList.remove('form-visible'); }

    // --- ãƒ‡ãƒ¼ã‚¿ç®¡ç† ---
    function loadRecipes() {
        try {
            const storedRecipes = localStorage.getItem(RECIPES_STORAGE_KEY);
            recipes = storedRecipes ? JSON.parse(storedRecipes) : generateSampleRecipes();
        } catch (e) {
            console.error("Failed to load recipes from localStorage", e);
            recipes = generateSampleRecipes();
        }
        saveRecipesToStorage();
    }
    function saveRecipesToStorage() { localStorage.setItem(RECIPES_STORAGE_KEY, JSON.stringify(recipes)); }

    // --- UIæç”» ---
    function renderRecipeList() {
        recipeListEl.innerHTML = '';
        if (recipes.length === 0) {
            // â˜…UXæ”¹å–„: ãƒ¬ã‚·ãƒ”ãŒãªã„å ´åˆã®è¡¨ç¤º
            const li = document.createElement('li');
            li.textContent = 'ãƒ¬ã‚·ãƒ”ãŒã‚ã‚Šã¾ã›ã‚“ã€‚æ–°è¦ä½œæˆã—ã¦ãã ã•ã„ã€‚';
            li.style.color = '#7f8c8d';
            li.style.cursor = 'default';
            recipeListEl.appendChild(li);
            return;
        }

        recipes.sort((a, b) => a.name.localeCompare(b.name, 'ja')).forEach(recipe => {
            const li = document.createElement('li');
            li.textContent = recipe.name;
            li.dataset.id = recipe.id;
            if (recipe.id === currentRecipeId) li.classList.add('selected');
            recipeListEl.appendChild(li);
        });
    }

    function renderRecipeForm(recipe) {
        currentRecipeId = recipe.id;
        recipeNameEl.value = recipe.name;
        ingredientsListEl.innerHTML = '';
        recipe.ingredients.forEach(ing => addIngredientRow(ing));
        scaleAmountEl.value = '';
        desiredTotalAmountEl.value = '';
        updateFormState('edit');
        // â˜…ãƒ­ã‚¸ãƒƒã‚¯æ”¹å–„: æç”»å¾Œã«å˜ä½ã¨åˆè¨ˆã‚’æ­£ã—ãè¨­å®š
        setUnit(currentUnit);
    }

    // â˜…ãƒ­ã‚¸ãƒƒã‚¯æ”¹å–„ & UXæ”¹å–„: addIngredientRowã‚’ä¿®æ­£
    function addIngredientRow(ingredient = { name: '', amount: 0 }, focusAfterAdd = false) {
        const li = document.createElement('li');
        li.className = 'ingredient-item';
        // â˜…ãƒ­ã‚¸ãƒƒã‚¯æ”¹å–„: ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ã‚’ä¸€å…ƒåŒ– (data-amount-in-g)
        li.dataset.amountInG = ingredient.amount || '0';

        const radio = document.createElement('input'); radio.type = 'radio'; radio.name = 'baseIngredient'; radio.title = 'åŸºæº–ã«ã™ã‚‹';
        const nameInput = document.createElement('input'); nameInput.type = 'text'; nameInput.className = 'name-input'; nameInput.placeholder = 'ææ–™å'; nameInput.value = ingredient.name;
        const amountInput = document.createElement('input'); amountInput.type = 'number'; amountInput.className = 'amount-input'; amountInput.placeholder = 'åˆ†é‡'; amountInput.min = '0';
        // HTMLã®inputã‚¤ãƒ™ãƒ³ãƒˆã§data-amount-in-gã‚’æ›´æ–°ã™ã‚‹ãŸã‚ã€ã“ã“ã§ã¯å€¤ã¯è¨­å®šã—ãªã„ï¼ˆsetUnitã§è¨­å®šã•ã‚Œã‚‹ï¼‰

        const unitLabel = document.createElement('span'); unitLabel.className = 'unit-label';
        const ratioDisplay = document.createElement('span'); ratioDisplay.className = 'ratio-display';
        const removeBtn = document.createElement('button'); removeBtn.textContent = 'ğŸ—‘ï¸'; removeBtn.className = 'danger'; removeBtn.title = 'å‰Šé™¤';
        removeBtn.addEventListener('click', () => {
            li.remove();
            updateTotalsAndRatios();
        });

        li.append(radio, nameInput, amountInput, unitLabel, ratioDisplay, removeBtn);
        ingredientsListEl.appendChild(li);

        // â˜…UXæ”¹å–„: è¿½åŠ å¾Œã«ææ–™åå…¥åŠ›æ¬„ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹
        if (focusAfterAdd) {
            nameInput.focus();
        }
        
        // å˜ä½è¨­å®šã¨åˆè¨ˆè¨ˆç®—ã‚‚å¿˜ã‚Œãšã«
        setUnit(currentUnit, true); // trueã§åˆ†é‡å…¥åŠ›æ¬„ã‚’æ›´æ–°
    }

    function updateFormState(state) {
        saveBtn.style.display = state === 'new' ? 'inline-flex' : 'none';
        updateBtn.style.display = state === 'edit' ? 'inline-flex' : 'none';
        deleteBtn.style.display = state === 'edit' ? 'inline-flex' : 'none';
    }

    // --- ãƒ¬ã‚·ãƒ”æ“ä½œ ---
    function selectRecipe(recipeId) {
        const recipe = recipes.find(r => r.id === recipeId);
        if (recipe) {
            // ç¾åœ¨ã®å˜ä½ã‚’ä¿æŒ
            const savedUnit = currentUnit;
            currentRecipeId = recipeId;
            renderRecipeForm(recipe);
            setUnit(savedUnit); // ä»¥å‰ã®å˜ä½ã‚’å†è¨­å®š
            renderRecipeList(); // é¸æŠçŠ¶æ…‹ã‚’åæ˜ 
            showFormView();
        }
    }

    function clearForm() {
        currentRecipeId = null;
        recipeNameEl.value = '';
        ingredientsListEl.innerHTML = '';
        scaleAmountEl.value = '';
        desiredTotalAmountEl.value = '';
        // â˜…UXæ”¹å–„: æ–°è¦ä½œæˆæ™‚ã«3è¡Œã®å…¥åŠ›æ¬„ã‚’ç”¨æ„
        addIngredientRow({ name: '', amount: 0 }, true); // æœ€åˆã®è¡Œã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹
        addIngredientRow();
        addIngredientRow();
        updateFormState('new');
        setUnit('g'); // å˜ä½ã‚’gã«ãƒªã‚»ãƒƒãƒˆ
        const selected = recipeListEl.querySelector('.selected');
        if (selected) selected.classList.remove('selected');
        recipeNameEl.focus();
    }

    // â˜…ãƒ­ã‚¸ãƒƒã‚¯æ”¹å–„: getRecipeDataFromFormã‚’ä¿®æ­£
    function getRecipeDataFromForm() {
        const name = recipeNameEl.value.trim();
        if (!name) {
            alert('ãƒ¬ã‚·ãƒ”åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
            return null;
        }
        const ingredients = Array.from(ingredientsListEl.querySelectorAll('.ingredient-item')).map(item => {
            const nameInput = item.querySelector('.name-input').value.trim();
            // â˜…ãƒ­ã‚¸ãƒƒã‚¯æ”¹å–„: data-amount-in-gã‹ã‚‰å€¤ã‚’å–å¾—
            const amount = parseFloat(item.dataset.amountInG);
            return (nameInput && !isNaN(amount) && amount > 0) ? { name: nameInput, amount: amount } : null;
        }).filter(Boolean); // â˜…UXæ”¹å–„: ç©ºã®ææ–™ã¯ä¿å­˜ã—ãªã„

        if (ingredients.length === 0) {
            alert('æœ‰åŠ¹ãªææ–™ã‚’1ã¤ä»¥ä¸Šå…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
            return null;
        }
        return { name, ingredients };
    }

    function saveRecipe() {
        const newRecipeData = getRecipeDataFromForm();
        if (!newRecipeData) return;
        const newRecipe = { id: `recipe_${Date.now()}`, ...newRecipeData };
        recipes.push(newRecipe);
        saveRecipesToStorage();
        renderRecipeList();
        selectRecipe(newRecipe.id);
    }

    function updateRecipe() {
        if (!currentRecipeId) return;
        const updatedData = getRecipeDataFromForm();
        if (!updatedData) return;
        const recipeIndex = recipes.findIndex(r => r.id === currentRecipeId);
        if (recipeIndex > -1) {
            recipes[recipeIndex] = { ...recipes[recipeIndex], ...updatedData };
            saveRecipesToStorage();
            renderRecipeList();
            alert('ãƒ¬ã‚·ãƒ”ãŒæ›´æ–°ã•ã‚Œã¾ã—ãŸã€‚');
        }
    }

    function deleteRecipe() {
        if (!currentRecipeId) return;
        const recipe = recipes.find(r => r.id === currentRecipeId);
        if (confirm(`ã€Œ${recipe.name}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
            recipes = recipes.filter(r => r.id !== currentRecipeId);
            saveRecipesToStorage();
            renderRecipeList();
            clearForm();
            showListView();
        }
    }

    // --- è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ ---
    // â˜…ãƒ­ã‚¸ãƒƒã‚¯æ”¹å–„: setUnitã‚’ä¿®æ­£
    function setUnit(unit, skipInputUpdate = false) {
        currentUnit = unit;
        scaleUnitEl.textContent = unit;
        totalAmountUnitEl.textContent = unit;
        totalUnitLabelEl.textContent = unit; // ç›®æ¨™åˆè¨ˆé‡ã®å˜ä½ãƒ©ãƒ™ãƒ«ã‚‚æ›´æ–°
        unit === 'g' ? (unitGRadio.checked = true) : (unitKgRadio.checked = true);
        
        const divider = unit === 'kg' ? 1000 : 1;
        const precision = unit === 'kg' ? 3 : 0;

        ingredientsListEl.querySelectorAll('.ingredient-item').forEach(item => {
            const amountInG = parseFloat(item.dataset.amountInG || '0');
            const input = item.querySelector('.amount-input');
            
            // å˜ä½ãŒå¤‰ã‚ã£ãŸã¨ãã€ã¾ãŸã¯ææ–™ãŒè¿½åŠ ã•ã‚ŒãŸã¨ãã«åˆ†é‡å…¥åŠ›æ¬„ã‚’æ›´æ–°
            if (!skipInputUpdate) {
                input.value = (amountInG / divider).toFixed(precision);
            }
            item.querySelector('.unit-label').textContent = unit;
        });

        // åŸºæº–é‡å…¥åŠ›æ¬„ã‚‚ç¾åœ¨ã®å˜ä½ã«åˆã‚ã›ã¦æ›´æ–°
        const baseRadio = ingredientsListEl.querySelector('input[name=baseIngredient]:checked');
        if (baseRadio) { // é¸æŠã•ã‚Œã¦ã„ã‚‹å ´åˆã®ã¿
            const item = baseRadio.closest('.ingredient-item');
            const amountInG = parseFloat(item.dataset.amountInG || '0');
            scaleAmountEl.value = (amountInG / divider).toFixed(precision);
        } else if (scaleAmountEl.value) {
             // åŸºæº–ææ–™ãŒæœªé¸æŠã§ã‚‚ã€å˜ä½å¤‰æ›´æ™‚ã«å€¤ã¯è¡¨ç¤ºå˜ä½ã«å¤‰æ›
             // â€»ãŸã ã—ã€åŸºæº–ææ–™ãŒé¸ã°ã‚Œã¦ã„ãªã„ã¨è¨ˆç®—ã¯å®Ÿè¡Œã§ããªã„
            // ç°¡ç•¥åŒ–ã®ãŸã‚ã€ã“ã“ã§ã¯åŸºæº–ææ–™é¸æŠæ™‚ã®ã¿scaleAmountElã®å€¤ã‚’æ›´æ–°
            scaleAmountEl.value = '';
        }

        updateTotalsAndRatios();
    }

    // â˜…ãƒ­ã‚¸ãƒƒã‚¯æ”¹å–„: calculateFromSingleIngredientã‚’å…¨é¢çš„ã«æ›¸ãæ›ãˆ
    function calculateFromSingleIngredient() {
        const scaleAmount = parseFloat(scaleAmountEl.value);
        if (isNaN(scaleAmount) || scaleAmount <= 0) return; // 0ä»¥ä¸‹ã¯ç„¡è¦–

        let baseItem = ingredientsListEl.querySelector('input[name=baseIngredient]:checked')?.closest('.ingredient-item');
        if (!baseItem) {
            alert('åŸºæº–ã«ã™ã‚‹ææ–™ã‚’ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ã§é¸æŠã—ã¦ãã ã•ã„ã€‚');
            return;
        }
        
        const baseAmountInG = parseFloat(baseItem.dataset.amountInG);
        if (isNaN(baseAmountInG) || baseAmountInG === 0) {
            alert('åŸºæº–ææ–™ã®åˆ†é‡ãŒ0ã®ãŸã‚ã€æ¯”ç‡ã‚’è¨ˆç®—ã§ãã¾ã›ã‚“ã€‚');
            return;
        }

        const multiplier = currentUnit === 'kg' ? 1000 : 1;
        const scale = (scaleAmount * multiplier) / baseAmountInG;

        ingredientsListEl.querySelectorAll('.ingredient-item').forEach(item => {
            const originalAmountInG = parseFloat(item.dataset.amountInG || '0');
            if (!isNaN(originalAmountInG)) {
                const newAmountInG = originalAmountInG * scale;
                item.dataset.amountInG = newAmountInG; // ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ã‚’æ›´æ–°
            }
        });

        // è¡¨ç¤ºã‚’æ›´æ–°
        setUnit(currentUnit);
    }

    // â˜…ãƒ­ã‚¸ãƒƒã‚¯æ”¹å–„: scaleFromTotalã‚’å…¨é¢çš„ã«æ›¸ãæ›ãˆ
    function scaleFromTotal() {
        const desiredTotal = parseFloat(desiredTotalAmountEl.value);
        if (isNaN(desiredTotal) || desiredTotal <= 0) {
            alert('æœ‰åŠ¹ãªç›®æ¨™åˆè¨ˆé‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
            return;
        }

        let currentTotalInG = 0;
        const items = Array.from(ingredientsListEl.querySelectorAll('.ingredient-item'));
        items.forEach(item => {
            const amountInG = parseFloat(item.dataset.amountInG || '0');
            if (!isNaN(amountInG)) {
                currentTotalInG += amountInG;
            }
        });

        if (currentTotalInG === 0) {
            alert('ç¾åœ¨ã®åˆè¨ˆãŒ0ã®ãŸã‚ã€æ¯”ç‡ã‚’è¨ˆç®—ã§ãã¾ã›ã‚“ã€‚');
            return;
        }

        const multiplier = currentUnit === 'kg' ? 1000 : 1;
        const scale = (desiredTotal * multiplier) / currentTotalInG;

        items.forEach(item => {
            const originalAmountInG = parseFloat(item.dataset.amountInG || '0');
            if (!isNaN(originalAmountInG)) {
                const newAmountInG = originalAmountInG * scale;
                item.dataset.amountInG = newAmountInG; // ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ã‚’æ›´æ–°
            }
        });

        // è¡¨ç¤ºã‚’æ›´æ–°
        setUnit(currentUnit);
    }

    // â˜…ãƒ­ã‚¸ãƒƒã‚¯æ”¹å–„: updateTotalsAndRatiosã‚’ä¿®æ­£
    function updateTotalsAndRatios() {
        let totalAmountInG = 0;
        const amountsInG = [];
        ingredientsListEl.querySelectorAll('.ingredient-item').forEach(item => {
            const amount = parseFloat(item.dataset.amountInG || '0');
            if (!isNaN(amount)) {
                totalAmountInG += amount;
                amountsInG.push(amount);
            } else {
                amountsInG.push(0);
            }
        });

        const divider = currentUnit === 'kg' ? 1000 : 1;
        totalAmountValueEl.textContent = (totalAmountInG / divider).toFixed(divider === 1000 ? 3 : 0);

        ingredientsListEl.querySelectorAll('.ratio-display').forEach((display, index) => {
            const ratio = totalAmountInG > 0 ? (amountsInG[index] / totalAmountInG) * 100 : 0;
            display.textContent = `(${ratio.toFixed(1)}%)`;
        });
    }

    // --- å…¨ç”»é¢è¡¨ç¤º ---
    function toggleFullscreen() {
        if (!document.fullscreenElement) {
            document.documentElement.requestFullscreen().catch(err => alert(`å…¨ç”»é¢è¡¨ç¤ºã«ã§ãã¾ã›ã‚“ã§ã—ãŸ: ${err.message}`));
        } else {
            if (document.exitFullscreen) document.exitFullscreen();
        }
    }

    // --- ã‚¤ãƒ³ãƒãƒ¼ãƒˆ/ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ ---
    function exportRecipes() {
        if (recipes.length === 0) {
            alert('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹ãƒ¬ã‚·ãƒ”ãŒã‚ã‚Šã¾ã›ã‚“ã€‚');
            return;
        }
        const dataStr = JSON.stringify(recipes, null, 2);
        const blob = new Blob([dataStr], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'recipes_backup.json';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }

    function importRecipes(event) {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = e => {
            try {
                const data = JSON.parse(e.target.result);
                if (!Array.isArray(data) || !data.every(item => item.id && item.name && Array.isArray(item.ingredients))) {
                    throw new Error('JSONã®ãƒ‡ãƒ¼ã‚¿æ§‹é€ ãŒä¸æ­£ã§ã™ã€‚');
                }
                if (confirm('ç¾åœ¨ã®å…¨ãƒ¬ã‚·ãƒ”ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ãŸãƒ‡ãƒ¼ã‚¿ã§ä¸Šæ›¸ãã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) {
                    recipes = data;
                    saveRecipesToStorage();
                    clearForm();
                    renderRecipeList();
                    showListView();
                    alert(`${recipes.length}ä»¶ã®ãƒ¬ã‚·ãƒ”ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸã€‚`);
                }
            } catch (error) {
                alert(`ã‚¤ãƒ³ãƒãƒ¼ãƒˆå¤±æ•—: ${error.message}`);
            } finally {
                importFileEl.value = '';
            }
        };
        reader.readAsText(file);
    }

    // --- ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ ---
    function generateSampleRecipes() {
        return [
            { id: "sample_1", name: "è‚‰ã˜ã‚ƒãŒ", ingredients: [ { name: "ã˜ã‚ƒãŒã„ã‚‚", amount: 300 }, { name: "ç‰›è‚‰", amount: 200 }, { name: "ç‰ã­ã", amount: 150 }, { name: "äººå‚", amount: 100 }, { name: "é†¤æ²¹", amount: 45 }, { name: "ç ‚ç³–", amount: 30 }, { name: "ã¿ã‚Šã‚“", amount: 30 }, { name: "ã ã—æ±", amount: 200 } ] },
            { id: "sample_2", name: "è±šã®ç”Ÿå§œç„¼ã", ingredients: [ { name: "è±šãƒ­ãƒ¼ã‚¹è‚‰", amount: 300 }, { name: "ç‰ã­ã", amount: 100 }, { name: "ç”Ÿå§œï¼ˆã™ã‚ŠãŠã‚ã—ï¼‰", amount: 15 }, { name: "é†¤æ²¹", amount: 30 }, { name: "ã¿ã‚Šã‚“", amount: 30 }, { name: "é…’", amount: 15 }, { name: "ã‚µãƒ©ãƒ€æ²¹", amount: 15 } ] },
            { id: "sample_3", name: "è¦ªå­ä¸¼", ingredients: [ { name: "é¶ã‚‚ã‚‚è‚‰", amount: 250 }, { name: "ç‰ã­ã", amount: 100 }, { name: "åµ", amount: 150 }, { name: "ã ã—æ±", amount: 100 }, { name: "é†¤æ²¹", amount: 30 }, { name: "ã¿ã‚Šã‚“", amount: 30 }, { name: "ã”é£¯", amount: 600 } ] },
            { id: "sample_4", name: "ã‚«ãƒ¬ãƒ¼ãƒ©ã‚¤ã‚¹", ingredients: [ { name: "è±šè‚‰ã¾ãŸã¯ç‰›è‚‰", amount: 250 }, { name: "ã˜ã‚ƒãŒã„ã‚‚", amount: 300 }, { name: "äººå‚", amount: 150 }, { name: "ç‰ã­ã", amount: 400 }, { name: "ã‚«ãƒ¬ãƒ¼ãƒ«ãƒ¼", amount: 100 }, { name: "æ°´", amount: 800 }, { name: "ã‚µãƒ©ãƒ€æ²¹", amount: 15 } ] },
            { id: "sample_5", name: "é¶ã®å”æšã’", ingredients: [ { name: "é¶ã‚‚ã‚‚è‚‰", amount: 500 }, { name: "é†¤æ²¹", amount: 30 }, { name: "é…’", amount: 15 }, { name: "ç”Ÿå§œï¼ˆã™ã‚ŠãŠã‚ã—ï¼‰", amount: 10 }, { name: "ã«ã‚“ã«ãï¼ˆã™ã‚ŠãŠã‚ã—ï¼‰", amount: 5 }, { name: "ç‰‡æ —ç²‰", amount: 50 }, { name: "æšã’æ²¹", amount: 500 } ] },
            { id: "sample_6", name: "ãƒãƒ³ãƒãƒ¼ã‚°", ingredients: [ { name: "åˆã„ã³ãè‚‰", amount: 400 }, { name: "ç‰ã­ã", amount: 150 }, { name: "ãƒ‘ãƒ³ç²‰", amount: 30 }, { name: "ç‰›ä¹³", amount: 45 }, { name: "åµ", amount: 50 }, { name: "å¡©", amount: 3 }, { name: "ã“ã—ã‚‡ã†", amount: 1 }, { name: "ãƒŠãƒ„ãƒ¡ã‚°", amount: 1 } ] },
            { id: "sample_7", name: "é®­ã®å¡©ç„¼ã", ingredients: [ { name: "ç”Ÿé®­", amount: 240 }, { name: "å¡©", amount: 2 } ] },
            { id: "sample_8", name: "ç­‘å‰ç…®", ingredients: [ { name: "é¶ã‚‚ã‚‚è‚‰", amount: 200 }, { name: "ã”ã¼ã†", amount: 100 }, { name: "äººå‚", amount: 100 }, { name: "ã‚Œã‚“ã“ã‚“", amount: 150 }, { name: "å¹²ã—ã—ã„ãŸã‘", amount: 10 }, { name: "ã“ã‚“ã«ã‚ƒã", amount: 100 }, { name: "ã ã—æ±", amount: 300 }, { name: "é†¤æ²¹", amount: 45 }, { name: "ç ‚ç³–", amount: 15 }, { name: "ã¿ã‚Šã‚“", amount: 30 } ] },
            { id: "sample_9", name: "ãŠå¥½ã¿ç„¼ã", ingredients: [ { name: "è–„åŠ›ç²‰", amount: 100 }, { name: "ã ã—æ±", amount: 120 }, { name: "ã‚­ãƒ£ãƒ™ãƒ„", amount: 300 }, { name: "è±šãƒãƒ©è‚‰", amount: 100 }, { name: "åµ", amount: 100 }, { name: "å¤©ã‹ã™", amount: 20 }, { name: "ç´…ã—ã‚‡ã†ãŒ", amount: 10 } ] },
            { id: "sample_10", name: "ã ã—å·»ãåµ", ingredients: [ { name: "åµ", amount: 200 }, { name: "ã ã—æ±", amount: 60 }, { name: "è–„å£é†¤æ²¹", amount: 5 }, { name: "ã¿ã‚Šã‚“", amount: 5 }, { name: "å¡©", amount: 1 } ] },
            { id: "sample_11", name: "ãƒãƒ£ãƒ¼ãƒãƒ³", ingredients: [ { name: "ã”é£¯", amount: 400 }, { name: "åµ", amount: 100 }, { name: "é•·ãƒã‚®", amount: 50 }, { name: "ç„¼ãè±š", amount: 80 }, { name: "é†¤æ²¹", amount: 10 }, { name: "å¡©", amount: 2 }, { name: "ã“ã—ã‚‡ã†", amount: 1 }, { name: "ã”ã¾æ²¹", amount: 10 } ] },
            { id: "sample_12", name: "æ±å¡è‚‰ï¼ˆãƒˆãƒ³ãƒãƒ¼ãƒ­ãƒ¼ï¼‰", ingredients: [ { name: "è±šãƒãƒ©ãƒ–ãƒ­ãƒƒã‚¯è‚‰", amount: 500 }, { name: "é•·ãƒã‚®ã®é’ã„éƒ¨åˆ†", amount: 50 }, { name: "ç”Ÿå§œã‚¹ãƒ©ã‚¤ã‚¹", amount: 20 }, { name: "ç´¹èˆˆé…’", amount: 100 }, { name: "é†¤æ²¹", amount: 75 }, { name: "æ°·ç ‚ç³–", amount: 50 }, { name: "æ°´", amount: 400 }, { name: "å…«è§’", amount: 1 } ] }
        ];
    }
    </script>
</body>
</html>            padding: 20px 0;
            overflow-y: auto;
        }
        #recipeFormContainer {
            flex-grow: 1;
            padding: 20px;
            overflow-y: auto;
        }

        /* --- ãƒ¬ã‚·ãƒ”ãƒªã‚¹ãƒˆ --- */
        .list-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px 10px;
            border-bottom: 1px solid #ddd;
            margin-bottom: 10px;
        }
        #recipeList {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        #recipeList li {
            padding: 12px 20px;
            cursor: pointer;
            transition: background-color 0.2s;
            border-bottom: 1px dotted #ddd;
            user-select: none;
        }
        #recipeList li:hover {
            background-color: #e0e6e9;
        }
        #recipeList li.selected {
            background-color: #3498db;
            color: white;
            font-weight: bold;
        }
        
        /* --- ãƒ•ã‚©ãƒ¼ãƒ ã¨ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« --- */
        .form-section {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            background-color: #fafafa;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #2c3e50;
        }
        input[type="text"], input[type="number"], .ingredient-item input {
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 16px;
        }
        #recipeName {
            width: calc(100% - 20px);
            margin-bottom: 15px;
        }
        
        /* --- ãƒœã‚¿ãƒ³ --- */
        button {
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.2s, opacity 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            font-size: 16px;
        }
        .primary {
            background-color: #2ecc71;
            color: white;
        }
        .primary:hover {
            background-color: #27ae60;
        }
        .secondary {
            background-color: #3498db;
            color: white;
        }
        .secondary:hover {
            background-color: #2980b9;
        }
        .danger {
            background-color: #e74c3c;
            color: white;
            font-size: 1em;
            padding: 5px 8px;
            margin-left: 5px;
        }
        .danger:hover {
            background-color: #c0392b;
        }
        .control-group button {
            margin-right: 10px;
        }

        /* --- ææ–™ãƒªã‚¹ãƒˆ --- */
        #ingredientsList {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .ingredient-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
            padding: 5px;
            border-bottom: 1px dashed #eee;
        }
        .ingredient-item input[type="radio"] {
            margin-right: 5px;
            cursor: pointer;
            transform: scale(1.2);
        }
        .ingredient-item .name-input {
            flex: 4;
        }
        .ingredient-item .amount-input {
            flex: 2;
            text-align: right;
            -moz-appearance: textfield; /* Firefoxã§çŸ¢å°ã‚’éè¡¨ç¤º */
        }
        .ingredient-item .amount-input::-webkit-outer-spin-button,
        .ingredient-item .amount-input::-webkit-inner-spin-button {
            -webkit-appearance: none; /* Chrome, Safariã§çŸ¢å°ã‚’éè¡¨ç¤º */
            margin: 0;
        }
        .ingredient-item .unit-label, .ingredient-item .ratio-display {
            flex: 1;
            text-align: left;
            white-space: nowrap;
        }
        .ingredient-item .ratio-display {
            font-size: 0.9em;
            color: #7f8c8d;
        }
        .ingredients-header {
            display: flex;
            gap: 10px;
            align-items: center;
            justify-content: flex-end;
            padding-right: 10px;
            margin-bottom: 5px;
        }
        
        /* --- ã‚¹ã‚±ãƒ¼ãƒ«ã¨åˆè¨ˆ --- */
        .scale-control, .total-control {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .scale-control input[type="number"], .total-control input[type="number"] {
            width: 80px;
            text-align: right;
        }
        .total-display {
            font-size: 1.2em;
            font-weight: bold;
            color: #2980b9;
        }
        .unit-radio-group {
            display: flex;
            gap: 15px;
            align-items: center;
        }
        .unit-radio-group label {
            display: inline-flex;
            align-items: center;
            margin-bottom: 0;
            font-weight: normal;
        }

        /* --- ãƒ¢ãƒã‚¤ãƒ«å¯¾å¿œ --- */
        @media (max-width: 768px) {
            body {
                padding-top: 0;
            }
            .app-container {
                width: 100%;
                min-height: 100vh;
                border-radius: 0;
                box-shadow: none;
                flex-direction: column;
            }
            
            #recipeListContainer, #recipeFormContainer {
                width: 100%;
                padding: 10px;
                border-right: none;
                border-bottom: 1px solid #eee;
                box-sizing: border-box;
            }
            
            #recipeFormContainer {
                display: none; /* åˆæœŸã¯ãƒ•ã‚©ãƒ¼ãƒ ã‚’éš ã™ */
            }

            .app-container.form-visible #recipeListContainer {
                display: none; /* ãƒ•ã‚©ãƒ¼ãƒ è¡¨ç¤ºæ™‚ã¯ãƒªã‚¹ãƒˆã‚’éš ã™ */
            }
            .app-container.form-visible #recipeFormContainer {
                display: block; /* ãƒ•ã‚©ãƒ¼ãƒ è¡¨ç¤ºæ™‚ã¯ãƒ•ã‚©ãƒ¼ãƒ ã‚’è¦‹ã›ã‚‹ */
            }

            .list-header {
                padding: 0 10px 10px;
            }

            .ingredient-item {
                flex-wrap: wrap;
                gap: 5px;
            }
            .ingredient-item input[type="radio"] {
                order: 1;
            }
            .ingredient-item .name-input {
                order: 2;
                flex: 1 1 70%;
            }
            .ingredient-item .amount-input {
                order: 3;
                flex: 1 1 30%;
            }
            .ingredient-item .unit-label {
                order: 4;
            }
            .ingredient-item .ratio-display {
                order: 5;
                flex: 1 1 100%;
                text-align: right;
                padding-right: 5px;
            }
            .ingredient-item .danger {
                order: 6;
            }

            .scale-control, .total-control {
                flex-wrap: wrap;
            }
            .scale-control input[type="number"], .total-control input[type="number"] {
                width: 100px;
            }
            .mobile-controls {
                display: flex;
                justify-content: space-between;
                margin-bottom: 10px;
            }
        }
        
        /* --- ãã®ä»–ã®ã‚¹ã‚¿ã‚¤ãƒ« --- */
        #backToListBtn, .mobile-controls {
            display: none;
        }
        @media (max-width: 768px) {
            .app-container.form-visible #backToListBtn {
                display: inline-flex;
            }
            .mobile-controls {
                display: flex;
            }
        }
        .control-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        .io-controls {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div id="recipeListContainer">
            <div class="list-header">
                <h2>ãƒ¬ã‚·ãƒ”ä¸€è¦§</h2>
                <button id="newRecipeBtn" class="primary">ğŸ“ æ–°è¦ä½œæˆ</button>
            </div>
            <ul id="recipeList">
                </ul>
        </div>

        <div id="recipeFormContainer">
            <div class="mobile-controls">
                <button id="backToListBtn" class="secondary">â—€ï¸ ä¸€è¦§ã«æˆ»ã‚‹</button>
                <button id="fullscreenBtn" class="secondary">ğŸŒ å…¨ç”»é¢</button>
            </div>

            <div class="form-section">
                <label for="recipeName">ãƒ¬ã‚·ãƒ”å</label>
                <input type="text" id="recipeName" placeholder="ä¾‹: è‚‰ã˜ã‚ƒãŒ" required>
            </div>
            
            <div class="form-section">
                <h3>ææ–™ã¨åˆ†é‡</h3>
                <div class="unit-radio-group">
                    <input type="radio" id="unitG" name="unit" value="g" checked>
                    <label for="unitG">ã‚°ãƒ©ãƒ  (g)</label>
                    <input type="radio" id="unitKg" name="unit" value="kg">
                    <label for="unitKg">ã‚­ãƒ­ã‚°ãƒ©ãƒ  (kg)</label>
                </div>
                
                <div class="ingredients-header">
                    <button id="addIngredient" class="secondary">â• ææ–™è¿½åŠ </button>
                </div>
                
                <ul id="ingredientsList">
                    </ul>
            </div>

            <div class="form-section">
                <h3>åˆ†é‡è¨ˆç®— (åŸºæº–ææ–™ã‹ã‚‰)</h3>
                <div class="scale-control">
                    <label>åŸºæº–é‡:</label>
                    <input type="number" id="scaleAmount" min="0" placeholder="0">
                    <span id="scaleUnit">g</span>
                    <button onclick="calculateFromSingleIngredient()" class="secondary">ğŸ”„ åŸºæº–é‡ã‹ã‚‰è¨ˆç®—</button>
                </div>
                <p style="font-size:0.9em; color:#7f8c8d; margin-top:5px;">â€»ææ–™æ¨ªã®ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ã§åŸºæº–ææ–™ã‚’é¸æŠã—ã¦ã‹ã‚‰ã€åŸºæº–é‡ã‚’å…¥åŠ›ãƒ»è¨ˆç®—ã—ã¦ãã ã•ã„ã€‚</p>
            </div>

            <div class="form-section">
                <h3>åˆ†é‡è¨ˆç®— (åˆè¨ˆé‡ã‹ã‚‰)</h3>
                <div class="total-control">
                    <label>ç¾åœ¨ã®åˆè¨ˆ:</label>
                    <span class="total-display"><span id="totalAmountValue">0</span><span id="totalAmountUnit">g</span></span>
                </div>
                <div class="total-control" style="margin-top: 10px;">
                    <label>ç›®æ¨™åˆè¨ˆé‡:</label>
                    <input type="number" id="desiredTotalAmount" min="0" placeholder="0">
                    <span id="totalUnitLabel">g</span>
                    <button id="scaleFromTotalBtn" class="secondary">ğŸ¯ åˆè¨ˆé‡ã‹ã‚‰è¨ˆç®—</button>
                </div>
                <p style="font-size:0.9em; color:#7f8c8d; margin-top:5px;">â€»ç›®æ¨™åˆè¨ˆé‡ã‚’å…¥åŠ›ã—ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨å…¨ææ–™ã®åˆ†é‡ãŒèª¿æ•´ã•ã‚Œã¾ã™ã€‚</p>
            </div>

            <div class="control-group">
                <button id="saveBtn" class="primary">ğŸ’¾ ä¿å­˜</button>
                <button id="updateBtn" class="primary" style="display:none;">âœ”ï¸ æ›´æ–°</button>
                <button id="deleteBtn" class="danger" style="display:none;">ğŸ—‘ï¸ å‰Šé™¤</button>
            </div>

            <div class="io-controls">
                <button id="exportBtn" class="secondary">ğŸ“¤ ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
                <button id="importBtn" class="secondary">ğŸ“¥ ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
                <input type="file" id="importFile" accept=".json" style="display:none;">
            </div>
        </div>
    </div>

    <script>
    // --- ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã¨DOMè¦ç´  ---
    const RECIPES_STORAGE_KEY = 'recipesv1all_improved';
    let recipes = [];
    let currentRecipeId = null;
    let currentUnit = 'g';

    const appContainer = document.querySelector('.app-container');
    const recipeListEl = document.getElementById('recipeList');
    const newRecipeBtn = document.getElementById('newRecipeBtn');
    const recipeNameEl = document.getElementById('recipeName');
    const ingredientsListEl = document.getElementById('ingredientsList');
    const addIngredientBtn = document.getElementById('addIngredient');
    const saveBtn = document.getElementById('saveBtn');
    const updateBtn = document.getElementById('updateBtn');
    const deleteBtn = document.getElementById('deleteBtn');
    const scaleAmountEl = document.getElementById('scaleAmount');
    const scaleUnitEl = document.getElementById('scaleUnit');
    const unitGRadio = document.getElementById('unitG');
    const unitKgRadio = document.getElementById('unitKg');
    const exportBtn = document.getElementById('exportBtn');
    const importBtn = document.getElementById('importBtn');
    const importFileEl = document.getElementById('importFile');
    const totalAmountValueEl = document.getElementById('totalAmountValue');
    const totalAmountUnitEl = document.getElementById('totalAmountUnit');
    const desiredTotalAmountEl = document.getElementById('desiredTotalAmount');
    const scaleFromTotalBtn = document.getElementById('scaleFromTotalBtn');
    const fullscreenBtn = document.getElementById('fullscreenBtn');
    const backToListBtn = document.getElementById('backToListBtn');
    const totalUnitLabelEl = document.getElementById('totalUnitLabel'); // ç›®æ¨™åˆè¨ˆé‡ã®å˜ä½ãƒ©ãƒ™ãƒ«

    // --- åˆæœŸåŒ–å‡¦ç† ---
    document.addEventListener('DOMContentLoaded', () => {
        loadRecipes();
        renderRecipeList();
        setupEventListeners();
        clearForm();
        // åˆæœŸè¡¨ç¤ºã§ã¯ãƒ•ã‚©ãƒ¼ãƒ ã‚’éš ã™ï¼ˆã‚¹ãƒãƒ›è€ƒæ…®ï¼‰
        if (window.innerWidth <= 768) {
            showListView();
        }
    });

    // --- ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š ---
    function setupEventListeners() {
        recipeListEl.addEventListener('click', e => {
            if (e.target.tagName === 'LI' && e.target.dataset.id) { // ãƒ‡ãƒ¼ã‚¿IDãŒã‚ã‚‹å ´åˆã®ã¿
                selectRecipe(e.target.dataset.id);
            }
        });
        newRecipeBtn.addEventListener('click', () => {
            clearForm();
            showFormView();
        });
        // â˜…ãƒã‚°ä¿®æ­£: ææ–™è¿½åŠ ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ãŒãªã‹ã£ãŸã®ã‚’è¿½åŠ 
        addIngredientBtn.addEventListener('click', () => addIngredientRow({ name: '', amount: 0 }, true));

        saveBtn.addEventListener('click', saveRecipe);
        updateBtn.addEventListener('click', updateRecipe);
        deleteBtn.addEventListener('click', deleteRecipe);
        unitGRadio.addEventListener('change', () => setUnit('g'));
        unitKgRadio.addEventListener('change', () => setUnit('kg'));
        scaleAmountEl.addEventListener('input', calculateFromSingleIngredient);
        scaleFromTotalBtn.addEventListener('click', scaleFromTotal);
        fullscreenBtn.addEventListener('click', toggleFullscreen);
        backToListBtn.addEventListener('click', showListView);

        // â˜…ãƒ­ã‚¸ãƒƒã‚¯æ”¹å–„: ææ–™ãƒªã‚¹ãƒˆå…¨ä½“ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
        ingredientsListEl.addEventListener('input', e => {
            const item = e.target.closest('.ingredient-item');
            if (!item) return;
            // åˆ†é‡ã®æ‰‹å…¥åŠ›ã§ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ã‚’æ›´æ–°
            if (e.target.classList.contains('amount-input')) {
                const amountValue = parseFloat(e.target.value) || 0;
                const multiplier = currentUnit === 'kg' ? 1000 : 1;
                item.dataset.amountInG = amountValue * multiplier;
                updateTotalsAndRatios();
            }
        });

        // â˜…UXæ”¹å–„: åŸºæº–ææ–™ã®ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯ã§åŸºæº–é‡ã‚’å…¥åŠ›æ¬„ã«ã‚»ãƒƒãƒˆ
        ingredientsListEl.addEventListener('click', e => {
            if (e.target.type === 'radio' && e.target.name === 'baseIngredient') {
                const item = e.target.closest('.ingredient-item');
                if (item) {
                    const amountInG = parseFloat(item.dataset.amountInG || '0');
                    const divider = currentUnit === 'kg' ? 1000 : 1;
                    scaleAmountEl.value = (amountInG / divider).toFixed(divider === 1000 ? 3 : 0);
                    scaleAmountEl.focus(); // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚’ç§»å‹•
                    calculateFromSingleIngredient(); // é¸æŠã—ãŸæ™‚ç‚¹ã§è¨ˆç®—å®Ÿè¡Œ
                }
            }
        });

        exportBtn.addEventListener('click', exportRecipes);
        importBtn.addEventListener('click', () => importFileEl.click());
        importFileEl.addEventListener('change', importRecipes);
    }

    // --- UIåˆ¶å¾¡ (ã‚¹ãƒãƒ›è¡¨ç¤ºå¯¾å¿œ) ---
    function showFormView() { appContainer.classList.add('form-visible'); }
    function showListView() { appContainer.classList.remove('form-visible'); }

    // --- ãƒ‡ãƒ¼ã‚¿ç®¡ç† ---
    function loadRecipes() {
        try {
            const storedRecipes = localStorage.getItem(RECIPES_STORAGE_KEY);
            recipes = storedRecipes ? JSON.parse(storedRecipes) : generateSampleRecipes();
        } catch (e) {
            console.error("Failed to load recipes from localStorage", e);
            recipes = generateSampleRecipes();
        }
        saveRecipesToStorage();
    }
    function saveRecipesToStorage() { localStorage.setItem(RECIPES_STORAGE_KEY, JSON.stringify(recipes)); }

    // --- UIæç”» ---
    function renderRecipeList() {
        recipeListEl.innerHTML = '';
        if (recipes.length === 0) {
            // â˜…UXæ”¹å–„: ãƒ¬ã‚·ãƒ”ãŒãªã„å ´åˆã®è¡¨ç¤º
            const li = document.createElement('li');
            li.textContent = 'ãƒ¬ã‚·ãƒ”ãŒã‚ã‚Šã¾ã›ã‚“ã€‚æ–°è¦ä½œæˆã—ã¦ãã ã•ã„ã€‚';
            li.style.color = '#7f8c8d';
            li.style.cursor = 'default';
            recipeListEl.appendChild(li);
            return;
        }

        recipes.sort((a, b) => a.name.localeCompare(b.name, 'ja')).forEach(recipe => {
            const li = document.createElement('li');
            li.textContent = recipe.name;
            li.dataset.id = recipe.id;
            if (recipe.id === currentRecipeId) li.classList.add('selected');
            recipeListEl.appendChild(li);
        });
    }

    function renderRecipeForm(recipe) {
        currentRecipeId = recipe.id;
        recipeNameEl.value = recipe.name;
        ingredientsListEl.innerHTML = '';
        recipe.ingredients.forEach(ing => addIngredientRow(ing));
        scaleAmountEl.value = '';
        desiredTotalAmountEl.value = '';
        updateFormState('edit');
        // â˜…ãƒ­ã‚¸ãƒƒã‚¯æ”¹å–„: æç”»å¾Œã«å˜ä½ã¨åˆè¨ˆã‚’æ­£ã—ãè¨­å®š
        setUnit(currentUnit);
    }

    // â˜…ãƒ­ã‚¸ãƒƒã‚¯æ”¹å–„ & UXæ”¹å–„: addIngredientRowã‚’ä¿®æ­£
    function addIngredientRow(ingredient = { name: '', amount: 0 }, focusAfterAdd = false) {
        const li = document.createElement('li');
        li.className = 'ingredient-item';
        // â˜…ãƒ­ã‚¸ãƒƒã‚¯æ”¹å–„: ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ã‚’ä¸€å…ƒåŒ– (data-amount-in-g)
        li.dataset.amountInG = ingredient.amount || '0';

        const radio = document.createElement('input'); radio.type = 'radio'; radio.name = 'baseIngredient'; radio.title = 'åŸºæº–ã«ã™ã‚‹';
        const nameInput = document.createElement('input'); nameInput.type = 'text'; nameInput.className = 'name-input'; nameInput.placeholder = 'ææ–™å'; nameInput.value = ingredient.name;
        const amountInput = document.createElement('input'); amountInput.type = 'number'; amountInput.className = 'amount-input'; amountInput.placeholder = 'åˆ†é‡'; amountInput.min = '0';
        // HTMLã®inputã‚¤ãƒ™ãƒ³ãƒˆã§data-amount-in-gã‚’æ›´æ–°ã™ã‚‹ãŸã‚ã€ã“ã“ã§ã¯å€¤ã¯è¨­å®šã—ãªã„ï¼ˆsetUnitã§è¨­å®šã•ã‚Œã‚‹ï¼‰

        const unitLabel = document.createElement('span'); unitLabel.className = 'unit-label';
        const ratioDisplay = document.createElement('span'); ratioDisplay.className = 'ratio-display';
        const removeBtn = document.createElement('button'); removeBtn.textContent = 'ğŸ—‘ï¸'; removeBtn.className = 'danger'; removeBtn.title = 'å‰Šé™¤';
        removeBtn.addEventListener('click', () => {
            li.remove();
            updateTotalsAndRatios();
        });

        li.append(radio, nameInput, amountInput, unitLabel, ratioDisplay, removeBtn);
        ingredientsListEl.appendChild(li);

        // â˜…UXæ”¹å–„: è¿½åŠ å¾Œã«ææ–™åå…¥åŠ›æ¬„ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹
        if (focusAfterAdd) {
            nameInput.focus();
        }
        
        // å˜ä½è¨­å®šã¨åˆè¨ˆè¨ˆç®—ã‚‚å¿˜ã‚Œãšã«
        setUnit(currentUnit, true); // trueã§åˆ†é‡å…¥åŠ›æ¬„ã‚’æ›´æ–°
    }

    function updateFormState(state) {
        saveBtn.style.display = state === 'new' ? 'inline-flex' : 'none';
        updateBtn.style.display = state === 'edit' ? 'inline-flex' : 'none';
        deleteBtn.style.display = state === 'edit' ? 'inline-flex' : 'none';
    }

    // --- ãƒ¬ã‚·ãƒ”æ“ä½œ ---
    function selectRecipe(recipeId) {
        const recipe = recipes.find(r => r.id === recipeId);
        if (recipe) {
            // ç¾åœ¨ã®å˜ä½ã‚’ä¿æŒ
            const savedUnit = currentUnit;
            currentRecipeId = recipeId;
            renderRecipeForm(recipe);
            setUnit(savedUnit); // ä»¥å‰ã®å˜ä½ã‚’å†è¨­å®š
            renderRecipeList(); // é¸æŠçŠ¶æ…‹ã‚’åæ˜ 
            showFormView();
        }
    }

    function clearForm() {
        currentRecipeId = null;
        recipeNameEl.value = '';
        ingredientsListEl.innerHTML = '';
        scaleAmountEl.value = '';
        desiredTotalAmountEl.value = '';
        // â˜…UXæ”¹å–„: æ–°è¦ä½œæˆæ™‚ã«3è¡Œã®å…¥åŠ›æ¬„ã‚’ç”¨æ„
        addIngredientRow({ name: '', amount: 0 }, true); // æœ€åˆã®è¡Œã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹
        addIngredientRow();
        addIngredientRow();
        updateFormState('new');
        setUnit('g'); // å˜ä½ã‚’gã«ãƒªã‚»ãƒƒãƒˆ
        const selected = recipeListEl.querySelector('.selected');
        if (selected) selected.classList.remove('selected');
        recipeNameEl.focus();
    }

    // â˜…ãƒ­ã‚¸ãƒƒã‚¯æ”¹å–„: getRecipeDataFromFormã‚’ä¿®æ­£
    function getRecipeDataFromForm() {
        const name = recipeNameEl.value.trim();
        if (!name) {
            alert('ãƒ¬ã‚·ãƒ”åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
            return null;
        }
        const ingredients = Array.from(ingredientsListEl.querySelectorAll('.ingredient-item')).map(item => {
            const nameInput = item.querySelector('.name-input').value.trim();
            // â˜…ãƒ­ã‚¸ãƒƒã‚¯æ”¹å–„: data-amount-in-gã‹ã‚‰å€¤ã‚’å–å¾—
            const amount = parseFloat(item.dataset.amountInG);
            return (nameInput && !isNaN(amount) && amount > 0) ? { name: nameInput, amount: amount } : null;
        }).filter(Boolean); // â˜…UXæ”¹å–„: ç©ºã®ææ–™ã¯ä¿å­˜ã—ãªã„

        if (ingredients.length === 0) {
            alert('æœ‰åŠ¹ãªææ–™ã‚’1ã¤ä»¥ä¸Šå…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
            return null;
        }
        return { name, ingredients };
    }

    function saveRecipe() {
        const newRecipeData = getRecipeDataFromForm();
        if (!newRecipeData) return;
        const newRecipe = { id: `recipe_${Date.now()}`, ...newRecipeData };
        recipes.push(newRecipe);
        saveRecipesToStorage();
        renderRecipeList();
        selectRecipe(newRecipe.id);
    }

    function updateRecipe() {
        if (!currentRecipeId) return;
        const updatedData = getRecipeDataFromForm();
        if (!updatedData) return;
        const recipeIndex = recipes.findIndex(r => r.id === currentRecipeId);
        if (recipeIndex > -1) {
            recipes[recipeIndex] = { ...recipes[recipeIndex], ...updatedData };
            saveRecipesToStorage();
            renderRecipeList();
            alert('ãƒ¬ã‚·ãƒ”ãŒæ›´æ–°ã•ã‚Œã¾ã—ãŸã€‚');
        }
    }

    function deleteRecipe() {
        if (!currentRecipeId) return;
        const recipe = recipes.find(r => r.id === currentRecipeId);
        if (confirm(`ã€Œ${recipe.name}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
            recipes = recipes.filter(r => r.id !== currentRecipeId);
            saveRecipesToStorage();
            renderRecipeList();
            clearForm();
            showListView();
        }
    }

    // --- è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ ---
    // â˜…ãƒ­ã‚¸ãƒƒã‚¯æ”¹å–„: setUnitã‚’ä¿®æ­£
    function setUnit(unit, skipInputUpdate = false) {
        currentUnit = unit;
        scaleUnitEl.textContent = unit;
        totalAmountUnitEl.textContent = unit;
        totalUnitLabelEl.textContent = unit; // ç›®æ¨™åˆè¨ˆé‡ã®å˜ä½ãƒ©ãƒ™ãƒ«ã‚‚æ›´æ–°
        unit === 'g' ? (unitGRadio.checked = true) : (unitKgRadio.checked = true);
        
        const divider = unit === 'kg' ? 1000 : 1;
        const precision = unit === 'kg' ? 3 : 0;

        ingredientsListEl.querySelectorAll('.ingredient-item').forEach(item => {
            const amountInG = parseFloat(item.dataset.amountInG || '0');
            const input = item.querySelector('.amount-input');
            
            // å˜ä½ãŒå¤‰ã‚ã£ãŸã¨ãã€ã¾ãŸã¯ææ–™ãŒè¿½åŠ ã•ã‚ŒãŸã¨ãã«åˆ†é‡å…¥åŠ›æ¬„ã‚’æ›´æ–°
            if (!skipInputUpdate) {
                input.value = (amountInG / divider).toFixed(precision);
            }
            item.querySelector('.unit-label').textContent = unit;
        });

        // åŸºæº–é‡å…¥åŠ›æ¬„ã‚‚ç¾åœ¨ã®å˜ä½ã«åˆã‚ã›ã¦æ›´æ–°
        const baseRadio = ingredientsListEl.querySelector('input[name=baseIngredient]:checked');
        if (baseRadio) { // é¸æŠã•ã‚Œã¦ã„ã‚‹å ´åˆã®ã¿
            const item = baseRadio.closest('.ingredient-item');
            const amountInG = parseFloat(item.dataset.amountInG || '0');
            scaleAmountEl.value = (amountInG / divider).toFixed(precision);
        } else if (scaleAmountEl.value) {
             // åŸºæº–ææ–™ãŒæœªé¸æŠã§ã‚‚ã€å˜ä½å¤‰æ›´æ™‚ã«å€¤ã¯è¡¨ç¤ºå˜ä½ã«å¤‰æ›
             // â€»ãŸã ã—ã€åŸºæº–ææ–™ãŒé¸ã°ã‚Œã¦ã„ãªã„ã¨è¨ˆç®—ã¯å®Ÿè¡Œã§ããªã„
            // ç°¡ç•¥åŒ–ã®ãŸã‚ã€ã“ã“ã§ã¯åŸºæº–ææ–™é¸æŠæ™‚ã®ã¿scaleAmountElã®å€¤ã‚’æ›´æ–°
            scaleAmountEl.value = '';
        }

        updateTotalsAndRatios();
    }

    // â˜…ãƒ­ã‚¸ãƒƒã‚¯æ”¹å–„: calculateFromSingleIngredientã‚’å…¨é¢çš„ã«æ›¸ãæ›ãˆ
    function calculateFromSingleIngredient() {
        const scaleAmount = parseFloat(scaleAmountEl.value);
        if (isNaN(scaleAmount) || scaleAmount <= 0) return; // 0ä»¥ä¸‹ã¯ç„¡è¦–

        let baseItem = ingredientsListEl.querySelector('input[name=baseIngredient]:checked')?.closest('.ingredient-item');
        if (!baseItem) {
            alert('åŸºæº–ã«ã™ã‚‹ææ–™ã‚’ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ã§é¸æŠã—ã¦ãã ã•ã„ã€‚');
            return;
        }
        
        const baseAmountInG = parseFloat(baseItem.dataset.amountInG);
        if (isNaN(baseAmountInG) || baseAmountInG === 0) {
            alert('åŸºæº–ææ–™ã®åˆ†é‡ãŒ0ã®ãŸã‚ã€æ¯”ç‡ã‚’è¨ˆç®—ã§ãã¾ã›ã‚“ã€‚');
            return;
        }

        const multiplier = currentUnit === 'kg' ? 1000 : 1;
        const scale = (scaleAmount * multiplier) / baseAmountInG;

        ingredientsListEl.querySelectorAll('.ingredient-item').forEach(item => {
            const originalAmountInG = parseFloat(item.dataset.amountInG || '0');
            if (!isNaN(originalAmountInG)) {
                const newAmountInG = originalAmountInG * scale;
                item.dataset.amountInG = newAmountInG; // ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ã‚’æ›´æ–°
            }
        });

        // è¡¨ç¤ºã‚’æ›´æ–°
        setUnit(currentUnit);
    }

    // â˜…ãƒ­ã‚¸ãƒƒã‚¯æ”¹å–„: scaleFromTotalã‚’å…¨é¢çš„ã«æ›¸ãæ›ãˆ
    function scaleFromTotal() {
        const desiredTotal = parseFloat(desiredTotalAmountEl.value);
        if (isNaN(desiredTotal) || desiredTotal <= 0) {
            alert('æœ‰åŠ¹ãªç›®æ¨™åˆè¨ˆé‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
            return;
        }

        let currentTotalInG = 0;
        const items = Array.from(ingredientsListEl.querySelectorAll('.ingredient-item'));
        items.forEach(item => {
            const amountInG = parseFloat(item.dataset.amountInG || '0');
            if (!isNaN(amountInG)) {
                currentTotalInG += amountInG;
            }
        });

        if (currentTotalInG === 0) {
            alert('ç¾åœ¨ã®åˆè¨ˆãŒ0ã®ãŸã‚ã€æ¯”ç‡ã‚’è¨ˆç®—ã§ãã¾ã›ã‚“ã€‚');
            return;
        }

        const multiplier = currentUnit === 'kg' ? 1000 : 1;
        const scale = (desiredTotal * multiplier) / currentTotalInG;

        items.forEach(item => {
            const originalAmountInG = parseFloat(item.dataset.amountInG || '0');
            if (!isNaN(originalAmountInG)) {
                const newAmountInG = originalAmountInG * scale;
                item.dataset.amountInG = newAmountInG; // ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ã‚’æ›´æ–°
            }
        });

        // è¡¨ç¤ºã‚’æ›´æ–°
        setUnit(currentUnit);
    }

    // â˜…ãƒ­ã‚¸ãƒƒã‚¯æ”¹å–„: updateTotalsAndRatiosã‚’ä¿®æ­£
    function updateTotalsAndRatios() {
        let totalAmountInG = 0;
        const amountsInG = [];
        ingredientsListEl.querySelectorAll('.ingredient-item').forEach(item => {
            const amount = parseFloat(item.dataset.amountInG || '0');
            if (!isNaN(amount)) {
                totalAmountInG += amount;
                amountsInG.push(amount);
            } else {
                amountsInG.push(0);
            }
        });

        const divider = currentUnit === 'kg' ? 1000 : 1;
        totalAmountValueEl.textContent = (totalAmountInG / divider).toFixed(divider === 1000 ? 3 : 0);

        ingredientsListEl.querySelectorAll('.ratio-display').forEach((display, index) => {
            const ratio = totalAmountInG > 0 ? (amountsInG[index] / totalAmountInG) * 100 : 0;
            display.textContent = `(${ratio.toFixed(1)}%)`;
        });
    }

    // --- å…¨ç”»é¢è¡¨ç¤º ---
    function toggleFullscreen() {
        if (!document.fullscreenElement) {
            document.documentElement.requestFullscreen().catch(err => alert(`å…¨ç”»é¢è¡¨ç¤ºã«ã§ãã¾ã›ã‚“ã§ã—ãŸ: ${err.message}`));
        } else {
            if (document.exitFullscreen) document.exitFullscreen();
        }
    }

    // --- ã‚¤ãƒ³ãƒãƒ¼ãƒˆ/ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ ---
    function exportRecipes() {
        if (recipes.length === 0) {
            alert('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹ãƒ¬ã‚·ãƒ”ãŒã‚ã‚Šã¾ã›ã‚“ã€‚');
            return;
        }
        const dataStr = JSON.stringify(recipes, null, 2);
        const blob = new Blob([dataStr], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'recipes_backup.json';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }

    function importRecipes(event) {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = e => {
            try {
                const data = JSON.parse(e.target.result);
                if (!Array.isArray(data) || !data.every(item => item.id && item.name && Array.isArray(item.ingredients))) {
                    throw new Error('JSONã®ãƒ‡ãƒ¼ã‚¿æ§‹é€ ãŒä¸æ­£ã§ã™ã€‚');
                }
                if (confirm('ç¾åœ¨ã®å…¨ãƒ¬ã‚·ãƒ”ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ãŸãƒ‡ãƒ¼ã‚¿ã§ä¸Šæ›¸ãã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) {
                    recipes = data;
                    saveRecipesToStorage();
                    clearForm();
                    renderRecipeList();
                    showListView();
                    alert(`${recipes.length}ä»¶ã®ãƒ¬ã‚·ãƒ”ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸã€‚`);
                }
            } catch (error) {
                alert(`ã‚¤ãƒ³ãƒãƒ¼ãƒˆå¤±æ•—: ${error.message}`);
            } finally {
                importFileEl.value = '';
            }
        };
        reader.readAsText(file);
    }

    // --- ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ ---
    function generateSampleRecipes() {
        return [
            { id: "sample_1", name: "è‚‰ã˜ã‚ƒãŒ", ingredients: [ { name: "ã˜ã‚ƒãŒã„ã‚‚", amount: 300 }, { name: "ç‰›è‚‰", amount: 200 }, { name: "ç‰ã­ã", amount: 150 }, { name: "äººå‚", amount: 100 }, { name: "é†¤æ²¹", amount: 45 }, { name: "ç ‚ç³–", amount: 30 }, { name: "ã¿ã‚Šã‚“", amount: 30 }, { name: "ã ã—æ±", amount: 200 } ] },
            { id: "sample_2", name: "è±šã®ç”Ÿå§œç„¼ã", ingredients: [ { name: "è±šãƒ­ãƒ¼ã‚¹è‚‰", amount: 300 }, { name: "ç‰ã­ã", amount: 100 }, { name: "ç”Ÿå§œï¼ˆã™ã‚ŠãŠã‚ã—ï¼‰", amount: 15 }, { name: "é†¤æ²¹", amount: 30 }, { name: "ã¿ã‚Šã‚“", amount: 30 }, { name: "é…’", amount: 15 }, { name: "ã‚µãƒ©ãƒ€æ²¹", amount: 15 } ] },
            { id: "sample_3", name: "è¦ªå­ä¸¼", ingredients: [ { name: "é¶ã‚‚ã‚‚è‚‰", amount: 250 }, { name: "ç‰ã­ã", amount: 100 }, { name: "åµ", amount: 150 }, { name: "ã ã—æ±", amount: 100 }, { name: "é†¤æ²¹", amount: 30 }, { name: "ã¿ã‚Šã‚“", amount: 30 }, { name: "ã”é£¯", amount: 600 } ] },
            { id: "sample_4", name: "ã‚«ãƒ¬ãƒ¼ãƒ©ã‚¤ã‚¹", ingredients: [ { name: "è±šè‚‰ã¾ãŸã¯ç‰›è‚‰", amount: 250 }, { name: "ã˜ã‚ƒãŒã„ã‚‚", amount: 300 }, { name: "äººå‚", amount: 150 }, { name: "ç‰ã­ã", amount: 400 }, { name: "ã‚«ãƒ¬ãƒ¼ãƒ«ãƒ¼", amount: 100 }, { name: "æ°´", amount: 800 }, { name: "ã‚µãƒ©ãƒ€æ²¹", amount: 15 } ] },
            { id: "sample_5", name: "é¶ã®å”æšã’", ingredients: [ { name: "é¶ã‚‚ã‚‚è‚‰", amount: 500 }, { name: "é†¤æ²¹", amount: 30 }, { name: "é…’", amount: 15 }, { name: "ç”Ÿå§œï¼ˆã™ã‚ŠãŠã‚ã—ï¼‰", amount: 10 }, { name: "ã«ã‚“ã«ãï¼ˆã™ã‚ŠãŠã‚ã—ï¼‰", amount: 5 }, { name: "ç‰‡æ —ç²‰", amount: 50 }, { name: "æšã’æ²¹", amount: 500 } ] },
            { id: "sample_6", name: "ãƒãƒ³ãƒãƒ¼ã‚°", ingredients: [ { name: "åˆã„ã³ãè‚‰", amount: 400 }, { name: "ç‰ã­ã", amount: 150 }, { name: "ãƒ‘ãƒ³ç²‰", amount: 30 }, { name: "ç‰›ä¹³", amount: 45 }, { name: "åµ", amount: 50 }, { name: "å¡©", amount: 3 }, { name: "ã“ã—ã‚‡ã†", amount: 1 }, { name: "ãƒŠãƒ„ãƒ¡ã‚°", amount: 1 } ] },
            { id: "sample_7", name: "é®­ã®å¡©ç„¼ã", ingredients: [ { name: "ç”Ÿé®­", amount: 240 }, { name: "å¡©", amount: 2 } ] },
            { id: "sample_8", name: "ç­‘å‰ç…®", ingredients: [ { name: "é¶ã‚‚ã‚‚è‚‰", amount: 200 }, { name: "ã”ã¼ã†", amount: 100 }, { name: "äººå‚", amount: 100 }, { name: "ã‚Œã‚“ã“ã‚“", amount: 150 }, { name: "å¹²ã—ã—ã„ãŸã‘", amount: 10 }, { name: "ã“ã‚“ã«ã‚ƒã", amount: 100 }, { name: "ã ã—æ±", amount: 300 }, { name: "é†¤æ²¹", amount: 45 }, { name: "ç ‚ç³–", amount: 15 }, { name: "ã¿ã‚Šã‚“", amount: 30 } ] },
            { id: "sample_9", name: "ãŠå¥½ã¿ç„¼ã", ingredients: [ { name: "è–„åŠ›ç²‰", amount: 100 }, { name: "ã ã—æ±", amount: 120 }, { name: "ã‚­ãƒ£ãƒ™ãƒ„", amount: 300 }, { name: "è±šãƒãƒ©è‚‰", amount: 100 }, { name: "åµ", amount: 100 }, { name: "å¤©ã‹ã™", amount: 20 }, { name: "ç´…ã—ã‚‡ã†ãŒ", amount: 10 } ] },
            { id: "sample_10", name: "ã ã—å·»ãåµ", ingredients: [ { name: "åµ", amount: 200 }, { name: "ã ã—æ±", amount: 60 }, { name: "è–„å£é†¤æ²¹", amount: 5 }, { name: "ã¿ã‚Šã‚“", amount: 5 }, { name: "å¡©", amount: 1 } ] },
            { id: "sample_11", name: "ãƒãƒ£ãƒ¼ãƒãƒ³", ingredients: [ { name: "ã”é£¯", amount: 400 }, { name: "åµ", amount: 100 }, { name: "é•·ãƒã‚®", amount: 50 }, { name: "ç„¼ãè±š", amount: 80 }, { name: "é†¤æ²¹", amount: 10 }, { name: "å¡©", amount: 2 }, { name: "ã“ã—ã‚‡ã†", amount: 1 }, { name: "ã”ã¾æ²¹", amount: 10 } ] },
            { id: "sample_12", name: "æ±å¡è‚‰ï¼ˆãƒˆãƒ³ãƒãƒ¼ãƒ­ãƒ¼ï¼‰", ingredients: [ { name: "è±šãƒãƒ©ãƒ–ãƒ­ãƒƒã‚¯è‚‰", amount: 500 }, { name: "é•·ãƒã‚®ã®é’ã„éƒ¨åˆ†", amount: 50 }, { name: "ç”Ÿå§œã‚¹ãƒ©ã‚¤ã‚¹", amount: 20 }, { name: "ç´¹èˆˆé…’", amount: 100 }, { name: "é†¤æ²¹", amount: 75 }, { name: "æ°·ç ‚ç³–", amount: 50 }, { name: "æ°´", amount: 400 }, { name: "å…«è§’", amount: 1 } ] }
        ];
    }
    </script>
</body>
</html>
