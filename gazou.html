<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ç”»åƒåœ§ç¸®ãƒ„ãƒ¼ãƒ« Pro - 10MBä»¥ä¸‹ã«è‡ªå‹•åœ§ç¸®</title>
<style>
  :root {
    --primary: #0066ff;
    --primary-dark: #0052cc;
    --success: #00a651;
    --error: #e74c3c;
    --warning: #f39c12;
    --bg: #f7f7fb;
    --card-bg: #ffffff;
    --border: #e0e0e8;
    --text: #111111;
    --text-light: #666666;
    --shadow: rgba(0, 0, 0, 0.08);
  }
  * { box-sizing: border-box; }
  body {
    font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Hiragino Kaku Gothic ProN", "Noto Sans JP", sans-serif;
    margin: 0; padding: 20px; background: var(--bg); color: var(--text); line-height: 1.6;
  }
  .container { max-width: 1200px; margin: 0 auto; }
  h1 { font-size: 1.8rem; margin: 0 0 0.5rem; color: var(--primary); }
  .subtitle { color: var(--text-light); margin: 0 0 1.5rem; font-size: 0.95rem; }
  .card { background: var(--card-bg); border-radius: 12px; padding: 24px; box-shadow: 0 2px 12px var(--shadow); margin-bottom: 20px; }
  .card h2 { font-size: 1.3rem; margin: 0 0 1rem; display: flex; align-items: center; gap: 8px; }
  .badge { display: inline-block; padding: 2px 8px; border-radius: 12px; font-size: 0.75rem; font-weight: 600; background: var(--primary); color: white; }
  .form-group { margin-bottom: 20px; }
  label { display: block; margin-bottom: 6px; font-weight: 600; font-size: 0.95rem; }
  .label-help { font-weight: 400; color: var(--text-light); font-size: 0.85rem; margin-left: 4px; }
  input[type=file] { display: block; width: 100%; padding: 12px; border: 2px dashed var(--border); border-radius: 8px; background: #fafafa; cursor: pointer; transition: all 0.3s; }
  input[type=file]:hover { border-color: var(--primary); background: #f0f7ff; }
  input[type=number], input[type=text], select { width: 100%; padding: 10px 12px; border-radius: 8px; border: 1px solid var(--border); font-size: 0.95rem; transition: border-color 0.3s; }
  input[type=number]:focus, input[type=text]:focus, select:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(0, 102, 255, 0.1); }
  .row { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; }
  .controls { display: flex; gap: 12px; flex-wrap: wrap; margin-top: 20px; }
  button { padding: 12px 20px; border-radius: 8px; border: none; font-size: 0.95rem; font-weight: 600; cursor: pointer; transition: all 0.3s; display: inline-flex; align-items: center; gap: 6px; background: white; border: 1px solid var(--border); color: var(--text); }
  button:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 4px 12px var(--shadow); }
  button:active:not(:disabled) { transform: translateY(0); }
  button:disabled { opacity: 0.5; cursor: not-allowed; }
  button.primary { background: var(--primary); color: white; border-color: var(--primary); }
  button.primary:hover:not(:disabled) { background: var(--primary-dark); }
  button.success { background: var(--success); color: white; border-color: var(--success); }
  button.danger { background: var(--error); color: white; border-color: var(--error); }
  .note { background: #f0f7ff; border-left: 4px solid var(--primary); padding: 12px 16px; border-radius: 6px; font-size: 0.9rem; margin-top: 16px; line-height: 1.6; }
  .note strong { color: var(--primary); }
  .list { margin-top: 16px; }
  .item { padding: 16px; border: 1px solid var(--border); border-radius: 8px; margin-bottom: 12px; display: flex; align-items: center; gap: 16px; background: white; transition: all 0.3s; }
  .item:hover { box-shadow: 0 4px 12px var(--shadow); border-color: var(--primary); }
  .thumb { width: 80px; height: 80px; object-fit: cover; border-radius: 8px; border: 2px solid var(--border); flex-shrink: 0; cursor: pointer; }
  .meta { flex: 1; min-width: 0; }
  .meta-title { font-weight: 600; margin-bottom: 4px; word-break: break-word; }
  .meta-info { display: flex; gap: 12px; flex-wrap: wrap; font-size: 0.85rem; color: var(--text-light); }
  .meta-info span { display: inline-flex; align-items: center; gap: 4px; }
  .size-badge { display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 0.8rem; font-weight: 600; }
  .size-badge.good { background: #d4edda; color: #155724; }
  .size-badge.warning { background: #fff3cd; color: #856404; }
  .actions { display: flex; flex-direction: column; gap: 8px; flex-shrink: 0; }
  .actions button { padding: 8px 16px; font-size: 0.85rem; white-space: nowrap; }
  .status { margin-top: 16px; padding: 12px 16px; border-radius: 8px; font-weight: 600; display: none; }
  .status.show { display: block; }
  .status.success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
  .status.error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
  .status.info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
  .progress-bar { width: 100%; height: 8px; background: #e0e0e8; border-radius: 4px; overflow: hidden; margin-top: 12px; display: none; }
  .progress-bar.show { display: block; }
  .progress-fill { height: 100%; background: var(--primary); transition: width 0.3s; border-radius: 4px; }
  .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 16px; margin-top: 16px; }
  .stat-card { background: linear-gradient(135deg, var(--primary) 0%, #0052cc 100%); color: white; padding: 16px; border-radius: 8px; text-align: center; }
  .stat-value { font-size: 1.8rem; font-weight: 700; margin-bottom: 4px; }
  .stat-label { font-size: 0.85rem; opacity: 0.9; }
  .empty-state { text-align: center; padding: 40px 20px; color: var(--text-light); }
  .empty-state svg { width: 64px; height: 64px; margin-bottom: 16px; opacity: 0.3; }
  .settings-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px; }
  .checkbox-group { display: flex; align-items: center; gap: 8px; margin-top: 12px; }
  .checkbox-group input[type=checkbox] { width: 20px; height: 20px; cursor: pointer; }
  .checkbox-group label { margin: 0; cursor: pointer; font-weight: 400; }
  @media (max-width: 768px) {
    body { padding: 12px; }
    .card { padding: 16px; }
    h1 { font-size: 1.5rem; }
    .item { flex-direction: column; align-items: flex-start; }
    .thumb { width: 100%; height: 200px; }
    .actions { width: 100%; flex-direction: row; }
    .actions button { flex: 1; }
    .controls { flex-direction: column; }
    .controls button { width: 100%; justify-content: center; }
  }
  .tooltip { position: relative; display: inline-block; cursor: help; }
  .tooltip .tooltiptext { visibility: hidden; width: 200px; background-color: #333; color: #fff; text-align: center; border-radius: 6px; padding: 8px; position: absolute; z-index: 1; bottom: 125%; left: 50%; margin-left: -100px; opacity: 0; transition: opacity 0.3s; font-size: 0.85rem; }
  .tooltip:hover .tooltiptext { visibility: visible; opacity: 1; }
  .preview-modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.9); align-items: center; justify-content: center; }
  .preview-modal.show { display: flex; }
  .preview-content { max-width: 90%; max-height: 90%; object-fit: contain; }
  .preview-close { position: absolute; top: 20px; right: 40px; color: white; font-size: 40px; font-weight: bold; cursor: pointer; }
</style>
</head>
<body>
  <div class="container">
    <h1>ğŸ–¼ï¸ ç”»åƒåœ§ç¸®ãƒ„ãƒ¼ãƒ« Pro</h1>
    <p class="subtitle">è¤‡æ•°ã®ç”»åƒã‚’ä¸€æ‹¬ã§10MBä»¥ä¸‹ã«è‡ªå‹•åœ§ç¸®ãƒ»ãƒªã‚µã‚¤ã‚ºãƒ»å¤‰æ›</p>

    <!-- è¨­å®šã‚«ãƒ¼ãƒ‰ -->
    <div class="card">
      <h2>âš™ï¸ è¨­å®š</h2>
      <div class="form-group">
        <label for="fileInput">ğŸ“ ç”»åƒã‚’é¸æŠï¼ˆè¤‡æ•°å¯ï¼‰ <span class="label-help">- JPG, PNG, WEBPå¯¾å¿œ</span></label>
        <input id="fileInput" type="file" accept="image/*" multiple />
      </div>

      <div class="settings-grid">
        <div class="form-group">
          <label for="maxSide">ğŸ“ æœ€å¤§é•·è¾ºã‚µã‚¤ã‚ºï¼ˆpxï¼‰ <span class="tooltip">â„¹ï¸<span class="tooltiptext">ç”»åƒã®é•·ã„æ–¹ã®è¾ºã‚’æŒ‡å®šã‚µã‚¤ã‚ºã«ç¸®å°ã—ã¾ã™</span></span></label>
          <input id="maxSide" type="number" value="2000" min="200" max="8000" step="100" />
        </div>

        <div class="form-group">
          <label for="initQuality">ğŸ¨ åˆæœŸJPEGå“è³ªï¼ˆ1-100ï¼‰ <span class="tooltip">â„¹ï¸<span class="tooltiptext">é«˜ã„ã»ã©é«˜å“è³ªã§ã™ãŒãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºã‚‚å¤§ãããªã‚Šã¾ã™</span></span></label>
          <input id="initQuality" type="number" value="85" min="10" max="100" step="5" />
        </div>

        <div class="form-group">
          <label for="targetSize">ğŸ’¾ ç›®æ¨™ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºï¼ˆMBï¼‰ <span class="tooltip">â„¹ï¸<span class="tooltiptext">ã“ã®å€¤ä»¥ä¸‹ã«ãªã‚‹ã¾ã§è‡ªå‹•èª¿æ•´ã—ã¾ã™</span></span></label>
          <input id="targetSize" type="number" value="10" min="0.5" max="50" step="0.5" />
        </div>
      </div>

      <div class="row">
        <div class="form-group">
          <label for="prefix">ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ«åãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ <span class="label-help">- ä¾‹: 20260130_æ¾ä¹ƒæœ¨é£¯åº—</span></label>
          <input id="prefix" type="text" placeholder="ä»»æ„ã®ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ï¼ˆçœç•¥å¯ï¼‰" />
        </div>

        <div class="form-group">
          <label for="category">ğŸ“‚ ä¿å­˜å…ˆã‚«ãƒ†ã‚´ãƒª <span class="label-help">- ZIPå†…ã®ãƒ•ã‚©ãƒ«ãƒ€å</span></label>
          <select id="category">
            <option value="general">ä¸€èˆ¬ (general)</option>
            <option value="kitchen">å¨æˆ¿ (kitchen)</option>
            <option value="hall">ãƒ›ãƒ¼ãƒ« (hall)</option>
            <option value="menu">ãƒ¡ãƒ‹ãƒ¥ãƒ¼ (menu)</option>
            <option value="sns">SNS (sns)</option>
            <option value="events">ã‚¤ãƒ™ãƒ³ãƒˆ (events)</option>
            <option value="products">å•†å“ (products)</option>
          </select>
        </div>
      </div>

      <div class="checkbox-group">
        <input type="checkbox" id="keepOriginalRatio" checked />
        <label for="keepOriginalRatio">ç¸¦æ¨ªæ¯”ã‚’ç¶­æŒã™ã‚‹ï¼ˆæ¨å¥¨ï¼‰</label>
      </div>

      <div class="checkbox-group">
        <input type="checkbox" id="removeExif" checked />
        <label for="removeExif">EXIFæƒ…å ±ã‚’å‰Šé™¤ã™ã‚‹ï¼ˆä½ç½®æƒ…å ±ç­‰ã‚’å‰Šé™¤ï¼‰</label>
      </div>

      <div class="controls">
        <button id="processBtn" class="primary">âš¡ åœ§ç¸®ãƒ»å¤‰æ›ã‚’å®Ÿè¡Œ</button>
        <button id="downloadAllBtn" class="success" disabled>ğŸ“¦ ã™ã¹ã¦ã‚’ZIPã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
        <button id="shareBtn" disabled>ğŸ“¤ å…±æœ‰ï¼ˆLINE/ãƒ¡ãƒ¼ãƒ«ç­‰ï¼‰</button>
        <button id="clearBtn" class="danger">ğŸ—‘ï¸ ã™ã¹ã¦ã‚¯ãƒªã‚¢</button>
      </div>

      <div class="progress-bar" id="progressBar"><div class="progress-fill" id="progressFill"></div></div>
      <div id="status" class="status"></div>

      <div class="note">
        <strong>ğŸ’¡ ä½¿ã„æ–¹:</strong><br>
        â‘  ç”»åƒã‚’é¸æŠï¼ˆè¤‡æ•°å¯ï¼‰<br>
        â‘¡ å¿…è¦ã«å¿œã˜ã¦è¨­å®šã‚’èª¿æ•´<br>
        â‘¢ã€Œåœ§ç¸®ãƒ»å¤‰æ›ã‚’å®Ÿè¡Œã€ã‚’ã‚¯ãƒªãƒƒã‚¯<br>
        â‘£ å®Œäº†å¾Œã€å€‹åˆ¥ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã¾ãŸã¯ZIPã§ä¸€æ‹¬ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰<br>
        <br>
        <strong>âœ¨ è‡ªå‹•æ©Ÿèƒ½:</strong> PNGâ†’JPGå¤‰æ›ã€ã‚µã‚¤ã‚ºèª¿æ•´ã€å“è³ªæœ€é©åŒ–ã€EXIFå‰Šé™¤
      </div>
    </div>

    <!-- çµ±è¨ˆã‚«ãƒ¼ãƒ‰ -->
    <div class="card" id="statsCard" style="display: none;">
      <h2>ğŸ“Š å‡¦ç†çµ±è¨ˆ</h2>
      <div class="stats">
        <div class="stat-card">
          <div class="stat-value" id="statCount">0</div>
          <div class="stat-label">å‡¦ç†æ¸ˆã¿ç”»åƒ</div>
        </div>
        <div class="stat-card" style="background: linear-gradient(135deg, #00a651 0%, #008741 100%);">
          <div class="stat-value" id="statOriginalSize">0 MB</div>
          <div class="stat-label">å…ƒã®ã‚µã‚¤ã‚º</div>
        </div>
        <div class="stat-card" style="background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);">
          <div class="stat-value" id="statCompressedSize">0 MB</div>
          <div class="stat-label">åœ§ç¸®å¾Œã‚µã‚¤ã‚º</div>
        </div>
        <div class="stat-card" style="background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);">
          <div class="stat-value" id="statSaved">0%</div>
          <div class="stat-label">å‰Šæ¸›ç‡</div>
        </div>
      </div>
    </div>

    <!-- å‡¦ç†æ¸ˆã¿ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ -->
    <div class="card">
      <h2>ğŸ“‹ å‡¦ç†æ¸ˆã¿ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ <span class="badge" id="fileCountBadge">0</span></h2>
      <div id="list" class="list">
        <div class="empty-state">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
            <circle cx="8.5" cy="8.5" r="1.5"></circle>
            <polyline points="21 15 16 10 5 21"></polyline>
          </svg>
          <p>ã¾ã å‡¦ç†æ¸ˆã¿ã®ç”»åƒãŒã‚ã‚Šã¾ã›ã‚“</p>
          <p style="font-size: 0.85rem;">ä¸Šéƒ¨ã‹ã‚‰ç”»åƒã‚’é¸æŠã—ã¦åœ§ç¸®ã‚’é–‹å§‹ã—ã¦ãã ã•ã„</p>
        </div>
      </div>
    </div>
  </div>

  <!-- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="previewModal" class="preview-modal">
    <span class="preview-close" id="previewClose">&times;</span>
    <img class="preview-content" id="previewImage" />
  </div>

  <!-- JSZip CDN -->
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>

<script>
// ============================================================================
// ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã¨å®šæ•°
// ============================================================================
let processedFiles = []; // {file: File, name: string, category: string, blobUrl: string, originalSize: number, compressedSize: number, dimensions: string, compressionRatio: string}
let originalTotalSize = 0;

const elements = {
  fileInput: document.getElementById('fileInput'),
  processBtn: document.getElementById('processBtn'),
  listEl: document.getElementById('list'),
  statusEl: document.getElementById('status'),
  downloadAllBtn: document.getElementById('downloadAllBtn'),
  shareBtn: document.getElementById('shareBtn'),
  clearBtn: document.getElementById('clearBtn'),
  progressBar: document.getElementById('progressBar'),
  progressFill: document.getElementById('progressFill'),
  fileCountBadge: document.getElementById('fileCountBadge'),
  statsCard: document.getElementById('statsCard'),
  previewModal: document.getElementById('previewModal'),
  previewImage: document.getElementById('previewImage'),
  previewClose: document.getElementById('previewClose')
};

// ============================================================================
// ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
// ============================================================================
function formatBytes(bytes) {
  if (bytes === 0) return '0 B';
  if (bytes < 1024) return bytes + ' B';
  if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
  return (bytes / (1024 * 1024)).toFixed(2) + ' MB';
}

function showStatus(message, type = 'info') {
  elements.statusEl.textContent = message;
  elements.statusEl.className = 'status show ' + type;
  if (type === 'success') {
    setTimeout(() => { elements.statusEl.classList.remove('show'); }, 3000);
  }
}

function updateProgress(percent) {
  if (percent > 0) {
    elements.progressBar.classList.add('show');
    elements.progressFill.style.width = percent + '%';
  } else {
    elements.progressBar.classList.remove('show');
    elements.progressFill.style.width = '0%';
  }
}

function updateStats() {
  if (processedFiles.length === 0) {
    elements.statsCard.style.display = 'none';
    return;
  }
  elements.statsCard.style.display = 'block';
  const totalOriginal = processedFiles.reduce((s, f) => s + (f.originalSize || 0), 0);
  const totalCompressed = processedFiles.reduce((s, f) => s + (f.compressedSize || 0), 0);
  const savedPercent = totalOriginal > 0 ? ((totalOriginal - totalCompressed) / totalOriginal * 100).toFixed(1) : 0;
  document.getElementById('statCount').textContent = processedFiles.length;
  document.getElementById('statOriginalSize').textContent = formatBytes(totalOriginal);
  document.getElementById('statCompressedSize').textContent = formatBytes(totalCompressed);
  document.getElementById('statSaved').textContent = savedPercent + '%';
}

function updateFileCountBadge() {
  elements.fileCountBadge.textContent = processedFiles.length;
}

function updateButtonStates() {
  const hasFiles = processedFiles.length > 0;
  elements.downloadAllBtn.disabled = !hasFiles;
  elements.shareBtn.disabled = !hasFiles;
}

// ============================================================================
// ç”»åƒå‡¦ç†é–¢æ•°
// ============================================================================
async function loadImageFromFile(file) {
  return new Promise((resolve, reject) => {
    const img = new Image();
    img.onload = () => { URL.revokeObjectURL(img.src); resolve(img); };
    img.onerror = () => { URL.revokeObjectURL(img.src); reject(new Error('ç”»åƒã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ')); };
    img.src = URL.createObjectURL(file);
  });
}

async function canvasToJpegBlob(canvas, quality) {
  return new Promise((resolve) => {
    canvas.toBlob(blob => resolve(blob), 'image/jpeg', quality);
  });
}

function calculateResizedDimensions(width, height, maxSide, keepRatio) {
  if (!keepRatio) {
    return { width: maxSide, height: maxSide };
  }
  const maxDimension = Math.max(width, height);
  if (maxDimension <= maxSide) return { width, height };
  const ratio = maxSide / maxDimension;
  return { width: Math.round(width * ratio), height: Math.round(height * ratio) };
}

async function compressImage(file, options) {
  const {
    maxSide = 2000,
    initQuality = 85,
    targetSizeMB = 10,
    prefix = '',
    index = 1,
    category = 'general',
    keepOriginalRatio = true,
    removeExif = true
  } = options;

  const targetBytes = targetSizeMB * 1024 * 1024;
  const originalSize = file.size;
  const img = await loadImageFromFile(file);

  let currentMaxSide = maxSide;
  let quality = initQuality / 100;
  let blob = null;
  let attempts = 0;
  const maxAttempts = 20;
  let lastCanvas = null;

  while (attempts < maxAttempts) {
    attempts++;
    const dimensions = calculateResizedDimensions(img.naturalWidth, img.naturalHeight, currentMaxSide, keepOriginalRatio);
    const canvas = document.createElement('canvas');
    canvas.width = Math.max(1, dimensions.width);
    canvas.height = Math.max(1, dimensions.height);
    lastCanvas = canvas;
    const ctx = canvas.getContext('2d');
    ctx.fillStyle = '#ffffff';
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    ctx.imageSmoothingEnabled = true;
    ctx.imageSmoothingQuality = 'high';
    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
    blob = await canvasToJpegBlob(canvas, quality);
    if (blob.size <= targetBytes) break;
    if (quality > 0.35) {
      quality = Math.max(0.35, quality - 0.1);
    } else if (currentMaxSide > 400) {
      currentMaxSide = Math.round(currentMaxSide * 0.85);
      quality = Math.max(0.35, quality); // keep low quality
    } else {
      break;
    }
  }

  const timestamp = new Date().toISOString().replace(/[-:]/g, '').replace(/\..+/, '').slice(0, 15);
  const safePrefix = (prefix || '').replace(/[^\w\-ã-ã‚“ã‚¡-ãƒ¶ãƒ¼ä¸€-é¾¯]/g, '').slice(0, 30);
  const paddedIndex = String(index).padStart(3, '0');
  const fileName = `${safePrefix ? safePrefix + '_' : ''}${timestamp}_${paddedIndex}.jpg`;
  const compressedFile = new File([blob], fileName, { type: 'image/jpeg' });

  return {
    file: compressedFile,
    name: fileName,
    category,
    blobUrl: URL.createObjectURL(blob),
    originalSize,
    compressedSize: blob.size,
    dimensions: lastCanvas ? `${lastCanvas.width}Ã—${lastCanvas.height}` : `${img.naturalWidth}Ã—${img.naturalHeight}`,
    compressionRatio: originalSize > 0 ? ((1 - blob.size / originalSize) * 100).toFixed(1) : '0.0'
  };
}

// ============================================================================
// UIæ›´æ–°é–¢æ•°
// ============================================================================
function renderFileList() {
  if (processedFiles.length === 0) {
    elements.listEl.innerHTML = `
      <div class="empty-state">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
          <circle cx="8.5" cy="8.5" r="1.5"></circle>
          <polyline points="21 15 16 10 5 21"></polyline>
        </svg>
        <p>ã¾ã å‡¦ç†æ¸ˆã¿ã®ç”»åƒãŒã‚ã‚Šã¾ã›ã‚“</p>
        <p style="font-size: 0.85rem;">ä¸Šéƒ¨ã‹ã‚‰ç”»åƒã‚’é¸æŠã—ã¦åœ§ç¸®ã‚’é–‹å§‹ã—ã¦ãã ã•ã„</p>
      </div>
    `;
    return;
  }

  elements.listEl.innerHTML = '';
  processedFiles.forEach((item, index) => {
    const div = document.createElement('div');
    div.className = 'item';
    const sizeClass = item.compressedSize < 5 * 1024 * 1024 ? 'good' : 'warning';
    const compressionRatio = item.compressionRatio || 0;
    div.innerHTML = `
      <img class="thumb" src="${item.blobUrl}" alt="${item.name}" data-index="${index}" />
      <div class="meta">
        <div class="meta-title">${item.name}</div>
        <div class="meta-info">
          <span>ğŸ“‚ ${item.category}</span>
          <span>ğŸ“ ${item.dimensions}</span>
          <span><span class="size-badge ${sizeClass}">${formatBytes(item.compressedSize)}</span></span>
          <span>ğŸ“‰ ${compressionRatio}% å‰Šæ¸›</span>
        </div>
      </div>
      <div class="actions">
        <button class="download-btn" data-index="${index}">ğŸ’¾ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
        <button class="preview-btn" data-index="${index}">ğŸ‘ï¸ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</button>
        <button class="danger remove-btn" data-index="${index}">ğŸ—‘ï¸ å‰Šé™¤</button>
      </div>
    `;
    elements.listEl.appendChild(div);
  });

  attachFileListEventListeners();
}

function attachFileListEventListeners() {
  document.querySelectorAll('.download-btn').forEach(btn => {
    btn.onclick = (e) => {
      const index = parseInt(e.currentTarget.dataset.index, 10);
      const item = processedFiles[index];
      const a = document.createElement('a');
      a.href = item.blobUrl;
      a.download = item.name;
      document.body.appendChild(a);
      a.click();
      a.remove();
    };
  });

  document.querySelectorAll('.preview-btn').forEach(btn => {
    btn.onclick = (e) => {
      const index = parseInt(e.currentTarget.dataset.index, 10);
      const item = processedFiles[index];
      elements.previewImage.src = item.blobUrl;
      elements.previewModal.classList.add('show');
    };
  });

  // ã‚µãƒ ãƒã‚¤ãƒ«ã‚¯ãƒªãƒƒã‚¯ã§ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
  document.querySelectorAll('.thumb').forEach(img => {
    img.onclick = (e) => {
      const index = parseInt(e.currentTarget.dataset.index, 10);
      const item = processedFiles[index];
      elements.previewImage.src = item.blobUrl;
      elements.previewModal.classList.add('show');
    };
  });

  document.querySelectorAll('.remove-btn').forEach(btn => {
    btn.onclick = (e) => {
      const index = parseInt(e.currentTarget.dataset.index, 10);
      removeFile(index);
    };
  });
}

function removeFile(index) {
  const item = processedFiles[index];
  try { URL.revokeObjectURL(item.blobUrl); } catch(e){}
  processedFiles.splice(index, 1);
  renderFileList();
  updateStats();
  updateFileCountBadge();
  updateButtonStates();
  showStatus('ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤ã—ã¾ã—ãŸ', 'success');
}

function clearAll() {
  processedFiles.forEach(item => { try { URL.revokeObjectURL(item.blobUrl); } catch(e){} });
  processedFiles = [];
  originalTotalSize = 0;
  elements.fileInput.value = '';
  renderFileList();
  updateStats();
  updateFileCountBadge();
  updateButtonStates();
  updateProgress(0);
  showStatus('ã™ã¹ã¦ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ', 'success');
}

// ============================================================================
// ãƒ¡ã‚¤ãƒ³å‡¦ç†
// ============================================================================
async function processImages() {
  const files = Array.from(elements.fileInput.files || []);
  if (files.length === 0) {
    showStatus('ç”»åƒã‚’é¸æŠã—ã¦ãã ã•ã„', 'error');
    return;
  }

  const maxSide = parseInt(document.getElementById('maxSide').value) || 2000;
  const initQuality = parseInt(document.getElementById('initQuality').value) || 85;
  const targetSize = parseFloat(document.getElementById('targetSize').value) || 10;
  const prefix = document.getElementById('prefix').value.trim();
  const category = document.getElementById('category').value || 'general';
  const keepOriginalRatio = document.getElementById('keepOriginalRatio').checked;
  const removeExif = document.getElementById('removeExif').checked;

  if (maxSide < 200 || maxSide > 8000) {
    showStatus('æœ€å¤§é•·è¾ºã‚µã‚¤ã‚ºã¯200ã€œ8000ã®ç¯„å›²ã§æŒ‡å®šã—ã¦ãã ã•ã„', 'error');
    return;
  }
  if (initQuality < 10 || initQuality > 100) {
    showStatus('åˆæœŸå“è³ªã¯10ã€œ100ã®ç¯„å›²ã§æŒ‡å®šã—ã¦ãã ã•ã„', 'error');
    return;
  }

  elements.processBtn.disabled = true;
  showStatus(`${files.length}å€‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‡¦ç†ä¸­...`, 'info');

  let processedCount = 0;
  const startIndex = processedFiles.length + 1;

  for (let i = 0; i < files.length; i++) {
    try {
      const file = files[i];
      const progress = Math.round(((i + 1) / files.length) * 100);
      updateProgress(progress);
      showStatus(`å‡¦ç†ä¸­ ${i + 1}/${files.length}: ${file.name}`, 'info');

      const result = await compressImage(file, {
        maxSide,
        initQuality,
        targetSizeMB: targetSize,
        prefix,
        index: startIndex + i,
        category,
        keepOriginalRatio,
        removeExif
      });

      processedFiles.push(result);
      processedCount++;

      renderFileList();
      updateStats();
      updateFileCountBadge();
      updateButtonStates();

      await new Promise(resolve => setTimeout(resolve, 50));
    } catch (error) {
      console.error('ç”»åƒå‡¦ç†ã‚¨ãƒ©ãƒ¼:', error);
      showStatus(`ã‚¨ãƒ©ãƒ¼: ${files[i].name} - ${error.message}`, 'error');
    }
  }

  updateProgress(0);
  elements.processBtn.disabled = false;
  showStatus(`âœ… ${processedCount}å€‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‡¦ç†ã—ã¾ã—ãŸ`, 'success');
}

// ZIP ä½œæˆã¨ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
async function downloadAsZip() {
  if (processedFiles.length === 0) {
    showStatus('å‡¦ç†æ¸ˆã¿ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚Šã¾ã›ã‚“', 'error');
    return;
  }
  showStatus('ZIPä½œæˆä¸­...', 'info');
  elements.downloadAllBtn.disabled = true;
  const zip = new JSZip();
  const groups = {};
  processedFiles.forEach(p => {
    if (!groups[p.category]) groups[p.category] = [];
    groups[p.category].push(p);
  });
  for (const cat of Object.keys(groups)) {
    const folder = zip.folder(cat);
    for (const p of groups[cat]) {
      const blob = await fetch(p.blobUrl).then(r => r.blob());
      folder.file(p.name, blob);
    }
  }
  const content = await zip.generateAsync({ type: 'blob' }, (meta) => {
    // optional progress callback
    const percent = Math.round((meta.percent || 0));
    updateProgress(percent);
  });
  const url = URL.createObjectURL(content);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'images_' + new Date().toISOString().slice(0,19).replace(/[:T]/g,'') + '.zip';
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
  updateProgress(0);
  elements.downloadAllBtn.disabled = false;
  showStatus('ZIPã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ', 'success');
}

// å…±æœ‰ï¼ˆWeb Share API ã‚’è©¦ã¿ã‚‹ï¼‰
async function shareFiles() {
  if (processedFiles.length === 0) {
    showStatus('å‡¦ç†æ¸ˆã¿ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚Šã¾ã›ã‚“', 'error');
    return;
  }
  showStatus('å…±æœ‰å‡¦ç†ã‚’é–‹å§‹ã—ã¾ã™...', 'info');
  try {
    const blobs = await Promise.all(processedFiles.map(p => fetch(p.blobUrl).then(r => r.blob())));
    const shareFiles = blobs.map((b, i) => new File([b], processedFiles[i].name, { type: b.type }));
    if (navigator.canShare && navigator.canShare({ files: shareFiles })) {
      await navigator.share({ files: shareFiles, title: 'åœ§ç¸®ç”»åƒ', text: 'åœ§ç¸®æ¸ˆã¿ç”»åƒã‚’å…±æœ‰ã—ã¾ã™ã€‚' });
      showStatus('å…±æœ‰ãŒå®Œäº†ã—ã¾ã—ãŸ', 'success');
      return;
    } else if (navigator.share) {
      await navigator.share({ title: 'åœ§ç¸®ç”»åƒ', text: 'ç”»åƒã‚’å…±æœ‰ã—ã¾ã™ã€‚ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦æ·»ä»˜ã—ã¦ãã ã•ã„ã€‚' });
      showStatus('å…±æœ‰ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’é–‹ãã¾ã—ãŸï¼ˆãƒ•ã‚¡ã‚¤ãƒ«æ·»ä»˜ã¯ç’°å¢ƒä¾å­˜ï¼‰', 'success');
      return;
    } else {
      throw new Error('ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯å…±æœ‰ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“');
    }
  } catch (err) {
    console.warn('å…±æœ‰ã‚¨ãƒ©ãƒ¼:', err);
    showStatus('ç›´æ¥å…±æœ‰ã§ãã¾ã›ã‚“ã€‚ZIPã‚’ä½œæˆã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã€‚', 'error');
    await downloadAsZip();
  }
}

// ============================================================================
// ã‚¤ãƒ™ãƒ³ãƒˆæ¥ç¶š
// ============================================================================
elements.processBtn.addEventListener('click', processImages);
elements.downloadAllBtn.addEventListener('click', downloadAsZip);
elements.shareBtn.addEventListener('click', shareFiles);
elements.clearBtn.addEventListener('click', clearAll);
elements.previewClose.addEventListener('click', () => {
  elements.previewModal.classList.remove('show');
  elements.previewImage.src = '';
});
elements.previewModal.addEventListener('click', (e) => {
  if (e.target === elements.previewModal) {
    elements.previewModal.classList.remove('show');
    elements.previewImage.src = '';
  }
});

// ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠæ™‚ã«ç°¡å˜ãªãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆä»»æ„ï¼‰
elements.fileInput.addEventListener('change', () => {
  const files = Array.from(elements.fileInput.files || []);
  if (files.length > 0) {
    showStatus(`${files.length}å€‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã•ã‚Œã¾ã—ãŸã€‚è¨­å®šã‚’ç¢ºèªã—ã¦ã€Œåœ§ç¸®ãƒ»å¤‰æ›ã‚’å®Ÿè¡Œã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚`, 'info');
  }
});

// ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚¢ãƒ³ãƒ­ãƒ¼ãƒ‰æ™‚ã« Blob URL ã‚’è§£æ”¾
window.addEventListener('beforeunload', () => {
  processedFiles.forEach(p => { try { URL.revokeObjectURL(p.blobUrl); } catch(e){} });
});
</script>
</body>
</html>
