<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>メモアプリ</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 1em;
      background-color: #fff;
      color: #000;
    }
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1em;
    }
    h1 {
      margin: 0;
    }
    .button {
      margin: 0.2em;
      padding: 0.5em 1em;
      cursor: pointer;
      border: 1px solid #aaa;
      background-color: #f0f0f0;
      border-radius: 4px;
    }
    .button:hover {
      background-color: #e0e0e0;
    }
    textarea {
      width: 100%;
      box-sizing: border-box;
      font-size: 1em;
    }
    .memo {
      border: 1px solid #ccc;
      padding: 0.5em;
      margin-bottom: 0.5em;
      border-radius: 4px;
      background-color: #fafafa;
    }
    .memoHeader {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.3em;
    }
    pre.memoText {
      white-space: pre-wrap;
      word-wrap: break-word;
      margin: 0;
    }
    .memoImage {
      max-width: 100%;
      margin-top: 0.5em;
    }
    .hint {
      font-size: 0.9em;
      color: #666;
    }
    /* ダークモード */
    .dark-mode {
      background-color: #222;
      color: #eee;
    }
    .dark-mode .memo {
      border-color: #555;
      background-color: #333;
    }
  </style>
</head>
<body>
  <header>
    <h1>メモアプリ</h1>
    <button id="toggleDarkMode" class="button">ダークモード切替</button>
  </header>
  <main>
    <!-- 入力部 -->
    <section id="memoInputSection">
      <textarea id="memoText" placeholder="メモを入力してください..." rows="6"></textarea>
      <br>
      <label for="imageInput" class="button">画像選択</label>
      <input type="file" id="imageInput" accept="image/*" style="display:none">
      <button id="capturePhoto" class="button">写真撮影</button>
      <button id="voiceInput" class="button">音声入力</button>
      <p class="hint">※ ダブルクリック（またはヒントをタップ）で自動保存</p>
      <!-- カメラ用プレビュー -->
      <div id="cameraSection" style="display:none; margin-top:1em;">
         <video id="video" autoplay style="width:100%; max-height:300px;"></video>
         <br>
         <button id="takePhoto" class="button">キャプチャ</button>
         <button id="closeCamera" class="button">キャンセル</button>
      </div>
      <!-- 選択・撮影した画像のプレビュー -->
      <div id="imagePreviewContainer" style="display:none; margin-top:1em;">
         <img id="imagePreview" alt="選択された画像" style="max-width:100%;">
         <br>
         <button id="removeImage" class="button">画像削除</button>
      </div>
    </section>
    
    <hr>
    
    <!-- アクション部（並び替え、検索、全削除、エクスポート／インポート、印刷） -->
    <section id="memoActions" style="margin-bottom:1em;">
      <select id="sortOrder" class="button">
        <option value="newest">新しい順</option>
        <option value="oldest">古い順</option>
      </select>
      <input type="text" id="searchInput" placeholder="検索..." class="button">
      <button id="deleteAll" class="button">全削除</button>
      <button id="exportMemos" class="button">エクスポート</button>
      <input type="file" id="importInput" accept=".html" style="display:none">
      <label for="importInput" class="button">インポート</label>
      <button id="printMemos" class="button">印刷／PDF</button>
    </section>
    
    <!-- メモ一覧部 -->
    <section id="memoListSection">
      <h2>メモ一覧</h2>
      <div id="memoList"></div>
    </section>
  </main>
  
  <script>
    // メモのデータ構造：各メモは { id, timestamp, text, image } のオブジェクト
    let memos = [];
    const memoText = document.getElementById('memoText');
    const imageInput = document.getElementById('imageInput');
    const imagePreviewContainer = document.getElementById('imagePreviewContainer');
    const imagePreview = document.getElementById('imagePreview');
    const removeImage = document.getElementById('removeImage');
    const memoList = document.getElementById('memoList');
    const sortOrder = document.getElementById('sortOrder');
    const searchInput = document.getElementById('searchInput');
    const deleteAllBtn = document.getElementById('deleteAll');
    const exportBtn = document.getElementById('exportMemos');
    const importInput = document.getElementById('importInput');
    const printMemosBtn = document.getElementById('printMemos');
    const toggleDarkModeBtn = document.getElementById('toggleDarkMode');
    
    // カメラ用要素
    const video = document.getElementById('video');
    const capturePhotoBtn = document.getElementById('capturePhoto');
    const cameraSection = document.getElementById('cameraSection');
    const takePhotoBtn = document.getElementById('takePhoto');
    const closeCameraBtn = document.getElementById('closeCamera');
    
    let currentImageData = null;
    
    // localStorage からメモを読み込む
    function loadMemos() {
      const savedMemos = localStorage.getItem('memos');
      if (savedMemos) {
        try {
          memos = JSON.parse(savedMemos);
        } catch(e) {
          console.error('メモデータ解析エラー:', e);
          memos = [];
        }
      }
      renderMemoList();
    }
    
    // localStorage にメモを保存する
    function saveMemos() {
      localStorage.setItem('memos', JSON.stringify(memos));
      renderMemoList();
    }
    
    // メモ一覧を表示（並び替え・検索に対応）
    function renderMemoList() {
      let filteredMemos = memos.filter(memo => memo.text.includes(searchInput.value));
      if (sortOrder.value === 'newest') {
        filteredMemos.sort((a, b) => b.timestamp - a.timestamp);
      } else {
        filteredMemos.sort((a, b) => a.timestamp - b.timestamp);
      }
      memoList.innerHTML = '';
      filteredMemos.forEach(memo => {
        const memoDiv = document.createElement('div');
        memoDiv.className = 'memo';
        const date = new Date(memo.timestamp);
        memoDiv.innerHTML = `
          <div class="memoHeader">
            <span>${date.toLocaleString()}</span>
            <button class="editMemo button" data-id="${memo.id}">修正</button>
            <button class="deleteMemo button" data-id="${memo.id}">削除</button>
          </div>
          <pre class="memoText">${memo.text}</pre>
          ${memo.image ? `<img src="${memo.image}" alt="メモ画像" class="memoImage">` : ''}
        `;
        memoList.appendChild(memoDiv);
      });
    }
    
    // 新規メモの追加
    function addMemo() {
      const text = memoText.value;
      if (!text.trim() && !currentImageData) {
        alert("メモ内容または画像を入力してください。");
        return;
      }
      const memo = {
        id: Date.now(),
        timestamp: Date.now(),
        text: text,
        image: currentImageData
      };
      memos.push(memo);
      memoText.value = '';
      currentImageData = null;
      imagePreviewContainer.style.display = 'none';
      imagePreview.src = '';
      saveMemos();
    }
    
    // メモの編集（prompt を利用）
    function editMemo(id) {
      const memo = memos.find(m => m.id == id);
      if (!memo) return;
      const newText = prompt("メモを修正してください:", memo.text);
      if (newText !== null) {
        memo.text = newText;
        memo.timestamp = Date.now(); // 更新時刻を更新
        saveMemos();
      }
    }
    
    // メモの削除
    function deleteMemo(id) {
      memos = memos.filter(m => m.id != id);
      saveMemos();
    }
    
    // 全削除
    function deleteAllMemos() {
      if (confirm("本当に全てのメモを削除しますか？")) {
        memos = [];
        saveMemos();
      }
    }
    
    // エクスポート：メモデータを JSON として特殊コメントに埋め込んだ自己完結型 HTML を作成
    function exportMemos() {
      const memoDataComment = `<!--MEMO_DATA_START-->${JSON.stringify(memos)}<!--MEMO_DATA_END-->`;
      const htmlContent = `
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <title>高速メモ</title>
</head>
<body>
${memoDataComment}
<h1>エクスポートされたメモ</h1>
<!-- このサンプルではメモ表示用コードは含まれていません -->
</body>
</html>
`;
      const blob = new Blob([htmlContent], { type: 'text/html' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = "高速メモ.html";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }
    
    // インポート：エクスポートした HTML から特殊コメント内の JSON を抽出してメモに復元
    function importMemos(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(e) {
        const content = e.target.result;
        const regex = /<!--MEMO_DATA_START-->([\s\S]*?)<!--MEMO_DATA_END-->/;
        const match = content.match(regex);
        if (match && match[1]) {
          try {
            const importedMemos = JSON.parse(match[1]);
            memos = memos.concat(importedMemos);
            saveMemos();
            alert("メモのインポートに成功しました。");
          } catch (err) {
            alert("インポートに失敗しました。データが正しくありません。");
          }
        } else {
          alert("インポートに失敗しました。データが見つかりません。");
        }
      };
      reader.readAsText(file);
    }
    
    // ブラウザの印刷ダイアログを起動
    function printMemos() {
      window.print();
    }
    
    // 音声入力（Web Speech API を利用）
    function startVoiceInput() {
      if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
        alert("このブラウザは音声認識に対応していません。");
        return;
      }
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      const recognition = new SpeechRecognition();
      recognition.lang = 'ja-JP';
      recognition.interimResults = false;
      recognition.maxAlternatives = 1;
      recognition.start();
      recognition.onresult = function(event) {
        const transcript = event.results[0][0].transcript;
        memoText.value += transcript;
      };
      recognition.onerror = function(event) {
        console.error("認識エラー:", event.error);
      };
    }
    
    // カメラ撮影用（getUserMedia を利用）
    function startCamera() {
      if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
        navigator.mediaDevices.getUserMedia({ video: { facingMode: { exact: "environment" } } })
        .then((stream) => {
          video.srcObject = stream;
          cameraSection.style.display = 'block';
        })
        .catch((err) => {
          console.error("カメラアクセスエラー:", err);
          alert("カメラにアクセスできませんでした。");
        });
      } else {
        alert("このブラウザはカメラに対応していません。");
      }
    }
    
    function stopCamera() {
      const stream = video.srcObject;
      if (stream) {
        stream.getTracks().forEach(track => track.stop());
      }
      video.srcObject = null;
      cameraSection.style.display = 'none';
    }
    
    function capturePhoto() {
      const canvas = document.createElement('canvas');
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
      currentImageData = canvas.toDataURL('image/png');
      imagePreview.src = currentImageData;
      imagePreviewContainer.style.display = 'block';
      stopCamera();
    }
    
    // --- イベントリスナー ---
    
    document.addEventListener('DOMContentLoaded', loadMemos);
    sortOrder.addEventListener('change', renderMemoList);
    searchInput.addEventListener('input', renderMemoList);
    deleteAllBtn.addEventListener('click', deleteAllMemos);
    exportBtn.addEventListener('click', exportMemos);
    importInput.addEventListener('change', importMemos);
    printMemosBtn.addEventListener('click', printMemos);
    toggleDarkModeBtn.addEventListener('click', () => {
      document.body.classList.toggle('dark-mode');
    });
    
    // 画像ファイル選択時の処理
    imageInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function(event) {
          currentImageData = event.target.result;
          imagePreview.src = currentImageData;
          imagePreviewContainer.style.display = 'block';
        };
        reader.readAsDataURL(file);
      }
    });
    
    removeImage.addEventListener('click', () => {
      currentImageData = null;
      imagePreviewContainer.style.display = 'none';
      imagePreview.src = '';
    });
    
    // 写真撮影
    capturePhotoBtn.addEventListener('click', startCamera);
    closeCameraBtn.addEventListener('click', stopCamera);
    takePhotoBtn.addEventListener('click', capturePhoto);
    
    // 音声入力
    document.getElementById('voiceInput').addEventListener('click', startVoiceInput);
    
    // ページ上のインタラクティブ要素以外をダブルクリック／タップで保存
    document.addEventListener('dblclick', function(e) {
      const tagName = e.target.tagName.toLowerCase();
      if (['input', 'textarea', 'button', 'label'].includes(tagName)) return;
      addMemo();
    });
    // ヒントテキストのクリックでも保存
    document.querySelector('.hint').addEventListener('click', addMemo);
    
    // 編集／削除ボタンのイベント（イベントデリゲーション）
    memoList.addEventListener('click', (e) => {
      if (e.target.classList.contains('editMemo')) {
        editMemo(e.target.dataset.id);
      } else if (e.target.classList.contains('deleteMemo')) {
        deleteMemo(e.target.dataset.id);
      }
    });
    
    // Ctrl+S (または Cmd+S) で保存（デフォルトのショートカットを防ぐ）
    document.addEventListener('keydown', function(e) {
      if ((e.ctrlKey || e.metaKey) && e.key === 's') {
        e.preventDefault();
        addMemo();
      }
    });
  </script>
</body>
</html>
