<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>メモアプリ</title>
  <style>
    /* 基本のスタイル */
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      margin: 0;
      background-color: #f0f0f0;
      color: #333;
    }
    /* ダークモードのスタイル */
    .dark-mode {
      background-color: #333;
      color: #eee;
    }
    textarea {
      width: 100%;
      height: 150px;
      padding: 10px;
      font-size: 16px;
      margin-bottom: 10px;
      box-sizing: border-box;
    }
    .custom-button {
      padding: 10px 15px;
      background-color: #007BFF;
      color: white;
      border: none;
      margin-right: 5px;
      cursor: pointer;
      display: inline-block;
    }
    .custom-button:hover {
      background-color: #0056b3;
    }
    #memo-list {
      margin-top: 20px;
    }
    .memo {
      border: 1px solid #ddd;
      padding: 10px;
      margin-bottom: 10px;
      background: white;
    }
    .memo img {
      max-width: 100%;
      height: auto;
      display: block;
      margin-top: 10px;
    }
    .memo-buttons {
      margin-top: 10px;
    }
    button {
      padding: 6px 10px;
      margin-right: 5px;
      cursor: pointer;
    }
    #video-preview {
      max-width: 100%;
      border: 1px solid #ddd;
      margin-bottom: 10px;
    }
    /* 手書きメモ用のキャンバス */
    #handwrite-canvas {
      border: 1px solid #ccc;
      touch-action: none;
    }
    @media (max-width: 600px) {
      textarea {
        height: 100px;
      }
      .custom-button {
        padding: 8px 12px;
      }
    }
  </style>
</head>
<body>
  <h1>メモアプリ</h1>
  
  <!-- メモ入力セクション -->
  <textarea id="memo-text" placeholder="メモを入力してください..."></textarea>
  <div>
    <label for="image-upload" class="custom-button">画像選択</label>
    <input type="file" id="image-upload" accept="image/*" style="display:none">
    <button id="photo-capture" class="custom-button">写真撮影</button>
    <button id="voice-input" class="custom-button">音声入力</button>
    <!-- 音声入力中のフィードバック表示 -->
    <span id="voice-status" style="display:none; margin-left:10px;">音声入力中…</span>
    <button id="handwrite-input" class="custom-button">手書きメモ</button>
    <button id="toggle-dark-mode" class="custom-button">ダークモード切替</button>
  </div>
  
  <!-- カメラプレビューセクション -->
  <div id="camera-section" style="margin-top:10px;">
    <video id="video-preview" autoplay playsinline style="display:none;"></video>
    <br>
    <button id="capture-photo" class="custom-button" style="display:none;">写真を撮る</button>
    <button id="cancel-photo" class="custom-button" style="display:none;">キャンセル</button>
  </div>
  
  <!-- 手書きメモセクション -->
  <div id="handwrite-section" style="display:none; margin-top:10px;">
    <canvas id="handwrite-canvas" width="300" height="200"></canvas>
    <div style="margin-top:5px;">
      <button id="clear-handwrite" class="custom-button">クリア</button>
      <button id="save-handwrite" class="custom-button">手書きメモ保存</button>
      <button id="cancel-handwrite" class="custom-button">キャンセル</button>
    </div>
  </div>
  
  <!-- ソート、検索、エクスポート／インポート、印刷／PDF、全削除 -->
  <div style="margin-top: 10px;">
    <select id="sort-order">
      <option value="newest">新着順</option>
      <option value="oldest">古い順</option>
    </select>
    <input type="text" id="search-box" placeholder="メモ検索...">
    <button id="export-memos" class="custom-button">メモをエクスポート</button>
    <label for="import-file" class="custom-button">メモをインポート</label>
    <input type="file" id="import-file" accept=".html" style="display:none">
    <button id="print-memos" class="custom-button">印刷 / PDF</button>
    <button id="delete-all" class="custom-button">全削除</button>
  </div>
  
  <!-- ダブルクリック保存のヒント -->
  <p id="double-click-hint" style="cursor:pointer; text-decoration:underline;">どこでもダブルクリックするとメモが保存されます</p>
  
  <!-- メモリスト -->
  <div id="memo-list"></div>
  
  <script>
    // グローバル変数
    let memos = []; // メモオブジェクトを保存する配列
    let currentImageData = null; // 現在の画像のデータURL（画像や手書き、写真）
    let recognition = null; // 音声認識インスタンス
    let stream = null; // カメラ用の MediaStream

    // 初回読み込み時に localStorage からメモをロード
    function loadMemos() {
      const stored = localStorage.getItem('memos');
      if (stored) {
        try {
          memos = JSON.parse(stored);
        } catch(e) {
          console.error('メモの解析エラー: ', e);
          memos = [];
        }
      }
    }
    
    // メモ配列を localStorage に保存する
    function saveMemosToStorage() {
      localStorage.setItem('memos', JSON.stringify(memos));
    }
    
    // ソート・検索フィルターを適用して、表示されるメモリストを更新する
    function updateMemoList() {
      const memoListDiv = document.getElementById('memo-list');
      memoListDiv.innerHTML = '';
      let filteredMemos = memos;
      
      // 検索クエリがあればフィルターを適用
      const query = document.getElementById('search-box').value.toLowerCase();
      if (query) {
        filteredMemos = filteredMemos.filter(memo => memo.text.toLowerCase().includes(query));
      }
      
      // 新着順または古い順のソートを適用
      const sortOrder = document.getElementById('sort-order').value;
      filteredMemos.sort((a, b) => {
        if (sortOrder === 'newest') {
          return new Date(b.timestamp) - new Date(a.timestamp);
        } else {
          return new Date(a.timestamp) - new Date(b.timestamp);
        }
      });
      
      // 各メモをレンダリング
      filteredMemos.forEach(memo => {
        const memoDiv = document.createElement('div');
        memoDiv.className = 'memo';
        
        // タイムスタンプ
        const timeP = document.createElement('p');
        timeP.innerHTML = `<strong>${new Date(memo.timestamp).toLocaleString()}</strong>`;
        memoDiv.appendChild(timeP);
        
        // メモテキスト（改行を維持するため <pre> を使用）
        const textPre = document.createElement('pre');
        textPre.textContent = memo.text;
        memoDiv.appendChild(textPre);
        
        // 添付された画像があれば表示
        if (memo.image) {
          const imgElem = document.createElement('img');
          imgElem.src = memo.image;
          memoDiv.appendChild(imgElem);
        }
        
        // 編集と削除ボタン
        const btnDiv = document.createElement('div');
        btnDiv.className = 'memo-buttons';
        
        const editBtn = document.createElement('button');
        editBtn.textContent = '修正';
        editBtn.addEventListener('click', () => {
          const newText = prompt('メモを編集:', memo.text);
          if (newText !== null) {
            memo.text = newText;
            memo.timestamp = new Date().toISOString();
            saveMemosToStorage();
            updateMemoList();
          }
        });
        
        const deleteBtn = document.createElement('button');
        deleteBtn.textContent = '削除';
        deleteBtn.addEventListener('click', () => {
          if (confirm('本当にこのメモを削除してもよろしいですか？')) {
            memos = memos.filter(m => m.id !== memo.id);
            saveMemosToStorage();
            updateMemoList();
          }
        });
        
        btnDiv.appendChild(editBtn);
        btnDiv.appendChild(deleteBtn);
        memoDiv.appendChild(btnDiv);
        
        memoListDiv.appendChild(memoDiv);
      });
    }
    
    // テキストまたは画像／手書き等が存在する場合のみ新しくメモを追加する
    function addMemo() {
      const textArea = document.getElementById('memo-text');
      const text = textArea.value.trim();
      if (!text && !currentImageData) {
        alert("保存する前にテキストを入力するか、画像・手書き、または写真を添付してください。");
        return;
      }
      const memo = {
        id: Date.now(),
        timestamp: new Date().toISOString(),
        text: text,
        image: currentImageData
      };
      memos.push(memo);
      saveMemosToStorage();
      updateMemoList();
      
      // 次のメモのために入力をクリア
      textArea.value = '';
      currentImageData = null;
    }
    
    // ダブルクリック保存メカニズム（入力・ボタン以外の領域なら有効）
    document.addEventListener('dblclick', function(e) {
      const tag = e.target.tagName.toLowerCase();
      if (tag === 'input' || tag === 'textarea' || tag === 'button' || e.target.classList.contains('custom-button')) {
        return;
      }
      addMemo();
    });
    
    // ヒントテキストをクリックしても保存を実行
    document.getElementById('double-click-hint').addEventListener('click', addMemo);
    
    // FileReader API を使って画像ファイルの選択を処理
    document.getElementById('image-upload').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (file && file.type.startsWith('image/')) {
        const reader = new FileReader();
        reader.onload = function(event) {
          currentImageData = event.target.result;
        };
        reader.readAsDataURL(file);
      }
    });
    
    // Web Speech API を用いた音声入力機能（ビジュアルフィードバック付き）
    document.getElementById('voice-input').addEventListener('click', function() {
      if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
        alert('このブラウザは Web Speech API をサポートしていません');
        return;
      }
      const voiceStatus = document.getElementById('voice-status');
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      recognition = new SpeechRecognition();
      recognition.lang = 'ja-JP';
      recognition.interimResults = false;
      recognition.maxAlternatives = 1;
      voiceStatus.style.display = 'inline';
      recognition.start();
      
      recognition.onresult = function(event) {
        const transcript = event.results[0][0].transcript;
        document.getElementById('memo-text').value += transcript + "\n";
        voiceStatus.style.display = 'none';
      };
      recognition.onerror = function(event) {
        console.error('音声認識エラー:', event.error);
        voiceStatus.style.display = 'none';
      };
      recognition.onend = function() {
        voiceStatus.style.display = 'none';
      };
    });
    
    // カメラ撮影：写真撮影ボタンを押すとカメラプレビューを表示し、キャンセルも可能に
    document.getElementById('photo-capture').addEventListener('click', async function() {
      const video = document.getElementById('video-preview');
      const captureBtn = document.getElementById('capture-photo');
      const cancelBtn = document.getElementById('cancel-photo');
      
      // ビデオと各ボタンを表示
      video.style.display = 'block';
      captureBtn.style.display = 'inline-block';
      cancelBtn.style.display = 'inline-block';
      
      try {
        // リアカメラ（環境カメラ）優先、なければ通常のカメラ
        stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: { exact: "environment" } } });
      } catch (error) {
        try {
          stream = await navigator.mediaDevices.getUserMedia({ video: true });
        } catch (err) {
          alert('カメラにアクセスできませんでした: ' + err);
          return;
        }
      }
      video.srcObject = stream;
    });
    
    // ビデオストリームから現在のフレームをキャプチャし、画像として保存（canvas 経由）
    document.getElementById('capture-photo').addEventListener('click', function() {
      const video = document.getElementById('video-preview');
      const canvas = document.getElementById('capture-canvas');
      
      if (!canvas) return; // canvas は後で作成（以下で自動生成）
      
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
      currentImageData = canvas.toDataURL('image/png');
      
      // カメラを停止し、プレビュー・ボタンを非表示にする
      if (stream) {
        stream.getTracks().forEach(track => track.stop());
      }
      video.style.display = 'none';
      document.getElementById('capture-photo').style.display = 'none';
      document.getElementById('cancel-photo').style.display = 'none';
    });
    
    // キャンセルボタン：カメラ起動中に中断できるようにする
    document.getElementById('cancel-photo').addEventListener('click', function() {
      const video = document.getElementById('video-preview');
      if (stream) {
        stream.getTracks().forEach(track => track.stop());
      }
      video.style.display = 'none';
      document.getElementById('capture-photo').style.display = 'none';
      document.getElementById('cancel-photo').style.display = 'none';
    });
    
    // HTML内に存在しない場合は、非表示の canvas（写真用）を作成
    (function createPhotoCanvas() {
      let canvas = document.getElementById('capture-canvas');
      if (!canvas) {
        canvas = document.createElement('canvas');
        canvas.id = 'capture-canvas';
        canvas.style.display = 'none';
        document.body.appendChild(canvas);
      }
    })();
    
    // 手書きメモ機能：ボタン押下で手書き用のキャンバスを表示
    document.getElementById('handwrite-input').addEventListener('click', function() {
      document.getElementById('handwrite-section').style.display = 'block';
      // キャンバスの初期化（背景クリア）
      const canvas = document.getElementById('handwrite-canvas');
      const ctx = canvas.getContext('2d');
      ctx.clearRect(0, 0, canvas.width, canvas.height);
    });
    
    // 手書きキャンバス描画用の実装（マウス／タッチ両対応）
    (function() {
      const canvas = document.getElementById('handwrite-canvas');
      const ctx = canvas.getContext('2d');
      let drawing = false;
      let lastX = 0;
      let lastY = 0;
      
      // 描画開始
      function startDrawing(x, y) {
        drawing = true;
        [lastX, lastY] = [x, y];
      }
      // 描画移動
      function draw(x, y) {
        if (!drawing) return;
        ctx.beginPath();
        ctx.moveTo(lastX, lastY);
        ctx.lineTo(x, y);
        ctx.strokeStyle = '#000';
        ctx.lineWidth = 2;
        ctx.stroke();
        [lastX, lastY] = [x, y];
      }
      // 描画終了
      function endDrawing() {
        drawing = false;
      }
      
      // マウスイベント
      canvas.addEventListener('mousedown', (e) => {
        startDrawing(e.offsetX, e.offsetY);
      });
      canvas.addEventListener('mousemove', (e) => {
        draw(e.offsetX, e.offsetY);
      });
      canvas.addEventListener('mouseup', endDrawing);
      canvas.addEventListener('mouseleave', endDrawing);
      
      // タッチイベント（座標はキャンバスの境界を考慮）
      canvas.addEventListener('touchstart', (e) => {
        e.preventDefault();
        const rect = canvas.getBoundingClientRect();
        const touch = e.touches[0];
        startDrawing(touch.clientX - rect.left, touch.clientY - rect.top);
      });
      canvas.addEventListener('touchmove', (e) => {
        e.preventDefault();
        const rect = canvas.getBoundingClientRect();
        const touch = e.touches[0];
        draw(touch.clientX - rect.left, touch.clientY - rect.top);
      });
      canvas.addEventListener('touchend', (e) => {
        e.preventDefault();
        endDrawing();
      });
    })();
    
    // 手書きメモ：クリア／保存／キャンセルの各ボタン処理
    document.getElementById('clear-handwrite').addEventListener('click', function() {
      const canvas = document.getElementById('handwrite-canvas');
      const ctx = canvas.getContext('2d');
      ctx.clearRect(0, 0, canvas.width, canvas.height);
    });
    document.getElementById('save-handwrite').addEventListener('click', function() {
      const canvas = document.getElementById('handwrite-canvas');
      currentImageData = canvas.toDataURL('image/png');
      document.getElementById('handwrite-section').style.display = 'none';
    });
    document.getElementById('cancel-handwrite').addEventListener('click', function() {
      document.getElementById('handwrite-section').style.display = 'none';
    });
    
    // ソート順または検索クエリが変更されたときにメモリストを更新
    document.getElementById('sort-order').addEventListener('change', updateMemoList);
    document.getElementById('search-box').addEventListener('input', updateMemoList);
    
    // エクスポート：コメントタグ内に JSON データを埋め込んだ自己完結型 HTML ファイルを生成
    document.getElementById('export-memos').addEventListener('click', function() {
      const exportData = JSON.stringify(memos, null, 2);
      const content = `
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>エクスポートされたメモ</title>
</head>
<body>
<!-- MEMO_DATA_START
${exportData}
MEMO_DATA_END -->
<h1>エクスポートされたメモ</h1>
<p>このファイルにはエクスポートされたメモが含まれています。メモアプリのインポート機能を使用してデータを復元してください。</p>
</body>
</html>`;
      const blob = new Blob([content], { type: 'text/html' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = '高速メモ.html';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    });
    
    // インポート：エクスポートされたファイルからメモを復元
    document.getElementById('import-file').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(event) {
        const content = event.target.result;
        const regex = /<!-- MEMO_DATA_START([\s\S]*?)MEMO_DATA_END -->/;
        const match = content.match(regex);
        if (match && match[1]) {
          try {
            const importedMemos = JSON.parse(match[1]);
            if (Array.isArray(importedMemos)) {
              memos = importedMemos;
              saveMemosToStorage();
              updateMemoList();
              alert('メモのインポートに成功しました！');
            } else {
              alert('無効なメモデータ形式です。');
            }
          } catch (err) {
            alert('メモデータの解析エラー: ' + err);
          }
        } else {
          alert('ファイル内にメモデータが見つかりませんでした。');
        }
      };
      reader.readAsText(file);
    });
    
    // 印刷 / PDF: ブラウザの標準印刷ダイアログの起動
    document.getElementById('print-memos').addEventListener('click', function() {
      window.print();
    });
    
    // localStorage から全メモを削除する
    document.getElementById('delete-all').addEventListener('click', function() {
      if (confirm('本当に全てのメモを削除してもよろしいですか？')) {
        memos = [];
        saveMemosToStorage();
        updateMemoList();
      }
    });
    
    // ダークモード切替
    document.getElementById('toggle-dark-mode').addEventListener('click', function() {
      document.body.classList.toggle('dark-mode');
    });
    
    // 初期化: メモを読み込みリストに表示
    loadMemos();
    updateMemoList();
  </script>
</body>
</html>
