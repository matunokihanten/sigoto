<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>高速メモ v2.0</title>
  <style>
    /* 全体レイアウト */
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f0f0f0;
      color: #333;
    }
    /* 操作パネル（上部に配置） */
    #controlPanel {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      padding: 10px;
      background-color: #f9f9f9;
      border-bottom: 1px solid #ccc;
    }
    #controlPanel label,
    #controlPanel input,
    #controlPanel button,
    #controlPanel select {
      font-size: 14px;
    }
    /* メインエリア */
    #mainArea {
      padding: 10px;
    }
    /* 入力エリア */
    #memoInput {
      width: 100%;
      height: 150px;
      box-sizing: border-box;
      padding: 5px;
      font-size: 16px;
      margin-bottom: 5px;
      resize: vertical;
    }
    /* プレビュー画像 */
    #currentImagePreview {
      max-width: 100%;
      margin-bottom: 10px;
      display: none;
    }
    /* メモグリッド */
    #memoGrid {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 10px;
      min-height: 100px;
      border: 1px dashed #aaa;
      padding: 5px;
    }
    .memoCard {
      background-color: white;
      border: 1px solid #ccc;
      padding: 10px;
      font-size: 14px;
      word-break: break-all;
      position: relative;
      transition: box-shadow 0.2s;
    }
    .memoCard:hover {
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
    .memoCard img {
      max-width: 100%;
      display: block;
      margin-top: 10px;
    }
    .memoCard small {
      display: block;
      margin-top: 10px;
      color: #666;
    }
    .memoCard button {
      margin-top: 10px;
      margin-right: 5px;
      font-size: 12px;
      cursor: pointer;
    }
    .memo-content {
      cursor: pointer;
      min-height: 20px;
      padding: 2px;
      white-space: pre-wrap;
    }
    .highlight {
      background-color: yellow;
    }
    /* ダークモード */
    .dark-mode {
      background-color: #333;
      color: #fff;
    }
    .dark-mode #controlPanel {
      background-color: #555;
      border-color: #444;
    }
    .dark-mode .memoCard {
      background-color: #444;
      border-color: #666;
    }
    .dark-mode .memoCard small {
      color: #ccc;
    }
    .dark-mode .highlight {
      background-color: #6a6a00;
      color: #fff;
    }
    /* 印刷時：操作パネル、入力欄、プレビュー画像を非表示 */
    @media print {
      #controlPanel,
      #memoInput,
      #currentImagePreview {
        display: none;
      }
    }
  </style>
</head>
<body>
  <div id="controlPanel">
    <label for="columnSelector">表示列数:</label>
    <input type="number" id="columnSelector" min="1" max="100" value="5">
    <button id="uploadImageButton">画像選択</button>
    <input type="file" id="fileInput" accept="image/*" hidden>
    <button id="capturePhotoButton">写真撮影</button>
    <div id="cameraArea" style="display: none; flex-direction: column; align-items: center; gap: 10px;">
      <video id="videoPreview" autoplay playsinline style="width: 100%; max-width: 300px;"></video>
      <button id="captureBtn">キャプチャ</button>
    </div>
    <button id="importMemoButton">インポート</button>
    <input type="file" id="importFileInput" accept=".json" hidden>
    <button id="exportMemoButton">エクスポート</button>
    <button id="printMemoButton">印刷/PDF</button>
    <button id="darkModeToggleButton">ダークモード切替</button>
    <select id="sortSelector">
      <option value="new">新しい順</option>
      <option value="old">古い順</option>
    </select>
    <input type="text" id="searchInput" placeholder="検索...">
    <button id="deleteAllButton">全削除</button>
  </div>
  <div id="mainArea">
    <textarea id="memoInput" placeholder="メモを入力してください(保存は背景のダブルクリック)"></textarea>
    <img id="currentImagePreview" alt="添付画像">
    <div id="memoGrid"></div>
  </div>
  <script>
    let currentImage = null;
    let draggedMemo = null;

    /* -------------------- ユーティリティ関数 -------------------- */
    function generateUniqueId() {
      return "_" + Math.random().toString(36).substr(2, 9);
    }

    function escapeHtml(string) {
      return String(string).replace(/[&<>"']/g, function(s) {
        const entityMap = { "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#39;" };
        return entityMap[s];
      });
    }

    function escapeRegExp(string) {
      return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    }

    function highlightText(text, query) {
      if (!query) return escapeHtml(text);
      const regex = new RegExp('(' + escapeRegExp(query) + ')', 'gi');
      return escapeHtml(text).replace(regex, '<span class="highlight">$1</span>');
    }

    /* -------------------- 画像処理 -------------------- */
    function convertImageToGrayscale(image, callback) {
      // 非同期処理としてグレースケール変換を実行
      setTimeout(() => {
        const canvas = document.createElement("canvas");
        canvas.width = image.width;
        canvas.height = image.height;
        const ctx = canvas.getContext("2d");
        ctx.drawImage(image, 0, 0);
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const data = imageData.data;
        for (let i = 0; i < data.length; i += 4) {
          const gray = 0.299 * data[i] + 0.587 * data[i + 1] + 0.114 * data[i + 2];
          data[i] = data[i + 1] = data[i + 2] = gray;
        }
        ctx.putImageData(imageData, 0, 0);
        callback(canvas.toDataURL());
      }, 0);
    }

    /* -------------------- メモ管理 -------------------- */
    function saveMemo() {
      const memoText = document.getElementById("memoInput").value.trim();
      if (memoText === "" && !currentImage) {
        alert("メモ内容または画像を添付してください。");
        return;
      }
      const memos = JSON.parse(localStorage.getItem("memos")) || [];
      const newMemo = {
        id: generateUniqueId(),
        content: memoText,
        image: currentImage,
        timestamp: new Date().toISOString()
      };
      memos.push(newMemo);
      localStorage.setItem("memos", JSON.stringify(memos));
      clearInputArea();
      displayMemos();
    }

    function deleteMemo(id) {
      let memos = JSON.parse(localStorage.getItem("memos")) || [];
      memos = memos.filter(memo => memo.id !== id);
      localStorage.setItem("memos", JSON.stringify(memos));
      displayMemos();
    }

    function editMemo(id) {
      const memoCard = document.querySelector(`.memoCard[data-id="${id}"]`);
      if (!memoCard) return;

      const contentDiv = memoCard.querySelector('.memo-content');
      if (contentDiv.querySelector('textarea')) return;

      const currentContent = contentDiv.innerText;
      const currentImageElement = memoCard.querySelector('.memo-image');
      const buttonsContainer = document.createElement('div');
      buttonsContainer.style.marginTop = '10px';

      const textarea = document.createElement('textarea');
      textarea.value = currentContent;
      textarea.style.width = '100%';
      textarea.style.height = 'auto';
      textarea.style.minHeight = '50px';
      textarea.style.boxSizing = 'border-box';
      textarea.style.marginBottom = '10px';
      contentDiv.replaceWith(textarea);

      const addImageBtn = document.createElement('button');
      addImageBtn.innerText = currentImageElement ? '画像を更新' : '画像を追加';
      addImageBtn.style.fontSize = '12px';
      addImageBtn.onclick = () => {
        const imageInput = document.createElement('input');
        imageInput.type = 'file';
        imageInput.accept = 'image/*';
        imageInput.onchange = (e) => {
          const file = e.target.files[0];
          if (file) {
            const reader = new FileReader();
            reader.onload = (event) => {
              const img = new Image();
              img.onload = () => {
                convertImageToGrayscale(img, (newImageSrc) => {
                  if (currentImageElement) {
                    currentImageElement.src = newImageSrc;
                  } else {
                    const newImgElem = document.createElement('img');
                    newImgElem.className = 'memo-image';
                    newImgElem.src = newImageSrc;
                    textarea.after(newImgElem);
                  }
                  memoCard.dataset.newImage = newImageSrc;
                  addImageBtn.innerText = '画像を更新';
                });
              };
              img.src = event.target.result;
            };
            reader.readAsDataURL(file);
          }
        };
        imageInput.click();
      };
      buttonsContainer.appendChild(addImageBtn);

      if (currentImageElement) {
        const removeImageBtn = document.createElement('button');
        removeImageBtn.innerText = '画像を削除';
        removeImageBtn.style.fontSize = '12px';
        removeImageBtn.onclick = () => {
          if (confirm('この画像を削除しますか？')) {
            currentImageElement.remove();
            memoCard.dataset.newImage = 'REMOVE';
            addImageBtn.innerText = '画像を追加';
            removeImageBtn.remove();
          }
        };
        buttonsContainer.appendChild(removeImageBtn);
      }

      const saveButton = document.createElement('button');
      saveButton.innerText = '保存';
      saveButton.style.fontSize = '12px';
      saveButton.onclick = () => {
        let memos = JSON.parse(localStorage.getItem("memos")) || [];
        const index = memos.findIndex(memo => memo.id === id);
        if (index !== -1) {
          memos[index].content = textarea.value;
          if (memoCard.dataset.newImage) {
            memos[index].image = memoCard.dataset.newImage === 'REMOVE' ? null : memoCard.dataset.newImage;
          }
          localStorage.setItem("memos", JSON.stringify(memos));
          displayMemos();
        }
      };

      const cancelButton = document.createElement('button');
      cancelButton.innerText = 'キャンセル';
      cancelButton.style.fontSize = '12px';
      cancelButton.onclick = () => {
        displayMemos();
      };

      buttonsContainer.appendChild(saveButton);
      buttonsContainer.appendChild(cancelButton);

      memoCard.appendChild(buttonsContainer);
      memoCard.querySelector('button[onclick^="editMemo"]').style.display = 'none';
      memoCard.querySelector('button[onclick^="deleteMemo"]').style.display = 'none';
    }

    function createMemoCard(memo, query) {
      const card = document.createElement("div");
      card.className = "memoCard";
      card.setAttribute("draggable", "true");
      card.setAttribute("data-id", memo.id);
      
      const contentDiv = document.createElement('div');
      contentDiv.className = 'memo-content';
      contentDiv.innerHTML = highlightText(memo.content, query);
      contentDiv.addEventListener('click', () => editMemo(memo.id));
      card.appendChild(contentDiv);

      if (memo.image) {
        const img = document.createElement('img');
        img.className = 'memo-image';
        img.src = memo.image;
        img.alt = '添付画像';
        card.appendChild(img);
      }

      const small = document.createElement('small');
      small.innerText = new Date(memo.timestamp).toLocaleString();
      card.appendChild(small);

      const editBtn = document.createElement('button');
      editBtn.innerText = '編集';
      editBtn.onclick = () => editMemo(memo.id);
      card.appendChild(editBtn);

      const deleteBtn = document.createElement('button');
      deleteBtn.innerText = '削除';
      deleteBtn.onclick = () => deleteMemo(memo.id);
      card.appendChild(deleteBtn);

      return card;
    }

    function displayMemos() {
      let memos = JSON.parse(localStorage.getItem("memos")) || [];
      const query = document.getElementById("searchInput").value.trim();
      if (query) {
        const regex = new RegExp(escapeRegExp(query), "gi");
        memos = memos.filter(memo => memo.content.match(regex));
      }
      const sortOrder = document.getElementById("sortSelector").value;
      memos.sort((a, b) =>
        sortOrder === "new" ? new Date(b.timestamp) - new Date(a.timestamp) : new Date(a.timestamp) - new Date(b.timestamp)
      );

      const memoGrid = document.getElementById("memoGrid");
      memoGrid.innerHTML = "";
      memos.forEach(memo => {
        const card = createMemoCard(memo, query);
        memoGrid.appendChild(card);
      });
    }
    
    function clearInputArea() {
      document.getElementById("memoInput").value = "";
      currentImage = null;
      const preview = document.getElementById("currentImagePreview");
      preview.src = "";
      preview.style.display = "none";
    }

    /* -------------------- イベントリスナー設定 -------------------- */

    // メモ保存
    document.addEventListener("dblclick", function(e) {
      if (e.target.closest("#controlPanel") || e.target.closest("#mainArea textarea") || e.target.closest(".memoCard")) {
        return;
      }
      saveMemo();
    });

    // 画像アップロード
    document.getElementById("uploadImageButton").addEventListener("click", () => document.getElementById("fileInput").click());
    document.getElementById("fileInput").addEventListener("change", function(e) {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = (event) => {
          const img = new Image();
          img.onload = () => {
            convertImageToGrayscale(img, (dataUrl) => {
              currentImage = dataUrl;
              const preview = document.getElementById("currentImagePreview");
              preview.src = currentImage;
              preview.style.display = "block";
            });
          };
          img.src = event.target.result;
        };
        reader.readAsDataURL(file);
      }
    });

    // 写真撮影
    document.getElementById("capturePhotoButton").addEventListener("click", () => {
      const cameraArea = document.getElementById("cameraArea");
      cameraArea.style.display = "flex";
      navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
        .then(stream => {
          const video = document.getElementById("videoPreview");
          video.srcObject = stream;
          video.play();
          window.currentStream = stream;
        })
        .catch(err => {
          alert("カメラにアクセスできませんでした: " + err.message);
          cameraArea.style.display = "none";
        });
    });
    document.getElementById("captureBtn").addEventListener("click", () => {
      const video = document.getElementById("videoPreview");
      const canvas = document.createElement("canvas");
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      const ctx = canvas.getContext("2d");
      ctx.drawImage(video, 0, 0);
      const img = new Image();
      img.onload = () => {
        convertImageToGrayscale(img, (dataUrl) => {
          currentImage = dataUrl;
          const preview = document.getElementById("currentImagePreview");
          preview.src = currentImage;
          preview.style.display = "block";
          if (window.currentStream) {
            window.currentStream.getTracks().forEach(track => track.stop());
          }
          document.getElementById("cameraArea").style.display = "none";
        });
      };
      img.src = canvas.toDataURL();
    });

    // インポート／エクスポート
    document.getElementById("exportMemoButton").addEventListener("click", () => {
      const memosData = localStorage.getItem("memos") || "[]";
      const blob = new Blob([memosData], { type: "application/json" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = "高速メモ.json";
      link.click();
    });
    document.getElementById("importMemoButton").addEventListener("click", () => document.getElementById("importFileInput").click());
    document.getElementById("importFileInput").addEventListener("change", function(e) {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = (event) => {
          const content = event.target.result;
          try {
            const parsedMemos = JSON.parse(content);
            if (Array.isArray(parsedMemos)) {
              localStorage.setItem("memos", JSON.stringify(parsedMemos));
              displayMemos();
              alert("メモが正常にインポートされました。");
            } else {
              alert("インポートされたファイルの内容が不正です。JSON配列ではありません。");
            }
          } catch (error) {
            alert("ファイルの読み込みまたは解析中にエラーが発生しました: " + error.message);
          }
        };
        reader.readAsText(file);
      }
    });

    // 印刷
    document.getElementById("printMemoButton").addEventListener("click", () => window.print());

    // ダークモード切替
    document.getElementById("darkModeToggleButton").addEventListener("click", () => document.body.classList.toggle("dark-mode"));

    // ソート／検索
    document.getElementById("sortSelector").addEventListener("change", displayMemos);
    document.getElementById("searchInput").addEventListener("input", displayMemos);

    // 全削除
    document.getElementById("deleteAllButton").addEventListener("click", () => {
      if (confirm("すべてのメモを削除してもよろしいですか？")) {
        localStorage.removeItem("memos");
        displayMemos();
      }
    });

    // 列数選択
    document.getElementById("columnSelector").addEventListener("change", function () {
      const columnCount = parseInt(this.value, 10);
      document.getElementById("memoGrid").style.gridTemplateColumns =
        `repeat(${Math.min(Math.max(columnCount, 1), 100)}, 1fr)`;
    });
    
    // ドラッグ＆ドロップによる並べ替え
    const memoGrid = document.getElementById("memoGrid");
    memoGrid.addEventListener("dragstart", (e) => {
      if (e.target.classList.contains("memoCard")) {
        draggedMemo = e.target;
        e.dataTransfer.effectAllowed = "move";
        e.target.style.opacity = '0.4';
      }
    });
    memoGrid.addEventListener("dragover", (e) => {
      e.preventDefault();
      const target = e.target.closest(".memoCard");
      if (target && target !== draggedMemo) {
        const rect = target.getBoundingClientRect();
        const next = (e.clientY - rect.top) / rect.height > 0.5;
        memoGrid.insertBefore(draggedMemo, next && target.nextSibling || target);
      }
    });
    memoGrid.addEventListener("dragend", (e) => {
      e.target.style.opacity = '1';
      const memos = [];
      memoGrid.querySelectorAll(".memoCard").forEach(card => {
        const id = card.getAttribute("data-id");
        const memo = JSON.parse(localStorage.getItem("memos")).find(m => m.id === id);
        if (memo) memos.push(memo);
      });
      localStorage.setItem("memos", JSON.stringify(memos));
      draggedMemo = null;
    });

    // 初期表示
    displayMemos();
  </script>
</body>
</html>
