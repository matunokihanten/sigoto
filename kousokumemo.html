<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>メモアプリ</title>
  <!-- OCR用 Tesseract.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.0.2/dist/tesseract.min.js"></script>
  <style>
    /* 基本レイアウト */
    body {
      font-family: Arial, sans-serif;
      background-color: #f4f4f4;
      margin: 0;
      padding: 20px;
    }
    .container {
      max-width: 800px;
      margin: auto;
      background: #ffffff;
      padding: 20px;
      border-radius: 5px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    h1 { margin-top: 0; }
    /* ヒントはタイトル直下 */
    #saveHint {
      margin-top: 10px;
      text-align: center;
      color: #555;
      cursor: pointer;
      font-size: 14px;
    }
    /* エクスポート/インポートボタンエリア（ヘッダー直下に配置） */
    .export-import {
      text-align: center;
      margin: 10px 0;
    }
    .export-import button {
      margin-right: 10px;
      padding: 5px 10px;
      cursor: pointer;
    }
    /* 各種操作ボタン群 */
    .controls {
      margin-bottom: 10px;
    }
    .controls button,
    .controls select {
      margin-right: 10px;
      padding: 5px 10px;
      cursor: pointer;
    }
    #searchInput {
      width: 100%;
      padding: 5px 10px;
      margin: 10px 0;
      box-sizing: border-box;
    }
    textarea {
      width: 100%;
      margin-bottom: 10px;
      box-sizing: border-box;
      padding: 8px;
      font-size: 14px;
    }
    h2 { margin-bottom: 5px; }
    ul { list-style: none; padding: 0; }
    li {
      border-bottom: 1px dashed #ccc;
      padding: 5px 0;
      margin-bottom: 5px;
    }
    li button {
      margin-left: 5px;
      padding: 3px 6px;
      cursor: pointer;
    }
    /* ダークモード */
    .dark-mode {
      background-color: #333;
      color: #f4f4f4;
    }
    .dark-mode .container {
      background-color: #444;
    }
    /* 手書き入力・写真撮影ポップアップ */
    #drawingContainer,
    #photoContainer {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #fff;
      border: 1px solid #ccc;
      padding: 10px;
      z-index: 1000;
    }
    .drawing-buttons,
    .photo-buttons {
      text-align: right;
      margin-top: 10px;
    }
    /* 写真撮影用動画 */
    #photoVideo {
      border: 1px solid #ccc;
    }
    /* スマホなど狭い画面用の調整 */
    @media (max-width: 600px) {
      #drawingContainer, #photoContainer {
        width: 90%;
        max-width: 500px;
      }
      #drawingCanvas, #photoVideo {
        width: 100%;
        height: auto;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>メモアプリ</h1>
    <div id="saveHint">ダブルクリックで保存</div>
    
    <!-- エクスポート／インポートエリア -->
    <div class="export-import">
      <button id="exportButton">エクスポート</button>
      <button id="importButton">インポート</button>
      <input type="file" id="importInput" accept=".html" style="display:none;">
    </div>
    
    <!-- 各種操作ボタン -->
    <div class="controls">
      <button id="darkModeToggle">ダークモード</button>
      <button id="voiceInputButton">音声入力</button>
      <button id="startDrawingButton">手書き入力</button>
      <button id="takePhotoButton">写真撮影</button>
      <select id="sortOptions">
        <option value="desc">新しい順</option>
        <option value="asc">古い順</option>
      </select>
      <button id="printButton">印刷 / PDF</button>
    </div>
    
    <!-- 検索欄 -->
    <input type="text" id="searchInput" placeholder="検索...">
    
    <!-- テキスト入力欄 -->
    <textarea id="memoInput" placeholder="メモを入力してください..." rows="4"></textarea>
    
    <!-- 保存されたメモ一覧 -->
    <h2>保存されたメモ</h2>
    <ul id="memoList"></ul>
    
    <!-- 手書き入力用ポップアップ -->
    <div id="drawingContainer">
      <h3>手書き入力</h3>
      <canvas id="drawingCanvas" width="500" height="300" style="border:1px solid #ccc;"></canvas>
      <div class="drawing-buttons">
        <button id="saveDrawingButton">保存</button>
        <button id="cancelDrawingButton">キャンセル</button>
      </div>
    </div>
    
    <!-- 写真撮影用ポップアップ -->
    <div id="photoContainer">
      <h3>写真撮影</h3>
      <video id="photoVideo" autoplay playsinline width="500" height="300"></video>
      <div class="photo-buttons">
        <button id="capturePhotoButton">キャプチャ</button>
        <button id="cancelPhotoButton">キャンセル</button>
      </div>
    </div>
  </div>
  
  <script>
    /* 各メモは { timestamp, createdAt, text, imageData, drawingData } の形式 */
    let memos = [];
    let currentDrawingData = null;
    let currentPhotoData = null;
    
    // 起動時に localStorage から復元
    if(localStorage.getItem('memos')){
      try {
        memos = JSON.parse(localStorage.getItem('memos'));
      } catch(e){
        console.error(e);
      }
    }
    
    // localStorage へ保存
    function saveMemos(){
      localStorage.setItem('memos', JSON.stringify(memos));
    }
    
    // メモ一覧の描画
    function renderMemos(){
      const memoList = document.getElementById('memoList');
      memoList.innerHTML = "";
      const sortOrder = document.getElementById('sortOptions').value;
      const searchQuery = document.getElementById('searchInput').value.toLowerCase();
      
      let sortedMemos = memos.slice().sort((a, b) => 
        sortOrder === 'asc' ? a.createdAt - b.createdAt : b.createdAt - a.createdAt
      );
      if(searchQuery){
        sortedMemos = sortedMemos.filter(memo => 
          memo.text && memo.text.toLowerCase().includes(searchQuery)
        );
      }
      sortedMemos.forEach(memo => {
        const li = document.createElement('li');
        // 日時表示
        const dateSpan = document.createElement('span');
        dateSpan.textContent = `[${memo.timestamp}] `;
        li.appendChild(dateSpan);
        // テキスト表示
        const textSpan = document.createElement('span');
        textSpan.textContent = memo.text || "";
        li.appendChild(textSpan);
        // 画像表示（写真撮影で取得したもの）
        if(memo.imageData){
          const img = document.createElement('img');
          img.src = memo.imageData;
          img.alt = "写真";
          img.style.maxWidth = "100px";
          img.style.marginLeft = "10px";
          li.appendChild(img);
        }
        // 手書き入力画像表示
        if(memo.drawingData){
          const img2 = document.createElement('img');
          img2.src = memo.drawingData;
          img2.alt = "手書きメモ";
          img2.style.maxWidth = "100px";
          img2.style.marginLeft = "10px";
          li.appendChild(img2);
        }
        // 編集ボタン（修正時に写真も追加できる）
        const editBtn = document.createElement('button');
        editBtn.textContent = "修正";
        editBtn.addEventListener('click', function(e){
          e.stopPropagation();
          const newText = prompt("メモの修正（テキスト）", memo.text);
          if(newText !== null){
            let newPhotoData = memo.imageData; // デフォルトは既存の写真
            if(confirm("写真も修正・追加しますか？")){
              // 動的なファイル入力を生成して、写真の更新を行う
              let fileInput = document.createElement('input');
              fileInput.type = 'file';
              fileInput.accept = 'image/*';
              fileInput.onchange = function(event){
                const file = event.target.files[0];
                if(file){
                  const reader = new FileReader();
                  reader.onload = function(ev){
                    newPhotoData = ev.target.result;
                    memo.text = newText;
                    memo.imageData = newPhotoData;
                    saveMemos();
                    renderMemos();
                  };
                  reader.readAsDataURL(file);
                } else {
                  memo.text = newText;
                  saveMemos();
                  renderMemos();
                }
              };
              fileInput.click();
            } else {
              memo.text = newText;
              saveMemos();
              renderMemos();
            }
          }
        });
        li.appendChild(editBtn);
        // 削除ボタン（確認なし）
        const delBtn = document.createElement('button');
        delBtn.textContent = "削除";
        delBtn.addEventListener('click', function(e){
          e.stopPropagation();
          const idx = memos.indexOf(memo);
          if(idx !== -1){
            memos.splice(idx, 1);
            saveMemos();
            renderMemos();
          }
        });
        li.appendChild(delBtn);
        memoList.appendChild(li);
      });
    }
    
    // ダブルクリック／ダブルタップで保存（入力欄以外の場合）
    let tapCount = 0;
    function handleDoubleTap(e){
      const ignoreTags = ['INPUT','TEXTAREA','BUTTON','LABEL'];
      if(ignoreTags.includes(e.target.tagName)) return;
      tapCount++;
      setTimeout(() => {
        if(tapCount >= 2){
          saveMemo();
        }
        tapCount = 0;
      },300);
    }
    if('ontouchstart' in window || navigator.maxTouchPoints > 0){
      document.body.addEventListener('touchend', handleDoubleTap);
      document.getElementById('saveHint').addEventListener('touchend', saveMemo);
    } else {
      document.body.addEventListener('click', handleDoubleTap);
      document.getElementById('saveHint').addEventListener('click', saveMemo);
    }
    
    // 保存処理：もし写真がある場合はOCRで手書き日時抽出を試みる
    function saveMemo(){
      const memoInput = document.getElementById('memoInput');
      const memoText = memoInput.value.trim();
      if(memoText === "" && !currentDrawingData && !currentPhotoData){
        alert("メモ、手書き、または写真のいずれかを入力してください。");
        return;
      }
      const now = new Date();
      let newMemo = {
        // 仮の日時。後でOCRで上書き可能
        timestamp: now.toLocaleString(),
        createdAt: now.getTime(),
        text: memoText,
        imageData: currentPhotoData || null,
        drawingData: currentDrawingData || null
      };
      if(newMemo.imageData){
        // 写真撮影の場合はOCRで日時抽出（日本語モード・ホワイトリスト設定）
        Tesseract.recognize(newMemo.imageData, 'jpn', {
          logger: m => console.log(m),
          tessedit_char_whitelist: "0123456789年月日／-: "
        }).then(result => {
          const text = result.data.text;
          const regex = /(\d{4}[\/\-]\d{1,2}[\/\-]\d{1,2})/;
          const match = text.match(regex);
          if(match && match[0]){
            newMemo.timestamp = match[0];
          }
          memos.push(newMemo);
          saveMemos();
          renderMemos();
          memoInput.value = "";
          currentDrawingData = null;
          currentPhotoData = null;
        }).catch(err => {
          console.error("OCRエラー:", err);
          memos.push(newMemo);
          saveMemos();
          renderMemos();
          memoInput.value = "";
          currentDrawingData = null;
          currentPhotoData = null;
        });
      } else {
        memos.push(newMemo);
        saveMemos();
        renderMemos();
        memoInput.value = "";
        currentDrawingData = null;
      }
    }
    
    // 音声入力（Web Speech API）
    document.getElementById('voiceInputButton').addEventListener('click', function(){
      const memoInput = document.getElementById('memoInput');
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      if(!SpeechRecognition){
        alert("音声入力はこのブラウザではサポートされていません。");
        return;
      }
      const recognition = new SpeechRecognition();
      recognition.lang = "ja-JP";
      recognition.interimResults = false;
      recognition.maxAlternatives = 1;
      recognition.start();
      recognition.onresult = function(event){
        const transcript = event.results[0][0].transcript;
        memoInput.value += transcript;
      };
      recognition.onerror = function(event){
        alert("音声認識エラー: " + event.error);
      };
    });
    
    // ダークモード切替
    document.getElementById('darkModeToggle').addEventListener('click', function(){
      document.body.classList.toggle('dark-mode');
      this.textContent = document.body.classList.contains('dark-mode') ? "ライトモード" : "ダークモード";
    });
    
    document.getElementById('sortOptions').addEventListener('change', renderMemos);
    document.getElementById('searchInput').addEventListener('input', renderMemos);
    
    // 印刷 / PDF 出力
    document.getElementById('printButton').addEventListener('click', function(){
      window.print();
    });
    
    // エクスポート機能
    document.getElementById('exportButton').addEventListener('click', function(){
      const jsonData = JSON.stringify(memos, null, 4);
      const exportContent = `<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <title>Exported Memos</title>
</head>
<body>
<!-- MEMO_DATA_START -->
${jsonData}
<!-- MEMO_DATA_END -->
<h1>Exported Memos</h1>
<pre>${jsonData}</pre>
</body>
</html>`;
      const blob = new Blob([exportContent], { type: 'text/html' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = "高速メモ.html";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    });
    
    // インポート機能
    document.getElementById('importButton').addEventListener('click', function(){
      document.getElementById('importInput').click();
    });
    document.getElementById('importInput').addEventListener('change', function(e){
      const file = e.target.files[0];
      if(!file) return;
      const reader = new FileReader();
      reader.onload = function(e){
        const content = e.target.result;
        const regex = /<!--\s*MEMO_DATA_START\s*-->([\s\S]*?)<!--\s*MEMO_DATA_END\s*-->/;
        const match = regex.exec(content);
        if(match && match[1]){
          try {
            memos = JSON.parse(match[1]);
            saveMemos();
            renderMemos();
            alert("インポートに成功しました。");
          } catch(error){
            alert("ファイルの読み込みに失敗しました。");
          }
        } else {
          alert("有効なファイルではありません。");
        }
      };
      reader.readAsText(file);
      e.target.value = '';
    });
    
    // 手書き入力／ドローイング機能
    document.getElementById('startDrawingButton').addEventListener('click', function(){
      document.getElementById('drawingContainer').style.display = 'block';
      initDrawing();
    });
    document.getElementById('cancelDrawingButton').addEventListener('click', function(){
      hideDrawingContainer();
    });
    document.getElementById('saveDrawingButton').addEventListener('click', function(){
      const canvas = document.getElementById('drawingCanvas');
      currentDrawingData = canvas.toDataURL();
      // OCR: 手書き画像から文字認識（日本語モード、ホワイトリスト付き）
      Tesseract.recognize(currentDrawingData, 'jpn', {
        logger: m => console.log(m),
        tessedit_char_whitelist: "0123456789年月日／-: "
      }).then(result => {
        const recognizedText = result.data.text;
        const memoInput = document.getElementById('memoInput');
        // 既存のテキストに追記
        memoInput.value += recognizedText;
        hideDrawingContainer();
      }).catch(err => {
        console.error("手書きOCRエラー:", err);
        hideDrawingContainer();
      });
    });
    function hideDrawingContainer(){
      document.getElementById('drawingContainer').style.display = 'none';
      const canvas = document.getElementById('drawingCanvas');
      const ctx = canvas.getContext('2d');
      ctx.clearRect(0, 0, canvas.width, canvas.height);
    }
    function initDrawing(){
      const canvas = document.getElementById('drawingCanvas');
      const ctx = canvas.getContext('2d');
      let drawing = false;
      function startPosition(e){
        drawing = true;
        draw(e);
      }
      function finishedPosition(){
        drawing = false;
        ctx.beginPath();
      }
      function draw(e){
        if(!drawing) return;
        e.preventDefault();
        const rect = canvas.getBoundingClientRect();
        let x, y;
        if(e.touches && e.touches[0]){
          x = e.touches[0].clientX - rect.left;
          y = e.touches[0].clientY - rect.top;
        } else {
          x = e.clientX - rect.left;
          y = e.clientY - rect.top;
        }
        ctx.lineWidth = 2;
        ctx.lineCap = 'round';
        ctx.strokeStyle = '#000';
        ctx.lineTo(x, y);
        ctx.stroke();
        ctx.beginPath();
        ctx.moveTo(x, y);
      }
      canvas.addEventListener('mousedown', startPosition);
      canvas.addEventListener('mouseup', finishedPosition);
      canvas.addEventListener('mousemove', draw);
      canvas.addEventListener('touchstart', startPosition);
      canvas.addEventListener('touchend', finishedPosition);
      canvas.addEventListener('touchmove', draw);
    }
    
    // 写真撮影機能（後ろカメラ利用）
    document.getElementById('takePhotoButton').addEventListener('click', function(){
      const photoContainer = document.getElementById('photoContainer');
      photoContainer.style.display = 'block';
      const video = document.getElementById('photoVideo');
      navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
        .then(function(stream){
          video.srcObject = stream;
          video.play();
          window.currentPhotoStream = stream;
        })
        .catch(function(err){
          alert("カメラ利用が許可されていません: " + err);
        });
    });
    document.getElementById('cancelPhotoButton').addEventListener('click', function(){
      const video = document.getElementById('photoVideo');
      if(window.currentPhotoStream){
        window.currentPhotoStream.getTracks().forEach(track => track.stop());
        window.currentPhotoStream = null;
      }
      document.getElementById('photoContainer').style.display = 'none';
    });
    document.getElementById('capturePhotoButton').addEventListener('click', function(){
      const video = document.getElementById('photoVideo');
      const canvas = document.createElement('canvas');
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
      currentPhotoData = canvas.toDataURL();
      if(window.currentPhotoStream){
        window.currentPhotoStream.getTracks().forEach(track => track.stop());
        window.currentPhotoStream = null;
      }
      document.getElementById('photoContainer').style.display = 'none';
    });
    
    renderMemos();
  </script>
</body>
</html>
