<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>高速メモアプリ</title>
  <style>
    /* ----- Basic Styles ----- */
    body {
      font-family: sans-serif;
      margin: 10px;
      background-color: #fff;
      color: #000;
      transition: background-color 0.3s, color 0.3s;
    }
    body.dark-mode {
      background-color: #222;
      color: #fff;
    }
    h1 {
      text-align: center;
    }
    textarea {
      width: 100%;
      height: 100px;
      margin-bottom: 10px;
      font-size: 1em;
      padding: 5px;
      box-sizing: border-box;
    }
    button {
      padding: 5px 10px;
      font-size: 0.9em;
      cursor: pointer;
    }
    #controls, #imageSection {
      margin: 10px 0;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
    }
    #doubleClickHint {
      font-size: 0.9em;
      color: #555;
      margin: 5px 0;
      cursor: pointer;
    }
    /* ----- Image Preview ----- */
    #imagePreview img {
      max-width: 113px;
      max-height: 113px;
      border: 1px solid #ccc;
      margin-top: 5px;
    }
    /* ----- Grid Layout for Memos ----- */
    #memosContainer {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 10px;
      margin-top: 20px;
    }
    .memo {
      border: 1px solid #ccc;
      padding: 5px;
      border-radius: 5px;
      background-color: rgba(255, 255, 255, 0.9);
      word-wrap: break-word;
    }
    body.dark-mode .memo {
      background-color: #333;
      border-color: #555;
    }
    .memo .timestamp {
      font-size: 0.8em;
      color: gray;
      margin-bottom: 5px;
    }
    .memo pre {
      white-space: pre-wrap;
      font-family: inherit;
      margin: 0 0 5px 0;
    }
    /* ----- Video Preview for Camera ----- */
    #videoPreview {
      display: none;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <h1>高速メモアプリ</h1>
  
  <!-- Input Section -->
  <section id="inputSection">
    <textarea id="memoInput" placeholder="メモを入力..."></textarea>
    
    <div id="imageSection">
      <!-- Image Preview -->
      <div id="imagePreview"></div>
      <!-- Image file selection -->
      <button id="selectImage">画像選択</button>
      <input type="file" id="imageInput" accept="image/*" style="display:none">
      <!-- Camera Capture -->
      <button id="capturePhoto">写真撮影</button>
    </div>
    
    <div>
      <!-- Voice Input -->
      <button id="voiceInput">音声入力</button>
    </div>
    <div id="doubleClickHint">ダブルクリックで保存</div>
  </section>
  
  <!-- Control Buttons & Options -->
  <section id="controls">
    <select id="sortMemos">
      <option value="newest">新しい順</option>
      <option value="oldest">古い順</option>
    </select>
    <input type="text" id="searchInput" placeholder="検索...">
    <button id="deleteAll">全削除</button>
    <button id="export">エクスポート</button>
    <button id="import">インポート</button>
    <input type="file" id="importFile" accept=".html" style="display:none">
    <button id="printBtn">印刷/PDF</button>
    <button id="darkMode">ダークモード</button>
  </section>
  
  <!-- Memos Display -->
  <section id="memosContainer"></section>
  
  <!-- Video element for camera preview -->
  <video id="videoPreview" autoplay style="max-width:300px;"></video>
  
  <script>
    /******** Global Variables ********/
    let memos = [];
    let videoStream = null; // For camera capture

    /******** LocalStorage Functions ********/
    function loadMemos() {
      const data = localStorage.getItem("memos");
      if (data) {
        try {
          memos = JSON.parse(data);
        } catch (e) {
          memos = [];
        }
      } else {
        memos = [];
      }
    }
    function saveMemos() {
      localStorage.setItem("memos", JSON.stringify(memos));
    }

    /******** Render Memos ********/
    function renderMemos() {
      const container = document.getElementById("memosContainer");
      const searchTerm = document.getElementById("searchInput").value.toLowerCase();
      let filtered = memos.filter(memo => memo.text.toLowerCase().includes(searchTerm));
      
      const sortValue = document.getElementById("sortMemos").value;
      if (sortValue === "newest") {
        filtered.sort((a, b) => b.timestamp - a.timestamp);
      } else {
        filtered.sort((a, b) => a.timestamp - b.timestamp);
      }
      
      container.innerHTML = "";
      filtered.forEach(memo => {
        const div = document.createElement("div");
        div.className = "memo";
        const timeString = new Date(memo.timestamp).toLocaleString();
        div.innerHTML = `
          <div class="timestamp">${timeString}</div>
          <pre class="memo-text">${memo.text}</pre>
        `;
        if (memo.image) {
          div.innerHTML += `<img src="${memo.image}" alt="memo image">`;
        }
        // Edit button
        const editBtn = document.createElement("button");
        editBtn.textContent = "修正";
        editBtn.addEventListener("click", () => {
          let updatedText = prompt("メモを修正してください:", memo.text);
          if (updatedText === null) return;
          if (updatedText.trim() === "") updatedText = "テスト";
          memo.text = updatedText;
          saveMemos();
          renderMemos();
        });
        // Delete button
        const deleteBtn = document.createElement("button");
        deleteBtn.textContent = "削除";
        deleteBtn.addEventListener("click", () => {
          if (confirm("このメモを削除しますか？")) {
            memos = memos.filter(m => m !== memo);
            saveMemos();
            renderMemos();
          }
        });
        div.appendChild(editBtn);
        div.appendChild(deleteBtn);
        container.appendChild(div);
      });
    }

    /******** Save Current Memo ********/
    function saveCurrentMemo() {
      const textarea = document.getElementById("memoInput");
      let text = textarea.value.trim();
      if (text === "") text = "テスト";
      
      // If an image was processed and previewed, grab its Data URL.
      const imagePreview = document.getElementById("imagePreview");
      let dataUrl = "";
      const imgElem = imagePreview.querySelector("img");
      if (imgElem) {
        dataUrl = imgElem.src;
        imagePreview.innerHTML = "";
      }
      
      const memo = {
        id: Date.now(),
        timestamp: Date.now(),
        text: text,
        image: dataUrl
      };
      memos.push(memo);
      saveMemos();
      renderMemos();
      textarea.value = "";
    }

    /******** Double-Click to Save ********/
    document.addEventListener("dblclick", function(e) {
      const tag = e.target.tagName.toLowerCase();
      // If not clicking on an interactive element, save the memo.
      if (!["button", "input", "textarea", "video", "select"].includes(tag)) {
        saveCurrentMemo();
      }
    });
    document.getElementById("doubleClickHint").addEventListener("click", saveCurrentMemo);

    /******** Voice Input ********/
    document.getElementById("voiceInput").addEventListener("click", function() {
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SpeechRecognition) {
        alert("このブラウザは音声認識に対応していません。");
        return;
      }
      const recognition = new SpeechRecognition();
      recognition.lang = "ja-JP";
      recognition.interimResults = false;
      recognition.maxAlternatives = 1;
      recognition.start();
      recognition.onresult = function(event) {
        const transcript = event.results[0][0].transcript;
        const textarea = document.getElementById("memoInput");
        textarea.value += (textarea.value ? "\n" : "") + transcript;
      };
      recognition.onerror = function(e) {
        console.error("Speech input error: " + e.error);
      };
    });

    /******** Image Upload Processing ********/
    document.getElementById("selectImage").addEventListener("click", () => {
      document.getElementById("imageInput").click();
    });
    document.getElementById("imageInput").addEventListener("change", function(e) {
      if (e.target.files && e.target.files[0]) {
        processImageFile(e.target.files[0], function(dataUrl) {
          const img = document.createElement("img");
          img.src = dataUrl;
          const preview = document.getElementById("imagePreview");
          preview.innerHTML = "";
          preview.appendChild(img);
        });
      }
    });
    function processImageFile(file, callback) {
      const reader = new FileReader();
      reader.onload = function(e) {
        const img = new Image();
        img.onload = function() {
          const maxDim = 113;
          const ratio = Math.min(1, maxDim / Math.max(img.width, img.height));
          const canvas = document.createElement("canvas");
          canvas.width = img.width * ratio;
          canvas.height = img.height * ratio;
          const ctx = canvas.getContext("2d");
          ctx.filter = "grayscale(100%)";
          ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
          const dataUrl = canvas.toDataURL("image/png");
          callback(dataUrl);
        };
        img.src = e.target.result;
      };
      reader.readAsDataURL(file);
    }

    /******** Camera Capture ********/
    const captureButton = document.getElementById("capturePhoto");
    const video = document.getElementById("videoPreview");
    captureButton.addEventListener("click", function() {
      if (!videoStream) {
        // Start the rear camera (if available)
        navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
          .then(stream => {
            videoStream = stream;
            video.srcObject = stream;
            video.style.display = "block";
            captureButton.textContent = "画像を撮る";
          })
          .catch(err => {
            console.error("カメラの起動に失敗しました: ", err);
          });
      } else {
        // Capture the current video frame
        const canvas = document.createElement("canvas");
        const maxDim = 113;
        const width = video.videoWidth;
        const height = video.videoHeight;
        const ratio = Math.min(1, maxDim / Math.max(width, height));
        canvas.width = width * ratio;
        canvas.height = height * ratio;
        const ctx = canvas.getContext("2d");
        ctx.filter = "grayscale(100%)";
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        const dataUrl = canvas.toDataURL("image/png");
        const preview = document.getElementById("imagePreview");
        preview.innerHTML = "";
        const img = document.createElement("img");
        img.src = dataUrl;
        preview.appendChild(img);
        // Stop camera stream
        videoStream.getTracks().forEach(track => track.stop());
        videoStream = null;
        video.style.display = "none";
        captureButton.textContent = "写真撮影";
      }
    });

    /******** Delete All Memos ********/
    document.getElementById("deleteAll").addEventListener("click", function() {
      if (confirm("すべてのメモを削除してもよろしいですか？")) {
        memos = [];
        saveMemos();
        renderMemos();
      }
    });

    /******** Export Memos ********/
    document.getElementById("export").addEventListener("click", function() {
      const jsonData = JSON.stringify(memos);
      const content = `
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>高速メモエクスポート</title>
</head>
<body>
  <!-- HIGH_SPEED_MEMO_DATA_START
  ${jsonData}
  HIGH_SPEED_MEMO_DATA_END -->
  <p>このファイルは高速メモのエクスポートデータを含んでいます。</p>
</body>
</html>`;
      const blob = new Blob([content], { type: 'text/html' });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "高速メモ.html";
      a.click();
    });

    /******** Import Memos ********/
    document.getElementById("import").addEventListener("click", function() {
      document.getElementById("importFile").click();
    });
    document.getElementById("importFile").addEventListener("change", function(e) {
      if (e.target.files && e.target.files[0]) {
        const file = e.target.files[0];
        const reader = new FileReader();
        reader.onload = function(ev) {
          const content = ev.target.result;
          const regex = /<!--\s*HIGH_SPEED_MEMO_DATA_START\s*([\s\S]*?)\s*HIGH_SPEED_MEMO_DATA_END\s*-->/;
          const match = regex.exec(content);
          if (match && match[1]) {
            try {
              const imported = JSON.parse(match[1]);
              memos = imported;
              saveMemos();
              renderMemos();
              alert("インポートに成功しました！");
            } catch (err) {
              alert("データの読み込みに失敗しました。");
            }
          } else {
            alert("有効なインポートファイルではありません。");
          }
        };
        reader.readAsText(file);
      }
    });

    /******** Print / PDF ********/
    document.getElementById("printBtn").addEventListener("click", function() {
      window.print();
    });

    /******** Dark Mode Toggle ********/
    document.getElementById("darkMode").addEventListener("click", function() {
      document.body.classList.toggle("dark-mode");
    });

    /******** Search and Sort Listeners ********/
    document.getElementById("searchInput").addEventListener("input", renderMemos);
    document.getElementById("sortMemos").addEventListener("change", renderMemos);

    /******** Initialize ********/
    document.addEventListener("DOMContentLoaded", () => {
      loadMemos();
      renderMemos();
    });
  </script>
</body>
</html>
