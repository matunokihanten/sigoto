<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <!-- スマホ向けにズームなどを制限 -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>メモアプリ</title>
  <style>
    /* 基本のスタイル */
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      margin: 0;
      background-color: #f0f0f0;
      color: #333;
    }
    /* ダークモードのスタイル */
    .dark-mode {
      background-color: #333;
      color: #eee;
    }
    textarea {
      width: 100%;
      height: 150px;
      padding: 10px;
      font-size: 16px;
      margin-bottom: 10px;
      box-sizing: border-box;
    }
    .custom-button {
      padding: 10px 15px;
      background-color: #007BFF;
      color: white;
      border: none;
      margin-right: 5px;
      margin-top: 5px;
      cursor: pointer;
      display: inline-block;
    }
    .custom-button:hover {
      background-color: #0056b3;
    }
    /* スマホ向けにタップしやすいサイズ調整 */
    @media (max-width: 600px) {
      .custom-button {
        padding: 12px 16px;
        font-size: 18px;
      }
      textarea {
        height: 100px;
      }
    }
    #memo-list {
      margin-top: 20px;
    }
    .memo {
      border: 1px solid #ddd;
      padding: 10px;
      margin-bottom: 10px;
      background: white;
    }
    .memo img {
      max-width: 100%;
      height: auto;
      display: block;
      margin-top: 10px;
    }
    .memo-buttons {
      margin-top: 10px;
    }
    button {
      padding: 6px 10px;
      margin-right: 5px;
      cursor: pointer;
    }
    /* カメラ／写真撮影用（PC向けのみ） */
    #camera-section {
      margin-top: 10px;
    }
    #video-preview {
      max-width: 100%;
      border: 1px solid #ddd;
      margin-bottom: 10px;
      cursor: pointer;
    }
    /* 手書きメモ用キャンバス */
    #handwrite-canvas {
      border: 1px solid #ccc;
      touch-action: none;
    }
    /* その他 */
    #video-hint {
      font-size: 14px;
      color: #555;
    }
  </style>
</head>
<body>
  <h1>メモアプリ</h1>
  
  <!-- メモ入力セクション -->
  <textarea id="memo-text" placeholder="メモを入力してください..."></textarea>
  <div>
    <label for="image-upload" class="custom-button">画像選択</label>
    <input type="file" id="image-upload" accept="image/*" style="display:none">
    <!-- 写真撮影ボタン（PC向けのみ表示） -->
    <button id="photo-capture" class="custom-button">写真撮影</button>
    <button id="voice-input" class="custom-button">音声入力</button>
    <!-- 音声入力中のフィードバック -->
    <span id="voice-status" style="display:none; margin-left:10px;">音声入力中…</span>
    <button id="handwrite-input" class="custom-button">手書きメモ</button>
    <button id="toggle-dark-mode" class="custom-button">ダークモード切替</button>
  </div>
  
  <!-- カメラプレビューセクション（PC向けのみ） -->
  <div id="camera-section">
    <video id="video-preview" autoplay playsinline style="display:none;"></video>
    <br>
    <button id="capture-photo" class="custom-button" style="display:none;">写真を撮る</button>
    <button id="cancel-photo" class="custom-button" style="display:none;">キャンセル</button>
    <p id="video-hint" style="display:none;">※プレビュー画面をタップしても撮影できます</p>
  </div>
  
  <!-- 手書きメモセクション -->
  <div id="handwrite-section" style="display:none; margin-top:10px;">
    <canvas id="handwrite-canvas" width="300" height="200"></canvas>
    <div style="margin-top:5px;">
      <button id="clear-handwrite" class="custom-button">クリア</button>
      <button id="save-handwrite" class="custom-button">手書きメモ保存</button>
      <button id="cancel-handwrite" class="custom-button">キャンセル</button>
    </div>
  </div>
  
  <!-- ソート、検索、エクスポート／インポート、印刷／PDF、全削除 -->
  <div style="margin-top: 10px;">
    <select id="sort-order">
      <option value="newest">新着順</option>
      <option value="oldest">古い順</option>
    </select>
    <input type="text" id="search-box" placeholder="メモ検索...">
    <button id="export-memos" class="custom-button">メモをエクスポート</button>
    <label for="import-file" class="custom-button">メモをインポート</label>
    <input type="file" id="import-file" accept=".html" style="display:none">
    <button id="print-memos" class="custom-button">印刷 / PDF</button>
    <button id="delete-all" class="custom-button">全削除</button>
  </div>
  
  <!-- ダブルクリック／ダブルタップ保存のヒント -->
  <p id="double-click-hint" style="cursor:pointer; text-decoration:underline;">
    どこでもダブルクリック（またはダブルタップ）するとメモが保存されます
  </p>
  
  <!-- メモリスト -->
  <div id="memo-list"></div>
  
  <script>
    // グローバル変数
    let memos = []; // メモオブジェクトを格納する配列
    let currentImageData = null; // 現在の画像のデータURL（画像・手書き・PCでの写真撮影）
    let recognition = null; // 音声認識インスタンス
    let stream = null; // カメラ用の MediaStream

    // スマホかどうかを判定する関数
    function isMobile() {
      return /Mobi|Android/i.test(navigator.userAgent);
    }

    // DOM読み込み後の初期処理
    document.addEventListener('DOMContentLoaded', function() {
      // スマホの場合はカメラ／写真撮影セクションを非表示
      if (isMobile()) {
        const cameraSection = document.getElementById('camera-section');
        if (cameraSection) {
          cameraSection.style.display = 'none';
        }
        // また、スマホ向けに「メモ保存」ボタンを追加
        const saveBtn = document.createElement('button');
        saveBtn.id = "save-memo";
        saveBtn.textContent = "メモ保存";
        saveBtn.className = "custom-button";
        saveBtn.style.marginTop = "10px";
        document.body.insertBefore(saveBtn, document.getElementById('memo-list'));
        saveBtn.addEventListener('click', addMemo);
      } else {
        // PCの場合はダブルクリック／ダブルタップによる保存イベントを登録
        document.addEventListener('dblclick', function(e) {
          const tag = e.target.tagName.toLowerCase();
          if (['input', 'textarea', 'button'].includes(tag) || e.target.classList.contains('custom-button')) {
            return;
          }
          addMemo();
        });
        let lastTap = 0;
        document.addEventListener('touchend', function(e) {
          const currentTime = new Date().getTime();
          if (currentTime - lastTap > 0 && currentTime - lastTap < 500) {
            const tag = e.target.tagName.toLowerCase();
            if (!['input', 'textarea', 'button'].includes(tag) && !e.target.classList.contains('custom-button')) {
              addMemo();
            }
          }
          lastTap = currentTime;
        });
      }
    });
    
    // localStorage からメモを読み込む
    function loadMemos() {
      const stored = localStorage.getItem('memos');
      if (stored) {
        try {
          memos = JSON.parse(stored);
        } catch(e) {
          console.error('メモ解析エラー:', e);
          memos = [];
        }
      }
    }
    
    // メモ配列を localStorage に保存
    function saveMemosToStorage() {
      localStorage.setItem('memos', JSON.stringify(memos));
    }
    
    // メモリストを更新（ソート・検索フィルター適用）
    function updateMemoList() {
      const memoListDiv = document.getElementById('memo-list');
      memoListDiv.innerHTML = '';
      let filteredMemos = memos;
      
      const query = document.getElementById('search-box').value.toLowerCase();
      if (query) {
        filteredMemos = filteredMemos.filter(memo => memo.text.toLowerCase().includes(query));
      }
      
      const sortOrder = document.getElementById('sort-order').value;
      filteredMemos.sort((a, b) => {
        if (sortOrder === 'newest') {
          return new Date(b.timestamp) - new Date(a.timestamp);
        } else {
          return new Date(a.timestamp) - new Date(b.timestamp);
        }
      });
      
      filteredMemos.forEach(memo => {
        const memoDiv = document.createElement('div');
        memoDiv.className = 'memo';
        
        const timeP = document.createElement('p');
        timeP.innerHTML = `<strong>${new Date(memo.timestamp).toLocaleString()}</strong>`;
        memoDiv.appendChild(timeP);
        
        const textPre = document.createElement('pre');
        textPre.textContent = memo.text;
        memoDiv.appendChild(textPre);
        
        if (memo.image) {
          const imgElem = document.createElement('img');
          imgElem.src = memo.image;
          memoDiv.appendChild(imgElem);
        }
        
        const btnDiv = document.createElement('div');
        btnDiv.className = 'memo-buttons';
        
        const editBtn = document.createElement('button');
        editBtn.textContent = '修正';
        editBtn.addEventListener('click', () => {
          const newText = prompt('メモを編集:', memo.text);
          if (newText !== null) {
            memo.text = newText;
            memo.timestamp = new Date().toISOString();
            saveMemosToStorage();
            updateMemoList();
          }
        });
        
        const deleteBtn = document.createElement('button');
        deleteBtn.textContent = '削除';
        deleteBtn.addEventListener('click', () => {
          if (confirm('本当にこのメモを削除しますか？')) {
            memos = memos.filter(m => m.id !== memo.id);
            saveMemosToStorage();
            updateMemoList();
          }
        });
        
        btnDiv.appendChild(editBtn);
        btnDiv.appendChild(deleteBtn);
        memoDiv.appendChild(btnDiv);
        
        memoListDiv.appendChild(memoDiv);
      });
    }
    
    // メモ追加（テキストまたは画像／手書きが存在する場合のみ）
    function addMemo() {
      const textArea = document.getElementById('memo-text');
      const text = textArea.value.trim();
      if (!text && !currentImageData) {
        alert("保存する前にテキストか画像・手書き、または写真を添付してください。");
        return;
      }
      const memo = {
        id: Date.now(),
        timestamp: new Date().toISOString(),
        text: text,
        image: currentImageData
      };
      memos.push(memo);
      saveMemosToStorage();
      updateMemoList();
      
      textArea.value = '';
      currentImageData = null;
    }
    
    // ----- 画像アップロード -----
    
    document.getElementById('image-upload').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (file && file.type.startsWith('image/')) {
        const reader = new FileReader();
        reader.onload = function(event) {
          currentImageData = event.target.result;
        };
        reader.readAsDataURL(file);
      }
    });
    
    // ----- 音声入力（ビジュアルフィードバック付き） -----
    
    document.getElementById('voice-input').addEventListener('click', function() {
      if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
        alert('このブラウザは Web Speech API をサポートしていません');
        return;
      }
      const voiceStatus = document.getElementById('voice-status');
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      recognition = new SpeechRecognition();
      recognition.lang = 'ja-JP';
      recognition.interimResults = false;
      recognition.maxAlternatives = 1;
      voiceStatus.style.display = 'inline';
      recognition.start();
      
      recognition.onresult = function(event) {
        const transcript = event.results[0][0].transcript;
        document.getElementById('memo-text').value += transcript + "\n";
        voiceStatus.style.display = 'none';
      };
      recognition.onerror = function(event) {
        console.error('音声認識エラー:', event.error);
        voiceStatus.style.display = 'none';
      };
      recognition.onend = function() {
        voiceStatus.style.display = 'none';
      };
    });
    
    // ----- カメラ／写真撮影機能（PC向けのみ） -----
    // スマホの場合は isMobile() により camera-section 自体が非表示になっているため、
    // ここでのコードはPC環境のみ有効です。
    
    // 共通の写真キャプチャ関数（サイズ縮小・JPEG保存）
    function capturePhotoFunction() {
      const video = document.getElementById('video-preview');
      const canvas = document.getElementById('capture-canvas');
      if (!canvas) return;
      
      const originalWidth = video.videoWidth, originalHeight = video.videoHeight;
      const maxWidth = 640;
      let newWidth = originalWidth, newHeight = originalHeight;
      if (originalWidth > maxWidth) {
        newWidth = maxWidth;
        newHeight = Math.floor(originalHeight * (maxWidth / originalWidth));
      }
      
      canvas.width = newWidth;
      canvas.height = newHeight;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(video, 0, 0, newWidth, newHeight);
      
      currentImageData = canvas.toDataURL('image/jpeg', 0.6);
      
      if (stream) {
        stream.getTracks().forEach(track => track.stop());
      }
      video.style.display = 'none';
      document.getElementById('capture-photo').style.display = 'none';
      document.getElementById('cancel-photo').style.display = 'none';
      document.getElementById('video-hint').style.display = 'none';
    }
    
    // 「写真撮影」ボタンの動作（PC向け）
    document.getElementById('photo-capture').addEventListener('click', async function() {
      const video = document.getElementById('video-preview');
      const captureBtn = document.getElementById('capture-photo');
      const cancelBtn = document.getElementById('cancel-photo');
      const videoHint = document.getElementById('video-hint');
      
      video.style.display = 'block';
      captureBtn.style.display = 'inline-block';
      cancelBtn.style.display = 'inline-block';
      videoHint.style.display = 'block';
      
      try {
        stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: { exact: "environment" } } });
      } catch (error) {
        try {
          stream = await navigator.mediaDevices.getUserMedia({ video: true });
        } catch (err) {
          alert('カメラにアクセスできませんでした: ' + err);
          return;
        }
      }
      video.srcObject = stream;
    });
    
    // 補助として「写真を撮る」ボタンの動作
    document.getElementById('capture-photo').addEventListener('click', capturePhotoFunction);
    
    // PC環境では、プレビュー画面（video）をクリックしても撮影可能
    document.getElementById('video-preview').addEventListener('click', function() {
      if (document.getElementById('video-preview').style.display !== 'none') {
        capturePhotoFunction();
      }
    });
    
    // キャンセルボタンの動作
    document.getElementById('cancel-photo').addEventListener('click', function() {
      const video = document.getElementById('video-preview');
      if (stream) {
        stream.getTracks().forEach(track => track.stop());
      }
      video.style.display = 'none';
      document.getElementById('capture-photo').style.display = 'none';
      document.getElementById('cancel-photo').style.display = 'none';
      document.getElementById('video-hint').style.display = 'none';
    });
    
    // HTML 内に写真用の非表示 canvas を作成
    (function createPhotoCanvas() {
      let canvas = document.getElementById('capture-canvas');
      if (!canvas) {
        canvas = document.createElement('canvas');
        canvas.id = 'capture-canvas';
        canvas.style.display = 'none';
        document.body.appendChild(canvas);
      }
    })();
    
    // ----- 手書きメモ機能 -----
    
    document.getElementById('handwrite-input').addEventListener('click', function() {
      document.getElementById('handwrite-section').style.display = 'block';
      const canvas = document.getElementById('handwrite-canvas');
      const ctx = canvas.getContext('2d');
      ctx.clearRect(0, 0, canvas.width, canvas.height);
    });
    
    (function() {
      const canvas = document.getElementById('handwrite-canvas');
      const ctx = canvas.getContext('2d');
      let drawing = false, lastX = 0, lastY = 0;
      
      function startDrawing(x, y) {
        drawing = true;
        [lastX, lastY] = [x, y];
      }
      function draw(x, y) {
        if (!drawing) return;
        ctx.beginPath();
        ctx.moveTo(lastX, lastY);
        ctx.lineTo(x, y);
        ctx.strokeStyle = '#000';
        ctx.lineWidth = 2;
        ctx.stroke();
        [lastX, lastY] = [x, y];
      }
      function endDrawing() {
        drawing = false;
      }
      
      canvas.addEventListener('mousedown', (e) => startDrawing(e.offsetX, e.offsetY));
      canvas.addEventListener('mousemove', (e) => draw(e.offsetX, e.offsetY));
      canvas.addEventListener('mouseup', endDrawing);
      canvas.addEventListener('mouseleave', endDrawing);
      
      canvas.addEventListener('touchstart', (e) => {
        e.preventDefault();
        const rect = canvas.getBoundingClientRect();
        const touch = e.touches[0];
        startDrawing(touch.clientX - rect.left, touch.clientY - rect.top);
      });
      canvas.addEventListener('touchmove', (e) => {
        e.preventDefault();
        const rect = canvas.getBoundingClientRect();
        const touch = e.touches[0];
        draw(touch.clientX - rect.left, touch.clientY - rect.top);
      });
      canvas.addEventListener('touchend', (e) => {
        e.preventDefault();
        endDrawing();
      });
    })();
    
    document.getElementById('clear-handwrite').addEventListener('click', function() {
      const canvas = document.getElementById('handwrite-canvas');
      const ctx = canvas.getContext('2d');
      ctx.clearRect(0, 0, canvas.width, canvas.height);
    });
    document.getElementById('save-handwrite').addEventListener('click', function() {
      const canvas = document.getElementById('handwrite-canvas');
      currentImageData = canvas.toDataURL('image/png');
      document.getElementById('handwrite-section').style.display = 'none';
    });
    document.getElementById('cancel-handwrite').addEventListener('click', function() {
      document.getElementById('handwrite-section').style.display = 'none';
    });
    
    // ----- エクスポート／インポート／印刷／全削除 -----
    
    document.getElementById('sort-order').addEventListener('change', updateMemoList);
    document.getElementById('search-box').addEventListener('input', updateMemoList);
    
    document.getElementById('export-memos').addEventListener('click', function() {
      const exportData = JSON.stringify(memos, null, 2);
      const content = `
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>エクスポートされたメモ</title>
</head>
<body>
<!-- MEMO_DATA_START
${exportData}
MEMO_DATA_END -->
<h1>エクスポートされたメモ</h1>
<p>このファイルにはエクスポートされたメモが含まれています。メモアプリのインポート機能を使用してデータを復元してください。</p>
</body>
</html>`;
      const blob = new Blob([content], { type: 'text/html' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = '高速メモ.html';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    });
    
    document.getElementById('import-file').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(event) {
        const content = event.target.result;
        const regex = /<!-- MEMO_DATA_START([\s\S]*?)MEMO_DATA_END -->/;
        const match = content.match(regex);
        if (match && match[1]) {
          try {
            const importedMemos = JSON.parse(match[1]);
            if (Array.isArray(importedMemos)) {
              memos = importedMemos;
              saveMemosToStorage();
              updateMemoList();
              alert('メモのインポートに成功しました！');
            } else {
              alert('無効なメモデータ形式です。');
            }
          } catch (err) {
            alert('メモデータ解析エラー: ' + err);
          }
        } else {
          alert('ファイル内にメモデータが見つかりませんでした。');
        }
      };
      reader.readAsText(file);
    });
    
    document.getElementById('print-memos').addEventListener('click', function() {
      window.print();
    });
    
    document.getElementById('delete-all').addEventListener('click', function() {
      if (confirm('本当に全てのメモを削除しますか？')) {
        memos = [];
        saveMemosToStorage();
        updateMemoList();
      }
    });
    
    document.getElementById('toggle-dark-mode').addEventListener('click', function() {
      document.body.classList.toggle('dark-mode');
    });
    
    // 初期化：メモ読み込み＆リスト更新
    loadMemos();
    updateMemoList();
  </script>
</body>
</html>
