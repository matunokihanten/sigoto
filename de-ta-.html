<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å£²ä¸Šãƒ‡ãƒ¼ã‚¿åˆ†æãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ Pro</title>
    <style>
        :root {
            --primary-color: #1a237e;
            --secondary-color: #3f51b5;
            --accent-color: #ff5722;
            --success-color: #4caf50;
            --warning-color: #ff9800;
            --error-color: #f44336;
            --background-color: #f5f5f5;
            --surface-color: #ffffff;
            --text-primary: #212121;
            --text-secondary: #757575;
            --border-color: #e0e0e0;
        }

        [data-theme="dark"] {
            --background-color: #121212;
            --surface-color: #1e1e1e;
            --text-primary: #ffffff;
            --text-secondary: #aaaaaa;
            --border-color: #333333;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--background-color);
            color: var(--text-primary);
            line-height: 1.6;
            transition: all 0.3s ease;
        }

        .app-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 30px;
            text-align: center;
            position: relative;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .theme-toggle {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 10px 15px;
            border-radius: 50px;
            cursor: pointer;
            font-size: 14px;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }

        .theme-toggle:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.05);
        }

        .card {
            background-color: var(--surface-color);
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            margin-bottom: 25px;
            overflow: hidden;
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
        }

        .card:hover {
            box-shadow: 0 8px 30px rgba(0,0,0,0.15);
        }

        .card-header {
            padding: 20px;
            background: linear-gradient(135deg, var(--surface-color), rgba(63,81,181,0.05));
            border-bottom: 2px solid var(--border-color);
        }

        .card-header h2 {
            color: var(--primary-color);
            font-size: 1.4rem;
            margin-bottom: 5px;
        }

        .card-content {
            padding: 20px;
        }

        .info-box {
            background: linear-gradient(135deg, #fff3cd, #ffeaa7);
            border: 1px solid #ffeeba;
            color: #856404;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 25px;
            text-align: center;
            font-size: 0.95rem;
            position: relative;
            overflow: hidden;
        }

        .info-box::before {
            content: "âš ï¸";
            position: absolute;
            top: -10px;
            left: -10px;
            font-size: 60px;
            opacity: 0.1;
        }

        .drag-drop-area {
            border: 3px dashed var(--border-color);
            padding: 50px 30px;
            border-radius: 12px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            background: var(--surface-color);
            position: relative;
            overflow: hidden;
        }

        .drag-drop-area::before {
            content: "ğŸ“Š";
            position: absolute;
            top: -20px;
            right: -20px;
            font-size: 100px;
            opacity: 0.05;
        }

        .drag-drop-area:hover, .drag-drop-area.active {
            border-color: var(--secondary-color);
            background: rgba(63,81,181,0.05);
            transform: translateY(-2px);
        }

        .controls-panel {
            background: var(--surface-color);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
        }

        .controls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            align-items: center;
        }

        .btn {
            background: var(--secondary-color);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn:hover {
            background: var(--primary-color);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .btn.danger {
            background: var(--error-color);
        }

        .btn.success {
            background: var(--success-color);
        }

        .btn.warning {
            background: var(--warning-color);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .summary-card {
            background: linear-gradient(135deg, var(--surface-color), rgba(63,81,181,0.05));
            padding: 30px 20px;
            border-radius: 12px;
            text-align: center;
            border: 1px solid var(--border-color);
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .summary-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
        }

        .summary-card::before {
            content: attr(data-icon);
            position: absolute;
            top: -10px;
            right: -10px;
            font-size: 80px;
            opacity: 0.1;
        }

        .summary-card h3 {
            color: var(--text-secondary);
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 15px;
        }

        .summary-card .value {
            font-size: 2.2rem;
            font-weight: bold;
            color: var(--primary-color);
            margin-bottom: 10px;
        }

        .summary-card .change {
            font-size: 0.85rem;
            padding: 4px 12px;
            border-radius: 20px;
            font-weight: 500;
        }

        .change.positive {
            background: rgba(76,175,80,0.1);
            color: var(--success-color);
        }

        .change.negative {
            background: rgba(244,67,54,0.1);
            color: var(--error-color);
        }

        .monthly-data-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            list-style: none;
            padding: 0;
            margin-top: 15px;
        }

        .monthly-data-list li {
            background: var(--border-color);
            color: var(--text-primary);
            padding: 10px 18px;
            border-radius: 25px;
            cursor: grab; /* ãƒ‰ãƒ©ãƒƒã‚°å¯èƒ½ã§ã‚ã‚‹ã“ã¨ã‚’ç¤ºã™ */
            transition: all 0.3s ease;
            font-weight: 500;
            position: relative;
            overflow: hidden;
        }
        
        .monthly-data-list li:active {
            cursor: grabbing;
        }

        .monthly-data-list li.drag-over {
            border-bottom: 3px solid var(--accent-color);
            transform: scale(1.08);
        }

        .monthly-data-list li::before {
            content: "";
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            transition: left 0.5s ease;
        }

        .monthly-data-list li:hover::before {
            left: 100%;
        }

        .monthly-data-list li.selected {
            background: var(--secondary-color);
            color: white;
            transform: scale(1.05);
        }

        .chart-container {
            background: var(--surface-color);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
            position: relative;
            min-height: 400px;
        }

        .chart-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid var(--border-color);
            flex-wrap: wrap; /* ã‚¹ãƒãƒ›è¡¨ç¤ºã§æŠ˜ã‚Šè¿”ã™ */
        }

        .chart-tab {
            background: transparent;
            border: none;
            padding: 12px 20px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            font-weight: 500;
            color: var(--text-secondary);
            transition: all 0.3s ease;
        }

        .chart-tab.active {
            color: var(--secondary-color);
            border-bottom-color: var(--secondary-color);
        }

        .filter-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            align-items: center;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .checkbox-group input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .table-wrapper {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch; /* iOSã§ã®ã‚¹ãƒ ãƒ¼ã‚ºã‚¹ã‚¯ãƒ­ãƒ¼ãƒ« */
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
            background: var(--surface-color);
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            min-width: 600px; /* ãƒ†ãƒ¼ãƒ–ãƒ«ã®æœ€å°å¹…ã‚’æŒ‡å®šã—ã¦ã€ã‚¹ãƒãƒ›ã§ã®è¡¨ç¤ºå´©ã‚Œã‚’é˜²ã */
        }

        .data-table th,
        .data-table td {
            padding: 12px 15px;
            text-align: center;
            border-bottom: 1px solid var(--border-color);
        }

        .data-table th {
            background: linear-gradient(135deg, var(--secondary-color), var(--primary-color));
            color: white;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .data-table tbody tr {
            transition: all 0.3s ease;
        }

        .data-table tbody tr:nth-child(even) {
            background: rgba(63,81,181,0.03);
        }

        .data-table tbody tr:hover {
            background: rgba(63,81,181,0.1);
            transform: scale(1.01);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-item {
            background: var(--surface-color);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            text-align: center;
        }

        .stat-item .label {
            font-size: 0.8rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            margin-bottom: 5px;
        }

        .stat-item .value {
            font-size: 1.4rem;
            font-weight: bold;
            color: var(--primary-color);
        }

        .hidden { display: none !important; }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .alert {
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid;
            animation: slideIn 0.3s ease;
        }

        .alert.success {
            background: rgba(76,175,80,0.1);
            border-color: var(--success-color);
            color: var(--success-color);
        }

        .alert.error {
            background: rgba(244,67,54,0.1);
            border-color: var(--error-color);
            color: var(--error-color);
        }

        .alert.warning {
            background: rgba(255,152,0,0.1);
            border-color: var(--warning-color);
            color: var(--warning-color);
        }

        @keyframes slideIn {
            from { transform: translateX(-100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .progress-bar {
            width: 100%;
            height: 4px;
            background: var(--border-color);
            border-radius: 2px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-bar .progress {
            height: 100%;
            background: linear-gradient(90deg, var(--secondary-color), var(--primary-color));
            width: 0%;
            transition: width 0.3s ease;
        }

        .tooltip {
            position: relative;
            cursor: help;
        }

        .tooltip:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.9);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            white-space: nowrap;
            z-index: 1000;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            backdrop-filter: blur(5px);
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: var(--surface-color);
            padding: 30px;
            border-radius: 12px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
        }

        .modal-close {
            position: absolute;
            top: 15px;
            right: 20px;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-secondary);
        }

        /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ãƒ‡ã‚¶ã‚¤ãƒ³ */
        @media (max-width: 768px) {
            .app-container {
                padding: 10px;
            }

            .header h1 {
                font-size: 2rem;
            }

            .theme-toggle {
                position: static;
                margin: 15px auto 0;
                display: block;
            }

            .controls-grid {
                grid-template-columns: 1fr;
            }

            .summary-grid {
                grid-template-columns: 1fr;
            }

            .filter-controls {
                grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            }

            .stats-grid {
                grid-template-columns: 1fr 1fr;
            }

            .data-table {
                font-size: 0.8rem;
            }

            .data-table th,
            .data-table td {
                padding: 8px 5px;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="header">
            <button class="theme-toggle" onclick="toggleTheme()">ğŸŒ“ ãƒ†ãƒ¼ãƒåˆ‡æ›¿</button>
            <h1>å£²ä¸Šãƒ‡ãƒ¼ã‚¿åˆ†æãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ Pro</h1>
            <p>é«˜åº¦ãªåˆ†ææ©Ÿèƒ½ã¨ç¾ã—ã„å¯è¦–åŒ–ã§ãƒ“ã‚¸ãƒã‚¹ã‚¤ãƒ³ã‚µã‚¤ãƒˆã‚’ç™ºè¦‹</p>
        </div>

        <div id="alerts-container"></div>

        <div class="info-box">
            <strong>ğŸš¨ é‡è¦ãªæ³¨æ„äº‹é …</strong><br>
            ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç›´æ¥é–‹ãã¨å‹•ä½œã—ã¾ã›ã‚“ã€‚Webã‚µãƒ¼ãƒãƒ¼çµŒç”±ã§é–‹ã„ã¦ãã ã•ã„ã€‚<br>
            åˆ†æä¸­ã®ãƒ‡ãƒ¼ã‚¿ã¯JSONãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦ä¿å­˜ãƒ»èª­ã¿è¾¼ã¿ãŒå¯èƒ½ã§ã™ã€‚
        </div>

        <div class="card">
            <div class="card-header">
                <h2>ğŸ“ ãƒ‡ãƒ¼ã‚¿ç®¡ç†</h2>
                <div class="progress-bar">
                    <div class="progress" id="upload-progress"></div>
                </div>
            </div>
            <div class="card-content">
                <div class="controls-grid">
                    <button class="btn" id="load-excel-btn">
                        ğŸ“Š æ–°ã—ã„Excelã‚’èª­ã¿è¾¼ã‚€
                    </button>
                    <button class="btn danger" id="clear-data-btn">
                        ğŸ—‘ï¸ ãƒ‡ãƒ¼ã‚¿ã‚’å…¨ã¦ã‚¯ãƒªã‚¢
                    </button>
                    <button class="btn success" id="save-session-btn">
                        ğŸ’¾ ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ä¿å­˜ï¼ˆJSONï¼‰
                    </button>
                    <button class="btn" id="load-session-btn">
                        ğŸ“‚ ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’èª­ã¿è¾¼ã‚€ï¼ˆJSONï¼‰
                    </button>
                </div>
                <input type="file" id="excel-file-input" accept=".xlsx, .xls, .csv" style="display:none;">
                <input type="file" id="session-file-input" accept=".json" style="display:none;">
            </div>
        </div>

        <div class="drag-drop-area" id="drag-drop-area">
            <h3>ğŸ“Š Excelï¼ˆ.xlsxï¼‰ã¾ãŸã¯CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã“ã“ã«ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—</h3>
            <p>ã¾ãŸã¯ã€ã€Œæ–°ã—ã„Excelã‚’èª­ã¿è¾¼ã‚€ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯</p>
            <p style="margin-top: 15px; color: var(--text-secondary); font-size: 0.9rem;">
                å¯¾å¿œãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ: .xlsx, .xls, .csv
            </p>
        </div>

        <div id="main-content" class="hidden">
            <div class="card">
                <div class="card-header">
                    <h2>ğŸ“ˆ èª­ã¿è¾¼ã¿æ¸ˆã¿ãƒ‡ãƒ¼ã‚¿ä¸€è¦§</h2>
                    <p>åˆ†æå¯¾è±¡ã®æœˆã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚ï¼ˆ<span id="loaded-data-count">0</span>ä»¶ï¼‰ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—ã§ä¸¦ã¹æ›¿ãˆã§ãã¾ã™ã€‚</p>
                </div>
                <div class="card-content">
                    <ul class="monthly-data-list" id="monthly-data-list"></ul>
                    <div class="controls-grid" style="margin-top: 20px;">
                        <button class="btn" id="select-all-btn">âœ… å…¨ã¦é¸æŠ</button>
                        <button class="btn" id="deselect-all-btn">âŒ å…¨ã¦è§£é™¤</button>
                        <button class="btn" id="data-validation-btn">ğŸ” ãƒ‡ãƒ¼ã‚¿æ¤œè¨¼</button>
                    </div>
                </div>
            </div>

            <div class="summary-grid">
                <div class="summary-card" data-icon="ğŸ’°">
                    <h3>ç·å£²ä¸Šé«˜</h3>
                    <div class="value" id="total-sales-sum">Â¥0</div>
                    <div class="change" id="sales-change">--</div>
                </div>
                <div class="summary-card" data-icon="ğŸ‘¥">
                    <h3>ç·å®¢æ•°</h3>
                    <div class="value" id="total-customers-sum">0 äºº</div>
                    <div class="change" id="customers-change">--</div>
                </div>
                <div class="summary-card" data-icon="ğŸ¯">
                    <h3>å¹³å‡å®¢å˜ä¾¡</h3>
                    <div class="value" id="avg-customer-spend">Â¥0</div>
                    <div class="change" id="avg-spend-change">--</div>
                </div>
                <div class="summary-card" data-icon="ğŸ“Š">
                    <h3>åˆ†ææœŸé–“</h3>
                    <div class="value" id="analysis-period">0 æ—¥</div>
                    <div class="change" id="period-info">--</div>
                </div>
            </div>

            <div class="stats-grid">
                <div class="stat-item">
                    <div class="label">æœ€é«˜å£²ä¸Šæ—¥</div>
                    <div class="value" id="max-sales-day">--</div>
                </div>
                <div class="stat-item">
                    <div class="label">æœ€ä½å£²ä¸Šæ—¥</div>
                    <div class="value" id="min-sales-day">--</div>
                </div>
                <div class="stat-item">
                    <div class="label">æœ€å¤šå®¢æ•°æ—¥</div>
                    <div class="value" id="max-customers-day">--</div>
                </div>
                <div class="stat-item">
                    <div class="label">å¹³å‡æ—¥å£²ä¸Š</div>
                    <div class="value" id="avg-daily-sales">Â¥0</div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h2>ğŸ“Š ãƒ‡ãƒ¼ã‚¿åˆ†æ</h2>
                </div>
                <div class="card-content">
                    <div class="chart-tabs">
                        <button class="chart-tab active" onclick="switchChart('time')">æ™‚é–“å¸¯åˆ¥åˆ†æ</button>
                        <button class="chart-tab" onclick="switchChart('daily')">æ—¥åˆ¥æ¨ç§»</button>
                        <button class="chart-tab" onclick="switchChart('weekly')">æ›œæ—¥åˆ¥åˆ†æ</button>
                        <button class="chart-tab" onclick="switchChart('comparison')">æœŸé–“æ¯”è¼ƒ</button>
                    </div>

                    <div class="controls-panel filter-controls">
                        <div style="grid-column: 1/-1;">
                            <strong>ğŸ—“ï¸ æ›œæ—¥ã§çµã‚Šè¾¼ã¿:</strong>
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" name="day-filter" value="æ—¥" id="sun" checked>
                            <label for="sun">æ—¥</label>
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" name="day-filter" value="æœˆ" id="mon" checked>
                            <label for="mon">æœˆ</label>
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" name="day-filter" value="ç«" id="tue" checked>
                            <label for="tue">ç«</label>
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" name="day-filter" value="æ°´" id="wed" checked>
                            <label for="wed">æ°´</label>
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" name="day-filter" value="æœ¨" id="thu" checked>
                            <label for="thu">æœ¨</label>
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" name="day-filter" value="é‡‘" id="fri" checked>
                            <label for="fri">é‡‘</label>
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" name="day-filter" value="åœŸ" id="sat" checked>
                            <label for="sat">åœŸ</label>
                        </div>
                        <button class="btn" id="filter-btn">ğŸ” é©ç”¨</button>
                    </div>

                    <div class="chart-container">
                        <canvas id="main-chart"></canvas>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h2>ğŸ“‹ æ—¥åˆ¥é›†è¨ˆ</h2>
                </div>
                <div class="card-content">
                    <div class="controls-grid">
                        <div>
                            <h4>ğŸ•’ é›†è¨ˆç¯„å›²1</h4>
                            <select id="start-hour-1"></select> æ™‚ ã‹ã‚‰
                            <select id="end-hour-1"></select> æ™‚ã¾ã§
                        </div>
                        <div>
                            <h4>ğŸ•’ é›†è¨ˆç¯„å›²2</h4>
                            <select id="start-hour-2"></select> æ™‚ ã‹ã‚‰
                            <select id="end-hour-2"></select> æ™‚ã¾ã§
                        </div>
                        <button class="btn success" id="calculate-btn">ğŸ§® è¨ˆç®—å®Ÿè¡Œ</button>
                        <button class="btn warning" id="export-btn">ğŸ“¤ Excelã§ä¿å­˜</button>
                    </div>
                    <div class="table-wrapper">
                        <table class="data-table hidden" id="daily-summary-table">
                            <thead>
                                <tr id="table-headers-row"></tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div id="validation-modal" class="modal">
            <div class="modal-content">
                <button class="modal-close" onclick="closeModal('validation-modal')">&times;</button>
                <h2>ğŸ” ãƒ‡ãƒ¼ã‚¿æ¤œè¨¼çµæœ</h2>
                <div id="validation-results"></div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let allMonthlyData = [];
        let timeLabels = [];
        let selectedMonths = new Set();
        let mainChart = null;
        let lastCalculatedTotals = {};
        let currentChartType = 'time';
        let monthOrder = []; // æœˆã®é †åºã‚’ä¿æŒ
        let draggedMonth = null; // ãƒ‰ãƒ©ãƒƒã‚°ä¸­ã®æœˆã‚’ä¿æŒ

        // DOMè¦ç´ ã®å–å¾—
        const elements = {
            excelFileInput: document.getElementById('excel-file-input'),
            sessionFileInput: document.getElementById('session-file-input'),
            dragDropArea: document.getElementById('drag-drop-area'),
            mainContent: document.getElementById('main-content'),
            loadExcelBtn: document.getElementById('load-excel-btn'),
            loadedDataCount: document.getElementById('loaded-data-count'),
            monthlyDataList: document.getElementById('monthly-data-list'),
            selectAllBtn: document.getElementById('select-all-btn'),
            deselectAllBtn: document.getElementById('deselect-all-btn'),
            clearDataBtn: document.getElementById('clear-data-btn'),
            saveSessionBtn: document.getElementById('save-session-btn'),
            loadSessionBtn: document.getElementById('load-session-btn'),
            dataValidationBtn: document.getElementById('data-validation-btn'),
            startHourSelect1: document.getElementById('start-hour-1'),
            endHourSelect1: document.getElementById('end-hour-1'),
            startHourSelect2: document.getElementById('start-hour-2'),
            endHourSelect2: document.getElementById('end-hour-2'),
            calculateBtn: document.getElementById('calculate-btn'),
            dailySummaryTable: document.getElementById('daily-summary-table'),
            exportBtn: document.getElementById('export-btn'),
            filterBtn: document.getElementById('filter-btn'),
            uploadProgress: document.getElementById('upload-progress'),
            alertsContainer: document.getElementById('alerts-container')
        };

        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¨­å®š
        function initializeEventListeners() {
            elements.loadExcelBtn.addEventListener('click', () => elements.excelFileInput.click());
            elements.loadSessionBtn.addEventListener('click', () => elements.sessionFileInput.click());
            
            elements.dragDropArea.addEventListener('dragover', handleDragOver);
            elements.dragDropArea.addEventListener('dragleave', handleDragLeave);
            elements.dragDropArea.addEventListener('drop', handleDrop);
            
            elements.excelFileInput.addEventListener('change', handleFileSelect);
            elements.sessionFileInput.addEventListener('change', handleSessionFileSelect);
            
            elements.selectAllBtn.addEventListener('click', selectAllMonths);
            elements.deselectAllBtn.addEventListener('click', deselectAllMonths);
            elements.calculateBtn.addEventListener('click', calculateAndDisplayDailyTotals);
            elements.exportBtn.addEventListener('click', exportDataToExcel);
            elements.filterBtn.addEventListener('click', filterDataAndRefreshDashboard);
            elements.clearDataBtn.addEventListener('click', clearAllData);
            elements.saveSessionBtn.addEventListener('click', saveSession);
            elements.dataValidationBtn.addEventListener('click', showDataValidation);
        }

        // ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ (ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ç”¨)
        function handleDragOver(e) {
            e.preventDefault();
            elements.dragDropArea.classList.add('active');
        }

        function handleDragLeave() {
            elements.dragDropArea.classList.remove('active');
        }

        function handleDrop(e) {
            e.preventDefault();
            elements.dragDropArea.classList.remove('active');
            const file = e.dataTransfer.files[0];
            if (file) handleExcelFile(file);
        }

        // ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ (æœˆãƒªã‚¹ãƒˆä¸¦ã¹æ›¿ãˆç”¨)
        function handleDragStart(e) {
            draggedMonth = e.target.dataset.month;
            setTimeout(() => e.target.style.opacity = '0.5', 0);
        }

        function handleDragOverListItem(e) {
            e.preventDefault();
            if (e.target.dataset.month && e.target.dataset.month !== draggedMonth) {
                e.target.classList.add('drag-over');
            }
        }

        function handleDragLeaveListItem(e) {
            e.target.classList.remove('drag-over');
        }

        function handleDropListItem(e) {
            e.preventDefault();
            const droppedOnMonth = e.target.dataset.month;
            if (droppedOnMonth && draggedMonth !== droppedOnMonth) {
                const fromIndex = monthOrder.indexOf(draggedMonth);
                const toIndex = monthOrder.indexOf(droppedOnMonth);
                const item = monthOrder.splice(fromIndex, 1)[0];
                monthOrder.splice(toIndex, 0, item);
                populateMonthlyList();
            }
        }
        
        function handleDragEnd(e) {
            e.target.style.opacity = '1';
            draggedMonth = null;
            document.querySelectorAll('.monthly-data-list li.drag-over').forEach(li => li.classList.remove('drag-over'));
        }


        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (file) handleExcelFile(file);
            e.target.value = '';
        }

        function handleSessionFileSelect(e) {
            const file = e.target.files[0];
            if (file) handleJsonFile(file);
            e.target.value = '';
        }

        // ãƒ•ã‚¡ã‚¤ãƒ«å‡¦ç†
        function handleExcelFile(file) {
            showAlert('info', `ãƒ•ã‚¡ã‚¤ãƒ« "${file.name}" ã‚’èª­ã¿è¾¼ã¿ä¸­...`);
            updateProgress(10);
            
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    updateProgress(50);
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                    const json = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                    
                    updateProgress(80);
                    processNewData(json);
                    updateProgress(100);
                    
                    setTimeout(() => updateProgress(0), 1000);
                    showAlert('success', 'ãƒ•ã‚¡ã‚¤ãƒ«ãŒæ­£å¸¸ã«èª­ã¿è¾¼ã¾ã‚Œã¾ã—ãŸï¼');
                } catch (error) {
                    updateProgress(0);
                    showAlert('error', 'ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
                    console.error(error);
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function handleJsonFile(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const loadedData = JSON.parse(e.target.result);
                    allMonthlyData = loadedData.allMonthlyData || [];
                    timeLabels = loadedData.timeLabels || [];
                    monthOrder = loadedData.monthOrder || [...new Set(allMonthlyData.map(d => d.month))].sort();
                    
                    if (elements.startHourSelect1.options.length === 0 && timeLabels.length > 0) {
                        populateHourSelects(timeLabels);
                    }
                    
                    populateMonthlyList();
                    updateDashboard();
                    showAlert('success', 'ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒæ­£å¸¸ã«èª­ã¿è¾¼ã¾ã‚Œã¾ã—ãŸï¼');
                } catch (error) {
                    showAlert('error', 'ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
                    console.error(error);
                }
            };
            reader.readAsText(file);
        }

        // ãƒ‡ãƒ¼ã‚¿å‡¦ç†
        function processNewData(data) {
            const headers = data[0];
            const indices = findDataIndices(headers);
            
            if (!validateHeaders(indices)) {
                showAlert('error', 'å¿…è¦ãªåˆ—ï¼ˆæ—¥ä»˜ã€æ›œæ—¥ã€æ™‚é–“å¸¯åˆ¥ãƒ‡ãƒ¼ã‚¿ï¼‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚');
                return;
            }

            if (timeLabels.length === 0) {
                timeLabels = headers.slice(indices.salesStart, indices.salesEnd + 1)
                    .map(h => h.replace('å£²ä¸Šé«˜', ''));
                populateHourSelects(timeLabels);
            }

            const newMonthlyData = data.slice(1)
                .map(row => createDailyEntry(row, indices))
                .filter(entry => entry && entry.date);

            const wasMonthOrderEmpty = monthOrder.length === 0;
            const existingMonths = new Set(monthOrder);
            const newMonths = [...new Set(newMonthlyData.map(d => d.month))];
            
            newMonths.forEach(month => {
                if (!existingMonths.has(month)) {
                    monthOrder.push(month);
                }
            });

            if (wasMonthOrderEmpty) {
                monthOrder.sort();
            }

            allMonthlyData.push(...newMonthlyData);
            populateMonthlyList();
            updateDashboard();
        }

        function findDataIndices(headers) {
            return {
                date: headers.indexOf('æ—¥ä»˜'),
                dayOfWeek: headers.indexOf('æ›œæ—¥'),
                salesStart: headers.indexOf('4æ™‚å£²ä¸Šé«˜'),
                customersStart: headers.indexOf('4æ™‚å®¢æ•°'),
                salesEnd: headers.indexOf('3æ™‚å£²ä¸Šé«˜')
            };
        }

        function validateHeaders(indices) {
            return indices.date !== -1 && 
                   indices.salesStart !== -1 && 
                   indices.salesEnd !== -1 && 
                   indices.customersStart !== -1;
        }

        function createDailyEntry(row, indices) {
            const date = parseDate(row[indices.date]);
            if (!date) return null;

            return {
                date: date,
                month: parseMonth(row[indices.date]),
                dayOfWeek: row[indices.dayOfWeek] || '',
                sales: Object.fromEntries(
                    timeLabels.map((label, i) => 
                        [label, parseNumber(row[indices.salesStart + i])]
                    )
                ),
                customers: Object.fromEntries(
                    timeLabels.map((label, i) => 
                        [label, parseNumber(row[indices.customersStart + i])]
                    )
                )
            };
        }

        // UIæ›´æ–°
        function populateMonthlyList() {
            elements.monthlyDataList.innerHTML = '';
            const months = monthOrder;
            elements.loadedDataCount.textContent = months.length;

            months.forEach(month => {
                const li = document.createElement('li');
                li.textContent = month;
                li.dataset.month = month;
                li.draggable = true;
                
                if (selectedMonths.has(month)) {
                    li.classList.add('selected');
                }
                
                li.addEventListener('click', () => toggleMonthSelection(month, li));
                
                li.addEventListener('dragstart', handleDragStart);
                li.addEventListener('dragover', handleDragOverListItem);
                li.addEventListener('dragleave', handleDragLeaveListItem);
                li.addEventListener('drop', handleDropListItem);
                li.addEventListener('dragend', handleDragEnd);

                elements.monthlyDataList.appendChild(li);
            });

            // åˆå›ãƒ‡ãƒ¼ã‚¿ãƒ­ãƒ¼ãƒ‰æ™‚ã¯å…¨ã¦é¸æŠ
            if (selectedMonths.size === 0 && months.length > 0 && allMonthlyData.length > 0) {
                months.forEach(month => selectedMonths.add(month));
                populateMonthlyList();
            }
        }

        function toggleMonthSelection(month, element) {
            if (selectedMonths.has(month)) {
                selectedMonths.delete(month);
                element.classList.remove('selected');
            } else {
                selectedMonths.add(month);
                element.classList.add('selected');
            }
            updateDashboard();
        }

        function selectAllMonths() {
            monthOrder.forEach(month => selectedMonths.add(month));
            populateMonthlyList();
            updateDashboard();
        }

        function deselectAllMonths() {
            selectedMonths.clear();
            populateMonthlyList();
            updateDashboard();
        }

        // ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰æ›´æ–°
        function updateDashboard() {
            if (allMonthlyData.length === 0 || selectedMonths.size === 0) {
                clearMainContentUI();
                return;
            }

            const filteredData = getFilteredData();
            updateSummaryCards(filteredData);
            updateStatistics(filteredData);
            renderChart(filteredData);
            
            elements.dragDropArea.classList.add('hidden');
            elements.mainContent.classList.remove('hidden');
            
            calculateAndDisplayDailyTotals();
        }

        function getFilteredData() {
            const filteredByMonth = allMonthlyData.filter(day => selectedMonths.has(day.month));
            const selectedDays = getSelectedDays();
            return filteredByMonth.filter(day => selectedDays.includes(day.dayOfWeek));
        }

        function updateSummaryCards(filteredData) {
            let totalSales = 0;
            let totalCustomers = 0;

            filteredData.forEach(day => {
                totalSales += Object.values(day.sales).reduce((sum, val) => sum + val, 0);
                totalCustomers += Object.values(day.customers).reduce((sum, val) => sum + val, 0);
            });

            const avgSpend = totalCustomers > 0 ? totalSales / totalCustomers : 0;

            document.getElementById('total-sales-sum').textContent = `Â¥${totalSales.toLocaleString()}`;
            document.getElementById('total-customers-sum').textContent = `${totalCustomers.toLocaleString()} äºº`;
            document.getElementById('avg-customer-spend').textContent = `Â¥${Math.round(avgSpend).toLocaleString()}`;
            document.getElementById('analysis-period').textContent = `${filteredData.length} æ—¥`;
        }

        function updateStatistics(filteredData) {
            if (filteredData.length === 0) {
                 // çµ±è¨ˆæƒ…å ±ã‚’ã‚¯ãƒªã‚¢
                document.getElementById('max-sales-day').textContent = '--';
                document.getElementById('min-sales-day').textContent = '--';
                document.getElementById('max-customers-day').textContent = '--';
                document.getElementById('avg-daily-sales').textContent = 'Â¥0';
                return;
            }

            const dailyTotals = filteredData.map(day => {
                const dailySales = Object.values(day.sales).reduce((sum, val) => sum + val, 0);
                const dailyCustomers = Object.values(day.customers).reduce((sum, val) => sum + val, 0);
                return { date: day.date, sales: dailySales, customers: dailyCustomers };
            });

            const maxSalesDay = dailyTotals.reduce((max, day) => 
                day.sales > max.sales ? day : max
            );
            
            const minSalesDay = dailyTotals.reduce((min, day) => 
                day.sales < min.sales ? day : min
            );
            
            const maxCustomersDay = dailyTotals.reduce((max, day) => 
                day.customers > max.customers ? day : max
            );
            
            const avgDailySales = dailyTotals.reduce((sum, day) => sum + day.sales, 0) / dailyTotals.length;

            document.getElementById('max-sales-day').textContent = 
                `${maxSalesDay.date}\nÂ¥${maxSalesDay.sales.toLocaleString()}`;
            document.getElementById('min-sales-day').textContent = 
                `${minSalesDay.date}\nÂ¥${minSalesDay.sales.toLocaleString()}`;
            document.getElementById('max-customers-day').textContent = 
                `${maxCustomersDay.date}\n${maxCustomersDay.customers.toLocaleString()}äºº`;
            document.getElementById('avg-daily-sales').textContent = 
                `Â¥${Math.round(avgDailySales).toLocaleString()}`;
        }

        // ãƒãƒ£ãƒ¼ãƒˆè¡¨ç¤º
        function switchChart(type) {
            currentChartType = type;
            document.querySelectorAll('.chart-tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');
            
            const filteredData = getFilteredData();
            renderChart(filteredData);
        }

        function renderChart(filteredData) {
            if (mainChart) mainChart.destroy();

            const ctx = document.getElementById('main-chart').getContext('2d');
            
            switch (currentChartType) {
                case 'time':
                    renderTimeChart(ctx, filteredData);
                    break;
                case 'daily':
                    renderDailyChart(ctx, filteredData);
                    break;
                case 'weekly':
                    renderWeeklyChart(ctx, filteredData);
                    break;
                case 'comparison':
                    renderComparisonChart(ctx, filteredData);
                    break;
            }
        }

        function renderTimeChart(ctx, filteredData) {
            const salesAverages = timeLabels.map(label => {
                const total = filteredData.reduce((sum, entry) => sum + (entry.sales[label] || 0), 0);
                return filteredData.length > 0 ? total / filteredData.length : 0;
            });

            const customerAverages = timeLabels.map(label => {
                const total = filteredData.reduce((sum, entry) => sum + (entry.customers[label] || 0), 0);
                return filteredData.length > 0 ? total / filteredData.length : 0;
            });

            mainChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: timeLabels,
                    datasets: [
                        {
                            label: 'å¹³å‡å£²ä¸Šé«˜',
                            data: salesAverages,
                            backgroundColor: 'rgba(63, 81, 181, 0.8)',
                            borderColor: 'rgba(63, 81, 181, 1)',
                            borderWidth: 2,
                            yAxisID: 'y'
                        },
                        {
                            label: 'å¹³å‡å®¢æ•°',
                            data: customerAverages,
                            backgroundColor: 'rgba(255, 87, 34, 0.8)',
                            borderColor: 'rgba(255, 87, 34, 1)',
                            borderWidth: 2,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'æ™‚é–“å¸¯åˆ¥å¹³å‡å£²ä¸Šé«˜ãƒ»å®¢æ•°',
                            font: { size: 16, weight: 'bold' }
                        },
                        legend: {
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: { display: true, text: 'å¹³å‡å£²ä¸Šé«˜ (å††)' }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: { display: true, text: 'å¹³å‡å®¢æ•° (äºº)' },
                            grid: { drawOnChartArea: false }
                        }
                    }
                }
            });
        }

        function renderDailyChart(ctx, filteredData) {
            const sortedData = filteredData.sort((a, b) => new Date(a.date.replace(/å¹´|æœˆ|æ—¥/g, '/')) - new Date(b.date.replace(/å¹´|æœˆ|æ—¥/g, '/')));
            const labels = sortedData.map(d => d.date);
            const salesData = sortedData.map(d => 
                Object.values(d.sales).reduce((sum, val) => sum + val, 0)
            );

            mainChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'æ—¥åˆ¥å£²ä¸Šé«˜',
                        data: salesData,
                        borderColor: 'rgba(63, 81, 181, 1)',
                        backgroundColor: 'rgba(63, 81, 181, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'æ—¥åˆ¥å£²ä¸Šé«˜æ¨ç§»',
                            font: { size: 16, weight: 'bold' }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: 'å£²ä¸Šé«˜ (å††)' }
                        }
                    }
                }
            });
        }

        function renderWeeklyChart(ctx, filteredData) {
            const dayOrder = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];
            const weeklyData = {};
            
            dayOrder.forEach(day => {
                weeklyData[day] = { sales: 0, customers: 0, count: 0 };
            });

            filteredData.forEach(day => {
                if (weeklyData[day.dayOfWeek]) {
                    weeklyData[day.dayOfWeek].sales += 
                        Object.values(day.sales).reduce((sum, val) => sum + val, 0);
                    weeklyData[day.dayOfWeek].customers += 
                        Object.values(day.customers).reduce((sum, val) => sum + val, 0);
                    weeklyData[day.dayOfWeek].count++;
                }
            });

            const salesAverages = dayOrder.map(day => 
                weeklyData[day].count > 0 ? weeklyData[day].sales / weeklyData[day].count : 0
            );

            mainChart = new Chart(ctx, {
                type: 'polarArea',
                data: {
                    labels: dayOrder,
                    datasets: [{
                        label: 'æ›œæ—¥åˆ¥å¹³å‡å£²ä¸Šé«˜',
                        data: salesAverages,
                        backgroundColor: [
                            'rgba(255, 99, 132, 0.6)',
                            'rgba(54, 162, 235, 0.6)',
                            'rgba(255, 205, 86, 0.6)',
                            'rgba(75, 192, 192, 0.6)',
                            'rgba(153, 102, 255, 0.6)',
                            'rgba(255, 159, 64, 0.6)',
                            'rgba(199, 199, 199, 0.6)'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'æ›œæ—¥åˆ¥å¹³å‡å£²ä¸Šé«˜',
                            font: { size: 16, weight: 'bold' }
                        }
                    }
                }
            });
        }

        function renderComparisonChart(ctx, filteredData) {
            const monthlyData = {};
            
            filteredData.forEach(day => {
                if (!monthlyData[day.month]) {
                    monthlyData[day.month] = { sales: 0, customers: 0 };
                }
                monthlyData[day.month].sales += 
                    Object.values(day.sales).reduce((sum, val) => sum + val, 0);
                monthlyData[day.month].customers += 
                    Object.values(day.customers).reduce((sum, val) => sum + val, 0);
            });

            const months = Object.keys(monthlyData).sort();
            const salesData = months.map(month => monthlyData[month].sales);
            const customersData = months.map(month => monthlyData[month].customers);

            mainChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: months,
                    datasets: [
                        {
                            label: 'æœˆåˆ¥å£²ä¸Šé«˜',
                            data: salesData,
                            backgroundColor: 'rgba(63, 81, 181, 0.8)',
                            yAxisID: 'y'
                        },
                        {
                            label: 'æœˆåˆ¥å®¢æ•°',
                            data: customersData,
                            backgroundColor: 'rgba(255, 87, 34, 0.8)',
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'æœˆåˆ¥æ¯”è¼ƒ',
                            font: { size: 16, weight: 'bold' }
                        }
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: { display: true, text: 'å£²ä¸Šé«˜ (å††)' }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: { display: true, text: 'å®¢æ•° (äºº)' },
                            grid: { drawOnChartArea: false }
                        }
                    }
                }
            });
        }

        // æ—¥åˆ¥é›†è¨ˆã¨ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
        function calculateAndDisplayDailyTotals() {
            if (selectedMonths.size === 0) {
                elements.dailySummaryTable.classList.add('hidden');
                return;
            }

            const startHour1 = parseInt(elements.startHourSelect1.value);
            const endHour1 = parseInt(elements.endHourSelect1.value);
            const startHour2 = parseInt(elements.startHourSelect2.value);
            const endHour2 = parseInt(elements.endHourSelect2.value);

            const filteredData = allMonthlyData.filter(day => selectedMonths.has(day.month));

            const totals1 = calculateTotalsForRange(filteredData, startHour1, endHour1);
            const totals2 = calculateTotalsForRange(filteredData, startHour2, endHour2);

            lastCalculatedTotals = {
                totals1,
                totals2,
                range1: `${startHour1}æ™‚-${endHour1}æ™‚`,
                range2: `${startHour2}æ™‚-${endHour2}æ™‚`
            };

            populateDailySummaryTable(lastCalculatedTotals);
        }

        function calculateTotalsForRange(data, startHour, endHour) {
            const totalsMap = new Map();
            
            data.forEach(day => {
                let dailySales = 0;
                let dailyCustomers = 0;
                
                Object.keys(day.sales).forEach(label => {
                    const hour = parseInt(label.replace('æ™‚', ''));
                    if (isHourInRange(hour, startHour, endHour)) {
                        dailySales += day.sales[label] || 0;
                        dailyCustomers += day.customers[label] || 0;
                    }
                });
                
                let dayEntry = totalsMap.get(day.date);
                if (!dayEntry) {
                    dayEntry = { date: day.date, dayOfWeek: day.dayOfWeek, totalSales: 0, totalCustomers: 0 };
                    totalsMap.set(day.date, dayEntry);
                }
                
                dayEntry.totalSales += dailySales;
                dayEntry.totalCustomers += dailyCustomers;
            });
            
            return Array.from(totalsMap.values());
        }
        
        function isHourInRange(hour, start, end) {
            const current = (hour === 0) ? 24 : hour;
            const s = (start === 0) ? 24 : start;
            const e = (end === 0) ? 24 : end;
            
            if (s <= e) {
                return current >= s && current <= e;
            } else { // 6æ™‚ã‹ã‚‰0æ™‚ (ç¿Œæœ) ãªã©ã®å¤œé–“ã‚’ã¾ãŸãå ´åˆ
                return current >= s || current <= e;
            }
        }

        function populateDailySummaryTable(data) {
            const headerRow = elements.dailySummaryTable.querySelector('#table-headers-row');
            const tbody = elements.dailySummaryTable.querySelector('tbody');
            
            headerRow.innerHTML = `
                <th>æ—¥ä»˜</th>
                <th>æ›œæ—¥</th>
                <th colspan="2">é›†è¨ˆç¯„å›²1 (${data.range1})</th>
                <th colspan="2">é›†è¨ˆç¯„å›²2 (${data.range2})</th>
            `;
            
            tbody.innerHTML = `
                <tr>
                    <td></td>
                    <td></td>
                    <th>å£²ä¸Šé«˜</th>
                    <th>å®¢æ•°</th>
                    <th>å£²ä¸Šé«˜</th>
                    <th>å®¢æ•°</th>
                </tr>
            `;

            const combinedData = new Map();
            data.totals1.forEach(item => combinedData.set(item.date, { ...item, totalSales: item.totalSales, totalCustomers: item.totalCustomers }));
            data.totals2.forEach(item => {
                const entry = combinedData.get(item.date);
                if (entry) {
                    entry.totalSales2 = item.totalSales;
                    entry.totalCustomers2 = item.totalCustomers;
                } else {
                    combinedData.set(item.date, {
                        date: item.date,
                        dayOfWeek: item.dayOfWeek,
                        totalSales: 0,
                        totalCustomers: 0,
                        totalSales2: item.totalSales,
                        totalCustomers2: item.totalCustomers
                    });
                }
            });

            const sortedData = Array.from(combinedData.values())
                .sort((a, b) => new Date(a.date.replace(/å¹´|æœˆ|æ—¥/g, '/')) - new Date(b.date.replace(/å¹´|æœˆ|æ—¥/g, '/')));

            sortedData.forEach(day => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${day.date}</td>
                    <td>${day.dayOfWeek}</td>
                    <td>Â¥${(day.totalSales || 0).toLocaleString()}</td>
                    <td>${Math.round(day.totalCustomers || 0).toLocaleString()}äºº</td>
                    <td>Â¥${(day.totalSales2 || 0).toLocaleString()}</td>
                    <td>${Math.round(day.totalCustomers2 || 0).toLocaleString()}äºº</td>
                `;
            });
            
            elements.dailySummaryTable.classList.remove('hidden');
        }

        function exportDataToExcel() {
            if (Object.keys(lastCalculatedTotals).length === 0) {
                showAlert('warning', 'å…ˆã«é›†è¨ˆç¯„å›²ã‚’è¨­å®šã—ã€ã€Œè¨ˆç®—ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚');
                return;
            }

            const tbody = elements.dailySummaryTable.querySelector('tbody');
            const dataToExport = Array.from(tbody.rows).slice(1).map(row => ({
                'æ—¥ä»˜': row.cells[0].textContent,
                'æ›œæ—¥': row.cells[1].textContent,
                [`é›†è¨ˆç¯„å›²1 å£²ä¸Šé«˜ (${lastCalculatedTotals.range1})`]: parseNumber(row.cells[2].textContent),
                [`é›†è¨ˆç¯„å›²1 å®¢æ•° (${lastCalculatedTotals.range1})`]: parseNumber(row.cells[3].textContent),
                [`é›†è¨ˆç¯„å›²2 å£²ä¸Šé«˜ (${lastCalculatedTotals.range2})`]: parseNumber(row.cells[4].textContent),
                [`é›†è¨ˆç¯„å›²2 å®¢æ•° (${lastCalculatedTotals.range2})`]: parseNumber(row.cells[5].textContent)
            }));

            const worksheet = XLSX.utils.json_to_sheet(dataToExport);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, 'é›†è¨ˆçµæœ');
            
            const fileName = `å£²ä¸Šé›†è¨ˆãƒ‡ãƒ¼ã‚¿_${new Date().toISOString().slice(0, 10)}.xlsx`;
            XLSX.writeFile(workbook, fileName);
            
            showAlert('success', `ãƒ‡ãƒ¼ã‚¿ãŒ "${fileName}" ã¨ã—ã¦ä¿å­˜ã•ã‚Œã¾ã—ãŸã€‚`);
        }

        // ãƒ‡ãƒ¼ã‚¿æ¤œè¨¼æ©Ÿèƒ½
        function showDataValidation() {
            const results = validateAllData();
            displayValidationResults(results);
            document.getElementById('validation-modal').classList.add('active');
        }

        function validateAllData() {
            const results = {
                totalRecords: allMonthlyData.length,
                missingDates: [],
                invalidSales: [],
                invalidCustomers: [],
                duplicateDates: [],
                summary: {}
            };

            const dateSet = new Set();
            
            allMonthlyData.forEach((day, index) => {
                if (dateSet.has(day.date)) {
                    results.duplicateDates.push(day.date);
                } else {
                    dateSet.add(day.date);
                }

                Object.entries(day.sales).forEach(([time, value]) => {
                    if (typeof value !== 'number' || isNaN(value) || value < 0) {
                        results.invalidSales.push(`${day.date} ${time}: ${value}`);
                    }
                });

                Object.entries(day.customers).forEach(([time, value]) => {
                    if (typeof value !== 'number' || isNaN(value) || value < 0) {
                        results.invalidCustomers.push(`${day.date} ${time}: ${value}`);
                    }
                });
            });

            results.summary = {
                isValid: results.invalidSales.length === 0 && 
                        results.invalidCustomers.length === 0 && 
                        results.duplicateDates.length === 0,
                totalIssues: results.invalidSales.length + 
                           results.invalidCustomers.length + 
                           results.duplicateDates.length
            };

            return results;
        }

        function displayValidationResults(results) {
            const container = document.getElementById('validation-results');
            
            let html = `
                <div class="alert ${results.summary.isValid ? 'success' : 'warning'}">
                    <h3>${results.summary.isValid ? 'âœ… ãƒ‡ãƒ¼ã‚¿ã¯æ­£å¸¸ã§ã™' : 'âš ï¸ ãƒ‡ãƒ¼ã‚¿ã«å•é¡ŒãŒã‚ã‚Šã¾ã™'}</h3>
                    <p>ç·ãƒ¬ã‚³ãƒ¼ãƒ‰æ•°: ${results.totalRecords}</p>
                    <p>å•é¡Œã®ç·æ•°: ${results.summary.totalIssues}</p>
                </div>
            `;

            if (results.duplicateDates.length > 0) {
                html += `
                    <div class="alert error">
                        <h4>ğŸ”„ é‡è¤‡ã™ã‚‹æ—¥ä»˜ (${results.duplicateDates.length}ä»¶)</h4>
                        <ul>
                            ${results.duplicateDates.slice(0, 10).map(date => `<li>${date}</li>`).join('')}
                        </ul>
                        ${results.duplicateDates.length > 10 ? '<p>...ä»–ã«ã‚‚ã‚ã‚Šã¾ã™</p>' : ''}
                    </div>
                `;
            }

            if (results.invalidSales.length > 0) {
                html += `
                    <div class="alert error">
                        <h4>ğŸ’° ç„¡åŠ¹ãªå£²ä¸Šãƒ‡ãƒ¼ã‚¿ (${results.invalidSales.length}ä»¶)</h4>
                        <ul>
                            ${results.invalidSales.slice(0, 10).map(item => `<li>${item}</li>`).join('')}
                        </ul>
                        ${results.invalidSales.length > 10 ? '<p>...ä»–ã«ã‚‚ã‚ã‚Šã¾ã™</p>' : ''}
                    </div>
                `;
            }

            if (results.invalidCustomers.length > 0) {
                html += `
                    <div class="alert error">
                        <h4>ğŸ‘¥ ç„¡åŠ¹ãªå®¢æ•°ãƒ‡ãƒ¼ã‚¿ (${results.invalidCustomers.length}ä»¶)</h4>
                        <ul>
                            ${results.invalidCustomers.slice(0, 10).map(item => `<li>${item}</li>`).join('')}
                        </ul>
                        ${results.invalidCustomers.length > 10 ? '<p>...ä»–ã«ã‚‚ã‚ã‚Šã¾ã™</p>' : ''}
                    </div>
                `;
            }

            container.innerHTML = html;
        }

        // ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†
        function saveSession() {
            if (allMonthlyData.length === 0) {
                showAlert('warning', 'ä¿å­˜ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚');
                return;
            }

            try {
                const dataToSave = {
                    allMonthlyData,
                    timeLabels,
                    monthOrder,
                    savedAt: new Date().toISOString(),
                    version: '2.1'
                };
                
                const json = JSON.stringify(dataToSave, null, 2);
                const blob = new Blob([json], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = `å£²ä¸Šåˆ†æã‚»ãƒƒã‚·ãƒ§ãƒ³_${new Date().toISOString().slice(0, 10)}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showAlert('success', 'ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒJSONãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦ä¿å­˜ã•ã‚Œã¾ã—ãŸã€‚');
            } catch (error) {
                showAlert('error', 'ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
                console.error(error);
            }
        }

        function clearAllData() {
            if (!confirm('ã™ã¹ã¦ã®èª­ã¿è¾¼ã¿æ¸ˆã¿ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚')) {
                return;
            }

            allMonthlyData = [];
            timeLabels = [];
            selectedMonths.clear();
            lastCalculatedTotals = {};
            monthOrder = [];
            
            populateMonthlyList();
            clearMainContentUI();
            
            showAlert('success', 'ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ãŒã‚¯ãƒªã‚¢ã•ã‚Œã¾ã—ãŸã€‚');
        }

        // UI ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
        function clearMainContentUI() {
            if (mainChart) mainChart.destroy();
            elements.dailySummaryTable.classList.add('hidden');
            elements.mainContent.classList.add('hidden');
            elements.dragDropArea.classList.remove('hidden');
            
            document.getElementById('total-sales-sum').textContent = 'Â¥0';
            document.getElementById('total-customers-sum').textContent = '0 äºº';
            document.getElementById('avg-customer-spend').textContent = 'Â¥0';
            document.getElementById('analysis-period').textContent = '0 æ—¥';
            
            elements.loadedDataCount.textContent = '0';
            elements.monthlyDataList.innerHTML = '';
        }

        function getSelectedDays() {
            return Array.from(document.querySelectorAll('input[name="day-filter"]:checked'))
                .map(checkbox => checkbox.value);
        }

        function filterDataAndRefreshDashboard() {
            updateDashboard();
            showAlert('info', 'ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãŒé©ç”¨ã•ã‚Œã¾ã—ãŸã€‚');
        }

        function populateHourSelects(labels) {
            const selects = [
                elements.startHourSelect1, elements.endHourSelect1,
                elements.startHourSelect2, elements.endHourSelect2
            ];
            
            selects.forEach(select => {
                select.innerHTML = '';
                labels.forEach(label => {
                    const value = parseInt(label.replace('æ™‚', ''));
                    const option = document.createElement('option');
                    option.value = value;
                    option.textContent = label;
                    select.appendChild(option);
                });
            });
            
            elements.startHourSelect1.value = 10;
            elements.endHourSelect1.value = 15;
            elements.startHourSelect2.value = 6;
            elements.endHourSelect2.value = 0;
        }

        // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
        function parseNumber(value) {
            if (typeof value === 'number') return value;
            if (typeof value === 'string') {
                const parsed = parseFloat(value.replace(/[^0-9.-]+/g, ""));
                return isNaN(parsed) ? 0 : parsed;
            }
            return 0;
        }

        function parseDate(excelDate) {
            if (typeof excelDate === 'number') {
                const date = new Date(Math.round((excelDate - 25569) * 86400 * 1000));
                return `${date.getFullYear()}å¹´${date.getMonth() + 1}æœˆ${date.getDate()}æ—¥`;
            }
            if (typeof excelDate === 'string') {
                try {
                    const date = new Date(excelDate);
                    if (!isNaN(date)) {
                        return `${date.getFullYear()}å¹´${date.getMonth() + 1}æœˆ${date.getDate()}æ—¥`;
                    }
                } catch(e) {}
            }
            return excelDate;
        }

        function parseMonth(excelDate) {
            let date;
            if (typeof excelDate === 'number') {
                date = new Date(Math.round((excelDate - 25569) * 86400 * 1000));
            } else if (typeof excelDate === 'string') {
                try {
                     date = new Date(excelDate.replace(/å¹´|æœˆ|æ—¥/g, '/'));
                     if (isNaN(date)) return 'ä¸æ˜ãªæœˆ';
                } catch (e) { return 'ä¸æ˜ãªæœˆ'; }
            } else {
                return 'ä¸æ˜ãªæœˆ';
            }
            return `${date.getFullYear()}å¹´${date.getMonth() + 1}æœˆ`;
        }

        function updateProgress(percent) {
            elements.uploadProgress.style.width = `${percent}%`;
        }

        function showAlert(type, message) {
            const alert = document.createElement('div');
            alert.className = `alert ${type}`;
            alert.textContent = message;
            
            elements.alertsContainer.appendChild(alert);
            
            setTimeout(() => {
                alert.style.opacity = '0';
                setTimeout(() => {
                    if (alert.parentNode) {
                        alert.parentNode.removeChild(alert);
                    }
                }, 300);
            }, 5000);
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        function toggleTheme() {
            const body = document.body;
            const currentTheme = body.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            
            body.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            
            showAlert('info', `${newTheme === 'dark' ? 'ãƒ€ãƒ¼ã‚¯' : 'ãƒ©ã‚¤ãƒˆ'}ãƒ†ãƒ¼ãƒã«åˆ‡ã‚Šæ›¿ãˆã¾ã—ãŸã€‚`);
        }

        // åˆæœŸåŒ–
        function init() {
            initializeEventListeners();
            
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme) {
                document.body.setAttribute('data-theme', savedTheme);
            }
            
            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.classList.remove('active');
                    }
                });
            });
        }

        // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
