<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>入出金伝票システム（完全コード）</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    #controlPanel, #searchPanel, #actionPanel {
      margin-bottom: 10px; padding: 10px; border: 1px solid #ccc;
      border-radius: 5px;
    }
    #controlPanel input, #controlPanel select, #controlPanel button {
      margin-right: 10px; font-size: 14px;
    }
    #voucherCard { margin-bottom: 20px; }
    #summaryPanel div { margin: 5px 0; }
    table { border-collapse: collapse; width: 100%; margin-top: 10px; }
    th, td { border: 1px solid #aaa; padding: 5px; text-align: center; }
    input[type="text"], input[type="number"] { width: 90%; }
    @media print {
      #controlPanel, #searchPanel, #actionPanel, #settingsPanel { display: none; }
    }
    /* 設定パネル */
    #settingsPanel {
      border: 1px solid #aaa; padding: 10px; margin-top: 10px;
      background-color: #f9f9f9; width: 300px;
    }
  </style>
</head>
<body>

  <!-- 操作エリア -->
  <div id="controlPanel">
    <label for="monthSelector">対象月：</label>
    <input type="month" id="monthSelector">
    
    <label for="daySelector">書き込む日：</label>
    <select id="daySelector"></select>
    
    <button id="prevDayBtn">前日</button>
    <button id="nextDayBtn">翌日</button>
    <button id="settingsBtn">設定</button>
  </div>

  <!-- 設定パネル（固定摘要同期設定） -->
  <div id="settingsPanel" style="display:none;">
    <h3>固定摘要同期設定</h3>
    <form id="syncForm">
      <div>
        <label><input type="checkbox" name="syncRow" value="1"> 行1</label>
        <label><input type="checkbox" name="syncRow" value="2"> 行2</label>
        <label><input type="checkbox" name="syncRow" value="3"> 行3</label>
        <label><input type="checkbox" name="syncRow" value="4"> 行4</label>
        <label><input type="checkbox" name="syncRow" value="5"> 行5</label>
      </div>
      <div>
        <label><input type="checkbox" name="syncRow" value="6"> 行6</label>
        <label><input type="checkbox" name="syncRow" value="7"> 行7</label>
        <label><input type="checkbox" name="syncRow" value="8"> 行8</label>
        <label><input type="checkbox" name="syncRow" value="9"> 行9</label>
        <label><input type="checkbox" name="syncRow" value="10"> 行10</label>
      </div>
      <br>
      <button type="button" id="closeSettingsBtn">閉じる</button>
    </form>
  </div>

  <!-- 伝票カード -->
  <div id="voucherCard">
    <h2 id="voucherHeader">伝票: </h2>
    <!-- サマリーパネル -->
    <div id="summaryPanel">
      <div id="prevBalanceContainer">前日残高: <span id="prevBalanceField"></span></div>
      <div>本日入金: <span id="depositTotal"></span></div>
      <div>本日出金: <span id="withdrawalTotal"></span></div>
      <div>本日残高: <span id="balance"></span></div>
    </div>
    <!-- 明細テーブル -->
    <table id="voucherDetails">
      <thead>
        <tr>
          <th>No.</th>
          <th>入金科目</th>
          <th>入金金額</th>
          <th>摘要</th>
          <th>出金金額</th>
          <th>出金科目</th>
        </tr>
      </thead>
      <tbody>
        <!-- 明細行は JavaScript で生成 -->
      </tbody>
    </table>
  </div>

  <!-- 検索エリア -->
  <div id="searchPanel">
    <label for="searchKeyword">検索キーワード：</label>
    <input type="text" id="searchKeyword" placeholder="キーワード入力">
    <button id="searchBtn">検索</button>
    <button id="clearSearchBtn">検索クリア</button>
    <div id="searchResults" style="margin-top: 10px;"></div>
  </div>

  <!-- その他の操作エリア -->
  <div id="actionPanel">
    <button id="excelSaveBtn">Excel保存</button>
    <input type="file" id="excelLoadInput" style="display:none;">
    <button id="excelLoadBtn">Excel読み込み</button>
    <button id="jsonSaveBtn">JSON保存</button>
    <input type="file" id="jsonLoadInput" style="display:none;">
    <button id="jsonLoadBtn">JSON読み込み</button>
    <button id="printBtn">印刷</button>
  </div>

  <script>
    /**********************************************
     * グローバル変数・データ構造
     **********************************************/
    // voucherData：すべての月・日付の伝票情報 "YYYY-MM-DD" をキーに保持
    let voucherData = {};
    // 固定摘要同期：各行（インデックス0～9）の対象フラグ
    let syncRows = Array(10).fill(false);
    // 現在表示中の伝票日付
    let currentVoucherDate = "";
    
    /**********************************************
     * 初期化・データ読み込み処理
     **********************************************/
    function initMonth() {
      // localStorage に保存済みデータがあれば読み込み
      const stored = localStorage.getItem("voucherData");
      if (stored) {
        try {
          voucherData = JSON.parse(stored);
        } catch(e) { voucherData = {}; }
      }
      const monthSelector = document.getElementById("monthSelector");
      const now = new Date();
      const monthValue = now.toISOString().slice(0, 7); // "YYYY-MM"
      monthSelector.value = monthValue;
      ensureVoucherDataForMonth(monthValue);
      populateDaySelector(monthValue);
      currentVoucherDate = monthValue + "-01";
      loadVoucher(currentVoucherDate);
    }
    
    // 対象月（YYYY-MM）の各日付データがなければ生成
    function ensureVoucherDataForMonth(month) {
      const [year, monthNum] = month.split("-");
      const days = new Date(year, monthNum, 0).getDate();
      for (let d = 1; d <= days; d++) {
        const dayStr = String(d).padStart(2, '0');
        const dateStr = `${month}-${dayStr}`;
        if (!voucherData[dateStr]) {
          voucherData[dateStr] = {
            date: dateStr,
            prevBalance: 0,
            deposit: 0,
            withdrawal: 0,
            balance: 0,
            details: []
          };
          for (let i = 0; i < 10; i++) {
            voucherData[dateStr].details.push({
              no: i + 1,
              depositCategory: "",
              depositAmount: 0,
              description: "",
              withdrawalAmount: 0,
              withdrawalCategory: ""
            });
          }
        }
      }
    }
    
    // 日付セレクトボックスの生成
    function populateDaySelector(month) {
      const daySelector = document.getElementById("daySelector");
      daySelector.innerHTML = "";
      const [year, monthNum] = month.split("-");
      const days = new Date(year, monthNum, 0).getDate();
      for (let d = 1; d <= days; d++) {
        const dayStr = String(d).padStart(2, '0');
        const dateStr = `${month}-${dayStr}`;
        const option = document.createElement("option");
        option.value = dateStr;
        option.textContent = dateStr;
        daySelector.appendChild(option);
      }
      daySelector.value = month + "-01";
    }
    
    /**********************************************
     * 自動保存（localStorage への保存）
     **********************************************/
    function autoSaveVoucherData() {
      localStorage.setItem("voucherData", JSON.stringify(voucherData));
    }
    
    /**********************************************
     * 集計処理（全体再計算）
     **********************************************/
    function recalcMonth() {
      // voucherData のキー順（日付順）に並べた伝票データを順次再計算
      const dates = Object.keys(voucherData).sort();
      for (let i = 0; i < dates.length; i++) {
        if (i > 0) {
          voucherData[dates[i]].prevBalance = voucherData[dates[i-1]].balance;
        }
        recalcVoucher(dates[i]);
      }
      loadVoucher(currentVoucherDate);
    }
    
    // 指定日の再計算（明細の合計から計算）
    function recalcVoucher(date) {
      const voucher = voucherData[date];
      if (!voucher) return;
      let totalDep = 0, totalWithdraw = 0;
      voucher.details.forEach(row => {
        totalDep += parseFloat(row.depositAmount) || 0;
        totalWithdraw += parseFloat(row.withdrawalAmount) || 0;
      });
      voucher.deposit = totalDep;
      voucher.withdrawal = totalWithdraw;
      voucher.balance = voucher.prevBalance + totalDep - totalWithdraw;
    }
    
    /**********************************************
     * 固定摘要同期（マスター（1日）の値から他の日へ）
     **********************************************/
    function updateSyncDescription(rowIndex, value) {
      Object.keys(voucherData).forEach(date => {
        if (date !== (document.getElementById("monthSelector").value + "-01")) {
          voucherData[date].details[rowIndex].description = value;
          if (date === currentVoucherDate) loadVoucher(date);
        }
      });
    }
    
    /**********************************************
     * 伝票表示・入力
     **********************************************/
    function loadVoucher(date) {
      const voucher = voucherData[date];
      if (!voucher) return;
      document.getElementById("voucherHeader").textContent = `伝票: ${date}`;
      
      // サマリーパネル更新（1日の場合は前日残高を入力欄にする）
      const prevBalanceContainer = document.getElementById("prevBalanceContainer");
      prevBalanceContainer.innerHTML = "前日残高: ";
      if (date.endsWith("-01")) {
        const inputPrev = document.createElement("input");
        inputPrev.type = "number";
        inputPrev.value = voucher.prevBalance === 0 ? "" : voucher.prevBalance;
        inputPrev.addEventListener("change", (e) => {
          voucher.prevBalance = parseFloat(e.target.value) || 0;
          recalcMonth();
        });
        prevBalanceContainer.appendChild(inputPrev);
      } else {
        const spanPrev = document.createElement("span");
        spanPrev.textContent = voucher.prevBalance;
        prevBalanceContainer.appendChild(spanPrev);
      }
      document.getElementById("depositTotal").textContent = voucher.deposit;
      document.getElementById("withdrawalTotal").textContent = voucher.withdrawal;
      document.getElementById("balance").textContent = voucher.balance;
      
      // 明細テーブル再生成
      const tbody = document.querySelector("#voucherDetails tbody");
      tbody.innerHTML = "";
      voucher.details.forEach((row, rowIndex) => {
        const tr = document.createElement("tr");
        tr.dataset.row = rowIndex;
    
        // No.
        const tdNo = document.createElement("td");
        tdNo.textContent = row.no;
        tr.appendChild(tdNo);
    
        // 入金科目
        const tdDepCat = document.createElement("td");
        const inputDepCat = document.createElement("input");
        inputDepCat.type = "text";
        inputDepCat.value = row.depositCategory;
        inputDepCat.dataset.row = rowIndex;
        inputDepCat.dataset.col = "1";
        inputDepCat.addEventListener("change", (e) => {
          row.depositCategory = e.target.value;
        });
        addEnterNavigation(inputDepCat);
        tdDepCat.appendChild(inputDepCat);
        tr.appendChild(tdDepCat);
    
        // 入金金額（0の場合は空欄）
        const tdDepAmt = document.createElement("td");
        const inputDepAmt = document.createElement("input");
        inputDepAmt.type = "number";
        inputDepAmt.value = row.depositAmount === 0 ? "" : row.depositAmount;
        inputDepAmt.dataset.row = rowIndex;
        inputDepAmt.dataset.col = "2";
        inputDepAmt.addEventListener("change", (e) => { 
          row.depositAmount = parseFloat(e.target.value) || 0; 
          recalcMonth();
        });
        addEnterNavigation(inputDepAmt);
        tdDepAmt.appendChild(inputDepAmt);
        tr.appendChild(tdDepAmt);
    
        // 摘要
        const tdDesc = document.createElement("td");
        const inputDesc = document.createElement("input");
        inputDesc.type = "text";
        if (syncRows[rowIndex] && date !== (document.getElementById("monthSelector").value + "-01")) {
          const masterVoucher = voucherData[document.getElementById("monthSelector").value + "-01"];
          inputDesc.value = masterVoucher.details[rowIndex].description;
          row.description = inputDesc.value;
        } else {
          inputDesc.value = row.description;
        }
        inputDesc.dataset.row = rowIndex;
        inputDesc.dataset.col = "3";
        inputDesc.addEventListener("change", (e) => {
          row.description = e.target.value;
          if (date === (document.getElementById("monthSelector").value + "-01") && syncRows[rowIndex]) {
            updateSyncDescription(rowIndex, e.target.value);
          }
        });
        addEnterNavigation(inputDesc);
        tdDesc.appendChild(inputDesc);
        tr.appendChild(tdDesc);
    
        // 出金金額（0の場合は空欄）
        const tdWithdrawAmt = document.createElement("td");
        const inputWithdrawAmt = document.createElement("input");
        inputWithdrawAmt.type = "number";
        inputWithdrawAmt.value = row.withdrawalAmount === 0 ? "" : row.withdrawalAmount;
        inputWithdrawAmt.dataset.row = rowIndex;
        inputWithdrawAmt.dataset.col = "4";
        inputWithdrawAmt.addEventListener("change", (e) => { 
          row.withdrawalAmount = parseFloat(e.target.value) || 0; 
          recalcMonth();
        });
        addEnterNavigation(inputWithdrawAmt);
        tdWithdrawAmt.appendChild(inputWithdrawAmt);
        tr.appendChild(tdWithdrawAmt);
    
        // 出金科目
        const tdWithdrawCat = document.createElement("td");
        const inputWithdrawCat = document.createElement("input");
        inputWithdrawCat.type = "text";
        inputWithdrawCat.value = row.withdrawalCategory;
        inputWithdrawCat.dataset.row = rowIndex;
        inputWithdrawCat.dataset.col = "5";
        inputWithdrawCat.addEventListener("change", (e) => { row.withdrawalCategory = e.target.value; });
        addEnterNavigation(inputWithdrawCat);
        tdWithdrawCat.appendChild(inputWithdrawCat);
        tr.appendChild(tdWithdrawCat);
    
        tbody.appendChild(tr);
      });
    }
    
    // Enterキーで同一列の下の入力欄へ移動するためのイベント付与
    function addEnterNavigation(inputElem) {
      inputElem.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          e.preventDefault();
          const currentRow = parseInt(e.target.dataset.row);
          const currentCol = e.target.dataset.col;
          const nextRow = currentRow + 1;
          const nextRowTr = document.querySelector(`#voucherDetails tbody tr[data-row='${nextRow}']`);
          if (nextRowTr) {
            const nextInput = nextRowTr.querySelector(`input[data-col='${currentCol}']`);
            if (nextInput) nextInput.focus();
          }
        }
      });
    }
    
    /**********************************************
     * CSVパース処理（Excel保存時のフォーマットに合わせる）
     **********************************************/
    function parseCSV(contents) {
      // BOM 除去
      contents = contents.replace(/^\uFEFF/, "");
      // 改行ごとに分割し、余計な空行を除去
      let rows = contents.split(/\r?\n/).filter(row => row.trim() !== "");
      let parsedData = {};
      let i = 1; // 最初の行は全体ヘッダーなのでスキップ
      while (i < rows.length) {
        // サマリー行：最初の5列を想定
        let fields = rows[i].split(",");
        if (fields.length < 5) { i++; continue; }
        let date = fields[0].trim();
        let prevBalance = parseFloat(fields[1]) || 0;
        let deposit = parseFloat(fields[2]) || 0;
        let withdrawal = parseFloat(fields[3]) || 0;
        let balance = parseFloat(fields[4]) || 0;
        let voucher = {
          date: date,
          prevBalance: prevBalance,
          deposit: deposit,
          withdrawal: withdrawal,
          balance: balance,
          details: []
        };
        i++; // 次行は詳細ヘッダー行
        if (i < rows.length && rows[i].indexOf("No.") !== -1) { i++; }
        // 続く10行は明細データ
        for (let d = 0; d < 10 && i < rows.length; d++, i++) {
          let detailFields = rows[i].split(",");
          if (detailFields.length < 6) continue;
          let detail = {
            no: parseInt(detailFields[0]) || (d + 1),
            depositCategory: detailFields[1] ? detailFields[1].trim() : "",
            depositAmount: parseFloat(detailFields[2]) || 0,
            description: detailFields[3] ? detailFields[3].trim() : "",
            withdrawalAmount: parseFloat(detailFields[4]) || 0,
            withdrawalCategory: detailFields[5] ? detailFields[5].trim() : ""
          };
          voucher.details.push(detail);
        }
        parsedData[date] = voucher;
      }
      return parsedData;
    }
    
    /**********************************************
     * ボタン・イベント処理
     **********************************************/
    // 対象月変更時（自動保存＆不足データ生成）
    document.getElementById("monthSelector").addEventListener("change", (e) => {
      autoSaveVoucherData();
      const month = e.target.value;
      ensureVoucherDataForMonth(month);
      populateDaySelector(month);
      currentVoucherDate = month + "-01";
      loadVoucher(currentVoucherDate);
    });
    
    // 書き込み日変更
    document.getElementById("daySelector").addEventListener("change", (e) => {
      currentVoucherDate = e.target.value;
      loadVoucher(currentVoucherDate);
    });
    
    // 前日・翌日ボタン
    document.getElementById("prevDayBtn").addEventListener("click", () => {
      const prevDate = getAdjacentDate(currentVoucherDate, -1);
      if(voucherData[prevDate]){
        currentVoucherDate = prevDate;
        document.getElementById("daySelector").value = prevDate;
        loadVoucher(prevDate);
      }
    });
    document.getElementById("nextDayBtn").addEventListener("click", () => {
      const nextDate = getAdjacentDate(currentVoucherDate, 1);
      if(voucherData[nextDate]){
        currentVoucherDate = nextDate;
        document.getElementById("daySelector").value = nextDate;
        loadVoucher(nextDate);
      }
    });
    function getAdjacentDate(dateStr, delta) {
      const date = new Date(dateStr);
      date.setDate(date.getDate() + delta);
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }
    
    // 設定パネル表示／非表示
    document.getElementById("settingsBtn").addEventListener("click", () => {
      const panel = document.getElementById("settingsPanel");
      panel.style.display = (panel.style.display === "none" || panel.style.display === "") ? "block" : "none";
    });
    document.getElementById("closeSettingsBtn").addEventListener("click", () => {
      document.getElementById("settingsPanel").style.display = "none";
    });
    document.querySelectorAll("#syncForm input[type=checkbox]").forEach(checkbox => {
      checkbox.addEventListener("change", (e) => {
        const row = parseInt(e.target.value, 10) - 1;
        syncRows[row] = e.target.checked;
        const masterDate = document.getElementById("monthSelector").value + "-01";
        if(syncRows[row] && voucherData[masterDate]){
          voucherData[currentVoucherDate].details[row].description = voucherData[masterDate].details[row].description;
          loadVoucher(currentVoucherDate);
        }
      });
    });
    
    // 検索機能　※　さらに入金金額・出金金額も文字列に変換して検索対象とする
    document.getElementById("searchBtn").addEventListener("click", () => {
      const keyword = document.getElementById("searchKeyword").value.trim();
      const resultsDiv = document.getElementById("searchResults");
      resultsDiv.innerHTML = "";
      if(keyword === "") return;
      Object.keys(voucherData).forEach(date => {
        const voucher = voucherData[date];
        const found = voucher.details.some(row => {
          return row.depositCategory.includes(keyword) ||
                 String(row.depositAmount).includes(keyword) ||
                 row.description.includes(keyword) ||
                 String(row.withdrawalAmount).includes(keyword) ||
                 row.withdrawalCategory.includes(keyword);
        });
        if(found){
          const link = document.createElement("a");
          link.textContent = date;
          link.href = "#";
          // クリックで伝票へ移動
          link.addEventListener("click", (e) => {
            e.preventDefault();
            currentVoucherDate = date;
            document.getElementById("daySelector").value = date;
            loadVoucher(date);
          });
          resultsDiv.appendChild(link);
          resultsDiv.appendChild(document.createElement("br"));
        }
      });
    });
    document.getElementById("clearSearchBtn").addEventListener("click", () => {
      document.getElementById("searchResults").innerHTML = "";
      document.getElementById("searchKeyword").value = "";
    });
    
    // Excel保存（CSV形式、UTF-8 BOM追加で文字化け防止）
    document.getElementById("excelSaveBtn").addEventListener("click", () => {
      const month = document.getElementById("monthSelector").value;
      let csvData = "\uFEFF";
      csvData += "伝票日付,前日残高,本日入金,本日出金,本日残高\n";
      Object.keys(voucherData).forEach(date => {
        if(date.startsWith(month)){
          const v = voucherData[date];
          csvData += `${date},${v.prevBalance},${v.deposit},${v.withdrawal},${v.balance}\n`;
          csvData += "No.,入金科目,入金金額,摘要,出金金額,出金科目\n";
          v.details.forEach(row => {
            csvData += `${row.no},${row.depositCategory},${row.depositAmount},${row.description},${row.withdrawalAmount},${row.withdrawalCategory}\n`;
          });
        }
      });
      const encodedUri = "data:text/csv;charset=utf-8," + encodeURIComponent(csvData);
      const link = document.createElement("a");
      link.setAttribute("href", encodedUri);
      link.setAttribute("download", `${month}_voucher.csv`);
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    });
    
    // Excel読み込み（CSV形式：ファイルをパースして voucherData にマージ）
    document.getElementById("excelLoadBtn").addEventListener("click", () => {
      document.getElementById("excelLoadInput").click();
    });
    document.getElementById("excelLoadInput").addEventListener("change", (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(event) {
        const contents = event.target.result;
        let loadedData = parseCSV(contents);
        // 読み込んだ各日付情報で上書きマージ
        for (let date in loadedData) {
          voucherData[date] = loadedData[date];
        }
        autoSaveVoucherData();
        const currentMonth = document.getElementById("monthSelector").value;
        populateDaySelector(currentMonth);
        if(voucherData[currentVoucherDate]){
          loadVoucher(currentVoucherDate);
        } else {
          currentVoucherDate = currentMonth + "-01";
          loadVoucher(currentVoucherDate);
        }
        alert("Excel（CSV）読み込みが完了しました。");
      };
      reader.readAsText(file);
    });
    
    // JSON 保存
    document.getElementById("jsonSaveBtn").addEventListener("click", () => {
      const jsonStr = JSON.stringify(voucherData, null, 2);
      const dataUri = "data:application/json;charset=utf-8," + encodeURIComponent(jsonStr);
      const link = document.createElement("a");
      link.setAttribute("href", dataUri);
      link.setAttribute("download", "voucherData.json");
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    });
    
    // JSON 読み込み
    document.getElementById("jsonLoadBtn").addEventListener("click", () => {
      document.getElementById("jsonLoadInput").click();
    });
    document.getElementById("jsonLoadInput").addEventListener("change", (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(event) {
        try {
          const loadedData = JSON.parse(event.target.result);
          voucherData = loadedData;
          autoSaveVoucherData();
          const currentMonth = document.getElementById("monthSelector").value;
          populateDaySelector(currentMonth);
          loadVoucher(currentVoucherDate);
          alert("JSON読み込みが完了しました。");
        } catch(err) {
          alert("読み込みエラー: 正しいJSON形式ではありません");
        }
      };
      reader.readAsText(file);
    });
    
    // 印刷
    document.getElementById("printBtn").addEventListener("click", () => {
      window.print();
    });
    
    // 初期化
    window.addEventListener("load", initMonth);
  </script>

</body>
</html>