<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>入出金伝票システム（完全Excel対応版）</title>
  <script src="https://cdn.jsdelivr.net/npm/exceljs/dist/exceljs.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    #controlPanel, #searchPanel, #actionPanel {
      margin-bottom: 10px; padding: 10px; border: 1px solid #ccc; border-radius: 5px;
    }
    #controlPanel input, #controlPanel select, #controlPanel button,
    #actionPanel button { margin-right: 10px; font-size: 14px; }
    #voucherCard { margin-bottom: 20px; }
    #summaryPanel div { margin: 5px 0; }
    table { border-collapse: collapse; width: 100%; margin-top: 10px; }
    th, td { border: 1px solid #aaa; padding: 5px; text-align: center; }
    input[type="text"], input[type="number"] { width: 90%; box-sizing: border-box; }
    @media print {
      #controlPanel, #searchPanel, #actionPanel, #settingsPanel { display: none; }
    }
    /* 設定パネル */
    #settingsPanel {
      border: 1px solid #aaa; padding: 10px; margin-top: 10px; background-color: #f9f9f9; width: 300px;
    }
    /* 検索結果 */
    .search-result-item {
      margin-bottom: 5px;
      display: flex; align-items: center;
    }
    .search-result-item a { margin-right: 10px; }
    .deleteResultBtn {
      margin-left: auto; font-size: 0.9em; color: #fff; background-color: #d9534f;
      border: none; padding: 2px 6px; cursor: pointer; border-radius: 3px;
    }
    .disabled-input { background-color: #f0f0f0; cursor: not-allowed; }
  </style>
</head>
<body>

  <div id="controlPanel">
    <label for="monthSelector">対象月：</label>
    <input type="month" id="monthSelector">
    <label for="daySelector">書き込む日：</label>
    <select id="daySelector"></select>
    <button id="prevDayBtn">前日</button>
    <button id="nextDayBtn">翌日</button>
    <button id="settingsBtn">設定</button>
  </div>

  <div id="settingsPanel" style="display:none;">
    <h3>固定摘要同期設定</h3>
    <p><small>選択された行の摘要は、毎月1日の摘要と同期されます。</small></p>
    <form id="syncForm">
      <div>
        <label><input type="checkbox" name="syncRow" value="0"> 行1</label>
        <label><input type="checkbox" name="syncRow" value="1"> 行2</label>
        <label><input type="checkbox" name="syncRow" value="2"> 行3</label>
        <label><input type="checkbox" name="syncRow" value="3"> 行4</label>
        <label><input type="checkbox" name="syncRow" value="4"> 行5</label>
      </div>
      <div>
        <label><input type="checkbox" name="syncRow" value="5"> 行6</label>
        <label><input type="checkbox" name="syncRow" value="6"> 行7</label>
        <label><input type="checkbox" name="syncRow" value="7"> 行8</label>
        <label><input type="checkbox" name="syncRow" value="8"> 行9</label>
        <label><input type="checkbox" name="syncRow" value="9"> 行10</label>
      </div>
    </form>
    <br>
    <button type="button" id="deleteAllDataBtn">全データ削除</button>
    <button type="button" id="closeSettingsBtn">閉じる</button>
  </div>

  <div id="voucherCard">
    <h2 id="voucherHeader">伝票: </h2>
    <div id="summaryPanel">
      <div id="prevBalanceContainer">前日残高: <span id="prevBalanceField"></span></div>
      <div>本日入金: <span id="depositTotal"></span></div>
      <div>本日出金: <span id="withdrawalTotal"></span></div>
      <div>本日残高: <span id="balance"></span></div>
    </div>
    <table id="voucherDetails">
      <thead>
        <tr>
          <th>No.</th>
          <th>入金科目</th>
          <th>入金金額</th>
          <th>摘要</th>
          <th>出金金額</th>
          <th>出金科目</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div id="searchPanel">
    <label for="searchKeyword">検索キーワード：</label>
    <input type="text" id="searchKeyword" placeholder="キーワード入力">
    <button id="searchBtn">検索</button>
    <button id="clearSearchBtn">検索クリア</button>
    <div id="searchResults" style="margin-top: 10px;"></div>
  </div>

  <div id="actionPanel">
    <button id="excelSaveBtn">Excel保存 (.xlsx)</button>
    <input type="file" id="excelLoadInput" accept=".xlsx" style="display:none;">
    <button id="excelLoadBtn">Excel読み込み (.xlsx)</button>
    
    <button id="jsonSaveBtn">JSON保存</button>
    <input type="file" id="jsonLoadInput" accept=".json" style="display:none;">
    <button id="jsonLoadBtn">JSON読み込み</button>
    
    <button id="printBtn">印刷</button>
  </div>

  <script>
    /**********************************************
     * グローバル変数・データ構造
     **********************************************/
    let voucherData = {};
    let syncRows = Array(10).fill(false);
    let currentVoucherDate = "";

    /**********************************************
     * 初期化・データ読み込み処理
     **********************************************/
    function initApp() {
      const storedVoucherData = localStorage.getItem("voucherData");
      if (storedVoucherData) {
        try { voucherData = JSON.parse(storedVoucherData); } catch(e) { voucherData = {}; console.error(e); }
      }
      const storedSyncRows = localStorage.getItem("syncRows");
      if (storedSyncRows) {
        try { syncRows = JSON.parse(storedSyncRows); } catch(e) { syncRows = Array(10).fill(false); console.error(e); }
      }

      document.querySelectorAll("#syncForm input[type=checkbox]").forEach((chk, index) => {
        chk.checked = syncRows[index];
      });

      const monthSelector = document.getElementById("monthSelector");
      const now = new Date();
      const monthValue = now.toISOString().slice(0, 7);
      monthSelector.value = monthValue;

      ensureVoucherDataForMonth(monthValue);
      populateDaySelector(monthValue);

      currentVoucherDate = monthValue + "-01";
      document.getElementById("daySelector").value = currentVoucherDate;
      loadVoucher(currentVoucherDate);
      recalcMonth();
    }

    function ensureVoucherDataForMonth(month) {
      const [year, monthNum] = month.split("-");
      const daysInMonth = new Date(parseInt(year), parseInt(monthNum), 0).getDate();

      for (let d = 1; d <= daysInMonth; d++) {
        const dayStr = String(d).padStart(2, "0");
        const dateStr = `${month}-${dayStr}`;

        if (!voucherData[dateStr]) {
          voucherData[dateStr] = {
            date: dateStr,
            prevBalance: 0,
            deposit: 0,
            withdrawal: 0,
            balance: 0,
            details: []
          };
          for (let i = 0; i < 10; i++) {
            voucherData[dateStr].details.push({
              no: i + 1,
              depositCategory: "",
              depositAmount: 0,
              description: "",
              withdrawalAmount: 0,
              withdrawalCategory: ""
            });
          }
        }
      }
      autoSaveVoucherData();
    }

    function populateDaySelector(month) {
      const selector = document.getElementById("daySelector");
      selector.innerHTML = "";
      const [year, monthNum] = month.split("-");
      const daysInMonth = new Date(parseInt(year), parseInt(monthNum), 0).getDate();

      for (let d = 1; d <= daysInMonth; d++) {
        const dayStr = String(d).padStart(2, "0");
        const date = `${month}-${dayStr}`;
        const option = document.createElement("option");
        option.value = date;
        option.textContent = date;
        selector.appendChild(option);
      }
      if (!selector.querySelector(`option[value="${currentVoucherDate}"]`)) {
        currentVoucherDate = month + "-01";
      }
      selector.value = currentVoucherDate;
    }

    function autoSaveVoucherData() {
      localStorage.setItem("voucherData", JSON.stringify(voucherData));
      localStorage.setItem("syncRows", JSON.stringify(syncRows));
    }

    /**********************************************
     * 集計処理
     **********************************************/
    function recalcMonth() {
      const dates = Object.keys(voucherData).sort();
      
      for (let i = 0; i < dates.length; i++) {
        const currentDate = dates[i];
        const voucher = voucherData[currentDate];
        if (!voucher) continue;

        if (i > 0) {
          voucher.prevBalance = voucherData[dates[i-1]].balance;
        }
        recalcVoucher(currentDate);
      }
      loadVoucher(currentVoucherDate);
      autoSaveVoucherData();
    }

    function recalcVoucher(date) {
      const voucher = voucherData[date];
      if (!voucher) return;
      let totalDep = 0, totalWithdraw = 0;

      voucher.details.forEach(row => {
        totalDep += parseFloat(row.depositAmount) || 0;
        totalWithdraw += parseFloat(row.withdrawalAmount) || 0;
      });

      voucher.deposit = totalDep;
      voucher.withdrawal = totalWithdraw;
      voucher.balance = voucher.prevBalance + totalDep - totalWithdraw;
    }

    /**********************************************
     * 固定摘要同期
     **********************************************/
    function syncDescription(rowIndex) {
      const currentMonth = document.getElementById("monthSelector").value;
      const masterDate = `${currentMonth}-01`;
      if (!voucherData[masterDate]) return;
      const masterDescription = voucherData[masterDate].details[rowIndex].description;

      Object.keys(voucherData).forEach(date => {
        if (date.startsWith(currentMonth)) {
          voucherData[date].details[rowIndex].description = masterDescription;
        }
      });
      loadVoucher(currentVoucherDate);
      autoSaveVoucherData();
    }

    /**********************************************
     * 伝票表示・入力
     **********************************************/
    function loadVoucher(date) {
      const voucher = voucherData[date];
      if (!voucher) {
         // データがない場合のフォールバック処理は省略（初期化で生成されるため）
         return;
      }

      document.getElementById("voucherHeader").textContent = `伝票: ${date}`;
      const prevBalanceContainer = document.getElementById("prevBalanceContainer");
      prevBalanceContainer.innerHTML = "前日残高: ";
      
      if (date.endsWith("-01")) {
        const input = document.createElement("input");
        input.type = "number";
        input.value = voucher.prevBalance === 0 ? "" : voucher.prevBalance;
        input.addEventListener("change", e => {
          voucher.prevBalance = parseFloat(e.target.value) || 0;
          recalcMonth();
        });
        prevBalanceContainer.appendChild(input);
      } else {
        const span = document.createElement("span");
        span.textContent = voucher.prevBalance.toLocaleString();
        prevBalanceContainer.appendChild(span);
      }

      document.getElementById("depositTotal").textContent = voucher.deposit.toLocaleString();
      document.getElementById("withdrawalTotal").textContent = voucher.withdrawal.toLocaleString();
      document.getElementById("balance").textContent = voucher.balance.toLocaleString();

      const tbody = document.querySelector("#voucherDetails tbody");
      tbody.innerHTML = "";
      const currentMonth = document.getElementById("monthSelector").value;
      const isFirstDayOfMonth = date.endsWith("-01");

      voucher.details.forEach((row, index) => {
        const tr = document.createElement("tr");
        tr.dataset.row = index;

        // No.
        const tdNo = document.createElement("td");
        tdNo.textContent = row.no;
        tr.appendChild(tdNo);

        // 入金科目
        createCell(tr, "text", row.depositCategory, index, "1", val => row.depositCategory = val);
        // 入金金額
        createCell(tr, "number", row.depositAmount, index, "2", val => {
          row.depositAmount = parseFloat(val) || 0;
          recalcVoucher(date); loadVoucher(date); autoSaveVoucherData();
        });

        // 摘要
        const tdDesc = document.createElement("td");
        const inputDesc = document.createElement("input");
        inputDesc.type = "text";
        inputDesc.dataset.row = index;
        inputDesc.dataset.col = "3";
        if (syncRows[index]) {
          const masterVoucher = voucherData[`${currentMonth}-01`];
          if (masterVoucher) {
            inputDesc.value = masterVoucher.details[index].description;
            row.description = masterVoucher.details[index].description;
          }
          if (!isFirstDayOfMonth) {
            inputDesc.readOnly = true;
            inputDesc.classList.add("disabled-input");
          }
        } else {
          inputDesc.value = row.description;
        }
        inputDesc.addEventListener("change", e => {
          row.description = e.target.value;
          autoSaveVoucherData();
          if (isFirstDayOfMonth && syncRows[index]) syncDescription(index);
        });
        addEnterNavigation(inputDesc);
        tdDesc.appendChild(inputDesc);
        tr.appendChild(tdDesc);

        // 出金金額
        createCell(tr, "number", row.withdrawalAmount, index, "4", val => {
          row.withdrawalAmount = parseFloat(val) || 0;
          recalcVoucher(date); loadVoucher(date); autoSaveVoucherData();
        });
        // 出金科目
        createCell(tr, "text", row.withdrawalCategory, index, "5", val => row.withdrawalCategory = val);

        tbody.appendChild(tr);
      });
    }

    function createCell(tr, type, value, rowIndex, colIndex, callback) {
      const td = document.createElement("td");
      const input = document.createElement("input");
      input.type = type;
      input.value = (value === 0 && type === "number") ? "" : value;
      input.dataset.row = rowIndex;
      input.dataset.col = colIndex;
      input.addEventListener("change", e => {
        callback(e.target.value);
        if(type !== "number") autoSaveVoucherData(); // numberはrecalcで保存されるため除外
      });
      addEnterNavigation(input);
      td.appendChild(input);
      tr.appendChild(td);
    }

    function addEnterNavigation(inputElem) {
      inputElem.addEventListener("keydown", e => {
        if (e.key === "Enter") {
          e.preventDefault();
          const currentRow = parseInt(e.target.dataset.row);
          const currentCol = e.target.dataset.col;
          const nextRow = currentRow + 1;
          const nextInput = document.querySelector(`#voucherDetails tbody tr[data-row='${nextRow}'] input[data-col='${currentCol}']`);
          if (nextInput) nextInput.focus();
        }
      });
    }

    /**********************************************
     * ボタン・イベント処理
     **********************************************/
    document.getElementById("monthSelector").addEventListener("change", e => {
      autoSaveVoucherData();
      const month = e.target.value;
      ensureVoucherDataForMonth(month);
      populateDaySelector(month);
      currentVoucherDate = month + "-01";
      document.getElementById("daySelector").value = currentVoucherDate;
      loadVoucher(currentVoucherDate);
      recalcMonth();
    });

    document.getElementById("daySelector").addEventListener("change", e => {
      currentVoucherDate = e.target.value;
      loadVoucher(currentVoucherDate);
      recalcMonth();
    });

    document.getElementById("prevDayBtn").addEventListener("click", () => {
      moveDay(-1);
    });
    document.getElementById("nextDayBtn").addEventListener("click", () => {
      moveDay(1);
    });

    function moveDay(delta) {
      const date = new Date(currentVoucherDate + "T00:00:00");
      date.setDate(date.getDate() + delta);
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, "0");
      const day = String(date.getDate()).padStart(2, "0");
      const nextDate = `${year}-${month}-${day}`;
      const currentMonth = document.getElementById("monthSelector").value;

      if (voucherData[nextDate] && nextDate.startsWith(currentMonth)) {
        currentVoucherDate = nextDate;
        document.getElementById("daySelector").value = nextDate;
        loadVoucher(nextDate);
      } else {
        alert("これ以上の日付はありません。");
      }
    }

    document.getElementById("settingsBtn").addEventListener("click", () => {
      const panel = document.getElementById("settingsPanel");
      panel.style.display = (panel.style.display === "none" || panel.style.display === "") ? "block" : "none";
    });
    document.getElementById("closeSettingsBtn").addEventListener("click", () => {
      document.getElementById("settingsPanel").style.display = "none";
    });

    document.querySelectorAll("#syncForm input[type=checkbox]").forEach(chk => {
      chk.addEventListener("change", e => {
        const rowIndex = parseInt(e.target.value, 10);
        syncRows[rowIndex] = e.target.checked;
        autoSaveVoucherData();
        if (e.target.checked) {
          syncDescription(rowIndex);
        } else {
          loadVoucher(currentVoucherDate);
        }
      });
    });

    document.getElementById("deleteAllDataBtn").addEventListener("click", function() {
      if (confirm("全ての伝票データを削除しますか？\nこの操作は取り消せません。")) {
        voucherData = {};
        syncRows = Array(10).fill(false);
        localStorage.removeItem("voucherData");
        localStorage.removeItem("syncRows");
        
        const currentMonth = document.getElementById("monthSelector").value;
        ensureVoucherDataForMonth(currentMonth);
        populateDaySelector(currentMonth);
        currentVoucherDate = currentMonth + "-01";
        document.getElementById("daySelector").value = currentVoucherDate;
        loadVoucher(currentVoucherDate);
        
        document.querySelectorAll("#syncForm input[type=checkbox]").forEach(chk => { chk.checked = false; });
        alert("全データが削除されました。");
      }
    });

    // 検索機能
    document.getElementById("searchBtn").addEventListener("click", () => {
      const keyword = document.getElementById("searchKeyword").value.trim().toLowerCase();
      const resultsDiv = document.getElementById("searchResults");
      resultsDiv.innerHTML = "";

      if (keyword === "") { alert("検索キーワードを入力してください。"); return; }

      const sortedDates = Object.keys(voucherData).sort();
      sortedDates.forEach(date => {
        const voucher = voucherData[date];
        let foundInVoucher = false;

        if (String(voucher.prevBalance).includes(keyword) ||
            String(voucher.deposit).includes(keyword) ||
            String(voucher.withdrawal).includes(keyword) ||
            String(voucher.balance).includes(keyword) ||
            voucher.date.includes(keyword)) {
          foundInVoucher = true;
        }

        if (!foundInVoucher) {
          foundInVoucher = voucher.details.some(row => {
            return (row.depositCategory && row.depositCategory.toLowerCase().includes(keyword)) ||
                   String(row.depositAmount).includes(keyword) ||
                   (row.description && row.description.toLowerCase().includes(keyword)) ||
                   String(row.withdrawalAmount).includes(keyword) ||
                   (row.withdrawalCategory && row.withdrawalCategory.toLowerCase().includes(keyword));
          });
        }

        if (foundInVoucher) {
          const itemDiv = document.createElement("div");
          itemDiv.classList.add("search-result-item");
          const link = document.createElement("a");
          link.textContent = date;
          link.href = "#";
          link.addEventListener("click", e => {
            e.preventDefault();
            const selectedMonth = date.slice(0, 7);
            document.getElementById("monthSelector").value = selectedMonth;
            ensureVoucherDataForMonth(selectedMonth);
            populateDaySelector(selectedMonth);
            currentVoucherDate = date;
            document.getElementById("daySelector").value = date;
            loadVoucher(date);
            recalcMonth();
            resultsDiv.innerHTML = "";
            document.getElementById("searchKeyword").value = "";
          });
          itemDiv.appendChild(link);
          
          const delBtn = document.createElement("button");
          delBtn.textContent = "削除";
          delBtn.classList.add("deleteResultBtn");
          delBtn.addEventListener("click", e => {
             e.preventDefault();
             if(confirm(date + " のデータを削除しますか？")) {
                 delete voucherData[date];
                 autoSaveVoucherData();
                 resultsDiv.removeChild(itemDiv);
                 // 必要ならリロード処理など
             }
          });
          itemDiv.appendChild(delBtn);

          resultsDiv.appendChild(itemDiv);
        }
      });
      if (resultsDiv.children.length === 0) resultsDiv.textContent = "検索結果はありません。";
    });

    document.getElementById("clearSearchBtn").addEventListener("click", () => {
      document.getElementById("searchResults").innerHTML = "";
      document.getElementById("searchKeyword").value = "";
    });

    /**********************************************
     * Excel (XLSX) 保存機能 (ExcelJS使用)
     * CSV問題を完全に解決（文字化けなし、""なし、書式付き）
     **********************************************/
    document.getElementById("excelSaveBtn").addEventListener("click", async () => {
      const month = document.getElementById("monthSelector").value;
      const workbook = new ExcelJS.Workbook();
      const sheet = workbook.addWorksheet('入出金伝票');

      // 列幅の設定
      sheet.columns = [
        { width: 8 },  // A: No
        { width: 15 }, // B: 入金科目
        { width: 12 }, // C: 入金金額
        { width: 30 }, // D: 摘要
        { width: 12 }, // E: 出金金額
        { width: 15 }  // F: 出金科目
      ];

      const sortedDatesForMonth = Object.keys(voucherData)
        .filter(date => date.startsWith(month))
        .sort();

      let currentRow = 1;

      for (const date of sortedDatesForMonth) {
        const v = voucherData[date];

        // 伝票ヘッダー部（罫線・背景色つき）
        const headerRow = sheet.getRow(currentRow);
        headerRow.values = ['伝票日付', '前日残高', '本日入金', '本日出金', '本日残高'];
        headerRow.font = { bold: true };
        headerRow.fill = { type: 'pattern', pattern:'solid', fgColor:{argb:'FFF2F2F2'} };
        headerRow.eachCell(cell => {
             cell.border = { top: {style:'thin'}, left: {style:'thin'}, bottom: {style:'thin'}, right: {style:'thin'} };
             cell.alignment = { horizontal: 'center' };
        });
        currentRow++;

        // 伝票サマリーデータ
        const summaryRow = sheet.getRow(currentRow);
        summaryRow.values = [v.date, v.prevBalance, v.deposit, v.withdrawal, v.balance];
        summaryRow.getCell(1).alignment = { horizontal: 'center' };
        // 数値整形
        [2,3,4,5].forEach(c => {
            summaryRow.getCell(c).numFmt = '#,##0';
            summaryRow.getCell(c).alignment = { horizontal: 'right' };
        });
        summaryRow.eachCell(cell => {
             cell.border = { top: {style:'thin'}, left: {style:'thin'}, bottom: {style:'thin'}, right: {style:'thin'} };
        });
        currentRow++;

        // 明細ヘッダー
        const detailHeader = sheet.getRow(currentRow);
        detailHeader.values = ['No.', '入金科目', '入金金額', '摘要', '出金金額', '出金科目'];
        detailHeader.font = { bold: true };
        detailHeader.eachCell(cell => {
             cell.border = { top: {style:'thin'}, left: {style:'thin'}, bottom: {style:'thin'}, right: {style:'thin'} };
             cell.alignment = { horizontal: 'center' };
             cell.fill = { type: 'pattern', pattern:'solid', fgColor:{argb:'FFEFEFEF'} };
        });
        currentRow++;

        // 明細データ
        v.details.forEach(detail => {
          const r = sheet.getRow(currentRow);
          r.values = [
            detail.no,
            detail.depositCategory,
            detail.depositAmount,
            detail.description,
            detail.withdrawalAmount,
            detail.withdrawalCategory
          ];
          // 罫線と数値フォーマット
          r.eachCell((cell, colNumber) => {
            cell.border = { top: {style:'dotted'}, left: {style:'thin'}, bottom: {style:'dotted'}, right: {style:'thin'} };
            if (colNumber === 3 || colNumber === 5) { // 金額列
               cell.numFmt = '#,##0';
            }
          });
          currentRow++;
        });

        // 伝票間のスペース
        currentRow += 1;
      }

      // ファイル書き出し
      const buffer = await workbook.xlsx.writeBuffer();
      const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `${month}_入出金伝票.xlsx`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    });

    /**********************************************
     * Excel (XLSX) 読み込み機能 (ExcelJS使用)
     **********************************************/
    document.getElementById("excelLoadBtn").addEventListener("click", () => {
      document.getElementById("excelLoadInput").click();
    });

    document.getElementById("excelLoadInput").addEventListener("change", async e => {
      const file = e.target.files[0];
      if (!file) return;

      try {
        const buffer = await file.arrayBuffer();
        const workbook = new ExcelJS.Workbook();
        await workbook.xlsx.load(buffer);
        const sheet = workbook.getWorksheet(1); // 最初のシート

        if (!sheet) throw new Error("シートが見つかりません");

        let loadedData = {};
        let currentVoucher = null;
        let detailsCount = 0;

        // 行を走査
        sheet.eachRow((row, rowNumber) => {
          const values = row.values; // values[1]がA列
          // ExcelJSのvaluesは1始まりの疎配列の場合があるため注意

          const cellA = row.getCell(1).value; 
          
          // 「伝票日付」ヘッダーを見つけたら、次の行がサマリーデータと判断
          if (String(cellA).trim() === '伝票日付') {
             // 次の行を取得するためにフラグなどを立てるのではなく、
             // ExcelJSなら直接次の行へアクセスも可能だが、ここではeachRowの流れに任せる
             // シンプルに「伝票日付」の次の行がデータであると仮定
             return; 
          }

          // 日付っぽい形式、かつ前の行が「伝票日付」ヘッダーだった場合…という判定もできるが
          // ここでは「No.」ヘッダー、「詳細行」などを文脈で判断します。

          // シンプルなロジック：
          // セルAが日付形式(YYYY-MM-DD)なら新しい伝票の開始
          // セルAが数値なら明細行
          
          let valA = String(cellA || "").trim();
          
          // 日付行（サマリー行）の判定 (例: 2023-10-01)
          if (valA.match(/^\d{4}-\d{2}-\d{2}$/)) {
            // 新しい伝票
            currentVoucher = {
              date: valA,
              prevBalance: parseFloat(row.getCell(2).value) || 0,
              deposit: parseFloat(row.getCell(3).value) || 0,
              withdrawal: parseFloat(row.getCell(4).value) || 0,
              balance: parseFloat(row.getCell(5).value) || 0,
              details: []
            };
            loadedData[valA] = currentVoucher;
            detailsCount = 0;
          }
          // 明細行の判定 (No.列が数値)
          else if (currentVoucher && !isNaN(parseInt(valA)) && parseInt(valA) > 0) {
             // 既に10行読み込んでいたらスキップ
             if (currentVoucher.details.length < 10) {
               currentVoucher.details.push({
                 no: parseInt(valA),
                 depositCategory: String(row.getCell(2).value || ""),
                 depositAmount: parseFloat(row.getCell(3).value) || 0,
                 description: String(row.getCell(4).value || ""),
                 withdrawalAmount: parseFloat(row.getCell(5).value) || 0,
                 withdrawalCategory: String(row.getCell(6).value || "")
               });
             }
          }
        });

        // データの補完（明細が10行未満の場合など）
        Object.values(loadedData).forEach(v => {
           while(v.details.length < 10) {
             v.details.push({
               no: v.details.length + 1,
               depositCategory: "", depositAmount: 0, description: "", withdrawalAmount: 0, withdrawalCategory: ""
             });
           }
        });

        if (Object.keys(loadedData).length === 0) {
           alert("有効な伝票データが見つかりませんでした。");
           return;
        }

        if (confirm("現在のデータを上書きしてExcelデータを読み込みますか？")) {
            voucherData = loadedData;
            autoSaveVoucherData();
            
            // 画面更新
            const dates = Object.keys(loadedData).sort();
            const firstDate = dates[0];
            if(firstDate) {
               const ym = firstDate.slice(0, 7);
               document.getElementById("monthSelector").value = ym;
               ensureVoucherDataForMonth(ym);
               populateDaySelector(ym);
               currentVoucherDate = firstDate;
               document.getElementById("daySelector").value = currentVoucherDate;
               loadVoucher(currentVoucherDate);
               recalcMonth();
            }
            alert("読み込み完了しました。");
        }

      } catch (err) {
        console.error(err);
        alert("Excel読み込みエラー: " + err.message);
      } finally {
        e.target.value = '';
      }
    });

    /**********************************************
     * JSON 保存・読み込み (バックアップ用)
     **********************************************/
    document.getElementById("jsonSaveBtn").addEventListener("click", () => {
      const dataToSave = { voucherData: voucherData, syncRows: syncRows };
      const jsonStr = JSON.stringify(dataToSave, null, 2);
      const dataUri = "data:application/json;charset=utf-8," + encodeURIComponent(jsonStr);
      const link = document.createElement("a");
      link.href = dataUri;
      link.download = "入出金伝票_バックアップ.json";
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    });

    document.getElementById("jsonLoadBtn").addEventListener("click", () => {
      document.getElementById("jsonLoadInput").click();
    });

    document.getElementById("jsonLoadInput").addEventListener("change", e => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(event) {
        try {
          const loadedData = JSON.parse(event.target.result);
          if (loadedData.voucherData) {
            if (confirm("JSONからデータを復元しますか？")) {
              voucherData = loadedData.voucherData;
              if(loadedData.syncRows) syncRows = loadedData.syncRows;
              autoSaveVoucherData();
              initApp(); // リロード的に初期化
              alert("復元しました。");
            }
          }
        } catch(e) { alert("JSON読み込みエラー"); }
      };
      reader.readAsText(file);
      e.target.value = '';
    });

    document.getElementById("printBtn").addEventListener("click", () => window.print());

    /**********************************************
     * アプリ起動
     **********************************************/
    window.addEventListener("load", initApp);
  </script>
</body>
</html>
