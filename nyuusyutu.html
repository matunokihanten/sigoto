<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>入出金伝票システム（松乃木飯店カスタム版）</title>
  <script src="https://cdn.jsdelivr.net/npm/exceljs/dist/exceljs.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    #controlPanel, #searchPanel, #actionPanel, #importPanel {
      margin-bottom: 10px; padding: 10px; border: 1px solid #ccc; border-radius: 5px;
    }
    #controlPanel input, #controlPanel select, #controlPanel button,
    #actionPanel button, #importPanel button { margin-right: 10px; font-size: 14px; margin-bottom: 5px; }
    #voucherCard { margin-bottom: 20px; }
    #summaryPanel div { margin: 5px 0; }
    table { border-collapse: collapse; width: 100%; margin-top: 10px; }
    th, td { border: 1px solid #aaa; padding: 5px; text-align: center; }
    /* 金額フィールドはtype="number"からtype="text"に変わるので、どちらも幅を適用 */
    input[type="text"], input[type="number"] { width: 90%; box-sizing: border-box; }

    /* アクティブな行のハイライト */
    tr.active-row td {
      background-color: #f7fff7 !important;
    }

    /* 検索結果のハイライト */
    .highlight-cell {
      background-color: #fffdc9 !important;
    }

    /* 処理中フィードバック用オーバーレイ */
    #loadingOverlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      display: none;
      justify-content: center;
      align-items: center;
      color: white;
      font-size: 1.5em;
    }

    @media print {
      #controlPanel, #searchPanel, #actionPanel, #settingsPanel, #loadingOverlay, #importPanel { display: none; }
    }
    /* 設定パネル */
    #settingsPanel {
      border: 1px solid #aaa; padding: 10px; margin-top: 10px; background-color: #f9f9f9; width: 300px;
    }
    /* 検索結果 */
    .search-result-item {
      margin-bottom: 5px;
      display: flex; align-items: center;
    }
    .search-result-item a { margin-right: 10px; }
    .disabled-input { background-color: #f0f0f0; }
    
    /* インポートパネル強調 */
    #importPanel { background-color: #eef9ff; border-color: #bee5eb; }
    h3 { margin-top: 0; }
  </style>
</head>
<body>

  <div id="controlPanel">
    <label for="monthSelector">対象月：</label>
    <input type="month" id="monthSelector">
    <label for="daySelector">書き込む日：</label>
    <select id="daySelector"></select>
    <button id="prevDayBtn">前日</button>
    <button id="nextDayBtn">翌日</button>
    <button id="settingsBtn">設定</button>
  </div>

  <div id="settingsPanel" style="display:none;">
    <h3>固定摘要同期設定</h3>
    <p><small>選択された行の摘要は、毎月1日の摘要と同期されます。</small></p>
    <form id="syncForm">
      <div>
        <label><input type="checkbox" name="syncRow" value="0"> 行1</label>
        <label><input type="checkbox" name="syncRow" value="1"> 行2</label>
        <label><input type="checkbox" name="syncRow" value="2"> 行3</label>
        <label><input type="checkbox" name="syncRow" value="3"> 行4</label>
        <label><input type="checkbox" name="syncRow" value="4"> 行5</label>
      </div>
      <div>
        <label><input type="checkbox" name="syncRow" value="5"> 行6</label>
        <label><input type="checkbox" name="syncRow" value="6"> 行7</label>
        <label><input type="checkbox" name="syncRow" value="7"> 行8</label>
        <label><input type="checkbox" name="syncRow" value="8"> 行9</label>
        <label><input type="checkbox" name="syncRow" value="9"> 行10</label>
      </div>
    </form>
    <br>
    <button type="button" id="deleteAllDataBtn">全データ削除</button>
    <button type="button" id="closeSettingsBtn">閉じる</button>
  </div>
  
  <div id="importPanel">
    <h3>売上データ連携</h3>
    <p><small>売上詳細CSVファイルを読み込み、入金(売上)と出金(売掛計)を反映します。</small></p>
    <input type="file" id="salesCsvInput" accept=".csv" style="display:none;">
    <button id="salesCsvLoadBtn" style="font-weight:bold; color:#0056b3;">売上管理表CSV読込</button>
  </div>

  <div id="voucherCard">
    <h2 id="voucherHeader">伝票: </h2>
    <div id="summaryPanel">
      <div id="prevBalanceContainer">前日残高: <span id="prevBalanceField"></span></div>
      <div>本日入金: <span id="depositTotal"></span></div>
      <div>本日出金: <span id="withdrawalTotal"></span></div>
      <div>本日残高: <span id="balance"></span></div>
    </div>
    <div style="text-align: right; margin-bottom: 5px;">
        <button id="clearPageBtn" style="background-color: #fff3cd; border: 1px solid #ffeeba; cursor:pointer;">表示中の伝票をクリア</button>
    </div>
    <table id="voucherDetails">
      <thead>
        <tr>
          <th>No.</th>
          <th>入金科目</th>
          <th>入金金額</th>
          <th>摘要</th>
          <th>出金金額</th>
          <th>出金科目</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div id="searchPanel">
    <label for="searchKeyword">検索キーワード：</label>
    <input type="text" id="searchKeyword" placeholder="キーワード入力">
    <button id="searchBtn">検索</button>
    <button id="clearSearchBtn">検索クリア</button>
    <div id="searchResults" style="margin-top: 10px;"></div>
  </div>

  <div id="actionPanel">
    <h3>データ操作</h3>
    <button id="excelSaveBtn">Excel保存 (.xlsx)</button>
    <input type="file" id="excelLoadInput" accept=".xlsx" style="display:none;">
    <button id="excelLoadBtn">Excel読み込み (.xlsx)</button>
    
    <button id="jsonSaveBtn">JSON保存</button>
    <input type="file" id="jsonLoadInput" accept=".json" style="display:none;">
    <button id="jsonLoadBtn">JSON読み込み</button>
    
    <button id="printBtn">印刷</button>
  </div>
  
  <div id="loadingOverlay" style="display: none;">
    <p id="loadingText">処理中...</p>
  </div>

  <script>
    /**********************************************
     * グローバル変数・データ構造
     **********************************************/
    let voucherData = {};
    let syncRows = Array(10).fill(false);
    let currentVoucherDate = "";

    /**********************************************
     * 処理中フィードバック
     **********************************************/
    function showLoading(text = "処理中...") {
      document.getElementById("loadingText").textContent = text;
      document.getElementById("loadingOverlay").style.display = "flex";
    }
    function hideLoading() {
      document.getElementById("loadingOverlay").style.display = "none";
    }

    /**********************************************
     * 初期化・データ読み込み処理
     **********************************************/
    function initApp() {
      const storedVoucherData = localStorage.getItem("voucherData");
      if (storedVoucherData) {
        try { voucherData = JSON.parse(storedVoucherData); } catch(e) { voucherData = {}; console.error(e); }
      }
      const storedSyncRows = localStorage.getItem("syncRows");
      if (storedSyncRows) {
        try { syncRows = JSON.parse(storedSyncRows); } catch(e) { syncRows = Array(10).fill(false); console.error(e); }
      }

      document.querySelectorAll("#syncForm input[type=checkbox]").forEach((chk, index) => {
        chk.checked = syncRows[index];
      });

      const monthSelector = document.getElementById("monthSelector");
      const now = new Date();
      const monthValue = now.toISOString().slice(0, 7);
      monthSelector.value = monthValue;

      ensureVoucherDataForMonth(monthValue);
      populateDaySelector(monthValue);

      currentVoucherDate = monthValue + "-01";
      document.getElementById("daySelector").value = currentVoucherDate;
      loadVoucher(currentVoucherDate);
      recalcMonth();
    }

    function ensureVoucherDataForMonth(month) {
      const [year, monthNum] = month.split("-");
      // Date(year, monthIndex, 0) でその月の最終日を取得できる
      const daysInMonth = new Date(parseInt(year), parseInt(monthNum), 0).getDate();

      for (let d = 1; d <= daysInMonth; d++) {
        const dayStr = String(d).padStart(2, "0");
        const dateStr = `${month}-${dayStr}`;

        if (!voucherData[dateStr]) {
          voucherData[dateStr] = {
            date: dateStr,
            prevBalance: 0,
            deposit: 0,
            withdrawal: 0,
            balance: 0,
            details: []
          };
          for (let i = 0; i < 10; i++) {
            voucherData[dateStr].details.push({
              no: i + 1,
              depositCategory: "",
              depositAmount: 0,
              description: "",
              withdrawalAmount: 0,
              withdrawalCategory: ""
            });
          }
        }
      }
      autoSaveVoucherData();
    }

    function populateDaySelector(month) {
      const selector = document.getElementById("daySelector");
      selector.innerHTML = "";
      const [year, monthNum] = month.split("-");
      const daysInMonth = new Date(parseInt(year), parseInt(monthNum), 0).getDate();

      for (let d = 1; d <= daysInMonth; d++) {
        const dayStr = String(d).padStart(2, "0");
        const date = `${month}-${dayStr}`;
        const option = document.createElement("option");
        option.value = date;
        option.textContent = date;
        selector.appendChild(option);
      }
      if (!selector.querySelector(`option[value="${currentVoucherDate}"]`)) {
        currentVoucherDate = month + "-01";
      }
      selector.value = currentVoucherDate;
    }

    function autoSaveVoucherData() {
      localStorage.setItem("voucherData", JSON.stringify(voucherData));
      localStorage.setItem("syncRows", JSON.stringify(syncRows));
    }

    // 【修正箇所】月末残高の翌月1日への繰越を実装
    function recalcMonth() {
      const dates = Object.keys(voucherData).sort();
      
      for (let i = 0; i < dates.length; i++) {
        const currentDate = dates[i];
        const voucher = voucherData[currentDate];
        if (!voucher) continue;

        // データの最初の日のprevBalance以外は、すべて前日のbalanceを反映する
        // これにより、日々の繰越と月末から翌月への繰越をまとめて処理する
        if (i > 0) {
            const prevVoucher = voucherData[dates[i-1]];
            if (prevVoucher) {
                // 前日の最終残高を当日の前日残高として設定
                voucher.prevBalance = prevVoucher.balance;
            }
        } 
        // データの最初の日は、prevBalanceは手動で設定された値（または初期値0）を保持

        recalcVoucher(currentDate);
      }
      loadVoucher(currentVoucherDate);
      autoSaveVoucherData();
    }

    function recalcVoucher(date) {
      const voucher = voucherData[date];
      if (!voucher) return;
      let totalDep = 0, totalWithdraw = 0;

      voucher.details.forEach(row => {
        totalDep += parseFloat(row.depositAmount) || 0;
        totalWithdraw += parseFloat(row.withdrawalAmount) || 0;
      });

      voucher.deposit = totalDep;
      voucher.withdrawal = totalWithdraw;
      // prevBalanceには、recalcMonthで設定された値（前日の残高）または手動入力値（1日目のみ）が使用される
      voucher.balance = voucher.prevBalance + totalDep - totalWithdraw; 
    }

    function syncDescription(rowIndex) {
      const currentMonth = document.getElementById("monthSelector").value;
      const masterDate = `${currentMonth}-01`;
      if (!voucherData[masterDate]) return;
      const masterDescription = voucherData[masterDate].details[rowIndex].description;

      Object.keys(voucherData).forEach(date => {
        if (date.startsWith(currentMonth)) {
          voucherData[date].details[rowIndex].description = masterDescription;
        }
      });
      loadVoucher(currentVoucherDate);
      autoSaveVoucherData();
    }

    /**********************************************
     * 伝票表示・入力
     **********************************************/
    function loadVoucher(date, searchKeyword = null) {
      const voucher = voucherData[date];
      if (!voucher) { return; }

      document.getElementById("voucherHeader").textContent = `伝票: ${date}`;
      const prevBalanceContainer = document.getElementById("prevBalanceContainer");
      prevBalanceContainer.innerHTML = "前日残高: ";
      
      // 月初（-01）の日は手動で前日残高を修正できるように入力フィールドを表示
      if (date.endsWith("-01")) {
        const input = document.createElement("input");
        input.type = "text"; 
        input.style.width = '100px'; 
        
        const displayValue = voucher.prevBalance === 0 ? "" : voucher.prevBalance.toLocaleString('ja-JP');
        input.value = displayValue;
        
        input.addEventListener("focus", e => {
            const rawValue = String(e.target.value).replace(/,/g, '');
            e.target.value = rawValue;
            if(e.target.select) e.target.select();
        });

        input.addEventListener("blur", e => {
            const numValue = parseFloat(e.target.value.replace(/,/g, '')) || 0;
            voucher.prevBalance = numValue;
            e.target.value = numValue.toLocaleString('ja-JP');
            // 手動で値を変更した際は再計算を走らせ、月全体の残高を更新する
            recalcMonth();
        });
        
        prevBalanceContainer.appendChild(input);
      } else {
        // 月初以外の日は自動計算された値（前日残高）をspanで表示し、手動修正は不可とする
        const span = document.createElement("span");
        span.textContent = voucher.prevBalance.toLocaleString();
        prevBalanceContainer.appendChild(span);
      }

      document.getElementById("depositTotal").textContent = voucher.deposit.toLocaleString();
      document.getElementById("withdrawalTotal").textContent = voucher.withdrawal.toLocaleString();
      document.getElementById("balance").textContent = voucher.balance.toLocaleString();

      const tbody = document.querySelector("#voucherDetails tbody");
      tbody.innerHTML = "";
      const currentMonth = document.getElementById("monthSelector").value;
      const isFirstDayOfMonth = date.endsWith("-01");
      const keyword = searchKeyword ? searchKeyword.toLowerCase() : null;

      voucher.details.forEach((row, index) => {
        const tr = document.createElement("tr");
        tr.dataset.row = index;

        // No.
        const tdNo = document.createElement("td");
        tdNo.textContent = row.no;
        tr.appendChild(tdNo);
        if (keyword && String(row.no).includes(keyword)) tdNo.classList.add("highlight-cell");

        // 入金科目
        createCell(tr, "text", row.depositCategory, index, "1", val => row.depositCategory = val, keyword);
        // 入金金額
        createCell(tr, "number", row.depositAmount, index, "2", val => {
          row.depositAmount = val;
        }, keyword);

        // 摘要
        const tdDesc = document.createElement("td");
        const inputDesc = document.createElement("input");
        inputDesc.type = "text";
        inputDesc.dataset.row = index;
        inputDesc.dataset.col = "3";
        let isSync = syncRows[index];

        if (isSync) {
          const masterVoucher = voucherData[`${currentMonth}-01`];
          if (masterVoucher) {
            inputDesc.value = masterVoucher.details[index].description;
            row.description = masterVoucher.details[index].description;
          }
          if (!isFirstDayOfMonth) {
            inputDesc.readOnly = true;
            inputDesc.classList.add("disabled-input");
          }
        } else {
          inputDesc.value = row.description;
        }
        
        inputDesc.addEventListener("change", e => {
          row.description = e.target.value;
          autoSaveVoucherData();
          if (isFirstDayOfMonth && isSync) syncDescription(index);
        });
        addEnterNavigation(inputDesc);
        addHighlightLogic(inputDesc, tr);

        if (keyword && (row.description && row.description.toLowerCase().includes(keyword))) tdDesc.classList.add("highlight-cell");

        tdDesc.appendChild(inputDesc);
        tr.appendChild(tdDesc);

        // 出金金額
        createCell(tr, "number", row.withdrawalAmount, index, "4", val => {
          row.withdrawalAmount = val;
        }, keyword);
        // 出金科目
        createCell(tr, "text", row.withdrawalCategory, index, "5", val => row.withdrawalCategory = val, keyword);

        tbody.appendChild(tr);
      });
    }

    function createCell(tr, type, value, rowIndex, colIndex, callback, keyword) {
      const td = document.createElement("td");
      const input = document.createElement("input");
      
      // 金額フィールドの表示形式修正（バグ修正対応）
      const actualInputType = (type === "number") ? "text" : type; 
      input.type = actualInputType;
      
      const valueStr = String(value);
      if (keyword && valueStr.toLowerCase().includes(keyword)) {
          td.classList.add("highlight-cell");
      }
      
      const displayValue = (value === 0 && type === "number") 
                           ? "" 
                           : (type === "number" ? (parseFloat(value) || 0).toLocaleString('ja-JP') : valueStr);
      input.value = displayValue;
      
      input.dataset.row = rowIndex;
      input.dataset.col = colIndex;
      
      if (type === "number") { // 内部ロジックは "number"型として動作
          input.addEventListener("focus", e => {
              // 編集のためカンマを削除
              const rawValue = String(e.target.value).replace(/,/g, '');
              e.target.value = rawValue;
              if(e.target.select) e.target.select();
          });
          
          input.addEventListener("blur", e => {
              // ぼかし時、値をパースしカンマを付けて表示
              const numValue = parseFloat(e.target.value.replace(/,/g, '')) || 0;
              callback(numValue);
              e.target.value = numValue.toLocaleString('ja-JP');
              recalcVoucher(currentVoucherDate); 
              loadVoucher(currentVoucherDate);
              autoSaveVoucherData();
          });
      } else {
          input.addEventListener("change", e => {
            callback(e.target.value);
            autoSaveVoucherData(); 
          });
      }
      
      addHighlightLogic(input, tr);
      addEnterNavigation(input);
      td.appendChild(input);
      tr.appendChild(td);
    }
    
    function addHighlightLogic(inputElem, trElem) {
      inputElem.addEventListener("focus", () => {
        document.querySelectorAll(".active-row").forEach(tr => tr.classList.remove("active-row"));
        trElem.classList.add("active-row");
      });
    }

    function addEnterNavigation(inputElem) {
      inputElem.addEventListener("keydown", e => {
        if (e.key === "Enter") {
          e.preventDefault();
          const currentRow = parseInt(e.target.dataset.row);
          const currentCol = parseInt(e.target.dataset.col);
          let nextRow = currentRow;
          let nextCol = currentCol + 1;

          if (currentCol === 2 || currentCol === 4 || currentCol === 5) {
            nextRow = currentRow + 1;
            nextCol = 1;
          }
          if (currentCol === 3) {
            nextCol = 4;
          }

          const nextInput = document.querySelector(`#voucherDetails tbody tr[data-row='${nextRow}'] input[data-col='${nextCol}']`);
          if (nextInput) {
            nextInput.focus();
            if(nextInput.type === "text") nextInput.select();
          }
        }
      });
    }

    /**********************************************
     * イベント処理・ボタン機能
     **********************************************/
    document.getElementById("monthSelector").addEventListener("change", e => {
      autoSaveVoucherData();
      const month = e.target.value;
      ensureVoucherDataForMonth(month);
      populateDaySelector(month);
      currentVoucherDate = month + "-01";
      document.getElementById("daySelector").value = currentVoucherDate;
      loadVoucher(currentVoucherDate);
      recalcMonth();
    });

    document.getElementById("daySelector").addEventListener("change", e => {
      currentVoucherDate = e.target.value;
      loadVoucher(currentVoucherDate);
      recalcMonth();
    });

    document.getElementById("prevDayBtn").addEventListener("click", () => moveDay(-1));
    document.getElementById("nextDayBtn").addEventListener("click", () => moveDay(1));

    function moveDay(delta) {
      const date = new Date(currentVoucherDate + "T00:00:00");
      date.setDate(date.getDate() + delta);
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, "0");
      const day = String(date.getDate()).padStart(2, "0");
      const nextDate = `${year}-${month}-${day}`;
      const currentMonth = document.getElementById("monthSelector").value;
      const nextMonth = `${year}-${month}`;

      // 1. 月が変わる場合は、まず新しい月のデータを初期化する
      if (currentMonth !== nextMonth) {
          if (year < 1950 || year > 2099) {
             return; 
          }
          
          document.getElementById("monthSelector").value = nextMonth;
          ensureVoucherDataForMonth(nextMonth); // 新しい月のデータを作成
          populateDaySelector(nextMonth); // セレクターを更新
      }

      // 2. データが作成されたことを確認した後、その日の伝票をロードする
      if (voucherData[nextDate]) {
        currentVoucherDate = nextDate;
        document.getElementById("daySelector").value = nextDate;
        loadVoucher(nextDate);
        recalcMonth(); // 移動後に再計算を走らせ、残高を更新
      } 
    }

    // 設定ボタンのイベントリスナー
    document.getElementById("settingsBtn").addEventListener("click", () => {
        document.getElementById("settingsPanel").style.display = "block";
    });
    document.getElementById("closeSettingsBtn").addEventListener("click", () => {
        document.getElementById("settingsPanel").style.display = "none";
    });
    document.getElementById("deleteAllDataBtn").addEventListener("click", () => {
        if(confirm("全てのデータを削除してもよろしいですか？この操作は取り消せません。")) {
            voucherData = {};
            localStorage.removeItem("voucherData");
            initApp();
            document.getElementById("settingsPanel").style.display = "none";
            alert("データを削除しました。");
        }
    });

    // 表示中の伝票をクリアする機能
    document.getElementById("clearPageBtn").addEventListener("click", () => {
        if(!confirm(`現在表示中の【${currentVoucherDate}】の明細を全てクリアしますか？\n（前日残高は維持されます）`)) return;
        
        const v = voucherData[currentVoucherDate];
        if(!v) return;

        v.details.forEach(d => {
            d.depositCategory = "";
            d.depositAmount = 0;
            d.description = "";
            d.withdrawalAmount = 0;
            d.withdrawalCategory = "";
        });
        
        recalcVoucher(currentVoucherDate);
        loadVoucher(currentVoucherDate);
        recalcMonth();
        autoSaveVoucherData();
    });

    /**********************************************
     * 売上CSV読込機能
     **********************************************/
    document.getElementById("salesCsvLoadBtn").addEventListener("click", () => {
        document.getElementById("salesCsvInput").click();
    });

    document.getElementById("salesCsvInput").addEventListener("change", e => {
        const file = e.target.files[0];
        if(!file) return;

        const reader = new FileReader();
        reader.onload = function(event) {
            try {
                const text = event.target.result;
                const lines = text.split(/\r\n|\n/);
                if(lines.length < 2) throw new Error("データが空か不正です。");

                // ヘッダー行を解析して列インデックスを特定
                const headers = lines[0].split(",");
                const colMap = {
                    date: 0, // A列: 集計期間
                    salesTaxInc: -1, // 売上高（税込）
                    square: -1, // Square
                    paypay: -1, // PayPay
                    gift: -1,   // 袋井商品券
                    funfo: -1   // Funfo
                };

                // ヘッダー名から列番号を探す
                headers.forEach((h, i) => {
                    const cleanH = h.trim();
                    if(cleanH === "売上高（税込）") colMap.salesTaxInc = i;
                    else if(cleanH === "Square") colMap.square = i;
                    else if(cleanH === "PayPay") colMap.paypay = i;
                    else if(cleanH === "袋井商品券") colMap.gift = i;
                    else if(cleanH === "Funfo") colMap.funfo = i;
                });

                if(colMap.salesTaxInc === -1) throw new Error("「売上高（税込）」列が見つかりません。");

                let processedCount = 0;

                // データ行をループ
                for(let i=1; i<lines.length; i++) {
                    const rowRaw = lines[i];
                    if(!rowRaw.trim()) continue;
                    
                    // カンマ区切り（簡易パース：データ内にカンマがない前提）
                    const row = rowRaw.split(",");
                    
                    // 日付の取得とフォーマット変換 (YYYY/MM/DD -> YYYY-MM-DD)
                    let dateStr = row[colMap.date];
                    if(!dateStr) continue;
                    dateStr = dateStr.replace(/\//g, "-"); 
                    
                    // 該当する日付の伝票データがあるか確認
                    if(voucherData[dateStr]) {
                        const v = voucherData[dateStr];
                        
                        // 数値取得用ヘルパー
                        const getVal = (idx) => {
                            if(idx === -1 || !row[idx]) return 0;
                            return parseFloat(row[idx]) || 0;
                        };

                        const salesVal = getVal(colMap.salesTaxInc);
                        // 出金（売掛）合計：Square + PayPay + 商品券 + Funfo
                        const creditTotal = getVal(colMap.square) + getVal(colMap.paypay) + getVal(colMap.gift) + getVal(colMap.funfo);

                        // 1行目に反映する
                        const detail = v.details[0]; // 常に1行目を使用
                        
                        // 入金：売上
                        detail.depositCategory = "売上";
                        detail.depositAmount = salesVal;
                        
                        // 出金：売掛金 (値がある場合のみ)
                        if(creditTotal > 0) {
                            detail.withdrawalCategory = "売掛金";
                            detail.withdrawalAmount = creditTotal;
                        } else {
                            // 売掛がない場合は0にリセット
                            detail.withdrawalCategory = "";
                            detail.withdrawalAmount = 0;
                        }
                        
                        processedCount++;
                    }
                }

                autoSaveVoucherData();
                recalcMonth();
                loadVoucher(currentVoucherDate);
                alert(`${processedCount}件のデータを反映しました。`);

            } catch(err) {
                console.error(err);
                alert("CSV読み込みエラー: " + err.message);
            } finally {
                e.target.value = "";
            }
        };
        reader.readAsText(file); 
    });


    /**********************************************
     * 検索機能
     **********************************************/
    document.getElementById("searchBtn").addEventListener("click", () => {
      document.querySelectorAll(".highlight-cell").forEach(cell => cell.classList.remove("highlight-cell"));
      const keyword = document.getElementById("searchKeyword").value.trim().toLowerCase();
      const resultsDiv = document.getElementById("searchResults");
      resultsDiv.innerHTML = "";

      if (keyword === "") { alert("検索キーワードを入力してください。"); return; }

      const sortedDates = Object.keys(voucherData).sort();
      sortedDates.forEach(date => {
        const voucher = voucherData[date];
        let foundInVoucher = false;

        const summaryValues = [
            String(voucher.prevBalance), String(voucher.deposit), 
            String(voucher.withdrawal), String(voucher.balance), voucher.date
        ];
        if (summaryValues.some(v => v.includes(keyword))) {
            foundInVoucher = true;
        }

        if (!foundInVoucher) {
          foundInVoucher = voucher.details.some(row => {
            return (row.depositCategory && row.depositCategory.toLowerCase().includes(keyword)) ||
                   String(row.depositAmount).includes(keyword) ||
                   (row.description && row.description.toLowerCase().includes(keyword)) ||
                   String(row.withdrawalAmount).includes(keyword) ||
                   (row.withdrawalCategory && row.withdrawalCategory.toLowerCase().includes(keyword));
          });
        }

        if (foundInVoucher) {
          const itemDiv = document.createElement("div");
          itemDiv.classList.add("search-result-item");
          const link = document.createElement("a");
          link.textContent = date;
          link.href = "#";
          link.addEventListener("click", e => {
            e.preventDefault();
            const selectedMonth = date.slice(0, 7);
            document.getElementById("monthSelector").value = selectedMonth;
            ensureVoucherDataForMonth(selectedMonth);
            populateDaySelector(selectedMonth);
            currentVoucherDate = date;
            document.getElementById("daySelector").value = date;
            loadVoucher(currentVoucherDate, keyword);
            recalcMonth();
          });
          itemDiv.appendChild(link);
          resultsDiv.appendChild(itemDiv);
        }
      });
      if (resultsDiv.children.length === 0) resultsDiv.textContent = "検索結果はありません。";
    });

    document.getElementById("clearSearchBtn").addEventListener("click", () => {
      document.getElementById("searchResults").innerHTML = "";
      document.getElementById("searchKeyword").value = "";
      document.querySelectorAll(".highlight-cell").forEach(cell => cell.classList.remove("highlight-cell"));
      loadVoucher(currentVoucherDate);
    });

    /**********************************************
     * Excel / JSON 保存・読込
     **********************************************/
    document.getElementById("excelSaveBtn").addEventListener("click", async () => {
      showLoading("Excelファイルを作成中...");
      try {
        const month = document.getElementById("monthSelector").value;
        const workbook = new ExcelJS.Workbook();

        const summarySheet = workbook.addWorksheet('月次サマリー');
        const sortedDatesForMonth = Object.keys(voucherData)
          .filter(date => date.startsWith(month))
          .sort();
          
        let summaryRow = 1;
        summarySheet.getRow(summaryRow++).values = ['日付', '前日残高', '本日入金', '本日出金', '本日残高'];
        sortedDatesForMonth.forEach(date => {
            const v = voucherData[date];
            const row = summarySheet.getRow(summaryRow++);
            row.values = [v.date, v.prevBalance, v.deposit, v.withdrawal, v.balance];
            [2,3,4,5].forEach(c => {
               row.getCell(c).numFmt = '#,##0';
               row.getCell(c).alignment = { horizontal: 'right' };
            });
        });

        const voucherSheet = workbook.addWorksheet('入出金伝票');
        voucherSheet.columns = [{ width: 8 }, { width: 15 }, { width: 12 }, { width: 30 }, { width: 12 }, { width: 15 }];
        let currentRow = 1;

        for (const date of sortedDatesForMonth) {
          const v = voucherData[date];
          const headerRow = voucherSheet.getRow(currentRow);
          headerRow.values = ['伝票日付', '前日残高', '本日入金', '本日出金', '本日残高'];
          headerRow.font = { bold: true };
          headerRow.fill = { type: 'pattern', pattern:'solid', fgColor:{argb:'FFF2F2F2'} };
          headerRow.eachCell(cell => {
               cell.border = { top: {style:'thin'}, left: {style:'thin'}, bottom: {style:'thin'}, right: {style:'thin'} };
               cell.alignment = { horizontal: 'center' };
          });
          currentRow++;

          const summaryRow = voucherSheet.getRow(currentRow);
          summaryRow.values = [v.date, v.prevBalance, v.deposit, v.withdrawal, v.balance];
          summaryRow.getCell(1).alignment = { horizontal: 'center' };
          [2,3,4,5].forEach(c => {
              summaryRow.getCell(c).numFmt = '#,##0';
              summaryRow.getCell(c).alignment = { horizontal: 'right' };
          });
          summaryRow.eachCell(cell => {
               cell.border = { top: {style:'thin'}, left: {style:'thin'}, bottom: {style:'thin'}, right: {style:'thin'} };
          });
          currentRow++;

          const detailHeader = voucherSheet.getRow(currentRow);
          detailHeader.values = ['No.', '入金科目', '入金金額', '摘要', '出金金額', '出金科目'];
          detailHeader.font = { bold: true };
          detailHeader.eachCell(cell => {
               cell.border = { top: {style:'thin'}, left: {style:'thin'}, bottom: {style:'thin'}, right: {style:'thin'} };
               cell.alignment = { horizontal: 'center' };
               cell.fill = { type: 'pattern', pattern:'solid', fgColor:{argb:'FFEFEFEF'} };
          });
          currentRow++;

          v.details.forEach(detail => {
            const r = voucherSheet.getRow(currentRow);
            r.values = [detail.no, detail.depositCategory, detail.depositAmount, detail.description, detail.withdrawalAmount, detail.withdrawalCategory];
            r.eachCell((cell, colNumber) => {
              cell.border = { top: {style:'dotted'}, left: {style:'thin'}, bottom: {style:'dotted'}, right: {style:'thin'} };
              if (colNumber === 3 || colNumber === 5) {
                 cell.numFmt = '#,##0';
                 cell.alignment = { horizontal: 'right' };
              }
            });
            currentRow++;
          });
          currentRow += 1;
        }

        const buffer = await workbook.xlsx.writeBuffer();
        const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${month}_入出金伝票_月次サマリー付.xlsx`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
        alert("Excelファイルの保存が完了しました。");
      } catch (error) {
          console.error("Excel保存エラー:", error);
          alert("Excelファイルの保存中にエラーが発生しました。");
      } finally { hideLoading(); }
    });

    document.getElementById("excelLoadBtn").addEventListener("click", () => {
      document.getElementById("excelLoadInput").click();
    });

    document.getElementById("excelLoadInput").addEventListener("change", async e => {
      const file = e.target.files[0];
      if (!file) return;
      showLoading("Excelデータを読み込み中...");
      try {
        const buffer = await file.arrayBuffer();
        const workbook = new ExcelJS.Workbook();
        await workbook.xlsx.load(buffer);
        const sheet = workbook.getWorksheet(1) || workbook.getWorksheet('入出金伝票');
        if (!sheet) throw new Error("伝票データシートが見つかりません。");

        let loadedData = {};
        let currentVoucher = null;

        sheet.eachRow((row, rowNumber) => {
          const cellA = row.getCell(1).value; 
          let valA = String(cellA || "").trim();
          
          if (valA.match(/^\d{4}-\d{2}-\d{2}$/)) {
            currentVoucher = {
              date: valA,
              prevBalance: parseFloat(row.getCell(2).value) || 0,
              deposit: parseFloat(row.getCell(3).value) || 0,
              withdrawal: parseFloat(row.getCell(4).value) || 0,
              balance: parseFloat(row.getCell(5).value) || 0,
              details: []
            };
            loadedData[valA] = currentVoucher;
          }
          else if (currentVoucher && !isNaN(parseInt(valA)) && parseInt(valA) > 0) {
             if (currentVoucher.details.length < 10) {
               currentVoucher.details.push({
                 no: parseInt(valA),
                 depositCategory: String(row.getCell(2).value || ""),
                 depositAmount: parseFloat(row.getCell(3).value) || 0,
                 description: String(row.getCell(4).value || ""),
                 withdrawalAmount: parseFloat(row.getCell(5).value) || 0,
                 withdrawalCategory: String(row.getCell(6).value || "")
               });
             }
          }
        });

        Object.values(loadedData).forEach(v => {
           while(v.details.length < 10) {
             v.details.push({ no: v.details.length + 1, depositCategory: "", depositAmount: 0, description: "", withdrawalAmount: 0, withdrawalCategory: "" });
           }
        });

        if (Object.keys(loadedData).length === 0) {
           alert("有効な伝票データが見つかりませんでした。");
           return;
        }

        if (confirm("現在のデータを上書きしてExcelデータを読み込みますか？")) {
            voucherData = loadedData;
            autoSaveVoucherData();
            const dates = Object.keys(loadedData).sort();
            const firstDate = dates[0];
            if(firstDate) {
               const ym = firstDate.slice(0, 7);
               document.getElementById("monthSelector").value = ym;
               ensureVoucherDataForMonth(ym);
               populateDaySelector(ym);
               currentVoucherDate = firstDate;
               document.getElementById("daySelector").value = currentVoucherDate;
               loadVoucher(currentVoucherDate);
               recalcMonth();
            }
            alert("読み込み完了しました。");
        }
      } catch (err) {
        console.error(err);
        alert("Excel読み込みエラー: " + err.message);
      } finally {
        e.target.value = '';
        hideLoading();
      }
    });
    
    document.getElementById("jsonSaveBtn").addEventListener("click", () => {
      const dataToSave = { voucherData: voucherData, syncRows: syncRows };
      const jsonStr = JSON.stringify(dataToSave, null, 2);
      const dataUri = "data:application/json;charset=utf-8," + encodeURIComponent(jsonStr);
      const link = document.createElement("a");
      link.href = dataUri;
      link.download = "入出金伝票_バックアップ.json";
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    });
    document.getElementById("jsonLoadBtn").addEventListener("click", () => document.getElementById("jsonLoadInput").click());
    document.getElementById("jsonLoadInput").addEventListener("change", e => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(event) {
        try {
          const loadedData = JSON.parse(event.target.result);
          if (loadedData.voucherData) {
            if (confirm("JSONからデータを復元しますか？")) {
              voucherData = loadedData.voucherData;
              if(loadedData.syncRows) syncRows = loadedData.syncRows;
              autoSaveVoucherData();
              initApp();
              alert("復元しました。");
            }
          }
        } catch(e) { alert("JSON読み込みエラー"); }
      };
      reader.readAsText(file);
      e.target.value = '';
    });
    document.getElementById("printBtn").addEventListener("click", () => window.print());
    
    window.addEventListener("load", initApp);
  </script>
</body>
</html>
