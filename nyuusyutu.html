
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>å…¥å‡ºé‡‘ä¼ç¥¨ã‚·ã‚¹ãƒ†ãƒ  Proç‰ˆï¼ˆå®Œå…¨ç‰ˆï¼‰</title>
  <script src="https://cdn.jsdelivr.net/npm/exceljs/dist/exceljs.min.js"></script>
  <style>
    * { box-sizing: border-box; }
    
    body { 
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
      margin: 0; 
      padding: 20px; 
      background-color: #f8f9fa;
      color: #333;
    }
    
    /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
    .app-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    
    .app-header h1 {
      margin: 0;
      font-size: 1.8em;
      font-weight: 600;
    }
    
    /* ãƒ‘ãƒãƒ«åŸºæœ¬ã‚¹ã‚¿ã‚¤ãƒ« */
    .panel {
      background: white;
      margin-bottom: 15px; 
      padding: 20px; 
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.08);
      border: 1px solid #e9ecef;
    }
    
    .panel h3 {
      margin-top: 0;
      margin-bottom: 15px;
      color: #495057;
      font-weight: 600;
      font-size: 1.1em;
      border-bottom: 2px solid #e9ecef;
      padding-bottom: 8px;
    }
    
    /* ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ‘ãƒãƒ« */
    #controlPanel {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 15px;
    }
    
    #controlPanel label {
      font-weight: 500;
      color: #495057;
    }
    
    #controlPanel input, #controlPanel select {
      padding: 8px 12px;
      border: 2px solid #dee2e6;
      border-radius: 5px;
      font-size: 14px;
      transition: border-color 0.2s;
    }
    
    #controlPanel input:focus, #controlPanel select:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    
    /* ãƒœã‚¿ãƒ³ã‚¹ã‚¿ã‚¤ãƒ« */
    .btn {
      padding: 8px 16px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.2s;
      text-decoration: none;
      display: inline-block;
      text-align: center;
    }
    
    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    
    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(102, 126, 234, 0.3);
    }
    
    .btn-secondary {
      background: #6c757d;
      color: white;
    }
    
    .btn-secondary:hover {
      background: #545b62;
      transform: translateY(-1px);
    }
    
    .btn-warning {
      background: #ffc107;
      color: #212529;
    }
    
    .btn-warning:hover {
      background: #e0a800;
      transform: translateY(-1px);
    }
    
    .btn-danger {
      background: #dc3545;
      color: white;
    }
    
    .btn-danger:hover {
      background: #c82333;
      transform: translateY(-1px);
    }
    
    .btn-success {
      background: #28a745;
      color: white;
    }
    
    .btn-success:hover {
      background: #218838;
      transform: translateY(-1px);
    }
    
    .btn-info {
      background: #17a2b8;
      color: white;
    }
    
    .btn-info:hover {
      background: #138496;
      transform: translateY(-1px);
    }
    
    /* ãƒ“ãƒ¥ãƒ¼åˆ‡ã‚Šæ›¿ãˆãƒœã‚¿ãƒ³ */
    #viewModeToggle {
      display: flex;
      border-radius: 5px;
      overflow: hidden;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    #viewModeToggle button {
      padding: 10px 20px;
      border: none;
      background: #e9ecef;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.2s;
    }
    
    #viewModeToggle button.active {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    
    #viewModeToggle button:hover:not(.active) {
      background: #dee2e6;
    }
    
    /* æœˆæ¬¡ãƒ“ãƒ¥ãƒ¼ã¨æ—¥æ¬¡ãƒ“ãƒ¥ãƒ¼ã®ã‚³ãƒ³ãƒ†ãƒŠ */
    .voucher-container {
      background: white;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.08);
    }
    
    /* æ—¥ã”ã¨ã®ä¼ç¥¨ã‚«ãƒ¼ãƒ‰ */
    .daily-voucher-card {
      margin-bottom: 25px;
      border: 1px solid #e9ecef;
      padding: 20px;
      border-radius: 8px;
      background: #ffffff;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      transition: box-shadow 0.2s;
    }
    
    .daily-voucher-card:hover {
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    /* æ—¥ã”ã¨ã®ã‚µãƒãƒªãƒ¼ãƒ‘ãƒãƒ« */
    .daily-summary-panel {
      display: grid;
      grid-template-columns: 2fr 1fr 1fr 1fr 1fr;
      gap: 15px;
      padding: 15px;
      margin-bottom: 15px;
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      border-radius: 6px;
      font-weight: 600;
      border: 2px solid #dee2e6;
    }
    
    .daily-summary-panel > div {
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
    }
    
    .daily-summary-panel > div:first-child {
      align-items: flex-start;
      text-align: left;
    }
    
    .daily-summary-panel .label {
      font-size: 0.85em;
      color: #6c757d;
      margin-bottom: 5px;
    }
    
    .daily-summary-panel .value {
      font-size: 1.1em;
      color: #495057;
    }
    
    /* å‰æ—¥æ®‹é«˜å…¥åŠ›æ¬„ */
    .prev-balance-input {
      width: 120px;
      font-weight: 600;
      text-align: right;
      border: 2px solid #dee2e6;
      border-radius: 4px;
      padding: 5px 8px;
      background: #fff;
      transition: border-color 0.2s;
    }
    
    .prev-balance-input:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    
    /* æ˜ç´°ãƒ†ãƒ¼ãƒ–ãƒ« */
    .voucher-details-table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 10px;
      background: white;
      border-radius: 6px;
      overflow: hidden;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    .voucher-details-table th {
      background: linear-gradient(135deg, #495057 0%, #6c757d 100%);
      color: white;
      padding: 12px 8px;
      text-align: center;
      font-weight: 600;
      font-size: 0.9em;
    }
    
    .voucher-details-table td {
      border: 1px solid #dee2e6;
      padding: 8px;
      text-align: center;
    }
    
    .voucher-details-table tbody tr:nth-child(even) {
      background-color: #f8f9fa;
    }
    
    .voucher-details-table tbody tr:hover {
      background-color: #e8f4f8;
    }
    
    .voucher-details-table input[type="text"] {
      width: 100%;
      border: 2px solid transparent;
      padding: 6px 8px;
      background: transparent;
      border-radius: 4px;
      transition: all 0.2s;
    }
    
    .voucher-details-table input[type="text"]:focus {
      outline: none;
      border-color: #667eea;
      background: white;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    
    /* ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªè¡Œã®ãƒã‚¤ãƒ©ã‚¤ãƒˆ */
    .voucher-details-table tr.active-row {
      background-color: #fff3cd !important;
      box-shadow: inset 0 0 0 2px #ffc107;
    }
    
    .voucher-details-table tr.active-row td {
      border-color: #ffc107;
    }
    
    /* æ¤œç´¢çµæœã®ãƒã‚¤ãƒ©ã‚¤ãƒˆ */
    .highlight-cell {
      background-color: #fff3cd !important;
      animation: highlight-pulse 2s ease-in-out;
    }
    
    @keyframes highlight-pulse {
      0%, 100% { background-color: #fff3cd; }
      50% { background-color: #ffecb5; }
    }
    
    /* ç„¡åŠ¹åŒ–ã•ã‚ŒãŸå…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ */
    .disabled-input {
      background-color: #f8f9fa !important;
      color: #6c757d;
      cursor: not-allowed;
    }
    
    /* å‡¦ç†ä¸­ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
    #loadingOverlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      z-index: 1000;
      display: none;
      justify-content: center;
      align-items: center;
      backdrop-filter: blur(2px);
    }
    
    .loading-content {
      background: white;
      padding: 30px;
      border-radius: 10px;
      text-align: center;
      box-shadow: 0 10px 25px rgba(0,0,0,0.3);
    }
    
    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 4px solid #f3f3f3;
      border-top: 4px solid #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 15px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* è¨­å®šãƒ‘ãƒãƒ« */
    #settingsPanel {
      background: white;
      border-radius: 8px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      max-width: 500px;
    }
    
    #settingsPanel .checkbox-group {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 10px;
      margin-bottom: 20px;
    }
    
    #settingsPanel label {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px;
      border: 2px solid #dee2e6;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    #settingsPanel label:hover {
      border-color: #667eea;
      background: #f8f9ff;
    }
    
    #settingsPanel input[type="checkbox"]:checked + span {
      color: #667eea;
      font-weight: 600;
    }
    
    #quickDescInput {
      width: 100%;
      padding: 12px;
      border: 2px solid #dee2e6;
      border-radius: 6px;
      font-family: inherit;
      resize: vertical;
      min-height: 120px;
    }
    
    #quickDescInput:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    
    /* ã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒ‘ãƒãƒ« */
    #importPanel {
      background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
      border: 2px solid #2196f3;
    }
    
    /* æ¤œç´¢ãƒ‘ãƒãƒ« */
    #searchPanel {
      background: linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%);
      border: 2px solid #9c27b0;
    }
    
    #searchKeyword {
      flex: 1;
      min-width: 250px;
      padding: 10px 15px;
      border: 2px solid #dee2e6;
      border-radius: 6px;
      font-size: 16px;
    }
    
    .search-controls {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }
    
    /* æ¤œç´¢çµæœ */
    .search-result-item {
      margin-bottom: 8px;
      padding: 10px;
      background: white;
      border-radius: 4px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      display: flex;
      align-items: center;
      gap: 15px;
    }
    
    .search-result-item a {
      color: #667eea;
      text-decoration: none;
      font-weight: 500;
      padding: 5px 10px;
      border-radius: 4px;
      transition: all 0.2s;
    }
    
    .search-result-item a:hover {
      background: #667eea;
      color: white;
    }
    
    /* ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒ‘ãƒãƒ« */
    #actionPanel .button-group {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
    }
    
    /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ãƒ‡ã‚¶ã‚¤ãƒ³ */
    @media (max-width: 768px) {
      body {
        padding: 10px;
      }
      
      .daily-summary-panel {
        grid-template-columns: 1fr;
        text-align: center;
      }
      
      .voucher-details-table {
        font-size: 0.85em;
      }
      
      .voucher-details-table th,
      .voucher-details-table td {
        padding: 6px 4px;
      }
      
      #controlPanel {
        flex-direction: column;
        align-items: stretch;
      }
      
      #settingsPanel .checkbox-group {
        grid-template-columns: repeat(2, 1fr);
      }
    }
    
    /* å°åˆ·ã‚¹ã‚¿ã‚¤ãƒ« */
    @media print {
      body {
        background: white;
        padding: 0;
      }
      
      .panel, .voucher-container {
        box-shadow: none;
        border: 1px solid #000;
      }
      
      #controlPanel, #searchPanel, #actionPanel, #settingsPanel, 
      #loadingOverlay, #importPanel, .app-header {
        display: none !important;
      }
      
      .daily-voucher-card {
        page-break-inside: avoid;
        margin-bottom: 20px;
      }
      
      .voucher-details-table {
        font-size: 10pt;
      }
    }
    
    /* ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ— */
    [data-tooltip] {
      position: relative;
      cursor: help;
    }
    
    [data-tooltip]:hover::after {
      content: attr(data-tooltip);
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      background: #333;
      color: white;
      padding: 8px 12px;
      border-radius: 4px;
      font-size: 12px;
      white-space: nowrap;
      z-index: 1000;
      margin-bottom: 5px;
    }
    
    [data-tooltip]:hover::before {
      content: '';
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      border: 5px solid transparent;
      border-top-color: #333;
      z-index: 1000;
    }
    
    /* æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ */
    .success-message {
      background: #d4edda;
      color: #155724;
      padding: 12px 20px;
      border-radius: 6px;
      border: 1px solid #c3e6cb;
      margin: 10px 0;
      animation: slideDown 0.3s ease-out;
    }
    
    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    /* ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ */
    .error-message {
      background: #f8d7da;
      color: #721c24;
      padding: 12px 20px;
      border-radius: 6px;
      border: 1px solid #f5c6cb;
      margin: 10px 0;
      animation: slideDown 0.3s ease-out;
    }
  </style>
</head>
<body>

  <div class="app-header">
    <h1>ğŸ“Š å…¥å‡ºé‡‘ä¼ç¥¨ã‚·ã‚¹ãƒ†ãƒ  Proç‰ˆ</h1>
    <p style="margin: 5px 0 0 0; opacity: 0.9;">é«˜æ©Ÿèƒ½ãªå…¥å‡ºé‡‘ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  - Excelé€£æºãƒ»æ¤œç´¢ãƒ»ãƒ‡ãƒ¼ã‚¿åŒæœŸå¯¾å¿œ</p>
  </div>

  <div id="controlPanel" class="panel">
    <div style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
      <div>
        <label for="monthSelector">ğŸ“… å¯¾è±¡æœˆï¼š</label>
        <input type="month" id="monthSelector" class="form-control">
      </div>
      
      <div id="dailyControls" style="display:none;">
        <label for="daySelector">ğŸ“† æ—¥ä»˜ï¼š</label>
        <select id="daySelector" class="form-control"></select>
        <button id="prevDayBtn" class="btn btn-secondary" data-tooltip="å‰ã®æ—¥ã«ç§»å‹•">â—€ å‰æ—¥</button>
        <button id="nextDayBtn" class="btn btn-secondary" data-tooltip="æ¬¡ã®æ—¥ã«ç§»å‹•">ç¿Œæ—¥ â–¶</button>
      </div>

      <div id="viewModeToggle">
        <button id="monthViewBtn" class="active" data-tooltip="æœˆå…¨ä½“ã‚’è¡¨ç¤º">ğŸ“Š æœˆæ¬¡ãƒ“ãƒ¥ãƒ¼</button>
        <button id="dayViewBtn" data-tooltip="1æ—¥å˜ä½ã§è¡¨ç¤º">ğŸ“‹ æ—¥æ¬¡ãƒ“ãƒ¥ãƒ¼</button>
      </div>
      
      <button id="settingsBtn" class="btn btn-info" data-tooltip="ã‚·ã‚¹ãƒ†ãƒ è¨­å®š">âš™ï¸ è¨­å®š</button>
    </div>
  </div>

  <div id="settingsPanel" class="panel" style="display:none;">
    <h3>âš™ï¸ ã‚·ã‚¹ãƒ†ãƒ è¨­å®š</h3>
    
    <h4>ğŸ”— å›ºå®šæ‘˜è¦åŒæœŸè¨­å®š</h4>
    <p style="color: #6c757d; font-size: 0.9em;">é¸æŠã•ã‚ŒãŸè¡Œã®æ‘˜è¦ã¯ã€æ¯æœˆ1æ—¥ã®æ‘˜è¦ã¨è‡ªå‹•åŒæœŸã•ã‚Œã¾ã™ã€‚</p>
    <form id="syncForm">
      <div class="checkbox-group">
        <label><input type="checkbox" name="syncRow" value="0"><span>è¡Œ1</span></label>
        <label><input type="checkbox" name="syncRow" value="1"><span>è¡Œ2</span></label>
        <label><input type="checkbox" name="syncRow" value="2"><span>è¡Œ3</span></label>
        <label><input type="checkbox" name="syncRow" value="3"><span>è¡Œ4</span></label>
        <label><input type="checkbox" name="syncRow" value="4"><span>è¡Œ5</span></label>
        <label><input type="checkbox" name="syncRow" value="5"><span>è¡Œ6</span></label>
        <label><input type="checkbox" name="syncRow" value="6"><span>è¡Œ7</span></label>
        <label><input type="checkbox" name="syncRow" value="7"><span>è¡Œ8</span></label>
        <label><input type="checkbox" name="syncRow" value="8"><span>è¡Œ9</span></label>
        <label><input type="checkbox" name="syncRow" value="9"><span>è¡Œ10</span></label>
      </div>
    </form>
    
    <h4>ğŸ·ï¸ æ‘˜è¦ã‚¯ã‚¤ãƒƒã‚¯å…¥åŠ›è¨­å®š</h4>
    <p style="color: #6c757d; font-size: 0.9em;">ä¸€è¡Œã«ä¸€ã¤ã®æ‘˜è¦ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚å…¥åŠ›æ™‚ã«å€™è£œã¨ã—ã¦è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</p>
    <textarea id="quickDescInput" placeholder="ä¾‹ï¼š&#10;é£Ÿè²»&#10;äº¤é€šè²»&#10;äº‹å‹™ç”¨å“&#10;é€šä¿¡è²»"></textarea>
    <div style="margin-top: 10px;">
      <button type="button" id="saveQuickDescBtn" class="btn btn-success">ğŸ’¾ æ‘˜è¦ã‚’ä¿å­˜</button>
    </div>
    
    <hr style="margin: 20px 0;">
    
    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
      <button type="button" id="deleteAllDataBtn" class="btn btn-danger">ğŸ—‘ï¸ å…¨ãƒ‡ãƒ¼ã‚¿å‰Šé™¤</button>
      <button type="button" id="closeSettingsBtn" class="btn btn-secondary">âœ–ï¸ é–‰ã˜ã‚‹</button>
    </div>
  </div>
  
  <div id="importPanel" class="panel">
    <h3>ğŸ“ˆ å£²ä¸Šãƒ‡ãƒ¼ã‚¿é€£æº</h3>
    <p>å£²ä¸Šè©³ç´°CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ã€å…¥é‡‘(å£²ä¸Š)ã¨å‡ºé‡‘(å£²æ›è¨ˆ)ã‚’è‡ªå‹•åæ˜ ã—ã¾ã™ã€‚</p>
    <input type="file" id="salesCsvInput" accept=".csv" style="display:none;">
    <button id="salesCsvLoadBtn" class="btn btn-info">ğŸ“ å£²ä¸Šç®¡ç†è¡¨CSVèª­è¾¼</button>
  </div>

  <div id="voucherCard" class="panel">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
      <h2 id="voucherHeader">ğŸ“„ ä¼ç¥¨ãƒ“ãƒ¥ãƒ¼</h2>
      <button id="clearViewBtn" class="btn btn-warning" data-tooltip="è¡¨ç¤ºä¸­ã®ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢">ğŸ§¹ ã‚¯ãƒªã‚¢</button>
    </div>
    
    <div id="monthlyVoucherContainer" class="voucher-container"></div>
    <div id="dailyVoucherContainer" class="voucher-container" style="display:none;">
      <div class="daily-voucher-card" id="singleDailyCard"></div>
    </div>
  </div>

  <div id="searchPanel" class="panel">
    <h3>ğŸ” ãƒ‡ãƒ¼ã‚¿æ¤œç´¢</h3>
    <div class="search-controls">
      <input type="text" id="searchKeyword" placeholder="ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰å…¥åŠ›ï¼ˆæ‘˜è¦ã€ç§‘ç›®ã€é‡‘é¡ãªã©ï¼‰">
      <button id="searchBtn" class="btn btn-primary">ğŸ” æ¤œç´¢</button>
      <button id="clearSearchBtn" class="btn btn-secondary">âŒ ã‚¯ãƒªã‚¢</button>
    </div>
    <div id="searchResults" style="margin-top: 15px;"></div>
  </div>

  <div id="actionPanel" class="panel">
    <h3>ğŸ’¾ ãƒ‡ãƒ¼ã‚¿æ“ä½œ</h3>
    <div class="button-group">
      <button id="excelSaveBtn" class="btn btn-success" data-tooltip="Excelå½¢å¼ã§ä¿å­˜">ğŸ“Š Excelä¿å­˜</button>
      <input type="file" id="excelLoadInput" accept=".xlsx" style="display:none;">
      <button id="excelLoadBtn" class="btn btn-primary" data-tooltip="Excelå½¢å¼ã§èª­ã¿è¾¼ã¿">ğŸ“‚ Excelèª­ã¿è¾¼ã¿</button>
      
      <button id="jsonSaveBtn" class="btn btn-info" data-tooltip="JSONå½¢å¼ã§ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—">ğŸ’¾ JSONä¿å­˜</button>
      <input type="file" id="jsonLoadInput" accept=".json" style="display:none;">
      <button id="jsonLoadBtn" class="btn btn-secondary" data-tooltip="JSONãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‹ã‚‰å¾©å…ƒ">ğŸ“ JSONèª­ã¿è¾¼ã¿</button>
      
      <button id="printBtn" class="btn btn-warning" data-tooltip="å°åˆ·ç”¨ç”»é¢">ğŸ–¨ï¸ å°åˆ·</button>
    </div>
  </div>
  
  <div id="loadingOverlay">
    <div class="loading-content">
      <div class="loading-spinner"></div>
      <p id="loadingText">å‡¦ç†ä¸­...</p>
    </div>
  </div>

  <script>
    /**********************************************
     * ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ãƒ»ãƒ‡ãƒ¼ã‚¿æ§‹é€ 
     **********************************************/
    let voucherData = {};
    let syncRows = Array(10).fill(false);
    let quickDescriptions = [];
    let currentMonth = ""; 
    let currentVoucherDate = ""; 
    let viewMode = 'month';

    /**********************************************
     * ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
     **********************************************/
    
    // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
    function showSuccessMessage(message) {
      const msgDiv = document.createElement('div');
      msgDiv.className = 'success-message';
      msgDiv.textContent = message;
      document.body.appendChild(msgDiv);
      setTimeout(() => {
        msgDiv.remove();
      }, 3000);
    }
    
    // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
    function showErrorMessage(message) {
      const msgDiv = document.createElement('div');
      msgDiv.className = 'error-message';
      msgDiv.textContent = message;
      document.body.appendChild(msgDiv);
      setTimeout(() => {
        msgDiv.remove();
      }, 5000);
    }

    // å‡¦ç†ä¸­ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
    function showLoading(text = "å‡¦ç†ä¸­...") {
      document.getElementById("loadingText").textContent = text;
      document.getElementById("loadingOverlay").style.display = "flex";
    }
    
    function hideLoading() {
      document.getElementById("loadingOverlay").style.display = "none";
    }

    // æ•°å€¤ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼‰
    function formatNumber(num) {
      if (num === 0 || num === '' || num == null) return '';
      return parseFloat(num).toLocaleString('ja-JP');
    }
    
    // æ•°å€¤ãƒ‘ãƒ¼ã‚¹ï¼ˆã‚«ãƒ³ãƒé™¤å»ï¼‰
    function parseNumber(str) {
      if (!str || str === '') return 0;
      return parseFloat(String(str).replace(/,/g, '')) || 0;
    }

    /**********************************************
     * åˆæœŸåŒ–ãƒ»ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å‡¦ç†
     **********************************************/
    function initApp() {
      try {
        // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
        const storedVoucherData = localStorage.getItem("voucherData");
        if (storedVoucherData) {
          voucherData = JSON.parse(storedVoucherData);
        }
        
        const storedSyncRows = localStorage.getItem("syncRows");
        if (storedSyncRows) {
          syncRows = JSON.parse(storedSyncRows);
        }
        
        const storedQuickDesc = localStorage.getItem("quickDescriptions");
        if (storedQuickDesc) {
          quickDescriptions = JSON.parse(storedQuickDesc);
        }

        // è¨­å®šç”»é¢ã®åŒæœŸè¡Œãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹è¨­å®š
        document.querySelectorAll("#syncForm input[type=checkbox]").forEach((chk, index) => {
          chk.checked = syncRows[index];
        });

        // æœˆé¸æŠã®åˆæœŸè¨­å®š
        const monthSelector = document.getElementById("monthSelector");
        const now = new Date();
        currentMonth = now.toISOString().slice(0, 7);
        monthSelector.value = currentMonth;

        // å½“æœˆãƒ‡ãƒ¼ã‚¿ã®æº–å‚™
        ensureVoucherDataForMonth(currentMonth);
        
        // æ—¥é¸æŠã®åˆæœŸè¨­å®š
        populateDaySelector(currentMonth);
        currentVoucherDate = currentMonth + "-01";
        document.getElementById("daySelector").value = currentVoucherDate;

        // è¨ˆç®—ã¨ç”»é¢æ›´æ–°
        recalcMonth();
        updateView();
        renderDatalist();
        
        showSuccessMessage("ã‚·ã‚¹ãƒ†ãƒ ã‚’åˆæœŸåŒ–ã—ã¾ã—ãŸ");
      } catch (error) {
        console.error("åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:", error);
        showErrorMessage("ã‚·ã‚¹ãƒ†ãƒ ã®åˆæœŸåŒ–ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ");
      }
    }

    function ensureVoucherDataForMonth(month) {
      try {
        const [year, monthNum] = month.split("-");
        const daysInMonth = new Date(parseInt(year), parseInt(monthNum), 0).getDate();

        for (let d = 1; d <= daysInMonth; d++) {
          const dayStr = String(d).padStart(2, "0");
          const dateStr = `${month}-${dayStr}`;

          if (!voucherData[dateStr]) {
            voucherData[dateStr] = {
              date: dateStr,
              prevBalance: 0,
              deposit: 0,
              withdrawal: 0,
              balance: 0,
              details: []
            };
            
            for (let i = 0; i < 10; i++) {
              voucherData[dateStr].details.push({
                no: i + 1,
                depositCategory: "",
                depositAmount: 0,
                description: "",
                withdrawalAmount: 0,
                withdrawalCategory: ""
              });
            }
          }
        }
        autoSaveVoucherData();
      } catch (error) {
        console.error("æœˆãƒ‡ãƒ¼ã‚¿ç”Ÿæˆã‚¨ãƒ©ãƒ¼:", error);
        showErrorMessage("æœˆãƒ‡ãƒ¼ã‚¿ã®ç”Ÿæˆã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ");
      }
    }
    
    function populateDaySelector(month) {
      const selector = document.getElementById("daySelector");
      selector.innerHTML = "";
      const [year, monthNum] = month.split("-");
      const daysInMonth = new Date(parseInt(year), parseInt(monthNum), 0).getDate();

      for (let d = 1; d <= daysInMonth; d++) {
        const dayStr = String(d).padStart(2, "0");
        const date = `${month}-${dayStr}`;
        const option = document.createElement("option");
        option.value = date;
        option.textContent = date;
        selector.appendChild(option);
      }
      
      if (!selector.querySelector(`option[value="${currentVoucherDate}"]`)) {
        currentVoucherDate = month + "-01";
      }
      selector.value = currentVoucherDate;
    }

    function autoSaveVoucherData() {
      try {
        localStorage.setItem("voucherData", JSON.stringify(voucherData));
        localStorage.setItem("syncRows", JSON.stringify(syncRows));
        localStorage.setItem("quickDescriptions", JSON.stringify(quickDescriptions));
      } catch (error) {
        console.error("ä¿å­˜ã‚¨ãƒ©ãƒ¼:", error);
        showErrorMessage("ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ");
      }
    }

    function recalcMonth() {
      try {
        const dates = Object.keys(voucherData).sort();
        
        for (let i = 0; i < dates.length; i++) {
          const currentDate = dates[i];
          const voucher = voucherData[currentDate];
          if (!voucher) continue;

          // å‰æ—¥æ®‹é«˜ã®è¨­å®š
          if (i > 0) {
            const prevVoucher = voucherData[dates[i-1]];
            if (prevVoucher) {
              voucher.prevBalance = prevVoucher.balance;
            }
          }
          
          recalcVoucher(currentDate);
        }
        
        updateView(); 
        autoSaveVoucherData();
      } catch (error) {
        console.error("è¨ˆç®—ã‚¨ãƒ©ãƒ¼:", error);
        showErrorMessage("è¨ˆç®—å‡¦ç†ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ");
      }
    }

    function recalcVoucher(date) {
      const voucher = voucherData[date];
      if (!voucher) return;
      
      let totalDep = 0, totalWithdraw = 0;

      voucher.details.forEach(row => {
        totalDep += parseNumber(row.depositAmount);
        totalWithdraw += parseNumber(row.withdrawalAmount);
      });

      voucher.deposit = totalDep;
      voucher.withdrawal = totalWithdraw;
      voucher.balance = voucher.prevBalance + totalDep - totalWithdraw; 
    }

    function syncDescription(rowIndex) {
      try {
        const masterDate = `${currentMonth}-01`;
        if (!voucherData[masterDate]) return;
        
        const masterDescription = voucherData[masterDate].details[rowIndex].description;

        Object.keys(voucherData).forEach(date => {
          if (date.startsWith(currentMonth) && syncRows[rowIndex]) {
            voucherData[date].details[rowIndex].description = masterDescription;
          }
        });
        
        updateView();
        autoSaveVoucherData();
      } catch (error) {
        console.error("åŒæœŸã‚¨ãƒ©ãƒ¼:", error);
        showErrorMessage("æ‘˜è¦åŒæœŸã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ");
      }
    }
    
    function renderDatalist() {
      let datalist = document.getElementById('quickDescList');
      if (!datalist) {
        datalist = document.createElement('datalist');
        datalist.id = 'quickDescList';
        document.body.appendChild(datalist);
      }
      
      datalist.innerHTML = quickDescriptions
        .filter(desc => desc.trim() !== '')
        .map(desc => `<option value="${desc}">`)
        .join('');
    }

    /**********************************************
     * ãƒ“ãƒ¥ãƒ¼ã®åˆ‡ã‚Šæ›¿ãˆã¨ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
     **********************************************/
     
    function updateView(searchKeyword = null) {
      try {
        renderDatalist();

        // ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ‘ãƒãƒ«ã®è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
        document.getElementById('monthlyVoucherContainer').style.display = 'none';
        document.getElementById('dailyVoucherContainer').style.display = 'none';
        document.getElementById('dailyControls').style.display = 'none';
        document.getElementById('monthViewBtn').classList.remove('active');
        document.getElementById('dayViewBtn').classList.remove('active');

        if (viewMode === 'month') {
          document.getElementById('voucherHeader').textContent = `ğŸ“Š æœˆæ¬¡ä¼ç¥¨ãƒ“ãƒ¥ãƒ¼: ${currentMonth}`;
          document.getElementById('monthlyVoucherContainer').style.display = 'block';
          document.getElementById('monthViewBtn').classList.add('active');
          document.getElementById('clearViewBtn').textContent = 'ğŸ§¹ è¡¨ç¤ºä¸­ã®æœˆã‚’ã‚¯ãƒªã‚¢';
          renderMonthView(currentMonth, searchKeyword);
        } else {
          document.getElementById('voucherHeader').textContent = `ğŸ“‹ ä¼ç¥¨: ${currentVoucherDate}`;
          document.getElementById('dailyVoucherContainer').style.display = 'block';
          document.getElementById('dailyControls').style.display = 'inline';
          document.getElementById('dayViewBtn').classList.add('active');
          document.getElementById('clearViewBtn').textContent = 'ğŸ§¹ è¡¨ç¤ºä¸­ã®ä¼ç¥¨ã‚’ã‚¯ãƒªã‚¢';
          renderViewDetails(currentVoucherDate, 'singleDailyCard', searchKeyword);
        }
      } catch (error) {
        console.error("ãƒ“ãƒ¥ãƒ¼æ›´æ–°ã‚¨ãƒ©ãƒ¼:", error);
        showErrorMessage("ç”»é¢ã®æ›´æ–°ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ");
      }
    }

    function renderMonthView(month, searchKeyword = null) {
      const container = document.getElementById("monthlyVoucherContainer");
      container.innerHTML = "";
      
      const sortedDatesForMonth = Object.keys(voucherData)
        .filter(date => date.startsWith(month))
        .sort();
      
      const keyword = searchKeyword ? searchKeyword.toLowerCase() : null;

      sortedDatesForMonth.forEach(date => {
        const dailyCardHtml = renderViewDetails(date, null, keyword, true);
        const dailyCard = document.createElement("div");
        dailyCard.classList.add("daily-voucher-card");
        dailyCard.dataset.date = date;
        dailyCard.innerHTML = dailyCardHtml;
        container.appendChild(dailyCard);
      });
      
      attachInputListeners(month);
    }
    
    function renderViewDetails(date, containerId, searchKeyword = null, isMonthlyView = false) {
      const voucher = voucherData[date];
      if (!voucher) return "";
      
      const isFirstDayOfMonth = date.endsWith("-01");
      const keyword = searchKeyword ? searchKeyword.toLowerCase() : null;
      
      let container = null;
      if (containerId) {
        container = document.getElementById(containerId);
        if (!container) return;
      }
      
      const prevBalanceDisplay = formatNumber(voucher.prevBalance);

      let summaryHtml = `
        <div class="daily-summary-panel">
          <div>
            <div class="label">ğŸ“… æ—¥ä»˜</div>
            <div class="value">${date}</div>
          </div>
          <div id="prevBalanceContainer_${date}">
            <div class="label">ğŸ’° å‰æ—¥æ®‹é«˜</div>
            <div class="value">
              ${(isFirstDayOfMonth || !isMonthlyView) ? 
                `<input type="text" class="prev-balance-input" data-date="${date}" value="${prevBalanceDisplay}" 
                    placeholder="0"
                    onfocus="this.value = String(this.value).replace(/,/g, ''); this.select();"
                    onblur="updatePrevBalance(this, '${date}');">` :
                `<span id="prevBalanceField_${date}">${formatNumber(voucher.prevBalance)}</span>`
              }
            </div>
          </div>
          <div>
            <div class="label">ğŸ“ˆ æœ¬æ—¥å…¥é‡‘</div>
            <div class="value" id="depositTotal_${date}">${formatNumber(voucher.deposit)}</div>
          </div>
          <div>
            <div class="label">ğŸ“‰ æœ¬æ—¥å‡ºé‡‘</div>
            <div class="value" id="withdrawalTotal_${date}">${formatNumber(voucher.withdrawal)}</div>
          </div>
          <div>
            <div class="label">ğŸ’³ æœ¬æ—¥æ®‹é«˜</div>
            <div class="value" id="balance_${date}" style="color: ${voucher.balance >= 0 ? '#28a745' : '#dc3545'}; font-weight: bold;">
              ${formatNumber(voucher.balance)}
            </div>
          </div>
        </div>
      `;
        
      let tableHtml = `
        <table class="voucher-details-table" data-date="${date}">
          <thead>
            <tr>
              <th style="width: 60px;">No.</th>
              <th style="width: 120px;">ğŸ“ˆ å…¥é‡‘ç§‘ç›®</th>
              <th style="width: 100px;">ğŸ’° å…¥é‡‘é‡‘é¡</th>
              <th style="width: 200px;">ğŸ“ æ‘˜è¦</th>
              <th style="width: 100px;">ğŸ’° å‡ºé‡‘é‡‘é¡</th>
              <th style="width: 120px;">ğŸ“‰ å‡ºé‡‘ç§‘ç›®</th>
            </tr>
          </thead>
          <tbody>
      `;

      voucher.details.forEach((row, index) => {
        const isSync = syncRows[index];
        let descValue = row.description;
        
        if (isSync) {
          const masterVoucher = voucherData[`${date.slice(0, 7)}-01`];
          if (masterVoucher) {
            descValue = masterVoucher.details[index].description;
            row.description = descValue; 
          }
        }
        
        const isDescReadOnly = isSync && !date.endsWith("-01");
        const syncIcon = isSync ? "ğŸ”— " : "";

        tableHtml += `
          <tr data-row="${index}">
            <td${keyword && String(row.no).includes(keyword) ? ' class="highlight-cell"' : ''}>${row.no}</td>
            ${createInputCellHtml(date, "text", row.depositCategory, index, "1", keyword)}
            ${createInputCellHtml(date, "number", row.depositAmount, index, "2", keyword)}
            ${createInputCellHtml(date, "text", syncIcon + descValue, index, "3", keyword, isDescReadOnly, true)}
            ${createInputCellHtml(date, "number", row.withdrawalAmount, index, "4", keyword)}
            ${createInputCellHtml(date, "text", row.withdrawalCategory, index, "5", keyword)}
          </tr>
        `;
      });

      tableHtml += `</tbody></table>`;
      
      const finalHtml = summaryHtml + tableHtml;
      
      if (container) {
        container.innerHTML = finalHtml;
        attachInputListeners(date.slice(0, 7));
      } else {
        return finalHtml;
      }
    }
    
    function createInputCellHtml(date, type, value, rowIndex, colIndex, keyword, readOnly = false, isDescription = false) {
      let displayValue;
      
      if (type === "number") {
        const numValue = parseNumber(value);
        displayValue = formatNumber(numValue);
      } else {
        displayValue = String(value);
      }

      const readOnlyAttr = readOnly ? 'readonly' : '';
      const disabledClass = readOnly ? 'disabled-input' : '';
      const cellClass = (keyword && String(value).toLowerCase().includes(keyword.toLowerCase())) ? ' class="highlight-cell"' : '';
      const datalistAttr = isDescription ? 'list="quickDescList"' : '';
      const placeholder = type === "number" ? "0" : "";

      return `
        <td${cellClass}>
          <input type="text" value="${displayValue}" 
                 data-date="${date}" data-row="${rowIndex}" data-col="${colIndex}" data-type="${type}"
                 ${readOnlyAttr} class="${disabledClass}" ${datalistAttr} placeholder="${placeholder}">
        </td>
      `;
    }
    
    // å‰æ—¥æ®‹é«˜ã®æ›´æ–°å‡¦ç†
    window.updatePrevBalance = function(inputElement, date) {
      try {
        const numValue = parseNumber(inputElement.value);
        const voucher = voucherData[date];
        
        if ((date.endsWith("-01") || viewMode === 'day') && voucher.prevBalance !== numValue) {
          voucher.prevBalance = numValue;
          recalcMonth(); 
        }
        
        inputElement.value = formatNumber(numValue);
      } catch (error) {
        console.error("å‰æ—¥æ®‹é«˜æ›´æ–°ã‚¨ãƒ©ãƒ¼:", error);
        showErrorMessage("å‰æ—¥æ®‹é«˜ã®æ›´æ–°ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ");
      }
    };

    function attachInputListeners(month) {
      const selector = viewMode === 'month' ? `#monthlyVoucherContainer input` : `#dailyVoucherContainer input`;
      
      document.querySelectorAll(selector).forEach(input => {
        const date = input.dataset.date;
        const rowIndex = parseInt(input.dataset.row);
        const colIndex = parseInt(input.dataset.col);
        const type = input.dataset.type;

        // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹æ™‚ã®å‡¦ç†
        input.addEventListener("focus", (e) => {
          document.querySelectorAll(".active-row").forEach(tr => tr.classList.remove("active-row"));
          e.target.closest("tr").classList.add("active-row");
          
          if (type === "number") {
            const rawValue = String(e.target.value).replace(/,/g, '');
            e.target.value = rawValue;
            if (e.target.select) e.target.select();
          }
        });

        // æ•°å€¤å…¥åŠ›ã®å‡¦ç†
        if (type === "number") {
          input.addEventListener("blur", e => {
            try {
              const numValue = parseNumber(e.target.value);
              
              const voucher = voucherData[date];
              const detail = voucher.details[rowIndex];
              let changed = false;

              if (colIndex === 2 && detail.depositAmount !== numValue) {
                detail.depositAmount = numValue;
                changed = true;
              } else if (colIndex === 4 && detail.withdrawalAmount !== numValue) {
                detail.withdrawalAmount = numValue;
                changed = true;
              }

              e.target.value = formatNumber(numValue);

              if (changed) {
                recalcMonth();
              }
            } catch (error) {
              console.error("æ•°å€¤æ›´æ–°ã‚¨ãƒ©ãƒ¼:", error);
              showErrorMessage("æ•°å€¤ã®æ›´æ–°ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ");
            }
          });
        }
        
        // ãƒ†ã‚­ã‚¹ãƒˆå…¥åŠ›ã®å‡¦ç†
        if (type === "text") {
          input.addEventListener("change", e => {
            if (e.target.readOnly) return;
            
            try {
              let textValue = e.target.value;
              
              // åŒæœŸã‚¢ã‚¤ã‚³ãƒ³ã‚’é™¤å»
              if (textValue.startsWith("ğŸ”— ")) {
                textValue = textValue.substring(3);
              }
              
              const voucher = voucherData[date];
              const detail = voucher.details[rowIndex];
              let changed = false;

              if (colIndex === 1 && detail.depositCategory !== textValue) {
                detail.depositCategory = textValue;
                changed = true;
              } else if (colIndex === 3 && detail.description !== textValue) {
                detail.description = textValue;
                changed = true;
                if (date.endsWith("-01") && syncRows[rowIndex]) {
                  syncDescription(rowIndex);
                }
              } else if (colIndex === 5 && detail.withdrawalCategory !== textValue) {
                detail.withdrawalCategory = textValue;
                changed = true;
              }
              
              if (changed) {
                autoSaveVoucherData();
              }
            } catch (error) {
              console.error("ãƒ†ã‚­ã‚¹ãƒˆæ›´æ–°ã‚¨ãƒ©ãƒ¼:", error);
              showErrorMessage("ãƒ†ã‚­ã‚¹ãƒˆã®æ›´æ–°ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ");
            }
          });
        }

        // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³
        input.addEventListener("keydown", e => {
          const allDates = Object.keys(voucherData).sort();
          const currentDateIndex = allDates.indexOf(date);
          
          let nextRow = rowIndex;
          let nextCol = colIndex;
          let nextDate = date;
          let move = false;

          switch (e.key) {
            case "Enter":
            case "ArrowDown":
              e.preventDefault();
              nextRow = rowIndex + 1;
              if (nextRow > 9) { 
                const nextDateCandidate = allDates[currentDateIndex + 1];
                if (nextDateCandidate) {
                  nextDate = nextDateCandidate;
                  nextRow = 0;
                } else { 
                  nextRow = 9; 
                }
              }
              move = true;
              break;
              
            case "ArrowUp":
              e.preventDefault();
              nextRow = rowIndex - 1;
              if (nextRow < 0) {
                const prevDate = allDates[currentDateIndex - 1];
                if (prevDate) {
                  nextDate = prevDate;
                  nextRow = 9;
                } else { 
                  nextRow = 0; 
                }
              }
              move = true;
              break;
              
            case "ArrowLeft":
              e.preventDefault();
              nextCol = colIndex - 1;
              if (nextCol < 1) nextCol = 1;
              move = true;
              break;
              
            case "ArrowRight":
              e.preventDefault();
              nextCol = colIndex + 1;
              if (nextCol > 5) nextCol = 5;
              move = true;
              break;
              
            default:
              return;
          }

          if (move) {
            const nextInput = document.querySelector(`input[data-date='${nextDate}'][data-row='${nextRow}'][data-col='${nextCol}']`);
            if (nextInput) {
              nextInput.focus();
              if (nextInput.select) nextInput.select();
            }
          }
        });
      });
    }

    /**********************************************
     * ã‚¤ãƒ™ãƒ³ãƒˆå‡¦ç†ãƒ»ãƒœã‚¿ãƒ³æ©Ÿèƒ½
     **********************************************/
    
    // ãƒ“ãƒ¥ãƒ¼ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ
    document.getElementById("monthViewBtn").addEventListener("click", () => {
      viewMode = 'month';
      updateView();
    });
    
    document.getElementById("dayViewBtn").addEventListener("click", () => {
      viewMode = 'day';
      updateView();
    });

    // æœˆé¸æŠã®å¤‰æ›´
    document.getElementById("monthSelector").addEventListener("change", e => {
      try {
        const month = e.target.value;
        currentMonth = month;
        ensureVoucherDataForMonth(month);
        populateDaySelector(month);
        currentVoucherDate = month + "-01";
        document.getElementById("daySelector").value = currentVoucherDate;
        recalcMonth();
      } catch (error) {
        console.error("æœˆé¸æŠã‚¨ãƒ©ãƒ¼:", error);
        showErrorMessage("æœˆã®åˆ‡ã‚Šæ›¿ãˆã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ");
      }
    });

    // æ—¥æ¬¡ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼ã®å¤‰æ›´
    document.getElementById("daySelector").addEventListener("change", e => {
      currentVoucherDate = e.target.value;
      updateView();
    });
    
    // æ—¥æ¬¡ç§»å‹•ãƒœã‚¿ãƒ³
    document.getElementById("prevDayBtn").addEventListener("click", () => moveDay(-1));
    document.getElementById("nextDayBtn").addEventListener("click", () => moveDay(1));

    function moveDay(delta) {
      try {
        const date = new Date(currentVoucherDate + "T00:00:00");
        date.setDate(date.getDate() + delta);
        
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, "0");
        const day = String(date.getDate()).padStart(2, "0");
        const nextDate = `${year}-${month}-${day}`;
        const nextMonth = `${year}-${month}`;

        if (year < 1950 || year > 2099) return; 

        if (currentMonth !== nextMonth) {
          document.getElementById("monthSelector").value = nextMonth;
          currentMonth = nextMonth;
          ensureVoucherDataForMonth(nextMonth);
          populateDaySelector(nextMonth);
          recalcMonth();
        }

        if (voucherData[nextDate]) {
          currentVoucherDate = nextDate;
          document.getElementById("daySelector").value = nextDate;
          updateView();
        } 
      } catch (error) {
        console.error("æ—¥ç§»å‹•ã‚¨ãƒ©ãƒ¼:", error);
        showErrorMessage("æ—¥ä»˜ç§»å‹•ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ");
      }
    }

    // è¨­å®šé–¢é€£ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
    document.getElementById("settingsBtn").addEventListener("click", () => {
      document.getElementById("quickDescInput").value = quickDescriptions.join('\n');
      document.getElementById("settingsPanel").style.display = "block";
    });
    
    document.getElementById("saveQuickDescBtn").addEventListener("click", () => {
      try {
        const input = document.getElementById("quickDescInput").value;
        quickDescriptions = input.split('\n').map(desc => desc.trim()).filter(desc => desc !== '');
        autoSaveVoucherData();
        renderDatalist();
        showSuccessMessage("æ‘˜è¦ã‚’ä¿å­˜ã—ã¾ã—ãŸ");
      } catch (error) {
        console.error("æ‘˜è¦ä¿å­˜ã‚¨ãƒ©ãƒ¼:", error);
        showErrorMessage("æ‘˜è¦ã®ä¿å­˜ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ");
      }
    });
    
    document.getElementById("closeSettingsBtn").addEventListener("click", () => {
      // åŒæœŸè¨­å®šã‚’ä¿å­˜
      document.querySelectorAll("#syncForm input[type=checkbox]").forEach((chk, index) => {
        syncRows[index] = chk.checked;
      });
      
      document.getElementById("settingsPanel").style.display = "none";
      recalcMonth(); 
    });
    
    document.getElementById("deleteAllDataBtn").addEventListener("click", () => {
      if (confirm("âš ï¸ å…¨ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚")) {
        try {
          voucherData = {};
          quickDescriptions = [];
          syncRows = Array(10).fill(false);
          localStorage.clear();
          initApp();
          document.getElementById("settingsPanel").style.display = "none";
          showSuccessMessage("å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã—ãŸ");
        } catch (error) {
          console.error("ãƒ‡ãƒ¼ã‚¿å‰Šé™¤ã‚¨ãƒ©ãƒ¼:", error);
          showErrorMessage("ãƒ‡ãƒ¼ã‚¿å‰Šé™¤ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ");
        }
      }
    });

    // è¡¨ç¤ºä¸­ã®ä¼ç¥¨/æœˆã‚’ã‚¯ãƒªã‚¢
    document.getElementById("clearViewBtn").addEventListener("click", () => {
      try {
        if (viewMode === 'month') {
          if (!confirm(`âš ï¸ ç¾åœ¨è¡¨ç¤ºä¸­ã®ã€${currentMonth}ã€‘ã®å…¨æ˜ç´°ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆ${currentMonth}-01ã®å‰æ—¥æ®‹é«˜ã¯ç¶­æŒã•ã‚Œã¾ã™ï¼‰`)) return;
          
          const sortedDatesForMonth = Object.keys(voucherData)
            .filter(date => date.startsWith(currentMonth))
            .sort();
          
          sortedDatesForMonth.forEach(date => {
            const v = voucherData[date];
            if (v) {
              v.details.forEach(d => {
                d.depositCategory = "";
                d.depositAmount = 0;
                d.description = "";
                d.withdrawalAmount = 0;
                d.withdrawalCategory = "";
              });
            }
          });
          
          showSuccessMessage(`${currentMonth}ã®æ˜ç´°ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ`);
        } else {
          if (!confirm(`âš ï¸ ç¾åœ¨è¡¨ç¤ºä¸­ã®ã€${currentVoucherDate}ã€‘ã®æ˜ç´°ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆå‰æ—¥æ®‹é«˜ã¯ç¶­æŒã•ã‚Œã¾ã™ï¼‰`)) return;
          
          const v = voucherData[currentVoucherDate];
          if (v) {
            v.details.forEach(d => {
              d.depositCategory = "";
              d.depositAmount = 0;
              d.description = "";
              d.withdrawalAmount = 0;
              d.withdrawalCategory = "";
            });
          }
          
          showSuccessMessage(`${currentVoucherDate}ã®æ˜ç´°ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ`);
        }
        
        recalcMonth();
      } catch (error) {
        console.error("ã‚¯ãƒªã‚¢ã‚¨ãƒ©ãƒ¼:", error);
        showErrorMessage("ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªã‚¢ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ");
      }
    });

    /**********************************************
     * å£²ä¸ŠCSVèª­è¾¼æ©Ÿèƒ½
     **********************************************/
    document.getElementById("salesCsvLoadBtn").addEventListener("click", () => {
      document.getElementById("salesCsvInput").click();
    });

    document.getElementById("salesCsvInput").addEventListener("change", e => {
      const file = e.target.files[0];
      if (!file) return;

      showLoading("å£²ä¸ŠCSVã‚’èª­ã¿è¾¼ã¿ä¸­...");
      
      const reader = new FileReader();
      reader.onload = function(event) {
        try {
          const text = event.target.result;
          const lines = text.split(/\r\n|\n/);
          
          if (lines.length < 2) {
            throw new Error("CSVãƒ•ã‚¡ã‚¤ãƒ«ã«ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“");
          }

          const headers = lines[0].split(",");
          const colMap = {
            date: 0, salesTaxInc: -1, square: -1, paypay: -1, gift: -1, funfo: -1
          };

          // ãƒ˜ãƒƒãƒ€ãƒ¼ãƒãƒƒãƒ”ãƒ³ã‚°
          headers.forEach((h, i) => {
            const cleanH = h.trim();
            if (cleanH === "å£²ä¸Šé«˜ï¼ˆç¨è¾¼ï¼‰") colMap.salesTaxInc = i;
            else if (cleanH === "Square") colMap.square = i;
            else if (cleanH === "PayPay") colMap.paypay = i;
            else if (cleanH === "è¢‹äº•å•†å“åˆ¸") colMap.gift = i;
            else if (cleanH === "Funfo") colMap.funfo = i;
          });

          if (colMap.salesTaxInc === -1) {
            throw new Error("ã€Œå£²ä¸Šé«˜ï¼ˆç¨è¾¼ï¼‰ã€åˆ—ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
          }

          let processedCount = 0;

          for (let i = 1; i < lines.length; i++) {
            const rowRaw = lines[i];
            if (!rowRaw.trim()) continue;
            
            const row = rowRaw.split(",");
            let dateStr = row[colMap.date];
            if (!dateStr) continue;
            
            dateStr = dateStr.replace(/\//g, "-"); 
            
            if (voucherData[dateStr]) {
              const v = voucherData[dateStr];
              
              const getVal = (idx) => {
                if (idx === -1 || !row[idx]) return 0;
                return parseFloat(row[idx]) || 0;
              };

              const salesVal = getVal(colMap.salesTaxInc);
              const creditTotal = getVal(colMap.square) + getVal(colMap.paypay) + getVal(colMap.gift) + getVal(colMap.funfo);

              const detail = v.details[0]; 
              
              detail.depositCategory = "å£²ä¸Š";
              detail.depositAmount = salesVal;
              
              if (creditTotal > 0) {
                detail.withdrawalCategory = "å£²æ›é‡‘";
                detail.withdrawalAmount = creditTotal;
              } else {
                detail.withdrawalCategory = "";
                detail.withdrawalAmount = 0;
              }
              
              processedCount++;
            }
          }

          autoSaveVoucherData();
          recalcMonth();
          showSuccessMessage(`${processedCount}ä»¶ã®å£²ä¸Šãƒ‡ãƒ¼ã‚¿ã‚’åæ˜ ã—ã¾ã—ãŸ`);

        } catch (err) {
          console.error("CSVèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:", err);
          showErrorMessage("CSVèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: " + err.message);
        } finally {
          e.target.value = "";
          hideLoading();
        }
      };
      
      reader.readAsText(file, 'UTF-8'); 
    });

    /**********************************************
     * æ¤œç´¢æ©Ÿèƒ½
     **********************************************/
    document.getElementById("searchBtn").addEventListener("click", () => {
      try {
        document.querySelectorAll(".highlight-cell").forEach(cell => cell.classList.remove("highlight-cell"));
        
        const keyword = document.getElementById("searchKeyword").value.trim().toLowerCase();
        const resultsDiv = document.getElementById("searchResults");
        resultsDiv.innerHTML = "";

        if (keyword === "") { 
          showErrorMessage("æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
          return; 
        }

        const sortedDates = Object.keys(voucherData).sort();
        let foundResults = [];
        
        sortedDates.forEach(date => {
          const voucher = voucherData[date];
          if (!voucher) return;
          
          let foundInVoucher = false;

          // ã‚µãƒãƒªãƒ¼æƒ…å ±ã§ã®æ¤œç´¢
          const summaryValues = [
            String(voucher.prevBalance), String(voucher.deposit), 
            String(voucher.withdrawal), String(voucher.balance), voucher.date
          ];
          
          if (summaryValues.some(v => v.includes(keyword))) {
            foundInVoucher = true;
          }

          // æ˜ç´°ã§ã®æ¤œç´¢
          if (!foundInVoucher) {
            foundInVoucher = voucher.details.some(row => {
              return (row.depositCategory && row.depositCategory.toLowerCase().includes(keyword)) ||
                     String(row.depositAmount).includes(keyword) ||
                     (row.description && row.description.toLowerCase().includes(keyword)) ||
                     String(row.withdrawalAmount).includes(keyword) ||
                     (row.withdrawalCategory && row.withdrawalCategory.toLowerCase().includes(keyword));
            });
          }

          if (foundInVoucher) {
            foundResults.push(date);
          }
        });
        
        // æ¤œç´¢çµæœã®è¡¨ç¤º
        foundResults.forEach(date => {
          const itemDiv = document.createElement("div");
          itemDiv.classList.add("search-result-item");
          
          const link = document.createElement("a");
          link.textContent = `ğŸ“‹ ${date}`;
          link.href = "#";
          link.addEventListener("click", e => {
            e.preventDefault();
            
            const selectedMonth = date.slice(0, 7);
            document.getElementById("monthSelector").value = selectedMonth;
            currentMonth = selectedMonth;
            ensureVoucherDataForMonth(selectedMonth);
            populateDaySelector(selectedMonth);
            currentVoucherDate = date;
            document.getElementById("daySelector").value = currentVoucherDate;
            
            viewMode = 'day'; 
            recalcMonth();
            
            const target = document.querySelector(`.daily-voucher-card[data-date='${date}']`);
            if (target) {
              target.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
          });
          
          itemDiv.appendChild(link);
          resultsDiv.appendChild(itemDiv);
        });
        
        if (resultsDiv.children.length === 0) {
          resultsDiv.innerHTML = '<p style="text-align: center; color: #6c757d;">ğŸ” æ¤œç´¢çµæœã¯ã‚ã‚Šã¾ã›ã‚“</p>';
        } else {
          // ãƒã‚¤ãƒ©ã‚¤ãƒˆè¡¨ç¤º
          if (viewMode === 'month') {
            renderMonthView(currentMonth, keyword);
          } else {
            renderViewDetails(currentVoucherDate, 'singleDailyCard', keyword);
          }
          showSuccessMessage(`${foundResults.length}ä»¶ã®æ¤œç´¢çµæœãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ`);
        }
      } catch (error) {
        console.error("æ¤œç´¢ã‚¨ãƒ©ãƒ¼:", error);
        showErrorMessage("æ¤œç´¢å‡¦ç†ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ");
      }
    });

    document.getElementById("clearSearchBtn").addEventListener("click", () => {
      document.getElementById("searchResults").innerHTML = "";
      document.getElementById("searchKeyword").value = "";
      document.querySelectorAll(".highlight-cell").forEach(cell => cell.classList.remove("highlight-cell"));
      updateView(); 
    });

    // Enterã‚­ãƒ¼ã§æ¤œç´¢å®Ÿè¡Œ
    document.getElementById("searchKeyword").addEventListener("keypress", e => {
      if (e.key === 'Enter') {
        document.getElementById("searchBtn").click();
      }
    });

    /**********************************************
     * Excelä¿å­˜ãƒ»èª­è¾¼ï¼ˆä¿®æ­£ç‰ˆï¼‰
     **********************************************/
    
    document.getElementById("excelSaveBtn").addEventListener("click", async () => {
      showLoading("Excelãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆä¸­...");
      
      try {
        const month = document.getElementById("monthSelector").value;
        const workbook = new ExcelJS.Workbook();
        
        const formatExcelValue = (value) => value === 0 ? '' : value;

        const sortedDatesForMonth = Object.keys(voucherData)
          .filter(date => date.startsWith(month))
          .sort();
          
        // æœˆæ¬¡ã‚µãƒãƒªãƒ¼ã‚·ãƒ¼ãƒˆ
        const summarySheet = workbook.addWorksheet('æœˆæ¬¡ã‚µãƒãƒªãƒ¼');
        let summaryRow = 1;
        summarySheet.getRow(summaryRow++).values = ['æ—¥ä»˜', 'å‰æ—¥æ®‹é«˜', 'æœ¬æ—¥å…¥é‡‘', 'æœ¬æ—¥å‡ºé‡‘', 'æœ¬æ—¥æ®‹é«˜'];
        
        let maxSummaryWidths = [10, 12, 12, 12, 12]; 
        
        sortedDatesForMonth.forEach(date => {
          const v = voucherData[date];
          const row = summarySheet.getRow(summaryRow);
          
          const values = [
            v.date, 
            formatExcelValue(v.prevBalance), 
            formatExcelValue(v.deposit), 
            formatExcelValue(v.withdrawal), 
            formatExcelValue(v.balance)
          ];
          row.values = values;
          
          // å¹…è¨ˆç®—
          values.forEach((val, i) => {
            const len = String(val).length;
            if (len > maxSummaryWidths[i]) {
              maxSummaryWidths[i] = len;
            }
          });
          
          // æ•°å€¤ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
          [2, 3, 4, 5].forEach(c => {
            if (row.getCell(c).value !== '') {
              row.getCell(c).numFmt = '#,##0';
            }
            row.getCell(c).alignment = { horizontal: 'right' };
          });
          
          summaryRow++;
        });

        summarySheet.columns = maxSummaryWidths.map(w => ({ width: w + 2 }));

        // å…¥å‡ºé‡‘ä¼ç¥¨ã‚·ãƒ¼ãƒˆ
        const voucherSheet = workbook.addWorksheet('å…¥å‡ºé‡‘ä¼ç¥¨');
        
        let maxDetailWidths = [5, 15, 15, 30, 15, 15]; 
        let currentRow = 1;

        for (const date of sortedDatesForMonth) {
          const v = voucherData[date];
          
          // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œ
          const headerRow = voucherSheet.getRow(currentRow);
          headerRow.values = ['ä¼ç¥¨æ—¥ä»˜', 'å‰æ—¥æ®‹é«˜', 'æœ¬æ—¥å…¥é‡‘', 'æœ¬æ—¥å‡ºé‡‘', 'æœ¬æ—¥æ®‹é«˜'];
          headerRow.font = { bold: true };
          headerRow.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFF2F2F2' } };
          headerRow.eachCell(cell => {
            cell.border = { 
              top: { style: 'thin' }, left: { style: 'thin' }, 
              bottom: { style: 'thin' }, right: { style: 'thin' } 
            };
            cell.alignment = { horizontal: 'center' };
          });
          currentRow++;

          // ã‚µãƒãƒªãƒ¼è¡Œ
          const summaryRow = voucherSheet.getRow(currentRow);
          summaryRow.values = [
            v.date, 
            formatExcelValue(v.prevBalance), 
            formatExcelValue(v.deposit), 
            formatExcelValue(v.withdrawal), 
            formatExcelValue(v.balance)
          ];
          
          summaryRow.getCell(1).alignment = { horizontal: 'center' };
          
          [1, 2, 3, 4, 5].forEach(c => {
            const val = summaryRow.getCell(c).value;
            const len = String(val).length;
            if (c === 1 && len > maxDetailWidths[0]) maxDetailWidths[0] = len + 1;
            if (c > 1 && len > maxDetailWidths[c - 1]) maxDetailWidths[c - 1] = len + 1;
          });
          
          [2, 3, 4, 5].forEach(c => {
            if (summaryRow.getCell(c).value !== '') {
              summaryRow.getCell(c).numFmt = '#,##0';
            }
            summaryRow.getCell(c).alignment = { horizontal: 'right' };
          });
          
          summaryRow.eachCell(cell => {
            cell.border = { 
              top: { style: 'thin' }, left: { style: 'thin' }, 
              bottom: { style: 'thin' }, right: { style: 'thin' } 
            };
          });
          currentRow++;

          // æ˜ç´°ãƒ˜ãƒƒãƒ€ãƒ¼
          const detailHeader = voucherSheet.getRow(currentRow);
          detailHeader.values = ['No.', 'å…¥é‡‘ç§‘ç›®', 'å…¥é‡‘é‡‘é¡', 'æ‘˜è¦', 'å‡ºé‡‘é‡‘é¡', 'å‡ºé‡‘ç§‘ç›®'];
          detailHeader.font = { bold: true };
          detailHeader.eachCell(cell => {
            cell.border = { 
              top: { style: 'thin' }, left: { style: 'thin' }, 
              bottom: { style: 'thin' }, right: { style: 'thin' } 
            };
            cell.alignment = { horizontal: 'center' };
            cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFEFEFEF' } };
          });
          currentRow++;

          // æ˜ç´°è¡Œ
          v.details.forEach(detail => {
            const r = voucherSheet.getRow(currentRow);
            const values = [
              detail.no, 
              detail.depositCategory, 
              formatExcelValue(detail.depositAmount), 
              detail.description, 
              formatExcelValue(detail.withdrawalAmount), 
              detail.withdrawalCategory
            ];
            r.values = values;
            
            // å¹…è¨ˆç®—
            values.forEach((val, i) => {
              const len = String(val).length;
              if (len > maxDetailWidths[i]) { 
                maxDetailWidths[i] = len + 1; 
              }
            });

            r.eachCell((cell, colNumber) => {
              cell.border = { 
                top: { style: 'dotted' }, left: { style: 'thin' }, 
                bottom: { style: 'dotted' }, right: { style: 'thin' } 
              };
              
              if (colNumber === 3 || colNumber === 5) {
                if (cell.value !== '') {
                  cell.numFmt = '#,##0';
                }
                cell.alignment = { horizontal: 'right' };
              }
            });
            currentRow++;
          });
          currentRow += 1; // ä¼ç¥¨é–“ã®ã‚¹ãƒšãƒ¼ã‚¹
        }

        voucherSheet.columns = maxDetailWidths.map(w => ({ width: w + 1 }));

        // ãƒ•ã‚¡ã‚¤ãƒ«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        const buffer = await workbook.xlsx.writeBuffer();
        const blob = new Blob([buffer], { 
          type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' 
        });
        
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${month}_å…¥å‡ºé‡‘ä¼ç¥¨_Proç‰ˆ.xlsx`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
        
        showSuccessMessage("Excelãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿å­˜ã—ã¾ã—ãŸ");
      } catch (error) {
        console.error("Excelä¿å­˜ã‚¨ãƒ©ãƒ¼:", error);
        showErrorMessage("Excelãƒ•ã‚¡ã‚¤ãƒ«ã®ä¿å­˜ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ");
      } finally { 
        hideLoading(); 
      }
    });

    document.getElementById("excelLoadBtn").addEventListener("click", () => {
      document.getElementById("excelLoadInput").click();
    });

    document.getElementById("excelLoadInput").addEventListener("change", async e => {
      const file = e.target.files[0];
      if (!file) return;
      
      showLoading("Excelãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...");
      
      try {
        const buffer = await file.arrayBuffer();
        const workbook = new ExcelJS.Workbook();
        await workbook.xlsx.load(buffer);
        
        // ã‚·ãƒ¼ãƒˆã®æ¤œç´¢ï¼ˆè¤‡æ•°ã®ã‚·ãƒ¼ãƒˆåã«å¯¾å¿œï¼‰
        let sheet = workbook.getWorksheet('å…¥å‡ºé‡‘ä¼ç¥¨') || 
                   workbook.getWorksheet(1) || 
                   workbook.getWorksheet('Sheet1');
                   
        if (!sheet) {
          throw new Error("èª­ã¿è¾¼ã¿å¯èƒ½ãªã‚·ãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
        }

        let loadedData = {};
        let currentVoucher = null;
        
        // æ”¹è‰¯ã•ã‚ŒãŸExcelæ—¥ä»˜å¤‰æ›é–¢æ•°
        const excelDateToISOString = (excelValue) => {
          try {
            // æ—¢ã«æ­£ã—ã„å½¢å¼ã®æ–‡å­—åˆ—ã®å ´åˆ
            if (typeof excelValue === 'string' && excelValue.match(/^\d{4}-\d{2}-\d{2}$/)) {
              return excelValue;
            }
            
            // Dateã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®å ´åˆ
            if (excelValue instanceof Date) {
              const year = excelValue.getFullYear();
              const month = String(excelValue.getMonth() + 1).padStart(2, '0');
              const day = String(excelValue.getDate()).padStart(2, '0');
              return `${year}-${month}-${day}`;
            }
            
            // æ•°å€¤ï¼ˆExcelã‚·ãƒªã‚¢ãƒ«å€¤ï¼‰ã®å ´åˆ
            if (typeof excelValue === 'number' && excelValue > 25569) { // 1970å¹´ä»¥é™
              const date = new Date((excelValue - 25569) * 86400 * 1000);
              const year = date.getUTCFullYear();
              const month = String(date.getUTCMonth() + 1).padStart(2, '0');
              const day = String(date.getUTCDate()).padStart(2, '0');
              return `${year}-${month}-${day}`;
            }
            
            // æ–‡å­—åˆ—ã®æ—¥ä»˜å½¢å¼ã‚’å¤‰æ›
            const str = String(excelValue).trim();
            if (str.match(/^\d{4}\/\d{1,2}\/\d{1,2}$/)) {
              const parts = str.split('/');
              return `${parts[0]}-${parts[1].padStart(2, '0')}-${parts[2].padStart(2, '0')}`;
            }
            
            return str;
          } catch (error) {
            console.warn("æ—¥ä»˜å¤‰æ›ã‚¨ãƒ©ãƒ¼:", error, excelValue);
            return String(excelValue || "").trim();
          }
        };

        sheet.eachRow((row, rowNumber) => {
          try {
            const cellA = row.getCell(1).value; 
            const dateStr = excelDateToISOString(cellA);
            
            // æ—¥ä»˜è¡Œã®åˆ¤å®šï¼ˆä¼ç¥¨ã®é–‹å§‹ï¼‰
            if (dateStr.match(/^\d{4}-\d{2}-\d{2}$/)) {
              currentVoucher = {
                date: dateStr,
                prevBalance: parseNumber(row.getCell(2).value) || 0,
                deposit: parseNumber(row.getCell(3).value) || 0,
                withdrawal: parseNumber(row.getCell(4).value) || 0,
                balance: parseNumber(row.getCell(5).value) || 0,
                details: []
              };
              loadedData[dateStr] = currentVoucher;
            }
            // æ˜ç´°è¡Œã®åˆ¤å®šï¼ˆNo.ãŒæ­£ã®æ•°å€¤ï¼‰
            else if (currentVoucher && !isNaN(parseInt(cellA)) && parseInt(cellA) > 0) {
              if (currentVoucher.details.length < 10) {
                currentVoucher.details.push({
                  no: parseInt(cellA),
                  depositCategory: String(row.getCell(2).value || ""),
                  depositAmount: parseNumber(row.getCell(3).value) || 0,
                  description: String(row.getCell(4).value || ""),
                  withdrawalAmount: parseNumber(row.getCell(5).value) || 0,
                  withdrawalCategory: String(row.getCell(6).value || "")
                });
              }
            }
          } catch (error) {
            console.warn(`è¡Œ ${rowNumber} ã®å‡¦ç†ã§ã‚¨ãƒ©ãƒ¼:`, error);
          }
        });

        // æ˜ç´°ã‚’10è¡Œã«èª¿æ•´
        Object.values(loadedData).forEach(v => {
          while (v.details.length < 10) {
            v.details.push({ 
              no: v.details.length + 1, 
              depositCategory: "", 
              depositAmount: 0, 
              description: "", 
              withdrawalAmount: 0, 
              withdrawalCategory: "" 
            });
          }
        });

        if (Object.keys(loadedData).length === 0) {
          throw new Error("æœ‰åŠ¹ãªä¼ç¥¨ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ");
        }

        if (confirm(`ğŸ“Š ${Object.keys(loadedData).length}ä»¶ã®ä¼ç¥¨ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸã€‚\nç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã‚’ä¸Šæ›¸ãã—ã¦èª­ã¿è¾¼ã¿ã¾ã™ã‹ï¼Ÿ`)) {
          voucherData = loadedData;
          autoSaveVoucherData();
          
          recalcMonth();
          
          // æœ€åˆã®æ—¥ä»˜ã«ç§»å‹•
          const dates = Object.keys(loadedData).sort();
          const firstDate = dates[0];
          if (firstDate) {
            currentMonth = firstDate.slice(0, 7);
            document.getElementById("monthSelector").value = currentMonth;
            currentVoucherDate = firstDate;
            document.getElementById("daySelector").value = currentVoucherDate;
            ensureVoucherDataForMonth(currentMonth);
            updateView();
          }
          
          showSuccessMessage(`${Object.keys(loadedData).length}ä»¶ã®ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ`);
        }
      } catch (err) {
        console.error("Excelèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:", err);
        showErrorMessage("Excelèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: " + err.message);
      } finally {
        e.target.value = '';
        hideLoading();
      }
    });
    
    /**********************************************
     * JSONä¿å­˜ãƒ»èª­è¾¼
     **********************************************/
    
    document.getElementById("jsonSaveBtn").addEventListener("click", () => {
      try {
        const dataToSave = { 
          voucherData: voucherData, 
          syncRows: syncRows, 
          quickDescriptions: quickDescriptions,
          exportDate: new Date().toISOString(),
          version: "Proç‰ˆ"
        };
        
        const jsonStr = JSON.stringify(dataToSave, null, 2);
        const dataUri = "data:application/json;charset=utf-8," + encodeURIComponent(jsonStr);
        
        const link = document.createElement("a");
        link.href = dataUri;
        link.download = `å…¥å‡ºé‡‘ä¼ç¥¨_Proç‰ˆ_${currentMonth}_ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—.json`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        showSuccessMessage("JSONãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ä¿å­˜ã—ã¾ã—ãŸ");
      } catch (error) {
        console.error("JSONä¿å­˜ã‚¨ãƒ©ãƒ¼:", error);
        showErrorMessage("JSONãƒ•ã‚¡ã‚¤ãƒ«ã®ä¿å­˜ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ");
      }
    });
    
    document.getElementById("jsonLoadBtn").addEventListener("click", () => {
      document.getElementById("jsonLoadInput").click();
    });
    
    document.getElementById("jsonLoadInput").addEventListener("change", e => {
      const file = e.target.files[0];
      if (!file) return;
      
      showLoading("JSONãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...");
      
      const reader = new FileReader();
      reader.onload = function(event) {
        try {
          const loadedData = JSON.parse(event.target.result);
          
          if (loadedData.voucherData) {
            if (confirm(`ğŸ“ JSONãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒã—ã¾ã™ã‹ï¼Ÿ\n${loadedData.exportDate ? 'ä½œæˆæ—¥æ™‚: ' + new Date(loadedData.exportDate).toLocaleString() : ''}`)) {
              voucherData = loadedData.voucherData;
              
              if (loadedData.syncRows) syncRows = loadedData.syncRows;
              if (loadedData.quickDescriptions) quickDescriptions = loadedData.quickDescriptions;
              
              autoSaveVoucherData();
              initApp();
              showSuccessMessage("JSONãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‹ã‚‰å¾©å…ƒã—ã¾ã—ãŸ");
            }
          } else {
            throw new Error("ç„¡åŠ¹ãªJSONãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ã§ã™");
          }
        } catch (e) { 
          console.error("JSONèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:", e);
          showErrorMessage("JSONãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ"); 
        } finally {
          hideLoading();
        }
      };
      
      reader.readAsText(file);
      e.target.value = '';
    });
    
    // å°åˆ·
    document.getElementById("printBtn").addEventListener("click", () => {
      window.print();
    });
    
    // åˆæœŸåŒ–
    window.addEventListener("load", initApp);
  </script>
</body>
</html>
