<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>入出金伝票システム（クイック入力・ビュー切り替え版）</title>
  <script src="https://cdn.jsdelivr.net/npm/exceljs/dist/exceljs.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    #controlPanel, #searchPanel, #actionPanel, #importPanel {
      margin-bottom: 10px; padding: 10px; border: 1px solid #ccc; border-radius: 5px;
    }
    #controlPanel input, #controlPanel select, #controlPanel button,
    #actionPanel button, #importPanel button { margin-right: 10px; font-size: 14px; margin-bottom: 5px; }
    
    /* ビュー切り替えボタンのスタイル */
    #viewModeToggle { margin-left: 20px; }
    #viewModeToggle button {
        padding: 5px 10px;
        border: 1px solid #333;
        background-color: #f0f0f0;
        cursor: pointer;
    }
    #viewModeToggle button.active {
        background-color: #333;
        color: white;
        font-weight: bold;
    }

    /* 月次ビューのコンテナ */
    #monthlyVoucherContainer { 
        border: 1px solid #ddd; 
        padding: 10px; 
        border-radius: 5px;
        background-color: #fcfcfc;
    }
    
    /* 日次ビューのコンテナ */
    #dailyVoucherContainer { 
        border: 1px solid #ddd; 
        padding: 10px; 
        border-radius: 5px;
        background-color: #fcfcfc;
    }

    /* 日ごとの伝票カード */
    .daily-voucher-card {
        margin-bottom: 25px;
        border: 1px solid #eee;
        padding: 10px;
        border-radius: 4px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        background-color: white;
    }

    /* 日ごとのサマリーパネル */
    .daily-summary-panel {
        display: flex;
        justify-content: space-between;
        padding: 5px 0;
        margin-bottom: 10px;
        font-size: 1.1em;
        font-weight: bold;
        border-bottom: 2px solid #333;
    }
    .daily-summary-panel div {
        flex-basis: 25%;
        text-align: right;
        padding-left: 10px;
    }
    .daily-summary-panel div:first-child { text-align: left; flex-basis: 35%; }
    
    /* 明細テーブル */
    .voucher-details-table { border-collapse: collapse; width: 100%; margin-top: 5px; }
    .voucher-details-table th, .voucher-details-table td { border: 1px solid #aaa; padding: 5px; text-align: center; font-size: 0.9em; }
    
    input[type="text"] { width: 90%; box-sizing: border-box; }

    /* アクティブな行のハイライト */
    tr.active-row td {
      background-color: #f7fff7 !important;
    }

    /* 検索結果のハイライト */
    .highlight-cell {
      background-color: #fffdc9 !important;
    }

    /* 処理中フィードバック用オーバーレイ */
    #loadingOverlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      display: none;
      justify-content: center;
      align-items: center;
      color: white;
      font-size: 1.5em;
    }

    @media print {
      #controlPanel, #searchPanel, #actionPanel, #settingsPanel, #loadingOverlay, #importPanel { display: none; }
    }
    /* 設定パネル */
    #settingsPanel {
      border: 1px solid #aaa; padding: 10px; margin-top: 10px; background-color: #f9f9f9; width: 300px;
    }
    /* 検索結果 */
    .search-result-item {
      margin-bottom: 5px;
      display: flex; align-items: center;
    }
    .search-result-item a { margin-right: 10px; }
    .disabled-input { background-color: #f0f0f0; }
    
    /* インポートパネル強調 */
    #importPanel { background-color: #eef9ff; border-color: #bee5eb; }
    h3 { margin-top: 0; }
    
    /* 月初残高入力欄の調整 */
    .prev-balance-input {
        width: 100px; 
        font-weight: normal; 
        text-align: right; 
        border: 1px solid #ccc;
        padding: 2px;
        margin-right: 5px;
    }
    
  </style>
</head>
<body>

  <div id="controlPanel">
    <label for="monthSelector">対象月：</label>
    <input type="month" id="monthSelector">
    
    <span id="dailyControls" style="display:none;">
        <label for="daySelector">日付：</label>
        <select id="daySelector"></select>
        <button id="prevDayBtn">前日</button>
        <button id="nextDayBtn">翌日</button>
    </span>

    <span id="viewModeToggle">
        <button id="monthViewBtn" class="active">月次ビュー</button>
        <button id="dayViewBtn">日次ビュー</button>
    </span>
    <button id="settingsBtn">設定</button>
  </div>

  <div id="settingsPanel" style="display:none;">
    <h3>固定摘要同期設定</h3>
    <p><small>選択された行の摘要は、毎月1日の摘要と同期されます。</small></p>
    <form id="syncForm">
      <div>
        <label><input type="checkbox" name="syncRow" value="0"> 行1</label>
        <label><input type="checkbox" name="syncRow" value="1"> 行2</label>
        <label><input type="checkbox" name="syncRow" value="2"> 行3</label>
        <label><input type="checkbox" name="syncRow" value="3"> 行4</label>
        <label><input type="checkbox" name="syncRow" value="4"> 行5</label>
      </div>
      <div>
        <label><input type="checkbox" name="syncRow" value="5"> 行6</label>
        <label><input type="checkbox" name="syncRow" value="6"> 行7</label>
        <label><input type="checkbox" name="syncRow" value="7"> 行8</label>
        <label><input type="checkbox" name="syncRow" value="8"> 行9</label>
        <label><input type="checkbox" name="syncRow" value="9"> 行10</label>
      </div>
    </form>
    <br>
    
    <h3>摘要クイック入力設定</h3>
    <p><small>一行に一つの摘要を入力してください。</small></p>
    <textarea id="quickDescInput" rows="5" style="width: 100%;"></textarea>
    <button type="button" id="saveQuickDescBtn">摘要を保存</button>
    <br><br>

    <button type="button" id="deleteAllDataBtn">全データ削除</button>
    <button type="button" id="closeSettingsBtn">閉じる</button>
  </div>
  
  <div id="importPanel">
    <h3>売上データ連携</h3>
    <p><small>売上詳細CSVファイルを読み込み、入金(売上)と出金(売掛計)を反映します。</small></p>
    <input type="file" id="salesCsvInput" accept=".csv" style="display:none;">
    <button id="salesCsvLoadBtn" style="font-weight:bold; color:#0056b3;">売上管理表CSV読込</button>
  </div>

  <div id="voucherCard">
    <h2 id="voucherHeader">伝票ビュー</h2>
    <div style="text-align: right; margin-bottom: 5px;">
        <button id="clearViewBtn" style="background-color: #fff3cd; border: 1px solid #ffeeba; cursor:pointer;">表示中の伝票をクリア</button>
    </div>
    
    <div id="monthlyVoucherContainer"></div>

    <div id="dailyVoucherContainer" style="display:none;">
        <div class="daily-voucher-card" id="singleDailyCard">
            </div>
    </div>
  </div>

  <div id="searchPanel">
    <label for="searchKeyword">検索キーワード：</label>
    <input type="text" id="searchKeyword" placeholder="キーワード入力">
    <button id="searchBtn">検索</button>
    <button id="clearSearchBtn">検索クリア</button>
    <div id="searchResults" style="margin-top: 10px;"></div>
  </div>

  <div id="actionPanel">
    <h3>データ操作</h3>
    <button id="excelSaveBtn">Excel保存 (.xlsx)</button>
    <input type="file" id="excelLoadInput" accept=".xlsx" style="display:none;">
    <button id="excelLoadBtn">Excel読み込み (.xlsx)</button>
    
    <button id="jsonSaveBtn">JSON保存</button>
    <input type="file" id="jsonLoadInput" accept=".json" style="display:none;">
    <button id="jsonLoadBtn">JSON読み込み</button>
    
    <button id="printBtn">印刷</button>
  </div>
  
  <div id="loadingOverlay" style="display: none;">
    <p id="loadingText">処理中...</p>
  </div>

  <script>
    /**********************************************
     * グローバル変数・データ構造
     **********************************************/
    let voucherData = {};
    let syncRows = Array(10).fill(false);
    let quickDescriptions = []; // クイック入力用の摘要リスト
    let currentMonth = ""; 
    let currentVoucherDate = ""; 
    let viewMode = 'month'; // 'month' or 'day'

    /**********************************************
     * 処理中フィードバック
     **********************************************/
    function showLoading(text = "処理中...") {
      document.getElementById("loadingText").textContent = text;
      document.getElementById("loadingOverlay").style.display = "flex";
    }
    function hideLoading() {
      document.getElementById("loadingOverlay").style.display = "none";
    }

    /**********************************************
     * 初期化・データ読み込み処理
     **********************************************/
    function initApp() {
      const storedVoucherData = localStorage.getItem("voucherData");
      if (storedVoucherData) {
        try { voucherData = JSON.parse(storedVoucherData); } catch(e) { voucherData = {}; console.error(e); }
      }
      const storedSyncRows = localStorage.getItem("syncRows");
      if (storedSyncRows) {
        try { syncRows = JSON.parse(storedSyncRows); } catch(e) { syncRows = Array(10).fill(false); console.error(e); }
      }
      const storedQuickDesc = localStorage.getItem("quickDescriptions");
      if (storedQuickDesc) {
        try { quickDescriptions = JSON.parse(storedQuickDesc); } catch(e) { quickDescriptions = []; console.error(e); }
      }

      document.querySelectorAll("#syncForm input[type=checkbox]").forEach((chk, index) => {
        chk.checked = syncRows[index];
      });

      const monthSelector = document.getElementById("monthSelector");
      const now = new Date();
      currentMonth = now.toISOString().slice(0, 7);
      monthSelector.value = currentMonth;

      ensureVoucherDataForMonth(currentMonth);
      
      populateDaySelector(currentMonth);
      currentVoucherDate = currentMonth + "-01";
      document.getElementById("daySelector").value = currentVoucherDate;

      recalcMonth();
      updateView();
      renderDatalist(); // datalistの初回描画
    }

    function ensureVoucherDataForMonth(month) {
      const [year, monthNum] = month.split("-");
      const daysInMonth = new Date(parseInt(year), parseInt(monthNum), 0).getDate();

      for (let d = 1; d <= daysInMonth; d++) {
        const dayStr = String(d).padStart(2, "0");
        const dateStr = `${month}-${dayStr}`;

        if (!voucherData[dateStr]) {
          voucherData[dateStr] = {
            date: dateStr,
            prevBalance: 0,
            deposit: 0,
            withdrawal: 0,
            balance: 0,
            details: []
          };
          for (let i = 0; i < 10; i++) {
            voucherData[dateStr].details.push({
              no: i + 1,
              depositCategory: "",
              depositAmount: 0,
              description: "",
              withdrawalAmount: 0,
              withdrawalCategory: ""
            });
          }
        }
      }
      autoSaveVoucherData();
    }
    
    function populateDaySelector(month) {
      const selector = document.getElementById("daySelector");
      selector.innerHTML = "";
      const [year, monthNum] = month.split("-");
      const daysInMonth = new Date(parseInt(year), parseInt(monthNum), 0).getDate();

      for (let d = 1; d <= daysInMonth; d++) {
        const dayStr = String(d).padStart(2, "0");
        const date = `${month}-${dayStr}`;
        const option = document.createElement("option");
        option.value = date;
        option.textContent = date;
        selector.appendChild(option);
      }
      if (!selector.querySelector(`option[value="${currentVoucherDate}"]`)) {
        currentVoucherDate = month + "-01";
      }
      selector.value = currentVoucherDate;
    }

    function autoSaveVoucherData() {
      localStorage.setItem("voucherData", JSON.stringify(voucherData));
      localStorage.setItem("syncRows", JSON.stringify(syncRows));
      localStorage.setItem("quickDescriptions", JSON.stringify(quickDescriptions));
    }

    function recalcMonth() {
      const dates = Object.keys(voucherData).sort();
      
      for (let i = 0; i < dates.length; i++) {
        const currentDate = dates[i];
        const voucher = voucherData[currentDate];
        if (!voucher) continue;

        if (i > 0) {
            const prevVoucher = voucherData[dates[i-1]];
            if (prevVoucher) {
                voucher.prevBalance = prevVoucher.balance;
            }
        } 
        recalcVoucher(currentDate);
      }
      
      updateView(); 
      autoSaveVoucherData();
    }

    function recalcVoucher(date) {
      const voucher = voucherData[date];
      if (!voucher) return;
      let totalDep = 0, totalWithdraw = 0;

      voucher.details.forEach(row => {
        // 金額は文字列で保存されている場合があるため、処理前にカンマを削除し数値化
        totalDep += parseFloat(String(row.depositAmount).replace(/,/g, '')) || 0;
        totalWithdraw += parseFloat(String(row.withdrawalAmount).replace(/,/g, '')) || 0;
      });

      voucher.deposit = totalDep;
      voucher.withdrawal = totalWithdraw;
      voucher.balance = voucher.prevBalance + totalDep - totalWithdraw; 
    }

    function syncDescription(rowIndex) {
      const masterDate = `${currentMonth}-01`;
      if (!voucherData[masterDate]) return;
      const masterDescription = voucherData[masterDate].details[rowIndex].description;

      Object.keys(voucherData).forEach(date => {
        if (date.startsWith(currentMonth)) {
          voucherData[date].details[rowIndex].description = masterDescription;
        }
      });
      updateView();
      autoSaveVoucherData();
    }
    
    // クイック入力用の datalist を生成/更新する
    function renderDatalist() {
        let datalist = document.getElementById('quickDescList');
        if (!datalist) {
            datalist = document.createElement('datalist');
            datalist.id = 'quickDescList';
            document.body.appendChild(datalist);
        }
        datalist.innerHTML = quickDescriptions
                                .filter(desc => desc.trim() !== '') // 空白を除外
                                .map(desc => `<option value="${desc}">`)
                                .join('');
    }

    /**********************************************
     * ビューの切り替えとレンダリング
     **********************************************/
     
    function updateView(searchKeyword = null) {
        // datalistの更新
        renderDatalist();

        // コントロールパネルの表示切り替え
        document.getElementById('monthlyVoucherContainer').style.display = 'none';
        document.getElementById('dailyVoucherContainer').style.display = 'none';
        document.getElementById('dailyControls').style.display = 'none';
        document.getElementById('monthViewBtn').classList.remove('active');
        document.getElementById('dayViewBtn').classList.remove('active');
        document.getElementById('clearViewBtn').style.display = 'block';

        if (viewMode === 'month') {
            document.getElementById('voucherHeader').textContent = `月次伝票ビュー: ${currentMonth}`;
            document.getElementById('monthlyVoucherContainer').style.display = 'block';
            document.getElementById('monthViewBtn').classList.add('active');
            document.getElementById('clearViewBtn').textContent = '表示中の月をクリア';
            renderMonthView(currentMonth, searchKeyword);
        } else { // viewMode === 'day'
            document.getElementById('voucherHeader').textContent = `伝票: ${currentVoucherDate}`;
            document.getElementById('dailyVoucherContainer').style.display = 'block';
            document.getElementById('dailyControls').style.display = 'inline';
            document.getElementById('dayViewBtn').classList.add('active');
            document.getElementById('clearViewBtn').textContent = '表示中の伝票をクリア';
            renderViewDetails(currentVoucherDate, 'singleDailyCard', searchKeyword);
        }
    }


    function renderMonthView(month, searchKeyword = null) {
      const container = document.getElementById("monthlyVoucherContainer");
      container.innerHTML = "";
      
      const sortedDatesForMonth = Object.keys(voucherData)
        .filter(date => date.startsWith(month))
        .sort();
      
      const keyword = searchKeyword ? searchKeyword.toLowerCase() : null;

      sortedDatesForMonth.forEach(date => {
        const dailyCardHtml = renderViewDetails(date, null, keyword, true);
        const dailyCard = document.createElement("div");
        dailyCard.classList.add("daily-voucher-card");
        dailyCard.dataset.date = date;
        dailyCard.innerHTML = dailyCardHtml;
        container.appendChild(dailyCard);
      });
      
      attachInputListeners(month);
    }
    
    function renderViewDetails(date, containerId, searchKeyword = null, isMonthlyView = false) {
      const voucher = voucherData[date];
      if (!voucher) return "";
      
      const isFirstDayOfMonth = date.endsWith("-01");
      const keyword = searchKeyword ? searchKeyword.toLowerCase() : null;
      
      let container = null;
      if(containerId) {
          container = document.getElementById(containerId);
          if(!container) return;
      }
      
      // 前日残高の表示値決定 (0なら空欄)
      const prevBalanceDisplay = voucher.prevBalance === 0 ? '' : voucher.prevBalance.toLocaleString('ja-JP');

      let summaryHtml = `
          <div class="daily-summary-panel">
            <div>${date}</div>
            <div id="prevBalanceContainer_${date}">前日残高: 
              ${(isFirstDayOfMonth || !isMonthlyView) ? 
                `<input type="text" class="prev-balance-input" data-date="${date}" value="${prevBalanceDisplay}" 
                    onfocus="this.value = String(this.value).replace(/,/g, ''); this.select();"
                    onblur="updatePrevBalance(this, '${date}');">` :
                `<span id="prevBalanceField_${date}">${voucher.prevBalance.toLocaleString('ja-JP')}</span>`
              }
            </div>
            <div>本日入金: <span id="depositTotal_${date}">${voucher.deposit.toLocaleString('ja-JP')}</span></div>
            <div>本日出金: <span id="withdrawalTotal_${date}">${voucher.withdrawal.toLocaleString('ja-JP')}</span></div>
            <div>本日残高: <span id="balance_${date}">${voucher.balance.toLocaleString('ja-JP')}</span></div>
          </div>
        `;
        
        let tableHtml = `
          <table class="voucher-details-table" data-date="${date}">
            <thead>
              <tr>
                <th>No.</th>
                <th>入金科目</th>
                <th>入金金額</th>
                <th>摘要</th>
                <th>出金金額</th>
                <th>出金科目</th>
              </tr>
            </thead>
            <tbody>
        `;

        voucher.details.forEach((row, index) => {
          const isSync = syncRows[index];
          let descValue = row.description;
          
          if (isSync) {
            const masterVoucher = voucherData[`${date.slice(0, 7)}-01`];
            if (masterVoucher) {
              descValue = masterVoucher.details[index].description;
              row.description = descValue; 
            }
          }
          
          const isDescReadOnly = isSync && !date.endsWith("-01");

          tableHtml += `
            <tr data-row="${index}">
              <td${keyword && String(row.no).includes(keyword) ? ' class="highlight-cell"' : ''}>${row.no}</td>
              ${createInputCellHtml(date, "text", row.depositCategory, index, "1", keyword)}
              ${createInputCellHtml(date, "number", row.depositAmount, index, "2", keyword)}
              ${createInputCellHtml(date, "text", descValue, index, "3", keyword, isDescReadOnly, true)}
              ${createInputCellHtml(date, "number", row.withdrawalAmount, index, "4", keyword)}
              ${createInputCellHtml(date, "text", row.withdrawalCategory, index, "5", keyword)}
            </tr>
          `;
        });

        tableHtml += `
            </tbody>
          </table>
        `;
        
        const finalHtml = summaryHtml + tableHtml;
        
        if (container) {
            container.innerHTML = finalHtml;
            attachInputListeners(date.slice(0, 7));
        } else {
            return finalHtml;
        }
    }
    
    // 単一セル用のHTMLを生成するヘルパー関数
    function createInputCellHtml(date, type, value, rowIndex, colIndex, keyword, readOnly = false, isDescription = false) {
        let displayValue;
        let numValue = (type === "number") ? parseFloat(String(value).replace(/,/g, '')) || 0 : value;

        // 1. フィールドが数値で、値が0の場合は空欄を表示
        if (type === "number") {
            displayValue = numValue === 0 ? "" : numValue.toLocaleString('ja-JP');
        } else {
            displayValue = String(value);
        }

        const inputType = "text"; 
        const readOnlyAttr = readOnly ? 'readonly' : '';
        const disabledClass = readOnly ? 'disabled-input' : '';
        
        const cellClass = (keyword && String(value).toLowerCase().includes(keyword.toLowerCase())) ? ' class="highlight-cell"' : '';
        
        const datalistAttr = isDescription ? 'list="quickDescList"' : '';

        return `
          <td${cellClass}>
            <input type="${inputType}" value="${displayValue}" 
                   data-date="${date}" data-row="${rowIndex}" data-col="${colIndex}" data-type="${type}"
                   ${readOnlyAttr} class="${disabledClass}" ${datalistAttr}>
          </td>
        `;
    }
    
    // 前日残高の更新処理
    window.updatePrevBalance = function(inputElement, date) {
        const numValue = parseFloat(inputElement.value.replace(/,/g, '')) || 0;
        const voucher = voucherData[date];
        
        if ((date.endsWith("-01") || viewMode === 'day') && voucher.prevBalance !== numValue) {
            voucher.prevBalance = numValue;
            recalcMonth(); 
        }
        
        // 0の場合は空欄、それ以外はカンマ付きに戻す
        inputElement.value = numValue === 0 ? '' : numValue.toLocaleString('ja-JP');
    };


    // すべての入力フィールドにイベントリスナーを設定する
    function attachInputListeners(month) {
        const selector = viewMode === 'month' ? `#monthlyVoucherContainer input` : `#dailyVoucherContainer input`;
        document.querySelectorAll(selector).forEach(input => {
            const date = input.dataset.date;
            const rowIndex = parseInt(input.dataset.row);
            const colIndex = parseInt(input.dataset.col);
            const type = input.dataset.type;

            input.addEventListener("focus", (e) => {
                document.querySelectorAll(".active-row").forEach(tr => tr.classList.remove("active-row"));
                e.target.closest("tr").classList.add("active-row");
                if(type === "number") {
                    const rawValue = String(e.target.value).replace(/,/g, '');
                    e.target.value = rawValue;
                    if(e.target.select) e.target.select();
                }
            });

            // データ更新ロジック (blurとchange)
            if (type === "number") {
                input.addEventListener("blur", e => {
                    const numValue = parseFloat(e.target.value.replace(/,/g, '')) || 0;
                    
                    const voucher = voucherData[date];
                    const detail = voucher.details[rowIndex];
                    let changed = false;

                    if (colIndex === 2 && detail.depositAmount !== numValue) {
                        detail.depositAmount = numValue;
                        changed = true;
                    } else if (colIndex === 4 && detail.withdrawalAmount !== numValue) {
                        detail.withdrawalAmount = numValue;
                        changed = true;
                    }

                    // 0の場合は空欄、それ以外はカンマ付きに戻す
                    e.target.value = numValue === 0 ? '' : numValue.toLocaleString('ja-JP');

                    if (changed) {
                        recalcMonth();
                    }
                });
            } else if (type === "text") {
                input.addEventListener("change", e => {
                    if (e.target.readOnly) return;
                    
                    const textValue = e.target.value;
                    const voucher = voucherData[date];
                    const detail = voucher.details[rowIndex];
                    let changed = false;

                    if (colIndex === 1 && detail.depositCategory !== textValue) {
                        detail.depositCategory = textValue;
                        changed = true;
                    } else if (colIndex === 3 && detail.description !== textValue) {
                        detail.description = textValue;
                        changed = true;
                        if (date.endsWith("-01") && syncRows[rowIndex]) {
                            syncDescription(rowIndex);
                        }
                    } else if (colIndex === 5 && detail.withdrawalCategory !== textValue) {
                        detail.withdrawalCategory = textValue;
                        changed = true;
                    }
                    
                    if (changed) {
                        autoSaveVoucherData();
                    }
                });
            }

            // Enter/Arrowキーでの移動 (省略、前バージョンと同じロジックが使用されます)
            input.addEventListener("keydown", e => {
                const allDates = Object.keys(voucherData).sort();
                const currentDateIndex = allDates.indexOf(date);
                
                let nextRow = rowIndex;
                let nextCol = colIndex;
                let nextDate = date;
                let move = false;

                switch (e.key) {
                  case "Enter":
                  case "ArrowDown":
                    e.preventDefault();
                    nextRow = rowIndex + 1;
                    if (nextRow > 9) { 
                        const nextDateCandidate = allDates[currentDateIndex + 1];
                        if (nextDateCandidate) {
                            nextDate = nextDateCandidate;
                            nextRow = 0;
                        } else { nextRow = 9; }
                    }
                    move = true;
                    break;
                  case "ArrowUp":
                    e.preventDefault();
                    nextRow = rowIndex - 1;
                    if (nextRow < 0) {
                        const prevDate = allDates[currentDateIndex - 1];
                        if (prevDate) {
                            nextDate = prevDate;
                            nextRow = 9;
                        } else { nextRow = 0; }
                    }
                    move = true;
                    break;
                  case "ArrowLeft":
                    e.preventDefault();
                    nextCol = colIndex - 1;
                    if (nextCol < 1) nextCol = 1;
                    move = true;
                    break;
                  case "ArrowRight":
                    e.preventDefault();
                    nextCol = colIndex + 1;
                    if (nextCol > 5) nextCol = 5;
                    move = true;
                    break;
                  default:
                    return;
                }

                if (move) {
                    const nextInput = document.querySelector(`input[data-date='${nextDate}'][data-row='${nextRow}'][data-col='${nextCol}']`);
                    if (nextInput) {
                        nextInput.focus();
                        if(nextInput.select) nextInput.select();
                    }
                }
            });
        });
    }


    /**********************************************
     * イベント処理・ボタン機能
     **********************************************/
    
    // ビューモード切り替え
    document.getElementById("monthViewBtn").addEventListener("click", () => {
        viewMode = 'month';
        updateView();
    });
    document.getElementById("dayViewBtn").addEventListener("click", () => {
        viewMode = 'day';
        updateView();
    });

    document.getElementById("monthSelector").addEventListener("change", e => {
      autoSaveVoucherData();
      const month = e.target.value;
      currentMonth = month;
      ensureVoucherDataForMonth(month);
      populateDaySelector(month);
      currentVoucherDate = month + "-01";
      document.getElementById("daySelector").value = currentVoucherDate;
      recalcMonth();
    });

    // 日次セレクターの変更
    document.getElementById("daySelector").addEventListener("change", e => {
        currentVoucherDate = e.target.value;
        updateView();
    });
    
    // 日次移動ボタン
    document.getElementById("prevDayBtn").addEventListener("click", () => moveDay(-1));
    document.getElementById("nextDayBtn").addEventListener("click", () => moveDay(1));

    function moveDay(delta) {
      const date = new Date(currentVoucherDate + "T00:00:00");
      date.setDate(date.getDate() + delta);
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, "0");
      const day = String(date.getDate()).padStart(2, "0");
      const nextDate = `${year}-${month}-${day}`;
      const nextMonth = `${year}-${month}`;

      if (year < 1950 || year > 2099) return; 

      if (currentMonth !== nextMonth) {
          document.getElementById("monthSelector").value = nextMonth;
          currentMonth = nextMonth;
          ensureVoucherDataForMonth(nextMonth);
          populateDaySelector(nextMonth);
          recalcMonth();
      }

      if (voucherData[nextDate]) {
        currentVoucherDate = nextDate;
        document.getElementById("daySelector").value = nextDate;
        updateView();
      } 
    }

    // 設定ボタンのイベントリスナー
    document.getElementById("settingsBtn").addEventListener("click", () => {
        // 設定パネル表示時にクイック摘要をロード
        document.getElementById("quickDescInput").value = quickDescriptions.join('\n');
        document.getElementById("settingsPanel").style.display = "block";
    });
    
    // クイック摘要保存ボタン
    document.getElementById("saveQuickDescBtn").addEventListener("click", () => {
        const input = document.getElementById("quickDescInput").value;
        quickDescriptions = input.split('\n').map(desc => desc.trim()).filter(desc => desc !== '');
        autoSaveVoucherData();
        renderDatalist(); // datalistを更新
        alert("摘要を保存しました。");
    });
    
    document.getElementById("closeSettingsBtn").addEventListener("click", () => {
        document.getElementById("settingsPanel").style.display = "none";
        recalcMonth(); 
    });
    document.getElementById("deleteAllDataBtn").addEventListener("click", () => {
        if(confirm("全てのデータを削除してもよろしいですか？この操作は取り消せません。")) {
            voucherData = {};
            localStorage.removeItem("voucherData");
            initApp();
            document.getElementById("settingsPanel").style.display = "none";
            alert("データを削除しました。");
        }
    });

    // 表示中の伝票/月をクリアする機能
    document.getElementById("clearViewBtn").addEventListener("click", () => {
        if (viewMode === 'month') {
             if(!confirm(`現在表示中の【${currentMonth}】の全明細を全てクリアしますか？\n（${currentMonth}-01の前日残高は維持されます）`)) return;
            
            const sortedDatesForMonth = Object.keys(voucherData)
                .filter(date => date.startsWith(currentMonth))
                .sort();
            
            sortedDatesForMonth.forEach(date => {
                const v = voucherData[date];
                if(v) {
                    v.details.forEach(d => {
                        d.depositCategory = "";
                        d.depositAmount = 0;
                        d.description = "";
                        d.withdrawalAmount = 0;
                        d.withdrawalCategory = "";
                    });
                }
            });
        } else { // viewMode === 'day'
            if(!confirm(`現在表示中の【${currentVoucherDate}】の明細を全てクリアしますか？\n（前日残高は維持されます）`)) return;
            
            const v = voucherData[currentVoucherDate];
            if(!v) return;

            v.details.forEach(d => {
                d.depositCategory = "";
                d.depositAmount = 0;
                d.description = "";
                d.withdrawalAmount = 0;
                d.withdrawalCategory = "";
            });
        }
        
        recalcMonth();
    });


    /**********************************************
     * 売上CSV読込機能
     **********************************************/
    document.getElementById("salesCsvLoadBtn").addEventListener("click", () => {
        document.getElementById("salesCsvInput").click();
    });

    document.getElementById("salesCsvInput").addEventListener("change", e => {
        const file = e.target.files[0];
        if(!file) return;

        const reader = new FileReader();
        reader.onload = function(event) {
            try {
                const text = event.target.result;
                const lines = text.split(/\r\n|\n/);
                if(lines.length < 2) throw new Error("データが空か不正です。");

                const headers = lines[0].split(",");
                const colMap = {
                    date: 0, salesTaxInc: -1, square: -1, paypay: -1, gift: -1, funfo: -1
                };

                headers.forEach((h, i) => {
                    const cleanH = h.trim();
                    if(cleanH === "売上高（税込）") colMap.salesTaxInc = i;
                    else if(cleanH === "Square") colMap.square = i;
                    else if(cleanH === "PayPay") colMap.paypay = i;
                    else if(cleanH === "袋井商品券") colMap.gift = i;
                    else if(cleanH === "Funfo") colMap.funfo = i;
                });

                if(colMap.salesTaxInc === -1) throw new Error("「売上高（税込）」列が見つかりません。");

                let processedCount = 0;

                for(let i=1; i<lines.length; i++) {
                    const rowRaw = lines[i];
                    if(!rowRaw.trim()) continue;
                    
                    const row = rowRaw.split(",");
                    let dateStr = row[colMap.date];
                    if(!dateStr) continue;
                    dateStr = dateStr.replace(/\//g, "-"); 
                    
                    if(voucherData[dateStr]) {
                        const v = voucherData[dateStr];
                        
                        const getVal = (idx) => {
                            if(idx === -1 || !row[idx]) return 0;
                            return parseFloat(row[idx]) || 0;
                        };

                        const salesVal = getVal(colMap.salesTaxInc);
                        const creditTotal = getVal(colMap.square) + getVal(colMap.paypay) + getVal(colMap.gift) + getVal(colMap.funfo);

                        const detail = v.details[0]; 
                        
                        detail.depositCategory = "売上";
                        detail.depositAmount = salesVal;
                        
                        if(creditTotal > 0) {
                            detail.withdrawalCategory = "売掛金";
                            detail.withdrawalAmount = creditTotal;
                        } else {
                            detail.withdrawalCategory = "";
                            detail.withdrawalAmount = 0;
                        }
                        
                        processedCount++;
                    }
                }

                autoSaveVoucherData();
                recalcMonth();
                alert(`${processedCount}件のデータを反映しました。`);

            } catch(err) {
                console.error(err);
                alert("CSV読み込みエラー: " + err.message);
            } finally {
                e.target.value = "";
            }
        };
        reader.readAsText(file); 
    });


    /**********************************************
     * 検索機能
     **********************************************/
    document.getElementById("searchBtn").addEventListener("click", () => {
      document.querySelectorAll(".highlight-cell").forEach(cell => cell.classList.remove("highlight-cell"));
      const keyword = document.getElementById("searchKeyword").value.trim().toLowerCase();
      const resultsDiv = document.getElementById("searchResults");
      resultsDiv.innerHTML = "";

      if (keyword === "") { alert("検索キーワードを入力してください。"); return; }

      const sortedDates = Object.keys(voucherData).sort();
      let foundResults = [];
      
      sortedDates.forEach(date => {
        const voucher = voucherData[date];
        if (!voucher) return;
        
        let foundInVoucher = false;

        const summaryValues = [
            String(voucher.prevBalance), String(voucher.deposit), 
            String(voucher.withdrawal), String(voucher.balance), voucher.date
        ];
        if (summaryValues.some(v => v.includes(keyword))) {
            foundInVoucher = true;
        }

        if (!foundInVoucher) {
          foundInVoucher = voucher.details.some(row => {
            return (row.depositCategory && row.depositCategory.toLowerCase().includes(keyword)) ||
                   String(row.depositAmount).includes(keyword) ||
                   (row.description && row.description.toLowerCase().includes(keyword)) ||
                   String(row.withdrawalAmount).includes(keyword) ||
                   (row.withdrawalCategory && row.withdrawalCategory.toLowerCase().includes(keyword));
          });
        }

        if (foundInVoucher) {
          foundResults.push(date);
        }
      });
      
      foundResults.forEach(date => {
          const itemDiv = document.createElement("div");
          itemDiv.classList.add("search-result-item");
          const link = document.createElement("a");
          link.textContent = date;
          link.href = "#";
          link.addEventListener("click", e => {
            e.preventDefault();
            const selectedMonth = date.slice(0, 7);
            document.getElementById("monthSelector").value = selectedMonth;
            currentMonth = selectedMonth;
            ensureVoucherDataForMonth(selectedMonth);
            populateDaySelector(selectedMonth);
            currentVoucherDate = date;
            document.getElementById("daySelector").value = currentVoucherDate;
            
            viewMode = 'day'; 
            recalcMonth();
            
            const target = document.querySelector(`.daily-voucher-card[data-date='${date}']`);
            if(target) {
                target.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
          });
          itemDiv.appendChild(link);
          resultsDiv.appendChild(itemDiv);
      });
      
      if (resultsDiv.children.length === 0) resultsDiv.textContent = "検索結果はありません。";
      else {
          if (viewMode === 'month') {
              renderMonthView(currentMonth, keyword);
          } else {
              renderViewDetails(currentVoucherDate, 'singleDailyCard', keyword);
          }
      }
    });

    document.getElementById("clearSearchBtn").addEventListener("click", () => {
      document.getElementById("searchResults").innerHTML = "";
      document.getElementById("searchKeyword").value = "";
      document.querySelectorAll(".highlight-cell").forEach(cell => cell.classList.remove("highlight-cell"));
      updateView(); 
    });

    /**********************************************
     * Excel / JSON 保存・読込
     **********************************************/
    // (Excel / JSON の保存・読込ロジックは変更なし)

    document.getElementById("excelSaveBtn").addEventListener("click", async () => {
      showLoading("Excelファイルを作成中...");
      try {
        const month = document.getElementById("monthSelector").value;
        const workbook = new ExcelJS.Workbook();

        const sortedDatesForMonth = Object.keys(voucherData)
          .filter(date => date.startsWith(month))
          .sort();
          
        const summarySheet = workbook.addWorksheet('月次サマリー');
        let summaryRow = 1;
        summarySheet.getRow(summaryRow++).values = ['日付', '前日残高', '本日入金', '本日出金', '本日残高'];
        
        let maxSummaryWidths = [10, 10, 10, 10, 10]; 
        
        sortedDatesForMonth.forEach(date => {
            const v = voucherData[date];
            const row = summarySheet.getRow(summaryRow);
            const values = [v.date, v.prevBalance, v.deposit, v.withdrawal, v.balance];
            row.values = values;
            
            values.forEach((val, i) => {
                const len = String(val).length;
                if (len > maxSummaryWidths[i]) {
                    maxSummaryWidths[i] = len;
                }
            });
            
            [2,3,4,5].forEach(c => {
               row.getCell(c).numFmt = '#,##0';
               row.getCell(c).alignment = { horizontal: 'right' };
            });
            summaryRow++;
        });

        summarySheet.columns = maxSummaryWidths.map(w => ({ width: w + 2 }));


        const voucherSheet = workbook.addWorksheet('入出金伝票');
        
        let maxDetailWidths = [5, 15, 15, 30, 15, 15]; 
        
        let currentRow = 1;

        for (const date of sortedDatesForMonth) {
          const v = voucherData[date];
          
          const headerRow = voucherSheet.getRow(currentRow);
          headerRow.values = ['伝票日付', '前日残高', '本日入金', '本日出金', '本日残高'];
          headerRow.font = { bold: true };
          headerRow.fill = { type: 'pattern', pattern:'solid', fgColor:{argb:'FFF2F2F2'} };
          headerRow.eachCell(cell => {
               cell.border = { top: {style:'thin'}, left: {style:'thin'}, bottom: {style:'thin'}, right: {style:'thin'} };
               cell.alignment = { horizontal: 'center' };
          });
          currentRow++;

          const summaryRow = voucherSheet.getRow(currentRow);
          summaryRow.values = [v.date, v.prevBalance, v.deposit, v.withdrawal, v.balance];
          summaryRow.getCell(1).alignment = { horizontal: 'center' };
          
          [1, 2, 3, 4, 5].forEach(c => {
              const val = summaryRow.getCell(c).value;
              const len = String(val).length;
              if (c === 1 && len > maxDetailWidths[0]) maxDetailWidths[0] = len + 1;
              if (c > 1 && len > maxDetailWidths[c - 1]) maxDetailWidths[c - 1] = len + 1;
          });
          
          [2,3,4,5].forEach(c => {
              summaryRow.getCell(c).numFmt = '#,##0';
              summaryRow.getCell(c).alignment = { horizontal: 'right' };
          });
          summaryRow.eachCell(cell => {
               cell.border = { top: {style:'thin'}, left: {style:'thin'}, bottom: {style:'thin'}, right: {style:'thin'} };
          });
          currentRow++;

          const detailHeader = voucherSheet.getRow(currentRow);
          detailHeader.values = ['No.', '入金科目', '入金金額', '摘要', '出金金額', '出金科目'];
          detailHeader.font = { bold: true };
          detailHeader.eachCell(cell => {
               cell.border = { top: {style:'thin'}, left: {style:'thin'}, bottom: {style:'thin'}, right: {style:'thin'} };
               cell.alignment = { horizontal: 'center' };
               cell.fill = { type: 'pattern', pattern:'solid', fgColor:{argb:'FFEFEFEF'} };
          });
          currentRow++;

          v.details.forEach(detail => {
            const r = voucherSheet.getRow(currentRow);
            const values = [detail.no, detail.depositCategory, detail.depositAmount, detail.description, detail.withdrawalAmount, detail.withdrawalCategory];
            r.values = values;
            
            values.forEach((val, i) => {
                const len = String(val).length;
                if (len > maxDetailWidths[i]) { 
                    maxDetailWidths[i] = len + 1; 
                }
            });

            r.eachCell((cell, colNumber) => {
              cell.border = { top: {style:'dotted'}, left: {style:'thin'}, bottom: {style:'dotted'}, right: {style:'thin'} };
              if (colNumber === 3 || colNumber === 5) {
                 cell.numFmt = '#,##0';
                 cell.alignment = { horizontal: 'right' };
              }
            });
            currentRow++;
          });
          currentRow += 1;
        }

        voucherSheet.columns = maxDetailWidths.map(w => ({ width: w + 1 }));


        const buffer = await workbook.xlsx.writeBuffer();
        const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${month}_入出金伝票_月次サマリー付.xlsx`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
        alert("Excelファイルの保存が完了しました。");
      } catch (error) {
          console.error("Excel保存エラー:", error);
          alert("Excelファイルの保存中にエラーが発生しました。");
      } finally { hideLoading(); }
    });

    document.getElementById("excelLoadBtn").addEventListener("click", () => {
      document.getElementById("excelLoadInput").click();
    });

    document.getElementById("excelLoadInput").addEventListener("change", async e => {
      const file = e.target.files[0];
      if (!file) return;
      showLoading("Excelデータを読み込み中...");
      try {
        const buffer = await file.arrayBuffer();
        const workbook = new ExcelJS.Workbook();
        await workbook.xlsx.load(buffer);
        const sheet = workbook.getWorksheet(1) || workbook.getWorksheet('入出金伝票');
        if (!sheet) throw new Error("伝票データシートが見つかりません。");

        let loadedData = {};
        let currentVoucher = null;

        sheet.eachRow((row, rowNumber) => {
          const cellA = row.getCell(1).value; 
          let valA = String(cellA || "").trim();
          
          if (valA.match(/^\d{4}-\d{2}-\d{2}$/)) {
            currentVoucher = {
              date: valA,
              prevBalance: parseFloat(row.getCell(2).value) || 0,
              deposit: parseFloat(row.getCell(3).value) || 0,
              withdrawal: parseFloat(row.getCell(4).value) || 0,
              balance: parseFloat(row.getCell(5).value) || 0,
              details: []
            };
            loadedData[valA] = currentVoucher;
          }
          else if (currentVoucher && !isNaN(parseInt(valA)) && parseInt(valA) > 0) {
             if (currentVoucher.details.length < 10) {
               currentVoucher.details.push({
                 no: parseInt(valA),
                 depositCategory: String(row.getCell(2).value || ""),
                 depositAmount: parseFloat(row.getCell(3).value) || 0,
                 description: String(row.getCell(4).value || ""),
                 withdrawalAmount: parseFloat(row.getCell(5).value) || 0,
                 withdrawalCategory: String(row.getCell(6).value || "")
               });
             }
          }
        });

        Object.values(loadedData).forEach(v => {
           while(v.details.length < 10) {
             v.details.push({ no: v.details.length + 1, depositCategory: "", depositAmount: 0, description: "", withdrawalAmount: 0, withdrawalCategory: "" });
           }
        });

        if (Object.keys(loadedData).length === 0) {
           alert("有効な伝票データが見つかりませんでした。");
           return;
        }

        if (confirm("現在のデータを上書きしてExcelデータを読み込みますか？")) {
            voucherData = loadedData;
            autoSaveVoucherData();
            
            recalcMonth();
            
            const dates = Object.keys(loadedData).sort();
            const firstDate = dates[0];
            if(firstDate) {
               currentMonth = firstDate.slice(0, 7);
               document.getElementById("monthSelector").value = currentMonth;
               currentVoucherDate = firstDate;
               document.getElementById("daySelector").value = currentVoucherDate;
               ensureVoucherDataForMonth(currentMonth);
               updateView();
            }
            alert("読み込み完了しました。");
        }
      } catch (err) {
        console.error(err);
        alert("Excel読み込みエラー: " + err.message);
      } finally {
        e.target.value = '';
        hideLoading();
      }
    });
    
    document.getElementById("jsonSaveBtn").addEventListener("click", () => {
      const dataToSave = { voucherData: voucherData, syncRows: syncRows, quickDescriptions: quickDescriptions };
      const jsonStr = JSON.stringify(dataToSave, null, 2);
      const dataUri = "data:application/json;charset=utf-8," + encodeURIComponent(jsonStr);
      const link = document.createElement("a");
      link.href = dataUri;
      link.download = "入出金伝票_バックアップ.json";
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    });
    document.getElementById("jsonLoadBtn").addEventListener("click", () => document.getElementById("jsonLoadInput").click());
    document.getElementById("jsonLoadInput").addEventListener("change", e => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(event) {
        try {
          const loadedData = JSON.parse(event.target.result);
          if (loadedData.voucherData) {
            if (confirm("JSONからデータを復元しますか？")) {
              voucherData = loadedData.voucherData;
              if(loadedData.syncRows) syncRows = loadedData.syncRows;
              if(loadedData.quickDescriptions) quickDescriptions = loadedData.quickDescriptions;
              autoSaveVoucherData();
              initApp();
              alert("復元しました。");
            }
          }
        } catch(e) { alert("JSON読み込みエラー"); }
      };
      reader.readAsText(file);
      e.target.value = '';
    });
    document.getElementById("printBtn").addEventListener("click", () => window.print());
    
    window.addEventListener("load", initApp);
  </script>
</body>
</html>
