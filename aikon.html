<!DOCTYPE html>
<html lang="ja">
<head>
  <link rel="manifest" href="manifest.json" />
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('service-worker.js');
    }
  </script>

  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>é«˜åº¦ãª3Dã‚¢ã‚¤ã‚³ãƒ³ä½œæˆãƒ„ãƒ¼ãƒ«</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Noto+Sans+JP:wght@300;400;500;700&family=M+PLUS+Rounded+1c:wght@400;700&family=Kosugi+Maru&family=Varela+Round&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #667eea;
      --secondary: #764ba2;
      --accent: #f093fb;
      --success: #10b981;
      --warning: #f59e0b;
      --error: #ef4444;
      --surface: #ffffff;
      --surface-2: #f8fafc;
      --background: #f1f5f9;
      --text-primary: #1e293b;
      --text-secondary: #64748b;
      --text-muted: #94a3b8;
      --border: #e2e8f0;
      --border-focus: #cbd5e1;
      --shadow-sm: rgba(0, 0, 0, 0.05);
      --shadow: rgba(0, 0, 0, 0.1);
      --shadow-lg: rgba(0, 0, 0, 0.15);
      --radius: 12px;
      --radius-sm: 8px;
      --transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      --transition-slow: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      font-family: 'Inter', 'Noto Sans JP', sans-serif;
      min-height: 100vh;
      color: var(--text-primary);
      line-height: 1.5;
    }

    .app-container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
      display: grid;
      grid-template-columns: minmax(320px, 400px) 1fr;
      gap: 30px;
      min-height: 100vh;
    }

    .control-panel {
      background: var(--surface);
      border-radius: var(--radius);
      padding: 30px;
      box-shadow: 0 20px 25px -5px var(--shadow), 0 10px 10px -5px var(--shadow);
      height: fit-content;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .preview-area {
      background: var(--surface);
      border-radius: var(--radius);
      padding: 30px;
      box-shadow: 0 20px 25px -5px var(--shadow), 0 10px 10px -5px var(--shadow);
      display: flex;
      flex-direction: column;
      gap: 30px;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    h1 {
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
      font-size: 2.5rem;
      font-weight: 700;
      text-align: center;
      margin-bottom: 30px;
      letter-spacing: -0.02em;
    }

    .section { margin-bottom: 25px; }
    
    .section-title {
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 15px;
      padding-bottom: 8px;
      border-bottom: 2px solid var(--border);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .control-row { display: flex; flex-direction: column; gap: 15px; margin-bottom: 20px; }
    .control { display: flex; flex-direction: column; gap: 8px; }
    .control-inline { display: flex; flex-direction: row; align-items: center; gap: 12px; flex-wrap: wrap; }
    
    label { font-weight: 500; color: var(--text-secondary); font-size: 0.9rem; cursor: pointer; }
    
    input, select, textarea {
      padding: 12px 16px;
      border: 2px solid var(--border);
      border-radius: var(--radius-sm);
      font-size: 15px;
      transition: var(--transition);
      background: var(--surface);
      color: var(--text-primary);
      font-family: inherit;
    }

    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
    }

    input:invalid { border-color: var(--error); }
    
    input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
    input[type=number] { -moz-appearance: textfield; }
    
    input[type="file"] { padding: 10px; background: var(--surface-2); cursor: pointer; }
    input[type="file"]::file-selector-button {
      background: var(--primary);
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: var(--radius-sm);
      cursor: pointer;
      margin-right: 10px;
      transition: var(--transition);
    }
    input[type="file"]::file-selector-button:hover { background: var(--secondary); }

    input[type="range"] {
      appearance: none;
      height: 6px;
      background: var(--border);
      border-radius: 3px;
      padding: 0;
      border: none;
      cursor: pointer;
    }
    
    input[type="range"]::-webkit-slider-thumb {
      appearance: none;
      width: 20px;
      height: 20px;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      border-radius: 50%;
      cursor: pointer;
      box-shadow: 0 2px 4px var(--shadow);
      transition: var(--transition);
    }
    input[type="range"]::-webkit-slider-thumb:hover { transform: scale(1.1); }
    
    input[type="color"] {
      width: 60px;
      height: 40px;
      border-radius: var(--radius-sm);
      cursor: pointer;
      padding: 2px;
      border: 2px solid var(--border);
    }

    textarea { resize: vertical; min-height: 80px; font-family: inherit; }

    .color-display { display: flex; align-items: center; gap: 10px; margin-top: 5px; }
    .color-box {
      width: 24px;
      height: 24px;
      border-radius: 6px;
      border: 2px solid var(--border);
      box-shadow: inset 0 1px 2px var(--shadow);
      flex-shrink: 0;
    }
    .color-hex {
      font-family: 'SF Mono', 'Monaco', 'Consolas', monospace;
      font-size: 0.85rem;
      color: var(--text-secondary);
      background: var(--surface-2);
      padding: 4px 8px;
      border-radius: 4px;
      min-width: 70px;
      text-align: center;
    }

    .radio-group, .checkbox-group { display: flex; gap: 15px; flex-wrap: wrap; }
    .radio-item, .checkbox-item {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      padding: 8px 12px;
      border-radius: 6px;
      transition: var(--transition);
      border: 1px solid transparent;
    }
    .radio-item:hover, .checkbox-item:hover { background: var(--surface-2); border-color: var(--border-focus); }

    input[type="radio"], input[type="checkbox"] {
      appearance: none;
      width: 18px;
      height: 18px;
      border: 2px solid var(--border);
      border-radius: 50%;
      position: relative;
      cursor: pointer;
      transition: var(--transition);
      margin: 0;
      padding: 0;
    }
    input[type="checkbox"] { border-radius: 4px; }
    
    input[type="radio"]:checked, input[type="checkbox"]:checked {
      border-color: var(--primary);
      background: var(--primary);
    }
    input[type="radio"]:checked::before {
      content: ''; width: 8px; height: 8px; background: white; border-radius: 50%;
      position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
    }
    input[type="checkbox"]:checked::before {
      content: 'âœ“'; color: white; font-size: 12px; font-weight: bold;
      position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
    }

    .button-group { display: flex; gap: 15px; margin-top: 30px; }
    button {
      flex: 1; padding: 14px 20px; border: none; border-radius: 10px;
      font-size: 16px; font-weight: 600; cursor: pointer; transition: var(--transition);
      position: relative; overflow: hidden; font-family: inherit; min-height: 48px;
    }
    button:disabled { opacity: 0.5; cursor: not-allowed; transform: none !important; }
    
    .btn-primary { background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3); }
    .btn-secondary { background: linear-gradient(135deg, #f093fb, #f5576c); color: white; box-shadow: 0 4px 15px rgba(245, 87, 108, 0.3); }
    .btn-accent { background: linear-gradient(135deg, #4facfe, #00f2fe); color: white; box-shadow: 0 4px 15px rgba(79, 172, 254, 0.3); }
    .btn-success { background: linear-gradient(135deg, var(--success), #059669); color: white; box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3); }
    
    button:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4); }
    button:active:not(:disabled) { transform: translateY(0); }
    
    .btn-outline { background: var(--surface); border: 2px solid var(--border); color: var(--text-secondary); box-shadow: none; }
    .btn-outline:hover:not(:disabled) { background: var(--surface-2); border-color: var(--border-focus); color: var(--text-primary); box-shadow: none; transform: none; }

    .preview-canvas-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 20px;
      padding: 30px;
      background: linear-gradient(135deg, #f8fafc, #e2e8f0);
      border-radius: var(--radius);
      border: 3px dashed var(--border);
      position: relative;
      transition: var(--transition);
    }
    .preview-canvas-container.dragover {
      background: rgba(102, 126, 234, 0.1);
      border-color: var(--primary);
    }

    canvas, #svgPreview {
      border-radius: var(--radius);
      box-shadow: 0 10px 25px var(--shadow-lg);
      transition: var(--transition-slow);
      max-width: 100%;
      height: auto;
      background: transparent;
    }

    .size-indicator { color: var(--text-secondary); font-size: 0.9rem; font-weight: 500; }
    
    .advanced-controls { display: none; animation: slideDown 0.3s ease-out; }
    .advanced-controls.show { display: block; }
    @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
    
    .toggle-advanced {
      background: none; border: 2px solid var(--primary); color: var(--primary);
      padding: 8px 16px; border-radius: 6px; font-size: 0.9rem; margin-bottom: 20px;
      transition: var(--transition); width: 100%;
    }
    .toggle-advanced:hover { background: var(--primary); color: white; transform: none; box-shadow: none; }

    .preset-buttons { display: grid; grid-template-columns: repeat(auto-fit, minmax(80px, 1fr)); gap: 10px; margin-top: 15px; }
    .preset-btn {
      padding: 8px; border-radius: 6px; font-size: 0.8rem; background: var(--surface-2);
      border: 1px solid var(--border); cursor: pointer; transition: var(--transition);
      color: var(--text-primary); font-weight: 500;
    }
    .preset-btn:hover { background: var(--primary); color: white; transform: none; box-shadow: none; }

    .export-options { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 15px; margin-top: 20px; }
    .export-btn {
      display: flex; flex-direction: column; align-items: center; gap: 8px; padding: 20px;
      border: 2px solid var(--border); border-radius: var(--radius); background: var(--surface);
      cursor: pointer; transition: var(--transition); text-decoration: none; color: inherit;
    }
    .export-btn:hover { border-color: var(--primary); background: rgba(102, 126, 234, 0.05); transform: translateY(-2px); }
    .export-icon {
      width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center;
      justify-content: center; font-size: 14px; font-weight: bold; color: white;
    }
    
    .range-display { display: flex; align-items: center; gap: 10px; }
    .range-display input[type="range"] { flex: 1; }
    .range-display output {
      min-width: 50px; text-align: center; font-weight: 600; color: var(--primary);
      background: var(--surface-2); padding: 4px 8px; border-radius: 4px; font-size: 0.9rem;
    }
    
    .size-input-group { display: flex; gap: 10px; }
    .size-input-group input { flex: 1; }
    
    .tooltip { position: relative; }
    .tooltip::after {
      content: attr(data-tooltip); position: absolute; top: -10px; left: 50%;
      transform: translate(-50%, -100%); background: var(--text-primary); color: white;
      padding: 6px 10px; border-radius: 6px; font-size: 0.8rem; white-space: nowrap;
      opacity: 0; pointer-events: none; transition: var(--transition); z-index: 1000;
    }
    .tooltip:hover::after { opacity: 1; transform: translate(-50%, -100%); }

    .error-message, .success-message {
      padding: 12px; border-radius: var(--radius-sm); margin-top: 10px; font-size: 0.9rem; display: none;
    }
    .error-message { background: rgba(239, 68, 68, 0.1); border: 1px solid var(--error); color: var(--error); }
    .success-message { background: rgba(16, 185, 129, 0.1); border: 1px solid var(--success); color: var(--success); }
    
    .mode-switcher {
      display: flex; background: var(--surface-2); border-radius: var(--radius-sm);
      padding: 6px; margin-bottom: 25px; border: 1px solid var(--border);
    }
    .mode-switcher label {
      flex: 1; text-align: center; padding: 10px; border-radius: 6px; font-weight: 600;
      color: var(--text-secondary); cursor: pointer; transition: var(--transition); position: relative;
    }
    .mode-switcher input[type="radio"] { display: none; }
    .mode-switcher input[type="radio"]:checked + label {
      background: var(--surface); color: var(--primary); box-shadow: 0 2px 8px var(--shadow-sm); border: 1px solid var(--border-focus);
    }

    /* ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é ˜åŸŸ */
    .utility-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      width: 100%;
      margin-top: 10px;
    }

    @media (max-width: 1200px) { .app-container { grid-template-columns: 1fr; max-width: 800px; } }
    @media (max-width: 768px) {
      .app-container { padding: 15px; gap: 20px; }
      .control-panel, .preview-area { padding: 20px; }
      h1 { font-size: 2rem; }
      .button-group { flex-direction: column; }
      .export-options { grid-template-columns: repeat(2, 1fr); }
      .radio-group, .checkbox-group { flex-direction: column; gap: 10px; }
      .preset-buttons { grid-template-columns: repeat(3, 1fr); }
    }
    @media (max-width: 480px) {
      .control-inline { flex-direction: column; align-items: stretch; }
      .size-input-group { flex-direction: column; }
      .export-options { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div class="app-container">
    <div class="control-panel">
      <h1>ğŸ¨ é«˜åº¦ãª3Dã‚¢ã‚¤ã‚³ãƒ³ä½œæˆãƒ„ãƒ¼ãƒ«</h1>

      <div class="mode-switcher">
        <input type="radio" name="mode" id="modeText" value="text" checked>
        <label for="modeText">ğŸ“ ãƒ†ã‚­ã‚¹ãƒˆ</label>
        
        <input type="radio" name="mode" id="modeImage" value="image">
        <label for="modeImage">ğŸ–¼ï¸ ç”»åƒ</label>
      </div>
      
      <div class="section" id="textSettingsSection">
        <div class="section-title">ğŸ“ ãƒ†ã‚­ã‚¹ãƒˆè¨­å®š</div>
        <div class="control">
          <label for="iconText">è¡¨ç¤ºãƒ†ã‚­ã‚¹ãƒˆ</label>
          <textarea id="iconText" placeholder="ã‚¢ã‚¤ã‚³ãƒ³ã«è¡¨ç¤ºã™ã‚‹ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›" rows="2" maxlength="50">æ¾ä¹ƒæœ¨é£¯åº—</textarea>
          <small class="color-hex">æ–‡å­—æ•°: <span id="textLength">5</span>/50</small>
        </div>
        
        <div class="control">
          <label for="fontFamily">ãƒ•ã‚©ãƒ³ãƒˆ</label>
          <select id="fontFamily">
            <option value="'Inter', sans-serif">Inter (ãƒ¢ãƒ€ãƒ³)</option>
            <option value="'Noto Sans JP', sans-serif">Noto Sans JP</option>
            <option value="'M PLUS Rounded 1c', sans-serif" selected>M PLUS Rounded (ä¸¸æ–‡å­—)</option>
            <option value="'Kosugi Maru', sans-serif">Kosugi Maru</option>
            <option value="'Varela Round', sans-serif">Varela Round</option>
            <option value="system-ui, sans-serif">ã‚·ã‚¹ãƒ†ãƒ ãƒ•ã‚©ãƒ³ãƒˆ</option>
            <option value="'Courier New', monospace">ç­‰å¹…ãƒ•ã‚©ãƒ³ãƒˆ</option>
          </select>
        </div>

        <div class="control">
          <label for="fontWeight">æ–‡å­—ã®å¤ªã•</label>
          <select id="fontWeight">
            <option value="300">Light (300)</option>
            <option value="400">Regular (400)</option>
            <option value="500">Medium (500)</option>
            <option value="600">SemiBold (600)</option>
            <option value="700">Bold (700)</option>
            <option value="800" selected>ExtraBold (800)</option>
            <option value="900">Black (900)</option>
          </select>
        </div>
      </div>

      <div class="section" id="imageSettingsSection" style="display: none;">
        <div class="section-title">ğŸ–¼ï¸ ç”»åƒè¨­å®š</div>
        <div class="control">
          <label for="imageUpload">ç”»åƒãƒ•ã‚¡ã‚¤ãƒ« (ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—å¯¾å¿œ)</label>
          <input type="file" id="imageUpload" accept="image/png, image/jpeg, image/webp">
        </div>
        
        <div class="control">
          <label for="imageFit">ç”»åƒã®è¡¨ç¤ºæ–¹æ³•</label>
          <select id="imageFit">
            <option value="contain" selected>å…¨ä½“ã‚’è¡¨ç¤º (Contain)</option>
            <option value="cover">å…¨ä½“ã‚’åŸ‹ã‚ã‚‹ (Cover)</option>
          </select>
        </div>

        <div class="control">
          <button id="clearImageBtn" class="btn-outline">ç”»åƒã‚’ã‚¯ãƒªã‚¢</button>
        </div>
      </div>

      <div class="section">
        <div class="section-title">ğŸ¨ ã‚«ãƒ©ãƒ¼è¨­å®š (èƒŒæ™¯)</div>
        <div class="control">
          <label for="gradColor1">èƒŒæ™¯ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³1</label>
          <div class="control-inline">
            <input type="color" id="gradColor1" value="#667eea">
            <div class="color-display">
              <div class="color-box" id="gradColor1Box"></div>
              <div class="color-hex" id="gradColor1Hex">#667EEA</div>
            </div>
          </div>
        </div>

        <div class="control">
          <label for="gradColor2">èƒŒæ™¯ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³2</label>
          <div class="control-inline">
            <input type="color" id="gradColor2" value="#764ba2">
            <div class="color-display">
              <div class="color-box" id="gradColor2Box"></div>
              <div class="color-hex" id="gradColor2Hex">#764BA2</div>
            </div>
          </div>
        </div>

        <div class="preset-buttons">
          <button class="preset-btn" data-colors="#667eea,#764ba2">ã‚ªãƒ¼ã‚·ãƒ£ãƒ³</button>
          <button class="preset-btn" data-colors="#f093fb,#f5576c">ã‚µãƒ³ã‚»ãƒƒãƒˆ</button>
          <button class="preset-btn" data-colors="#4facfe,#00f2fe">ã‚¹ã‚«ã‚¤</button>
          <button class="preset-btn" data-colors="#43e97b,#38f9d7">ãƒ•ã‚©ãƒ¬ã‚¹ãƒˆ</button>
          <button class="preset-btn" data-colors="#fa709a,#fee140">ã‚¦ã‚©ãƒ¼ãƒ </button>
          <button class="preset-btn" data-colors="#a8edea,#fed6e3">ãƒ‘ã‚¹ãƒ†ãƒ«</button>
          <button class="preset-btn" data-colors="#ff6b6b,#ee5a52">ã‚³ãƒ¼ãƒ©ãƒ«</button>
          <button class="preset-btn" data-colors="#4ecdc4,#44a08d">ãƒ†ã‚£ãƒ¼ãƒ«</button>
        </div>
      </div>

      <div class="section">
        <div class="section-title">âš™ï¸ åŸºæœ¬è¨­å®š</div>
        <div class="control">
          <label for="iconSize">ã‚¢ã‚¤ã‚³ãƒ³ã‚µã‚¤ã‚º</label>
          <select id="iconSize">
            <option value="64">64Ã—64 (ãƒ•ã‚¡ãƒ“ã‚³ãƒ³)</option>
            <option value="128">128Ã—128 (ã‚¢ãƒ—ãƒª)</option>
            <option value="192">192Ã—192 (ã‚¦ã‚§ãƒ¼ãƒ–)</option>
            <option value="256" selected>256Ã—256 (æ¨™æº–)</option>
            <option value="512">512Ã—512 (é«˜è§£åƒåº¦)</option>
            <option value="1024">1024Ã—1024 (è¶…é«˜è§£åƒåº¦)</option>
            <option value="custom">ã‚«ã‚¹ã‚¿ãƒ </option>
          </select>
        </div>
        <div class="control size-input-group" id="customSizeInputs" style="display: none;">
          <input type="number" id="iconWidth" placeholder="å¹… (px)" value="256" min="32" max="2048" step="1">
          <input type="number" id="iconHeight" placeholder="é«˜ã• (px)" value="256" min="32" max="2048" step="1">
        </div>

        <div class="control" id="textLetterSpacingControl">
          <label for="letterSpacing">æ–‡å­—é–“éš”</label>
          <div class="range-display">
            <input type="range" id="letterSpacing" min="-5" max="20" value="0" step="0.5">
            <output id="letterSpacingValue">0</output>
          </div>
        </div>

        <div class="control" id="textLineHeightControl">
          <label for="lineHeight">è¡Œé–“éš”</label>
          <div class="range-display">
            <input type="range" id="lineHeight" min="0.8" max="2.0" value="1.2" step="0.1">
            <output id="lineHeightValue">1.2</output>
          </div>
        </div>
      </div>

      <button class="toggle-advanced" onclick="toggleAdvanced()">ğŸ”§ é«˜åº¦ãªè¨­å®šã‚’è¡¨ç¤º</button>

      <div class="advanced-controls" id="advancedControls">
        <div class="section">
          <div class="section-title">ğŸ’« ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ</div>

          <div class="control">
            <div class="checkbox-item">
              <input type="checkbox" id="enableFrame">
              <label for="enableFrame">ğŸ–¼ï¸ é¡ç¸ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã‚’è¿½åŠ </label>
            </div>
          </div>
          
          <div id="frameSettings" style="display: none; padding-left: 10px; border-left: 2px solid var(--border); margin-top: 10px; margin-bottom: 20px;">
            <div class="control" style="margin-bottom: 15px;">
              <label for="frameColor">é¡ç¸ã®è‰²</label>
              <div class="control-inline">
                <input type="color" id="frameColor" value="#8b5a2b">
                <div class="color-display"><div class="color-box" id="frameColorBox"></div><div class="color-hex" id="frameColorHex">#8B5A2B</div></div>
              </div>
            </div>
            <div class="control">
              <label for="frameWidth">é¡ç¸ã®å¤ªã•</label>
              <div class="range-display">
                <input type="range" id="frameWidth" min="2" max="40" value="12">
                <output id="frameWidthValue">12</output>
              </div>
            </div>
          </div>

          <div class="control">
            <label>ãƒ‰ãƒ­ãƒƒãƒ—ã‚·ãƒ£ãƒ‰ã‚¦ (èƒŒæ™¯)</label>
            <div class="radio-group">
              <div class="radio-item"><input type="radio" name="dropShadow" value="0" id="shadow0"><label for="shadow0">ãªã—</label></div>
              <div class="radio-item"><input type="radio" name="dropShadow" value="3" id="shadow3" checked><label for="shadow3">è»½ã„</label></div>
              <div class="radio-item"><input type="radio" name="dropShadow" value="6" id="shadow6"><label for="shadow6">æ¨™æº–</label></div>
              <div class="radio-item"><input type="radio" name="dropShadow" value="10" id="shadow10"><label for="shadow10">å¼·ã„</label></div>
            </div>
          </div>
          
          <div class="control">
            <label>ã‚¤ãƒ³ãƒŠãƒ¼ã‚·ãƒ£ãƒ‰ã‚¦ (èƒŒæ™¯)</label>
            <div class="radio-group">
              <div class="radio-item"><input type="radio" name="innerShadow" value="0" id="innerShadow0" checked><label for="innerShadow0">ãªã—</label></div>
              <div class="radio-item"><input type="radio" name="innerShadow" value="5" id="innerShadow5"><label for="innerShadow5">è»½ã„</label></div>
              <div class="radio-item"><input type="radio" name="innerShadow" value="10" id="innerShadow10"><label for="innerShadow10">æ¨™æº–</label></div>
            </div>
          </div>

          <div id="textEffectControls">
            <div class="control">
              <label for="textGradColor1">ãƒ†ã‚­ã‚¹ãƒˆã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³1</label>
              <div class="control-inline">
                <input type="color" id="textGradColor1" value="#ffffff">
                <div class="color-display"><div class="color-box" id="textGradColor1Box"></div><div class="color-hex" id="textGradColor1Hex">#FFFFFF</div></div>
              </div>
            </div>
            <div class="control">
              <label for="textGradColor2">ãƒ†ã‚­ã‚¹ãƒˆã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³2</label>
              <div class="control-inline">
                <input type="color" id="textGradColor2" value="#e0e0e0">
                <div class="color-display"><div class="color-box" id="textGradColor2Box"></div><div class="color-hex" id="textGradColor2Hex">#E0E0E0</div></div>
              </div>
            </div>

            <div class="control">
              <div class="checkbox-item">
                <input type="checkbox" id="addOutline" checked>
                <label for="addOutline">ã‚¢ã‚¦ãƒˆãƒ©ã‚¤ãƒ³è¿½åŠ </label>
              </div>
            </div>

            <div class="control" id="outlineControls">
              <label for="outlineColor">ã‚¢ã‚¦ãƒˆãƒ©ã‚¤ãƒ³è‰²</label>
              <div class="control-inline">
                <input type="color" id="outlineColor" value="#000000">
                <div class="color-display"><div class="color-box" id="outlineColorBox"></div><div class="color-hex" id="outlineColorHex">#000000</div></div>
              </div>
            </div>
            
            <div class="control" id="outlineWidthControl">
              <label for="outlineWidth">ã‚¢ã‚¦ãƒˆãƒ©ã‚¤ãƒ³å¹…</label>
              <div class="range-display">
                <input type="range" id="outlineWidth" min="1" max="20" value="5">
                <output id="outlineWidthValue">5</output>
              </div>
            </div>
          </div>

          <div class="control">
            <label for="cornerRadius">è§’ä¸¸ã®å¼·ã•</label>
            <div class="range-display">
              <input type="range" id="cornerRadius" min="0" max="50" value="20">
              <output id="cornerRadiusValue">20%</output>
            </div>
          </div>
        </div>
      </div>

      <div class="button-group">
        <button class="btn-primary" id="randomizeBtn">ğŸ² ãƒ©ãƒ³ãƒ€ãƒ ç”Ÿæˆ</button>
        <button class="btn-secondary" id="resetBtn">ğŸ”„ ãƒªã‚»ãƒƒãƒˆ</button>
      </div>
    </div>

    <div class="preview-area">
      <div class="preview-canvas-container" id="dropZone">
        <canvas id="iconCanvas" width="256" height="256"></canvas>
        <div class="utility-bar">
          <div class="checkbox-item tooltip" data-tooltip="Androidç­‰ã§ä¸¸ãåˆ‡ã‚ŠæŠœã‹ã‚Œã‚‹å®‰å…¨é ˜åŸŸ">
            <input type="checkbox" id="showGuide">
            <label for="showGuide">PWAã‚»ãƒ¼ãƒ•ã‚¨ãƒªã‚¢ã‚¬ã‚¤ãƒ‰ã‚’è¡¨ç¤º</label>
          </div>
          <div class="size-indicator" id="sizeIndicator">256 x 256 px</div>
        </div>
      </div>

      <div class="section">
        <div class="section-title">â¬‡ï¸ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã¨ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</div>
        
        <button id="copyToClipboardBtn" class="btn-outline" style="width: 100%; margin-bottom: 15px; border-color: var(--primary); color: var(--primary);">
          ğŸ“‹ ç”»åƒã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼
        </button>

        <div class="export-options">
          <a href="#" id="downloadPngBtn" class="export-btn tooltip" data-tooltip="ã‚¦ã‚§ãƒ–ã®é€éã‚¢ã‚¤ã‚³ãƒ³ã€ãƒ­ã‚´ã«">
            <span class="export-icon" style="background: var(--success);">PNG</span>
            <span>PNG</span>
          </a>
          <a href="#" id="downloadJpgBtn" class="export-btn tooltip" data-tooltip="å†™çœŸãªã©ã€é€éãŒä¸è¦ãªç”»åƒã«">
            <span class="export-icon" style="background: var(--warning);">JPG</span>
            <span>JPG</span>
          </a>
          <a href="#" id="downloadWebpBtn" class="export-btn tooltip" data-tooltip="é«˜ç”»è³ªã‚’ä¿ã¡ã¤ã¤ã€è»½é‡ãªã‚¦ã‚§ãƒ–ç”»åƒã«">
            <span class="export-icon" style="background: var(--primary);">WEBP</span>
            <span>WEBP</span>
          </a>
          <a href="#" id="downloadSvgBtn" class="export-btn tooltip" data-tooltip="ã‚µã‚¤ã‚ºã‚’å¤‰ãˆã¦ã‚‚åŠ£åŒ–ã—ãªã„ãƒ™ã‚¯ã‚¿ãƒ¼ç”»åƒã«">
            <span class="export-icon" style="background: var(--accent);">SVG</span>
            <span>SVG</span>
          </a>
          <a href="#" id="downloadIcoBtn" class="export-btn tooltip" data-tooltip="Windowsã®ãƒ•ã‚¡ãƒ“ã‚³ãƒ³ã‚„ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆã«æœ€é©">
            <span class="export-icon" style="background: #5D5DFF;">ICO</span>
            <span>ICO</span>
          </a>
        </div>
        <div class="success-message" id="copySuccessMessage">âœ… ç”»åƒãŒã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã•ã‚Œã¾ã—ãŸï¼</div>
        <div class="error-message" id="copyErrorMessage">âš ï¸ ç”»åƒã®ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ–ãƒ©ã‚¦ã‚¶ãŒå¯¾å¿œã—ã¦ã„ãªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚</div>
      </div>
    </div>
  </div>

  <script>
    // è¦ç´ ã®å–å¾—
    const canvas = document.getElementById('iconCanvas');
    const ctx = canvas.getContext('2d');
    const iconTextarea = document.getElementById('iconText');
    const textLengthSpan = document.getElementById('textLength');
    const fontFamilySelect = document.getElementById('fontFamily');
    const fontWeightSelect = document.getElementById('fontWeight');
    const gradColor1Input = document.getElementById('gradColor1');
    const gradColor2Input = document.getElementById('gradColor2');
    const iconSizeSelect = document.getElementById('iconSize');
    const iconWidthInput = document.getElementById('iconWidth');
    const iconHeightInput = document.getElementById('iconHeight');
    const customSizeInputs = document.getElementById('customSizeInputs');
    const letterSpacingRange = document.getElementById('letterSpacing');
    const letterSpacingValue = document.getElementById('letterSpacingValue');
    const lineHeightRange = document.getElementById('lineHeight');
    const lineHeightValue = document.getElementById('lineHeightValue');
    const cornerRadiusRange = document.getElementById('cornerRadius');
    const cornerRadiusValue = document.getElementById('cornerRadiusValue');
    const dropShadowRadios = document.querySelectorAll('input[name="dropShadow"]');
    const innerShadowRadios = document.querySelectorAll('input[name="innerShadow"]');
    const addOutlineCheckbox = document.getElementById('addOutline');
    const outlineColorInput = document.getElementById('outlineColor');
    const outlineWidthRange = document.getElementById('outlineWidth');
    const outlineWidthValue = document.getElementById('outlineWidthValue');
    const outlineControls = document.getElementById('outlineControls');
    const randomizeBtn = document.getElementById('randomizeBtn');
    const resetBtn = document.getElementById('resetBtn');
    const presetBtns = document.querySelectorAll('.preset-btn');
    const downloadPngBtn = document.getElementById('downloadPngBtn');
    const downloadJpgBtn = document.getElementById('downloadJpgBtn');
    const downloadWebpBtn = document.getElementById('downloadWebpBtn');
    const downloadSvgBtn = document.getElementById('downloadSvgBtn');
    const downloadIcoBtn = document.getElementById('downloadIcoBtn');
    const copySuccessMessage = document.getElementById('copySuccessMessage');
    const copyErrorMessage = document.getElementById('copyErrorMessage');
    const sizeIndicator = document.getElementById('sizeIndicator');
    const textGradColor1Input = document.getElementById('textGradColor1');
    const textGradColor2Input = document.getElementById('textGradColor2');
    
    // æ—¢å­˜è¿½åŠ è¦ç´ 
    const modeRadios = document.querySelectorAll('input[name="mode"]');
    const textSettingsSection = document.getElementById('textSettingsSection');
    const imageSettingsSection = document.getElementById('imageSettingsSection');
    const imageUploadInput = document.getElementById('imageUpload');
    const imageFitSelect = document.getElementById('imageFit');
    const clearImageBtn = document.getElementById('clearImageBtn');
    const textLetterSpacingControl = document.getElementById('textLetterSpacingControl');
    const textLineHeightControl = document.getElementById('textLineHeightControl');
    const textEffectControls = document.getElementById('textEffectControls');
    const outlineWidthControl = document.getElementById('outlineWidthControl');

    // æ–°è¦è¿½åŠ è¦ç´ 
    const enableFrameCheckbox = document.getElementById('enableFrame');
    const frameSettings = document.getElementById('frameSettings');
    const frameColorInput = document.getElementById('frameColor');
    const frameWidthRange = document.getElementById('frameWidth');
    const frameWidthValue = document.getElementById('frameWidthValue');
    const showGuideCheckbox = document.getElementById('showGuide');
    const copyToClipboardBtn = document.getElementById('copyToClipboardBtn');
    const dropZone = document.getElementById('dropZone');

    let patternType = 'none';
    let uploadedImage = null;
    let currentMode = 'text';

    // ICOãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆé–¢æ•°
    function canvasToICO(canvas) {
      const pngDataUrl = canvas.toDataURL('image/png');
      const pngBase64 = pngDataUrl.split(',')[1];
      const pngBytes = atob(pngBase64);
      const pngLength = pngBytes.length;

      const headerSize = 6 + 16;
      const totalSize = headerSize + pngLength;
      const buffer = new ArrayBuffer(totalSize);
      const view = new DataView(buffer);
      
      let offset = 0;
      view.setUint16(offset, 0, true); offset += 2;
      view.setUint16(offset, 1, true); offset += 2;
      view.setUint16(offset, 1, true); offset += 2;
      
      const size = canvas.width;
      view.setUint8(offset, size >= 256 ? 0 : size); offset++;
      view.setUint8(offset, size >= 256 ? 0 : size); offset++;
      view.setUint8(offset, 0); offset++;
      view.setUint8(offset, 0); offset++;
      view.setUint16(offset, 1, true); offset += 2;
      view.setUint16(offset, 32, true); offset += 2;
      view.setUint32(offset, pngLength, true); offset += 4;
      view.setUint32(offset, headerSize, true); offset += 4;
      
      for (let i = 0; i < pngLength; i++) {
        view.setUint8(offset + i, pngBytes.charCodeAt(i));
      }
      return new Blob([buffer], { type: 'image/x-icon' });
    }

    // åˆæœŸçŠ¶æ…‹ã®è¨­å®š
    function initializeState() {
      iconTextarea.value = 'æ¾ä¹ƒæœ¨é£¯åº—';
      fontFamilySelect.value = "'M PLUS Rounded 1c', sans-serif";
      fontWeightSelect.value = '800';
      letterSpacingRange.value = '0';
      lineHeightRange.value = '1.2';
      
      gradColor1Input.value = '#667eea';
      gradColor2Input.value = '#764ba2';
      textGradColor1Input.value = '#ffffff';
      textGradColor2Input.value = '#e0e0e0';

      iconSizeSelect.value = '256';
      iconWidthInput.value = '256';
      iconHeightInput.value = '256';

      cornerRadiusRange.value = '20';
      addOutlineCheckbox.checked = true;
      outlineColorInput.value = '#000000';
      outlineWidthRange.value = '5';
      document.getElementById('shadow3').checked = true;
      document.getElementById('innerShadow0').checked = true;
      
      enableFrameCheckbox.checked = false;
      frameColorInput.value = '#8b5a2b';
      frameWidthRange.value = '12';
      showGuideCheckbox.checked = false;

      patternType = 'none';
      uploadedImage = null;
      imageUploadInput.value = null;
      imageFitSelect.value = 'contain';
      currentMode = 'text';
      document.getElementById('modeText').checked = true;

      updateUI();
      drawIcon();
    }

    // UIã®å€¤ã‚’æ›´æ–°
    function updateUI() {
      document.getElementById('textGradColor1Hex').textContent = textGradColor1Input.value.toUpperCase();
      document.getElementById('textGradColor1Box').style.backgroundColor = textGradColor1Input.value;
      document.getElementById('textGradColor2Hex').textContent = textGradColor2Input.value.toUpperCase();
      document.getElementById('textGradColor2Box').style.backgroundColor = textGradColor2Input.value;
      document.getElementById('gradColor1Hex').textContent = gradColor1Input.value.toUpperCase();
      document.getElementById('gradColor1Box').style.backgroundColor = gradColor1Input.value;
      document.getElementById('gradColor2Hex').textContent = gradColor2Input.value.toUpperCase();
      document.getElementById('gradColor2Box').style.backgroundColor = gradColor2Input.value;
      
      document.getElementById('frameColorHex').textContent = frameColorInput.value.toUpperCase();
      document.getElementById('frameColorBox').style.backgroundColor = frameColorInput.value;
      frameWidthValue.textContent = frameWidthRange.value;
      frameSettings.style.display = enableFrameCheckbox.checked ? 'block' : 'none';

      letterSpacingValue.textContent = letterSpacingRange.value;
      lineHeightValue.textContent = lineHeightRange.value;
      outlineWidthValue.textContent = outlineWidthRange.value;
      cornerRadiusValue.textContent = `${cornerRadiusRange.value}%`;

      textLengthSpan.textContent = iconTextarea.value.length;
      customSizeInputs.style.display = iconSizeSelect.value === 'custom' ? 'flex' : 'none';
      outlineControls.style.display = addOutlineCheckbox.checked ? 'flex' : 'none';
      outlineWidthControl.style.display = addOutlineCheckbox.checked ? 'flex' : 'none';

      const isTextMode = currentMode === 'text';
      textSettingsSection.style.display = isTextMode ? 'block' : 'none';
      textLetterSpacingControl.style.display = isTextMode ? 'flex' : 'none';
      textLineHeightControl.style.display = isTextMode ? 'flex' : 'none';
      textEffectControls.style.display = isTextMode ? 'block' : 'none';
      imageSettingsSection.style.display = isTextMode ? 'none' : 'block';
      
      downloadSvgBtn.style.display = isTextMode ? 'flex' : 'none';
    }

    // ã‚­ãƒ£ãƒ³ãƒã‚¹ã«ã‚¢ã‚¤ã‚³ãƒ³ã‚’æç”»
    function drawIcon() {
      const text = iconTextarea.value.trim();
      const fontFamily = fontFamilySelect.value;
      const fontWeight = fontWeightSelect.value;
      const textGradColor1 = textGradColor1Input.value;
      const textGradColor2 = textGradColor2Input.value;
      const gradColor1 = gradColor1Input.value;
      const gradColor2 = gradColor2Input.value;
      const letterSpacing = parseFloat(letterSpacingRange.value);
      const lineHeight = parseFloat(lineHeightRange.value);
      const cornerRadius = parseFloat(cornerRadiusRange.value) / 100;
      const dropShadow = parseInt(document.querySelector('input[name="dropShadow"]:checked').value);
      const innerShadow = parseInt(document.querySelector('input[name="innerShadow"]:checked').value);
      const addOutline = addOutlineCheckbox.checked;
      const outlineColor = outlineColorInput.value;
      const outlineWidth = parseInt(outlineWidthRange.value);

      const width = iconSizeSelect.value === 'custom' ? parseInt(iconWidthInput.value) : parseInt(iconSizeSelect.value);
      const height = iconSizeSelect.value === 'custom' ? parseInt(iconHeightInput.value) : parseInt(iconSizeSelect.value);
      
      if (isNaN(width) || isNaN(height) || width < 32 || height < 32) return;

      canvas.width = width;
      canvas.height = height;
      sizeIndicator.textContent = `${width} x ${height} px`;

      ctx.clearRect(0, 0, width, height);
      
      // ãƒ‰ãƒ­ãƒƒãƒ—ã‚·ãƒ£ãƒ‰ã‚¦
      if (dropShadow > 0) {
        ctx.shadowColor = `rgba(0, 0, 0, 0.3)`;
        ctx.shadowBlur = dropShadow * 3;
        ctx.shadowOffsetX = dropShadow * 1;
        ctx.shadowOffsetY = dropShadow * 1.5;
      } else {
         ctx.shadowColor = 'transparent';
      }

      // è§’ä¸¸ãƒ‘ã‚¹ä½œæˆ
      const radius = width * cornerRadius;
      ctx.beginPath();
      ctx.moveTo(radius, 0);
      ctx.lineTo(width - radius, 0);
      ctx.quadraticCurveTo(width, 0, width, radius);
      ctx.lineTo(width, height - radius);
      ctx.quadraticCurveTo(width, height, width - radius, height);
      ctx.lineTo(radius, height);
      ctx.quadraticCurveTo(0, height, 0, height - radius);
      ctx.lineTo(0, radius);
      ctx.quadraticCurveTo(0, 0, radius, 0);
      ctx.closePath();
      
      ctx.save();
      
      // ãƒ™ãƒ¼ã‚¹ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
      const gradient = ctx.createLinearGradient(0, 0, width, height);
      gradient.addColorStop(0, gradColor1);
      gradient.addColorStop(1, gradColor2);
      ctx.fillStyle = gradient;
      ctx.fill();
      
      ctx.restore();
      ctx.shadowColor = 'transparent';

      // ã‚¤ãƒ³ãƒŠãƒ¼ã‚·ãƒ£ãƒ‰ã‚¦
      if (innerShadow > 0) {
        ctx.save();
        ctx.clip();
        ctx.shadowColor = `rgba(0, 0, 0, 0.4)`;
        ctx.shadowBlur = innerShadow * 2;
        ctx.shadowOffsetX = 0;
        ctx.shadowOffsetY = 0;
        
        ctx.fillStyle = "black";
        ctx.beginPath();
        ctx.rect(0, 0, width, height);
        ctx.moveTo(radius, 0);
        ctx.lineTo(width - radius, 0);
        ctx.quadraticCurveTo(width, 0, width, radius);
        ctx.lineTo(width, height - radius);
        ctx.quadraticCurveTo(width, height, width - radius, height);
        ctx.lineTo(radius, height);
        ctx.quadraticCurveTo(0, height, 0, height - radius);
        ctx.lineTo(0, radius);
        ctx.quadraticCurveTo(0, 0, radius, 0);
        ctx.closePath();
        
        ctx.fill("evenodd");
        ctx.restore();
      }

      // æç”»ãƒ¢ãƒ¼ãƒ‰ã«ã‚ˆã‚‹åˆ†å²
      if (currentMode === 'text' && text) {
        const lines = text.split('\n');
        const maxTextWidth = width * 0.85;
        const maxTextHeight = height * 0.85;
        let fontSize = Math.min(width, height);

        while (true) {
          ctx.font = `${fontWeight} ${fontSize}px ${fontFamily}`;
          let totalTextHeight = 0;
          let maxWidth = 0;

          lines.forEach((line) => {
            const metrics = ctx.measureText(line);
            const textWidth = metrics.width + (line.length - 1) * (letterSpacing * (fontSize / 100));
            maxWidth = Math.max(maxWidth, textWidth);
            totalTextHeight += fontSize * lineHeight;
          });

          if (maxWidth <= maxTextWidth && totalTextHeight <= maxTextHeight) {
            break;
          }
          fontSize -= 1;
          if (fontSize <= 10) break;
        }

        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';

        const textGradient = ctx.createLinearGradient(0, height / 2, width, height / 2);
        textGradient.addColorStop(0, textGradColor1);
        textGradient.addColorStop(1, textGradColor2);

        const textHeight = fontSize * lineHeight;
        const totalHeight = textHeight * (lines.length - 1);
        const startY = height / 2 - (totalHeight / 2) + (fontSize * lineHeight - fontSize) / 2;

        // ãƒ¡ã‚¤ãƒ³ãƒ†ã‚­ã‚¹ãƒˆæç”»
        lines.forEach((line, index) => {
          const yPos = startY + index * textHeight;
          if (addOutline) {
            ctx.strokeStyle = outlineColor;
            ctx.lineWidth = outlineWidth;
            ctx.lineJoin = 'round';
            ctx.strokeText(line, width / 2, yPos);
          }
          ctx.fillStyle = textGradient;
          ctx.fillText(line, width / 2, yPos);
        });

      } else if (currentMode === 'image' && uploadedImage) {
        const fit = imageFitSelect.value;
        ctx.save();
        
        ctx.beginPath();
        ctx.moveTo(radius, 0);
        ctx.lineTo(width - radius, 0);
        ctx.quadraticCurveTo(width, 0, width, radius);
        ctx.lineTo(width, height - radius);
        ctx.quadraticCurveTo(width, height, width - radius, height);
        ctx.lineTo(radius, height);
        ctx.quadraticCurveTo(0, height, 0, height - radius);
        ctx.lineTo(0, radius);
        ctx.quadraticCurveTo(0, 0, radius, 0);
        ctx.closePath();
        ctx.clip();

        const imgWidth = uploadedImage.width;
        const imgHeight = uploadedImage.height;
        const canvasAspect = width / height;
        const imgAspect = imgWidth / imgHeight;
        
        let scale = 1, dx = 0, dy = 0, dw = 0, dh = 0;

        if (fit === 'cover') {
            if (imgAspect > canvasAspect) {
                scale = height / imgHeight;
                dw = imgWidth * scale; dh = height;
                dx = (width - dw) / 2; dy = 0;
            } else {
                scale = width / imgWidth;
                dw = width; dh = imgHeight * scale;
                dx = 0; dy = (height - dh) / 2;
            }
        } else {
            if (imgAspect > canvasAspect) {
                scale = width / imgWidth;
                dw = width; dh = imgHeight * scale;
                dx = 0; dy = (height - dh) / 2;
            } else {
                scale = height / imgHeight;
                dw = imgWidth * scale; dh = height;
                dx = (width - dw) / 2; dy = 0;
            }
        }

        ctx.drawImage(uploadedImage, dx, dy, dw, dh);
        ctx.restore();
      }

      // æ–°æ©Ÿèƒ½: é¡ç¸ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã®æç”»
      if (enableFrameCheckbox.checked) {
        const fColor = frameColorInput.value;
        const fWidth = parseInt(frameWidthRange.value);

        ctx.save();
        
        // å¤–æ ã®ãƒ‘ã‚¹ã‚’å†ä½œæˆ
        ctx.beginPath();
        ctx.moveTo(radius, 0);
        ctx.lineTo(width - radius, 0);
        ctx.quadraticCurveTo(width, 0, width, radius);
        ctx.lineTo(width, height - radius);
        ctx.quadraticCurveTo(width, height, width - radius, height);
        ctx.lineTo(radius, height);
        ctx.quadraticCurveTo(0, height, 0, height - radius);
        ctx.lineTo(0, radius);
        ctx.quadraticCurveTo(0, 0, radius, 0);
        ctx.closePath();
        
        ctx.clip(); // ã¯ã¿å‡ºã—é˜²æ­¢

        // ãƒ™ãƒ¼ã‚¹ã®é¡ç¸ï¼ˆå¤–å‘¨ã®ä¸­å¤®ã«ç·šãŒå¼•ã‹ã‚Œã‚‹ãŸã‚å¤ªã•ã¯2å€ã«ã™ã‚‹ï¼‰
        ctx.lineWidth = fWidth * 2;
        ctx.strokeStyle = fColor;
        ctx.stroke();

        // é¡ç¸ã®ç«‹ä½“æ„Ÿï¼ˆå†…å´ã®å½±ã¨ãƒã‚¤ãƒ©ã‚¤ãƒˆï¼‰
        const innerRadius = Math.max(0, radius - fWidth);
        ctx.beginPath();
        ctx.moveTo(fWidth + innerRadius, fWidth);
        ctx.lineTo(width - fWidth - innerRadius, fWidth);
        ctx.quadraticCurveTo(width - fWidth, fWidth, width - fWidth, fWidth + innerRadius);
        ctx.lineTo(width - fWidth, height - fWidth - innerRadius);
        ctx.quadraticCurveTo(width - fWidth, height - fWidth, width - fWidth - innerRadius, height - fWidth);
        ctx.lineTo(fWidth + innerRadius, height - fWidth);
        ctx.quadraticCurveTo(fWidth, height - fWidth, fWidth, height - fWidth - innerRadius);
        ctx.lineTo(fWidth, fWidth + innerRadius);
        ctx.quadraticCurveTo(fWidth, fWidth, fWidth + innerRadius, fWidth);
        ctx.closePath();

        // å†…å´ã®æš—ã„ç·šï¼ˆã‚·ãƒ£ãƒ‰ã‚¦ï¼‰
        ctx.lineWidth = 3;
        ctx.strokeStyle = 'rgba(0, 0, 0, 0.5)';
        ctx.stroke();

        // ãã®ã™ãå†…å´ã®æ˜ã‚‹ã„ç·šï¼ˆãƒã‚¤ãƒ©ã‚¤ãƒˆï¼‰
        ctx.lineWidth = 1;
        ctx.strokeStyle = 'rgba(255, 255, 255, 0.3)';
        ctx.stroke();

        // é¡ç¸ãã®ã‚‚ã®ã«ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚’é‡ã­ã¦ä¸¸ã¿ãƒ»å…‰æ²¢ã‚’å‡ºã™
        ctx.beginPath();
        ctx.moveTo(radius, 0);
        ctx.lineTo(width - radius, 0);
        ctx.quadraticCurveTo(width, 0, width, radius);
        ctx.lineTo(width, height - radius);
        ctx.quadraticCurveTo(width, height, width - radius, height);
        ctx.lineTo(radius, height);
        ctx.quadraticCurveTo(0, height, 0, height - radius);
        ctx.lineTo(0, radius);
        ctx.quadraticCurveTo(0, 0, radius, 0);
        ctx.closePath();

        ctx.lineWidth = fWidth * 2;
        const frameGloss = ctx.createLinearGradient(0, 0, width, height);
        frameGloss.addColorStop(0, 'rgba(255, 255, 255, 0.4)');
        frameGloss.addColorStop(0.5, 'rgba(255, 255, 255, 0)');
        frameGloss.addColorStop(1, 'rgba(0, 0, 0, 0.3)');
        ctx.strokeStyle = frameGloss;
        ctx.stroke();

        ctx.restore();
      }

      // PWAã‚»ãƒ¼ãƒ•ã‚¨ãƒªã‚¢ã‚¬ã‚¤ãƒ‰
      if (showGuideCheckbox.checked) {
        ctx.save();
        ctx.beginPath();
        ctx.arc(width / 2, height / 2, width * 0.4, 0, Math.PI * 2);
        ctx.strokeStyle = 'rgba(255, 0, 0, 0.8)';
        ctx.lineWidth = Math.max(1, width * 0.005);
        ctx.setLineDash([width * 0.02, width * 0.02]);
        ctx.stroke();
        
        ctx.fillStyle = 'rgba(255, 0, 0, 0.1)';
        ctx.fill();
        ctx.restore();
      }
    }

    // SVGç”Ÿæˆ
    function createSvgString() {
      const gradColor1 = gradColor1Input.value;
      const gradColor2 = gradColor2Input.value;
      const cornerRadius = parseFloat(cornerRadiusRange.value);
      const dropShadow = parseInt(document.querySelector('input[name="dropShadow"]:checked').value);
      const innerShadow = parseInt(document.querySelector('input[name="innerShadow"]:checked').value);
      const enableFrame = enableFrameCheckbox.checked;
      
      const size = iconSizeSelect.value === 'custom' ? parseInt(iconWidthInput.value) : parseInt(iconSizeSelect.value);
      const width = size, height = size;
      const radius = width * (cornerRadius / 100);

      let svg = `<svg width="${width}" height="${height}" xmlns="http://www.w3.org/2000/svg">`;
      svg += `<defs>`;
      svg += `<linearGradient id="bgGrad" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" style="stop-color:${gradColor1}"/><stop offset="100%" style="stop-color:${gradColor2}"/></linearGradient>`;
      
      if (dropShadow > 0) {
        svg += `<filter id="shadow"><feDropShadow dx="${dropShadow * 1}" dy="${dropShadow * 1.5}" stdDeviation="${dropShadow * 0.5}" flood-color="rgba(0, 0, 0, 0.3)"/></filter>`;
      }
      if (innerShadow > 0) {
        svg += `<filter id="innerShadow"><feOffset dx="0" dy="0"/><feGaussianBlur stdDeviation="${innerShadow * 0.2}"/><feComposite in2="SourceAlpha" operator="arithmetic" k2="-1" k3="1"/><feFlood flood-color="rgba(0,0,0,0.4)"/><feComposite in2="SourceGraphic" operator="in"/><feComposite operator="over" in2="SourceGraphic"/></filter>`;
      }

      if (enableFrame) {
        svg += `<linearGradient id="frameGloss" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" style="stop-color:white;stop-opacity:0.4"/><stop offset="50%" style="stop-color:white;stop-opacity:0"/><stop offset="100%" style="stop-color:black;stop-opacity:0.3"/></linearGradient>`;
      }

      if (currentMode === 'image' && uploadedImage) {
        const fit = imageFitSelect.value;
        svg += `<clipPath id="svgClip"><rect width="100%" height="100%" rx="${radius}" ry="${radius}"/></clipPath></defs>`;
        let rectFilter = dropShadow > 0 ? `filter="url(#shadow)"` : '';
        svg += `<rect width="100%" height="100%" rx="${radius}" ry="${radius}" fill="url(#bgGrad)" ${rectFilter}/>`;
        
        svg += `<g clip-path="url(#svgClip)">`;
        const preserveAspect = (fit === 'cover') ? 'xMidYMid slice' : 'xMidYMid meet';
        svg += `<image href="${uploadedImage.src}" width="100%" height="100%" preserveAspectRatio="${preserveAspect}"/>`;
        svg += `</g>`;
      } else {
        const text = iconTextarea.value.trim();
        const fontFamily = fontFamilySelect.value;
        const fontWeight = fontWeightSelect.value;
        const textGradColor1 = textGradColor1Input.value;
        const textGradColor2 = textGradColor2Input.value;
        const letterSpacing = parseFloat(letterSpacingRange.value);
        const lineHeight = parseFloat(lineHeightRange.value);
        const addOutline = addOutlineCheckbox.checked;
        const outlineColor = outlineColorInput.value;
        const outlineWidth = parseInt(outlineWidthRange.value);

        svg += `<linearGradient id="textGrad" x1="0%" y1="50%" x2="100%" y2="50%"><stop offset="0%" style="stop-color:${textGradColor1}"/><stop offset="100%" style="stop-color:${textGradColor2}"/></linearGradient></defs>`;
        
        let rectFilter = dropShadow > 0 ? `filter="url(#shadow)"` : '';
        svg += `<rect width="100%" height="100%" rx="${radius}" ry="${radius}" fill="url(#bgGrad)" ${rectFilter}/>`;

        if (text) {
          const lines = text.split('\n');
          let fontSize = Math.min(width, height);
          const maxTextWidth = width * 0.9;
          const maxTextHeight = height * 0.9;
          
          const testSvg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
          testSvg.style.visibility = 'hidden'; testSvg.style.position = 'absolute';
          const testText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
          testText.setAttribute('font-family', fontFamily);
          testText.setAttribute('font-weight', fontWeight);
          testText.setAttribute('letter-spacing', letterSpacing);
          testSvg.appendChild(testText); document.body.appendChild(testSvg);
          
          while (true) {
            let totalTextHeight = 0, maxWidth = 0;
            testText.setAttribute('font-size', fontSize + 'px');
            lines.forEach((line) => {
              testText.textContent = line;
              const textWidth = testText.getComputedTextLength();
              maxWidth = Math.max(maxWidth, textWidth);
              totalTextHeight += fontSize * lineHeight;
            });
            if (maxWidth <= maxTextWidth && totalTextHeight <= maxTextHeight) break;
            fontSize -= 1;
            if (fontSize <= 10) break;
          }
          document.body.removeChild(testSvg);
          
          const textHeight = fontSize * lineHeight;
          const totalHeight = textHeight * (lines.length - 1);
          const startY = (height / 2) - (totalHeight / 2) + (fontSize * 0.3);
          
          const textAttrs = `fill="url(#textGrad)" font-family="${fontFamily}" font-weight="${fontWeight}" font-size="${fontSize}px" text-anchor="middle" letter-spacing="${letterSpacing}"`;
          
          lines.forEach((line, index) => {
            const yPos = startY + index * textHeight;
            if (addOutline) {
              svg += `<text x="${width / 2}" y="${yPos}" ${textAttrs} stroke="${outlineColor}" stroke-width="${outlineWidth}" stroke-linejoin="round">${line}</text>`;
            }
            svg += `<text x="${width / 2}" y="${yPos}" ${textAttrs}>${line}</text>`;
          });
        }
      }

      // é¡ç¸ã®SVGè¦ç´ ã‚’è¿½åŠ 
      if (enableFrame) {
        const fColor = frameColorInput.value;
        const fWidth = parseInt(frameWidthRange.value);
        const innerRadius = Math.max(0, radius - fWidth);
        
        svg += `<rect width="100%" height="100%" rx="${radius}" ry="${radius}" fill="none" stroke="${fColor}" stroke-width="${fWidth * 2}" />`;
        svg += `<rect width="100%" height="100%" rx="${radius}" ry="${radius}" fill="none" stroke="url(#frameGloss)" stroke-width="${fWidth * 2}" />`;
        svg += `<rect x="${fWidth}" y="${fWidth}" width="${width - fWidth*2}" height="${height - fWidth*2}" rx="${innerRadius}" ry="${innerRadius}" fill="none" stroke="rgba(0,0,0,0.5)" stroke-width="3" />`;
        svg += `<rect x="${fWidth}" y="${fWidth}" width="${width - fWidth*2}" height="${height - fWidth*2}" rx="${innerRadius}" ry="${innerRadius}" fill="none" stroke="rgba(255,255,255,0.3)" stroke-width="1" />`;
      }

      svg += `</svg>`;
      return svg;
    }

    // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
    const inputs = [
      iconTextarea, fontFamilySelect, fontWeightSelect,
      gradColor1Input, gradColor2Input, textGradColor1Input, textGradColor2Input, iconSizeSelect, iconWidthInput,
      iconHeightInput, letterSpacingRange, lineHeightRange,
      cornerRadiusRange, addOutlineCheckbox, outlineColorInput, outlineWidthRange,
      imageFitSelect, enableFrameCheckbox, frameColorInput, frameWidthRange, showGuideCheckbox
    ];
    
    inputs.forEach(input => input.addEventListener('input', () => { updateUI(); drawIcon(); }));
    dropShadowRadios.forEach(radio => radio.addEventListener('change', () => { drawIcon(); }));
    innerShadowRadios.forEach(radio => radio.addEventListener('change', () => { drawIcon(); }));

    modeRadios.forEach(radio => radio.addEventListener('change', (e) => {
      currentMode = e.target.value;
      updateUI();
      drawIcon();
    }));

    // ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å…±é€šå‡¦ç†
    function handleImageFile(file) {
      if (file && file.type.startsWith('image/')) {
        const reader = new FileReader();
        reader.onload = (event) => {
          uploadedImage = new Image();
          uploadedImage.onload = () => {
            document.getElementById('modeImage').checked = true;
            currentMode = 'image';
            updateUI();
            drawIcon();
          };
          uploadedImage.src = event.target.result;
        };
        reader.readAsDataURL(file);
      }
    }

    imageUploadInput.addEventListener('change', (e) => handleImageFile(e.target.files[0]));

    // ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—æ©Ÿèƒ½
    dropZone.addEventListener('dragover', (e) => {
      e.preventDefault();
      dropZone.classList.add('dragover');
    });
    dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
    dropZone.addEventListener('drop', (e) => {
      e.preventDefault();
      dropZone.classList.remove('dragover');
      if (e.dataTransfer.files.length > 0) {
        handleImageFile(e.dataTransfer.files[0]);
      }
    });

    clearImageBtn.addEventListener('click', () => {
      uploadedImage = null;
      imageUploadInput.value = null;
      drawIcon();
    });

    presetBtns.forEach(btn => {
      btn.addEventListener('click', () => {
        const colors = btn.dataset.colors.split(',');
        gradColor1Input.value = colors[0];
        gradColor2Input.value = colors[1];
        patternType = 'none';
        updateUI(); drawIcon();
      });
    });

    randomizeBtn.addEventListener('click', () => {
      const randomHex = () => '#' + Math.floor(Math.random()*16777215).toString(16).padStart(6, '0');
      gradColor1Input.value = randomHex(); gradColor2Input.value = randomHex();
      cornerRadiusRange.value = Math.floor(Math.random() * 50);

      if (currentMode === 'text') {
        textGradColor1Input.value = randomHex(); textGradColor2Input.value = randomHex();
        const randomWeight = ['300', '400', '500', '600', '700', '800', '900'];
        fontWeightSelect.value = randomWeight[Math.floor(Math.random() * randomWeight.length)];
        letterSpacingRange.value = Math.floor(Math.random() * 25) - 5;
      }
      
      if (enableFrameCheckbox.checked) {
        frameColorInput.value = randomHex();
      }
      
      updateUI(); drawIcon();
    });

    resetBtn.addEventListener('click', initializeState);

    // ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã¸ã‚³ãƒ”ãƒ¼æ©Ÿèƒ½
    copyToClipboardBtn.addEventListener('click', async () => {
      // ã‚³ãƒ”ãƒ¼æ™‚ã¯ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³ã‚’ä¸€æ™‚çš„ã«æ¶ˆã—ã¦å†æç”»
      const wasGuideOn = showGuideCheckbox.checked;
      if(wasGuideOn) { showGuideCheckbox.checked = false; drawIcon(); }

      try {
        canvas.toBlob(async (blob) => {
          const item = new ClipboardItem({ 'image/png': blob });
          await navigator.clipboard.write([item]);
          
          copySuccessMessage.style.display = 'block';
          copyErrorMessage.style.display = 'none';
          setTimeout(() => copySuccessMessage.style.display = 'none', 3000);

          // ã‚¬ã‚¤ãƒ‰ã‚’å…ƒã«æˆ»ã™
          if(wasGuideOn) { showGuideCheckbox.checked = true; drawIcon(); }
        }, 'image/png');
      } catch (err) {
        copyErrorMessage.style.display = 'block';
        copySuccessMessage.style.display = 'none';
        setTimeout(() => copyErrorMessage.style.display = 'none', 3000);
        console.error('ã‚³ãƒ”ãƒ¼å¤±æ•—:', err);
        if(wasGuideOn) { showGuideCheckbox.checked = true; drawIcon(); }
      }
    });

    downloadPngBtn.addEventListener('click', () => {
      drawIcon(); const size = canvas.width;
      downloadPngBtn.href = canvas.toDataURL('image/png');
      downloadPngBtn.download = `icon${size}.png`;
    });

    downloadJpgBtn.addEventListener('click', () => {
      drawIcon(); const size = canvas.width;
      downloadJpgBtn.href = canvas.toDataURL('image/jpeg', 0.9);
      downloadJpgBtn.download = `icon${size}.jpeg`;
    });

    downloadWebpBtn.addEventListener('click', () => {
      drawIcon(); const size = canvas.width;
      downloadWebpBtn.href = canvas.toDataURL('image/webp');
      downloadWebpBtn.download = `icon${size}.webp`;
    });

    downloadSvgBtn.addEventListener('click', (event) => {
      if (currentMode === 'text') {
        const size = iconSizeSelect.value === 'custom' ? parseInt(iconWidthInput.value) : parseInt(iconSizeSelect.value);
        const svgString = createSvgString();
        const blob = new Blob([svgString], {type: 'image/svg+xml'});
        downloadSvgBtn.href = URL.createObjectURL(blob);
        downloadSvgBtn.download = `icon${size}.svg`;
      } else {
        alert('ç”»åƒãƒ¢ãƒ¼ãƒ‰ã§ã¯SVGã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã¯ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚PNGã‚’ã”åˆ©ç”¨ãã ã•ã„ã€‚');
        event.preventDefault();
      }
    });

    downloadIcoBtn.addEventListener('click', () => {
      drawIcon(); const size = canvas.width;
      const icoBlob = canvasToICO(canvas);
      const url = URL.createObjectURL(icoBlob);
      downloadIcoBtn.href = url;
      downloadIcoBtn.download = `icon${size}.ico`;
    });

    function toggleAdvanced() {
      const advancedControls = document.getElementById('advancedControls');
      const toggleBtn = document.querySelector('.toggle-advanced');
      const isVisible = advancedControls.classList.contains('show');
      
      if (isVisible) {
        advancedControls.classList.remove('show');
        toggleBtn.textContent = 'ğŸ”§ é«˜åº¦ãªè¨­å®šã‚’è¡¨ç¤º';
      } else {
        advancedControls.classList.add('show');
        toggleBtn.textContent = 'âŒ é«˜åº¦ãªè¨­å®šã‚’éš ã™';
      }
    }

    window.onload = initializeState;
  </script>
</body>
</html>
