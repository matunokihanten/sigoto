<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>完全機能掲示板システム</title>
  <style>
    /* --- CSS Variables for Dynamic Theming --- */
    :root {
      --primary-color: #007acc;
      --primary-dark: #005fa3;
      --primary-darker: #004080;
      --success-color: #28a745;
      --warning-color: #ffc107;
      --danger-color: #dc3545;
      --info-color: #17a2b8;
      --light-color: #f8f9fa;
      --dark-color: #343a40;
      --bg-color: #f4f4f4;
      --text-color: #333;
      --border-color: #ddd;
      --shadow: 0 2px 4px rgba(0,0,0,0.1);
      --shadow-hover: 0 4px 8px rgba(0,0,0,0.15);
      --transition: all 0.3s ease;
      --border-radius: 8px;
      --font-size-small: 0.85rem;
      --font-size-normal: 1rem;
      --font-size-large: 1.2rem;
    }

    /* --- Dark Mode Variables --- */
    .dark-mode {
      --bg-color: #1a1a1a;
      --text-color: #e0e0e0;
      --border-color: #444;
      --light-color: #2d2d2d;
      --dark-color: #121212;
      --primary-color: #4da6ff;
      --primary-dark: #3b89e0;
      --primary-darker: #2c6eb5;
      --info-color: #20c997;
      --success-color: #20c997;
    }

    /* --- Global Styles --- */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: var(--bg-color);
      color: var(--text-color);
      transition: var(--transition);
      line-height: 1.6;
    }

    /* --- Header Styles --- */
    header {
      background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
      padding: 15px;
      box-shadow: var(--shadow);
      position: sticky;
      top: 0;
      z-index: 50;
    }

    .header-content {
      max-width: 1400px;
      margin: 0 auto;
    }

    .header-row {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 8px;
      margin-bottom: 10px;
      align-items: center;
    }

    .header-row.top {
      margin-bottom: 15px;
    }

    .header-btn {
      padding: 10px 16px;
      border: none;
      border-radius: var(--border-radius);
      background: var(--primary-dark);
      color: white;
      cursor: pointer;
      transition: var(--transition);
      font-size: var(--font-size-small);
      font-weight: 500;
      white-space: nowrap;
      position: relative;
      overflow: hidden;
    }

    .header-btn:hover {
      background: var(--primary-darker);
      transform: translateY(-2px);
      box-shadow: var(--shadow-hover);
    }

    .header-btn:active {
      transform: translateY(0);
    }

    .header-btn.active {
      background: var(--success-color);
    }

    .header-input {
      padding: 8px 12px;
      border: 2px solid rgba(255,255,255,0.3);
      border-radius: var(--border-radius);
      background: rgba(255,255,255,0.1);
      color: white;
      font-size: var(--font-size-small);
      transition: var(--transition);
    }

    .header-input::placeholder {
      color: rgba(255,255,255,0.7);
    }

    .header-input:focus {
      outline: none;
      background: rgba(255,255,255,0.2);
      border-color: rgba(255,255,255,0.5);
    }

    /* --- New Post Area --- */
    .new-post-section {
      background: var(--light-color);
      padding: 20px;
      border-bottom: 1px solid var(--border-color);
      box-shadow: var(--shadow);
    }

    .new-post-container {
      max-width: 1400px;
      margin: 0 auto;
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 15px;
      align-items: start;
    }

    .new-post-input {
      width: 100%;
      padding: 12px;
      border: 2px solid var(--border-color);
      border-radius: var(--border-radius);
      resize: vertical;
      font-family: inherit;
      font-size: var(--font-size-normal);
      transition: var(--transition);
      min-height: 80px;
      background: var(--bg-color);
      color: var(--text-color);
    }

    .new-post-input:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(0, 122, 204, 0.1);
    }

    .new-post-controls {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .control-btn {
      padding: 12px 20px;
      border: none;
      border-radius: var(--border-radius);
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
      white-space: nowrap;
    }

    .btn-primary {
      background: var(--success-color);
      color: white;
    }

    .btn-primary:hover {
      background: #218838;
      transform: translateY(-1px);
    }

    .btn-secondary {
      background: var(--warning-color);
      color: var(--dark-color);
    }

    .btn-secondary:hover {
      background: #e0a800;
      transform: translateY(-1px);
    }

    /* --- Posts Container --- */
    .posts-section {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
      transform-origin: top left;
      transition: transform 0.3s ease;
    }

    /* --- Post Styles --- */
    .post {
      background: var(--light-color);
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius);
      margin: 15px 0;
      padding: 20px;
      transition: var(--transition);
      position: relative;
      cursor: pointer;
      box-shadow: var(--shadow);
    }

    .post:hover {
      box-shadow: var(--shadow-hover);
      transform: translateY(-2px);
    }

    .post.pinned {
      border-left: 5px solid var(--success-color);
      background: linear-gradient(135deg, var(--light-color), #f0fff0);
    }
    
    .dark-mode .post.pinned {
      background: linear-gradient(135deg, var(--light-color), #2f4f4f);
    }

    .post.archived {
      opacity: 0.7;
      background: linear-gradient(135deg, var(--light-color), #f5f5f5);
    }

    .dark-mode .post.archived {
      background: linear-gradient(135deg, var(--light-color), #333);
    }

    .post-header {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      gap: 10px;
    }

    .post-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      align-items: center;
      font-size: var(--font-size-small);
      color: #666;
    }
    
    .dark-mode .post-meta {
      color: #aaa;
    }

    .timestamp {
      font-weight: 500;
    }

    .post-stats {
      display: flex;
      gap: 15px;
      align-items: center;
      font-size: var(--font-size-small);
    }

    .stat-item {
      display: flex;
      align-items: center;
      gap: 4px;
      padding: 4px 8px;
      background: rgba(0, 122, 204, 0.1);
      border-radius: 12px;
      color: var(--primary-color);
      font-weight: 500;
    }

    .post-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .post-btn {
      padding: 6px 12px;
      border: none;
      border-radius: 16px;
      font-size: 0.8rem;
      cursor: pointer;
      transition: var(--transition);
      font-weight: 500;
    }

    .btn-favorite {
      background: #fff3cd;
      color: #856404;
      border: 1px solid #ffeaa7;
    }

    .btn-favorite.active {
      background: #ffc107;
      color: white;
    }

    .btn-reply {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }

    .btn-edit {
      background: #e2e3e5;
      color: #383d41;
      border: 1px solid #d6d8db;
    }

    .btn-delete {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f1b0b7;
    }

    .post-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .post-content {
      font-size: var(--font-size-normal);
      line-height: 1.7;
      margin-bottom: 15px;
      word-wrap: break-word;
      white-space: pre-wrap;
    }

    .post-content.collapsed {
      max-height: 100px;
      overflow: hidden;
      position: relative;
    }

    .post-content.collapsed::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      height: 40px;
      width: 100%;
      background: linear-gradient(transparent, var(--light-color));
    }
    
    .dark-mode .post-content.collapsed::after {
      background: linear-gradient(transparent, var(--light-color));
    }

    .highlighted {
      background: linear-gradient(120deg, #a8e6cf 0%, #dcedc1 100%);
      padding: 2px 4px;
      border-radius: 4px;
      font-weight: 600;
    }

    /* --- Tags --- */
    .post-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 15px;
    }

    .tag {
      padding: 4px 10px;
      background: linear-gradient(135deg, var(--info-color), #20c997);
      color: white;
      border-radius: 16px;
      font-size: 0.8rem;
      font-weight: 500;
      cursor: pointer;
      transition: var(--transition);
    }

    .tag:hover {
      transform: scale(1.05);
      box-shadow: 0 2px 8px rgba(23, 162, 184, 0.3);
    }

    .tag-removable {
      cursor: pointer;
      margin-left: 5px;
      font-weight: bold;
    }

    /* --- Reply Form --- */
    .reply-form {
      background: var(--bg-color);
      border: 2px dashed var(--border-color);
      border-radius: var(--border-radius);
      padding: 15px;
      margin-top: 15px;
      animation: slideDown 0.3s ease;
    }

    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .reply-textarea {
      width: 100%;
      min-height: 80px;
      padding: 12px;
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius);
      resize: vertical;
      font-family: inherit;
      margin-bottom: 10px;
      background: var(--light-color);
      color: var(--text-color);
    }

    .reply-actions {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
    }

    /* --- Sidebar Panels --- */
    .sidebar-panel {
      position: fixed;
      top: 120px;
      right: 20px;
      background: var(--light-color);
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius);
      padding: 20px;
      max-width: 300px;
      max-height: 500px;
      overflow-y: auto;
      box-shadow: var(--shadow-hover);
      z-index: 40;
      transform: translateX(320px);
      transition: transform 0.3s ease;
    }

    .sidebar-panel.visible {
      transform: translateX(0);
    }

    .panel-header {
      font-size: var(--font-size-large);
      font-weight: 700;
      margin-bottom: 15px;
      color: var(--primary-color);
      border-bottom: 2px solid var(--primary-color);
      padding-bottom: 8px;
    }

    .fav-item, .archive-item {
      padding: 10px;
      border-bottom: 1px solid var(--border-color);
      cursor: pointer;
      transition: var(--transition);
      border-radius: 4px;
      margin-bottom: 5px;
    }

    .fav-item:hover, .archive-item:hover {
      background: var(--primary-color);
      color: white;
      transform: translateX(5px);
    }

    /* --- Filter Tags --- */
    .tag-filter-section {
      background: var(--light-color);
      padding: 15px 20px;
      border-top: 1px solid var(--border-color);
    }

    .tag-filter-container {
      max-width: 1400px;
      margin: 0 auto;
    }

    .filter-tag {
      display: inline-block;
      padding: 8px 15px;
      margin: 4px;
      background: #e9ecef;
      color: #495057;
      border: 1px solid #ced4da;
      border-radius: 20px;
      cursor: pointer;
      transition: var(--transition);
      font-weight: 500;
    }
    
    .dark-mode .filter-tag {
      background: #444;
      color: #e0e0e0;
      border-color: #555;
    }

    .filter-tag:hover, .filter-tag.active {
      background: var(--primary-color);
      color: white;
      transform: scale(1.05);
    }

    /* --- Settings Panel --- */
    .overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(5px);
      z-index: 98;
      opacity: 0;
      visibility: hidden;
      transition: var(--transition);
    }

    .overlay.visible {
      opacity: 1;
      visibility: visible;
    }

    .settings-panel {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(0.8);
      background: var(--light-color);
      border-radius: var(--border-radius);
      padding: 30px;
      width: 90%;
      max-width: 500px;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      z-index: 99;
      transition: var(--transition);
      opacity: 0;
    }

    .settings-panel.visible {
      transform: translate(-50%, -50%) scale(1);
      opacity: 1;
    }

    .settings-section {
      margin-bottom: 25px;
    }

    .settings-label {
      display: block;
      font-weight: 700;
      margin-bottom: 10px;
      color: var(--primary-color);
      font-size: var(--font-size-large);
    }

    .button-list {
      max-height: 200px;
      overflow-y: auto;
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius);
      padding: 10px;
    }

    .button-item {
      display: flex;
      align-items: center;
      padding: 8px 0;
      border-bottom: 1px solid #eee;
    }

    .button-item:last-child {
      border-bottom: none;
    }

    .button-item input[type="checkbox"] {
      margin-right: 10px;
      transform: scale(1.2);
    }

    .settings-slider {
      width: 100%;
      margin: 15px 0;
      height: 8px;
      border-radius: 4px;
      background: #ddd;
      outline: none;
      -webkit-appearance: none;
    }

    .settings-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: var(--primary-color);
      cursor: pointer;
    }

    /* --- Notification System --- */
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 15px 20px;
      border-radius: var(--border-radius);
      color: white;
      font-weight: 600;
      z-index: 101;
      transform: translateX(400px);
      transition: var(--transition);
      min-width: 250px;
      box-shadow: var(--shadow-hover);
    }

    .notification.visible {
      transform: translateX(0);
    }

    .notification.success {
      background: linear-gradient(135deg, var(--success-color), #20c997);
    }

    .notification.error {
      background: linear-gradient(135deg, var(--danger-color), #e83e8c);
    }

    .notification.info {
      background: linear-gradient(135deg, var(--info-color), var(--primary-color));
    }
    
    .close-notification {
      margin-left: 10px;
      font-size: 1.2rem;
      cursor: pointer;
      font-weight: bold;
    }

    /* --- Color Picker --- */
    .color-picker {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: var(--light-color);
      border-radius: var(--border-radius);
      padding: 20px;
      box-shadow: var(--shadow-hover);
      z-index: 100;
      display: grid;
      grid-template-columns: repeat(8, 1fr);
      gap: 8px;
      max-width: 300px;
      opacity: 0;
      visibility: hidden;
      transition: var(--transition);
    }
    
    .color-picker.visible {
      opacity: 1;
      visibility: visible;
    }

    .color-btn {
      width: 30px;
      height: 30px;
      border: 2px solid #fff;
      border-radius: 50%;
      cursor: pointer;
      transition: var(--transition);
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .color-btn:hover {
      transform: scale(1.2);
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }

    /* --- Loading Animation --- */
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255,255,255,.3);
      border-radius: 50%;
      border-top-color: #fff;
      animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* --- Responsive Design --- */
    @media (max-width: 768px) {
      .header-row {
        flex-direction: column;
        gap: 5px;
      }

      .new-post-container {
        grid-template-columns: 1fr;
        gap: 10px;
      }

      .new-post-controls {
        flex-direction: row;
        justify-content: space-between;
      }

      .posts-section {
        padding: 10px;
      }

      .post {
        margin: 10px 0;
        padding: 15px;
      }

      .post-header {
        flex-direction: column;
        align-items: flex-start;
      }

      .sidebar-panel {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        max-width: none;
        max-height: none;
        border-radius: 0;
        transform: translateY(100%);
      }

      .sidebar-panel.visible {
        transform: translateY(0);
      }
    }

    /* --- Print Styles --- */
    @media print {
      * {
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
      }

      header, .new-post-section, .tag-filter-section, .sidebar-panel, .settings-panel, .overlay, .post-actions, .reply-form {
        display: none !important;
      }

      .post {
        break-inside: avoid;
        margin: 10px 0;
        box-shadow: none;
        border: 1px solid #000;
      }
    }

    /* --- Utility Classes --- */
    .hidden { display: none !important; }
    .visible { display: block !important; }
    .flex { display: flex; }
    .flex-center { display: flex; align-items: center; justify-content: center; }
    .text-center { text-align: center; }
    .font-bold { font-weight: 700; }
    .text-small { font-size: var(--font-size-small); }
    .text-large { font-size: var(--font-size-large); }
    .mb-10 { margin-bottom: 10px; }
    .mt-10 { margin-top: 10px; }
    .p-10 { padding: 10px; }
    
    /* --- Animation Classes --- */
    .fade-in {
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .pulse {
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(0, 122, 204, 0.4); }
      70% { box-shadow: 0 0 0 10px rgba(0, 122, 204, 0); }
      100% { box-shadow: 0 0 0 0 rgba(0, 122, 204, 0); }
    }
  </style>
</head>
<body>
  <header id="global-header">
    <div class="header-content">
      <div class="header-row top" id="btn-container">
        <button id="btn-dark-mode" class="header-btn" draggable="true" title="ダークモード切替">🌙 ダークモード</button>
        <button id="btn-sort-new" class="header-btn" draggable="true" title="新しい順でソート">📅 新しい順</button>
        <button id="btn-sort-old" class="header-btn" draggable="true" title="古い順でソート">📆 古い順</button>
        <button id="btn-sort-alpha" class="header-btn" draggable="true" title="五十音順でソート">🔤 五十音順</button>
        <button id="btn-sort-popular" class="header-btn" draggable="true" title="人気順でソート">⭐ 人気順</button>
        <button id="btn-collapse-expand" class="header-btn" draggable="true" title="全投稿の折りたたみ切替">📋 展開/折りたたみ</button>
        <button id="btn-print" class="header-btn" draggable="true" title="印刷">🖨️ 印刷</button>
        <button id="btn-save" class="header-btn" draggable="true" title="データ保存">💾 保存</button>
        <button id="btn-load" class="header-btn" draggable="true" title="データ読み込み">📁 読み込み</button>
        <button id="btn-export" class="header-btn" draggable="true" title="CSV/JSON形式で出力">📤 出力</button>
        <button id="btn-favorites" class="header-btn" draggable="true" title="お気に入り一覧">⭐ お気に入り</button>
        <button id="btn-archives" class="header-btn" draggable="true" title="アーカイブ一覧">📦 アーカイブ</button>
        <button id="btn-statistics" class="header-btn" draggable="true" title="統計情報">📊 統計</button>
        <input type="text" id="search-input" class="header-input" placeholder="🔍 投稿を検索..." title="キーワード検索">
        <button id="btn-search" class="header-btn" draggable="true" title="検索実行">🔍 検索</button>
        <button id="btn-search-reset" class="header-btn" draggable="true" title="検索リセット">🔄 リセット</button>
        <button id="btn-undo" class="header-btn" draggable="true" title="元に戻す">↶ 元に戻す</button>
        <button id="btn-redo" class="header-btn" draggable="true" title="やり直し">↷ やり直し</button>
        <button id="btn-recover" class="header-btn" draggable="true" title="削除した投稿を復活">🔮 復活</button>
        <button id="btn-settings" class="header-btn" draggable="true" title="設定">⚙️ 設定</button>
      </div>
      <div class="header-row bottom">
        <label for="zoom-slider">🔍 ズーム:</label>
        <input type="range" id="zoom-slider" class="settings-slider" min="50" max="200" value="100" title="表示倍率調整">
        <span id="zoom-value">100%</span>
      </div>
    </div>
  </header>

  <section class="new-post-section">
    <div class="new-post-container">
      <div>
        <textarea id="new-post-input" class="new-post-input" placeholder="💭 新しい投稿を入力してください..." rows="3"></textarea>
        <div class="post-tags" style="margin-top: 10px;">
          <input type="text" id="tag-input" placeholder="タグを追加 (スペース区切り)" style="padding: 8px; border: 1px solid var(--border-color); border-radius: 4px; width: 200px;">
          <button id="add-tag-btn" class="post-btn" style="margin-left: 10px;">🏷️ タグ追加</button>
        </div>
        <div id="current-tags" class="post-tags"></div>
      </div>
      <div class="new-post-controls">
        <button id="post-btn" class="control-btn btn-primary">📝 投稿</button>
        <button id="local-collapse-btn" class="control-btn btn-secondary">📋 全折りたたみ</button>
        <button id="pin-mode-btn" class="control-btn btn-secondary">📌 ピンモード</button>
      </div>
    </div>
  </section>

  <section id="posts-container" class="posts-section"></section>

  <section class="tag-filter-section" id="tag-filter-section">
    <div class="tag-filter-container">
      <h3 style="margin-bottom: 10px; color: var(--primary-color);">🏷️ タグでフィルター</h3>
      <div id="tag-filter"></div>
    </div>
  </section>

  <aside id="favorites-panel" class="sidebar-panel">
    <div class="panel-header">⭐ お気に入り一覧</div>
    <div id="favorites-list"></div>
  </aside>

  <aside id="archives-panel" class="sidebar-panel">
    <div class="panel-header">📦 アーカイブ一覧</div>
    <div id="archives-list"></div>
  </aside>

  <aside id="statistics-panel" class="sidebar-panel">
    <div class="panel-header">📊 統計情報</div>
    <div id="statistics-content"></div>
  </aside>

  <input type="file" id="load-file-input" style="display:none;" accept=".json,.csv">

  <div id="overlay" class="overlay"></div>
  <div id="settings-panel" class="settings-panel">
    <div class="settings-section">
      <label class="settings-label">🎨 テーマカラー変更</label>
      <div id="theme-color-palette" class="color-picker"></div>
    </div>
    <div class="settings-section">
      <label class="settings-label">🔧 ボタンの表示設定</label>
      <div class="button-list" id="button-visibility-list"></div>
    </div>
    <div class="settings-section">
      <label class="settings-label">📏 ボタンサイズ</label>
      <input type="range" id="button-size-slider" class="settings-slider" min="0.8" max="1.4" step="0.1" value="1.0">
      <span id="button-size-value">1.0x</span>
    </div>
    <div class="settings-section">
      <label class="settings-label">📝 デフォルトの投稿テンプレート</label>
      <textarea id="template-textarea" style="width:100%; height:100px; padding:10px; border:1px solid var(--border-color);"></textarea>
      <button id="save-template-btn" class="control-btn btn-primary" style="margin-top:10px;">テンプレート保存</button>
    </div>
  </div>
  
  <div id="notification-area"></div>

  <script>
    // JavaScript Code
    document.addEventListener('DOMContentLoaded', () => {
      // --- DOM Elements ---
      const postsContainer = document.getElementById('posts-container');
      const newPostInput = document.getElementById('new-post-input');
      const postBtn = document.getElementById('post-btn');
      const searchInput = document.getElementById('search-input');
      const searchBtn = document.getElementById('btn-search');
      const searchResetBtn = document.getElementById('btn-search-reset');
      const tagInput = document.getElementById('tag-input');
      const addTagBtn = document.getElementById('add-tag-btn');
      const currentTagsContainer = document.getElementById('current-tags');
      const tagFilterContainer = document.getElementById('tag-filter');
      const darkModeBtn = document.getElementById('btn-dark-mode');
      const sortNewBtn = document.getElementById('btn-sort-new');
      const sortOldBtn = document.getElementById('btn-sort-old');
      const sortAlphaBtn = document.getElementById('btn-sort-alpha');
      const sortPopularBtn = document.getElementById('btn-sort-popular');
      const collapseExpandBtn = document.getElementById('btn-collapse-expand');
      const localCollapseBtn = document.getElementById('local-collapse-btn');
      const pinModeBtn = document.getElementById('pin-mode-btn');
      const favoritesBtn = document.getElementById('btn-favorites');
      const archivesBtn = document.getElementById('btn-archives');
      const statisticsBtn = document.getElementById('btn-statistics');
      const favoritesPanel = document.getElementById('favorites-panel');
      const archivesPanel = document.getElementById('archives-panel');
      const statisticsPanel = document.getElementById('statistics-panel');
      const settingsBtn = document.getElementById('btn-settings');
      const settingsPanel = document.getElementById('settings-panel');
      const overlay = document.getElementById('overlay');
      const zoomSlider = document.getElementById('zoom-slider');
      const zoomValueSpan = document.getElementById('zoom-value');
      const buttonVisibilityList = document.getElementById('button-visibility-list');
      const buttonSizeSlider = document.getElementById('button-size-slider');
      const buttonSizeValueSpan = document.getElementById('button-size-value');
      const undoBtn = document.getElementById('btn-undo');
      const redoBtn = document.getElementById('btn-redo');
      const recoverBtn = document.getElementById('btn-recover');
      const saveBtn = document.getElementById('btn-save');
      const loadBtn = document.getElementById('btn-load');
      const loadFileInput = document.getElementById('load-file-input');
      const exportBtn = document.getElementById('btn-export');
      const themeColorPalette = document.getElementById('theme-color-palette');
      const templateTextarea = document.getElementById('template-textarea');
      const saveTemplateBtn = document.getElementById('save-template-btn');
      const notificationArea = document.getElementById('notification-area');
      const printBtn = document.getElementById('btn-print');

      // --- Global State ---
      let posts = [];
      let currentTags = [];
      let historyStack = [];
      let historyIndex = -1;
      let deletedPosts = [];
      let isCollapsed = false;
      let isPinMode = false;
      let currentSort = 'new';
      let currentFilterTag = null;
      let currentSearchQuery = '';

      // --- Data Structure (Post Class) ---
      class Post {
        constructor(content, tags = [], parentId = null) {
          this.id = Date.now();
          this.content = content;
          this.timestamp = new Date().toISOString();
          this.tags = tags;
          this.replies = [];
          this.parentId = parentId;
          this.favorites = 0;
          this.isPinned = false;
          this.isArchived = false;
        }
      }

      // --- Persistence (localStorage) ---
      const saveState = () => {
        try {
          localStorage.setItem('boardPosts', JSON.stringify(posts));
          localStorage.setItem('deletedPosts', JSON.stringify(deletedPosts));
        } catch (e) {
          showNotification('データの保存に失敗しました。', 'error');
          console.error('Failed to save state to localStorage:', e);
        }
      };

      const loadState = () => {
        try {
          const storedPosts = localStorage.getItem('boardPosts');
          const storedDeleted = localStorage.getItem('deletedPosts');
          if (storedPosts) {
            posts = JSON.parse(storedPosts);
          }
          if (storedDeleted) {
            deletedPosts = JSON.parse(storedDeleted);
          }
        } catch (e) {
          showNotification('データの読み込みに失敗しました。', 'error');
          console.error('Failed to load state from localStorage:', e);
        }
      };

      // --- History (Undo/Redo) ---
      const saveHistory = () => {
        historyStack = historyStack.slice(0, historyIndex + 1);
        historyStack.push(JSON.stringify({ posts, deletedPosts }));
        historyIndex = historyStack.length - 1;
        updateHistoryButtons();
      };

      const undo = () => {
        if (historyIndex > 0) {
          historyIndex--;
          const prevState = JSON.parse(historyStack[historyIndex]);
          posts = prevState.posts;
          deletedPosts = prevState.deletedPosts;
          renderPosts();
          showNotification('元に戻しました。', 'info');
          updateHistoryButtons();
        }
      };

      const redo = () => {
        if (historyIndex < historyStack.length - 1) {
          historyIndex++;
          const nextState = JSON.parse(historyStack[historyIndex]);
          posts = nextState.posts;
          deletedPosts = nextState.deletedPosts;
          renderPosts();
          showNotification('やり直しました。', 'info');
          updateHistoryButtons();
        }
      };

      const updateHistoryButtons = () => {
        undoBtn.disabled = historyIndex <= 0;
        redoBtn.disabled = historyIndex >= historyStack.length - 1;
      };

      // --- UI Rendering ---
      const renderPosts = () => {
        postsContainer.innerHTML = '';
        const sortedPosts = sortPosts(filterPosts(posts));
        
        sortedPosts.forEach(post => {
          if (!post.isArchived) {
            postsContainer.appendChild(createPostElement(post));
          }
        });
        
        renderTagFilters();
        renderSidebarPanels();
        saveState();
      };
      
      const createPostElement = (post, isReply = false) => {
        const postElement = document.createElement('div');
        postElement.className = 'post fade-in';
        postElement.dataset.id = post.id;
        
        if (post.isPinned) {
          postElement.classList.add('pinned');
        }

        const tagsHtml = post.tags.map(tag => `<span class="tag" data-tag="${tag}">${tag}</span>`).join('');
        const repliesCount = post.replies ? post.replies.length : 0;

        let contentHtml = post.content;
        if (currentSearchQuery) {
          const regex = new RegExp(`(${currentSearchQuery})`, 'gi');
          contentHtml = post.content.replace(regex, `<span class="highlighted">$1</span>`);
        }

        postElement.innerHTML = `
          <div class="post-header">
            <div class="post-meta">
              <span class="timestamp">${new Date(post.timestamp).toLocaleString()}</span>
              ${post.isPinned ? `<span class="stat-item">📌 ピン留め</span>` : ''}
            </div>
            <div class="post-stats">
              <span class="stat-item">💬 ${repliesCount}</span>
              <span class="stat-item">⭐ ${post.favorites}</span>
            </div>
          </div>
          <div class="post-tags">${tagsHtml}</div>
          <div class="post-content">${contentHtml}</div>
          <div class="post-actions">
            <button class="post-btn btn-reply">💬 返信</button>
            <button class="post-btn btn-favorite ${post.isFavorite ? 'active' : ''}">⭐ お気に入り</button>
            <button class="post-btn btn-edit">✍️ 編集</button>
            <button class="post-btn btn-delete">🗑️ 削除</button>
            <button class="post-btn btn-archive">📦 アーカイブ</button>
            <button class="post-btn btn-pin">${post.isPinned ? '📌 ピン解除' : '📌 ピン留め'}</button>
          </div>
        `;
        
        if (post.replies && post.replies.length > 0) {
          const repliesContainer = document.createElement('div');
          repliesContainer.className = 'replies-container';
          post.replies.forEach(reply => {
            repliesContainer.appendChild(createPostElement(reply, true));
          });
          postElement.appendChild(repliesContainer);
        }
        
        // Add event listeners to new buttons
        const replyBtn = postElement.querySelector('.btn-reply');
        replyBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          toggleReplyForm(postElement, post.id);
        });
        
        const favoriteBtn = postElement.querySelector('.btn-favorite');
        favoriteBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          toggleFavorite(post.id);
        });
        
        const editBtn = postElement.querySelector('.btn-edit');
        editBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          editPost(post.id, postElement);
        });
        
        const deleteBtn = postElement.querySelector('.btn-delete');
        deleteBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          deletePost(post.id);
        });
        
        const archiveBtn = postElement.querySelector('.btn-archive');
        archiveBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          archivePost(post.id);
        });
        
        const pinBtn = postElement.querySelector('.btn-pin');
        pinBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          togglePin(post.id);
        });
        
        const tags = postElement.querySelectorAll('.tag');
        tags.forEach(tag => {
          tag.addEventListener('click', (e) => {
            e.stopPropagation();
            filterByTag(tag.dataset.tag);
          });
        });
        
        return postElement;
      };

      const renderTagFilters = () => {
        tagFilterContainer.innerHTML = '';
        const allTags = new Set();
        posts.forEach(post => {
          post.tags.forEach(tag => allTags.add(tag));
          if (post.replies) {
            post.replies.forEach(reply => {
              reply.tags.forEach(tag => allTags.add(tag));
            });
          }
        });
        
        allTags.forEach(tag => {
          const tagBtn = document.createElement('span');
          tagBtn.className = 'filter-tag';
          tagBtn.textContent = tag;
          tagBtn.dataset.tag = tag;
          if (tag === currentFilterTag) {
            tagBtn.classList.add('active');
          }
          tagBtn.addEventListener('click', () => {
            if (currentFilterTag === tag) {
              currentFilterTag = null;
            } else {
              currentFilterTag = tag;
            }
            renderPosts();
          });
          tagFilterContainer.appendChild(tagBtn);
        });
      };
      
      const renderSidebarPanels = () => {
        favoritesList.innerHTML = '';
        archivesList.innerHTML = '';
        
        posts.forEach(post => {
          if (post.isFavorite) {
            const favItem = document.createElement('div');
            favItem.className = 'fav-item';
            favItem.textContent = post.content.substring(0, 30) + '...';
            favItem.dataset.id = post.id;
            favItem.addEventListener('click', () => {
              document.querySelector(`[data-id="${post.id}"]`).scrollIntoView({ behavior: 'smooth' });
              showNotification('投稿にジャンプしました。', 'info');
            });
            favoritesList.appendChild(favItem);
          }
          if (post.isArchived) {
            const archiveItem = document.createElement('div');
            archiveItem.className = 'archive-item';
            archiveItem.textContent = post.content.substring(0, 30) + '...';
            archiveItem.dataset.id = post.id;
            archiveItem.addEventListener('click', () => {
              showNotification('アーカイブされた投稿は閲覧できません。', 'info');
            });
            archivesList.appendChild(archiveItem);
          }
        });
        
        updateStatistics();
      };
      
      const updateStatistics = () => {
        const totalPosts = posts.length;
        const totalReplies = posts.reduce((sum, post) => sum + (post.replies ? post.replies.length : 0), 0);
        const totalFavorites = posts.reduce((sum, post) => sum + post.favorites, 0);
        const uniqueTags = new Set(posts.flatMap(post => post.tags));
        
        statisticsContent.innerHTML = `
          <p>📝 総投稿数: ${totalPosts}</p>
          <p>💬 総返信数: ${totalReplies}</p>
          <p>⭐ 総お気に入り数: ${totalFavorites}</p>
          <p>🏷️ 総タグ数: ${uniqueTags.size}</p>
        `;
      };
      
      // --- Functional Logic ---
      const addPost = (content, tags, parentId = null) => {
        if (!content.trim()) {
          showNotification('投稿内容を入力してください。', 'warning');
          return;
        }
        
        const newPost = new Post(content, tags, parentId);
        
        if (parentId) {
          const parentPost = findPostById(posts, parentId);
          if (parentPost) {
            if (!parentPost.replies) parentPost.replies = [];
            parentPost.replies.push(newPost);
            showNotification('返信が投稿されました。', 'success');
          }
        } else {
          posts.push(newPost);
          showNotification('新しい投稿が作成されました。', 'success');
        }
        
        saveHistory();
        renderPosts();
        clearNewPostForm();
      };
      
      const findPostById = (arr, id) => {
        for (let i = 0; i < arr.length; i++) {
          if (arr[i].id === id) {
            return arr[i];
          }
          if (arr[i].replies) {
            const reply = findPostById(arr[i].replies, id);
            if (reply) return reply;
          }
        }
        return null;
      };
      
      const toggleReplyForm = (postElement, postId) => {
        const existingForm = postElement.querySelector('.reply-form');
        if (existingForm) {
          existingForm.remove();
          return;
        }
        
        const replyForm = document.createElement('div');
        replyForm.className = 'reply-form';
        replyForm.innerHTML = `
          <textarea class="reply-textarea" placeholder="返信を入力..."></textarea>
          <div class="reply-actions">
            <button class="post-btn btn-primary reply-submit">返信</button>
            <button class="post-btn btn-secondary reply-cancel">キャンセル</button>
          </div>
        `;
        
        postElement.appendChild(replyForm);
        
        const submitBtn = replyForm.querySelector('.reply-submit');
        const cancelBtn = replyForm.querySelector('.reply-cancel');
        const textarea = replyForm.querySelector('.reply-textarea');
        
        submitBtn.addEventListener('click', () => {
          addPost(textarea.value, [], postId);
          replyForm.remove();
        });
        
        cancelBtn.addEventListener('click', () => {
          replyForm.remove();
        });
      };
      
      const editPost = (postId, postElement) => {
        const post = findPostById(posts, postId);
        if (!post) return;
        
        const contentDiv = postElement.querySelector('.post-content');
        const originalContent = post.content;
        
        contentDiv.innerHTML = `<textarea class="edit-textarea" style="width:100%; min-height:100px;">${originalContent}</textarea>`;
        contentDiv.style.cursor = 'auto';
        
        const textarea = contentDiv.querySelector('.edit-textarea');
        const actionsDiv = postElement.querySelector('.post-actions');
        
        actionsDiv.innerHTML = `
          <button class="post-btn btn-primary save-edit">保存</button>
          <button class="post-btn btn-secondary cancel-edit">キャンセル</button>
        `;
        
        postElement.querySelector('.save-edit').addEventListener('click', () => {
          post.content = textarea.value;
          post.timestamp = new Date().toISOString();
          saveHistory();
          renderPosts();
          showNotification('投稿を編集しました。', 'success');
        });
        
        postElement.querySelector('.cancel-edit').addEventListener('click', () => {
          renderPosts(); // Simply re-render to revert
          showNotification('編集をキャンセルしました。', 'info');
        });
      };
      
      const deletePost = (postId) => {
        const postIndex = posts.findIndex(post => post.id === postId);
        if (postIndex > -1) {
          const deleted = posts.splice(postIndex, 1)[0];
          deletedPosts.push(deleted);
          saveHistory();
          renderPosts();
          showNotification('投稿を削除しました。復活ボタンで元に戻せます。', 'info');
        } else {
          // Check for replies
          posts.forEach(post => {
            if (post.replies) {
              const replyIndex = post.replies.findIndex(reply => reply.id === postId);
              if (replyIndex > -1) {
                const deleted = post.replies.splice(replyIndex, 1)[0];
                deletedPosts.push(deleted);
                saveHistory();
                renderPosts();
                showNotification('返信を削除しました。', 'info');
              }
            }
          });
        }
      };
      
      const toggleFavorite = (postId) => {
        const post = findPostById(posts, postId);
        if (post) {
          post.isFavorite = !post.isFavorite;
          if (post.isFavorite) {
            post.favorites++;
            showNotification('お気に入りに追加しました。', 'success');
          } else {
            post.favorites--;
            showNotification('お気に入りから削除しました。', 'info');
          }
          renderPosts();
        }
      };
      
      const archivePost = (postId) => {
        const post = findPostById(posts, postId);
        if (post) {
          post.isArchived = !post.isArchived;
          if (post.isArchived) {
            showNotification('投稿をアーカイブしました。', 'success');
          } else {
            showNotification('投稿をアーカイブから復元しました。', 'info');
          }
          renderPosts();
        }
      };
      
      const togglePin = (postId) => {
        const post = findPostById(posts, postId);
        if (post) {
          post.isPinned = !post.isPinned;
          renderPosts();
          showNotification(`投稿を${post.isPinned ? 'ピン留め' : 'ピン解除'}しました。`, 'info');
        }
      };
      
      const filterPosts = (postsArray) => {
        let filtered = postsArray;
        
        if (currentSearchQuery) {
          filtered = filtered.filter(post => 
            post.content.toLowerCase().includes(currentSearchQuery.toLowerCase()) ||
            post.tags.some(tag => tag.toLowerCase().includes(currentSearchQuery.toLowerCase()))
          );
        }
        
        if (currentFilterTag) {
          filtered = filtered.filter(post => post.tags.includes(currentFilterTag));
        }
        
        return filtered;
      };
      
      const sortPosts = (postsArray) => {
        const pinnedPosts = postsArray.filter(post => post.isPinned);
        const nonPinnedPosts = postsArray.filter(post => !post.isPinned);
        
        let sorted = [...nonPinnedPosts];
        
        switch(currentSort) {
          case 'new':
            sorted.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            break;
          case 'old':
            sorted.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
            break;
          case 'alpha':
            sorted.sort((a, b) => a.content.localeCompare(b.content, 'ja'));
            break;
          case 'popular':
            sorted.sort((a, b) => b.favorites - a.favorites);
            break;
        }
        
        return [...pinnedPosts, ...sorted];
      };
      
      const searchPosts = () => {
        currentSearchQuery = searchInput.value.trim();
        renderPosts();
        showNotification(`${posts.length}件の投稿を検索しました。`, 'info');
      };
      
      const resetSearch = () => {
        searchInput.value = '';
        currentSearchQuery = '';
        renderPosts();
        showNotification('検索がリセットされました。', 'info');
      };

      const clearNewPostForm = () => {
        newPostInput.value = '';
        tagInput.value = '';
        currentTags = [];
        updateCurrentTagsUI();
      };
      
      const updateCurrentTagsUI = () => {
        currentTagsContainer.innerHTML = '';
        currentTags.forEach(tag => {
          const tagSpan = document.createElement('span');
          tagSpan.className = 'tag';
          tagSpan.textContent = tag;
          const removeBtn = document.createElement('span');
          removeBtn.className = 'tag-removable';
          removeBtn.textContent = 'x';
          removeBtn.addEventListener('click', () => {
            currentTags = currentTags.filter(t => t !== tag);
            updateCurrentTagsUI();
          });
          tagSpan.appendChild(removeBtn);
          currentTagsContainer.appendChild(tagSpan);
        });
      };
      
      const toggleSidebarPanel = (panel) => {
        [favoritesPanel, archivesPanel, statisticsPanel].forEach(p => {
          if (p !== panel) {
            p.classList.remove('visible');
          }
        });
        panel.classList.toggle('visible');
      };

      const closeSidebarPanels = () => {
        [favoritesPanel, archivesPanel, statisticsPanel].forEach(p => p.classList.remove('visible'));
      };

      const toggleSettingsPanel = () => {
        settingsPanel.classList.toggle('visible');
        overlay.classList.toggle('visible');
      };

      const showNotification = (message, type = 'info', duration = 3000) => {
        const notification = document.createElement('div');
        notification.className = `notification ${type}`;
        notification.innerHTML = `<span>${message}</span><span class="close-notification">&times;</span>`;
        
        notificationArea.prepend(notification); // Add to top
        
        // Show the notification
        setTimeout(() => {
          notification.classList.add('visible');
        }, 10);
        
        // Hide after duration
        setTimeout(() => {
          notification.classList.remove('visible');
          notification.addEventListener('transitionend', () => notification.remove());
        }, duration);
        
        // Close on click
        notification.querySelector('.close-notification').addEventListener('click', () => {
          notification.classList.remove('visible');
          notification.addEventListener('transitionend', () => notification.remove());
        });
      };

      const initializeSettingsPanel = () => {
        // Button visibility
        const allButtons = document.querySelectorAll('.header-btn:not(#btn-settings)');
        allButtons.forEach(btn => {
          const itemId = btn.id;
          const itemName = btn.title || btn.textContent.trim();
          const item = document.createElement('div');
          item.className = 'button-item';
          item.innerHTML = `
            <input type="checkbox" id="btn-vis-${itemId}" checked>
            <label for="btn-vis-${itemId}">${itemName}</label>
          `;
          buttonVisibilityList.appendChild(item);
          
          item.querySelector('input').addEventListener('change', (e) => {
            btn.style.display = e.target.checked ? 'block' : 'none';
          });
        });

        // Theme color picker
        const colors = [
          '#007acc', '#28a745', '#ffc107', '#dc3545', '#17a2b8',
          '#6f42c1', '#fd7e14', '#e83e8c', '#6c757d', '#343a40'
        ];
        colors.forEach(color => {
          const colorBtn = document.createElement('div');
          colorBtn.className = 'color-btn';
          colorBtn.style.backgroundColor = color;
          colorBtn.addEventListener('click', () => {
            document.documentElement.style.setProperty('--primary-color', color);
            document.documentElement.style.setProperty('--primary-dark', color);
            document.documentElement.style.setProperty('--primary-darker', color);
            localStorage.setItem('themeColor', color);
          });
          themeColorPalette.appendChild(colorBtn);
        });

        const savedColor = localStorage.getItem('themeColor');
        if (savedColor) {
          document.documentElement.style.setProperty('--primary-color', savedColor);
          document.documentElement.style.setProperty('--primary-dark', savedColor);
          document.documentElement.style.setProperty('--primary-darker', savedColor);
        }
      };

      const loadDefaultTemplate = () => {
        const savedTemplate = localStorage.getItem('defaultTemplate');
        if (savedTemplate) {
          newPostInput.value = savedTemplate;
        }
      };

      // --- Event Listeners ---
      postBtn.addEventListener('click', () => {
        addPost(newPostInput.value, currentTags);
      });

      addTagBtn.addEventListener('click', () => {
        const tagsToAdd = tagInput.value.split(/\s+/).filter(t => t.trim() !== '');
        currentTags.push(...tagsToAdd);
        tagInput.value = '';
        updateCurrentTagsUI();
      });

      newPostInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && e.shiftKey) {
          e.preventDefault();
          postBtn.click();
        }
      });

      searchInput.addEventListener('input', () => {
        currentSearchQuery = searchInput.value.trim();
        renderPosts();
      });
      
      searchBtn.addEventListener('click', searchPosts);
      searchResetBtn.addEventListener('click', resetSearch);
      
      darkModeBtn.addEventListener('click', () => {
        document.body.classList.toggle('dark-mode');
      });
      
      sortNewBtn.addEventListener('click', () => {
        currentSort = 'new';
        document.querySelectorAll('.header-btn[id^="btn-sort"]').forEach(btn => btn.classList.remove('active'));
        sortNewBtn.classList.add('active');
        renderPosts();
      });
      
      sortOldBtn.addEventListener('click', () => {
        currentSort = 'old';
        document.querySelectorAll('.header-btn[id^="btn-sort"]').forEach(btn => btn.classList.remove('active'));
        sortOldBtn.classList.add('active');
        renderPosts();
      });
      
      sortAlphaBtn.addEventListener('click', () => {
        currentSort = 'alpha';
        document.querySelectorAll('.header-btn[id^="btn-sort"]').forEach(btn => btn.classList.remove('active'));
        sortAlphaBtn.classList.add('active');
        renderPosts();
      });
      
      sortPopularBtn.addEventListener('click', () => {
        currentSort = 'popular';
        document.querySelectorAll('.header-btn[id^="btn-sort"]').forEach(btn => btn.classList.remove('active'));
        sortPopularBtn.classList.add('active');
        renderPosts();
      });
      
      collapseExpandBtn.addEventListener('click', () => {
        isCollapsed = !isCollapsed;
        document.querySelectorAll('.post-content').forEach(content => {
          content.classList.toggle('collapsed', isCollapsed);
        });
        showNotification(`全投稿を${isCollapsed ? '折りたたみ' : '展開'}ました。`, 'info');
      });

      localCollapseBtn.addEventListener('click', () => {
        const postElements = document.querySelectorAll('.post');
        postElements.forEach(postEl => {
          const content = postEl.querySelector('.post-content');
          if (content) {
            content.classList.toggle('collapsed');
          }
        });
      });
      
      pinModeBtn.addEventListener('click', () => {
        isPinMode = !isPinMode;
        if (isPinMode) {
          pinModeBtn.classList.add('active');
          showNotification('ピンモードが有効になりました。', 'info');
        } else {
          pinModeBtn.classList.remove('active');
          showNotification('ピンモードが無効になりました。', 'info');
        }
      });
      
      favoritesBtn.addEventListener('click', () => toggleSidebarPanel(favoritesPanel));
      archivesBtn.addEventListener('click', () => toggleSidebarPanel(archivesPanel));
      statisticsBtn.addEventListener('click', () => toggleSidebarPanel(statisticsPanel));
      
      settingsBtn.addEventListener('click', toggleSettingsPanel);
      overlay.addEventListener('click', () => {
        toggleSettingsPanel();
        closeSidebarPanels();
      });
      
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && (settingsPanel.classList.contains('visible') || favoritesPanel.classList.contains('visible') || archivesPanel.classList.contains('visible') || statisticsPanel.classList.contains('visible'))) {
          toggleSettingsPanel();
          closeSidebarPanels();
        }
      });
      
      zoomSlider.addEventListener('input', (e) => {
        const zoomValue = e.target.value;
        document.body.style.zoom = `${zoomValue}%`;
        zoomValueSpan.textContent = `${zoomValue}%`;
      });
      
      buttonSizeSlider.addEventListener('input', (e) => {
        const sizeValue = e.target.value;
        document.documentElement.style.setProperty('--font-size-small', `${sizeValue * 0.85}rem`);
        document.documentElement.style.setProperty('--font-size-normal', `${sizeValue}rem`);
        document.documentElement.style.setProperty('--font-size-large', `${sizeValue * 1.2}rem`);
        buttonSizeValueSpan.textContent = `${sizeValue}x`;
      });
      
      undoBtn.addEventListener('click', undo);
      redoBtn.addEventListener('click', redo);
      
      recoverBtn.addEventListener('click', () => {
        if (deletedPosts.length > 0) {
          const recovered = deletedPosts.pop();
          posts.push(recovered);
          saveHistory();
          renderPosts();
          showNotification('最近削除した投稿を復活させました。', 'success');
        } else {
          showNotification('復活できる投稿はありません。', 'warning');
        }
      });

      saveBtn.addEventListener('click', () => {
        saveState();
        showNotification('データを保存しました！', 'success');
      });

      loadBtn.addEventListener('click', () => {
        loadFileInput.click();
      });

      loadFileInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (event) => {
          try {
            const data = JSON.parse(event.target.result);
            if (data.posts) {
              posts = data.posts;
              deletedPosts = data.deletedPosts || [];
              renderPosts();
              saveHistory();
              showNotification('データを読み込みました。', 'success');
            } else {
              showNotification('無効なファイル形式です。', 'error');
            }
          } catch (error) {
            showNotification('ファイルの解析に失敗しました。', 'error');
            console.error('File load error:', error);
          }
        };
        reader.readAsText(file);
      });

      exportBtn.addEventListener('click', () => {
        const data = { posts, deletedPosts };
        const json = JSON.stringify(data, null, 2);
        const blob = new Blob([json], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'board_data.json';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        showNotification('JSONファイルとしてエクスポートしました。', 'info');
      });

      saveTemplateBtn.addEventListener('click', () => {
        const templateContent = templateTextarea.value;
        localStorage.setItem('defaultTemplate', templateContent);
        showNotification('テンプレートを保存しました。', 'success');
      });
      
      printBtn.addEventListener('click', () => {
        window.print();
      });

      // --- Initialization ---
      const init = () => {
        loadState();
        // Add sample posts if none exist
        if (posts.length === 0) {
          posts.push(new Post('今日の出来事について話しましょう！\n皆さんの一日はいかがでしたか？', ['日常', '雑談']));
          posts.push(new Post('JavaScriptの非同期処理について質問です。Promiseとasync/awaitの違いを教えてください。', ['JavaScript', 'プログラミング']));
          posts[0].replies.push(new Post('私は今日は家でゆっくりしていました。とても良い一日でした！', ['休日', 'リラックス']));
        }
        renderPosts();
        updateHistoryButtons();
        initializeSettingsPanel();
        loadDefaultTemplate();
        // Set initial sort button state
        sortNewBtn.classList.add('active');
        saveHistory();
      };
      
      init();
    });
  </script>
</body>
</html>
