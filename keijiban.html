<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>マインドマップ掲示板</title>
  <style>
    /* 全体ベース */
    body {
      font-family: sans-serif;
      margin: 0;
      padding: 0;
      background: #fafafa;
      color: #333;
      transition: background 0.3s, color 0.3s;
    }
    /* グローバル操作エリア */
    #global-controls {
      background: #f0f0f0;
      padding: 10px;
      border-bottom: 1px solid #ccc;
    }
    #global-controls button,
    #global-controls input[type="text"],
    #global-controls input[type="range"] {
      margin-right: 5px;
    }
    /* ダークモード */
    body.dark {
      background-color: #333;
      color: #eee;
    }
    body.dark #global-controls {
      background: #555;
      border-bottom: 1px solid #666;
    }
    /* 新規投稿エリア */
    #new-post-area {
      margin: 10px;
    }
    #new-post-text {
      width: 80%;
      height: 50px;
      resize: vertical;
    }
    /* 投稿表示エリア */
    #posts-container {
      margin: 10px;
      transform-origin: 0 0;
    }
    .post {
      border: 1px solid #ccc;
      padding: 10px;
      margin: 5px;
      position: relative;
      background-color: #fff;
      cursor: move;
    }
    /* お気に入りの場合 */
    .post[data-favorite="true"] {
      border: 2px solid gold;
    }
    .post .content {
      user-select: none;
    }
    .post .controls {
      margin-top: 5px;
    }
    .post .controls button {
      margin-right: 3px;
    }
    .child-container {
      margin-left: 20px;
      margin-top: 10px;
    }
    /* 色変更パネル */
    .color-panel {
      position: absolute;
      top: 20px;
      left: 20px;
      background: #eee;
      border: 1px solid #aaa;
      padding: 5px;
      z-index: 100;
      display: flex;
      flex-wrap: wrap;
      width: 140px;
    }
    .color-option {
      width: 20px;
      height: 20px;
      margin: 2px;
      border: 1px solid #666;
      cursor: pointer;
    }
    /* 返信フォーム */
    .reply-form {
      margin-top: 10px;
    }
    /* 検索でヒットした部分のハイライト用 */
    .highlighted {
      background-color: yellow;
    }
    /* タグ絞り込みエリア */
    #tag-filter {
      margin: 10px;
      padding: 10px;
      border-top: 1px solid #ccc;
    }
    #tag-buttons button {
      margin: 2px;
    }
    /* お気に入り一覧パネル */
    #favorites-panel {
      display: none; 
      position: fixed; 
      right: 10px; 
      top: 50px; 
      background: #fff; 
      border: 1px solid #ccc; 
      padding: 10px; 
      z-index: 200;
    }
  </style>
</head>
<body>
  <!-- グローバル操作エリア -->
  <header id="global-controls">
    <button id="toggle-dark-mode">ダークモード切替</button>
    <!-- ソートボタン -->
    <button id="sort-newest">新しい順</button>
    <button id="sort-oldest">古い順</button>
    <button id="sort-alphabetical">五十音順</button>
    <button id="toggle-collapse-all">全投稿折りたたみ/展開</button>
    <button id="print-board">印刷</button>
    <button id="save-board">保存</button>
    <button id="load-board">読み込み</button>
    <input type="file" id="load-file" style="display:none">
    <button id="toggle-favorites">お気に入り一覧</button>
    <label for="zoom-slider">ズーム:</label>
    <input type="range" id="zoom-slider" min="0.5" max="2" step="0.1" value="1">
    <input type="text" id="search-input" placeholder="検索...">
    <button id="search-btn">検索</button>
    <button id="reset-search">検索リセット</button>
    <button id="undo-btn">元に戻す</button>
  </header>

  <!-- 新規投稿エリアと投稿ツリー -->
  <main>
    <div id="new-post-area">
      <textarea id="new-post-text" placeholder="新しい投稿を入力"></textarea>
      <button id="post-btn">投稿</button>
    </div>
    <div id="posts-container">
      <!-- 投稿はここに追加されます -->
    </div>
  </main>

  <!-- タグ絞り込みエリア -->
  <section id="tag-filter">
    <h3>タグで絞り込み</h3>
    <div id="tag-buttons"></div>
  </section>

  <!-- お気に入り一覧パネル -->
  <div id="favorites-panel">
    <h4>お気に入り一覧</h4>
    <div id="favorites-list"></div>
    <button id="close-favorites">閉じる</button>
  </div>

  <script>
    /**********************
     * グローバル変数
     **********************/
    let postCounter = 0;
    let undoStack = [];
    let currentCollapseState = false;
    let lastEnterTimestamp = 0; // 新規投稿用 Enter ダブル入力判定

    // 20色（必ず白を含む）…全く違う色を選定
    const predefinedColors = [
      "#FFFFFF", // White
      "#FF0000", // Red
      "#00FF00", // Lime
      "#0000FF", // Blue
      "#FFFF00", // Yellow
      "#FF00FF", // Fuchsia
      "#00FFFF", // Aqua
      "#800000", // Maroon
      "#008000", // DarkGreen
      "#000080", // Navy
      "#808000", // Olive
      "#800080", // Purple
      "#008080", // Teal
      "#C0C0C0", // Silver
      "#FFA500", // Orange
      "#A52A2A", // Brown
      "#D2691E", // Chocolate
      "#B22222", // Firebrick
      "#7FFF00", // Chartreuse
      "#FF1493"  // DeepPink
    ];

    // 状態保存（undo用）
    function saveState() {
      const container = document.getElementById('posts-container');
      undoStack.push(container.innerHTML);
      if (undoStack.length > 10) {
          undoStack.shift();
      }
    }
    // 元に戻す
    function undo() {
      if (undoStack.length > 0) {
          const container = document.getElementById('posts-container');
          container.innerHTML = undoStack.pop();
          setupAllPostEvents();
          updateTagButtons();
      } else {
          alert("これ以上元に戻せません。");
      }
    }

    /**********************
     * 投稿作成と操作
     **********************/
    // 新規投稿（または返信）の作成
    function createPostElement(text, parent = null) {
      postCounter++;
      const post = document.createElement('div');
      post.classList.add('post');
      post.setAttribute('draggable', 'true');
      post.dataset.id = postCounter;
      post.dataset.timestamp = Date.now();
      post.dataset.favorite = "false";
      post.dataset.collapsed = "false";
      // 検索用に元テキストを保持
      post.dataset.originalText = text;
      
      post.style.backgroundColor = getRandomColor();

      const content = document.createElement('div');
      content.classList.add('content');
      content.textContent = text;
      post.appendChild(content);

      const controls = document.createElement('div');
      controls.classList.add('controls');

      // 投稿テキストのダブルクリックで編集（インライン編集）
      content.addEventListener('dblclick', () => {
        const input = document.createElement('input');
        input.type = 'text';
        input.value = content.textContent;
        post.replaceChild(input, content);
        input.focus();
        input.addEventListener('blur', () => {
          content.textContent = input.value;
          post.dataset.originalText = input.value;
          post.replaceChild(content, input);
        });
        input.addEventListener('keydown', (e) => {
          if (e.key === 'Enter') {
            input.blur();
          }
        });
      });

      // 返信ボタン
      const replyBtn = document.createElement('button');
      replyBtn.textContent = "返信";
      replyBtn.addEventListener('click', () => {
        if (post.querySelector('.reply-form')) return;
        const replyForm = createReplyForm(post);
        post.appendChild(replyForm);
      });
      controls.appendChild(replyBtn);

      // お気に入りボタン
      const favBtn = document.createElement('button');
      updateFavoriteButton(favBtn, false);
      favBtn.addEventListener('click', () => {
        let fav = post.dataset.favorite === "true";
        fav = !fav;
        post.dataset.favorite = fav.toString();
        updateFavoriteButton(favBtn, fav);
        updateFavoritesPanel();
      });
      controls.appendChild(favBtn);

      // 色変更ボタン
      const colorChangeBtn = document.createElement('button');
      colorChangeBtn.textContent = "色変更";
      colorChangeBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        if (post.querySelector('.color-panel')) return;
        const panel = createColorPanel(post);
        post.appendChild(panel);
        setTimeout(() => {
          if (panel.parentNode) {
            panel.parentNode.removeChild(panel);
          }
        }, 5000);
      });
      controls.appendChild(colorChangeBtn);

      // タグ入力ボタン
      const tagBtn = document.createElement('button');
      tagBtn.textContent = "タグ";
      tagBtn.addEventListener('click', () => {
        let tags = prompt("カンマ区切りでタグを入力してください", post.dataset.tags || "");
        if (tags !== null) {
          post.dataset.tags = tags;
          updateTagButtons();
        }
      });
      controls.appendChild(tagBtn);

      // 削除ボタン
      const deleteBtn = document.createElement('button');
      deleteBtn.textContent = "削除";
      deleteBtn.addEventListener('click', () => {
        if (confirm("この投稿を削除しますか？")) {
          saveState();
          post.parentNode.removeChild(post);
          updateTagButtons();
        }
      });
      controls.appendChild(deleteBtn);

      // 折りたたみ／展開ボタン
      const toggleBtn = document.createElement('button');
      toggleBtn.textContent = "折";
      toggleBtn.addEventListener('click', () => {
        const childContainer = post.querySelector('.child-container');
        if (childContainer) {
          if (childContainer.style.display === 'none') {
            childContainer.style.display = '';
            toggleBtn.textContent = "折";
            post.dataset.collapsed = "false";
          } else {
            childContainer.style.display = 'none';
            toggleBtn.textContent = "展";
            post.dataset.collapsed = "true";
          }
        }
      });
      controls.appendChild(toggleBtn);

      post.appendChild(controls);

      // 子投稿（返信）コンテナ
      const childContainer = document.createElement('div');
      childContainer.classList.add('child-container');
      post.appendChild(childContainer);

      setupDragAndDrop(post);

      if (parent) {
        const parentChildContainer = parent.querySelector('.child-container');
        parentChildContainer.appendChild(post);
      } else {
        document.getElementById('posts-container').appendChild(post);
      }

      saveState();
      return post;
    }
    // 返信フォームの生成（返信もダブルクリックで送信可能）
    function createReplyForm(parentPost) {
      const formDiv = document.createElement('div');
      formDiv.classList.add('reply-form');
      const textarea = document.createElement('textarea');
      textarea.placeholder = "返信メッセージを入力";
      formDiv.appendChild(textarea);
      
      // 送信ボタン（従来のクリック送信）
      const sendBtn = document.createElement('button');
      sendBtn.textContent = "送信";
      sendBtn.addEventListener('click', () => {
        if (textarea.value.trim() !== "") {
          createPostElement(textarea.value, parentPost);
          formDiv.remove();
        }
      });
      formDiv.appendChild(sendBtn);

      // ダブルクリックで返信送信
      textarea.addEventListener('dblclick', () => {
        if (textarea.value.trim() !== "") {
          createPostElement(textarea.value, parentPost);
          formDiv.remove();
        }
      });

      const cancelBtn = document.createElement('button');
      cancelBtn.textContent = "キャンセル";
      cancelBtn.addEventListener('click', () => {
        formDiv.remove();
      });
      formDiv.appendChild(cancelBtn);
      return formDiv;
    }
    // 色変更パネル作成
    function createColorPanel(post) {
      const panel = document.createElement('div');
      panel.classList.add('color-panel');
      predefinedColors.forEach(color => {
        const colorOpt = document.createElement('div');
        colorOpt.classList.add('color-option');
        colorOpt.style.backgroundColor = color;
        colorOpt.addEventListener('click', () => {
          post.style.backgroundColor = color;
          panel.remove();
        });
        panel.appendChild(colorOpt);
      });
      return panel;
    }
    // お気に入りボタン更新
    function updateFavoriteButton(btn, isFav) {
      btn.textContent = isFav ? "★" : "☆";
    }
    // ドラッグ＆ドロップの設定
    function setupDragAndDrop(post) {
      post.addEventListener('dragstart', (e) => {
        e.dataTransfer.setData("text/plain", post.dataset.id);
        saveState();
      });
      post.addEventListener('dragover', (e) => {
        e.preventDefault();
        post.style.borderColor = "blue";
      });
      post.addEventListener('dragleave', (e) => {
        post.style.borderColor = "#ccc";
      });
      post.addEventListener('drop', (e) => {
        e.preventDefault();
        post.style.borderColor = "#ccc";
        const draggedId = e.dataTransfer.getData("text/plain");
        if (draggedId === post.dataset.id) return;
        const draggedElem = document.querySelector(`.post[data-id='${draggedId}']`);
        if (draggedElem.contains(post)) {
          alert("自分自身や子孫にドロップはできません。");
          return;
        }
        const childContainer = post.querySelector('.child-container');
        childContainer.appendChild(draggedElem);
      });
    }
    // すべての投稿にイベント再設定（undo 後など）
    function setupAllPostEvents() {
      const posts = document.querySelectorAll('.post');
      posts.forEach(post => {
        setupDragAndDrop(post);
        const content = post.querySelector('.content');
        content.removeEventListener('dblclick', null);
        content.addEventListener('dblclick', () => {
          const input = document.createElement('input');
          input.type = 'text';
          input.value = content.textContent;
          post.replaceChild(input, content);
          input.focus();
          input.addEventListener('blur', () => {
            content.textContent = input.value;
            post.dataset.originalText = input.value;
            post.replaceChild(content, input);
          });
          input.addEventListener('keydown', (e) => {
            if(e.key === 'Enter'){
              input.blur();
            }
          });
        });
      });
    }

    /**********************
     * タグ絞り込み機能
     **********************/
    function updateTagButtons() {
      const tagButtonsDiv = document.getElementById('tag-buttons');
      tagButtonsDiv.innerHTML = "";
      const tagsSet = new Set();
      document.querySelectorAll('.post').forEach(post => {
        if (post.dataset.tags) {
          post.dataset.tags.split(',').map(t => t.trim()).forEach(tag => {
            if (tag) tagsSet.add(tag);
          });
        }
      });
      tagsSet.forEach(tag => {
        const btn = document.createElement('button');
        btn.textContent = tag;
        btn.dataset.active = "false";
        btn.addEventListener('click', () => {
          const isActive = btn.dataset.active === "true";
          btn.dataset.active = isActive ? "false" : "true";
          filterPostsByTags();
        });
        tagButtonsDiv.appendChild(btn);
      });
    }
    function filterPostsByTags() {
      const activeTags = Array.from(document.querySelectorAll('#tag-buttons button'))
                           .filter(btn => btn.dataset.active === "true")
                           .map(btn => btn.textContent);
      document.querySelectorAll('.post').forEach(post => {
        if (activeTags.length === 0) {
          post.style.display = "";
        } else {
          if (post.dataset.tags) {
            const postTags = post.dataset.tags.split(',').map(t => t.trim());
            const hasAll = activeTags.every(tag => postTags.includes(tag));
            post.style.display = hasAll ? "" : "none";
          } else {
            post.style.display = "none";
          }
        }
      });
    }

    /**********************
     * ソート機能
     **********************/
    function sortPostsNewest() {
      const container = document.getElementById('posts-container');
      const postsArray = Array.from(container.children);
      postsArray.sort((a, b) => Number(b.dataset.timestamp) - Number(a.dataset.timestamp));
      container.innerHTML = "";
      postsArray.forEach(post => container.appendChild(post));
    }
    function sortPostsOldest() {
      const container = document.getElementById('posts-container');
      const postsArray = Array.from(container.children);
      postsArray.sort((a, b) => Number(a.dataset.timestamp) - Number(b.dataset.timestamp));
      container.innerHTML = "";
      postsArray.forEach(post => container.appendChild(post));
    }
    function sortPostsAlphabetical() {
      const container = document.getElementById('posts-container');
      const postsArray = Array.from(container.children);
      postsArray.sort((a, b) => {
        const textA = a.querySelector('.content').textContent.trim();
        const textB = b.querySelector('.content').textContent.trim();
        return textA.localeCompare(textB, 'ja');
      });
      container.innerHTML = "";
      postsArray.forEach(post => container.appendChild(post));
    }

    /**********************
     * グローバル操作
     **********************/
    document.getElementById('toggle-dark-mode').addEventListener('click', () => {
      document.body.classList.toggle('dark');
    });
    // ソートボタン
    document.getElementById('sort-newest').addEventListener('click', sortPostsNewest);
    document.getElementById('sort-oldest').addEventListener('click', sortPostsOldest);
    document.getElementById('sort-alphabetical').addEventListener('click', sortPostsAlphabetical);
    // 全投稿折りたたみ／展開
    document.getElementById('toggle-collapse-all').addEventListener('click', () => {
      const posts = document.querySelectorAll('.post');
      currentCollapseState = !currentCollapseState;
      posts.forEach(post => {
        const childContainer = post.querySelector('.child-container');
        if (childContainer) {
          childContainer.style.display = currentCollapseState ? 'none' : '';
          // ※ 折りたたみボタンは controls 内の6番目のボタン（返信,お気に入り,色変更,タグ,削除,折/展）
          const toggleBtn = post.querySelector('.controls button:nth-child(6)');
          if (toggleBtn) {
            toggleBtn.textContent = currentCollapseState ? "展" : "折";
          }
          post.dataset.collapsed = currentCollapseState.toString();
        }
      });
    });
    document.getElementById('print-board').addEventListener('click', () => {
      window.print();
    });
    // 保存：現在の投稿ツリーを JSON としてエクスポート
    document.getElementById('save-board').addEventListener('click', () => {
      const data = { posts: document.getElementById('posts-container').innerHTML };
      const jsonStr = JSON.stringify(data);
      const blob = new Blob([jsonStr], {type: 'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      const dateStr = new Date().toISOString().replace(/[:.]/g, "-");
      a.download = "マインドマップ掲示板_" + dateStr + ".json";
      a.href = url;
      a.click();
    });
    // 読み込み：以前保存した JSON を復元
    document.getElementById('load-board').addEventListener('click', () => {
      document.getElementById('load-file').click();
    });
    document.getElementById('load-file').addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const data = JSON.parse(e.target.result);
          document.getElementById('posts-container').innerHTML = data.posts;
          setupAllPostEvents();
          updateTagButtons();
        } catch(err) {
          alert("読み込みエラー：" + err);
        }
      };
      reader.readAsText(file);
    });
    // お気に入り一覧パネル
    document.getElementById('toggle-favorites').addEventListener('click', () => {
      const panel = document.getElementById('favorites-panel');
      if (panel.style.display === "none" || panel.style.display === "") {
        updateFavoritesPanel();
        panel.style.display = "block";
      } else {
        panel.style.display = "none";
      }
    });
    document.getElementById('close-favorites').addEventListener('click', () => {
      document.getElementById('favorites-panel').style.display = "none";
    });
    function updateFavoritesPanel() {
      const favList = document.getElementById('favorites-list');
      favList.innerHTML = "";
      document.querySelectorAll('.post').forEach(post => {
        if (post.dataset.favorite === "true") {
          const item = document.createElement('div');
          item.textContent = post.querySelector('.content').textContent;
          item.style.cursor = "pointer";
          item.addEventListener('click', () => {
            post.scrollIntoView({behavior: "smooth"});
          });
          favList.appendChild(item);
        }
      });
    }
    // ズーム機能
    document.getElementById('zoom-slider').addEventListener('input', (e) => {
      const scale = e.target.value;
      document.getElementById('posts-container').style.transform = `scale(${scale})`;
    });

    /**********************
     * 検索機能（ハイライト）
     **********************/
    function escapeRegExp(string) {
      return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    }
    document.getElementById('search-btn').addEventListener('click', () => {
      const keyword = document.getElementById('search-input').value.trim();
      document.querySelectorAll('.post').forEach(post => {
        const contentElem = post.querySelector('.content');
        const originalText = post.dataset.originalText || contentElem.textContent;
        if (keyword === "") {
          contentElem.innerHTML = originalText;
          return;
        }
        const regex = new RegExp(escapeRegExp(keyword), "gi");
        const highlightedText = originalText.replace(regex, (match) => `<span class="highlighted">${match}</span>`);
        contentElem.innerHTML = highlightedText;
      });
    });
    document.getElementById('reset-search').addEventListener('click', () => {
      document.getElementById('search-input').value = "";
      document.querySelectorAll('.post').forEach(post => {
        const contentElem = post.querySelector('.content');
        contentElem.innerHTML = post.dataset.originalText || contentElem.textContent;
      });
    });

    /**********************
     * その他操作
     **********************/
    // 元に戻す
    document.getElementById('undo-btn').addEventListener('click', () => {
      undo();
    });
    // 新規投稿（「投稿」ボタンのクリックまたは Enter ダブル入力）
    document.getElementById('post-btn').addEventListener('click', () => {
      const text = document.getElementById('new-post-text').value.trim();
      if (text === "") return;
      createPostElement(text);
      document.getElementById('new-post-text').value = "";
      updateTagButtons();
    });
    document.getElementById('new-post-text').addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        const now = Date.now();
        if (now - lastEnterTimestamp < 300) { // 300ms以内ならダブルEnterと判定
          e.preventDefault();
          document.getElementById('post-btn').click();
          lastEnterTimestamp = 0;
        } else {
          lastEnterTimestamp = now;
        }
      }
    });
    // Escape キーですべての返信フォームを閉じる
    document.addEventListener('keydown', (e) => {
      if (e.key === "Escape") {
        document.querySelectorAll('.reply-form').forEach(form => form.remove());
      }
    });

    // ヘルパー：ランダムな色を取得
    function getRandomColor() {
      return predefinedColors[Math.floor(Math.random() * predefinedColors.length)];
    }
  </script>
</body>
</html>
