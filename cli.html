<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Web CLI (VFSæ­è¼‰)</title>
  <style>
    * { box-sizing: border-box; }
    body {
      margin:0; padding:0; height:100vh;
      font-family: monospace;
      background:#272822; color:#f8f8f2;
    }
    #terminal {
      position:absolute; top:0; left:0; right:0; bottom:60px;
      overflow-y:auto; padding:10px;
      white-space:pre-wrap;
    }
    .line { margin:2px 0; display:flex; align-items:center; }
    .output { flex:1; padding:2px 4px; }
    .copyBtn { margin-left:6px; cursor:pointer; opacity:0.6; }
    .copyBtn:hover {opacity:1;}
    /* help ãƒã‚¤ãƒ©ã‚¤ãƒˆå°‚ç”¨ */
    .help-highlight {
      background: yellow;
      color: black;
      border-radius: 4px;
      padding: 2px 4px;
      display: inline-block;
      width: 100%;
    }
    .prompt-line {
      position:absolute; bottom:0; left:0; right:0;
      display:flex; align-items:center;
      padding:10px;
      background:#1e1e1e; border-top:1px solid #444;
    }
    .prompt-label { margin-right:6px; }
    #input {
      flex:1; font-size:1em;
      background:none; border:none; outline:none; color:inherit;
    }
    .error{color:#f92672;} .success{color:#a6e22e;} .info{color:#66d9ef;}
    #helpBtn{
      position:fixed; top:12px; right:12px; z-index:1000;
      width:42px; height:42px;
      background:#1e1e1e; color:#f8f8f2;
      border:none; border-radius:6px;
      font-size:1.2em;
    }
    .overlay{position:fixed; inset:0; display:flex;
      align-items:center; justify-content:center;
      background:rgba(0,0,0,0.75); padding:20px;}
    .hidden{display:none;}
    .overlay-content{background:#272822; color:#f8f8f2; padding:20px; border-radius:8px; width:320px;}
    .overlay-content ul{list-style:none; padding:0;}
    .overlay-content li{margin-bottom:6px;}
    .overlay-content button{margin-top:12px; padding:8px 14px; background:#444; border:none; border-radius:4px; color:#eee;}
  </style>
</head>
<body>
  <button id="helpBtn">?</button>
  <div id="terminal"></div>
  <div class="prompt-line">
    <span class="prompt-label">></span>
    <input id="input" autocomplete="off" autofocus/>
  </div>
  <div id="cmdOverlay" class="overlay hidden">
    <div class="overlay-content">
      <h2>ã‚³ãƒãƒ³ãƒ‰ä¸€è¦§</h2>
      <ul>
        <li><code>help</code>               : ã‚³ãƒãƒ³ãƒ‰ä¸€è¦§è¡¨ç¤º</li>
        <li><code>pwd</code>                : ã‚«ãƒ¬ãƒ³ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªè¡¨ç¤º</li>
        <li><code>ls</code>                 : ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä¸€è¦§</li>
        <li><code>cd &lt;dir&gt;</code>     : ã‚«ãƒ¬ãƒ³ãƒˆå¤‰æ›´</li>
        <li><code>mkdir &lt;dir&gt;</code>   : ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ</li>
        <li><code>touch &lt;file&gt;</code>  : ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ</li>
        <li><code>cat &lt;file&gt;</code>    : ãƒ•ã‚¡ã‚¤ãƒ«è¡¨ç¤º</li>
        <li><code>write &lt;file&gt; text</code>: ãƒ•ã‚¡ã‚¤ãƒ«ä¸Šæ›¸ã</li>
        <li><code>append &lt;file&gt; text</code>: ãƒ•ã‚¡ã‚¤ãƒ«è¿½è¨˜</li>
        <li><code>rm &lt;file/dir&gt;</code>   : å‰Šé™¤</li>
        <li><code>tree</code>              : ãƒ„ãƒªãƒ¼è¡¨ç¤º</li>
        <li><code>clear</code>             : ç”»é¢ã‚¯ãƒªã‚¢</li>
      </ul>
      <button id="closeOverlay">é–‰ã˜ã‚‹</button>
    </div>
  </div>

<script>
document.addEventListener('DOMContentLoaded', ()=>{
  const terminal=document.getElementById('terminal');
  const input=document.getElementById('input');
  const helpBtn=document.getElementById('helpBtn');
  const overlay=document.getElementById('cmdOverlay');
  const closeBtn=document.getElementById('closeOverlay');

  // === VFSåˆæœŸåŒ– ===
  let vfs = JSON.parse(localStorage.getItem("VFS")) || {type:"dir", children:{}}; 
  let cwd = []; // pathé…åˆ—
  function saveVFS(){ localStorage.setItem("VFS",JSON.stringify(vfs)); }
  function getNode(path){
    let node=vfs;
    for(let p of path){
      if(node.type==="dir" && node.children[p]) node=node.children[p];
      else return null;
    }
    return node;
  }
  function ensureDir(node){ return node && node.type==="dir"; }

  // === å‡ºåŠ›é–¢æ•° ===
  function print(text, cls="", highlight=false){
    const line=document.createElement("div");
    line.className="line";
    const span=document.createElement("span");
    span.className="output"; 
    if(cls) span.classList.add(cls);
    span.textContent=text;
    if(highlight){
      span.classList.add("help-highlight");
    }
    const cbtn=document.createElement("span");
    cbtn.textContent="ğŸ“‹"; cbtn.className="copyBtn";
    cbtn.onclick=()=>navigator.clipboard.writeText(text);
    line.appendChild(span);
    if(text) line.appendChild(cbtn);
    terminal.appendChild(line);
    terminal.scrollTop=terminal.scrollHeight;
  }

  function resolvePath(pathStr){
    if(!pathStr) return [...cwd];
    let parts=pathStr.split("/");
    let res=(pathStr.startsWith("/"))? []:[...cwd];
    for(let p of parts){
      if(p===""||p===".") continue;
      if(p==="..") res.pop(); else res.push(p);
    }
    return res;
  }

  function showTree(node,prefix=""){
    let out="";
    if(node.type==="dir"){
      for(let k in node.children){
        out+=prefix+"- "+k+(node.children[k].type==="dir"?"/":"")+"\n";
        if(node.children[k].type==="dir")
          out+=showTree(node.children[k],prefix+"   ");
      }
    }
    return out;
  }

  // === HELPå‡ºåŠ› ===
  const helpCommands = [
    ["help","ã‚³ãƒãƒ³ãƒ‰ä¸€è¦§ã¨èª¬æ˜ã‚’è¡¨ç¤º"],
    ["pwd","ç¾åœ¨ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’è¡¨ç¤º"],
    ["ls","ç¾åœ¨ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå†…ã®ä¸€è¦§ã‚’è¡¨ç¤º"],
    ["cd <dir>","ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ç§»å‹•"],
    ["mkdir <dir>","æ–°ã—ã„ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆ"],
    ["touch <file>","ç©ºã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ"],
    ["cat <file>","ãƒ•ã‚¡ã‚¤ãƒ«ã®å†…å®¹ã‚’è¡¨ç¤º"],
    ["write <file> text","ãƒ•ã‚¡ã‚¤ãƒ«ã«ãƒ†ã‚­ã‚¹ãƒˆã‚’æ›¸ãè¾¼ã¿ï¼ˆä¸Šæ›¸ãï¼‰"],
    ["append <file> text","ãƒ•ã‚¡ã‚¤ãƒ«ã«ãƒ†ã‚­ã‚¹ãƒˆã‚’è¿½è¨˜"],
    ["rm <file/dir>","ãƒ•ã‚¡ã‚¤ãƒ«ã¾ãŸã¯ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’å‰Šé™¤"],
    ["tree","ä»®æƒ³ãƒ•ã‚¡ã‚¤ãƒ«ãƒ„ãƒªãƒ¼ã‚’è¡¨ç¤º"],
    ["clear","ç”»é¢ã‚’ã‚¯ãƒªã‚¢ã™ã‚‹"]
  ];

  function showHelp(){
    print("åˆ©ç”¨å¯èƒ½ãªã‚³ãƒãƒ³ãƒ‰ä¸€è¦§ (èª¬æ˜ä»˜ã):");
    helpCommands.forEach(([cmd,desc])=>{
      print(cmd+" : "+desc,"","highlight");
    });
  }

  // === ã‚³ãƒãƒ³ãƒ‰è§£é‡ˆ ===
  function processCommand(line){
    if(!line.trim()) return;
    print(">"+line,"info");
    const args=line.trim().split(/\s+/);
    const cmd=args[0];

    switch(cmd){
      case "help": showHelp(); break;
      case "pwd": print("/"+cwd.join("/")); break;
      case "ls":{
        const node=getNode(cwd);
        if(!ensureDir(node)) return print("ä¸æ­£ãªãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª","error");
        print(Object.keys(node.children).map(k=> node.children[k].type==="dir"?k+"/":k).join("  "));
        break;
      }
      case "cd":{
        const path=resolvePath(args[1]);
        const node=getNode(path);
        if(ensureDir(node)){ cwd=path; print("ç¾åœ¨: /"+cwd.join("/")); }
        else print("cd: ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒå­˜åœ¨ã—ã¾ã›ã‚“","error");
        break;
      }
      case "mkdir":{
        if(!args) return print("mkdir: åå‰ãŒå¿…è¦","error");
        const node=getNode(cwd);
        if(node.children[args]) return print("mkdir: æ—¢ã«å­˜åœ¨","error");
        node.children[args]={type:"dir",children:{}}; saveVFS();
        break;
      }
      case "touch":{
        if(!args) return print("touch: ãƒ•ã‚¡ã‚¤ãƒ«åãŒå¿…è¦","error");
        const node=getNode(cwd);
        node.children[args]={type:"file",content:""}; saveVFS();
        break;
      }
      case "cat":{
        if(!args) return print("cat: ãƒ•ã‚¡ã‚¤ãƒ«åãŒå¿…è¦","error");
        const f=getNode(cwd).children[args];
        if(f && f.type==="file") print(f.content);
        else print("cat: ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã—ã¾ã›ã‚“","error");
        break;
      }
      case "write":{
        if(args.length<3) return print("write: ãƒ•ã‚¡ã‚¤ãƒ«ã¨å†…å®¹ã‚’æŒ‡å®š","error");
        const node=getNode(cwd);
        if(!node.children[args[1]]) node.children[args]={type:"file",content:""};
        if(node.children[args].type!=="file") return print("write: ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã§ã™","error");
        node.children[args].content=args.slice(2).join(" "); saveVFS();
        break;
      }
      case "append":{
        if(args.length<3) return print("append: ãƒ•ã‚¡ã‚¤ãƒ«ã¨å†…å®¹ã‚’æŒ‡å®š","error");
        const node=getNode(cwd);
        if(!node.children[args]) node.children[args]={type:"file",content:""};
        if(node.children[args].type!=="file") return print("append: ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã§ã™","error");
        node.children[args].content+=(node.children[args].content?"\n":"")+args.slice(2).join(" "); saveVFS();
        break;
      }
      case "rm":{
        if(!args) return print("rm: å¯¾è±¡æŒ‡å®šå¿…è¦","error");
        const node=getNode(cwd);
        if(node.children[args]) { delete node.children[args]; saveVFS();}
        else print("rm: è¦‹ã¤ã‹ã‚‰ãªã„","error");
        break;
      }
      case "tree": print("/\n"+showTree(vfs," ")); break;
      case "clear": terminal.innerHTML=""; break;
      default: print("æœªçŸ¥ã®ã‚³ãƒãƒ³ãƒ‰: "+cmd,"error");
    }
  }

  // === å…¥åŠ›å‡¦ç† ===
  input.addEventListener("keydown", e=>{
    if(e.key==="Enter"){ processCommand(input.value); input.value=""; e.preventDefault(); }
  });

  helpBtn.onclick=()=>overlay.classList.remove("hidden");
  closeBtn.onclick=()=>overlay.classList.add("hidden");
  overlay.addEventListener('click', e=>{ if(e.target===overlay) overlay.classList.add("hidden"); });

  print("=== Web CLI VFSç‰ˆã¸ã‚ˆã†ã“ã ===");
  print("help ã§ã‚³ãƒãƒ³ãƒ‰ä¸€è¦§(èª¬æ˜ä»˜ã)ã‚’è¡¨ç¤ºã—ã¾ã™");
});
</script>
</body>
</html>
