<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Web CLI (VFS搭載)</title>
  <style>
    * { box-sizing: border-box; }
    body {
      margin:0; padding:0; height:100vh;
      font-family: monospace;
      background:#272822; color:#f8f8f2;
    }
    #terminal {
      position:absolute; top:0; left:0; right:0; bottom:60px;
      overflow-y:auto; padding:10px;
      white-space:pre-wrap;
    }
    .line { margin:2px 0; display:flex; align-items:center; }
    .output { flex:1; padding:2px 4px; }
    .copyBtn { margin-left:6px; cursor:pointer; opacity:0.6; }
    .copyBtn:hover {opacity:1;}
    /* help ハイライト専用 */
    .help-highlight {
      background: yellow;
      color: black;
      border-radius: 4px;
      padding: 2px 4px;
      display: inline-block;
      width: 100%;
    }
    .prompt-line {
      position:absolute; bottom:0; left:0; right:0;
      display:flex; align-items:center;
      padding:10px;
      background:#1e1e1e; border-top:1px solid #444;
    }
    .prompt-label { margin-right:6px; }
    #input {
      flex:1; font-size:1em;
      background:none; border:none; outline:none; color:inherit;
    }
    .error{color:#f92672;} .success{color:#a6e22e;} .info{color:#66d9ef;}
    #helpBtn{
      position:fixed; top:12px; right:12px; z-index:1000;
      width:42px; height:42px;
      background:#1e1e1e; color:#f8f8f2;
      border:none; border-radius:6px;
      font-size:1.2em;
    }
    .overlay{position:fixed; inset:0; display:flex;
      align-items:center; justify-content:center;
      background:rgba(0,0,0,0.75); padding:20px;}
    .hidden{display:none;}
    .overlay-content{background:#272822; color:#f8f8f2; padding:20px; border-radius:8px; width:320px;}
    .overlay-content ul{list-style:none; padding:0;}
    .overlay-content li{margin-bottom:6px;}
    .overlay-content button{margin-top:12px; padding:8px 14px; background:#444; border:none; border-radius:4px; color:#eee;}
  </style>
</head>
<body>
  <button id="helpBtn">?</button>
  <div id="terminal"></div>
  <div class="prompt-line">
    <span class="prompt-label">></span>
    <input id="input" autocomplete="off" autofocus/>
  </div>
  <div id="cmdOverlay" class="overlay hidden">
    <div class="overlay-content">
      <h2>コマンド一覧</h2>
      <ul>
        <li><code>help</code>               : コマンド一覧表示</li>
        <li><code>pwd</code>                : カレントディレクトリ表示</li>
        <li><code>ls</code>                 : ディレクトリ一覧</li>
        <li><code>cd &lt;dir&gt;</code>     : カレント変更</li>
        <li><code>mkdir &lt;dir&gt;</code>   : ディレクトリ作成</li>
        <li><code>touch &lt;file&gt;</code>  : ファイル作成</li>
        <li><code>cat &lt;file&gt;</code>    : ファイル表示</li>
        <li><code>write &lt;file&gt; text</code>: ファイル上書き</li>
        <li><code>append &lt;file&gt; text</code>: ファイル追記</li>
        <li><code>rm &lt;file/dir&gt;</code>   : 削除</li>
        <li><code>tree</code>              : ツリー表示</li>
        <li><code>clear</code>             : 画面クリア</li>
      </ul>
      <button id="closeOverlay">閉じる</button>
    </div>
  </div>

<script>
document.addEventListener('DOMContentLoaded', ()=>{
  const terminal=document.getElementById('terminal');
  const input=document.getElementById('input');
  const helpBtn=document.getElementById('helpBtn');
  const overlay=document.getElementById('cmdOverlay');
  const closeBtn=document.getElementById('closeOverlay');

  // === VFS初期化 ===
  let vfs = JSON.parse(localStorage.getItem("VFS")) || {type:"dir", children:{}}; 
  let cwd = []; // path配列
  function saveVFS(){ localStorage.setItem("VFS",JSON.stringify(vfs)); }
  function getNode(path){
    let node=vfs;
    for(let p of path){
      if(node.type==="dir" && node.children[p]) node=node.children[p];
      else return null;
    }
    return node;
  }
  function ensureDir(node){ return node && node.type==="dir"; }

  // === 出力関数 ===
  function print(text, cls="", highlight=false){
    const line=document.createElement("div");
    line.className="line";
    const span=document.createElement("span");
    span.className="output"; 
    if(cls) span.classList.add(cls);
    span.textContent=text;
    if(highlight){
      span.classList.add("help-highlight");
    }
    const cbtn=document.createElement("span");
    cbtn.textContent="📋"; cbtn.className="copyBtn";
    cbtn.onclick=()=>navigator.clipboard.writeText(text);
    line.appendChild(span);
    if(text) line.appendChild(cbtn);
    terminal.appendChild(line);
    terminal.scrollTop=terminal.scrollHeight;
  }

  function resolvePath(pathStr){
    if(!pathStr) return [...cwd];
    let parts=pathStr.split("/");
    let res=(pathStr.startsWith("/"))? []:[...cwd];
    for(let p of parts){
      if(p===""||p===".") continue;
      if(p==="..") res.pop(); else res.push(p);
    }
    return res;
  }

  function showTree(node,prefix=""){
    let out="";
    if(node.type==="dir"){
      for(let k in node.children){
        out+=prefix+"- "+k+(node.children[k].type==="dir"?"/":"")+"\n";
        if(node.children[k].type==="dir")
          out+=showTree(node.children[k],prefix+"   ");
      }
    }
    return out;
  }

  // === HELP出力 ===
  const helpCommands = [
    ["help","コマンド一覧と説明を表示"],
    ["pwd","現在のディレクトリを表示"],
    ["ls","現在のディレクトリ内の一覧を表示"],
    ["cd <dir>","ディレクトリを移動"],
    ["mkdir <dir>","新しいディレクトリを作成"],
    ["touch <file>","空のファイルを作成"],
    ["cat <file>","ファイルの内容を表示"],
    ["write <file> text","ファイルにテキストを書き込み（上書き）"],
    ["append <file> text","ファイルにテキストを追記"],
    ["rm <file/dir>","ファイルまたはディレクトリを削除"],
    ["tree","仮想ファイルツリーを表示"],
    ["clear","画面をクリアする"]
  ];

  function showHelp(){
    print("利用可能なコマンド一覧 (説明付き):");
    helpCommands.forEach(([cmd,desc])=>{
      print(cmd+" : "+desc,"","highlight");
    });
  }

  // === コマンド解釈 ===
  function processCommand(line){
    if(!line.trim()) return;
    print(">"+line,"info");
    const args=line.trim().split(/\s+/);
    const cmd=args[0];

    switch(cmd){
      case "help": showHelp(); break;
      case "pwd": print("/"+cwd.join("/")); break;
      case "ls":{
        const node=getNode(cwd);
        if(!ensureDir(node)) return print("不正なディレクトリ","error");
        print(Object.keys(node.children).map(k=> node.children[k].type==="dir"?k+"/":k).join("  "));
        break;
      }
      case "cd":{
        const path=resolvePath(args[1]);
        const node=getNode(path);
        if(ensureDir(node)){ cwd=path; print("現在: /"+cwd.join("/")); }
        else print("cd: ディレクトリが存在しません","error");
        break;
      }
      case "mkdir":{
        if(!args) return print("mkdir: 名前が必要","error");
        const node=getNode(cwd);
        if(node.children[args]) return print("mkdir: 既に存在","error");
        node.children[args]={type:"dir",children:{}}; saveVFS();
        break;
      }
      case "touch":{
        if(!args) return print("touch: ファイル名が必要","error");
        const node=getNode(cwd);
        node.children[args]={type:"file",content:""}; saveVFS();
        break;
      }
      case "cat":{
        if(!args) return print("cat: ファイル名が必要","error");
        const f=getNode(cwd).children[args];
        if(f && f.type==="file") print(f.content);
        else print("cat: ファイルが存在しません","error");
        break;
      }
      case "write":{
        if(args.length<3) return print("write: ファイルと内容を指定","error");
        const node=getNode(cwd);
        if(!node.children[args[1]]) node.children[args]={type:"file",content:""};
        if(node.children[args].type!=="file") return print("write: ディレクトリです","error");
        node.children[args].content=args.slice(2).join(" "); saveVFS();
        break;
      }
      case "append":{
        if(args.length<3) return print("append: ファイルと内容を指定","error");
        const node=getNode(cwd);
        if(!node.children[args]) node.children[args]={type:"file",content:""};
        if(node.children[args].type!=="file") return print("append: ディレクトリです","error");
        node.children[args].content+=(node.children[args].content?"\n":"")+args.slice(2).join(" "); saveVFS();
        break;
      }
      case "rm":{
        if(!args) return print("rm: 対象指定必要","error");
        const node=getNode(cwd);
        if(node.children[args]) { delete node.children[args]; saveVFS();}
        else print("rm: 見つからない","error");
        break;
      }
      case "tree": print("/\n"+showTree(vfs," ")); break;
      case "clear": terminal.innerHTML=""; break;
      default: print("未知のコマンド: "+cmd,"error");
    }
  }

  // === 入力処理 ===
  input.addEventListener("keydown", e=>{
    if(e.key==="Enter"){ processCommand(input.value); input.value=""; e.preventDefault(); }
  });

  helpBtn.onclick=()=>overlay.classList.remove("hidden");
  closeBtn.onclick=()=>overlay.classList.add("hidden");
  overlay.addEventListener('click', e=>{ if(e.target===overlay) overlay.classList.add("hidden"); });

  print("=== Web CLI VFS版へようこそ ===");
  print("help でコマンド一覧(説明付き)を表示します");
});
</script>
</body>
</html>
