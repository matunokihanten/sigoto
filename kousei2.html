<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>🌟 Beautiful Structure Editor</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body { 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #333;
      line-height: 1.6;
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
    }

    .header {
      text-align: center;
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 2px solid #e9ecef;
    }

    .header h1 {
      font-size: 2.5rem;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 10px;
    }

    .header p {
      color: #6c757d;
      font-size: 1.1rem;
    }

    .main-content {
      display: grid;
      grid-template-columns: 300px 1fr;
      gap: 30px;
      align-items: start;
    }

    .sidebar {
      background: #f8f9fa;
      border-radius: 15px;
      padding: 20px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
      position: sticky;
      top: 20px;
      max-height: calc(100vh - 40px);
      overflow-y: auto;
    }

    .sidebar h3 {
      color: #495057;
      margin-bottom: 15px;
      font-size: 1.1rem;
      font-weight: 600;
    }

    .control-section {
      margin-bottom: 25px;
      padding-bottom: 20px;
      border-bottom: 1px solid #e9ecef;
    }

    .control-section:last-child {
      border-bottom: none;
      margin-bottom: 0;
    }

    .template-select {
      width: 100%;
      padding: 12px 15px;
      border: 2px solid #e9ecef;
      border-radius: 10px;
      background: white;
      font-size: 14px;
      margin-bottom: 15px;
      transition: all 0.3s ease;
    }

    .template-select:focus {
      border-color: #667eea;
      outline: none;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .btn-group {
      display: grid;
      gap: 8px;
      margin-bottom: 15px;
    }

    .btn {
      padding: 12px 16px;
      border: none;
      border-radius: 10px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      text-align: center;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
    }

    .btn:active {
      transform: translateY(0);
    }

    .btn:disabled {
      background: #dee2e6;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .btn-secondary {
      background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
    }

    .btn-success {
      background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
    }

    .btn-danger {
      background: linear-gradient(135deg, #dc3545 0%, #e83e8c 100%);
    }

    .btn-warning {
      background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%);
      color: #212529;
    }

    .color-picker {
      background: white;
      border: 2px solid #e9ecef;
      border-radius: 15px;
      padding: 15px;
      margin-bottom: 15px;
    }

    .color-picker h4 {
      margin-bottom: 12px;
      color: #495057;
      font-size: 0.95rem;
    }

    .color-options {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 8px;
    }

    .color-option {
      position: relative;
      cursor: pointer;
    }

    .color-option input[type="radio"] {
      position: absolute;
      opacity: 0;
      width: 100%;
      height: 100%;
      cursor: pointer;
    }

    .color-swatch {
      width: 40px;
      height: 40px;
      border-radius: 8px;
      border: 2px solid #dee2e6;
      transition: all 0.3s ease;
      position: relative;
    }

    .color-option input[type="radio"]:checked + .color-swatch {
      border-color: #667eea;
      transform: scale(1.1);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    }

    .color-option input[type="radio"]:checked + .color-swatch::after {
      content: "✓";
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: #667eea;
      font-weight: bold;
      font-size: 16px;
    }

    .tree-container {
      background: white;
      border-radius: 15px;
      padding: 25px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
      min-height: 500px;
    }

    #tree {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    li {
      margin: 8px 0;
      position: relative;
      transition: all 0.3s ease;
    }

    li::before {
      content: "";
      position: absolute;
      top: 20px;
      left: -15px;
      width: 15px;
      height: 1px;
      background: #dee2e6;
    }

    .children {
      border-left: 2px solid #e9ecef;
      margin-left: 15px;
      padding-left: 20px;
      position: relative;
    }

    .node, .node-input {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 12px 16px;
      border: 2px solid #e9ecef;
      border-radius: 12px;
      background: white;
      font-family: 'SF Mono', 'Monaco', 'Cascadia Code', monospace;
      font-size: 14px;
      transition: all 0.3s ease;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    .node {
      cursor: pointer;
      user-select: none;
    }

    .node:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
      border-color: #667eea;
    }

    .node.selected {
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
      transform: translateY(-2px);
    }

    .node-input {
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      outline: none;
    }

    .actions {
      margin-left: 12px;
      display: inline-flex;
      gap: 6px;
      flex-wrap: wrap;
    }

    .actions button {
      padding: 6px 10px;
      border: none;
      border-radius: 6px;
      background: #f8f9fa;
      color: #495057;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s ease;
      font-weight: 500;
    }

    .actions button:hover {
      background: #e9ecef;
      transform: translateY(-1px);
    }

    .actions button:active {
      transform: translateY(0);
    }

    /* Drag & Drop Styles */
    .dragging {
      opacity: 0.6;
      transform: rotate(5deg);
    }

    .drop-before {
      border-top: 3px solid #667eea !important;
      border-radius: 12px 12px 0 0;
    }

    .drop-after {
      border-bottom: 3px solid #667eea !important;
      border-radius: 0 0 12px 12px;
    }

    .over > .node {
      background: linear-gradient(135deg, #667eea20, #764ba220) !important;
      border-color: #667eea !important;
      transform: scale(1.05);
    }

    /* Modal Styles */
    #modal-bg {
      position: fixed;
      left: 0;
      top: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(5px);
      z-index: 1000;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    #modal {
      background: white;
      border-radius: 20px;
      padding: 30px;
      min-width: 500px;
      max-width: 80vw;
      max-height: 80vh;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
      overflow-y: auto;
    }

    #modal h3 {
      margin-bottom: 20px;
      color: #495057;
      font-size: 1.3rem;
    }

    #modal textarea {
      width: 100%;
      height: 400px;
      font-family: 'SF Mono', 'Monaco', 'Cascadia Code', monospace;
      font-size: 14px;
      border: 2px solid #e9ecef;
      border-radius: 12px;
      padding: 15px;
      resize: vertical;
      margin-bottom: 20px;
      transition: border-color 0.3s ease;
    }

    #modal textarea:focus {
      border-color: #667eea;
      outline: none;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .modal-btns {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
    }

    .favorites {
      background: white;
      border: 2px solid #e9ecef;
      border-radius: 15px;
      padding: 15px;
      margin-bottom: 15px;
    }

    .favorites h4 {
      margin-bottom: 12px;
      color: #495057;
      font-size: 0.95rem;
    }

    .fav-item {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      margin: 4px;
      background: #f8f9fa;
      border-radius: 8px;
      overflow: hidden;
    }

    .fav-item button {
      padding: 8px 12px;
      border: none;
      background: transparent;
      cursor: pointer;
      font-size: 13px;
      transition: background-color 0.2s ease;
    }

    .fav-item button:first-child {
      color: #495057;
    }

    .fav-item button:first-child:hover {
      background: #e9ecef;
    }

    .fav-item button:last-child {
      color: #dc3545;
      padding: 8px;
    }

    .fav-item button:last-child:hover {
      background: #f5c6cb;
    }

    #txt-preview {
      background: #f8f9fa;
      border: 2px solid #e9ecef;
      border-radius: 15px;
      padding: 20px;
      margin-top: 20px;
      font-family: 'SF Mono', 'Monaco', 'Cascadia Code', monospace;
      font-size: 14px;
      white-space: pre;
      overflow-x: auto;
      max-height: 400px;
      overflow-y: auto;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      .container {
        padding: 20px;
        margin: 10px;
      }

      .main-content {
        grid-template-columns: 1fr;
        gap: 20px;
      }

      .sidebar {
        position: static;
        max-height: none;
      }

      .header h1 {
        font-size: 2rem;
      }

      .color-options {
        grid-template-columns: repeat(8, 1fr);
      }

      .color-swatch {
        width: 30px;
        height: 30px;
      }
    }

    /* Hide for capture */
    body.hide-for-capture .actions {
      display: none !important;
    }

    /* Loading animation */
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .loading {
      animation: pulse 1.5s infinite;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>🌟 Beautiful Structure Editor</h1>
      <p>プロジェクト構造を視覚的に作成・編集できる高機能エディタ</p>
    </div>

    <div class="main-content">
      <div class="sidebar">
        <div class="control-section">
          <h3>📁 テンプレート</h3>
          <select id="templateSelect" class="template-select">
            <option value="empty">— 空 —</option>
            <option value="js">JavaScript プロジェクト</option>
            <option value="html">HTML ファイル構成</option>
          </select>
        </div>

        <div class="control-section">
          <h3>➕ 追加</h3>
          <div class="btn-group">
            <button id="addRootFolder" class="btn">📁 フォルダ</button>
            <button id="addRootFile" class="btn">📄 HTMLファイル</button>
            <button id="addRootTxt" class="btn">📝 テキストファイル</button>
          </div>
        </div>

        <div class="control-section">
          <h3>💾 保存・読込</h3>
          <div class="btn-group">
            <button id="saveCsv" class="btn btn-success">CSV保存</button>
            <button id="loadCsv" class="btn btn-success">CSV読込</button>
            <button id="saveAllBtn" class="btn btn-success">JSON保存</button>
            <button id="loadAllBtn" class="btn btn-success">JSON読込</button>
          </div>
        </div>

        <div class="control-section">
          <h3>📂 インポート・エクスポート</h3>
          <div class="btn-group">
            <button id="importFs" class="btn btn-warning">フォルダ読込</button>
            <button id="downloadZip" class="btn btn-warning">ZIP出力</button>
            <button id="downloadPng" class="btn btn-warning">PNG出力</button>
          </div>
        </div>

        <div class="control-section">
          <h3>🔄 編集</h3>
          <div class="btn-group">
            <button id="undoBtn" class="btn btn-secondary">↶ 元に戻す</button>
            <button id="redoBtn" class="btn btn-secondary">↷ やり直し</button>
            <button id="clearAllBtn" class="btn btn-danger">🗑️ 全削除</button>
          </div>
        </div>

        <div class="control-section">
          <h3>👁️ プレビュー</h3>
          <div class="btn-group">
            <button id="txtPreviewBtn" class="btn">📄 TXTプレビュー</button>
          </div>
        </div>

        <div class="control-section">
          <div class="color-picker">
            <h4>🎨 色選択</h4>
            <div class="color-options">
              <label class="color-option">
                <input type="radio" name="color" value="#FFFFFF" checked>
                <div class="color-swatch" style="background-color: #FFFFFF;"></div>
              </label>
              <label class="color-option">
                <input type="radio" name="color" value="#ffdddd">
                <div class="color-swatch" style="background-color: #ffdddd;"></div>
              </label>
              <label class="color-option">
                <input type="radio" name="color" value="#ddffdd">
                <div class="color-swatch" style="background-color: #ddffdd;"></div>
              </label>
              <label class="color-option">
                <input type="radio" name="color" value="#ddddff">
                <div class="color-swatch" style="background-color: #ddddff;"></div>
              </label>
              <label class="color-option">
                <input type="radio" name="color" value="#ffffdd">
                <div class="color-swatch" style="background-color: #ffffdd;"></div>
              </label>
              <label class="color-option">
                <input type="radio" name="color" value="#ffddff">
                <div class="color-swatch" style="background-color: #ffddff;"></div>
              </label>
              <label class="color-option">
                <input type="radio" name="color" value="#ddffff">
                <div class="color-swatch" style="background-color: #ddffff;"></div>
              </label>
              <label class="color-option">
                <input type="radio" name="color" value="#f0f0f0">
                <div class="color-swatch" style="background-color: #f0f0f0;"></div>
              </label>
            </div>
          </div>
        </div>

        <div class="control-section">
          <div class="favorites">
            <h4>⭐ お気に入り</h4>
            <div id="fav-list"></div>
            <button id="addFavBtn" class="btn" style="width: 100%; margin-top: 10px;">⭐ 現在の状態を保存</button>
          </div>
        </div>
      </div>

      <div class="tree-container">
        <ul id="tree"></ul>
        <div id="txt-preview" style="display:none"></div>
      </div>
    </div>
  </div>

  <div id="modal-bg">
    <div id="modal">
      <h3 id="modal-label"></h3>
      <textarea id="modal-text" placeholder="ファイルの内容を入力してください..."></textarea>
      <div class="modal-btns">
        <button id="modal-cancel" class="btn btn-secondary">キャンセル</button>
        <button id="modal-ok" class="btn">💾 保存</button>
      </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
  <script>
    //―― テンプレート ――
    const templates = {
      empty: ``,
      js: `
/my-app
├── src/
│   └── index.js
├── package.json
└── README.md`.trim(),
      html: `
/site
├── index.html
├── style.css
└── script.js`.trim()
    };

    //―― ユーティリティ ――
    let idCounter = 1;
    function genId() { return 'n'+(idCounter++); }
    function createNode(name, type, color = '#FFFFFF') {
        return { id: genId(), name, type, children: [], content: '', color: color };
    }
    function getFileTemplate(name){
      if(name.endsWith('.html')){
        const t=name.replace(/\.html$/,'');
        return `<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${t}</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f8f9fa;
        }
        .container {
            background: white;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>${t}</h1>
        <p>このページの内容をここに追加してください。</p>
    </div>
</body>
</html>`;
      }
      if(name.endsWith('.js')){
        return `// ${name}
console.log('Hello from ${name}');
`;
      }
      if(name.endsWith('.css')){
        return `/* ${name} */
body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    line-height: 1.6;
    color: #333;
}

.container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
}
`;
      }
      return '';
    }
    function getContrastYIQ(hexcolor){
        hexcolor = hexcolor.replace("#", "");
        var r = parseInt(hexcolor.substr(0,2),16);
        var g = parseInt(hexcolor.substr(2,2),16);
        var b = parseInt(hexcolor.substr(4,2),16);
        var yiq = ((r*299)+(g*587)+(b*114))/1000;
        return (yiq >= 128) ? 'black' : 'white';
    }

    //―― Undo/Redo用履歴管理 ――
    let history = [];
    let future = [];
    function saveHistory(){
      history.push(JSON.stringify(root));
      if(history.length>100) history.shift();
      future = [];
      updateUndoRedoBtn();
    }
    function undo(){
      if(history.length<=1) return;
      future.push(JSON.stringify(root));
      history.pop();
      root = JSON.parse(history[history.length-1]);
      idCounter = getMaxId(root)+1;
      selectedId = null;
      render();
      updateUndoRedoBtn();
    }
    function redo(){
      if(future.length===0) return;
      const nextState = future.pop();
      history.push(nextState);
      root = JSON.parse(nextState);
      idCounter = getMaxId(root)+1;
      selectedId = null;
      render();
      updateUndoRedoBtn();
    }
    function getMaxId(node){
        let max = 0;
        function walk(n){
            const num = parseInt(n.id.replace('n',''), 10);
            if(num > max) max = num;
            if(n.children) n.children.forEach(walk);
        }
        if(node.children) node.children.forEach(walk);
        return max;
    }
    function updateUndoRedoBtn(){
      document.getElementById('undoBtn').disabled = history.length <= 1;
      document.getElementById('redoBtn').disabled = future.length === 0;
    }

    //―― グローバル状態 ――
    let root = createNode('/', 'folder');
    let editingId = null;
    let selectedId = null;
    let draggedId = null;

    //―― テンプレート読み込み ――
    function loadTemplate(key){
      root = createNode('/', 'folder');
      idCounter = 1; editingId = null; selectedId = null;
      if(key!=='empty'){
        const lines=templates[key].split('\n'), stack=[];
        lines.forEach(raw=>{
          const depth=(raw.match(/^(\s*[│├└─]+)?/)?.[0]||'').replace(/[│├└─]/g,'').length/2;
          const txt=raw.replace(/^[\s│├└─]+/,'').trim();
          if(!txt) return;
          const isDir=txt.endsWith('/');
          const name=txt.replace(/\/$/,'');
          const node=createNode(name, isDir ? 'folder' : 'file');
          if(node.type === 'file' && node.content === '') {
            node.content = getFileTemplate(node.name);
          }
          while(stack.length > depth) stack.pop();
          const parent = stack[stack.length-1] || root;
          parent.children.push(node);
          if(isDir) stack.push(node);
        });
      }
      saveHistory();
      render();
    }

    //―― ファイル内容編集用（モーダル）
    let modalNode = null;
    function editFileContent(node) {
      modalNode = node;
      document.getElementById('modal-label').textContent = `「${node.name}」の内容を編集`;
      document.getElementById('modal-text').value = node.content || '';
      document.getElementById('modal-bg').style.display = 'flex';
      document.getElementById('modal-text').focus();
    }
    document.getElementById('modal-cancel').onclick = ()=>{
      document.getElementById('modal-bg').style.display = 'none';
      modalNode = null;
    };
    document.getElementById('modal-ok').onclick = ()=>{
      if(modalNode){
        modalNode.content = document.getElementById('modal-text').value;
        saveHistory();
        render();
      }
      document.getElementById('modal-bg').style.display = 'none';
      modalNode = null;
    };

    // Modal background click to close
    document.getElementById('modal-bg').onclick = (e) => {
      if (e.target === document.getElementById('modal-bg')) {
        document.getElementById('modal-bg').style.display = 'none';
        modalNode = null;
      }
    };

    //―― HTMLファイル実行用 ――
    function executeHtmlFile(node) {
        if (node.type === 'file' && node.name.endsWith('.html')) {
            const blob = new Blob([node.content], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            window.open(url, '_blank');
        } else {
            alert('これはHTMLファイルではありません。');
        }
    }

    //―― アイコン取得 ――
    function getFileIcon(name) {
      if (name.endsWith('.html')) return '🌐';
      if (name.endsWith('.css')) return '🎨';
      if (name.endsWith('.js')) return '⚡';
      if (name.endsWith('.json')) return '📋';
      if (name.endsWith('.md')) return '📝';
      if (name.endsWith('.txt')) return '📄';
      if (name.endsWith('.png') || name.endsWith('.jpg') || name.endsWith('.gif')) return '🖼️';
      return '📄';
    }

    //―― レンダリング ――
    function render(){
      const ul=document.getElementById('tree');
      ul.innerHTML='';
      function build(node, container){
        node.children.forEach((ch, idx)=>{
          const li=document.createElement('li');
          li.draggable=true;
          li.dataset.id=ch.id;
          li.dataset.parentId = node.id;

          if(ch.id===editingId){
            const inp=document.createElement('input');
            inp.value=ch.name; 
            inp.className='node-input';
            inp.onblur=()=>commitEdit(inp.value);
            inp.onkeydown=e=>{ if(e.key==='Enter') inp.blur(); };
            li.appendChild(inp);
            setTimeout(()=>inp.select(),0);
          } else {
            const sp=document.createElement('span');
            sp.className='node';
            if (ch.id === selectedId) {
                sp.classList.add('selected');
            }
            sp.style.backgroundColor = ch.color || '#FFFFFF';
            sp.style.color = getContrastYIQ(ch.color || '#FFFFFF');
            
            // Add icon and name
            const icon = ch.type === 'folder' ? '📁' : getFileIcon(ch.name);
            sp.innerHTML = `${icon} ${ch.name}${ch.type==='folder'?'/':''}`;
            
            sp.ondblclick=()=>{ editingId=ch.id; render(); };
            sp.onclick = (e) => {
                e.stopPropagation();
                selectedId = ch.id;
                const selectedNode = findNode(root, selectedId);
                const colorRadios = document.querySelectorAll('#color-picker input[name="color"]');
                colorRadios.forEach(radio => {
                    radio.checked = radio.value === (selectedNode.color || '#FFFFFF');
                });
                render();
            };
            li.appendChild(sp);
          }

          const act=document.createElement('span');
          act.className='actions';
          const btns=[
            {t:'✏️',fn:()=>{ editingId=ch.id; selectedId=null; render(); }, title:'名前を編集'},
            {t:'📁+',fn:()=>{ const newNode=createNode('新しいフォルダ','folder', ch.color); ch.children.push(newNode); saveHistory(); render(); },cond:ch.type==='folder', title:'フォルダを追加'},
            {t:'🌐+',fn:()=>{ const newNode=createNode('新しいファイル.html','file', ch.color); newNode.content = getFileTemplate(newNode.name); ch.children.push(newNode); saveHistory(); render(); },cond:ch.type==='folder', title:'HTMLファイルを追加'},
            {t:'📄+',fn:()=>{ const newNode=createNode('新しいファイル.txt','file', ch.color); ch.children.push(newNode); saveHistory(); render(); },cond:ch.type==='folder', title:'テキストファイルを追加'},
            {t:'❌',fn:()=>{ if(confirm(`「${ch.name}」を削除しますか？`)) { removeNode(root,ch.id); saveHistory(); render(); }}, title:'削除'},
            {t:'📝',fn:() => editFileContent(ch), cond:ch.type==='file', title:'内容を編集'},
            {t:'▶️',fn:() => executeHtmlFile(ch), cond:ch.type==='file' && ch.name.endsWith('.html'), title:'HTMLを実行'}
          ];
          btns.forEach(b=>{
            if(b.cond===false) return;
            const btn=document.createElement('button');
            btn.textContent=b.t; 
            btn.onclick=b.fn;
            btn.title=b.title;
            act.appendChild(btn);
          });
          li.appendChild(act);

          li.addEventListener('dragstart', onDragStart);
          li.addEventListener('dragover', onDragOver);
          li.addEventListener('dragleave', onDragLeave);
          li.addEventListener('drop', onDrop);
          li.addEventListener('dragend', onDragEnd);

          container.appendChild(li);
          if(ch.type==='folder'){
            const sub=document.createElement('ul');
            sub.className='children';
            li.appendChild(sub);
            build(ch,sub);
          }
        });
      }
      build(root,ul);
      updateUndoRedoBtn();
      renderFavList();
    }

    function commitEdit(val){
      if(val.trim()) {
        const node = findNode(root, editingId);
        const oldName = node.name;
        node.name = val.trim();
        
        // If it's a file and the extension changed, update template
        if(node.type === 'file' && !node.content && oldName !== node.name) {
          node.content = getFileTemplate(node.name);
        }
      }
      editingId=null; 
      saveHistory(); 
      render();
    }

    function removeNode(p,id){
        for (let i = 0; i < p.children.length; i++) {
            if (p.children[i].id === id) {
                p.children.splice(i, 1);
                return true;
            }
            if (removeNode(p.children[i], id)) {
                return true;
            }
        }
        return false;
    }

    function findNode(p,id){
      if(p.id===id) return p;
      for(const c of p.children){ const r=findNode(c,id); if(r) return r; }
      return null;
    }
    function findParent(p,id){
      for(const c of p.children){
        if(c.id===id) return p;
        const r=findParent(c,id);
        if(r) return r;
      }
      return null;
    }

    //―― Drag & Drop ――
    let dropPosition = 'inside';

    function onDragStart(e) {
        draggedId = e.currentTarget.dataset.id;
        e.dataTransfer.effectAllowed = 'move';
        e.currentTarget.classList.add('dragging');
    }

    function onDragOver(e) {
        e.preventDefault();
        const targetLi = e.currentTarget;
        const targetNode = findNode(root, targetLi.dataset.id);
        const draggedNode = findNode(root, draggedId);

        document.querySelectorAll('#tree li.over, #tree li.drop-before, #tree li.drop-after').forEach(li => {
            li.classList.remove('over', 'drop-before', 'drop-after');
        });

        if (!targetNode || !draggedNode || draggedId === targetLi.dataset.id) {
            e.dataTransfer.dropEffect = 'none';
            return;
        }

        let current = targetNode;
        while(current) {
            if (current.id === draggedId) {
                e.dataTransfer.dropEffect = 'none';
                return;
            }
            current = findParent(root, current.id);
        }
        e.dataTransfer.dropEffect = 'move';

        const rect = targetLi.getBoundingClientRect();
        const y = e.clientY - rect.top;
        const third = rect.height / 3;

        if (targetNode.type === 'folder') {
            if (y < third) {
                dropPosition = 'before';
                targetLi.classList.add('drop-before');
            } else if (y > third * 2) {
                dropPosition = 'after';
                targetLi.classList.add('drop-after');
            } else {
                dropPosition = 'inside';
                targetLi.classList.add('over');
            }
        } else {
            if (y < rect.height / 2) {
                dropPosition = 'before';
                targetLi.classList.add('drop-before');
            } else {
                dropPosition = 'after';
                targetLi.classList.add('drop-after');
            }
        }
    }

    function onDragLeave(e) {
        e.currentTarget.classList.remove('over', 'drop-before', 'drop-after');
    }

    function onDrop(e) {
        e.preventDefault();
        e.stopPropagation();
        
        document.querySelectorAll('#tree li.dragging, #tree li.over, #tree li.drop-before, #tree li.drop-after').forEach(li => {
            li.classList.remove('dragging', 'over', 'drop-before', 'drop-after');
        });

        const targetId = e.currentTarget.dataset.id;
        if (draggedId === targetId) return;

        const draggedNode = findNode(root, draggedId);
        if (!draggedNode) return;

        const sourceParent = findParent(root, draggedId);
        if (sourceParent) {
            removeNode(sourceParent, draggedId);
        } else {
            console.error("Dragged node's parent not found.");
            draggedId = null;
            return;
        }

        const targetNode = findNode(root, targetId);
        if (!targetNode) return;

        if (dropPosition === 'inside' && targetNode.type === 'folder') {
            targetNode.children.push(draggedNode);
        } else {
            const targetParent = findParent(root, targetId);
            const parentToInsertInto = targetParent || root;
            const targetIndex = parentToInsertInto.children.findIndex(c => c.id === targetId);

            if (targetIndex > -1) {
                if (dropPosition === 'before') {
                    parentToInsertInto.children.splice(targetIndex, 0, draggedNode);
                } else {
                    parentToInsertInto.children.splice(targetIndex + 1, 0, draggedNode);
                }
            } else {
                parentToInsertInto.children.push(draggedNode);
            }
        }

        draggedId = null;
        saveHistory();
        render();
    }

    function onDragEnd(e) {
        document.querySelectorAll('#tree li.dragging, #tree li.over, #tree li.drop-before, #tree li.drop-after').forEach(li => {
            li.classList.remove('dragging', 'over', 'drop-before', 'drop-after');
        });
        draggedId = null;
    }

    //―― CSV 保存/読込 ――
    function treeToCsv(){
      const rows=[['path','type','content','color']];
      (function w(n,p){
        n.children.forEach(c=>{
          const path=p+'/'+c.name;
          rows.push([path,c.type,c.type==='file'?btoa(unescape(encodeURIComponent(c.content||''))):'', c.color || '#FFFFFF']);
          if(c.type==='folder') w(c,path);
        });
      })(root,'');
      return rows.map(r=>r.map(x=>`"${(x||'').replace(/"/g,'""')}"`).join(',')).join('\n');
    }
    document.getElementById('saveCsv').onclick = () => {
      const bom = new Uint8Array([0xEF, 0xBB, 0xBF]);
      const csv = treeToCsv();
      const blob = new Blob([bom, csv], {type:'text/csv'});
      const a=document.createElement('a');
      a.href=URL.createObjectURL(blob);
      a.download='structure.csv';
      a.click();
    };
    document.getElementById('loadCsv').onclick = async () => {
      try {
        const [f]=await window.showOpenFilePicker({types:[{accept:{'text/csv':['.csv']}}]});
        const txt=await (await f.getFile()).text();
        const lines=txt.split('\n').filter(l=>l.trim());
        root=createNode('/','folder'); idCounter = 1;
        lines.slice(1).forEach(l=>{
          const parts = [];
          let inQuote = false;
          let currentPart = '';
          for (let i = 0; i < l.length; i++) {
              const char = l[i];
              if (char === '"') {
                  if (i + 1 < l.length && l[i+1] === '"') {
                      currentPart += '"';
                      i++;
                  } else {
                      inQuote = !inQuote;
                  }
              } else if (char === ',' && !inQuote) {
                  parts.push(currentPart);
                  currentPart = '';
              } else {
                  currentPart += char;
              }
          }
          parts.push(currentPart);

          if (parts.length < 2) return;
          const [path, type, contentStr, color] = parts;
          const content = (contentStr && type === 'file') ? decodeURIComponent(escape(atob(contentStr))) : '';
          const seg=path.split('/').filter(Boolean);
          let p=root;
          seg.forEach((n,i)=>{
            const last=i===seg.length-1;
            const nodeType = last ? type : 'folder';
            let d=p.children.find(c=>c.name===n&&c.type===nodeType);
            if(!d){
               d=createNode(n, nodeType, color);
               if(last && type === 'file') d.content = content;
               p.children.push(d);
            }
            p=d;
          });
        });
        saveHistory();
        render();
      } catch (e) {
        if(e.name !== 'AbortError') alert('CSVファイルの読み込みに失敗しました。');
      }
    };

    //―― フォルダから読込 ――
    document.getElementById('importFs').onclick = async () => {
      try {
        const dh=await window.showDirectoryPicker();
        idCounter=1; root=createNode('/','folder');
        await readFsRecursive(dh, root);
        saveHistory();
        render();
      } catch (e) {
        if(e.name !== 'AbortError') alert('フォルダの読み込みに失敗しました。');
      }
    };
    async function readFsRecursive(dh, parentNode){
      for await(const [name,ent] of dh.entries()){
        if(ent.kind==='directory') {
          const folderNode = createNode(name,'folder');
          parentNode.children.push(folderNode);
          await readFsRecursive(ent, folderNode);
        } else {
          const fileNode = createNode(name,'file');
          parentNode.children.push(fileNode);
          try {
            const file = await ent.getFile();
            if (file.size < 1024 * 1024) { // Only read files smaller than 1MB
              fileNode.content = await file.text();
            } else {
              fileNode.content = `[Large file: ${(file.size / 1024 / 1024).toFixed(2)}MB - Content not loaded]`;
            }
          } catch (e) { 
            fileNode.content = `[Error reading file: ${e.message}]`; 
          }
        }
      }
    }

    //―― ZIP 出力 ――
    document.getElementById('downloadZip').onclick = () => {
      const zip=new JSZip();
      (function add(n, f){
        n.children.forEach(c => {
          if(c.type==='folder') {
            add(c, f.folder(c.name));
          } else {
            f.file(c.name, c.content ?? getFileTemplate(c.name));
          }
        });
      })(root, zip);
      zip.generateAsync({type:'blob'}).then(b=>{
        const a=document.createElement('a');
        a.href=URL.createObjectURL(b); a.download='structure.zip';
        a.click();
      });
    };

    //―― PNG画像でダウンロード ――
    document.getElementById('downloadPng').onclick = () => {
      document.body.classList.add('hide-for-capture');
      
      const treeContainer = document.querySelector('.tree-container');
      const originalBackground = treeContainer.style.background;
      treeContainer.style.background = 'white';

      html2canvas(treeContainer, {
          scale: 3,
          logging: false,
          useCORS: true,
          backgroundColor: 'white',
          width: treeContainer.scrollWidth,
          height: treeContainer.scrollHeight,
      }).then(canvas => {
          const a = document.createElement('a');
          a.href = canvas.toDataURL('image/png');
          a.download = 'structure.png';
          a.click();
      }).finally(() => {
          document.body.classList.remove('hide-for-capture');
          treeContainer.style.background = originalBackground;
      });
    };

    //―― TXTプレビュー ――
    document.getElementById('txtPreviewBtn').onclick=()=>{
      let txt = '';
      function walk(n, prefix=''){
        n.children.forEach(c=>{
          txt += prefix + (c.type==='folder'?'📁':'📄') + ' ' + c.name + (c.type==='folder'?'/':'') + '\n';
          if(c.type==='file' && c.content){
            const lines = c.content.split(/\r?\n/);
            const previewLines = lines.slice(0, 10); // Show first 10 lines
            txt += previewLines.map(line=>'  │ '+line).join('\n');
            if(lines.length > 10) {
              txt += `\n  │ ... (${lines.length - 10} more lines)`;
            }
            txt += '\n\n';
          }
          if(c.type==='folder') walk(c, prefix+'  ');
        });
      }
      walk(root);
      const preview = document.getElementById('txt-preview');
      preview.textContent = txt;
      preview.style.display = preview.style.display === 'none' ? 'block' : 'none';
    };

    //―― 完全保存・読込（JSON）――
    document.getElementById('saveAllBtn').onclick=()=>{
      const blob = new Blob([JSON.stringify(root, null, 2)], {type:'application/json'});
      const a=document.createElement('a');
      a.href=URL.createObjectURL(blob); a.download='structure.json';
      a.click();
    };
    document.getElementById('loadAllBtn').onclick=async()=>{
      try {
        const [f]=await window.showOpenFilePicker({types:[{accept:{'application/json':['.json']}}]});
        const txt=await (await f.getFile()).text();
        root=JSON.parse(txt);
        idCounter = getMaxId(root)+1;
        saveHistory();
        render();
      } catch (e) {
        if(e.name !== 'AbortError') alert('JSONファイルの読み込みに失敗しました。');
      }
    };

    //―― お気に入りテンプレート保存・呼び出し ――
    function renderFavList(){
      const favDiv = document.getElementById('fav-list');
      const favs = JSON.parse(localStorage.getItem('favTemplates')||'[]');
      
      if(favs.length === 0) {
        favDiv.innerHTML = '<p style="color: #6c757d; font-style: italic; margin: 0;">お気に入りはありません</p>';
        return;
      }

      favDiv.innerHTML = '';
      favs.forEach((f,i)=>{
        const item = document.createElement('div');
        item.className = 'fav-item';
        
        const loadBtn = document.createElement('button');
        loadBtn.textContent = f.name;
        loadBtn.onclick = ()=>{ 
          if(confirm(`「${f.name}」を読み込みますか？現在の内容は失われます。`)) {
            root = JSON.parse(f.data); 
            idCounter = getMaxId(root)+1; 
            saveHistory(); 
            render(); 
          }
        };
        
        const deleteBtn = document.createElement('button');
        deleteBtn.textContent = '✕'; 
        deleteBtn.onclick = (e) => {
            e.stopPropagation();
            if (confirm(`「${f.name}」を削除しますか？`)) { 
              removeFav(i); 
            }
        };
        
        item.appendChild(loadBtn);
        item.appendChild(deleteBtn);
        favDiv.appendChild(item);
      });
    }

    function removeFav(index){
        const favs = JSON.parse(localStorage.getItem('favTemplates')||'[]');
        favs.splice(index, 1);
        localStorage.setItem('favTemplates', JSON.stringify(favs));
        renderFavList();
    }

    document.getElementById('addFavBtn').onclick=()=>{
      const name = prompt('お気に入り名を入力してください:');
      if(!name || !name.trim()) return;
      const favs = JSON.parse(localStorage.getItem('favTemplates')||'[]');
      favs.push({name: name.trim(), data: JSON.stringify(root)});
      localStorage.setItem('favTemplates', JSON.stringify(favs));
      renderFavList();
    };

    //―― 全て削除ボタン ――
    document.getElementById('clearAllBtn').onclick = () => {
        if (confirm('本当にすべて削除しますか？この操作は元に戻せません。')) {
            root = createNode('/', 'folder'); 
            idCounter = 1;
            selectedId = null;
            saveHistory(); 
            render();
        }
    };

    // 再帰的に子ノードの色を更新する関数
    function updateChildrenColor(node, newColor) {
        node.children.forEach(child => {
            child.color = newColor;
            if (child.type === 'folder') {
                updateChildrenColor(child, newColor);
            }
        });
    }

    //―― イベントバインド & 初期化 ――
    document.getElementById('templateSelect').onchange=e=>loadTemplate(e.target.value);
    document.getElementById('addRootFolder').onclick=()=>{ 
      root.children.push(createNode('新しいフォルダ','folder')); 
      saveHistory(); 
      render(); 
    };
    document.getElementById('addRootFile').onclick=()=>{ 
      const newNode = createNode('新しいファイル.html','file');
      newNode.content = getFileTemplate(newNode.name);
      root.children.push(newNode); 
      saveHistory(); 
      render(); 
    };
    document.getElementById('addRootTxt').onclick=()=>{ 
      root.children.push(createNode('新しいファイル.txt','file')); 
      saveHistory(); 
      render(); 
    };
    document.getElementById('undoBtn').onclick=undo;
    document.getElementById('redoBtn').onclick=redo;

    document.querySelectorAll('#color-picker input[name="color"]').forEach(radio => {
        radio.addEventListener('change', (e) => {
            if (selectedId) {
                const node = findNode(root, selectedId);
                if (node) {
                    node.color = e.target.value;
                    if (node.type === 'folder') {
                        updateChildrenColor(node, e.target.value);
                    }
                    saveHistory();
                    render();
                }
            }
        });
    });

    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
      if (e.ctrlKey || e.metaKey) {
        switch(e.key) {
          case 'z':
            e.preventDefault();
            if (e.shiftKey) {
              redo();
            } else {
              undo();
            }
            break;
          case 's':
            e.preventDefault();
            document.getElementById('saveAllBtn').click();
            break;
        }
      }
    });

    // Click outside to deselect
    document.addEventListener('click', (e) => {
      if (!e.target.closest('#tree') && !e.target.closest('.sidebar')) {
        selectedId = null;
        render();
      }
    });

    // Initial Load
    saveHistory();
    render();

    // Welcome message
    setTimeout(() => {
      if (root.children.length === 0) {
        const welcome = confirm(
          '🌟 Beautiful Structure Editor へようこそ！\n\n' +
          '左のサイドバーからテンプレートを選択するか、\n' +
          '「フォルダ」ボタンでプロジェクト構造を作成してみませんか？\n\n' +
          'JavaScriptプロジェクトのテンプレートを読み込みますか？'
        );
        if (welcome) {
          loadTemplate('js');
        }
      }
    }, 1000);
  </script>
</body>
</html>
