<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>è±ªè¯HTMLã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/theme/material-darker.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/search/matchesonscrollbar.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/dialog/dialog.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <style>
    :root {
      --button-columns: 4;
      --button-gap: 8px;
    }
    body {
      margin: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      display: flex;
      flex-direction: column;
      height: 100vh;
      background-color: #263238;
      color: #ECEFF1;
      padding-top: env(safe-area-inset-top);
      padding-bottom: env(safe-area-inset-bottom);
      padding-left: env(safe-area-inset-left);
      padding-right: env(safe-area-inset-right);
    }
    .controls {
      padding: 10px;
      background-color: #37474F;
      display: flex;
      flex-wrap: wrap;
      gap: 5px; /* ãƒœã‚¿ãƒ³é–“ã®éš™é–“ã‚’å°ã•ã */
      position: relative;
      z-index: 10;
      box-shadow: 0 4px 8px rgba(0,0,0,0.3);
      border-bottom: 1px solid #455A64;
      align-items: center;
    }
    .controls button {
      flex: 1 1 auto;
      padding: 5px 8px; /* ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’å°ã•ã */
      cursor: pointer;
      border: none;
      border-radius: 4px;
      background-color: #546E7A;
      color: #ECEFF1;
      font-size: 0.8em;
      font-weight: 600;
      transition: background-color 0.2s ease, transform 0.2s ease, box-shadow 0.2s ease;
      box-shadow: 0 1px 2px rgba(0,0,0,0.2);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 4px; /* ã‚¢ã‚¤ã‚³ãƒ³ã¨æ–‡å­—ã®éš™é–“ã‚’å°ã•ã */
    }
    .controls button:hover {
      background-color: #607D8B;
      transform: translateY(-2px);
      box-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }
    .controls button:active {
      transform: translateY(0);
      box-shadow: 0 1px 2px rgba(0,0,0,0.2);
    }
    .controls button i {
      font-size: 1em; /* ã‚¢ã‚¤ã‚³ãƒ³ã‚µã‚¤ã‚ºã‚’èª¿æ•´ */
    }
    .controls button#runBtn {
        background-color: #00A381;
        flex-grow: 1;
        font-size: 1.2em;
        font-weight: bold;
        min-width: unset;
        width: 100%;
    }
    .controls button#saveFavoriteBtn {
        background-color: #FFC107;
    }
    .controls button#showFavoritesBtn {
        background-color: #FF9800;
    }
    .controls button#clearAllBtn {
        background-color: #D32F2F;
    }
    /* è¿½åŠ ã—ãŸè‰²ä»˜ã‘ */
    .controls button#copyBtn {
        background-color: #2196F3; /* é’è‰² */
    }
    .controls button#pasteBtn {
        background-color: #9C27B0; /* ç´«è‰² */
    }
    .controls button#runBtn:hover {
        background-color: #00b894;
        transform: translateY(-3px);
    }
    .controls button#saveFavoriteBtn:hover {
        background-color: #ffca28;
    }
    .controls button#showFavoritesBtn:hover {
        background-color: #ffb300;
    }
    .controls button#clearAllBtn:hover {
        background-color: #e53935;
    }
    .controls button#copyBtn:hover {
        background-color: #42a5f5;
    }
    .controls button#pasteBtn:hover {
        background-color: #ab47bc;
    }
    .column-selector {
      display: none;
    }
    .editor {
      flex: 1;
      overflow: hidden;
    }
    .CodeMirror {
      height: 100%;
      border: none;
      font-size: 16px;
      line-height: 1.5;
    }
    .CodeMirror-matchingtag {
      background-color: rgba(255, 255, 0, 0.4);
      outline: 1px solid rgba(255, 255, 0, 0.6);
    }
    .CodeMirror-foldmarker {
      color: #90A4AE;
      background-color: #455A64;
      font-weight: bold;
      border-radius: 2px;
    }
    #messageArea {
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      padding: 10px 20px;
      font-size: 0.9em;
      white-space: nowrap;
      background-color: rgba(0, 0, 0, 0.85);
      color: white;
      border-radius: 8px;
      opacity: 0;
      transition: opacity 0.4s ease-out, transform 0.4s ease-out, background-color 0.4s ease;
      z-index: 100;
      pointer-events: none;
      box-shadow: 0 4px 12px rgba(0,0,0,0.4);
    }
    #messageArea.show {
        opacity: 1;
        transform: translateY(-50%) translateX(0);
    }
    #messageArea:not(.show) {
        transform: translateY(-50%) translateX(20px);
    }
    #messageArea.success {
        background-color: #4CAF50;
    }
    #messageArea.error {
        background-color: #F44336;
    }
    #messageArea.info {
        background-color: #2196F3;
    }
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0, 0, 0, 0.7);
      padding-top: 60px;
    }
    .modal-content {
      background-color: #37474F;
      margin: 5% auto;
      padding: 20px;
      border: 1px solid #888;
      width: 90%;
      max-width: 600px;
      border-radius: 10px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.5);
      color: #ECEFF1;
      position: relative;
    }
    .close-button {
      color: #aaa;
      position: absolute;
      top: 10px;
      right: 20px;
      font-size: 28px;
      font-weight: bold;
    }
    .close-button:hover, .close-button:focus {
      color: #fff;
      text-decoration: none;
      cursor: pointer;
    }
    .modal-content h2 {
      margin-top: 0;
      border-bottom: 1px solid #455A64;
      padding-bottom: 10px;
    }
    #favoritesList, #helpContent {
      list-style-type: none;
      padding: 0;
    }
    #favoritesList li {
      padding: 12px;
      border-bottom: 1px solid #455A64;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: background-color 0.2s;
    }
    #favoritesList li:hover {
      background-color: #455A64;
    }
    #favoritesList .favorite-info {
      cursor: pointer;
      flex-grow: 1;
    }
    #favoritesList .favorite-title {
      font-weight: bold;
      font-size: 1.1em;
    }
    #favoritesList .favorite-date {
      font-size: 0.8em;
      color: #B0BEC5;
    }
    #favoritesList .delete-btn {
      background-color: #D32F2F;
      color: white;
      border: none;
      padding: 5px 10px;
      border-radius: 5px;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    #favoritesList .delete-btn:hover {
      background-color: #e53935;
    }
    @media (max-width: 768px) {
      .controls {
        padding-top: calc(10px + env(safe-area-inset-top, 0px));
        padding-bottom: 10px;
      }
      .controls .button-row {
        display: flex;
        flex-wrap: wrap;
        gap: 5px;
        width: 100%;
      }
      .controls button {
        flex: 1 1 auto;
        padding: 5px;
        font-size: 0.7em;
        text-align: center;
        flex-direction: column;
        justify-content: center;
        min-width: 60px;
      }
      .controls button i {
        font-size: 1.2em;
        margin-bottom: 2px;
      }
      .controls button#runBtn {
        flex-grow: 1;
        width: 100%;
        font-size: 1.1em;
        padding: 10px;
        flex-direction: row;
        gap: 8px;
      }
      .column-selector {
        display: none;
      }
      #messageArea {
        top: calc(70px + env(safe-area-inset-top, 0px));
        transform: translateY(0);
        left: 50%;
        transform: translateX(-50%);
        white-space: normal;
        text-align: center;
        width: 80%;
      }
      #messageArea.show {
        transform: translateY(0) translateX(-50%);
      }
      #messageArea:not(.show) {
        transform: translateY(0) translateX(-50%) translateY(-20px);
      }
      .modal-content {
        width: 95%;
        margin: 5% auto;
      }
    }
  </style>
</head>
<body>
  <div class="controls">
    <div id="messageArea"></div>
    <button id="runBtn"><i class="fas fa-play"></i> å®Ÿè¡Œ</button>
    <div class="button-row">
      <button id="saveFavoriteBtn"><i class="fas fa-star"></i> ãŠæ°—ã«å…¥ã‚Š</button>
      <button id="showFavoritesBtn"><i class="fas fa-list"></i> ä¸€è¦§</button>
      <button id="selectAllBtn"><i class="fas fa-border-all"></i> å…¨é¸æŠ</button>
      <button id="deselectAllBtn"><i class="far fa-circle"></i> é¸æŠè§£é™¤</button>
      <button id="copyBtn"><i class="fas fa-copy"></i> ã‚³ãƒ”ãƒ¼</button>
      <button id="pasteBtn"><i class="fas fa-paste"></i> è²¼ä»˜ã‘</button>
      <button id="clearAllBtn"><i class="fas fa-trash-alt"></i> å…¨å‰Šé™¤</button>
      <button id="undoBtn"><i class="fas fa-undo"></i> æˆ»ã™</button>
      <button id="redoBtn"><i class="fas fa-redo"></i> é€²ã‚€</button>
      <button id="openFileBtn"><i class="fas fa-folder-open"></i> é–‹ã</button>
      <input type="file" id="fileInput" accept=".html,.css,.js,.txt,.xml" style="display:none">
      <button id="saveBtn"><i class="fas fa-save"></i> ä¿å­˜</button>
      <button id="scrollToCursorBtn"><i class="fas fa-location-arrow"></i> ã‚«ãƒ¼ã‚½ãƒ«</button>
      <button id="findBtn"><i class="fas fa-search"></i> æ¤œç´¢</button>
      <button id="replaceBtn"><i class="fas fa-exchange-alt"></i> ç½®æ›</button>
      <button id="commentBtn"><i class="fas fa-comment"></i> ã‚³ãƒ¡ãƒ³ãƒˆ</button>
      <button id="helpBtn"><i class="fas fa-question-circle"></i> ãƒ˜ãƒ«ãƒ—</button>
    </div>

    <div class="column-selector">
      <label>
        <input type="radio" name="columnCount" value="1" id="columns1"> 1åˆ—
      </label>
      <label>
        <input type="radio" name="columnCount" value="2" id="columns2"> 2åˆ—
      </label>
      <label>
        <input type="radio" name="columnCount" value="4" id="columns4" checked> 4åˆ—
      </label>
    </div>
  </div>

  <div class="editor">
    <textarea id="htmlCode" placeholder="ã“ã“ã«HTMLã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"></textarea>
  </div>

  <div id="favoritesModal" class="modal">
    <div class="modal-content">
      <span class="close-button">&times;</span>
      <h2>ãŠæ°—ã«å…¥ã‚Šä¸€è¦§ â­ï¸</h2>
      <ul id="favoritesList">
      </ul>
    </div>
  </div>

  <div id="helpModal" class="modal">
    <div class="modal-content">
      <span class="close-button">&times;</span>
      <h2>ãƒ˜ãƒ«ãƒ— & ä½¿ã„æ–¹ ğŸ’¡</h2>
      <div id="helpContent">
        <p>ã“ã®ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼ã¯ã€ã‚¦ã‚§ãƒ–é–‹ç™ºã®ãŸã‚ã®å¤šæ©Ÿèƒ½ãƒ„ãƒ¼ãƒ«ã§ã™ã€‚ä»¥ä¸‹ã«ä¸»ãªä½¿ã„æ–¹ã‚’ã¾ã¨ã‚ã¾ã—ãŸã€‚</p>
        <h3>åŸºæœ¬æ“ä½œ</h3>
        <ul>
          <li><strong>å®Ÿè¡Œ</strong>: ç¾åœ¨ã®ã‚³ãƒ¼ãƒ‰ã‚’æ–°ã—ã„ã‚¿ãƒ–ã§è¡¨ç¤ºã—ã¾ã™ã€‚</li>
          <li><strong>ãŠæ°—ã«å…¥ã‚Š</strong>: ç¾åœ¨ã®ã‚³ãƒ¼ãƒ‰ã‚’åå‰ã‚’ä»˜ã‘ã¦ä¿å­˜ã—ã¾ã™ã€‚</li>
          <li><strong>ä¸€è¦§</strong>: ä¿å­˜ã—ãŸã‚³ãƒ¼ãƒ‰ã®ãƒªã‚¹ãƒˆã‚’è¡¨ç¤ºãƒ»èª­ã¿è¾¼ã¿ãƒ»å‰Šé™¤ã—ã¾ã™ã€‚</li>
          <li><strong>ã‚³ãƒ”ãƒ¼/è²¼ä»˜ã‘</strong>: ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼å†…ã®ã‚³ãƒ¼ãƒ‰ã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼/è²¼ä»˜ã‘ã—ã¾ã™ã€‚</li>
          <li><strong>å…¨å‰Šé™¤</strong>: ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼å†…ã®ã‚³ãƒ¼ãƒ‰ã‚’ã™ã¹ã¦æ¶ˆå»ã—ã¾ã™ã€‚</li>
          <li><strong>ä¿å­˜</strong>: ç¾åœ¨ã®ã‚³ãƒ¼ãƒ‰ã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã€‚</li>
        </ul>
        <h3>ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼æ©Ÿèƒ½</h3>
        <ul>
          <li><strong>è¡Œç•ªå·/ã‚·ãƒ³ã‚¿ãƒƒã‚¯ã‚¹ãƒã‚¤ãƒ©ã‚¤ãƒˆ</strong>: ã‚³ãƒ¼ãƒ‰ã®ç¨®é¡ã«å¿œã˜ã¦è‰²åˆ†ã‘è¡¨ç¤ºã—ã¾ã™ã€‚</li>
          <li><strong>ã‚³ãƒ¼ãƒ‰ã®æŠ˜ã‚ŠãŸãŸã¿</strong>: å¤§é‡ã®ã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆã«è¡¨ç¤ºã—ã¾ã™ã€‚</li>
          <li><strong>ã‚«ãƒ¼ã‚½ãƒ«</strong>: ç”»é¢ãŒã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã—ã¦ã„ã¦ã‚‚ã€ã‚«ãƒ¼ã‚½ãƒ«ã®ä½ç½®ã¾ã§è‡ªå‹•ã§ç§»å‹•ã—ã¾ã™ã€‚</li>
          <li><strong>æ¤œç´¢/ç½®æ›</strong>: ã‚³ãƒ¼ãƒ‰å†…ã®æ–‡å­—åˆ—ã‚’æ¤œç´¢ã—ãŸã‚Šã€ç½®ãæ›ãˆãŸã‚Šã§ãã¾ã™ã€‚</li>
          <li><strong>ã‚³ãƒ¡ãƒ³ãƒˆ</strong>: é¸æŠç¯„å›²ã‚„ã‚«ãƒ¼ã‚½ãƒ«è¡Œã‚’ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆ/ã‚¢ãƒ³ã‚³ãƒ¡ãƒ³ãƒˆã—ã¾ã™ã€‚</li>
        </ul>
      </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/htmlmixed/htmlmixed.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/xml/xml.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/javascript/javascript.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/css/css.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/edit/closetag.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/edit/matchbrackets.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/edit/matchtags.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/selection/active-line.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/search/search.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/search/searchcursor.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/dialog/dialog.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/search/jump-to-line.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/search/match-highlighter.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/edit/comment.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/fold/foldcode.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/fold/foldgutter.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/fold/xml-fold.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/fold/foldgutter.min.css">

  <script>
    var cm = CodeMirror.fromTextArea(document.getElementById('htmlCode'), {
      mode: "htmlmixed",
      lineNumbers: true,
      theme: "material-darker",
      autoCloseTags: true,
      matchBrackets: true,
      matchTags: { bothTags: true },
      styleActiveLine: true,
      highlightSelectionMatches: {showToken: /\w/, annotateScrollbar: true},
      extraKeys: {
        "Ctrl-Q": function(cm){ cm.foldCode(cm.getCursor()); },
        "Ctrl-/": "toggleComment"
      },
      foldGutter: true,
      gutters: ["CodeMirror-linenumbers", "CodeMirror-foldgutter"]
    });

    setTimeout(() => {
      cm.refresh();
    }, 100);

    const STORAGE_KEY_FAVORITES = "advancedEditorFavorites";
    const STORAGE_KEY_CODE = "advancedEditorCode";
    const STORAGE_KEY_COLUMNS = "advancedEditorColumns";
    let autoSaveTimer;

    const controlsDiv = document.querySelector('.controls');
    const selectAllBtn = document.getElementById('selectAllBtn');
    const deselectAllBtn = document.getElementById('deselectAllBtn');
    const copyBtn = document.getElementById('copyBtn');
    const pasteBtn = document.getElementById('pasteBtn');
    const clearAllBtn = document.getElementById('clearAllBtn');
    const undoBtn = document.getElementById('undoBtn');
    const redoBtn = document.getElementById('redoBtn');
    const openFileBtn = document.getElementById('openFileBtn');
    const fileInput = document.getElementById('fileInput');
    const saveBtn = document.getElementById('saveBtn');
    const runBtn = document.getElementById('runBtn');
    const scrollToCursorBtn = document.getElementById('scrollToCursorBtn');
    const findBtn = document.getElementById('findBtn');
    const replaceBtn = document.getElementById('replaceBtn');
    const commentBtn = document.getElementById('commentBtn');
    const saveFavoriteBtn = document.getElementById('saveFavoriteBtn');
    const showFavoritesBtn = document.getElementById('showFavoritesBtn');
    const helpBtn = document.getElementById('helpBtn');
    const messageArea = document.getElementById('messageArea');
    const columnRadios = document.querySelectorAll('input[name="columnCount"]');
    const root = document.documentElement;

    const favoritesModal = document.getElementById('favoritesModal');
    const favoritesList = document.getElementById('favoritesList');
    const helpModal = document.getElementById('helpModal');
    const closeModalButtons = document.querySelectorAll('.close-button');

    closeModalButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        favoritesModal.style.display = 'none';
        helpModal.style.display = 'none';
      });
    });

    window.addEventListener('click', (event) => {
      if (event.target === favoritesModal) {
        favoritesModal.style.display = 'none';
      }
      if (event.target === helpModal) {
        helpModal.style.display = 'none';
      }
    });

    function showMessage(msg, type = 'info') {
      messageArea.textContent = msg;
      messageArea.className = 'show ' + type;
      clearTimeout(autoSaveTimer);
      autoSaveTimer = setTimeout(() => {
        messageArea.className = '';
        messageArea.textContent = '';
      }, 2500);
    }

    function updateButtonColumns(columns) {
      if (window.innerWidth <= 768) {
        return;
      }
      root.style.setProperty('--button-columns', columns);
      localStorage.setItem(STORAGE_KEY_COLUMNS, columns);
      showMessage(`${columns}åˆ—è¡¨ç¤ºã«åˆ‡ã‚Šæ›¿ãˆã¾ã—ãŸ`, "info");
    }

    function loadFavorites() {
      const favoritesJSON = localStorage.getItem(STORAGE_KEY_FAVORITES);
      return favoritesJSON ? JSON.parse(favoritesJSON) : [];
    }

    function saveFavorites(favorites) {
      localStorage.setItem(STORAGE_KEY_FAVORITES, JSON.stringify(favorites));
    }

    function displayFavorites() {
      const favorites = loadFavorites();
      favoritesList.innerHTML = '';
      if (favorites.length === 0) {
        favoritesList.innerHTML = '<li>ãŠæ°—ã«å…¥ã‚Šã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚</li>';
        return;
      }
      favorites.forEach((fav, index) => {
        const li = document.createElement('li');
        li.dataset.index = index;
        li.innerHTML = `
          <div class="favorite-info">
            <div class="favorite-title">${fav.title}</div>
            <div class="favorite-date">ä¿å­˜æ—¥: ${fav.date}</div>
          </div>
          <button class="delete-btn"><i class="fas fa-trash-alt"></i></button>
        `;
        favoritesList.appendChild(li);
      });
    }

    function initialize() {
      const savedCode = localStorage.getItem(STORAGE_KEY_CODE);
      if (savedCode) {
        cm.setValue(savedCode);
      }
      if (window.innerWidth > 768) {
        const savedColumns = localStorage.getItem(STORAGE_KEY_COLUMNS);
        if (savedColumns) {
          updateButtonColumns(savedColumns);
          const radioToSelect = document.getElementById(`columns${savedColumns}`);
          if (radioToSelect) {
            radioToSelect.checked = true;
          }
        } else {
          document.getElementById('columns4').checked = true;
        }
      }

      cm.on("change", () => {
        localStorage.setItem(STORAGE_KEY_CODE, cm.getValue());
      });

      selectAllBtn.addEventListener('click', () => {
        cm.focus();
        cm.execCommand("selectAll");
        showMessage("å…¨é¸æŠã—ã¾ã—ãŸ", "info");
      });
      deselectAllBtn.addEventListener('click', () => {
        cm.setSelection(cm.getCursor(), cm.getCursor());
        showMessage("å…¨é¸æŠã‚’è§£é™¤ã—ã¾ã—ãŸ", "info");
      });
      copyBtn.addEventListener('click', () => {
        const text = cm.getSelection() || cm.getValue();
        navigator.clipboard.writeText(text)
          .then(() => showMessage("ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ", "success"))
          .catch(err => showMessage("ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ", "error"));
      });
      pasteBtn.addEventListener('click', () => {
        navigator.clipboard.readText()
          .then(text => {
            cm.replaceSelection(text);
            showMessage("è²¼ã‚Šä»˜ã‘ã¾ã—ãŸ", "success");
            controlsDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
          })
          .catch(err => showMessage("è²¼ã‚Šä»˜ã‘ã«å¤±æ•—ã—ã¾ã—ãŸ", "error"));
      });
      clearAllBtn.addEventListener('click', () => {
        if (confirm("æœ¬å½“ã«å…¨å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
          cm.setValue("");
          showMessage("å…¨ã¦å‰Šé™¤ã—ã¾ã—ãŸ", "info");
        }
      });
      undoBtn.addEventListener('click', () => {
        cm.undo();
        showMessage("å…ƒã«æˆ»ã—ã¾ã—ãŸ", "info");
      });
      redoBtn.addEventListener('click', () => {
        cm.redo();
        showMessage("ã‚„ã‚Šç›´ã—ã¾ã—ãŸ", "info");
      });
      openFileBtn.addEventListener('click', () => fileInput.click());
      fileInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = (evt) => {
            cm.setValue(evt.target.result);
            const fileName = file.name.toLowerCase();
            if (fileName.endsWith('.html') || fileName.endsWith('.htm')) cm.setOption('mode', 'htmlmixed');
            else if (fileName.endsWith('.css')) cm.setOption('mode', 'css');
            else if (fileName.endsWith('.js')) cm.setOption('mode', 'javascript');
            else if (fileName.endsWith('.xml')) cm.setOption('mode', 'xml');
            else cm.setOption('mode', null);
            showMessage(`ãƒ•ã‚¡ã‚¤ãƒ«ã€Œ${file.name}ã€ã‚’é–‹ãã¾ã—ãŸ`, "success");
            controlsDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
          };
          reader.readAsText(file);
        }
        fileInput.value = '';
      });
      saveBtn.addEventListener('click', () => {
        const currentMode = cm.getOption('mode');
        let fileName, fileType;
        switch (currentMode) {
          case 'css': fileName = "style.css"; fileType = "text/css"; break;
          case 'javascript': fileName = "script.js"; fileType = "application/javascript"; break;
          case 'xml': fileName = "document.xml"; fileType = "application/xml"; break;
          case 'htmlmixed':
          default: fileName = "index.html"; fileType = "text/html"; break;
        }
        const blob = new Blob([cm.getValue()], { type: fileType });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = fileName;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        showMessage("ä¿å­˜ã—ã¾ã—ãŸ", "success");
      });
      runBtn.addEventListener('click', () => {
        const blob = new Blob([cm.getValue()], { type: "text/html" });
        const url = URL.createObjectURL(blob);
        window.open(url, "_blank");
        showMessage("ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã—ã¾ã—ãŸ", "info");
      });
      scrollToCursorBtn.addEventListener('click', () => {
        cm.scrollIntoView(null, 20);
        showMessage("ã‚«ãƒ¼ã‚½ãƒ«ä½ç½®ã¸ç§»å‹•ã—ã¾ã—ãŸ", "info");
      });
      findBtn.addEventListener('click', () => cm.execCommand("find"));
      replaceBtn.addEventListener('click', () => cm.execCommand("replace"));
      commentBtn.addEventListener('click', () => cm.toggleComment());
      helpBtn.addEventListener('click', () => helpModal.style.display = 'block');

      columnRadios.forEach(radio => {
        radio.addEventListener('change', (event) => updateButtonColumns(event.target.value));
      });

      saveFavoriteBtn.addEventListener('click', () => {
        const title = prompt("ãŠæ°—ã«å…¥ã‚Šã®ã‚¿ã‚¤ãƒˆãƒ«ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:");
        if (title) {
          const favorites = loadFavorites();
          favorites.unshift({
            title: title,
            code: cm.getValue(),
            date: new Date().toLocaleDateString('ja-JP', {
              year: 'numeric',
              month: '2-digit',
              day: '2-digit',
              hour: '2-digit',
              minute: '2-digit'
            })
          });
          saveFavorites(favorites);
          showMessage(`ã€Œ${title}ã€ã‚’ãŠæ°—ã«å…¥ã‚Šã«è¿½åŠ ã—ã¾ã—ãŸ`, "success");
        }
      });

      showFavoritesBtn.addEventListener('click', () => {
        displayFavorites();
        favoritesModal.style.display = 'block';
      });

      favoritesList.addEventListener('click', (event) => {
        const li = event.target.closest('li');
        if (!li) return;
        const index = li.dataset.index;
        if (event.target.closest('.delete-btn')) {
          if (confirm("ã“ã®ãŠæ°—ã«å…¥ã‚Šã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
            const favorites = loadFavorites();
            const deletedTitle = favorites[index].title;
            favorites.splice(index, 1);
            saveFavorites(favorites);
            displayFavorites();
            showMessage(`ã€Œ${deletedTitle}ã€ã‚’å‰Šé™¤ã—ã¾ã—ãŸ`, "info");
          }
        } else {
          const favorites = loadFavorites();
          const selectedCode = favorites[index].code;
          cm.setValue(selectedCode);
          favoritesModal.style.display = 'none';
          showMessage(`ã€Œ${favorites[index].title}ã€ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ`, "success");
        }
      });
    }

    initialize();
  </script>
</body>
</html>
