<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>è±ªè¯HTMLã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼ (ã‚¿ãƒ–æ©Ÿèƒ½ãƒ»æ”¹å–„ç‰ˆ)</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/theme/material-darker.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/search/matchesonscrollbar.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/dialog/dialog.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/fold/foldgutter.min.css">
  <style>
    /* ğŸ¨ PCã¨ãƒ¢ãƒã‚¤ãƒ«ã®ä¸¡æ–¹ã«å¯¾å¿œã™ã‚‹ãŸã‚ã®å¤‰æ•°ã¨åŸºæœ¬è¨­å®š */
    :root {
      /* PCç”¨: ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒœã‚¿ãƒ³ã®åˆ—æ•° (JSã§å¤‰æ›´å¯èƒ½) */
      --button-columns: 5;
      --button-gap: 8px;
    }
    body {
      margin: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      display: flex;
      flex-direction: column;
      height: 100vh;
      background-color: #263238;
      color: #ECEFF1;
      padding-top: env(safe-area-inset-top);
      padding-bottom: env(safe-area-inset-bottom);
      padding-left: env(safe-area-inset-left);
      padding-right: env(safe-area-inset-right);
      box-sizing: border-box; /* paddingã‚’å«ã‚ã¦é«˜ã•ã‚’è¨ˆç®— */
    }

    /* --- ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã‚¨ãƒªã‚¢ --- */
    .controls {
      padding: 10px;
      background-color: #37474F;
      display: flex;
      flex-direction: column; /* ç¸¦ã«ä¸¦ã¹ã‚‹åŸºæœ¬æ§‹é€  */
      gap: 10px; /* runBtnã¨button-rowã®é–“ã®éš™é–“ */
      position: relative;
      z-index: 10;
      box-shadow: 0 4px 8px rgba(0,0,0,0.3);
      border-bottom: 1px solid #455A64;
    }

    /* å®Ÿè¡Œãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    #runBtn {
      background-color: #00A381;
      padding: 10px 8px !important;
      font-size: 1.2em !important;
      font-weight: bold;
      width: 100%;
      box-sizing: border-box;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    .controls button#runBtn:hover {
        background-color: #00b894;
        transform: translateY(-2px);
    }


    /* PCã§ã®ãƒœã‚¿ãƒ³ç¾¤ã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯éãƒ¢ãƒã‚¤ãƒ«) */
    .button-row {
      display: grid;
      grid-template-columns: repeat(var(--button-columns), 1fr);
      gap: 5px; /* ãƒœã‚¿ãƒ³é–“ã®éš™é–“ã‚’å°ã•ã */
      width: 100%;
    }

    /* é€šå¸¸ãƒœã‚¿ãƒ³ã®åŸºæœ¬ã‚¹ã‚¿ã‚¤ãƒ« */
    .controls button {
      padding: 6px 4px; /* ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’èª¿æ•´ */
      cursor: pointer;
      border: none;
      border-radius: 4px;
      background-color: #546E7A;
      color: #ECEFF1;
      font-size: 0.85em; /* æ–‡å­—ã‚µã‚¤ã‚ºã‚’å°‘ã—å¤§ãã */
      font-weight: 600;
      transition: background-color 0.2s ease, transform 0.2s ease, box-shadow 0.2s ease;
      box-shadow: 0 1px 2px rgba(0,0,0,0.2);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
      white-space: nowrap; /* ãƒœã‚¿ãƒ³ã®ãƒ†ã‚­ã‚¹ãƒˆãŒæŠ˜ã‚Šè¿”ã•ãªã„ã‚ˆã†ã« */
      text-align: center;
      min-width: 0; /* gridã‚¢ã‚¤ãƒ†ãƒ ã¨ã—ã¦ç¸®å°ã§ãã‚‹ã‚ˆã†ã« */
      box-sizing: border-box;
    }
    .controls button i {
      font-size: 1.1em; /* ã‚¢ã‚¤ã‚³ãƒ³ã‚µã‚¤ã‚ºã‚’èª¿æ•´ */
    }
    .controls button:hover {
      background-color: #607D8B;
      transform: translateY(-2px);
      box-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }
    .controls button:active {
      transform: translateY(0);
      box-shadow: 0 1px 2px rgba(0,0,0,0.2);
    }
    
    /* ãƒœã‚¿ãƒ³ã®è‰²ä»˜ã‘ */
    .controls button#saveFavoriteBtn { background-color: #FFC107; }
    .controls button#showFavoritesBtn { background-color: #FF9800; }
    .controls button#clearAllBtn { background-color: #D32F2F; }
    .controls button#copyBtn { background-color: #2196F3; }
    .controls button#pasteBtn { background-color: #9C27B0; }
    /* hoverè‰² */
    .controls button#saveFavoriteBtn:hover { background-color: #ffca28; }
    .controls button#showFavoritesBtn:hover { background-color: #ffb300; }
    .controls button#clearAllBtn:hover { background-color: #e53935; }
    .controls button#copyBtn:hover { background-color: #42a5f5; }
    .controls button#pasteBtn:hover { background-color: #ab47bc; }

    /* ã‚«ãƒ©ãƒ ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼ */
    .column-selector {
      display: flex;
      gap: 15px;
      padding-top: 5px;
      border-top: 1px solid #455A64;
    }
    .column-selector label {
      font-size: 0.85em;
      cursor: pointer;
    }


    /* --- ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼ã‚¨ãƒªã‚¢ --- */
    .editor {
      flex: 1;
      overflow: hidden;
    }
    .CodeMirror {
      height: 100%;
      border: none;
      font-size: 16px;
      line-height: 1.5;
    }
    /* CodeMirroré–¢é€£ã®ã‚¹ã‚¿ã‚¤ãƒ«ã¯æ—¢å­˜ã®ã‚‚ã®ã‚’ç¶­æŒ */
    .CodeMirror-matchingtag {
      background-color: rgba(255, 255, 0, 0.4);
      outline: 1px solid rgba(255, 255, 0, 0.6);
    }
    .CodeMirror-foldmarker {
      color: #90A4AE;
      background-color: #455A64;
      font-weight: bold;
      border-radius: 2px;
    }

    /* --- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¨ãƒªã‚¢ --- */
    #messageArea {
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      padding: 10px 20px;
      font-size: 0.9em;
      white-space: nowrap;
      background-color: rgba(0, 0, 0, 0.85);
      color: white;
      border-radius: 8px;
      opacity: 0;
      transition: opacity 0.4s ease-out, transform 0.4s ease-out, background-color 0.4s ease;
      z-index: 100;
      pointer-events: none;
      box-shadow: 0 4px 12px rgba(0,0,0,0.4);
    }
    #messageArea.show {
        opacity: 1;
        transform: translateY(-50%) translateX(0);
    }
    #messageArea:not(.show) {
        transform: translateY(-50%) translateX(20px);
    }
    #messageArea.success { background-color: #4CAF50; }
    #messageArea.error { background-color: #F44336; }
    #messageArea.info { background-color: #2196F3; }

    /* --- ãƒ¢ãƒ¼ãƒ€ãƒ« --- */
    /* ãƒ¢ãƒ¼ãƒ€ãƒ«é–¢é€£ã®ã‚¹ã‚¿ã‚¤ãƒ«ã¯æ—¢å­˜ã®ã‚‚ã®ã‚’ç¶­æŒ */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0, 0, 0, 0.7);
      padding-top: 60px;
    }
    .modal-content {
      background-color: #37474F;
      margin: 5% auto;
      padding: 20px;
      border: 1px solid #888;
      width: 90%;
      max-width: 600px;
      border-radius: 10px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.5);
      color: #ECEFF1;
      position: relative;
    }
    .close-button {
      color: #aaa;
      position: absolute;
      top: 10px;
      right: 20px;
      font-size: 28px;
      font-weight: bold;
    }
    .close-button:hover, .close-button:focus {
      color: #fff;
      text-decoration: none;
      cursor: pointer;
    }
    #favoritesList li {
      padding: 12px;
      border-bottom: 1px solid #455A64;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: background-color 0.2s;
    }
    #favoritesList li:hover { background-color: #455A64; }
    #favoritesList .favorite-info { cursor: pointer; flex-grow: 1; }
    #favoritesList .favorite-title { font-weight: bold; font-size: 1.1em; }
    #favoritesList .favorite-date { font-size: 0.8em; color: #B0BEC5; }
    #favoritesList .delete-btn {
      background-color: #D32F2F;
      color: white;
      border: none;
      padding: 5px 10px;
      border-radius: 5px;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    #favoritesList .delete-btn:hover { background-color: #e53935; }


    /* ğŸ“± ãƒ¢ãƒã‚¤ãƒ«å¯¾å¿œ (768pxä»¥ä¸‹) */
    @media (max-width: 768px) {
      .controls {
        padding-top: calc(10px + env(safe-area-inset-top, 0px));
        padding-bottom: 10px;
        gap: 8px; /* ãƒ¢ãƒã‚¤ãƒ«ã§ã¯runBtnã¨button-rowã®éš™é–“ã‚’å°‘ã—ç‹­ã */
      }
      
      /* ãƒ¢ãƒã‚¤ãƒ«ã§ã®ãƒœã‚¿ãƒ³ç¾¤ã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
      .button-row {
        grid-template-columns: repeat(4, 1fr); /* ãƒ¢ãƒã‚¤ãƒ«ã§ã¯4åˆ—å›ºå®š */
        gap: 5px;
      }
      
      .controls button {
        /* ãƒ¢ãƒã‚¤ãƒ«ã§ã¯ã‚¢ã‚¤ã‚³ãƒ³ã¨æ–‡å­—ã‚’ç¸¦ã«ä¸¦ã¹ã‚‹ */
        flex-direction: column;
        justify-content: center;
        padding: 5px 3px;
        font-size: 0.7em;
        min-width: unset;
      }
      .controls button i {
        font-size: 1.2em;
        margin-bottom: 2px;
      }
      
      /* runBtnã¯æ¨ªä¸¦ã³ã®ã¾ã¾ */
      .controls button#runBtn {
        flex-direction: row;
        gap: 8px;
        padding: 10px;
        font-size: 1.1em;
      }

      /* ãƒ¢ãƒã‚¤ãƒ«ã§ä¸è¦ã¨åˆ¤æ–­ã—ã¦ã„ãŸãƒœã‚¿ãƒ³ã‚’å†åº¦è¡¨ç¤º */
      #selectAllBtn, #deselectAllBtn, #undoBtn, #redoBtn, #scrollToCursorBtn {
        display: none !important; /* é »åº¦ãŒä½ã„ã‚‚ã®ã¯éè¡¨ç¤ºã®ã¾ã¾ */
      }

      /* æ¤œç´¢ã€ç½®æ›ã€ã‚³ãƒ”ãƒ¼ã€è²¼ä»˜ã‘ãªã©ã®å®Ÿç”¨çš„ãªãƒœã‚¿ãƒ³ã¯ãƒ¢ãƒã‚¤ãƒ«ã§ã‚‚è¡¨ç¤º */
      #copyBtn, #pasteBtn, #findBtn, #replaceBtn, #commentBtn {
          display: flex !important;
      }
      
      /* ã‚«ãƒ©ãƒ ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼ã¯ãƒ¢ãƒã‚¤ãƒ«ã§ã¯ä¸è¦ãªã®ã§éè¡¨ç¤º */
      .column-selector {
        display: none;
      }
      
      /* ãƒ¢ãƒã‚¤ãƒ«ã§ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¨ãƒªã‚¢ã®ä½ç½®èª¿æ•´ */
      #messageArea {
        top: calc(5px + env(safe-area-inset-top, 0px)); /* ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã‚¨ãƒªã‚¢ã®ã™ãä¸‹ã«é…ç½® */
        transform: translateY(0);
        left: 50%;
        transform: translateX(-50%);
        white-space: normal;
        text-align: center;
        width: 90%;
        max-width: 400px;
      }
      #messageArea.show {
        transform: translateY(0) translateX(-50%);
      }
      #messageArea:not(.show) {
        transform: translateY(-20px) translateX(-50%);
      }
      
      .modal-content {
        width: 95%;
        margin: 5% auto;
      }
    }
    
    /* --- ã‚¿ãƒ–æ©Ÿèƒ½ã®ã‚¹ã‚¿ã‚¤ãƒ« --- */
    .tab-bar {
      display: flex;
      flex-wrap: nowrap;
      overflow-x: auto;
      padding: 0 10px;
      background-color: #263238;
      border-bottom: 1px solid #455A64;
      white-space: nowrap;
      scrollbar-width: none; /* Firefox */
    }
    .tab-bar::-webkit-scrollbar {
      display: none; /* Chrome, Safari, Opera */
    }

    .tab {
      display: flex;
      align-items: center;
      padding: 8px 12px;
      cursor: pointer;
      background-color: #37474F;
      border: 1px solid #455A64;
      border-bottom: none;
      margin-right: 5px;
      border-radius: 6px 6px 0 0;
      font-size: 0.9em;
      transition: background-color 0.2s, color 0.2s;
      min-width: 100px;
      max-width: 200px;
    }

    .tab.active {
      background-color: #263238;
      border-color: #2196F3;
      color: #2196F3;
      font-weight: bold;
    }

    .tab:hover:not(.active) {
      background-color: #455A64;
    }
    
    .tab-title {
        flex-grow: 1;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        padding-right: 8px;
    }

    .tab-close {
      margin-left: 8px;
      background: none;
      border: none;
      color: #B0BEC5;
      cursor: pointer;
      font-size: 1.1em;
      padding: 0;
      line-height: 1;
      transition: color 0.2s;
    }

    .tab-close:hover {
      color: #ECEFF1;
    }
    
    .add-tab-btn {
      background-color: #546E7A;
      color: #ECEFF1;
      border: none;
      padding: 8px 12px;
      border-radius: 6px 6px 0 0;
      margin-left: auto;
      cursor: pointer;
      transition: background-color 0.2s;
      font-size: 1em;
      line-height: 1;
    }
    .add-tab-btn:hover {
        background-color: #607D8B;
    }
  </style>
</head>
<body>
  <div class="controls">
    <div id="messageArea"></div>
    <button id="runBtn"><i class="fas fa-play"></i> å®Ÿè¡Œ</button>
    
    <div class="button-row">
      <button id="saveFavoriteBtn"><i class="fas fa-star"></i> ãŠæ°—ã«å…¥ã‚Š</button>
      <button id="showFavoritesBtn"><i class="fas fa-list"></i> ä¸€è¦§</button>
      <button id="selectAllBtn"><i class="fas fa-border-all"></i> å…¨é¸æŠ</button>
      <button id="deselectAllBtn"><i class="far fa-circle"></i> é¸æŠè§£é™¤</button>
      <button id="copyBtn"><i class="fas fa-copy"></i> ã‚³ãƒ”ãƒ¼</button>
      <button id="pasteBtn"><i class="fas fa-paste"></i> è²¼ä»˜ã‘</button>
      <button id="clearAllBtn"><i class="fas fa-trash-alt"></i> å…¨å‰Šé™¤</button>
      <button id="undoBtn"><i class="fas fa-undo"></i> æˆ»ã™</button>
      <button id="redoBtn"><i class="fas fa-redo"></i> é€²ã‚€</button>
      <button id="openFileBtn"><i class="fas fa-folder-open"></i> é–‹ã</button>
      <input type="file" id="fileInput" accept=".html,.css,.js,.txt,.xml" style="display:none">
      <button id="saveBtn"><i class="fas fa-save"></i> ä¿å­˜</button>
      <button id="scrollToCursorBtn"><i class="fas fa-location-arrow"></i> ã‚«ãƒ¼ã‚½ãƒ«</button>
      <button id="findBtn"><i class="fas fa-search"></i> æ¤œç´¢</button>
      <button id="replaceBtn"><i class="fas fa-exchange-alt"></i> ç½®æ›</button>
      <button id="commentBtn"><i class="fas fa-comment"></i> ã‚³ãƒ¡ãƒ³ãƒˆ</button>
      <button id="helpBtn"><i class="fas fa-question-circle"></i> ãƒ˜ãƒ«ãƒ—</button>
    </div>
    
    <div class="column-selector">
      <label>
        <input type="radio" name="columnCount" value="1" id="columns1"> 1åˆ—
      </label>
      <label>
        <input type="radio" name="columnCount" value="2" id="columns2"> 2åˆ—
      </label>
      <label>
        <input type="radio" name="columnCount" value="3" id="columns3"> 3åˆ—
      </label>
      <label>
        <input type="radio" name="columnCount" value="4" id="columns4"> 4åˆ—
      </label>
      <label>
        <input type="radio" name="columnCount" value="5" id="columns5" checked> 5åˆ—
      </label>
    </div>
  </div>
  
  <div class="tab-bar" id="tabBar">
    <button id="addTabBtn" class="add-tab-btn" title="æ–°ã—ã„ã‚¿ãƒ–ã‚’è¿½åŠ "><i class="fas fa-plus"></i></button>
  </div>
  
  <div class="editor">
    <textarea id="htmlCode" placeholder="ã“ã“ã«HTMLã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"></textarea>
  </div>
  
  <div id="favoritesModal" class="modal">
    <div class="modal-content">
      <span class="close-button" aria-label="é–‰ã˜ã‚‹">&times;</span>
      <h2>ãŠæ°—ã«å…¥ã‚Šä¸€è¦§ â­ï¸</h2>
      <ul id="favoritesList">
      </ul>
    </div>
  </div>
  
  <div id="helpModal" class="modal">
    <div class="modal-content">
      <span class="close-button" aria-label="é–‰ã˜ã‚‹">&times;</span>
      <h2>ãƒ˜ãƒ«ãƒ— & ä½¿ã„æ–¹ ğŸ’¡</h2>
      <div id="helpContent">
        <p>ã“ã®ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼ã¯ã€ã‚¦ã‚§ãƒ–é–‹ç™ºã®ãŸã‚ã®å¤šæ©Ÿèƒ½ãƒ„ãƒ¼ãƒ«ã§ã™ã€‚ä»¥ä¸‹ã«ä¸»ãªä½¿ã„æ–¹ã‚’ã¾ã¨ã‚ã¾ã—ãŸã€‚</p>
        <h3>åŸºæœ¬æ“ä½œ</h3>
        <ul>
          <li><strong>å®Ÿè¡Œ</strong>: ç¾åœ¨ã®ã‚³ãƒ¼ãƒ‰ã‚’æ–°ã—ã„ã‚¿ãƒ–ã§è¡¨ç¤ºã—ã¾ã™ã€‚</li>
          <li><strong>ãŠæ°—ã«å…¥ã‚Š</strong>: ç¾åœ¨ã®ã‚³ãƒ¼ãƒ‰ã‚’åå‰ã‚’ä»˜ã‘ã¦ä¿å­˜ã—ã¾ã™ã€‚</li>
          <li><strong>ä¸€è¦§</strong>: ä¿å­˜ã—ãŸã‚³ãƒ¼ãƒ‰ã®ãƒªã‚¹ãƒˆã‚’è¡¨ç¤ºãƒ»èª­ã¿è¾¼ã¿ãƒ»å‰Šé™¤ã—ã¾ã™ã€‚</li>
          <li><strong>ã‚³ãƒ”ãƒ¼/è²¼ä»˜ã‘</strong>: ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼å†…ã®ã‚³ãƒ¼ãƒ‰ã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼/è²¼ä»˜ã‘ã—ã¾ã™ã€‚</li>
          <li><strong>å…¨å‰Šé™¤</strong>: ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼å†…ã®ã‚³ãƒ¼ãƒ‰ã‚’ã™ã¹ã¦æ¶ˆå»ã—ã¾ã™ã€‚</li>
          <li><strong>ä¿å­˜</strong>: ç¾åœ¨ã®ã‚³ãƒ¼ãƒ‰ã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã€‚</li>
          <li><strong>ã‚¿ãƒ–</strong>: è¤‡æ•°ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’åˆ‡ã‚Šæ›¿ãˆã¦ç·¨é›†ã§ãã¾ã™ã€‚ã‚¿ãƒ–ã‚’ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯ã§åå‰ã‚’å¤‰æ›´ã§ãã¾ã™ã€‚</li>
          <li><strong>â­ï¸æ–°æ©Ÿèƒ½â­ï¸</strong>: HTMLã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã™ã‚‹ã¨ã€è‡ªå‹•ã§`&lt;title&gt;`ã‚¿ã‚°ã®å†…å®¹ã‚’ã‚¿ãƒ–åã«åæ˜ ã—ã¾ã™ã€‚</li>
        </ul>
        <h3>ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼æ©Ÿèƒ½</h3>
        <ul>
          <li><strong>è¡Œç•ªå·/ã‚·ãƒ³ã‚¿ãƒƒã‚¯ã‚¹ãƒã‚¤ãƒ©ã‚¤ãƒˆ</strong>: ã‚³ãƒ¼ãƒ‰ã®ç¨®é¡ã«å¿œã˜ã¦è‰²åˆ†ã‘è¡¨ç¤ºã—ã¾ã™ã€‚</li>
          <li><strong>ã‚³ãƒ¼ãƒ‰ã®æŠ˜ã‚ŠãŸãŸã¿</strong>: å¤§é‡ã®ã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆã«è¡¨ç¤ºã—ã¾ã™ã€‚</li>
          <li><strong>ã‚«ãƒ¼ã‚½ãƒ«</strong>: ç”»é¢ãŒã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã—ã¦ã„ã¦ã‚‚ã€ã‚«ãƒ¼ã‚½ãƒ«ã®ä½ç½®ã¾ã§è‡ªå‹•ã§ç§»å‹•ã—ã¾ã™ã€‚</li>
          <li><strong>æ¤œç´¢/ç½®æ›</strong>: ã‚³ãƒ¼ãƒ‰å†…ã®æ–‡å­—åˆ—ã‚’æ¤œç´¢ã—ãŸã‚Šã€ç½®ãæ›ãˆãŸã‚Šã§ãã¾ã™ã€‚<br>
            <strong>â­ï¸æ”¹å–„â­ï¸</strong>: ä¸€è‡´ç®‡æ‰€ã¯ãƒã‚¤ãƒ©ã‚¤ãƒˆã•ã‚Œã€**ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã«ã‚‚è¡¨ç¤º**ã•ã‚Œã‚‹ãŸã‚ã€ç°¡å˜ã«ç§»å‹•ã§ãã¾ã™ã€‚<br>
            <strong>â­ï¸æ”¹å–„â­ï¸</strong>: ã€Œ**ä¸€æ‹¬ç½®æ›**ã€ã‚’å®Ÿè¡Œã™ã‚‹ã¨ã€**ç½®æ›ã—ãŸä»¶æ•°**ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚
          </li>
          <li><strong>ã‚³ãƒ¡ãƒ³ãƒˆ</strong>: é¸æŠç¯„å›²ã‚„ã‚«ãƒ¼ã‚½ãƒ«è¡Œã‚’ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆ/ã‚¢ãƒ³ã‚³ãƒ¡ãƒ³ãƒˆã—ã¾ã™ã€‚</li>
        </ul>
      </div>
    </div>
  </div>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/htmlmixed/htmlmixed.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/xml/xml.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/javascript/javascript.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/css/css.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/edit/closetag.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/edit/matchbrackets.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/edit/matchtags.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/selection/active-line.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/search/search.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/search/searchcursor.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/dialog/dialog.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/search/jump-to-line.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/search/match-highlighter.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/edit/comment.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/fold/foldcode.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/fold/foldgutter.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/fold/xml-fold.min.js"></script>

  <script>
    // æ¤œç´¢ãƒ»ç½®æ›ã®ä»¶æ•°è¡¨ç¤ºæ©Ÿèƒ½ï¼ˆã‚°ãƒ­ãƒ¼ãƒãƒ«ã«é–¢æ•°ã‚’ãƒ©ãƒƒãƒ—ï¼‰
    (function() {
        /**
         * @param {string} query - æ¤œç´¢æ–‡å­—åˆ—
         * @param {CodeMirror.Editor} cmInstance - CodeMirrorã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹
         * @returns {number} - ä¸€è‡´ã—ãŸä»¶æ•°
         */
        function countOccurrences(query, cmInstance) {
           if (!query || query === "") return 0;
           let count = 0;
           // æ¤œç´¢ã‚«ãƒ¼ã‚½ãƒ«ã‚’ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®æœ€åˆã‹ã‚‰é–‹å§‹
           const cursor = cmInstance.getSearchCursor(query, {line: 0, ch: 0});
           while (cursor.findNext()) {
               count++;
           }
           return count;
        }

        // 'replaceAll' ã‚³ãƒãƒ³ãƒ‰ã‚’ãƒ©ãƒƒãƒ—ã—ã¦ä»¶æ•°ã‚’è¡¨ç¤º
        const originalReplaceAll = CodeMirror.commands.replaceAll;
        CodeMirror.commands.replaceAll = function(cm) {
            let count = 0;
            let query = "";
            
            // ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‹ã‚‰ç¾åœ¨ã®ã‚¯ã‚¨ãƒªã‚’å–å¾—
            if (cm.state.search && cm.state.search.query) {
                query = cm.state.search.query;
            } else if (cm.state.dialog && cm.state.dialog.lastSearch) {
                query = cm.state.dialog.lastSearch.query;
            }
            
            if (query) {
               count = countOccurrences(query, cm);
            }

            // å…ƒã® replaceAll ã‚’å®Ÿè¡Œ
            originalReplaceAll.apply(this, arguments);
            
            if (count > 0) {
                // showMessage ã¯ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ã‚³ãƒ¼ãƒ—ã§å®šç¾©ã•ã‚Œã‚‹ãŸã‚ã€ã“ã“ã§ã¯å‘¼ã³å‡ºã›ã‚‹
                showMessage(`${count}ä»¶ã‚’ç½®æ›ã—ã¾ã—ãŸ`, "success");
            } else if (query) {
                showMessage("ç½®æ›å¯¾è±¡ã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ", "error");
            }
        };
    })();

    var cm = CodeMirror.fromTextArea(document.getElementById('htmlCode'), {
      mode: "htmlmixed",
      lineNumbers: true,
      theme: "material-darker",
      autoCloseTags: true,
      matchBrackets: true,
      matchTags: { bothTags: true },
      styleActiveLine: true,
      // â­ï¸æ”¹å–„â­ï¸: matchesonscrollbar: true ã§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã«ä¸€è‡´ç®‡æ‰€ã‚’è¡¨ç¤º
      highlightSelectionMatches: {showToken: /\w/, annotateScrollbar: true}, 
      extraKeys: {
        "Ctrl-Q": function(cm){ cm.foldCode(cm.getCursor()); },
        "Ctrl-/": "toggleComment",
        "Cmd-F": "find",
        "Ctrl-F": "find",
        "Cmd-G": "findNext",
        "Ctrl-G": "findNext",
        "Shift-Cmd-G": "findPrev",
        "Shift-Ctrl-G": "findPrev",
        "Shift-Cmd-F": "replace",
        "Shift-Ctrl-F": "replace",
        "Shift-Cmd-R": "replaceAll",
        "Shift-Ctrl-R": "replaceAll"
      },
      foldGutter: true,
      gutters: ["CodeMirror-linenumbers", "CodeMirror-foldgutter"]
    });

    setTimeout(() => {
      cm.refresh();
    }, 100);

    const STORAGE_KEY_FAVORITES = "advancedEditorFavorites";
    const STORAGE_KEY_TABS = "advancedEditorTabs_v2"; // ã‚¿ãƒ–æ©Ÿèƒ½ç”¨ã®æ–°ã—ã„ã‚­ãƒ¼
    const STORAGE_KEY_ACTIVE_TAB = "advancedEditorActiveTab_v2";
    const STORAGE_KEY_COLUMNS = "advancedEditorColumns";
    let autoSaveTimer;
    let titleUpdateTimer; // â­ï¸æ–°æ©Ÿèƒ½â­ï¸: <title>ã‚¿ã‚°è‡ªå‹•æ›´æ–°ç”¨ãƒ‡ãƒã‚¦ãƒ³ã‚¹ã‚¿ã‚¤ãƒãƒ¼
    const titleRegex = /<title\b[^>]*>([\s\S]*?)<\/title>/i; // â­ï¸æ–°æ©Ÿèƒ½â­ï¸: <title>ã‚¿ã‚°æŠ½å‡ºç”¨æ­£è¦è¡¨ç¾

    const controlsDiv = document.querySelector('.controls');
    const selectAllBtn = document.getElementById('selectAllBtn');
    const deselectAllBtn = document.getElementById('deselectAllBtn');
    const copyBtn = document.getElementById('copyBtn');
    const pasteBtn = document.getElementById('pasteBtn');
    const clearAllBtn = document.getElementById('clearAllBtn');
    const undoBtn = document.getElementById('undoBtn');
    const redoBtn = document.getElementById('redoBtn');
    const openFileBtn = document.getElementById('openFileBtn');
    const fileInput = document.getElementById('fileInput');
    const saveBtn = document.getElementById('saveBtn');
    const runBtn = document.getElementById('runBtn');
    const scrollToCursorBtn = document.getElementById('scrollToCursorBtn');
    const findBtn = document.getElementById('findBtn');
    const replaceBtn = document.getElementById('replaceBtn');
    const commentBtn = document.getElementById('commentBtn');
    const saveFavoriteBtn = document.getElementById('saveFavoriteBtn');
    const showFavoritesBtn = document.getElementById('showFavoritesBtn');
    const helpBtn = document.getElementById('helpBtn');
    const messageArea = document.getElementById('messageArea');
    const columnRadios = document.querySelectorAll('input[name="columnCount"]');
    const root = document.documentElement;
    const tabBar = document.getElementById('tabBar');
    const addTabBtn = document.getElementById('addTabBtn');

    const favoritesModal = document.getElementById('favoritesModal');
    const favoritesList = document.getElementById('favoritesList');
    const helpModal = document.getElementById('helpModal');
    const closeModalButtons = document.querySelectorAll('.close-button');

    // --- ã‚¿ãƒ–ç®¡ç†ç”¨å¤‰æ•° ---
    let tabs = [];
    let activeTabIndex = 0;
    let tabIdCounter = 1;


    closeModalButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        favoritesModal.style.display = 'none';
        helpModal.style.display = 'none';
      });
    });

    window.addEventListener('click', (event) => {
      if (event.target === favoritesModal) {
        favoritesModal.style.display = 'none';
      }
      if (event.target === helpModal) {
        helpModal.style.display = 'none';
      }
    });

    /**
     * @param {string} msg - è¡¨ç¤ºã™ã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
     * @param {'info' | 'success' | 'error'} type - ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ã‚¿ã‚¤ãƒ—
     */
    function showMessage(msg, type = 'info') {
      messageArea.textContent = msg;
      messageArea.className = 'show ' + type;
      clearTimeout(autoSaveTimer);
      autoSaveTimer = setTimeout(() => {
        messageArea.className = '';
        messageArea.textContent = '';
      }, 3000); // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºæ™‚é–“ã‚’3ç§’ã«å»¶é•·
    }

    /**
     * @param {string} columns - è¨­å®šã™ã‚‹åˆ—æ•°
     */
    function updateButtonColumns(columns) {
      if (window.innerWidth <= 768) {
        return;
      }
      root.style.setProperty('--button-columns', columns);
      localStorage.setItem(STORAGE_KEY_COLUMNS, columns);
      showMessage(`${columns}åˆ—è¡¨ç¤ºã«åˆ‡ã‚Šæ›¿ãˆã¾ã—ãŸ`, "info");
    }

    function loadFavorites() {
      const favoritesJSON = localStorage.getItem(STORAGE_KEY_FAVORITES);
      return favoritesJSON ? JSON.parse(favoritesJSON) : [];
    }

    function saveFavorites(favorites) {
      localStorage.setItem(STORAGE_KEY_FAVORITES, JSON.stringify(favorites));
    }

    function displayFavorites() {
      const favorites = loadFavorites();
      favoritesList.innerHTML = '';
      if (favorites.length === 0) {
        favoritesList.innerHTML = '<li>ãŠæ°—ã«å…¥ã‚Šã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚</li>';
        return;
      }
      favorites.forEach((fav, index) => {
        const li = document.createElement('li');
        li.dataset.index = index;
        li.innerHTML = `
          <div class="favorite-info">
            <div class="favorite-title">${fav.title}</div>
            <div class="favorite-date">ä¿å­˜æ—¥: ${fav.date}</div>
          </div>
          <button class="delete-btn" title="å‰Šé™¤"><i class="fas fa-trash-alt"></i></button>
        `;
        favoritesList.appendChild(li);
      });
    }

    // --- ã‚¿ãƒ–æ©Ÿèƒ½ã®å®Ÿè£… ---
    function loadTabs() {
      const savedTabs = localStorage.getItem(STORAGE_KEY_TABS);
      const activeTabId = localStorage.getItem(STORAGE_KEY_ACTIVE_TAB);
      
      if (savedTabs) {
        tabs = JSON.parse(savedTabs);
        tabIdCounter = tabs.reduce((max, t) => Math.max(max, t.id), 0) + 1;
        const activeTab = tabs.find(t => t.id == activeTabId);
        activeTabIndex = activeTab ? tabs.indexOf(activeTab) : 0;
      }

      if (tabs.length === 0) {
        tabs.push({ id: tabIdCounter++, title: 'Tab 1', code: '', mode: 'htmlmixed' });
        activeTabIndex = 0;
      }
      
      // ä»¥å‰ã®ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚­ãƒ¼ã‹ã‚‰ç§»è¡Œ
      if (!savedTabs) {
          const oldCode = localStorage.getItem("advancedEditorCode");
          if (oldCode) {
            tabs[0].code = oldCode;
            localStorage.removeItem("advancedEditorCode"); // ç§»è¡Œå®Œäº†
          }
      }
    }
    
    /**
     * â­ï¸ãƒã‚°ä¿®æ­£â­ï¸: ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚¿ãƒ–ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’CMã«ãƒ­ãƒ¼ãƒ‰ã™ã‚‹å‡¦ç†ã‚’åˆ†é›¢
     */
    function loadActiveTabContent() {
        if (tabs[activeTabIndex]) {
            cm.setValue(tabs[activeTabIndex].code);
            cm.setOption('mode', tabs[activeTabIndex].mode);
            cm.refresh();
            cm.focus();
        }
    }

    function saveTabs() {
      if (tabs[activeTabIndex]) {
          localStorage.setItem(STORAGE_KEY_TABS, JSON.stringify(tabs));
          localStorage.setItem(STORAGE_KEY_ACTIVE_TAB, tabs[activeTabIndex].id);
      }
    }

    function switchTab(index) {
      if (index === activeTabIndex || index < 0 || index >= tabs.length) return;

      // ç¾åœ¨ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚¿ãƒ–ã®å†…å®¹ã‚’ä¿å­˜
      tabs[activeTabIndex].code = cm.getValue();
      tabs[activeTabIndex].mode = cm.getOption('mode');

      activeTabIndex = index;
      
      // æ–°ã—ã„ã‚¿ãƒ–ã®å†…å®¹ã‚’ãƒ­ãƒ¼ãƒ‰ (â­ï¸ãƒã‚°ä¿®æ­£â­ï¸: åˆ†é›¢ã—ãŸé–¢æ•°ã‚’ä½¿ç”¨)
      loadActiveTabContent(); 

      renderTabs();
      saveTabs();
      showMessage(`ã‚¿ãƒ–ã€Œ${tabs[activeTabIndex].title}ã€ã«åˆ‡ã‚Šæ›¿ãˆã¾ã—ãŸ`, "info");
    }
    
    function addTab(title = null, code = '', mode = 'htmlmixed') {
      const newTitle = title || `Tab ${tabIdCounter}`;
      const newTab = { id: tabIdCounter++, title: newTitle, code: code, mode: mode };
      tabs.push(newTab);
      switchTab(tabs.length - 1); // æ–°ã—ã„ã‚¿ãƒ–ã«åˆ‡ã‚Šæ›¿ãˆ
    }

    function removeTab(index) {
      if (tabs.length === 1) {
        showMessage("æœ€å¾Œã®ã‚¿ãƒ–ã¯å‰Šé™¤ã§ãã¾ã›ã‚“", "error");
        return;
      }
      
      const removedTitle = tabs[index].title;
      tabs.splice(index, 1);
      
      if (index <= activeTabIndex) {
        activeTabIndex = Math.max(0, activeTabIndex - 1);
      }
      
      // å‰Šé™¤å¾Œã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚¿ãƒ–ã‚’å†ãƒ­ãƒ¼ãƒ‰ (â­ï¸ãƒã‚°ä¿®æ­£â­ï¸: åˆ†é›¢ã—ãŸé–¢æ•°ã‚’ä½¿ç”¨)
      loadActiveTabContent();

      renderTabs();
      saveTabs();
      showMessage(`ã‚¿ãƒ–ã€Œ${removedTitle}ã€ã‚’å‰Šé™¤ã—ã¾ã—ãŸ`, "info");
    }

    function renameTab(index) {
        const currentTitle = tabs[index].title;
        const newTitle = prompt("æ–°ã—ã„ã‚¿ãƒ–ã®ã‚¿ã‚¤ãƒˆãƒ«ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:", currentTitle);
        if (newTitle && newTitle.trim() !== "" && newTitle !== currentTitle) {
            tabs[index].title = newTitle.trim();
            renderTabs();
            saveTabs();
            showMessage(`ã‚¿ãƒ–åã‚’ã€Œ${newTitle.trim()}ã€ã«å¤‰æ›´ã—ã¾ã—ãŸ`, "success");
        } else if (newTitle === "") {
            showMessage("ã‚¿ã‚¤ãƒˆãƒ«ãŒå…¥åŠ›ã•ã‚Œã¦ã„ã¾ã›ã‚“", "error");
        }
    }


    function renderTabs() {
      const tempDiv = document.createElement('div');
      
      tabs.forEach((tab, index) => {
        const tabEl = document.createElement('div');
        tabEl.className = `tab ${index === activeTabIndex ? 'active' : ''}`;
        tabEl.dataset.index = index;
        tabEl.title = tab.title;

        tabEl.innerHTML = `<span class="tab-title">${tab.title}</span><button class="tab-close" title="é–‰ã˜ã‚‹">&times;</button>`;
        
        tabEl.addEventListener('click', (e) => {
            if (e.target.classList.contains('tab-close')) {
                removeTab(index);
            } else {
                switchTab(index);
            }
        });
        
        // ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯ã§åå‰å¤‰æ›´
        tabEl.addEventListener('dblclick', (e) => {
            if (!e.target.classList.contains('tab-close')) {
                renameTab(index);
            }
        });

        tempDiv.appendChild(tabEl);
      });
      
      // addTabBtnä»¥å¤–ã®æ—¢å­˜è¦ç´ ã‚’å‰Šé™¤
      while (tabBar.firstChild && tabBar.firstChild !== addTabBtn) {
        tabBar.removeChild(tabBar.firstChild);
      }
      // ä½œæˆã—ãŸã‚¿ãƒ–è¦ç´ ã‚’addTabBtnã®å‰ã«æŒ¿å…¥
      tempDiv.childNodes.forEach(node => {
        tabBar.insertBefore(node, addTabBtn);
      });
      
      // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªã‚¿ãƒ–ãŒã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒ“ãƒ¥ãƒ¼ã«å…¥ã‚‹ã‚ˆã†ã«èª¿æ•´
      const activeTabEl = tabBar.querySelector('.tab.active');
      if (activeTabEl) {
          activeTabEl.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'nearest' });
      }
    }
    
    /**
     * â­ï¸æ–°æ©Ÿèƒ½â­ï¸: ã‚³ãƒ¼ãƒ‰ã®å†…å®¹ã‹ã‚‰<title>ã‚¿ã‚°ã‚’æŠ½å‡ºã—ã€ã‚¿ãƒ–åã‚’æ›´æ–°
     * @param {string} content - CodeMirrorã®ç¾åœ¨ã®å†…å®¹
     * @param {number} index - æ›´æ–°å¯¾è±¡ã®ã‚¿ãƒ–ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
     */
    function updateTabTitleFromContent(content, index) {
        if (!tabs[index] || tabs[index].mode !== 'htmlmixed') return; // HTMLãƒ¢ãƒ¼ãƒ‰ã®ã¨ãã®ã¿å®Ÿè¡Œ

        const match = content.match(titleRegex);
        if (match && match[1]) {
            let newTitle = match[1].trim();
            
            // ã‚¿ã‚¤ãƒˆãƒ«ãŒç©ºã§ãªã„ã€ã‹ã¤ç¾åœ¨ã®ã‚¿ãƒ–åã¨ç•°ãªã‚‹å ´åˆã®ã¿æ›´æ–°
            if (newTitle && newTitle !== tabs[index].title) {
                // é•·ã™ãã‚‹ã‚¿ã‚¤ãƒˆãƒ«ã‚’ä¸¸ã‚ã‚‹
                if (newTitle.length > 50) newTitle = newTitle.substring(0, 50) + "...";
                
                tabs[index].title = newTitle;
                renderTabs(); // UIã‚’æ›´æ–°
                saveTabs(); // ä¿å­˜
            }
        }
    }
    // --- ã‚¿ãƒ–æ©Ÿèƒ½ å®Ÿè£…çµ‚ã‚ã‚Š ---

    function initialize() {
      // --- ã‚¿ãƒ–ã®åˆæœŸåŒ–ã¨ãƒ­ãƒ¼ãƒ‰ (â­ï¸ãƒã‚°ä¿®æ­£â­ï¸) ---
      loadTabs(); // 1. tabsé…åˆ—ã‚’æº–å‚™
      renderTabs(); // 2. ã‚¿ãƒ–ã®UIã‚’å…ˆã«æç”»
      loadActiveTabContent(); // 3. ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚¿ãƒ–ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’CMã«ãƒ­ãƒ¼ãƒ‰
      saveTabs(); // 4. åˆæœŸçŠ¶æ…‹ã‚’ä¿å­˜

      // --- ã‚«ãƒ©ãƒ è¨­å®šã®ãƒ­ãƒ¼ãƒ‰ ---
      const savedColumns = localStorage.getItem(STORAGE_KEY_COLUMNS);
      let columnsToUse = savedColumns || '5';
      if (window.innerWidth > 768) {
        updateButtonColumns(columnsToUse);
        const radioToSelect = document.getElementById(`columns${columnsToUse}`);
        if (radioToSelect) {
          radioToSelect.checked = true;
        }
      } 

      // --- ã‚¨ãƒ‡ã‚£ã‚¿å¤‰æ›´æ™‚ã®å‡¦ç†ï¼ˆã‚¿ãƒ–ã«ä¿å­˜ï¼‰ ---
      cm.on("change", () => {
        if (tabs[activeTabIndex]) {
             tabs[activeTabIndex].code = cm.getValue();
             tabs[activeTabIndex].mode = cm.getOption('mode');
             saveTabs(); // ã‚¿ãƒ–ã®å†…å®¹ã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜
             
             // â­ï¸æ–°æ©Ÿèƒ½â­ï¸: <title>ã‚¿ã‚°ã®è‡ªå‹•æ›´æ–°ï¼ˆãƒ‡ãƒã‚¦ãƒ³ã‚¹ä»˜ãï¼‰
             clearTimeout(titleUpdateTimer);
             titleUpdateTimer = setTimeout(() => {
                 updateTabTitleFromContent(tabs[activeTabIndex].code, activeTabIndex);
             }, 1500); // 1.5ç§’å¾…æ©Ÿ
        }
      });
      
      // --- ãƒœã‚¿ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ ---
      selectAllBtn.addEventListener('click', () => {
        cm.focus();
        cm.execCommand("selectAll");
        showMessage("å…¨é¸æŠã—ã¾ã—ãŸ", "info");
      });
      deselectAllBtn.addEventListener('click', () => {
        cm.setSelection(cm.getCursor(), cm.getCursor());
        showMessage("å…¨é¸æŠã‚’è§£é™¤ã—ã¾ã—ãŸ", "info");
      });
      copyBtn.addEventListener('click', () => {
        const text = cm.getSelection() || cm.getValue();
        navigator.clipboard.writeText(text)
          .then(() => showMessage("ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ", "success"))
          .catch(err => showMessage("ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ", "error"));
      });
      pasteBtn.addEventListener('click', () => {
        navigator.clipboard.readText()
          .then(text => {
            cm.replaceSelection(text);
            showMessage("è²¼ã‚Šä»˜ã‘ã¾ã—ãŸ", "success");
            controlsDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
          })
          .catch(err => {
             showMessage("è²¼ã‚Šä»˜ã‘ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒè¨±å¯ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚", "error");
          });
      });
      clearAllBtn.addEventListener('click', () => {
        if (confirm("æœ¬å½“ã«ã‚¨ãƒ‡ã‚£ã‚¿ã®å†…å®¹ã‚’ã™ã¹ã¦å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
          cm.setValue("");
          // ã‚¿ãƒ–ã®å†…å®¹ã‚‚ã‚¯ãƒªã‚¢ã—ã€ä¿å­˜
          if (tabs[activeTabIndex]) {
              tabs[activeTabIndex].code = "";
              saveTabs();
          }
          showMessage("å…¨ã¦å‰Šé™¤ã—ã¾ã—ãŸ", "info");
        }
      });
      undoBtn.addEventListener('click', () => {
        cm.undo();
        showMessage("å…ƒã«æˆ»ã—ã¾ã—ãŸ", "info");
      });
      redoBtn.addEventListener('click', () => {
        cm.redo();
        showMessage("ã‚„ã‚Šç›´ã—ã¾ã—ãŸ", "info");
      });
      openFileBtn.addEventListener('click', () => fileInput.click());
      fileInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = (evt) => {
            const content = evt.target.result;
            const fileName = file.name;
            let fileMode = 'htmlmixed';
            
            // ãƒ•ã‚¡ã‚¤ãƒ«æ‹¡å¼µå­ã«åŸºã¥ã„ã¦ãƒ¢ãƒ¼ãƒ‰ã‚’è¨­å®š
            if (fileName.endsWith('.css')) fileMode = 'css';
            else if (fileName.endsWith('.js')) fileMode = 'javascript';
            else if (fileName.endsWith('.xml')) fileMode = 'xml';
            else if (!fileName.endsWith('.html') && !fileName.endsWith('.htm')) fileMode = null;
            
            // æ–°è¦ã‚¿ãƒ–ã¨ã—ã¦ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é–‹ã
            addTab(fileName, content, fileMode);
            
            // â­ï¸æ–°æ©Ÿèƒ½â­ï¸: èª­ã¿è¾¼ã¿ç›´å¾Œã«<title>ã‚’ãƒã‚§ãƒƒã‚¯
            updateTabTitleFromContent(content, activeTabIndex); 
            
            showMessage(`ãƒ•ã‚¡ã‚¤ãƒ«ã€Œ${fileName}ã€ã‚’é–‹ãã¾ã—ãŸ`, "success");
            controlsDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
          };
          reader.readAsText(file);
        }
        fileInput.value = '';
      });
      saveBtn.addEventListener('click', () => {
        const currentMode = cm.getOption('mode');
        // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚¿ãƒ–ã®ã‚¿ã‚¤ãƒˆãƒ«ã‚’ãƒ•ã‚¡ã‚¤ãƒ«åã«åˆ©ç”¨
        const currentTitle = tabs[activeTabIndex].title;
        let fileName = currentTitle, fileType;
        
        let inferredMode = currentMode;
        
        // ãƒ¢ãƒ¼ãƒ‰ã¾ãŸã¯ã‚¿ãƒ–ã®ã‚¿ã‚¤ãƒˆãƒ«ã‹ã‚‰ãƒ•ã‚¡ã‚¤ãƒ«ã‚¿ã‚¤ãƒ—ã‚’æ¨æ¸¬
        if (currentTitle.toLowerCase().endsWith('.css')) { inferredMode = 'css'; }
        else if (currentTitle.toLowerCase().endsWith('.js')) { inferredMode = 'javascript'; }
        else if (currentTitle.toLowerCase().endsWith('.xml')) { inferredMode = 'xml'; }
        else if (currentTitle.toLowerCase().endsWith('.html') || currentTitle.toLowerCase().endsWith('.htm')) { inferredMode = 'htmlmixed'; }

        switch (inferredMode) {
          case 'css': fileName = currentTitle.endsWith('.css') ? currentTitle : currentTitle.split('.')[0] + ".css"; fileType = "text/css"; break;
          case 'javascript': fileName = currentTitle.endsWith('.js') ? currentTitle : currentTitle.split('.')[0] + ".js"; fileType = "application/javascript"; break;
          case 'xml': fileName = currentTitle.endsWith('.xml') ? currentTitle : currentTitle.split('.')[0] + ".xml"; fileType = "application/xml"; break;
          case 'htmlmixed':
          default: fileName = (currentTitle.endsWith('.html') || currentTitle.endsWith('.htm')) ? currentTitle : currentTitle.split('.')[0] + ".html"; fileType = "text/html"; break;
        }

        const blob = new Blob([cm.getValue()], { type: fileType });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = fileName;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        showMessage("ä¿å­˜ã—ã¾ã—ãŸ", "success");
      });
      runBtn.addEventListener('click', () => {
        const blob = new Blob([cm.getValue()], { type: "text/html" });
        const url = URL.createObjectURL(blob);
        window.open(url, "_blank");
        showMessage("ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã—ã¾ã—ãŸ", "info");
      });
      scrollToCursorBtn.addEventListener('click', () => {
        cm.scrollIntoView(null, 20);
        showMessage("ã‚«ãƒ¼ã‚½ãƒ«ä½ç½®ã¸ç§»å‹•ã—ã¾ã—ãŸ", "info");
      });
      
      // â­ï¸æ¤œç´¢ãƒ»ç½®æ›æ©Ÿèƒ½ã®æ”¹å–„â­ï¸
      findBtn.addEventListener('click', () => {
        cm.execCommand("find");
        showMessage("æ¤œç´¢ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤ºã€‚ä¸€è‡´ç®‡æ‰€ã¯ãƒã‚¤ãƒ©ã‚¤ãƒˆã•ã‚Œã€ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã«è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚", "info");
      });
      replaceBtn.addEventListener('click', () => {
        cm.execCommand("replace");
        showMessage("ç½®æ›ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤ºã€‚ä¸€è‡´ç®‡æ‰€ã¯ãƒã‚¤ãƒ©ã‚¤ãƒˆã•ã‚Œã€ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã«è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚", "info");
      });

      commentBtn.addEventListener('click', () => {
        cm.toggleComment();
        showMessage("ã‚³ãƒ¡ãƒ³ãƒˆã®åˆ‡ã‚Šæ›¿ãˆã‚’è¡Œã„ã¾ã—ãŸ", "info");
      });
      helpBtn.addEventListener('click', () => helpModal.style.display = 'block');

      columnRadios.forEach(radio => {
        radio.addEventListener('change', (event) => updateButtonColumns(event.target.value));
      });

      saveFavoriteBtn.addEventListener('click', () => {
        const title = prompt("ãŠæ°—ã«å…¥ã‚Šã®ã‚¿ã‚¤ãƒˆãƒ«ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:", tabs[activeTabIndex].title); // â­ï¸ã‚¿ãƒ–åã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«
        if (title) {
          const favorites = loadFavorites();
          favorites.unshift({
            title: title,
            code: cm.getValue(),
            date: new Date().toLocaleDateString('ja-JP', {
              year: 'numeric',
              month: '2-digit',
              day: '2-digit',
              hour: '2-digit',
              minute: '2-digit'
            })
          });
          saveFavorites(favorites);
          showMessage(`ã€Œ${title}ã€ã‚’ãŠæ°—ã«å…¥ã‚Šã«è¿½åŠ ã—ã¾ã—ãŸ`, "success");
        } else if (title === "") {
          showMessage("ã‚¿ã‚¤ãƒˆãƒ«ãŒå…¥åŠ›ã•ã‚Œã¦ã„ã¾ã›ã‚“", "error");
        }
      });

      showFavoritesBtn.addEventListener('click', () => {
        displayFavorites();
        favoritesModal.style.display = 'block';
      });

      favoritesList.addEventListener('click', (event) => {
        const li = event.target.closest('li');
        if (!li) return;
        const index = li.dataset.index;
        if (event.target.closest('.delete-btn')) {
          if (confirm("ã“ã®ãŠæ°—ã«å…¥ã‚Šã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
            const favorites = loadFavorites();
            const deletedTitle = favorites[index].title;
            favorites.splice(index, 1);
            saveFavorites(favorites);
            displayFavorites();
            showMessage(`ã€Œ${deletedTitle}ã€ã‚’å‰Šé™¤ã—ã¾ã—ãŸ`, "info");
          }
        } else {
          const favorites = loadFavorites();
          const selectedCode = favorites[index].code;
          const title = favorites[index].title;
          
          let favMode = 'htmlmixed';
          // ãƒ•ã‚¡ã‚¤ãƒ«åã‹ã‚‰ãƒ¢ãƒ¼ãƒ‰ã‚’æ¨æ¸¬ï¼ˆç°¡æ˜“çš„ï¼‰
          if (title.toLowerCase().endsWith('.css')) favMode = 'css';
          else if (title.toLowerCase().endsWith('.js')) favMode = 'javascript';
          else if (title.toLowerCase().endsWith('.xml')) favMode = 'xml';
          else if (!title.toLowerCase().endsWith('.html') && !title.toLowerCase().endsWith('.htm')) favMode = null;

          // ãŠæ°—ã«å…¥ã‚Šã‚’æ–°ã—ã„ã‚¿ãƒ–ã¨ã—ã¦é–‹ã
          addTab(title, selectedCode, favMode);
          
          // â­ï¸æ–°æ©Ÿèƒ½â­ï¸: èª­ã¿è¾¼ã¿ç›´å¾Œã«<title>ã‚’ãƒã‚§ãƒƒã‚¯
          updateTabTitleFromContent(selectedCode, activeTabIndex);

          favoritesModal.style.display = 'none';
          showMessage(`ã€Œ${title}ã€ã‚’æ–°ã—ã„ã‚¿ãƒ–ã«èª­ã¿è¾¼ã¿ã¾ã—ãŸ`, "success");
        }
      });
      
      // --- ã‚¿ãƒ–ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ ---
      addTabBtn.addEventListener('click', () => addTab());
      
    }

    initialize();
  </script>
</body>
</html>
