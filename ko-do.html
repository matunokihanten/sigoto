<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>高機能HTMLエディタ</title>
  <!-- CodeMirror の CSS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/codemirror.min.css">
  <!-- CodeMirror ダークテーマ -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/theme/dracula.min.css">
  <!-- ダイアログ用 CSS（検索・置換用） -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/addon/dialog/dialog.min.css">
  <style>
    /* 全体レイアウト */
    body { margin: 0; font-family: sans-serif; }
    #container { display: flex; flex-direction: column; height: 100vh; }
    /* 上部操作バー */
    #topbar {
      padding: 5px;
      background-color: #ddd;
      display: flex;
      align-items: center;
      flex-wrap: wrap;
      gap: 5px;
      border-bottom: 1px solid #ccc;
    }
    #topbar input[type="text"] { padding: 5px; font-size: 1em; }
    #topbar button { padding: 5px 8px; cursor: pointer; }
    /* エディタ＆プレビュー領域 */
    #content { flex: 1; display: flex; overflow: hidden; }
    #editorContainer, #previewContainer { height: 100%; }
    #editorContainer { width: 100%; }
    /* プレビュー領域：初期は非表示 */
    #previewContainer { width: 50%; position: relative; overflow: auto; display: none; }
    /* iframe によるプレビュー表示 */
    #previewFrame {
      width: 100%;
      height: 100%;
      border: none;
      transform: scale(0.8);
      transform-origin: top left;
    }
    /* 操作説明モーダル */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
    }
    .modal-content {
      background-color: #fff;
      margin: 10% auto;
      padding: 20px;
      width: 80%;
      position: relative;
      border-radius: 4px;
    }
    .modal-close { position: absolute; right: 10px; top: 10px; cursor: pointer; font-size: 20px; }
    /* ダークモード用 */
    .dark { background-color: #333; color: #eee; }
    .dark #topbar { background-color: #555; }
    .dark .modal-content { background-color: #666; color: #fff; }
    /* 検索で見つかった文字のハイライト */
    .search-highlight { background-color: yellow !important; }
  </style>
</head>
<body>
  <div id="container">
    <!-- 上部操作バー：ファイル名入力、各種ボタン -->
    <div id="topbar">
      <input type="text" id="fileName" placeholder="ファイル名">
      <button id="autoFormatBtn">自動整形</button>
      <button id="lintCheckBtn">Lintチェック</button>
      <button id="minifyBtn">コード短縮</button>
      <button id="themeToggleBtn">テーマ切替</button>
      <button id="clearAllBtn">全削除</button>
      <button id="loadHtmlBtn">HTMLファイル読み込み</button>
      <button id="downloadFileBtn">HTML保存</button>
      <button id="downloadPdfBtn">PDF保存</button>
      <button id="togglePreviewBtn">プレビュー表示</button>
      <button id="searchReplaceBtn">検索/置換</button>
      <button id="showHelpBtn">操作説明</button>
      <!-- HTMLファイル読み込み用非表示入力 -->
      <input type="file" id="htmlFileInput" style="display:none;" accept=".html">
    </div>
    <!-- エディタ＆プレビュー領域 -->
    <div id="content">
      <div id="editorContainer">
        <textarea id="codeEditor"></textarea>
      </div>
      <div id="previewContainer">
        <iframe id="previewFrame" sandbox="allow-same-origin"></iframe>
      </div>
    </div>
  </div>
  
  <!-- 操作説明モーダル -->
  <div id="modal" class="modal">
    <div class="modal-content">
      <span id="modalClose" class="modal-close">&times;</span>
      <h2>操作説明</h2>
      <p>
        このエディタは、HTMLコードの入力・編集、リアルタイムプレビュー、コードの自動整形、Lintチェック、<br>
        そしてコード短縮（余分な改行や空白の削除）機能を備えています。<br>
        ファイル名欄に保存したい名前を入力し、HTMLまたはPDFとして保存が可能です。<br>
        「検索/置換」ボタンを押すと、検索文字列を入力するダイアログが表示され、<br>
        一致した文字列は黄色にハイライトされた状態で残ります。（置換も実行可能です）
      </p>
    </div>
  </div>
  
  <!-- 各種ライブラリ読み込み -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/codemirror.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/mode/htmlmixed/htmlmixed.min.js"></script>
  <!-- 検索／置換用ダイアログ -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/addon/search/searchcursor.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/addon/search/search.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/addon/dialog/dialog.min.js"></script>
  <!-- 自動整形・Lintチェック -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/js-beautify/1.14.0/beautify-html.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/htmlhint/0.10.0/htmlhint.min.js"></script>
  <!-- PDF保存用ライブラリ -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  
  <!-- メインスクリプト -->
  <script>
    // persistent search markers 用の配列
    var searchMarkers = [];
    
    // CodeMirror エディタ初期化（コード補完／インテリセンスは削除）
    var codeEditor = CodeMirror.fromTextArea(document.getElementById("codeEditor"), {
      mode: "htmlmixed",
      lineNumbers: true,
      theme: "default",
      tabSize: 2
    });
    codeEditor.setSize("100%", "100%");
    
    // リアルタイムプレビュー更新
    function updatePreview() {
      var previewFrame = document.getElementById("previewFrame");
      previewFrame.srcdoc = codeEditor.getValue();
    }
    codeEditor.on("change", updatePreview);
    updatePreview();
    
    // HTMLファイル読み込み
    document.getElementById("loadHtmlBtn").addEventListener("click", function() {
      document.getElementById("htmlFileInput").click();
    });
    document.getElementById("htmlFileInput").addEventListener("change", function(event) {
      var file = event.target.files[0];
      if (file) {
        var reader = new FileReader();
        reader.onload = function(e) {
          codeEditor.setValue(e.target.result);
          updatePreview();
          document.getElementById("fileName").value = file.name;
        };
        reader.readAsText(file);
      }
    });
    
    // HTML保存：ファイル名にピリオドがなければ ".html" を付与
    document.getElementById("downloadFileBtn").addEventListener("click", function() {
      var fileName = document.getElementById("fileName").value.trim() || "タイトル無";
      if (fileName.indexOf('.') === -1) { fileName += ".html"; }
      var blob = new Blob([codeEditor.getValue()], { type: "text/html" });
      var a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = fileName;
      a.click();
    });
    
    // PDF保存：プレビュー表示中でないと警告
    document.getElementById("downloadPdfBtn").addEventListener("click", function() {
      var previewContainer = document.getElementById("previewContainer");
      if (previewContainer.style.display === "none" || previewContainer.style.display === "") {
        alert("PDF保存するには、まずプレビューを表示してください。");
        return;
      }
      var previewDoc = document.getElementById("previewFrame").contentDocument.body;
      var pdfFileName = document.getElementById("fileName").value.trim() || "document";
      if (pdfFileName.indexOf('.') === -1) { pdfFileName += ".pdf"; }
      var opt = {
        margin: 0.5,
        filename: pdfFileName,
        image: { type: 'png', quality: 0.98 },
        html2canvas: { scale: 2 },
        jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
      };
      html2pdf().set(opt).from(previewDoc).save();
    });
    
    // 自動整形（js-beautify 利用）
    document.getElementById("autoFormatBtn").addEventListener("click", function() {
      var formatted = html_beautify(codeEditor.getValue());
      codeEditor.setValue(formatted);
      updatePreview();
    });
    
    // Lintチェック（HTMLHint 利用）
    document.getElementById("lintCheckBtn").addEventListener("click", function() {
      var results = HTMLHint.verify(codeEditor.getValue());
      if (results.length > 0) {
        alert("Lintエラー:\n" + results.map(r => r.message + " (Line " + r.line + ")").join("\n"));
      } else {
        alert("Lintチェック: エラーはありません。");
      }
    });
    
    // コード短縮（Minify）機能
    function minifyCode(code) {
      return code
        .replace(/<!--[\s\S]*?-->/g, "")  // コメント削除
        .replace(/\n/g, "")               // 改行削除
        .replace(/\s\s+/g, " ")           // 連続空白を1つに
        .replace(/>\s+</g, "><")          // タグ間の空白削除
        .trim();
    }
    document.getElementById("minifyBtn").addEventListener("click", function() {
      var original = codeEditor.getValue();
      var minified = minifyCode(original);
      codeEditor.setValue(minified);
      updatePreview();
      alert("コードが短縮されました。");
    });
    
    // テーマ切替
    var isDarkMode = false;
    document.getElementById("themeToggleBtn").addEventListener("click", function() {
      isDarkMode = !isDarkMode;
      if (isDarkMode) {
        document.body.classList.add("dark");
        codeEditor.setOption("theme", "dracula");
      } else {
        document.body.classList.remove("dark");
        codeEditor.setOption("theme", "default");
      }
    });
    
    // 全削除（コードクリア）
    document.getElementById("clearAllBtn").addEventListener("click", function() {
      if (confirm("すべてのコードを削除しますか？")) {
        codeEditor.setValue("");
        updatePreview();
      }
    });
    
    // 検索/置換機能（永続的ハイライト付き）
    document.getElementById("searchReplaceBtn").addEventListener("click", function() {
      // 既存のハイライトをクリア
      searchMarkers.forEach(function(marker) { marker.clear(); });
      searchMarkers = [];
      
      var searchQuery = window.prompt("検索文字列を入力してください：", "");
      if (!searchQuery) { return; }
      
      // 検索して一致箇所をマーク（markText）
      var cursor = codeEditor.getSearchCursor(searchQuery, { line: 0, ch: 0 });
      while (cursor.findNext()) {
        var marker = codeEditor.markText(cursor.from(), cursor.to(), { className: "search-highlight", clearWhenEmpty: false });
        searchMarkers.push(marker);
      }
      
      // 置換を行うか確認（キャンセルならハイライトはそのまま）
      var replaceQuery = window.prompt("置換文字列を入力してください（キャンセルで置換なし）：", "");
      if (replaceQuery !== null) {
        // すべての一致箇所を置換
        var content = codeEditor.getValue();
        // 正規表現用に検索文字列をエスケープ
        var escapedSearch = searchQuery.replace(/[-[\]{}()*+?.,\\^$|#\s]/g, '\\$&');
        var re = new RegExp(escapedSearch, "g");
        var newContent = content.replace(re, replaceQuery);
        codeEditor.setValue(newContent);
        updatePreview();
        
        // 置換後もハイライトを残すため、再度検索文字列として置換後の値を用いてハイライト
        searchMarkers.forEach(function(marker) { marker.clear(); });
        searchMarkers = [];
        var newCursor = codeEditor.getSearchCursor(replaceQuery, { line: 0, ch: 0 });
        while (newCursor.findNext()) {
          var newMarker = codeEditor.markText(newCursor.from(), newCursor.to(), { className: "search-highlight", clearWhenEmpty: false });
          searchMarkers.push(newMarker);
        }
      }
    });
    
    // プレビューの表示／非表示切替
    document.getElementById("togglePreviewBtn").addEventListener("click", function() {
      var previewContainer = document.getElementById("previewContainer");
      var editorContainer = document.getElementById("editorContainer");
      if (previewContainer.style.display === "none" || previewContainer.style.display === "") {
        previewContainer.style.display = "block";
        editorContainer.style.width = "50%";
        this.textContent = "プレビュー非表示";
        updatePreview();
      } else {
        previewContainer.style.display = "none";
        editorContainer.style.width = "100%";
        this.textContent = "プレビュー表示";
      }
    });
    
    // 操作説明モーダルの表示／非表示
    var modal = document.getElementById("modal");
    document.getElementById("showHelpBtn").addEventListener("click", function() { modal.style.display = "block"; });
    document.getElementById("modalClose").addEventListener("click", function() { modal.style.display = "none"; });
    window.addEventListener("click", function(event) { if (event.target == modal) { modal.style.display = "none"; } });
  </script>
</body>
</html>
