<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>è±ªè¯ãƒ¢ãƒ¼ãƒ‰å°‚ç”¨ HTMLã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼</title>
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.css" />
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/theme/material-darker.min.css" />
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/search/matchesonscrollbar.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/dialog/dialog.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/fold/foldgutter.min.css">
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  
  <style>
    /* ğŸ¨ PCã¨ãƒ¢ãƒã‚¤ãƒ«ã®ä¸¡æ–¹ã«å¯¾å¿œã™ã‚‹ãŸã‚ã®å¤‰æ•°ã¨åŸºæœ¬è¨­å®š */
    :root {
      /* PCç”¨: ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ(è±ªè¯ãƒ¢ãƒ¼ãƒ‰)ã®ãƒœã‚¿ãƒ³ã®åˆ—æ•°ã¨ã‚µã‚¤ã‚º */
      --control-cols: 5; 
      --control-gap: 5px;
      --control-padding: 10px;
    }
    
    body {
      margin: 0;
      font-family: sans-serif;
      display: flex;
      flex-direction: column;
      /* ç”»é¢å…¨ä½“ã«ãƒ•ã‚£ãƒƒãƒˆ */
      height: 100vh;
      box-sizing: border-box;
      /* ğŸ› ï¸ ä¿®æ­£: ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’ç¦æ­¢ */
      overflow: hidden; 
      /* iOS ã® Safe Area ã«å¯¾å¿œ */
      padding-top: env(safe-area-inset-top);
      padding-bottom: env(safe-area-inset-bottom);
      padding-left: env(safe-area-inset-left);
      padding-right: env(safe-area-inset-right);
      
      /* è±ªè¯ãƒ¢ãƒ¼ãƒ‰ã®èƒŒæ™¯ */
      background-color: #1e1e1e; 
      color: #eee;
    }

    /* ğŸ“± ãƒ¢ãƒã‚¤ãƒ«å„ªå…ˆã®è¨­å®š */
    @media (max-width: 768px) {
      :root {
        --control-cols: 3; /* ãƒ¢ãƒã‚¤ãƒ«ã§ã¯3åˆ—ã« */
        --control-gap: 4px;
        --control-padding: 8px;
      }

      #messageArea {
          top: 10px; /* ä¸Šéƒ¨ã‹ã‚‰å°‘ã—é›¢ã™ */
          right: 50%;
          transform: translateX(50%); /* ä¸­å¤®é…ç½® */
          font-size: 0.8em;
          padding: 6px 10px;
          white-space: normal;
          width: 80%;
      }
      #messageArea.show {
          transform: translateX(50%) translateY(0);
      }
      #messageArea:not(.show) {
          transform: translateX(50%) translateY(-20px);
      }
    }

    /* ---------------------------------- */
    /* --- âš™ï¸ ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ‘ãƒãƒ« --- */
    /* ---------------------------------- */
    .controls {
      padding: var(--control-padding);
      background-color: #333; /* æš—ã„èƒŒæ™¯è‰² */
      display: grid; 
      grid-template-columns: repeat(var(--control-cols), 1fr); /* åˆ—æ•°ã«åˆã‚ã›ãŸã‚°ãƒªãƒƒãƒ‰ */
      gap: var(--control-gap);
      position: relative; 
      z-index: 10; 
      box-shadow: 0 2px 5px rgba(0,0,0,0.3); 
      order: 1; 
      width: 100%;
      box-sizing: border-box;
    }
    .controls button {
      padding: 8px 10px;
      cursor: pointer;
      border: 1px solid #555;
      border-radius: 4px;
      background-color: #444;
      color: #eee;
      transition: background-color 0.2s, box-shadow 0.2s, color 0.2s, border-color 0.2s;
      font-size: 0.85em;
      line-height: 1.2;
      white-space: nowrap; 
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .controls button:hover {
      background-color: #555;
      box-shadow: 0 0 8px rgba(255, 255, 255, 0.1);
    }
    .controls button i {
      margin-right: 5px;
    }

    /* ç‰¹å®šã®ãƒœã‚¿ãƒ³ã‚’å¼·èª¿ã™ã‚‹ã‚¹ã‚¿ã‚¤ãƒ« */
    .controls button.prominent {
      background-color: #007bff; 
      border-color: #007bff;
      color: white;
    }
    .controls button.prominent:hover {
      background-color: #0056b3;
      border-color: #0056b3;
    }
    .controls button#runBtn {
        background-color: #28a745; 
        border-color: #28a745;
        font-weight: bold;
        color: white;
    }
    .controls button#runBtn:hover {
        background-color: #1e7e34;
        border-color: #1e7e34;
    }
    .controls button#clearAllBtn {
        background-color: #dc3545; 
        border-color: #dc3545;
        color: white;
    }
    .controls button#clearAllBtn:hover {
        background-color: #c82333;
        border-color: #c82333;
    }

    /* ğŸ” æ¤œç´¢ãƒãƒ¼ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    #searchBar {
      grid-column: 1 / -1; 
      display: flex;
      gap: var(--control-gap);
      padding: 5px 0;
      border-top: 1px solid #555;
      margin-top: 5px;
    }
    #searchBar input[type="text"] {
      padding: 8px;
      border: 1px solid #555;
      border-radius: 4px;
      flex-grow: 1;
      background-color: #222;
      color: #eee;
    }
    #searchBar button {
        flex-shrink: 0;
        padding: 8px 12px;
        font-size: 0.9em;
    }
    #searchStats {
        display: flex;
        align-items: center;
        color: #ccc;
        font-size: 0.8em;
        padding-left: 5px;
    }

    /* ğŸ’¬ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¨ãƒªã‚¢ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    #messageArea {
      position: absolute;
      right: 10px;
      top: 50%; 
      transform: translateY(-50%); 
      padding: 8px 15px;
      font-size: 0.85em;
      white-space: nowrap;
      background-color: rgba(0, 0, 0, 0.7);
      color: white;
      border-radius: 5px;
      opacity: 0;
      transition: opacity 0.4s ease-out, transform 0.4s ease-out, background-color 0.4s ease;
      z-index: 100; 
      pointer-events: none; 
    }
    #messageArea.show {
        opacity: 1;
        transform: translateY(-50%) translateX(0);
    }
    #messageArea:not(.show) {
        transform: translateY(-50%) translateX(20px); 
    }
    #messageArea.success {
        background-color: #28a745;
    }
    #messageArea.error {
        background-color: #dc3545;
    }
    #messageArea.info {
        background-color: #17a2b8;
    }

    /* ğŸ–¥ï¸ ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼é ˜åŸŸ */
    .editor {
      flex: 1; /* æ®‹ã‚Šã®é«˜ã•ã‚’å…¨ã¦å ã‚ã‚‹ */
      overflow: hidden; /* ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼è‡ªä½“ã®è¦ªã‚³ãƒ³ãƒ†ãƒŠã¯overflowã‚’ç¦æ­¢ */
      order: 3;
    }
    /* CodeMirrorã‚¹ã‚¿ã‚¤ãƒ« */
    .CodeMirror {
      height: 100%; /* è¦ª (.editor) ã®é«˜ã•ã«åˆã‚ã›ã‚‹ */
      border: none; 
      border-top: 1px solid #555; 
      font-size: 14px; 
    }
    .CodeMirror-gutters {
        background-color: #2a2a2a; 
        border-right: 1px solid #555;
    }
    .CodeMirror-linenumber {
        color: #888;
    }
    .CodeMirror-activeline-background {
        background: #3c3c3c; 
    }
    .CodeMirror-search-match {
        background-color: #ff0;
        color: #000;
        border-radius: 2px;
        padding: 0 1px;
    }

    /* --- ğŸ“‘ ã‚¿ãƒ–æ©Ÿèƒ½ã®ã‚¹ã‚¿ã‚¤ãƒ« --- */
    .tab-bar {
      display: flex;
      flex-wrap: nowrap;
      overflow-x: auto;
      padding: 0 10px;
      background-color: #222;
      border-bottom: 1px solid #555;
      white-space: nowrap;
      scrollbar-width: none; 
      order: 2; 
    }
    .tab-bar::-webkit-scrollbar {
      display: none; 
    }
    .tab {
      display: flex;
      align-items: center;
      padding: 8px 12px;
      cursor: pointer;
      background-color: #444;
      border: 1px solid #555;
      border-bottom: none;
      margin-right: 5px;
      border-radius: 6px 6px 0 0;
      font-size: 0.9em;
      transition: background-color 0.2s, color 0.2s, border-color 0.2s;
      min-width: 100px;
      max-width: 200px;
      color: #eee;
    }
    .tab.active {
      background-color: #1e1e1e; 
      border-color: #007bff;
      color: #007bff;
      font-weight: bold;
      border-bottom: 1px solid #1e1e1e; 
    }
    .tab:hover:not(.active) {
      background-color: #555;
    }
    .tab-title {
        flex-grow: 1;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        padding-right: 8px;
    }
    .tab-close {
      margin-left: 8px;
      background: none;
      border: none;
      color: #ccc;
      cursor: pointer;
      font-size: 1.1em;
      padding: 0;
      line-height: 1;
      transition: color 0.2s;
    }
    .tab-close:hover {
      color: #fff;
    }
    .add-tab-btn {
      background-color: #333;
      color: #eee;
      border: none;
      padding: 8px 12px;
      border-radius: 6px 6px 0 0;
      margin-left: auto;
      cursor: pointer;
      transition: background-color 0.2s;
      font-size: 1em;
      line-height: 1;
    }
    .add-tab-btn:hover {
        background-color: #444;
    }

  </style>
</head>
<body>
  
  <div class="controls" id="controlsPanel"> 
    <div id="messageArea"></div>

    <button id="selectAllBtn"><i class="fas fa-mouse-pointer"></i> å…¨é¸æŠ</button>
    <button id="copyBtn"><i class="fas fa-copy"></i> ã‚³ãƒ”ãƒ¼</button>
    <button id="pasteBtn" class="prominent"><i class="fas fa-paste"></i> è²¼ä»˜ã‘</button>
    <button id="clearAllBtn" class="prominent"><i class="fas fa-trash-alt"></i> å…¨å‰Šé™¤</button>
    <button id="openFileBtn"><i class="fas fa-folder-open"></i> é–‹ã</button>
    <input type="file" id="fileInput" accept=".html,.css,.js,.txt,.xml" style="display:none">
    <button id="saveBtn"><i class="fas fa-file-download"></i> ä¿å­˜ (HTML)</button>
    <button id="saveTxtBtn"><i class="fas fa-file-alt"></i> ä¿å­˜ (TXT)</button>
    <button id="runBtn" style="grid-column: span 1 / span 1;"><i class="fas fa-play"></i> å®Ÿè¡Œ</button>
    
    <button id="undoBtn"><i class="fas fa-undo"></i> å…ƒã«æˆ»ã™</button>
    <button id="redoBtn"><i class="fas fa-redo"></i> ã‚„ã‚Šç›´ã—</button>
    <button id="searchBtn"><i class="fas fa-search"></i> æ¢ã™</button>
    <button id="replaceBtn"><i class="fas fa-exchange-alt"></i> ç½®æ›</button>
    <button id="prevMatchBtn" disabled><i class="fas fa-arrow-up"></i> å‰ã¸</button>
    <button id="nextMatchBtn" disabled><i class="fas fa-arrow-down"></i> æ¬¡ã¸</button>

    <div id="searchBar" style="display: none;">
        <input type="text" id="searchInput" placeholder="æ¤œç´¢ã™ã‚‹æ–‡å­—åˆ—">
        <button id="searchNextBtn" title="æ¬¡ã‚’æ¤œç´¢"><i class="fas fa-arrow-down"></i></button>
        <button id="searchPrevBtn" title="å‰ã‚’æ¤œç´¢"><i class="fas fa-arrow-up"></i></button>
        <button id="replaceOneBtn" disabled>ç½®æ›</button>
        <button id="replaceAllBtn" disabled>å…¨ã¦ç½®æ›</button>
        <span id="searchStats">0/0</span>
        <button id="closeSearchBtn" title="é–‰ã˜ã‚‹"><i class="fas fa-times"></i></button>
    </div>
  </div>

  <div class="tab-bar" id="tabBar">
    <button id="addTabBtn" class="add-tab-btn" title="æ–°ã—ã„ã‚¿ãƒ–ã‚’è¿½åŠ "><i class="fas fa-plus"></i></button>
  </div>

  <div class="editor">
    <textarea id="htmlCode" placeholder="ã“ã“ã«HTMLã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"></textarea>
  </div>


  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.js"></script>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/htmlmixed/htmlmixed.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/xml/xml.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/javascript/javascript.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/css/css.min.js"></script>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/search/searchcursor.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/search/search.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/dialog/dialog.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/search/jump-to-line.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/search/matchesonscrollbar.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/edit/matchbrackets.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/edit/closebrackets.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/edit/closetag.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/edit/matchtags.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/edit/trailingspace.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/selection/active-line.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/fold/foldcode.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/fold/foldgutter.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/fold/brace-fold.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/fold/xml-fold.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/fold/indent-fold.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/fold/comment-fold.min.js"></script>


  <script>
    // --- å®šæ•°ã¨ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•° ---
    const STORAGE_KEY_TABS = "editorTabs_v3";
    const STORAGE_KEY_ACTIVE_TAB = "editorActiveTab_v3";
    const titleRegex = /<title\b[^>]*>([\s\S]*?)<\/title>/i; 
    let autoSaveTimer;
    let titleUpdateTimer;

    // --- CodeMirrorã‚ªãƒ—ã‚·ãƒ§ãƒ³ (è±ªè¯ãƒ¢ãƒ¼ãƒ‰å›ºå®š) ---
    const deluxeOptions = {
        theme: "material-darker",
        mode: "htmlmixed",
        lineNumbers: true,
        autofocus: true,
        matchBrackets: true,
        autoCloseBrackets: true,
        autoCloseTags: true,
        matchTags: { both: true },
        styleActiveLine: true,
        showTrailingSpace: true,
        foldGutter: true,
        gutters: ["CodeMirror-linenumbers", "CodeMirror-foldgutter"],
        highlightSelectionMatches: { showToken: /\w/ } 
    };

    // --- ã‚¿ãƒ–ç®¡ç†ç”¨å¤‰æ•° ---
    let tabs = [];
    let activeTabIndex = 0;
    let tabIdCounter = 1;

    // CodeMirror ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼ã®åˆæœŸåŒ–
    var cm = CodeMirror.fromTextArea(document.getElementById('htmlCode'), deluxeOptions);

    // --- è¦ç´ ã®å–å¾— ---
    const selectAllBtn = document.getElementById('selectAllBtn');
    const copyBtn = document.getElementById('copyBtn');
    const pasteBtn = document.getElementById('pasteBtn');
    const clearAllBtn = document.getElementById('clearAllBtn');
    const openFileBtn = document.getElementById('openFileBtn');
    const fileInput = document.getElementById('fileInput');
    const saveBtn = document.getElementById('saveBtn');
    const saveTxtBtn = document.getElementById('saveTxtBtn'); 
    const runBtn = document.getElementById('runBtn');
    const undoBtn = document.getElementById('undoBtn');
    const redoBtn = document.getElementById('redoBtn');
    const messageArea = document.getElementById('messageArea');
    const controlsPanel = document.getElementById('controlsPanel');
    const tabBar = document.getElementById('tabBar');
    const addTabBtn = document.getElementById('addTabBtn');
    const searchBtn = document.getElementById('searchBtn');
    const replaceBtn = document.getElementById('replaceBtn');
    const prevMatchBtn = document.getElementById('prevMatchBtn');
    const nextMatchBtn = document.getElementById('nextMatchBtn');
    const searchBar = document.getElementById('searchBar');
    const searchInput = document.getElementById('searchInput');
    const searchNextBtn = document.getElementById('searchNextBtn');
    const searchPrevBtn = document.getElementById('searchPrevBtn');
    const replaceOneBtn = document.getElementById('replaceOneBtn');
    const replaceAllBtn = document.getElementById('replaceAllBtn');
    const searchStats = document.getElementById('searchStats');
    const closeSearchBtn = document.getElementById('closeSearchBtn');

    // --- ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•° ---

    /**
     * ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºé–¢æ•°
     * @param {string} msg - è¡¨ç¤ºã™ã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
     * @param {'success'|'error'|'info'} type - ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ç¨®é¡ (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 'info')
     */
    function showMessage(msg, type = 'info') {
      messageArea.textContent = msg;
      messageArea.className = 'show ' + type;

      clearTimeout(autoSaveTimer); 
      autoSaveTimer = setTimeout(() => {
        messageArea.className = '';
        messageArea.textContent = '';
      }, 2500); 
    }

    // --- ã‚¿ãƒ–æ©Ÿèƒ½ã®å®Ÿè£… ---
    
    /**
     * ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰ã‚¿ãƒ–ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€
     */
    function loadTabs() {
      const savedTabs = localStorage.getItem(STORAGE_KEY_TABS);
      const activeTabId = localStorage.getItem(STORAGE_KEY_ACTIVE_TAB);
      
      if (savedTabs) {
        tabs = JSON.parse(savedTabs);
        tabIdCounter = tabs.reduce((max, t) => Math.max(max, t.id), 0) + 1;
        const activeTab = tabs.find(t => t.id == activeTabId);
        activeTabIndex = activeTab ? tabs.indexOf(activeTab) : 0;
      }

      if (tabs.length === 0) {
        const oldCode = localStorage.getItem("htmlCode");
        tabs.push({ id: tabIdCounter++, title: 'Tab 1', code: oldCode || '', mode: 'htmlmixed' });
        localStorage.removeItem("htmlCode"); 
        activeTabIndex = 0;
      }
    }
    
    /**
     * ç¾åœ¨ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªã‚¿ãƒ–ã®å†…å®¹ã‚’CodeMirrorã«èª­ã¿è¾¼ã‚€
     */
    function loadActiveTabContent() {
        if (tabs[activeTabIndex]) {
            cm.setValue(tabs[activeTabIndex].code);
            cm.setOption('mode', tabs[activeTabIndex].mode);
            cm.focus();
            cm.getDoc().clearHistory(); 
        }
    }

    /**
     * ç¾åœ¨ã®ã‚¿ãƒ–ã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜ã™ã‚‹
     */
    function saveTabs() {
      if (tabs[activeTabIndex]) {
          tabs[activeTabIndex].code = cm.getValue();
          tabs[activeTabIndex].mode = cm.getOption('mode');
          localStorage.setItem(STORAGE_KEY_TABS, JSON.stringify(tabs));
          localStorage.setItem(STORAGE_KEY_ACTIVE_TAB, tabs[activeTabIndex].id);
      }
    }

    /**
     * æŒ‡å®šã—ãŸã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®ã‚¿ãƒ–ã«åˆ‡ã‚Šæ›¿ãˆã‚‹
     */
    function switchTab(index) {
      if (index === activeTabIndex || index < 0 || index >= tabs.length) return;

      tabs[activeTabIndex].code = cm.getValue();
      tabs[activeTabIndex].mode = cm.getOption('mode');

      activeTabIndex = index;
      
      loadActiveTabContent(); 
      renderTabs();
      saveTabs();
      showMessage(`ã‚¿ãƒ–ã€Œ${tabs[activeTabIndex].title}ã€ã«åˆ‡ã‚Šæ›¿ãˆã¾ã—ãŸ`, "info");
      hideSearchBar(); 
    }
    
    /**
     * æ–°ã—ã„ã‚¿ãƒ–ã‚’è¿½åŠ ã™ã‚‹
     */
    function addTab(title = null, code = '', mode = 'htmlmixed') {
      const newTitle = title || `Tab ${tabIdCounter}`;
      const newTab = { id: tabIdCounter++, title: newTitle, code: code, mode: mode };
      tabs.push(newTab);
      switchTab(tabs.length - 1); 
    }

    /**
     * æŒ‡å®šã—ãŸã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®ã‚¿ãƒ–ã‚’å‰Šé™¤ã™ã‚‹
     */
    function removeTab(index) {
      if (tabs.length === 1) {
        showMessage("æœ€å¾Œã®ã‚¿ãƒ–ã¯å‰Šé™¤ã§ãã¾ã›ã‚“", "error");
        return;
      }
      
      const removedTitle = tabs[index].title;
      tabs.splice(index, 1);
      
      if (index <= activeTabIndex) {
        activeTabIndex = Math.max(0, activeTabIndex - 1);
      }
      
      loadActiveTabContent();
      renderTabs();
      saveTabs();
      showMessage(`ã‚¿ãƒ–ã€Œ${removedTitle}ã€ã‚’å‰Šé™¤ã—ã¾ã—ãŸ`, "info");
      hideSearchBar();
    }

    /**
     * ã‚¿ãƒ–åã‚’å¤‰æ›´ã™ã‚‹
     */
    function renameTab(index) {
        const currentTitle = tabs[index].title;
        const newTitle = prompt("æ–°ã—ã„ã‚¿ãƒ–ã®ã‚¿ã‚¤ãƒˆãƒ«ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:", currentTitle);
        if (newTitle && newTitle.trim() !== "" && newTitle !== currentTitle) {
            tabs[index].title = newTitle.trim();
            renderTabs();
            saveTabs();
            showMessage(`ã‚¿ãƒ–åã‚’ã€Œ${newTitle.trim()}ã€ã«å¤‰æ›´ã—ã¾ã—ãŸ`, "success");
        } else if (newTitle === "") {
            showMessage("ã‚¿ã‚¤ãƒˆãƒ«ãŒå…¥åŠ›ã•ã‚Œã¦ã„ã¾ã›ã‚“", "error");
        }
    }

    /**
     * ç¾åœ¨ã®ã‚¿ãƒ–é…åˆ—ã«åŸºã¥ã„ã¦ã‚¿ãƒ–ãƒãƒ¼ã®UIã‚’æ§‹ç¯‰ã™ã‚‹
     */
    function renderTabs() {
      while (tabBar.firstChild && tabBar.firstChild !== addTabBtn) {
        tabBar.removeChild(tabBar.firstChild);
      }
      
      const fragment = document.createDocumentFragment();

      tabs.forEach((tab, index) => {
        const tabEl = document.createElement('div');
        tabEl.className = `tab ${index === activeTabIndex ? 'active' : ''}`;
        tabEl.dataset.index = index;
        tabEl.title = tab.title;

        const titleEl = document.createElement('span');
        titleEl.className = 'tab-title';
        titleEl.textContent = tab.title;
        
        const closeBtn = document.createElement('button');
        closeBtn.className = 'tab-close';
        closeBtn.title = 'é–‰ã˜ã‚‹';
        closeBtn.innerHTML = '&times;'; 
        
        tabEl.appendChild(titleEl);
        tabEl.appendChild(closeBtn);
        
        tabEl.addEventListener('click', (e) => {
            if (e.target !== closeBtn) {
                switchTab(index);
            }
        });
        
        closeBtn.addEventListener('click', () => removeTab(index));
        
        tabEl.addEventListener('dblclick', (e) => {
            if (e.target !== closeBtn) {
                renameTab(index);
            }
        });

        fragment.appendChild(tabEl);
      });
      
      tabBar.insertBefore(fragment, addTabBtn);
      
      const activeTabEl = tabBar.querySelector('.tab.active');
      if (activeTabEl) {
          activeTabEl.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'nearest' });
      }
    }
    
    /**
     * ã‚³ãƒ¼ãƒ‰ã®å†…å®¹ã‹ã‚‰<title>ã‚¿ã‚°ã‚’æŠ½å‡ºã—ã€ã‚¿ãƒ–åã‚’æ›´æ–°
     */
    function updateTabTitleFromContent(content, index) {
        if (!tabs[index] || tabs[index].mode !== 'htmlmixed') return; 

        const match = content.match(titleRegex);
        if (match && match[1]) {
            let newTitle = match[1].trim();
            
            if (newTitle && newTitle !== tabs[index].title) {
                if (newTitle.length > 50) newTitle = newTitle.substring(0, 50) + "...";
                
                tabs[index].title = newTitle;
                renderTabs(); 
            }
        }
    }
    // --- ã‚¿ãƒ–æ©Ÿèƒ½ å®Ÿè£…çµ‚ã‚ã‚Š ---

    // --- æ¤œç´¢ãƒ»ç½®æ›æ©Ÿèƒ½ ---
    let searchState = {
        query: null,
        matches: [],
        currentMatchIndex: -1,
        isReplacing: false
    };

    /**
     * æ¤œç´¢ãƒãƒ¼ã‚’è¡¨ç¤ºã™ã‚‹
     */
    function startSearch(isReplacing = false) {
        searchState.isReplacing = isReplacing;
        searchBar.style.display = 'flex';
        searchInput.focus();
        
        const selectedText = cm.getSelection();
        if (selectedText) {
            searchInput.value = selectedText;
        }

        replaceOneBtn.style.display = isReplacing ? 'inline-block' : 'none';
        replaceAllBtn.style.display = isReplacing ? 'inline-block' : 'none';
        
        findMatches(searchInput.value);
    }

    /**
     * æ¤œç´¢ãƒãƒ¼ã‚’éè¡¨ç¤ºã«ã—ã€ãƒãƒ¼ã‚«ãƒ¼ã‚’ã‚¯ãƒªã‚¢ã™ã‚‹
     */
    function hideSearchBar() {
        searchBar.style.display = 'none';
        searchState.isReplacing = false;
        clearSearchMarkers();
        updateSearchStats(0, 0);
        searchState.query = null;
        cm.focus(); 
    }

    /**
     * æ¤œç´¢ãƒãƒ¼ã‚«ãƒ¼ã¨çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
     */
    function clearSearchMarkers() {
        // æ­£ã—ã„ã‚¯ãƒªã‚¢æ–¹æ³•ã¯ cm.execCommand("clearSearch") ã«ä»»ã›ã‚‹
        try {
            cm.execCommand("clearSearch");
        } catch (e) {
            // å¤ã„/ç•°ãªã‚‹ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã§ã‚‚å®‰å…¨ã«å‹•ä½œã™ã‚‹ã‚ˆã†ã«
            // ã“ã“ã§ã¯ä½•ã‚‚ã—ãªã„
        }
        
        searchState.matches = [];
        searchState.currentMatchIndex = -1;
    }
    
    /**
     * æ¤œç´¢çµæœã®çµ±è¨ˆã‚’æ›´æ–° (ä¾‹: 1/10)
     */
    function updateSearchStats(current, total) {
        searchStats.textContent = `${current}/${total}`;
        
        const isDisabled = total === 0;

        // ãƒ¡ã‚¤ãƒ³ãƒ‘ãƒãƒ«ã®ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ã®åˆ¶å¾¡
        prevMatchBtn.disabled = isDisabled;
        nextMatchBtn.disabled = isDisabled;
        
        // æ¤œç´¢ãƒãƒ¼å†…ã®ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒ»ç½®æ›ãƒœã‚¿ãƒ³ã®åˆ¶å¾¡
        searchNextBtn.disabled = isDisabled; 
        searchPrevBtn.disabled = isDisabled;
        replaceOneBtn.disabled = isDisabled;
        replaceAllBtn.disabled = isDisabled;
    }

    /**
     * ã‚¯ã‚¨ãƒªã«åŸºã¥ã„ã¦ãƒ†ã‚­ã‚¹ãƒˆã‚’æ¤œç´¢ã—ã€ãƒãƒƒãƒãƒªã‚¹ãƒˆã‚’ä½œæˆ
     */
    function findMatches(query) {
        clearSearchMarkers();
        if (!query) {
            updateSearchStats(0, 0);
            return;
        }
        searchState.query = query; 

        const matches = [];
        // getSearchCursor ã‚’ä½¿ã£ã¦å…¨æ–‡æ¤œç´¢ï¼ˆé–‹å§‹ä½ç½®ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§æ–‡é ­ï¼‰
        let cursor;
        try {
            cursor = cm.getSearchCursor(query);
        } catch (e) {
            // æ–‡å­—åˆ—ã§ã¯ãªãæ­£è¦è¡¨ç¾ãŒæœŸå¾…ã•ã‚Œã‚‹ç­‰ã®å ´åˆã‚’è€ƒæ…®ã—ã¦ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
            cursor = cm.getSearchCursor(query.toString());
        }
        
        while (cursor && cursor.findNext()) {
            matches.push({ from: cursor.from(), to: cursor.to() });
        }

        searchState.matches = matches;
        
        // matchesonscrollbar ã‚¢ãƒ‰ã‚ªãƒ³ãŒå­˜åœ¨ã™ã‚‹å ´åˆã¯å®‰å…¨ã«å‘¼ã¶
        try {
            if (typeof CodeMirror.showMatchesOnScrollbar === 'function') {
                // CodeMirror.showMatchesOnScrollbar ã® API ã¯ç’°å¢ƒã«ã‚ˆã£ã¦ç•°ãªã‚‹ãŸã‚
                // ç¬¬ä¸‰å¼•æ•°ã‚’ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã§æ¸¡ã™å½¢ã«ã—ã¦å®‰å…¨ã«å‘¼ã³å‡ºã™
                CodeMirror.showMatchesOnScrollbar(cm, query, {caseFold: true});
            }
        } catch (e) {
            // å¤±æ•—ã—ã¦ã‚‚æ¤œç´¢è‡ªä½“ã¯å•é¡Œãªã„ã®ã§ç„¡è¦–
        }
        
        if (matches.length > 0) {
            const currentCursor = cm.getCursor();
            let closestIndex = 0;
            for(let i=0; i<matches.length; i++) {
                // CodeMirror.cmpPos ã‚’ä½¿ã£ã¦ä½ç½®æ¯”è¼ƒï¼ˆäº’æ›æ€§ã‚’è€ƒæ…®ï¼‰
                try {
                    if (CodeMirror.cmpPos(matches[i].from, currentCursor) >= 0) {
                        closestIndex = i;
                        break;
                    }
                } catch (e) {
                    // cmpPos ãŒç„¡ã„å ´åˆã¯æœ€åˆã®ãƒãƒƒãƒã‚’é¸ã¶
                    closestIndex = 0;
                    break;
                }
            }
            searchState.currentMatchIndex = closestIndex;
            goToMatch(closestIndex);
        } else {
            updateSearchStats(0, 0);
        }
    }
    
    /**
     * æŒ‡å®šã—ãŸã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®ãƒãƒƒãƒä½ç½®ã«ç§»å‹•
     */
    function goToMatch(index) {
        if (searchState.matches.length === 0) return;

        const match = searchState.matches[index];
        if (!match) return;
        
        searchState.currentMatchIndex = index;

        cm.setSelection(match.from, match.to);
        try {
            cm.scrollIntoView({ from: match.from, to: match.to }, 50);
        } catch (e) {
            // ä¸€éƒ¨ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã§ã¯å¼•æ•°ãŒé•ã†å ´åˆãŒã‚ã‚‹ã®ã§ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
            cm.scrollIntoView(match.from);
        }
        
        updateSearchStats(index + 1, searchState.matches.length);
    }
    
    /**
     * æ¬¡ã®æ¤œç´¢çµæœã¸ç§»å‹•
     */
    function searchNext() {
        if (!searchState.query) {
             findMatches(searchInput.value); 
             if (searchState.matches.length === 0) return;
        } else if (searchState.matches.length === 0) {
            return;
        }

        let nextIndex = (searchState.currentMatchIndex + 1) % searchState.matches.length;
        goToMatch(nextIndex);
    }
    
    /**
     * å‰ã®æ¤œç´¢çµæœã¸ç§»å‹•
     */
    function searchPrev() {
        if (!searchState.query) {
             findMatches(searchInput.value);
             if (searchState.matches.length === 0) return;
        } else if (searchState.matches.length === 0) {
            return;
        }

        let prevIndex = (searchState.currentMatchIndex - 1 + searchState.matches.length) % searchState.matches.length;
        goToMatch(prevIndex);
    }

    /**
     * ç¾åœ¨ã®ãƒãƒƒãƒã‚’ç½®æ›
     */
    function replaceOne() {
        if (searchState.matches.length === 0 || searchState.currentMatchIndex === -1) return;

        const replaceText = prompt("ç½®æ›å¾Œã®æ–‡å­—åˆ—ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:", "");
        if (replaceText === null) return; 

        const match = searchState.matches[searchState.currentMatchIndex];
        
        cm.replaceRange(replaceText, match.from, match.to);
        
        findMatches(searchState.query); 
        showMessage(`1ç®‡æ‰€ã‚’ç½®æ›ã—ã¾ã—ãŸ`, "success");
    }

    /**
     * ã™ã¹ã¦ã®ãƒãƒƒãƒã‚’ç½®æ›
     */
    function replaceAll() {
        if (searchState.matches.length === 0) return;

        const replaceText = prompt("ç½®æ›å¾Œã®æ–‡å­—åˆ—ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:", "");
        if (replaceText === null) return; 
        
        let replacedCount = 0;
        
        cm.operation(() => {
            let cursor = cm.getSearchCursor(searchState.query);
            while (cursor.findNext()) {
                cursor.replace(replaceText);
                replacedCount++;
            }
        });
        
        findMatches(searchState.query);
        showMessage(`${replacedCount}ç®‡æ‰€ã‚’å…¨ã¦ç½®æ›ã—ã¾ã—ãŸ`, "success");
    }
    // --- æ¤œç´¢ãƒ»ç½®æ›æ©Ÿèƒ½ çµ‚ã‚ã‚Š ---


    // --- åˆæœŸåŒ–ã¨ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¨­å®š ---

    function initialize() {
        loadTabs(); 
        loadActiveTabContent(); 
        renderTabs(); 
        saveTabs();
        
        setTimeout(() => {
            cm.refresh();
        }, 10);


        // --- ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ ---
        
        cm.on("change", () => {
            saveTabs(); 
             
            clearTimeout(titleUpdateTimer);
            titleUpdateTimer = setTimeout(() => {
                updateTabTitleFromContent(cm.getValue(), activeTabIndex);
            }, 1000); 
        });
        
        selectAllBtn.addEventListener('click', function() {
            cm.focus();
            cm.execCommand("selectAll");
            showMessage("å…¨é¸æŠã—ã¾ã—ãŸ", "info");
        });

        copyBtn.addEventListener('click', function() {
            if (!cm.somethingSelected()) {
                cm.focus();
                cm.execCommand("selectAll");
            }
            var text = cm.getSelection() || cm.getValue();
            navigator.clipboard.writeText(text)
                .then(() => showMessage("ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ", "success"))
                .catch(err => showMessage("ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ", "error"));
        });

        pasteBtn.addEventListener('click', function() {
            navigator.clipboard.readText()
                .then(text => {
                    cm.replaceSelection(text);
                    showMessage("è²¼ã‚Šä»˜ã‘ã¾ã—ãŸ", "success");
                })
                .catch(err => showMessage("è²¼ã‚Šä»˜ã‘ã«å¤±æ•—ã—ã¾ã—ãŸ", "error"));
        });

        clearAllBtn.addEventListener('click', function() {
            if (confirm("æœ¬å½“ã«å…¨å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
                cm.setValue("");
                showMessage("å…¨ã¦å‰Šé™¤ã—ã¾ã—ãŸ", "info");
            }
        });

        openFileBtn.addEventListener('click', function() {
            fileInput.click();
        });

        fileInput.addEventListener('change', function(e) {
            var file = e.target.files[0];
            if (file) {
                var reader = new FileReader();
                reader.onload = function(evt) {
                    const content = evt.target.result;
                    const fileName = file.name;
                    let fileMode = 'htmlmixed'; 
            
                    if (fileName.endsWith('.css')) fileMode = 'css';
                    else if (fileName.endsWith('.js')) fileMode = 'javascript';
                    else if (fileName.endsWith('.xml')) fileMode = 'xml';
                    else if (!fileName.endsWith('.html') && !fileName.endsWith('.htm')) fileMode = 'text/plain'; 
                    
                    addTab(fileName, content, fileMode);
                    if (fileMode === 'htmlmixed') {
                        updateTabTitleFromContent(content, activeTabIndex); 
                    }

                    showMessage(`ãƒ•ã‚¡ã‚¤ãƒ«ã€Œ${file.name}ã€ã‚’é–‹ãã¾ã—ãŸ`, "success");
                }
                reader.readAsText(file);
            }
            fileInput.value = ''; 
        });

        saveBtn.addEventListener('click', function() {
            const currentTitle = tabs[activeTabIndex].title;
            const baseName = currentTitle.split('.').slice(0, -1).join('.') || currentTitle;
            const fileName = (currentTitle.endsWith('.html') || currentTitle.endsWith('.htm')) ? currentTitle : baseName + ".html";
            
            var blob = new Blob([cm.getValue()], { type: "text/html;charset=utf-8" });
            var url = URL.createObjectURL(blob);
            var a = document.createElement("a");
            a.href = url;
            a.download = fileName;
            a.style.display = "none";
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showMessage("HTMLã¨ã—ã¦ä¿å­˜ã—ã¾ã—ãŸ", "success");
        });

        saveTxtBtn.addEventListener('click', function() {
            const currentTitle = tabs[activeTabIndex].title;
            const baseName = currentTitle.split('.').slice(0, -1).join('.') || currentTitle;
            const fileName = currentTitle.endsWith('.txt') ? currentTitle : baseName + ".txt";
            
            var blob = new Blob([cm.getValue()], { type: "text/plain;charset=utf-8" });
            var url = URL.createObjectURL(blob);
            var a = document.createElement("a");
            a.href = url;
            a.download = fileName;
            a.style.display = "none";
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showMessage("TXTã¨ã—ã¦ä¿å­˜ã—ã¾ã—ãŸ", "success");
        });
        
        runBtn.addEventListener('click', function() {
            var blob = new Blob([cm.getValue()], { type: "text/html;charset=utf-8" });
            var url = URL.createObjectURL(blob);
            window.open(url, "_blank");
            showMessage("ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã—ã¾ã—ãŸ", "info");
        });
        
        undoBtn.addEventListener('click', function() {
            cm.undo();
            showMessage("å…ƒã«æˆ»ã—ã¾ã—ãŸ", "info");
        });

        redoBtn.addEventListener('click', function() {
            cm.redo();
            showMessage("ã‚„ã‚Šç›´ã—ã¾ã—ãŸ", "info");
        });

        addTabBtn.addEventListener('click', () => addTab());

        searchBtn.addEventListener('click', () => startSearch(false));
        replaceBtn.addEventListener('click', () => startSearch(true));
        
        prevMatchBtn.addEventListener('click', searchPrev);
        nextMatchBtn.addEventListener('click', searchNext);
        searchNextBtn.addEventListener('click', searchNext);
        searchPrevBtn.addEventListener('click', searchPrev);
        
        closeSearchBtn.addEventListener('click', hideSearchBar);
        replaceOneBtn.addEventListener('click', replaceOne);
        replaceAllBtn.addEventListener('click', replaceAll);

        searchInput.addEventListener('input', (e) => {
            findMatches(e.target.value);
        });

        searchInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                searchNext();
            }
            if (e.key === 'Escape') {
                e.preventDefault();
                hideSearchBar();
            }
        });

        cm.setOption("extraKeys", {
            "Cmd-F": function() { startSearch(false); },
            "Ctrl-F": function() { startSearch(false); },
            "Cmd-H": function() { startSearch(true); },
            "Ctrl-H": function() { startSearch(true); },
            "Cmd-G": function() { if(searchBar.style.display === 'flex') searchNext(); },
            "Ctrl-G": function() { if(searchBar.style.display === 'flex') searchNext(); },
            "Shift-Cmd-G": function() { if(searchBar.style.display === 'flex') searchPrev(); },
            "Shift-Ctrl-G": function() { if(searchBar.style.display === 'flex') searchPrev(); },
            "Esc": function() { if(searchBar.style.display === 'flex') hideSearchBar(); }
        });
    }

    initialize();
  </script>
</body>
</html>