<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>豪華モード専用 HTMLエディター</title>
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.css" />
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/theme/material-darker.min.css" />
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/search/matchesonscrollbar.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/dialog/dialog.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/fold/foldgutter.min.css">
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  
  <style>
    /* 🎨 PCとモバイルの両方に対応するための変数と基本設定 */
    :root {
      /* PC用: デフォルト(豪華モード)のボタンの列数とサイズ */
      --control-cols: 5; 
      --control-gap: 5px;
      --control-padding: 10px;
    }
    
    body {
      margin: 0;
      font-family: sans-serif;
      display: flex;
      flex-direction: column;
      /* 画面全体にフィット */
      height: 100vh;
      box-sizing: border-box;
      /* 🛠️ 修正: スクロールを禁止 */
      overflow: hidden; 
      /* iOS の Safe Area に対応 */
      padding-top: env(safe-area-inset-top);
      padding-bottom: env(safe-area-inset-bottom);
      padding-left: env(safe-area-inset-left);
      padding-right: env(safe-area-inset-right);
      
      /* 豪華モードの背景 */
      background-color: #1e1e1e; 
      color: #eee;
    }

    /* 📱 モバイル優先の設定 */
    @media (max-width: 768px) {
      :root {
        --control-cols: 3; /* モバイルでは3列に */
        --control-gap: 4px;
        --control-padding: 8px;
      }

      #messageArea {
          top: 10px; /* 上部から少し離す */
          right: 50%;
          transform: translateX(50%); /* 中央配置 */
          font-size: 0.8em;
          padding: 6px 10px;
          white-space: normal;
          width: 80%;
      }
      #messageArea.show {
          transform: translateX(50%) translateY(0);
      }
      #messageArea:not(.show) {
          transform: translateX(50%) translateY(-20px);
      }
    }

    /* ---------------------------------- */
    /* --- ⚙️ コントロールパネル --- */
    /* ---------------------------------- */
    .controls {
      padding: var(--control-padding);
      background-color: #333; /* 暗い背景色 */
      display: grid; 
      grid-template-columns: repeat(var(--control-cols), 1fr); /* 列数に合わせたグリッド */
      gap: var(--control-gap);
      position: relative; 
      z-index: 10; 
      box-shadow: 0 2px 5px rgba(0,0,0,0.3); 
      order: 1; 
      width: 100%;
      box-sizing: border-box;
    }
    .controls button {
      padding: 8px 10px;
      cursor: pointer;
      border: 1px solid #555;
      border-radius: 4px;
      background-color: #444;
      color: #eee;
      transition: background-color 0.2s, box-shadow 0.2s, color 0.2s, border-color 0.2s;
      font-size: 0.85em;
      line-height: 1.2;
      white-space: nowrap; 
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .controls button:hover {
      background-color: #555;
      box-shadow: 0 0 8px rgba(255, 255, 255, 0.1);
    }
    .controls button i {
      margin-right: 5px;
    }

    /* 特定のボタンを強調するスタイル */
    .controls button.prominent {
      background-color: #007bff; 
      border-color: #007bff;
      color: white;
    }
    .controls button.prominent:hover {
      background-color: #0056b3;
      border-color: #0056b3;
    }
    .controls button#runBtn {
        background-color: #28a745; 
        border-color: #28a745;
        font-weight: bold;
        color: white;
    }
    .controls button#runBtn:hover {
        background-color: #1e7e34;
        border-color: #1e7e34;
    }
    .controls button#clearAllBtn {
        background-color: #dc3545; 
        border-color: #dc3545;
        color: white;
    }
    .controls button#clearAllBtn:hover {
        background-color: #c82333;
        border-color: #c82333;
    }

    /* 🔍 検索バーのスタイル */
    #searchBar {
      grid-column: 1 / -1; 
      display: flex;
      gap: var(--control-gap);
      padding: 5px 0;
      border-top: 1px solid #555;
      margin-top: 5px;
    }
    #searchBar input[type="text"] {
      padding: 8px;
      border: 1px solid #555;
      border-radius: 4px;
      flex-grow: 1;
      background-color: #222;
      color: #eee;
    }
    #searchBar button {
        flex-shrink: 0;
        padding: 8px 12px;
        font-size: 0.9em;
    }
    #searchStats {
        display: flex;
        align-items: center;
        color: #ccc;
        font-size: 0.8em;
        padding-left: 5px;
    }

    /* 💬 メッセージエリアのスタイル */
    #messageArea {
      position: absolute;
      right: 10px;
      top: 50%; 
      transform: translateY(-50%); 
      padding: 8px 15px;
      font-size: 0.85em;
      white-space: nowrap;
      background-color: rgba(0, 0, 0, 0.7);
      color: white;
      border-radius: 5px;
      opacity: 0;
      transition: opacity 0.4s ease-out, transform 0.4s ease-out, background-color 0.4s ease;
      z-index: 100; 
      pointer-events: none; 
    }
    #messageArea.show {
        opacity: 1;
        transform: translateY(-50%) translateX(0);
    }
    #messageArea:not(.show) {
        transform: translateY(-50%) translateX(20px); 
    }
    #messageArea.success {
        background-color: #28a745;
    }
    #messageArea.error {
        background-color: #dc3545;
    }
    #messageArea.info {
        background-color: #17a2b8;
    }

    /* 🖥️ エディター領域 */
    .editor {
      flex: 1; /* 残りの高さを全て占める */
      overflow: hidden; /* エディター自体の親コンテナはoverflowを禁止 */
      order: 3;
    }
    /* CodeMirrorスタイル */
    .CodeMirror {
      height: 100%; /* 親 (.editor) の高さに合わせる */
      border: none; 
      border-top: 1px solid #555; 
      font-size: 14px; 
    }
    .CodeMirror-gutters {
        background-color: #2a2a2a; 
        border-right: 1px solid #555;
    }
    .CodeMirror-linenumber {
        color: #888;
    }
    .CodeMirror-activeline-background {
        background: #3c3c3c; 
    }
    .CodeMirror-search-match {
        background-color: #ff0;
        color: #000;
        border-radius: 2px;
        padding: 0 1px;
    }

    /* --- 📑 タブ機能のスタイル --- */
    .tab-bar {
      display: flex;
      flex-wrap: nowrap;
      overflow-x: auto;
      padding: 0 10px;
      background-color: #222;
      border-bottom: 1px solid #555;
      white-space: nowrap;
      scrollbar-width: none; 
      order: 2; 
    }
    .tab-bar::-webkit-scrollbar {
      display: none; 
    }
    .tab {
      display: flex;
      align-items: center;
      padding: 8px 12px;
      cursor: pointer;
      background-color: #444;
      border: 1px solid #555;
      border-bottom: none;
      margin-right: 5px;
      border-radius: 6px 6px 0 0;
      font-size: 0.9em;
      transition: background-color 0.2s, color 0.2s, border-color 0.2s;
      min-width: 100px;
      max-width: 200px;
      color: #eee;
    }
    .tab.active {
      background-color: #1e1e1e; 
      border-color: #007bff;
      color: #007bff;
      font-weight: bold;
      border-bottom: 1px solid #1e1e1e; 
    }
    .tab:hover:not(.active) {
      background-color: #555;
    }
    .tab-title {
        flex-grow: 1;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        padding-right: 8px;
    }
    .tab-close {
      margin-left: 8px;
      background: none;
      border: none;
      color: #ccc;
      cursor: pointer;
      font-size: 1.1em;
      padding: 0;
      line-height: 1;
      transition: color 0.2s;
    }
    .tab-close:hover {
      color: #fff;
    }
    .add-tab-btn {
      background-color: #333;
      color: #eee;
      border: none;
      padding: 8px 12px;
      border-radius: 6px 6px 0 0;
      margin-left: auto;
      cursor: pointer;
      transition: background-color 0.2s;
      font-size: 1em;
      line-height: 1;
    }
    .add-tab-btn:hover {
        background-color: #444;
    }

  </style>
</head>
<body>
  
  <div class="controls" id="controlsPanel"> 
    <div id="messageArea"></div>

    <button id="selectAllBtn"><i class="fas fa-mouse-pointer"></i> 全選択</button>
    <button id="copyBtn"><i class="fas fa-copy"></i> コピー</button>
    <button id="pasteBtn" class="prominent"><i class="fas fa-paste"></i> 貼付け</button>
    <button id="clearAllBtn" class="prominent"><i class="fas fa-trash-alt"></i> 全削除</button>
    <button id="openFileBtn"><i class="fas fa-folder-open"></i> 開く</button>
    <input type="file" id="fileInput" accept=".html,.css,.js,.txt,.xml" style="display:none">
    <button id="saveBtn"><i class="fas fa-file-download"></i> 保存 (HTML)</button>
    <button id="saveTxtBtn"><i class="fas fa-file-alt"></i> 保存 (TXT)</button>
    <button id="runBtn" style="grid-column: span 1 / span 1;"><i class="fas fa-play"></i> 実行</button>
    
    <button id="undoBtn"><i class="fas fa-undo"></i> 元に戻す</button>
    <button id="redoBtn"><i class="fas fa-redo"></i> やり直し</button>
    <button id="searchBtn"><i class="fas fa-search"></i> 探す</button>
    <button id="replaceBtn"><i class="fas fa-exchange-alt"></i> 置換</button>
    <button id="prevMatchBtn" disabled><i class="fas fa-arrow-up"></i> 前へ</button>
    <button id="nextMatchBtn" disabled><i class="fas fa-arrow-down"></i> 次へ</button>

    <div id="searchBar" style="display: none;">
        <input type="text" id="searchInput" placeholder="検索する文字列">
        <button id="searchNextBtn" title="次を検索"><i class="fas fa-arrow-down"></i></button>
        <button id="searchPrevBtn" title="前を検索"><i class="fas fa-arrow-up"></i></button>
        <button id="replaceOneBtn" disabled>置換</button>
        <button id="replaceAllBtn" disabled>全て置換</button>
        <span id="searchStats">0/0</span>
        <button id="closeSearchBtn" title="閉じる"><i class="fas fa-times"></i></button>
    </div>
  </div>

  <div class="tab-bar" id="tabBar">
    <button id="addTabBtn" class="add-tab-btn" title="新しいタブを追加"><i class="fas fa-plus"></i></button>
  </div>

  <div class="editor">
    <textarea id="htmlCode" placeholder="ここにHTMLコードを入力してください"></textarea>
  </div>


  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.js"></script>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/htmlmixed/htmlmixed.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/xml/xml.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/javascript/javascript.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/css/css.min.js"></script>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/search/searchcursor.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/search/search.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/dialog/dialog.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/search/jump-to-line.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/search/matchesonscrollbar.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/edit/matchbrackets.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/edit/closebrackets.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/edit/closetag.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/edit/matchtags.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/edit/trailingspace.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/selection/active-line.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/fold/foldcode.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/fold/foldgutter.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/fold/brace-fold.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/fold/xml-fold.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/fold/indent-fold.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/fold/comment-fold.min.js"></script>


  <script>
    // --- 定数とグローバル変数 ---
    const STORAGE_KEY_TABS = "editorTabs_v3";
    const STORAGE_KEY_ACTIVE_TAB = "editorActiveTab_v3";
    const titleRegex = /<title\b[^>]*>([\s\S]*?)<\/title>/i; 
    let autoSaveTimer;
    let titleUpdateTimer;

    // --- CodeMirrorオプション (豪華モード固定) ---
    const deluxeOptions = {
        theme: "material-darker",
        mode: "htmlmixed",
        lineNumbers: true,
        autofocus: true,
        matchBrackets: true,
        autoCloseBrackets: true,
        autoCloseTags: true,
        matchTags: { both: true },
        styleActiveLine: true,
        showTrailingSpace: true,
        foldGutter: true,
        gutters: ["CodeMirror-linenumbers", "CodeMirror-foldgutter"],
        highlightSelectionMatches: { showToken: /\w/ } 
    };

    // --- タブ管理用変数 ---
    let tabs = [];
    let activeTabIndex = 0;
    let tabIdCounter = 1;

    // CodeMirror エディターの初期化
    var cm = CodeMirror.fromTextArea(document.getElementById('htmlCode'), deluxeOptions);

    // --- 要素の取得 ---
    const selectAllBtn = document.getElementById('selectAllBtn');
    const copyBtn = document.getElementById('copyBtn');
    const pasteBtn = document.getElementById('pasteBtn');
    const clearAllBtn = document.getElementById('clearAllBtn');
    const openFileBtn = document.getElementById('openFileBtn');
    const fileInput = document.getElementById('fileInput');
    const saveBtn = document.getElementById('saveBtn');
    const saveTxtBtn = document.getElementById('saveTxtBtn'); 
    const runBtn = document.getElementById('runBtn');
    const undoBtn = document.getElementById('undoBtn');
    const redoBtn = document.getElementById('redoBtn');
    const messageArea = document.getElementById('messageArea');
    const controlsPanel = document.getElementById('controlsPanel');
    const tabBar = document.getElementById('tabBar');
    const addTabBtn = document.getElementById('addTabBtn');
    const searchBtn = document.getElementById('searchBtn');
    const replaceBtn = document.getElementById('replaceBtn');
    const prevMatchBtn = document.getElementById('prevMatchBtn');
    const nextMatchBtn = document.getElementById('nextMatchBtn');
    const searchBar = document.getElementById('searchBar');
    const searchInput = document.getElementById('searchInput');
    const searchNextBtn = document.getElementById('searchNextBtn');
    const searchPrevBtn = document.getElementById('searchPrevBtn');
    const replaceOneBtn = document.getElementById('replaceOneBtn');
    const replaceAllBtn = document.getElementById('replaceAllBtn');
    const searchStats = document.getElementById('searchStats');
    const closeSearchBtn = document.getElementById('closeSearchBtn');

    // --- ユーティリティ関数 ---

    /**
     * メッセージ表示関数
     * @param {string} msg - 表示するメッセージ
     * @param {'success'|'error'|'info'} type - メッセージの種類 (デフォルト: 'info')
     */
    function showMessage(msg, type = 'info') {
      messageArea.textContent = msg;
      messageArea.className = 'show ' + type;

      clearTimeout(autoSaveTimer); 
      autoSaveTimer = setTimeout(() => {
        messageArea.className = '';
        messageArea.textContent = '';
      }, 2500); 
    }

    // --- タブ機能の実装 ---
    
    /**
     * ローカルストレージからタブデータを読み込む
     */
    function loadTabs() {
      const savedTabs = localStorage.getItem(STORAGE_KEY_TABS);
      const activeTabId = localStorage.getItem(STORAGE_KEY_ACTIVE_TAB);
      
      if (savedTabs) {
        tabs = JSON.parse(savedTabs);
        tabIdCounter = tabs.reduce((max, t) => Math.max(max, t.id), 0) + 1;
        const activeTab = tabs.find(t => t.id == activeTabId);
        activeTabIndex = activeTab ? tabs.indexOf(activeTab) : 0;
      }

      if (tabs.length === 0) {
        const oldCode = localStorage.getItem("htmlCode");
        tabs.push({ id: tabIdCounter++, title: 'Tab 1', code: oldCode || '', mode: 'htmlmixed' });
        localStorage.removeItem("htmlCode"); 
        activeTabIndex = 0;
      }
    }
    
    /**
     * 現在アクティブなタブの内容をCodeMirrorに読み込む
     */
    function loadActiveTabContent() {
        if (tabs[activeTabIndex]) {
            cm.setValue(tabs[activeTabIndex].code);
            cm.setOption('mode', tabs[activeTabIndex].mode);
            cm.focus();
            cm.getDoc().clearHistory(); 
        }
    }

    /**
     * 現在のタブをローカルストレージに保存する
     */
    function saveTabs() {
      if (tabs[activeTabIndex]) {
          tabs[activeTabIndex].code = cm.getValue();
          tabs[activeTabIndex].mode = cm.getOption('mode');
          localStorage.setItem(STORAGE_KEY_TABS, JSON.stringify(tabs));
          localStorage.setItem(STORAGE_KEY_ACTIVE_TAB, tabs[activeTabIndex].id);
      }
    }

    /**
     * 指定したインデックスのタブに切り替える
     */
    function switchTab(index) {
      if (index === activeTabIndex || index < 0 || index >= tabs.length) return;

      tabs[activeTabIndex].code = cm.getValue();
      tabs[activeTabIndex].mode = cm.getOption('mode');

      activeTabIndex = index;
      
      loadActiveTabContent(); 
      renderTabs();
      saveTabs();
      showMessage(`タブ「${tabs[activeTabIndex].title}」に切り替えました`, "info");
      hideSearchBar(); 
    }
    
    /**
     * 新しいタブを追加する
     */
    function addTab(title = null, code = '', mode = 'htmlmixed') {
      const newTitle = title || `Tab ${tabIdCounter}`;
      const newTab = { id: tabIdCounter++, title: newTitle, code: code, mode: mode };
      tabs.push(newTab);
      switchTab(tabs.length - 1); 
    }

    /**
     * 指定したインデックスのタブを削除する
     */
    function removeTab(index) {
      if (tabs.length === 1) {
        showMessage("最後のタブは削除できません", "error");
        return;
      }
      
      const removedTitle = tabs[index].title;
      tabs.splice(index, 1);
      
      if (index <= activeTabIndex) {
        activeTabIndex = Math.max(0, activeTabIndex - 1);
      }
      
      loadActiveTabContent();
      renderTabs();
      saveTabs();
      showMessage(`タブ「${removedTitle}」を削除しました`, "info");
      hideSearchBar();
    }

    /**
     * タブ名を変更する
     */
    function renameTab(index) {
        const currentTitle = tabs[index].title;
        const newTitle = prompt("新しいタブのタイトルを入力してください:", currentTitle);
        if (newTitle && newTitle.trim() !== "" && newTitle !== currentTitle) {
            tabs[index].title = newTitle.trim();
            renderTabs();
            saveTabs();
            showMessage(`タブ名を「${newTitle.trim()}」に変更しました`, "success");
        } else if (newTitle === "") {
            showMessage("タイトルが入力されていません", "error");
        }
    }

    /**
     * 現在のタブ配列に基づいてタブバーのUIを構築する
     */
    function renderTabs() {
      while (tabBar.firstChild && tabBar.firstChild !== addTabBtn) {
        tabBar.removeChild(tabBar.firstChild);
      }
      
      const fragment = document.createDocumentFragment();

      tabs.forEach((tab, index) => {
        const tabEl = document.createElement('div');
        tabEl.className = `tab ${index === activeTabIndex ? 'active' : ''}`;
        tabEl.dataset.index = index;
        tabEl.title = tab.title;

        const titleEl = document.createElement('span');
        titleEl.className = 'tab-title';
        titleEl.textContent = tab.title;
        
        const closeBtn = document.createElement('button');
        closeBtn.className = 'tab-close';
        closeBtn.title = '閉じる';
        closeBtn.innerHTML = '&times;'; 
        
        tabEl.appendChild(titleEl);
        tabEl.appendChild(closeBtn);
        
        tabEl.addEventListener('click', (e) => {
            if (e.target !== closeBtn) {
                switchTab(index);
            }
        });
        
        closeBtn.addEventListener('click', () => removeTab(index));
        
        tabEl.addEventListener('dblclick', (e) => {
            if (e.target !== closeBtn) {
                renameTab(index);
            }
        });

        fragment.appendChild(tabEl);
      });
      
      tabBar.insertBefore(fragment, addTabBtn);
      
      const activeTabEl = tabBar.querySelector('.tab.active');
      if (activeTabEl) {
          activeTabEl.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'nearest' });
      }
    }
    
    /**
     * コードの内容から<title>タグを抽出し、タブ名を更新
     */
    function updateTabTitleFromContent(content, index) {
        if (!tabs[index] || tabs[index].mode !== 'htmlmixed') return; 

        const match = content.match(titleRegex);
        if (match && match[1]) {
            let newTitle = match[1].trim();
            
            if (newTitle && newTitle !== tabs[index].title) {
                if (newTitle.length > 50) newTitle = newTitle.substring(0, 50) + "...";
                
                tabs[index].title = newTitle;
                renderTabs(); 
            }
        }
    }
    // --- タブ機能 実装終わり ---

    // --- 検索・置換機能 ---
    let searchState = {
        query: null,
        matches: [],
        currentMatchIndex: -1,
        isReplacing: false
    };

    /**
     * 検索バーを表示する
     */
    function startSearch(isReplacing = false) {
        searchState.isReplacing = isReplacing;
        searchBar.style.display = 'flex';
        searchInput.focus();
        
        const selectedText = cm.getSelection();
        if (selectedText) {
            searchInput.value = selectedText;
        }

        replaceOneBtn.style.display = isReplacing ? 'inline-block' : 'none';
        replaceAllBtn.style.display = isReplacing ? 'inline-block' : 'none';
        
        findMatches(searchInput.value);
    }

    /**
     * 検索バーを非表示にし、マーカーをクリアする
     */
    function hideSearchBar() {
        searchBar.style.display = 'none';
        searchState.isReplacing = false;
        clearSearchMarkers();
        updateSearchStats(0, 0);
        searchState.query = null;
        cm.focus(); 
    }

    /**
     * 検索マーカーと状態をリセット
     */
    function clearSearchMarkers() {
        // 正しいクリア方法は cm.execCommand("clearSearch") に任せる
        try {
            cm.execCommand("clearSearch");
        } catch (e) {
            // 古い/異なるバージョンでも安全に動作するように
            // ここでは何もしない
        }
        
        searchState.matches = [];
        searchState.currentMatchIndex = -1;
    }
    
    /**
     * 検索結果の統計を更新 (例: 1/10)
     */
    function updateSearchStats(current, total) {
        searchStats.textContent = `${current}/${total}`;
        
        const isDisabled = total === 0;

        // メインパネルのナビゲーションボタンの制御
        prevMatchBtn.disabled = isDisabled;
        nextMatchBtn.disabled = isDisabled;
        
        // 検索バー内のナビゲーション・置換ボタンの制御
        searchNextBtn.disabled = isDisabled; 
        searchPrevBtn.disabled = isDisabled;
        replaceOneBtn.disabled = isDisabled;
        replaceAllBtn.disabled = isDisabled;
    }

    /**
     * クエリに基づいてテキストを検索し、マッチリストを作成
     */
    function findMatches(query) {
        clearSearchMarkers();
        if (!query) {
            updateSearchStats(0, 0);
            return;
        }
        searchState.query = query; 

        const matches = [];
        // getSearchCursor を使って全文検索（開始位置はデフォルトで文頭）
        let cursor;
        try {
            cursor = cm.getSearchCursor(query);
        } catch (e) {
            // 文字列ではなく正規表現が期待される等の場合を考慮してフォールバック
            cursor = cm.getSearchCursor(query.toString());
        }
        
        while (cursor && cursor.findNext()) {
            matches.push({ from: cursor.from(), to: cursor.to() });
        }

        searchState.matches = matches;
        
        // matchesonscrollbar アドオンが存在する場合は安全に呼ぶ
        try {
            if (typeof CodeMirror.showMatchesOnScrollbar === 'function') {
                // CodeMirror.showMatchesOnScrollbar の API は環境によって異なるため
                // 第三引数をオプションで渡す形にして安全に呼び出す
                CodeMirror.showMatchesOnScrollbar(cm, query, {caseFold: true});
            }
        } catch (e) {
            // 失敗しても検索自体は問題ないので無視
        }
        
        if (matches.length > 0) {
            const currentCursor = cm.getCursor();
            let closestIndex = 0;
            for(let i=0; i<matches.length; i++) {
                // CodeMirror.cmpPos を使って位置比較（互換性を考慮）
                try {
                    if (CodeMirror.cmpPos(matches[i].from, currentCursor) >= 0) {
                        closestIndex = i;
                        break;
                    }
                } catch (e) {
                    // cmpPos が無い場合は最初のマッチを選ぶ
                    closestIndex = 0;
                    break;
                }
            }
            searchState.currentMatchIndex = closestIndex;
            goToMatch(closestIndex);
        } else {
            updateSearchStats(0, 0);
        }
    }
    
    /**
     * 指定したインデックスのマッチ位置に移動
     */
    function goToMatch(index) {
        if (searchState.matches.length === 0) return;

        const match = searchState.matches[index];
        if (!match) return;
        
        searchState.currentMatchIndex = index;

        cm.setSelection(match.from, match.to);
        try {
            cm.scrollIntoView({ from: match.from, to: match.to }, 50);
        } catch (e) {
            // 一部バージョンでは引数が違う場合があるのでフォールバック
            cm.scrollIntoView(match.from);
        }
        
        updateSearchStats(index + 1, searchState.matches.length);
    }
    
    /**
     * 次の検索結果へ移動
     */
    function searchNext() {
        if (!searchState.query) {
             findMatches(searchInput.value); 
             if (searchState.matches.length === 0) return;
        } else if (searchState.matches.length === 0) {
            return;
        }

        let nextIndex = (searchState.currentMatchIndex + 1) % searchState.matches.length;
        goToMatch(nextIndex);
    }
    
    /**
     * 前の検索結果へ移動
     */
    function searchPrev() {
        if (!searchState.query) {
             findMatches(searchInput.value);
             if (searchState.matches.length === 0) return;
        } else if (searchState.matches.length === 0) {
            return;
        }

        let prevIndex = (searchState.currentMatchIndex - 1 + searchState.matches.length) % searchState.matches.length;
        goToMatch(prevIndex);
    }

    /**
     * 現在のマッチを置換
     */
    function replaceOne() {
        if (searchState.matches.length === 0 || searchState.currentMatchIndex === -1) return;

        const replaceText = prompt("置換後の文字列を入力してください:", "");
        if (replaceText === null) return; 

        const match = searchState.matches[searchState.currentMatchIndex];
        
        cm.replaceRange(replaceText, match.from, match.to);
        
        findMatches(searchState.query); 
        showMessage(`1箇所を置換しました`, "success");
    }

    /**
     * すべてのマッチを置換
     */
    function replaceAll() {
        if (searchState.matches.length === 0) return;

        const replaceText = prompt("置換後の文字列を入力してください:", "");
        if (replaceText === null) return; 
        
        let replacedCount = 0;
        
        cm.operation(() => {
            let cursor = cm.getSearchCursor(searchState.query);
            while (cursor.findNext()) {
                cursor.replace(replaceText);
                replacedCount++;
            }
        });
        
        findMatches(searchState.query);
        showMessage(`${replacedCount}箇所を全て置換しました`, "success");
    }
    // --- 検索・置換機能 終わり ---


    // --- 初期化とイベントリスナーの設定 ---

    function initialize() {
        loadTabs(); 
        loadActiveTabContent(); 
        renderTabs(); 
        saveTabs();
        
        setTimeout(() => {
            cm.refresh();
        }, 10);


        // --- イベントリスナー ---
        
        cm.on("change", () => {
            saveTabs(); 
             
            clearTimeout(titleUpdateTimer);
            titleUpdateTimer = setTimeout(() => {
                updateTabTitleFromContent(cm.getValue(), activeTabIndex);
            }, 1000); 
        });
        
        selectAllBtn.addEventListener('click', function() {
            cm.focus();
            cm.execCommand("selectAll");
            showMessage("全選択しました", "info");
        });

        copyBtn.addEventListener('click', function() {
            if (!cm.somethingSelected()) {
                cm.focus();
                cm.execCommand("selectAll");
            }
            var text = cm.getSelection() || cm.getValue();
            navigator.clipboard.writeText(text)
                .then(() => showMessage("コピーしました", "success"))
                .catch(err => showMessage("コピーに失敗しました", "error"));
        });

        pasteBtn.addEventListener('click', function() {
            navigator.clipboard.readText()
                .then(text => {
                    cm.replaceSelection(text);
                    showMessage("貼り付けました", "success");
                })
                .catch(err => showMessage("貼り付けに失敗しました", "error"));
        });

        clearAllBtn.addEventListener('click', function() {
            if (confirm("本当に全削除しますか？")) {
                cm.setValue("");
                showMessage("全て削除しました", "info");
            }
        });

        openFileBtn.addEventListener('click', function() {
            fileInput.click();
        });

        fileInput.addEventListener('change', function(e) {
            var file = e.target.files[0];
            if (file) {
                var reader = new FileReader();
                reader.onload = function(evt) {
                    const content = evt.target.result;
                    const fileName = file.name;
                    let fileMode = 'htmlmixed'; 
            
                    if (fileName.endsWith('.css')) fileMode = 'css';
                    else if (fileName.endsWith('.js')) fileMode = 'javascript';
                    else if (fileName.endsWith('.xml')) fileMode = 'xml';
                    else if (!fileName.endsWith('.html') && !fileName.endsWith('.htm')) fileMode = 'text/plain'; 
                    
                    addTab(fileName, content, fileMode);
                    if (fileMode === 'htmlmixed') {
                        updateTabTitleFromContent(content, activeTabIndex); 
                    }

                    showMessage(`ファイル「${file.name}」を開きました`, "success");
                }
                reader.readAsText(file);
            }
            fileInput.value = ''; 
        });

        saveBtn.addEventListener('click', function() {
            const currentTitle = tabs[activeTabIndex].title;
            const baseName = currentTitle.split('.').slice(0, -1).join('.') || currentTitle;
            const fileName = (currentTitle.endsWith('.html') || currentTitle.endsWith('.htm')) ? currentTitle : baseName + ".html";
            
            var blob = new Blob([cm.getValue()], { type: "text/html;charset=utf-8" });
            var url = URL.createObjectURL(blob);
            var a = document.createElement("a");
            a.href = url;
            a.download = fileName;
            a.style.display = "none";
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showMessage("HTMLとして保存しました", "success");
        });

        saveTxtBtn.addEventListener('click', function() {
            const currentTitle = tabs[activeTabIndex].title;
            const baseName = currentTitle.split('.').slice(0, -1).join('.') || currentTitle;
            const fileName = currentTitle.endsWith('.txt') ? currentTitle : baseName + ".txt";
            
            var blob = new Blob([cm.getValue()], { type: "text/plain;charset=utf-8" });
            var url = URL.createObjectURL(blob);
            var a = document.createElement("a");
            a.href = url;
            a.download = fileName;
            a.style.display = "none";
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showMessage("TXTとして保存しました", "success");
        });
        
        runBtn.addEventListener('click', function() {
            var blob = new Blob([cm.getValue()], { type: "text/html;charset=utf-8" });
            var url = URL.createObjectURL(blob);
            window.open(url, "_blank");
            showMessage("コードを実行しました", "info");
        });
        
        undoBtn.addEventListener('click', function() {
            cm.undo();
            showMessage("元に戻しました", "info");
        });

        redoBtn.addEventListener('click', function() {
            cm.redo();
            showMessage("やり直しました", "info");
        });

        addTabBtn.addEventListener('click', () => addTab());

        searchBtn.addEventListener('click', () => startSearch(false));
        replaceBtn.addEventListener('click', () => startSearch(true));
        
        prevMatchBtn.addEventListener('click', searchPrev);
        nextMatchBtn.addEventListener('click', searchNext);
        searchNextBtn.addEventListener('click', searchNext);
        searchPrevBtn.addEventListener('click', searchPrev);
        
        closeSearchBtn.addEventListener('click', hideSearchBar);
        replaceOneBtn.addEventListener('click', replaceOne);
        replaceAllBtn.addEventListener('click', replaceAll);

        searchInput.addEventListener('input', (e) => {
            findMatches(e.target.value);
        });

        searchInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                searchNext();
            }
            if (e.key === 'Escape') {
                e.preventDefault();
                hideSearchBar();
            }
        });

        cm.setOption("extraKeys", {
            "Cmd-F": function() { startSearch(false); },
            "Ctrl-F": function() { startSearch(false); },
            "Cmd-H": function() { startSearch(true); },
            "Ctrl-H": function() { startSearch(true); },
            "Cmd-G": function() { if(searchBar.style.display === 'flex') searchNext(); },
            "Ctrl-G": function() { if(searchBar.style.display === 'flex') searchNext(); },
            "Shift-Cmd-G": function() { if(searchBar.style.display === 'flex') searchPrev(); },
            "Shift-Ctrl-G": function() { if(searchBar.style.display === 'flex') searchPrev(); },
            "Esc": function() { if(searchBar.style.display === 'flex') hideSearchBar(); }
        });
    }

    initialize();
  </script>
</body>
</html>