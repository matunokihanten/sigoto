<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>テキスト→CSV 変換ツール</title>
  <style>
    :root{font-family:system-ui,-apple-system,Segoe UI,Roboto,"Hiragino Kaku Gothic ProN","メイリオ",sans-serif;color:#111}
    body{max-width:900px;margin:28px auto;padding:18px;background:#f7f9fb;border:1px solid #e1e7ee;border-radius:10px}
    h3{margin:0 0 12px 0;font-size:1.1rem}
    label{display:block;margin:12px 0 6px 0;font-weight:600}
    textarea{width:100%;min-height:160px;padding:10px;border:1px solid #cdd7e3;border-radius:6px;background:#fff;resize:vertical}
    .controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    button{background:#0b69ff;color:#fff;border:none;padding:8px 12px;border-radius:6px;cursor:pointer}
    button.secondary{background:#6b7280}
    button:disabled{opacity:.5;cursor:not-allowed}
    .dropzone{border:2px dashed #c6d2e3;border-radius:8px;padding:10px;text-align:center;color:#61707e;background:#f3f7fb}
    .preview{margin-top:12px;background:#fff;border:1px solid #e0e6ee;padding:10px;border-radius:6px;white-space:pre-wrap;font-family:monospace}
    .rowcount{margin-left:auto;color:#3b4b66;font-size:.95rem;align-self:center}
    .options{display:flex;gap:12px;align-items:center;margin-top:8px;flex-wrap:wrap}
    input[type="text"]{padding:8px;border:1px solid #cdd7e3;border-radius:6px}
    small{color:#58606b}
    footer{margin-top:18px;color:#6b7280;font-size:.9rem}
    @media (max-width:560px){.controls{flex-direction:column}.rowcount{margin-left:0}}
  </style>
</head>
<body>
  <h3>テキストをCSVに変換する単一ファイルアプリ</h3>

  <label for="input">入力（コピーしたメニューを貼り付けてください）</label>
  <div class="dropzone" id="dropzone" tabindex="0">ここにファイルをドラッグ＆ドロップ、またはクリックして貼り付け</div>
  <textarea id="input" placeholder="例:
品名,価格（円）
小えびのチリソース煮,1450
小えびと野菜の塩味炒め,1450
中華エビマヨ,1450
いかの甘酢辛し炒め,1750"></textarea>

  <div class="options">
    <label style="display:flex;gap:8px;align-items:center">
      <input type="checkbox" id="hasHeader" checked /> <span>先頭行をヘッダとして扱う</span>
    </label>
    <label style="display:flex;gap:8px;align-items:center">
      区切り文字
      <input type="text" id="delimiter" value="," style="width:54px" />
    </label>
    <label style="display:flex;gap:8px;align-items:center">
      文字コード
      <select id="encoding">
        <option value="utf-8" selected>UTF-8</option>
        <option value="shift_jis">Shift_JIS</option>
      </select>
    </label>
    <div class="rowcount" id="rowcount">0 行</div>
  </div>

  <div class="controls">
    <button id="previewBtn">プレビュー更新</button>
    <button id="downloadBtn">CSVとしてダウンロード</button>
    <button id="clearBtn" class="secondary">クリア</button>
    <input type="text" id="filename" value="menu.csv" style="padding:8px;border-radius:6px;border:1px solid #cdd7e3" />
  </div>

  <label style="margin-top:12px">CSV プレビュー</label>
  <div class="preview" id="preview" aria-live="polite"></div>

  <footer>
    入力例のように「品名,価格（円）」を含む行を貼り付ければ、そのままCSVに変換できます。Shift_JISで保存したい場合は文字コードを選択してください。
  </footer>

  <script>
    // 要素
    const input = document.getElementById('input');
    const preview = document.getElementById('preview');
    const previewBtn = document.getElementById('previewBtn');
    const downloadBtn = document.getElementById('downloadBtn');
    const clearBtn = document.getElementById('clearBtn');
    const hasHeader = document.getElementById('hasHeader');
    const delimiter = document.getElementById('delimiter');
    const encoding = document.getElementById('encoding');
    const filenameInput = document.getElementById('filename');
    const dropzone = document.getElementById('dropzone');
    const rowcountEl = document.getElementById('rowcount');

    // 改行と余白を正規化して行配列を返す
    function getLines(text) {
      if (!text) return [];
      // CRLF, CR を LF に統一し、先頭末尾の空白行をトリム
      const normalized = text.replace(/\r\n/g,'\n').replace(/\r/g,'\n').replace(/^\s+|\s+$/g,'');
      const lines = normalized.split('\n').map(l => l.trim()).filter(l => l.length>0);
      return lines;
    }

    // CSV用に各セルをエスケープする（" を二重にして、必要なら "で囲む）
    function csvEscapeCell(cell, sep=',') {
      const needsQuote = cell.includes('"') || cell.includes(sep) || cell.includes('\n') || /^\s|\s$/.test(cell);
      let v = String(cell).replace(/"/g,'""');
      if (needsQuote) v = '"' + v + '"';
      return v;
    }

    // テキストをCSV形式に変換
    function convertToCSV(text, sep=',', headerExists=true) {
      const lines = getLines(text);
      if (lines.length === 0) return { csv: '', rows: 0, message: '入力が空です' };
      const rows = [];
      // 各行をsepで分割（ただしセルにsepが含まれる可能性が低い前提。必要なら高度なパーサに拡張）
      for (let i=0;i<lines.length;i++){
        // 既にカンマ区切りの行ならそのまま、そうでなければ空白で分割して結合検出
        let parts = lines[i].split(sep);
        if (parts.length === 1 && sep !== ',' ) {
          // if custom sep yields one part, fallback to any common separators
          parts = lines[i].split(/[,、\t]/);
        }
        // トリム
        parts = parts.map(p => p.trim());
        rows.push(parts);
      }
      // 簡易検証: 全行のカラム数を揃える（ヘッダがある場合はその幅に合わせる）
      let maxCols = rows.reduce((m,r)=>Math.max(m,r.length),0);
      if (headerExists) {
        maxCols = Math.max(maxCols, rows[0].length);
      }
      // 正規化（不足セルは空文字で埋める）
      const normalized = rows.map(r=>{
        const copy = r.slice();
        while (copy.length < maxCols) copy.push('');
        return copy;
      });
      // CSV生成
      const csvLines = normalized.map(r => r.map(cell => csvEscapeCell(cell, sep)).join(sep));
      return { csv: csvLines.join('\r\n'), rows: normalized.length, message: 'OK' };
    }

    // Shift_JISエンコード（ブラウザでの実装はTextEncoderがShift_JIS未対応のため、簡易対応としては外部libが必要）
    // ここではUTF-8とShift_JIS両対応するため、Shift_JISのときは代替手段として EUC-JP/Shift_JIS を扱えるライブラリが必要だが
    // 簡潔化のため、Shift_JIS選択時はBOMつきのSJISを想定した実装は行わず、代わりにJSで実現可能な範囲でUTF-8とShift_JIS用の簡易CSVをBlobで作成します。
    // 実運用で確実にShift_JISが必要な場合はサーバー側変換か外部ライブラリの組み込みを推奨します。
    function downloadCSV(csvText, fileName, encodingName='utf-8') {
      if (encodingName === 'utf-8') {
        // UTF-8 BOM を付けるとExcelでの文字化け対策になる場合があるためオプションで付与
        const BOM = new Uint8Array([0xEF,0xBB,0xBF]);
        const csvBuffer = new TextEncoder().encode(csvText);
        const blob = new Blob([BOM, csvBuffer], {type: 'text/csv;charset=utf-8'});
        triggerDownload(blob, fileName);
      } else if (encodingName === 'shift_jis') {
        // ブラウザだけで完璧なShift_JIS変換を行うには外部ライブラリ（Encoding.jsやiconv-lite相当）が必要。
        // 簡易的な代替：UTF-8として保存し、ファイル名に_sjisと付けて警告を出す。
        // ここでは実用性を優先してUTF-8で保存し、ユーザーに選択を通知する。
        const BOM = new Uint8Array([0xEF,0xBB,0xBF]);
        const csvBuffer = new TextEncoder().encode(csvText);
        const blob = new Blob([BOM, csvBuffer], {type: 'text/csv;charset=utf-8'});
        triggerDownload(blob, fileName.replace(/\.csv$/i,'_utf8.csv'));
        alert('Shift_JISを選択しましたが、ブラウザ内で確実にShift_JISへ変換するには追加ライブラリが必要です。\n代わりにUTF-8で出力しました。必要なら教えてください。');
      } else {
        const blob = new Blob([csvText], {type: 'text/csv;charset=utf-8'});
        triggerDownload(blob, fileName);
      }
    }

    function triggerDownload(blob, fileName) {
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = fileName || 'download.csv';
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(()=>URL.revokeObjectURL(url), 1000);
    }

    function updatePreview() {
      const text = input.value;
      const sep = delimiter.value || ',';
      const header = hasHeader.checked;
      const result = convertToCSV(text, sep, header);
      preview.textContent = result.csv || result.message;
      rowcountEl.textContent = result.rows + ' 行';
      downloadBtn.disabled = !result.csv;
    }

    // 初回プレビュー
    updatePreview();

    previewBtn.addEventListener('click', () => updatePreview());

    downloadBtn.addEventListener('click', () => {
      const text = input.value;
      const sep = delimiter.value || ',';
      const header = hasHeader.checked;
      const fileName = filenameInput.value.trim() || 'menu.csv';
      const enc = encoding.value;
      const result = convertToCSV(text, sep, header);
      if (!result.csv) {
        alert('CSVデータが生成できません。入力を確認してください。');
        return;
      }
      downloadCSV(result.csv, fileName, enc);
    });

    clearBtn.addEventListener('click', () => {
      input.value = '';
      preview.textContent = '';
      rowcountEl.textContent = '0 行';
      downloadBtn.disabled = true;
    });

    // ドラッグ＆ドロップ、クリックでファイル読み取り
    ;(function setupDropzone(){
      dropzone.addEventListener('click', ()=> input.focus());
      ['dragenter','dragover'].forEach(evt=>{
        dropzone.addEventListener(evt, e => {
          e.preventDefault();
          dropzone.style.background = '#eaf2ff';
        });
      });
      ['dragleave','drop'].forEach(evt=>{
        dropzone.addEventListener(evt, e => {
          e.preventDefault();
          dropzone.style.background = '';
        });
      });
      dropzone.addEventListener('drop', async e => {
        const dt = e.dataTransfer;
        if (!dt) return;
        const f = dt.files && dt.files[0];
        if (!f) {
          // テキストの直接ドロップ（選択範囲のテキスト）
          const text = dt.getData('text/plain');
          if (text) {
            input.value = text;
            updatePreview();
          }
          return;
        }
        const text = await f.text();
        input.value = text;
        updatePreview();
      });
      // ペースト対応
      input.addEventListener('paste', (e)=>{
        setTimeout(()=> updatePreview(), 50);
      });
    })();

    // テキスト変更で自動プレビュー（遅延）
    let typingTimer;
    input.addEventListener('input', () => {
      clearTimeout(typingTimer);
      typingTimer = setTimeout(updatePreview, 400);
    });

    // 初期有効化
    downloadBtn.disabled = true;
    // 簡易サンプルを残すため、生成可能なら有効化
    if (input.value.trim()) updatePreview();
  </script>
</body>
</html>