<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>飲食店向け多機能電卓</title>
  <style>
    body {
      background: #f2f2f2;
      margin: 0;
      color: #111;
      font-family: 'Segoe UI', Arial, sans-serif;
    }
    .calc-app {
      max-width: 370px;
      margin: 30px auto;
      background: #fff;
      box-shadow: 0 4px 16px #0002;
      border-radius: 14px;
      padding: 19px 15px 14px;
    }
    .calc-tabs {
      display: flex;
      margin-bottom: 14px;
    }
    .calc-tab {
      flex: 1;
      padding: 5px 10px;
      background: #eee;
      border: 1px solid #ccc;
      border-right: none;
      cursor: pointer;
      text-align: center;
      font-weight: bold;
      color: #222;
      border-radius: 10px 10px 0 0;
    }
    .calc-tab.active {
      background: #222;
      color: #fff;
    }
    .calc-tab-del-btn {
      color: #f55;
      margin-left: 4px;
      cursor: pointer;
      font-weight: bold;
    }
    .calc-tab:last-child {
      border-right: 1px solid #ccc;
    }
    .calc-btns {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 8px;
      margin-bottom: 6px;
    }
    .calc-display {
      background: #111;
      color: #fff;
      font-size: 2em;
      text-align: right;
      padding: 10px;
      border-radius: 8px;
      margin-bottom: 12px;
      min-height: 43px;
      letter-spacing: 1px;
      user-select: all;
    }
    button,
    .calc-special-btn {
      font-size: 1.2em;
      padding: 15px 0;
      border-radius: 8px;
      border: none;
      background: #fff;
      color: #111;
      box-shadow: 0 1px 2px #0001;
      font-weight: bold;
      cursor: pointer;
      transition: 0.14s;
    }
    .op {
      background: #111;
      color: #fff;
    }
    .ctrl {
      background: #e7e7e7;
      color: #c33;
    }
    .equal {
      background: #333;
      color: #fff;
    }
    .calc-special-btn {
      background: #fafafa;
      padding: 8px 11px;
      margin: 2px;
    }
    .calc-tax-group input[type='radio'] {
      margin-right: 2px;
    }
    .calc-tax-group {
      margin: 7px 0;
    }
    .history-title {
      margin: 13px 0 6px;
      font-size: 1em;
      color: #666;
    }
    /* 横並び＋折返し対応 */
    .calc-hist {
      background: #f8f8f8;
      border-radius: 6px;
      margin-bottom: 8px;
      max-height: 110px;
      overflow-y: auto;
      font-size: 1em;
      padding: 8px 6px;
      display: flex;
      flex-wrap: wrap;
      gap: 6px 8px;
    }
    .calc-hist .hist-line {
      background: #2222;
      color: #222;
      font-family: monospace;
      cursor: pointer;
      border-radius: 3px;
      padding: 2px 5px;
      user-select: none;
      white-space: nowrap;
      position: relative;
      transition: background 0.1s;
    }
    .calc-hist .hist-line:active {
      background: #f55;
      color: white;
    }
    .hist-btns {
      text-align: right;
      margin-bottom: 5px;
    }
    .hist-btns button {
      margin-left: 4px;
      font-size: 0.9em;
    }
    @media (max-width: 410px) {
      .calc-app {
        max-width: 99vw;
        padding: 7px 2vw 6vw;
      }
      .calc-btns button,
      .calc-special-btn {
        font-size: 1.03em;
        padding: 11px 0;
      }
      .calc-display {
        font-size: 1.1em;
      }
    }
  </style>
</head>
<body>
  <div class="calc-app" id="app">
    <div class="calc-tabs" id="tabs"></div>
    <div class="calc-display" id="display">0</div>
    <div class="calc-tax-group">
      <label><input type="radio" name="taxRate" value="0.08" />8%</label>
      <label><input type="radio" name="taxRate" value="0.10" checked />10%</label>
      <button class="calc-special-btn" onclick="applyTaxIn()">税込</button>
      <button class="calc-special-btn" onclick="applyTaxOut()">税抜</button>
      <button class="calc-special-btn" onclick="applyDiscount()">割引</button>
      <button class="calc-special-btn" onclick="applyUp()">割増</button>
    </div>
    <div class="calc-btns">
      <button onclick="inputNum('7')">7</button>
      <button onclick="inputNum('8')">8</button>
      <button onclick="inputNum('9')">9</button>
      <button class="op" onclick="inputOp('/')">÷</button>

      <button onclick="inputNum('4')">4</button>
      <button onclick="inputNum('5')">5</button>
      <button onclick="inputNum('6')">6</button>
      <button class="op" onclick="inputOp('*')">×</button>

      <button onclick="inputNum('1')">1</button>
      <button onclick="inputNum('2')">2</button>
      <button onclick="inputNum('3')">3</button>
      <button class="op" onclick="inputOp('-')">−</button>

      <button onclick="inputNum('0')">0</button>
      <button onclick="inputNum('.')">.</button>
      <button class="equal" onclick="calcEqual()">=</button>
      <button class="op" onclick="inputOp('+')">＋</button>

      <button class="ctrl" onclick="allClear()">AC</button>
      <button class="ctrl" onclick="clearEntry()">CE</button>
      <button class="ctrl" onclick="backspace()">⌫</button>
      <button onclick="addTab()">タブ+ </button>
    </div>
    <div class="history-title">計算履歴</div>
    <div class="calc-hist" id="history"></div>
    <div class="hist-btns">
      <button onclick="historySum()">履歴合計</button>
      <button onclick="clearHistory()">履歴クリア</button>
    </div>
  </div>
  <script>
    let tabs = [{ name: 'タブ1', expr: '', display: '0', hist: [] }];
    let activeTab = 0;
    let inputting = true;

    function renderTabs() {
      const tabEl = document.getElementById('tabs');
      tabEl.innerHTML = '';
      tabs.forEach((tab, i) => {
        const t = document.createElement('div');
        t.className = 'calc-tab' + (i === activeTab ? ' active' : '');
        t.textContent = tab.name;
        t.onclick = () => switchTab(i);
        if (tabs.length > 1) {
          const d = document.createElement('span');
          d.className = 'calc-tab-del-btn';
          d.textContent = '✕';
          d.onclick = (e) => {
            e.stopPropagation();
            removeTab(i);
          };
          t.appendChild(d);
        }
        tabEl.appendChild(t);
      });
    }
    function switchTab(i) {
      saveTabState();
      activeTab = i;
      loadTabState();
      renderTabs();
    }
    function addTab() {
      saveTabState();
      tabs.push({ name: 'タブ' + (tabs.length + 1), expr: '', display: '0', hist: [] });
      switchTab(tabs.length - 1);
    }
    function removeTab(idx) {
      if (tabs.length === 1) return;
      tabs.splice(idx, 1);
      if (activeTab >= tabs.length) activeTab = tabs.length - 1;
      loadTabState();
      renderTabs();
    }
    function saveTabState() {
      tabs[activeTab].expr = window.expr || '';
      tabs[activeTab].display = document.getElementById('display').textContent;
      tabs[activeTab].hist = JSON.parse(JSON.stringify(window.calcHistory || []));
    }
    function loadTabState() {
      window.expr = tabs[activeTab].expr || '';
      document.getElementById('display').textContent = tabs[activeTab].display || '0';
      window.calcHistory = JSON.parse(JSON.stringify(tabs[activeTab].hist || []));
      renderHistory();
    }

    let expr = '';
    function updateDisplay(val) {
      document.getElementById('display').textContent = val;
      tabs[activeTab].display = val;
    }
    function inputNum(n) {
      if (!inputting) {
        expr = '';
        inputting = true;
      }
      if (expr.length > 25) return;
      expr += n;
      updateDisplay(expr);
    }
    function inputOp(o) {
      if (expr === '') return;
      if ('+-*/'.indexOf(expr[expr.length - 1]) !== -1) return;
      expr += o;
      inputting = true;
      updateDisplay(expr);
    }
    function backspace() {
      expr = expr.slice(0, -1);
      updateDisplay(expr == '' ? '0' : expr);
    }
    function allClear() {
      expr = '';
      updateDisplay('0');
    }
    function clearEntry() {
      if (/[+\-*/]/.test(expr)) expr = expr.replace(/([+\-*/])[^+\-*/]*$/, '$1');
      else expr = '';
      updateDisplay(expr == '' ? '0' : expr);
    }
    function calcEqual() {
      try {
        if (expr === '') return;
        let result = eval(expr);
        result = +result.toFixed(6);
        addHistory(expr + '=' + result);
        expr = '' + result;
        inputting = false;
        updateDisplay(expr);
      } catch (e) {
        updateDisplay('ERR');
        expr = '';
        inputting = false;
      }
    }

    let calcHistory = [];
    let longPressTimer = null;
    const longPressDuration = 700; // 700ms長押し判定

    function addHistory(str) {
      calcHistory.unshift(str);
      renderHistory();
      tabs[activeTab].hist = JSON.parse(JSON.stringify(calcHistory));
    }
    function renderHistory() {
      const h = document.getElementById('history');
      h.innerHTML = '';
      (calcHistory || []).forEach((item, i) => {
        const s = document.createElement('div');
        s.className = 'hist-line';
        s.textContent = item; // 数式も必ず表示
        s.title = item;
        s.tabIndex = 0; // フォーカス可にして keyboard操作許可
        s.onmousedown = s.ontouchstart = () => {
          longPressTimer = setTimeout(() => {
            // 長押しで履歴アイテム削除
            calcHistory.splice(i, 1);
            tabs[activeTab].hist = JSON.parse(JSON.stringify(calcHistory));
            renderHistory();
          }, longPressDuration);
        };
        s.onmouseup = s.onmouseleave = s.ontouchend = s.ontouchcancel = () => {
          if (longPressTimer) {
            clearTimeout(longPressTimer);
            longPressTimer = null;
          }
        };
        s.onclick = () => {
          if (longPressTimer) {
            clearTimeout(longPressTimer);
            longPressTimer = null;
          }
          // "="が含まれる場合は結果部分のみを返す
          if (item.includes('=')) {
            expr = item.split('=')[1];
          } else {
            expr = item;
          }
          inputting = true;
          updateDisplay(expr);
        };
        h.appendChild(s);
      });
    }
    function clearHistory() {
      calcHistory = [];
      renderHistory();
      tabs[activeTab].hist = [];
    }
    function historySum() {
      let sum = 0;
      for (const c of calcHistory) {
        let value = c.split('=')[1];
        if (typeof value === 'string') {
          value = value.replace(/[^\d.-]/g, '');
          if (value !== '' && !isNaN(value)) sum += parseFloat(value);
        }
      }
      updateDisplay('合計: ' + sum);
    }

    function getTaxRate() {
      const radios = document.getElementsByName('taxRate');
      for (let r of radios) if (r.checked) return parseFloat(r.value);
      return 0.1;
    }
    function applyTaxIn() {
      if (!expr) return;
      let v = eval(expr);
      let tax = getTaxRate();
      let result = Math.round(v * (1 + tax));
      addHistory(expr + '（税込' + Math.round(tax * 100) + '%）=' + result);
      expr = '' + result;
      inputting = false;
      updateDisplay(expr);
    }
    function applyTaxOut() {
      if (!expr) return;
      let tax = getTaxRate();
      let v = eval(expr);
      let result = Math.round(v / (1 + tax));
      addHistory(expr + '（税抜' + Math.round(tax * 100) + '%）=' + result);
      expr = '' + result;
      inputting = false;
      updateDisplay(expr);
    }
    function applyDiscount() {
      let v = eval(expr);
      let rate = prompt('割引率（％）を入力:', '10');
      if (rate === null) return;
      let r = parseFloat(rate) / 100;
      let result = Math.round(v * (1 - r));
      addHistory(expr + '−' + rate + '%=' + result);
      expr = '' + result;
      inputting = false;
      updateDisplay(expr);
    }
    function applyUp() {
      let v = eval(expr);
      let rate = prompt('割増率（％）を入力:', '10');
      if (rate === null) return;
      let r = parseFloat(rate) / 100;
      let result = Math.round(v * (1 + r));
      addHistory(expr + '＋' + rate + '%=' + result);
      expr = '' + result;
      inputting = false;
      updateDisplay(expr);
    }

    document.addEventListener('keydown', (e) => {
      const key = e.key;
      if ('0123456789'.includes(key)) inputNum(key);
      if (key === '+' || key === '-' || key === '*' || key === '/') inputOp(key);
      if (key === 'Enter' || key === '=') calcEqual();
      if (key === 'Backspace') backspace();
      if (key === 'Delete') clearEntry();
      if (key === 'Escape') allClear();
      if (key === 'Tab') {
        addTab();
        e.preventDefault();
      }
      if (key === '.') inputNum('.');
    });

    renderTabs();
    loadTabState();
    document.getElementsByName('taxRate')[1].checked = true;
  </script>
</body>
</html>
