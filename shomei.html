<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PDF署名ツール</title>
  <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
  <style>
    /* ページ全体の基本スタイル */
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Hiragino Sans", "Noto Sans CJK JP", "Yu Gothic", sans-serif;
      background-color: #f4f4f9;
      color: #333;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      margin: 0;
      padding: 20px;
    }
    
    /* コンテナのスタイル */
    .container {
      max-width: 600px;
      width: 100%;
      background-color: #ffffff;
      border-radius: 8px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      padding: 30px;
      text-align: center;
    }
    
    h1 {
      color: #444;
      margin-bottom: 25px;
    }
    
    /* 入力欄グループ */
    .input-group {
      margin-bottom: 20px;
      text-align: left;
    }
    
    label {
      display: block;
      margin-bottom: 8px;
      font-weight: bold;
      color: #555;
    }
    
    input[type="file"],
    input[type="number"],
    input[type="text"] {
      width: 100%;
      padding: 10px;
      box-sizing: border-box;
      border: 1px solid #ddd;
      border-radius: 4px;
      background-color: #f9f9f9;
    }
    
    input[type="file"]:hover,
    input[type="number"]:hover,
    input[type="text"]:hover {
      border-color: #007bff;
    }
    
    /* ボタンのスタイル */
    button {
      width: 48%;
      padding: 12px;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: background-color 0.3s;
      margin: 2%;
    }
    
    button:hover {
      background-color: #0056b3;
    }
    
    button:disabled {
      background-color: #cccccc;
      cursor: not-allowed;
    }
    
    /* ステータス表示 */
    #status {
      margin-top: 20px;
      font-weight: bold;
      min-height: 24px;
    }
    
    .status-success {
      color: #28a745;
    }
    
    .status-error {
      color: #dc3545;
    }
    
    /* プレビュー用iframe */
    #previewContainer {
      display: none;
      margin-top: 20px;
    }
    #pdfPreview {
      width: 100%;
      height: 500px;
      border: 1px solid #ddd;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>PDFに署名画像を追加</h1>
    
    <!-- ファイル選択 -->
    <div class="input-group">
      <label for="pdfFile">1. 契約書などのPDFファイルを選択</label>
      <input type="file" id="pdfFile" accept=".pdf">
    </div>
    <div class="input-group">
      <label for="imageFile">2. 署名・印鑑の画像ファイル (PNG/JPG) を選択</label>
      <input type="file" id="imageFile" accept="image/png, image/jpeg">
    </div>
    
    <!-- 追加設定 -->
    <div class="input-group">
      <label for="pageNum">3. 署名を追加するページ番号 (1ページ目から)</label>
      <input type="number" id="pageNum" min="1" value="1">
    </div>
    <div class="input-group">
      <label for="posX">4. 署名画像のX座標 (PDFの左下原点からの位置 px)</label>
      <input type="number" id="posX" value="50">
    </div>
    <div class="input-group">
      <label for="posY">5. 署名画像のY座標 (PDFの左下原点からの位置 px)</label>
      <input type="number" id="posY" value="70">
    </div>
    <div class="input-group">
      <label for="sigWidth">6. 署名画像の幅 (px)</label>
      <input type="number" id="sigWidth" min="1" value="120">
    </div>
    <div class="input-group">
      <label for="sigHeight">7. 署名画像の高さ (px)</label>
      <input type="number" id="sigHeight" min="1" value="60">
    </div>
    <div class="input-group">
      <label for="signatureText">8. 署名テキスト (任意、画像の下に追加されます)</label>
      <input type="text" id="signatureText" placeholder="例: 秀和">
    </div>
    
    <!-- ボタン類 -->
    <button id="signButton">署名してダウンロード</button>
    <button id="previewButton">署名プレビュー</button>
    
    <!-- ステータス表示 -->
    <p id="status"></p>
    
    <!-- プレビュー表示用領域 -->
    <div id="previewContainer">
      <h2>プレビュー</h2>
      <iframe id="pdfPreview"></iframe>
    </div>
  </div>

  <script>
    const { PDFDocument, rgb, StandardFonts } = PDFLib;

    // HTML要素の取得
    const pdfFileInput = document.getElementById('pdfFile');
    const imageFileInput = document.getElementById('imageFile');
    const signButton = document.getElementById('signButton');
    const previewButton = document.getElementById('previewButton');
    const statusEl = document.getElementById('status');
    const previewContainer = document.getElementById('previewContainer');
    const pdfPreview = document.getElementById('pdfPreview');

    // 現在のプレビュー用 URL を保持する変数
    let currentPreviewUrl = null;

    // ステータス表示の関数
    function displayStatus(message, type = '') {
      statusEl.textContent = message;
      statusEl.className = ''; // 既存のクラスをリセット
      if (type === 'success') {
        statusEl.classList.add('status-success');
      } else if (type === 'error') {
        statusEl.classList.add('status-error');
      }
    }

    // ダウンロード処理（モバイルでは window.open を利用）
    function download(bytes, filename, mimeType) {
      const blob = new Blob([bytes], { type: mimeType });
      const objectUrl = URL.createObjectURL(blob);
      const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

      if (isMobile) {
        // モバイル環境では新規タブで開く
        window.open(objectUrl, '_blank');
      } else {
        const link = document.createElement('a');
        link.href = objectUrl;
        link.download = filename;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      }
      
      // ブラウザによっては即時解放がうまく働かないことがあるため、少し遅延させます
      setTimeout(() => { URL.revokeObjectURL(objectUrl); }, 1000);
    }

    // PDF を処理して署名画像やテキストを追加する関数
    async function processPDF() {
      // ファイル選択のチェック
      if (pdfFileInput.files.length === 0 || imageFileInput.files.length === 0) {
        throw new Error('PDFファイルと署名画像の両方を選択してください。');
      }

      // ファイルの読み込み
      const pdfBuffer = await pdfFileInput.files[0].arrayBuffer();
      const imageBuffer = await imageFileInput.files[0].arrayBuffer();
      const imageType = imageFileInput.files[0].type.toLowerCase();

      // PDF ドキュメントの読み込み
      const pdfDoc = await PDFDocument.load(pdfBuffer);

      // 画像の種類判定（jpeg, jpg, png に対応）
      let image;
      if (imageType.includes('jpeg') || imageType.includes('jpg')) {
        image = await pdfDoc.embedJpg(imageBuffer);
      } else if (imageType.includes('png')) {
        image = await pdfDoc.embedPng(imageBuffer);
      } else {
        throw new Error(`未対応の画像形式です: ${imageType}`);
      }

      // ユーザー入力から配置情報を取得
      const pageNum = parseInt(document.getElementById('pageNum').value);
      let pageIndex = pageNum - 1;
      const pages = pdfDoc.getPages();
      if (pageIndex < 0 || pageIndex >= pages.length) {
        pageIndex = pages.length - 1;
        displayStatus('指定されたページが存在しません。最終ページに署名を追加します。');
      }
      const targetPage = pages[pageIndex];

      const posX = parseFloat(document.getElementById('posX').value) || 50;
      const posY = parseFloat(document.getElementById('posY').value) || 70;
      const sigWidth = parseFloat(document.getElementById('sigWidth').value) || 120;
      const sigHeight = parseFloat(document.getElementById('sigHeight').value) || 60;

      // 署名画像の描画
      targetPage.drawImage(image, {
        x: posX,
        y: posY,
        width: sigWidth,
        height: sigHeight
      });

      // 署名テキストの追加（入力がある場合）
      const signatureText = document.getElementById('signatureText').value;
      if (signatureText.trim() !== '') {
        const helveticaFont = await pdfDoc.embedFont(StandardFonts.Helvetica);
        targetPage.drawText(signatureText, {
          x: posX,
          y: posY - 15, // 画像の下に 15px 空ける
          size: 12,
          font: helveticaFont,
          color: rgb(0, 0, 0),
        });
      }

      // 変更を反映した PDF をバイト配列として生成
      const pdfBytes = await pdfDoc.save();
      return pdfBytes;
    }

    // 「署名してダウンロード」ボタン押下時の処理
    signButton.addEventListener('click', async () => {
      signButton.disabled = true;
      previewButton.disabled = true;
      displayStatus('処理中... しばらくお待ちください。');
      previewContainer.style.display = 'none';

      try {
        const signedPdfBytes = await processPDF();
        download(signedPdfBytes, "signed-document.pdf", "application/pdf");
        displayStatus('完了しました！ダウンロードが開始されます。', 'success');
      } catch (e) {
        console.error(e);
        displayStatus(`エラーが発生しました: ${e.message}`, 'error');
      } finally {
        signButton.disabled = false;
        previewButton.disabled = false;
      }
    });

    // 「署名プレビュー」ボタン押下時の処理
    previewButton.addEventListener('click', async () => {
      signButton.disabled = true;
      previewButton.disabled = true;
      displayStatus('プレビューを生成中です...');

      try {
        const signedPdfBytes = await processPDF();
        const blob = new Blob([signedPdfBytes], { type: "application/pdf" });
        // 以前のプレビュー用 URL があれば解放する
        if (currentPreviewUrl) {
          URL.revokeObjectURL(currentPreviewUrl);
        }
        currentPreviewUrl = URL.createObjectURL(blob);
        pdfPreview.src = currentPreviewUrl;
        previewContainer.style.display = 'block';
        displayStatus('プレビューが生成されました。', 'success');
      } catch (e) {
        console.error(e);
        displayStatus(`エラーが発生しました: ${e.message}`, 'error');
      } finally {
        signButton.disabled = false;
        previewButton.disabled = false;
      }
    });
  </script>
</body>
</html>